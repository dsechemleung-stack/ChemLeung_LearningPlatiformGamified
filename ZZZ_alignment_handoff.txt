ALIGNMENT / CROPPING HANDOFF (ChemCity Gacha Avatars)

GOAL
- Correct avatar per gender (boy/girl).
- Remove transparent padding so avatar appears tight and centered.
- Center/scale consistently across:
  - ProfileCard (profile preview)
  - GachaResultsModal (gacha results)
  - CosmeticsInventory (inventory grid)
  - ProfileIcon (round head icon)
- Support exceptions: single-person avatars that must NOT be split/cut (e.g. avatar numbers 31, 32).

============================================================
A) STORAGE + FIRESTORE DATA MODEL
============================================================

1) Firebase Storage
- Original avatar images:
  chemcity/cosmetics/avatars/
    - {cosmeticId}.png

- Gendered (derived) avatar images (generated by seeder):
  chemcity/cosmetics/avatars_gendered/
    - {cosmeticId}_boy.png
    - {cosmeticId}_girl.png

2) Firestore cosmetics docs
Collection:
- cosmetics/{cosmeticId}

Fields used:
- imageUrl: string (original avatar image)
- imageUrlBoy?: string (boy-only cropped image URL)
- imageUrlGirl?: string (girl-only cropped image URL)
- availability.channels.gacha: boolean
- rarity: common|uncommon|rare|epic|legendary

Notes:
- UI prefers imageUrlBoy/imageUrlGirl when present.
- UI falls back to the old half-sprite render from imageUrl when gendered URLs are missing.

============================================================
B) SEEDER / UPLOADER CHANGES
============================================================

File:
- scripts/seed-firestore.ts

What it does for avatars:
- Uploads avatars to Storage under:
  - chemcity/cosmetics/avatars/{id}.png

- Generates gendered images using sharp:
  - Reads the local avatar file
  - Ensures alpha (ensureAlpha)
  - Splits into halves:
    - boyHalf = left half
    - girlHalf = right half
  - Tries trim({ threshold: 1 }) to remove transparent padding
  - If trim fails, falls back to untrimmed half
  - Uploads buffers to Storage under:
    - chemcity/cosmetics/avatars_gendered/{id}_boy.png
    - chemcity/cosmetics/avatars_gendered/{id}_girl.png
  - Writes imageUrlBoy/imageUrlGirl into Firestore cosmetics/{id}.

Important bugfix made:
- avatars_gendered/ was empty because trim could fail and the script previously swallowed errors.
- Fix: "trim with fallback" + warning logging so gendered files always upload.

Commands used:
- npm install (to install sharp)
- npx tsx scripts/seed-firestore.ts --upload-cosmetics
- (optional) npx tsx scripts/seed-firestore.ts --seed-gacha

Cache version bumps observed:
- meta/cacheVersion bumped multiple times; latest used during this work reached 19.

============================================================
C) CLIENT RENDERING CHANGES (GENDER URL PREFERENCE + ALIGNMENT)
============================================================

1) Type support
File:
- src/lib/chemcity/types.ts
Change:
- Cosmetic interface includes:
  - imageUrlBoy?: string
  - imageUrlGirl?: string

2) Gacha Results
File:
- src/components/chemcity/gacha/GachaResultsModal.tsx
Logic:
- If cosmetic.type === 'avatar':
  - If userGender exists AND NOT no-split AND imageUrlBoy/imageUrlGirl exists:
    - render the gendered URL
    - position: bottom anchored, centered horizontally
    - apply tuning: offsetXPercent/offsetYPercent/scale (from AvatarTuner)
  - else fallback to old 2x-sprite crop:
    - w-[200%] + max-w-none + translateX(0%/-50%)

3) Inventory
File:
- src/components/chemcity/gacha/CosmeticsInventory.tsx
Logic:
- Mirrors gacha result avatar logic:
  - prefer imageUrlBoy/imageUrlGirl with tuning
  - fallback to old 2x-sprite crop

4) Profile Card
File:
- src/components/chemcity/gacha/ProfileCard.tsx
Logic:
- ProfileCard avatar:
  - prefer gendered URL (unless no-split)
  - centered and bottom-anchored, with tuner tuning

- ProfileIcon (round icon):
  - uses (in priority order):
    - iconCosmetic.imageUrl
    - gendered avatar url (imageUrlBoy/imageUrlGirl)
    - avatarCosmetic.imageUrl
  - uses faceCrop:
    - iconCosmetic.faceCrop OR avatarCosmetic.faceCrop OR global default faceCrop (from AvatarTuner)

============================================================
D) FIRESTORE RULES (TO FIX PERMISSION-DENIED)
============================================================

File:
- firestore.rules
Added read-only access for authenticated users:
- match /cosmetics/{cosmeticId} { allow read: if isAuthenticated(); }
- match /gachaBanners/{bannerId} { allow read: if isAuthenticated(); }
  - match /entries/{cosmeticId} { allow read: if isAuthenticated(); }
- match /events/{eventId} { allow read: if isAuthenticated(); }

Deployed:
- firebase deploy --only firestore:rules

============================================================
E) BANNER CLEANUP (REMOVE DEMO ENTRIES)
============================================================

File:
- scripts/seed-firestore.ts (seedGacha)
Fix:
- Old demo banner entries remained because banner entries were merged but never deleted.
- Updated seed logic to:
  - build entrySource from real cosmetics
  - delete stale entry docs not in desiredEntryIds
  - deprecate demo cosmetics pointing to storage.example.com

============================================================
F) AVATAR TUNER (DEV TOOL FOR PER-AVATAR / PER-CONTEXT ALIGNMENT)
============================================================

Files:
- src/components/chemcity/gacha/AvatarTuner.tsx
- src/pages/ProfilePage.jsx (button placement)

What it provides:
1) Dev-only modal UI opened by "Avatar Tuner" button on Profile page next to ProfileCard preview.
2) Stores config in localStorage key:
   - cc_avatar_tuner_config_v1
3) Supports:
   - noSplitAvatarNumbers (exceptions: e.g. [31,32])
   - per-avatar tuning per context per gender:
     - offsetXPercent
     - offsetYPercent
     - scale
   - globalDefaults.faceCropByGender (boy/girl) used for ProfileIcon if faceCrop missing

How to enable tuner UI:
- It shows automatically on localhost / 127.0.0.1
- Also can be forced by:
  localStorage.setItem('cc_enable_avatar_tuner','1')

Tap-to-generate faceCrop:
- In tuner modal -> Global defaults
  - choose Tap: boy or Tap: girl
  - click top-left then bottom-right of face
  - auto-fills x/y/w/h

Copy/Export config:
- Tuner modal shows:
  - Config JSON textarea (always visible)
  - Copy JSON / Select All / Download

Import config:
- Tuner modal includes Import JSON textarea + Apply

Helpers exported for renderers:
- shouldForceNoSplit(avatarId)
- getAvatarTuning(avatarId, ctx, gender)
- getGlobalFaceCrop(gender)

IMPORTANT NOTE
- The per-context tuning currently affects:
  - ProfileCard avatar render
  - GachaResultsModal avatar render
  - CosmeticsInventory avatar render
- ProfileIcon uses global faceCrop defaults (and/or per-avatar faceCrop) to crop the head.

============================================================
G) USER-PROVIDED JSON EXAMPLE (FROM TUNER)
============================================================
{
  "version": 1,
  "noSplitAvatarNumbers": [31, 32],
  "byAvatarId": {
    "avatar_59_findingnemo": {
      "profile_card": {
        "boy": { "offsetXPercent": 0 },
        "girl": { "offsetXPercent": 19, "scale": 1 }
      },
      "gacha_result": {
        "boy": { "offsetXPercent": 0 }
      }
    }
  },
  "globalDefaults": {
    "faceCropByGender": {
      "girl": { "x": 0.1964, "y": 0.1281, "w": 0.2786, "h": 0.2313 },
      "boy": { "x": 0.5429, "y": 0.1094, "w": 0.2786, "h": 0.2531 }
    }
  }
}

============================================================
H) QUICK VERIFICATION CHECKLIST
============================================================
1) Storage contains:
   - chemcity/cosmetics/avatars_gendered/*_boy.png and *_girl.png

2) Firestore cosmetics docs contain:
   - imageUrlBoy and imageUrlGirl (where applicable)

3) UI:
   - ProfileCard: toggling gender changes avatar
   - Inventory thumbnails: show correct gendered avatar
   - Gacha results: show correct gendered avatar
   - ProfileIcon: uses global faceCrop defaults (if faceCrop not set per-avatar)


============================================================
I) CURRENT AVATAR TUNER DEFAULT CONFIG (SYSTEM-WIDE)
============================================================

Note:
- Stored in localStorage key: cc_avatar_tuner_config_v4
- This is the DEFAULT_CFG shipped in code (src/components/chemcity/gacha/AvatarTuner.tsx)

{
  "version": 1,
  "noSplitAvatarNumbers": [
    31,
    32
  ],
  "globalDefaults": {
    "faceCropByGender": {
      "boy": {
        "x": 0.5327,
        "y": 0.1179,
        "w": 0.2449,
        "h": 0.2357
      },
      "girl": {
        "x": 0.198,
        "y": 0.1214,
        "w": 0.2857,
        "h": 0.2393
      }
    },
    "noSplitFaceCropDefault": {
      "x": 0.3,
      "y": 0.04,
      "w": 0.38,
      "h": 0.26
    },
    "bodyFrameByGender": {
      "boy": {
        "scale": 1
      },
      "girl": {
        "scale": 1
      }
    },
    "tuningByContext": {
      "profile_card": {
        "boy": {
          "offsetXPercent": 1,
          "offsetYPercent": -14.1,
          "scale": 1.16
        },
        "girl": {
          "offsetXPercent": 1,
          "offsetYPercent": -14.1,
          "scale": 1.16
        }
      },
      "gacha_result": {
        "boy": {
          "offsetXPercent": 0,
          "offsetYPercent": 0,
          "scale": 0.88
        },
        "girl": {
          "offsetXPercent": 0,
          "offsetYPercent": 0,
          "scale": 0.88
        }
      },
      "inventory": {
        "boy": {
          "offsetXPercent": 1,
          "offsetYPercent": 45.2,
          "scale": 3.12
        },
        "girl": {
          "offsetXPercent": 1,
          "offsetYPercent": 45.2,
          "scale": 3.12
        }
      },
      "profile_icon": {
        "boy": {
          "offsetXPercent": 1,
          "offsetYPercent": 42.1,
          "scale": 2.42
        },
        "girl": {
          "offsetXPercent": 1,
          "offsetYPercent": 42.1,
          "scale": 2.42
        }
      }
    }
  },
  "byAvatarId": {
    "avatar_38_dino": {
      "profile_card": {
        "boy": {
          "offsetXPercent": -3,
          "offsetYPercent": -15.5,
          "scale": 1
        },
        "girl": {
          "offsetXPercent": 0.5,
          "offsetYPercent": -16.4,
          "scale": 1
        }
      },
      "gacha_result": {
        "boy": {
          "offsetXPercent": -3,
          "offsetYPercent": -3,
          "scale": 0.98
        },
        "girl": {
          "offsetXPercent": 0,
          "offsetYPercent": -4.2,
          "scale": 0.98
        }
      },
      "inventory": {
        "boy": {
          "offsetXPercent": -14.5,
          "offsetYPercent": 40.5,
          "scale": 3.16
        },
        "girl": {
          "offsetXPercent": -0.5,
          "offsetYPercent": 39.6,
          "scale": 3.08
        }
      },
      "profile_icon": {
        "boy": {
          "offsetXPercent": -15,
          "offsetYPercent": 40.2,
          "scale": 2.62
        },
        "girl": {
          "offsetXPercent": 0.6,
          "offsetYPercent": 38.4,
          "scale": 2.62
        }
      }
    },
    "avatar_56_oil": {
      "profile_card": {
        "girl": {
          "offsetXPercent": 2,
          "offsetYPercent": -16.8,
          "scale": 1.2
        },
        "boy": {
          "offsetXPercent": 0.5,
          "offsetYPercent": -16.5
        }
      },
      "inventory": {
        "boy": {
          "scale": 2.36,
          "offsetXPercent": 3,
          "offsetYPercent": 35.5
        },
        "girl": {
          "scale": 3.12,
          "offsetXPercent": 5.5,
          "offsetYPercent": 45.2
        }
      },
      "profile_icon": {
        "boy": {
          "offsetXPercent": 3.6,
          "offsetYPercent": 39,
          "scale": 2.32
        },
        "girl": {
          "offsetXPercent": 4.6,
          "offsetYPercent": 42.1,
          "scale": 2.42
        }
      },
      "gacha_result": {
        "boy": {
          "offsetXPercent": 1.5,
          "offsetYPercent": -2.5
        },
        "girl": {
          "offsetXPercent": 0.5,
          "offsetYPercent": -1.5,
          "scale": 0.88
        }
      }
    },
    "avatar_63_pikachu": {
      "profile_card": {
        "boy": {
          "offsetXPercent": 5,
          "offsetYPercent": -14.1,
          "scale": 1.16
        },
        "girl": {
          "offsetXPercent": 4.6,
          "offsetYPercent": -14.1,
          "scale": 1.16
        }
      },
      "gacha_result": {
        "boy": {
          "offsetXPercent": 4,
          "offsetYPercent": 0,
          "scale": 0.58
        },
        "girl": {
          "offsetXPercent": 4.3,
          "offsetYPercent": 0,
          "scale": 0.88
        }
      },
      "inventory": {
        "boy": {
          "offsetXPercent": 13.9,
          "offsetYPercent": 45.5,
          "scale": 3.12
        },
        "girl": {
          "offsetXPercent": 11.5,
          "offsetYPercent": 45.2,
          "scale": 3.12
        }
      },
      "profile_icon": {
        "boy": {
          "offsetXPercent": 12.4,
          "offsetYPercent": 42.1,
          "scale": 2.42
        },
        "girl": {
          "offsetXPercent": 11.1,
          "offsetYPercent": 42.1,
          "scale": 2.42
        }
      }
    },
    "avatar_75_tempest": {
      "profile_card": {
        "boy": {
          "offsetXPercent": 9,
          "offsetYPercent": -14.1,
          "scale": 1.16
        },
        "girl": {
          "offsetXPercent": 10.8,
          "offsetYPercent": -13.1,
          "scale": 1.16
        }
      },
      "gacha_result": {
        "boy": {
          "offsetXPercent": 5.7,
          "offsetYPercent": 0,
          "scale": 0.88
        },
        "girl": {
          "offsetXPercent": 6.9,
          "offsetYPercent": 0,
          "scale": 0.88
        }
      },
      "inventory": {
        "boy": {
          "offsetXPercent": 16.4,
          "offsetYPercent": 45.8,
          "scale": 3.12
        },
        "girl": {
          "offsetXPercent": 23.4,
          "offsetYPercent": 46.9,
          "scale": 3.12
        }
      },
      "profile_icon": {
        "boy": {
          "offsetXPercent": 15.7,
          "offsetYPercent": 42.1,
          "scale": 2.42
        },
        "girl": {
          "offsetXPercent": 20.9,
          "offsetYPercent": 44.5,
          "scale": 2.42
        }
      }
    },
    "avatar_62_wizard": {
      "profile_card": {
        "boy": {
          "offsetXPercent": -5.3,
          "offsetYPercent": -14.1,
          "scale": 1.16
        },
        "girl": {
          "offsetXPercent": -1.6,
          "offsetYPercent": -14.1,
          "scale": 1.16
        }
      },
      "gacha_result": {
        "boy": {
          "offsetXPercent": -5.1,
          "offsetYPercent": 0,
          "scale": 0.88
        },
        "girl": {
          "offsetXPercent": -2.2,
          "offsetYPercent": 0,
          "scale": 0.88
        }
      },
      "inventory": {
        "boy": {
          "offsetXPercent": -11.5,
          "offsetYPercent": 45.2,
          "scale": 3.12
        },
        "girl": {
          "offsetXPercent": -7.2,
          "offsetYPercent": 45,
          "scale": 3.12
        }
      },
      "profile_icon": {
        "boy": {
          "offsetXPercent": -10.7,
          "offsetYPercent": 41.9,
          "scale": 2.42
        },
        "girl": {
          "offsetXPercent": -7.2,
          "offsetYPercent": 42.1,
          "scale": 2.42
        }
      }
    },
    "avatar_16_forest": {
      "profile_card": {
        "boy": {
          "offsetXPercent": -5.9,
          "offsetYPercent": -14.1,
          "scale": 1.16
        }
      },
      "gacha_result": {
        "boy": {
          "offsetXPercent": -4.3,
          "offsetYPercent": 0.2,
          "scale": 0.88
        }
      },
      "inventory": {
        "boy": {
          "offsetXPercent": -14.2,
          "offsetYPercent": 45.2,
          "scale": 3.12
        }
      },
      "profile_icon": {
        "boy": {
          "offsetXPercent": -12.2,
          "offsetYPercent": 42.1,
          "scale": 2.42
        }
      }
    },
    "avatar_68_pajama": {
      "profile_card": {
        "boy": {
          "offsetXPercent": -2.3,
          "offsetYPercent": -14.1,
          "scale": 1.16
        }
      },
      "gacha_result": {
        "boy": {
          "offsetXPercent": -2.7,
          "offsetYPercent": 0,
          "scale": 0.88
        }
      },
      "inventory": {
        "boy": {
          "offsetXPercent": -5.6,
          "offsetYPercent": 45.2,
          "scale": 3.12
        }
      },
      "profile_icon": {
        "boy": {
          "offsetXPercent": -5.3,
          "offsetYPercent": 42.7,
          "scale": 2.42
        }
      }
    },
    "avatar_71_stone_age": {
      "profile_card": {
        "boy": {
          "offsetXPercent": -6.7,
          "offsetYPercent": -13.9,
          "scale": 1.16
        },
        "girl": {
          "offsetXPercent": -3,
          "offsetYPercent": -14.1,
          "scale": 1.16
        }
      },
      "gacha_result": {
        "boy": {
          "offsetXPercent": -6.1,
          "offsetYPercent": -0.2,
          "scale": 0.88
        },
        "girl": {
          "offsetXPercent": -3.1,
          "offsetYPercent": 0,
          "scale": 0.88
        }
      },
      "inventory": {
        "boy": {
          "offsetXPercent": -17.8,
          "offsetYPercent": 45.2,
          "scale": 3.12
        },
        "girl": {
          "offsetXPercent": -10.6,
          "offsetYPercent": 45.4,
          "scale": 3.12
        }
      },
      "profile_icon": {
        "boy": {
          "offsetXPercent": -15,
          "offsetYPercent": 42.1,
          "scale": 2.42
        },
        "girl": {
          "offsetXPercent": -8.5,
          "offsetYPercent": 42.3,
          "scale": 2.42
        }
      }
    },
    "avatar_3_cat": {
      "profile_card": {
        "boy": {
          "offsetXPercent": 9.6,
          "offsetYPercent": -14.1,
          "scale": 1.16
        },
        "girl": {
          "offsetXPercent": 9,
          "offsetYPercent": -14.1,
          "scale": 1.16
        }
      },
      "gacha_result": {
        "boy": {
          "offsetXPercent": 6.8,
          "offsetYPercent": -0.3,
          "scale": 0.88
        },
        "girl": {
          "offsetXPercent": 6.3,
          "offsetYPercent": 0,
          "scale": 0.88
        }
      },
      "inventory": {
        "boy": {
          "offsetXPercent": 23.5,
          "offsetYPercent": 44.7,
          "scale": 3.12
        },
        "girl": {
          "offsetXPercent": 23.3,
          "offsetYPercent": 45.2,
          "scale": 3.12
        }
      },
      "profile_icon": {
        "boy": {
          "offsetXPercent": 21,
          "offsetYPercent": 42.1,
          "scale": 2.42
        },
        "girl": {
          "offsetXPercent": 20.1,
          "offsetYPercent": 42.3,
          "scale": 2.42
        }
      }
    },
    "avatar_47_singer": {
      "profile_card": {
        "boy": {
          "offsetXPercent": 2.3,
          "offsetYPercent": -14.1,
          "scale": 1.16
        }
      },
      "gacha_result": {
        "boy": {
          "offsetXPercent": 1.2,
          "offsetYPercent": 0,
          "scale": 0.6
        }
      },
      "inventory": {
        "boy": {
          "offsetXPercent": 6.1,
          "offsetYPercent": 45.3,
          "scale": 3.12
        }
      },
      "profile_icon": {
        "boy": {
          "offsetXPercent": 5.4,
          "offsetYPercent": 42.1,
          "scale": 2.42
        }
      }
    },
    "avatar_21_robot": {
      "profile_card": {
        "boy": {
          "offsetXPercent": -1,
          "offsetYPercent": -14.1,
          "scale": 1.16
        }
      }
    },
    "avatar_26_antman": {
      "profile_card": {
        "boy": {
          "offsetXPercent": 5.9,
          "offsetYPercent": 16.8,
          "scale": 0.5
        },
        "girl": {
          "offsetXPercent": 1.6,
          "offsetYPercent": -13.8,
          "scale": 0.5
        }
      },
      "gacha_result": {
        "girl": {
          "offsetXPercent": 1.8,
          "offsetYPercent": 18.3,
          "scale": 0.5
        },
        "boy": {
          "offsetXPercent": 6.9,
          "offsetYPercent": 15,
          "scale": 0.5
        }
      },
      "inventory": {
        "boy": {
          "offsetXPercent": 16.8,
          "offsetYPercent": 33.9,
          "scale": 1.58
        },
        "girl": {
          "offsetXPercent": 3.6,
          "offsetYPercent": 29.3,
          "scale": 1.36
        }
      },
      "profile_icon": {
        "boy": {
          "offsetXPercent": 9.8,
          "offsetYPercent": 30,
          "scale": 0.96
        },
        "girl": {
          "offsetXPercent": 3.8,
          "offsetYPercent": 28.5,
          "scale": 1.4
        }
      }
    },
    "avatar_79_champion": {
      "profile_card": {
        "girl": {
          "offsetXPercent": -7.5,
          "offsetYPercent": -14,
          "scale": 1.16
        }
      },
      "gacha_result": {
        "girl": {
          "offsetXPercent": -5.9,
          "offsetYPercent": -0.3,
          "scale": 0.88
        }
      },
      "inventory": {
        "girl": {
          "offsetXPercent": -19.9,
          "offsetYPercent": 45.2,
          "scale": 3.12
        }
      },
      "profile_icon": {
        "girl": {
          "offsetXPercent": -18,
          "offsetYPercent": 42.1,
          "scale": 2.42
        }
      }
    },
    "avatar_67_lego": {
      "profile_card": {
        "girl": {
          "offsetXPercent": 3.7,
          "offsetYPercent": -14.1,
          "scale": 1.16
        }
      },
      "gacha_result": {
        "girl": {
          "offsetXPercent": 2.9,
          "offsetYPercent": 0,
          "scale": 0.88
        }
      },
      "inventory": {
        "girl": {
          "offsetXPercent": 8.6,
          "offsetYPercent": 45.2,
          "scale": 3.12
        }
      },
      "profile_icon": {
        "girl": {
          "offsetXPercent": 7.1,
          "offsetYPercent": 42.3,
          "scale": 2.42
        }
      }
    },
    "avatar_84_smurf": {
      "profile_card": {
        "boy": {
          "offsetXPercent": 5.7,
          "offsetYPercent": -14.1,
          "scale": 1.16
        },
        "girl": {
          "offsetXPercent": -5.7,
          "offsetYPercent": -14.1,
          "scale": 1.16
        }
      },
      "gacha_result": {
        "boy": {
          "offsetXPercent": 3.7,
          "offsetYPercent": 0,
          "scale": 0.88
        },
        "girl": {
          "offsetXPercent": -5,
          "offsetYPercent": 0.3,
          "scale": 0.88
        }
      },
      "inventory": {
        "boy": {
          "offsetXPercent": 20.7,
          "offsetYPercent": 31,
          "scale": 3.12
        },
        "girl": {
          "offsetXPercent": -14.5,
          "offsetYPercent": 34.4,
          "scale": 3.12
        }
      },
      "profile_icon": {
        "boy": {
          "offsetXPercent": 17.9,
          "offsetYPercent": 32.4,
          "scale": 2.42
        },
        "girl": {
          "offsetXPercent": -14.1,
          "offsetYPercent": 32,
          "scale": 2.42
        }
      }
    }
  }
}

