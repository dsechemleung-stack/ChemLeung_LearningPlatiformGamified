# Combined ChemCity code
# Generated: Sat Feb 21 07:49:33 HKT 2026



===== functions/chemcity/collectPassiveIncome.ts =====

// ============================================================
// ChemCity ‚Äî collectPassiveIncome Cloud Function
//
// CRITICAL: Server-side timestamp only. Client clock is IGNORED.
// Changing device clock to the future earns nothing.
//
// Algorithm:
//   1. Read user.passiveIncome.lastCollected from Firestore
//   2. Get current time from Firestore server timestamp
//   3. elapsed = serverNow - lastCollected
//   4. Cap elapsed at 24 hours
//   5. coins = passiveBaseCoinsPerHour √ó elapsed_in_hours
//   6. Add coins, write lastCollected = serverNow
//
// Called by client tap on "Collect" button.
// The client's displayed ticker is cosmetic only.
// ============================================================

import * as admin from 'firebase-admin';
import * as functions from 'firebase-functions';

const db = admin.firestore();

const MAX_HOURS = 24; // passive income cap

export const collectPassiveIncome = functions.https.onCall(
  async (data, context) => {
    if (!context.auth) {
      throw new functions.https.HttpsError(
        'unauthenticated',
        'User must be signed in.',
      );
    }

    const userId = context.auth.uid;
    const userRef = db.collection('users').doc(userId);

    return db.runTransaction(async (tx) => {
      const snap = await tx.get(userRef);
      if (!snap.exists) {
        throw new functions.https.HttpsError('not-found', 'User not initialised.');
      }

      const userData = snap.data()!;
      const bonuses = userData.activeBonuses;
      const passiveBase: number = bonuses.passiveBaseCoinsPerHour ?? 0;

      if (passiveBase === 0) {
        return { coinsAwarded: 0, message: 'No passive income yet ‚Äî equip cards in the Garden and Lab.' };
      }

      // Server-side time only ‚Äî client clock is irrelevant
      const serverNow = admin.firestore.Timestamp.now();
      const lastCollected: admin.firestore.Timestamp | null =
        userData.passiveIncome?.lastCollected ?? null;

      let elapsedSeconds = 0;
      if (lastCollected) {
        elapsedSeconds = serverNow.seconds - lastCollected.seconds;
      } else {
        // First ever collection ‚Äî treat as if collected right now
        elapsedSeconds = 0;
      }

      // Cap at 24 hours
      const cappedSeconds = Math.min(elapsedSeconds, MAX_HOURS * 3600);
      const elapsedHours = cappedSeconds / 3600;

      const coinsAwarded = Math.floor(passiveBase * elapsedHours);

      // Write new balance + timestamp
      tx.update(userRef, {
        'currencies.coins': admin.firestore.FieldValue.increment(coinsAwarded),
        'passiveIncome.lastCollected': serverNow,
        updatedAt: serverNow,
      });

      return {
        coinsAwarded,
        elapsedHours: elapsedHours.toFixed(2),
        newLastCollected: serverNow.toDate().toISOString(),
      };
    });
  },
);


===== functions/chemcity/initChemCityUser.ts =====

// ============================================================
// ChemCity ‚Äî User Initialization
// Creates the user doc + progress sub-document with defaults.
// Called by the initChemCityUser Cloud Function.
//
// NOTE: This function must run server-side (Cloud Function).
//       It writes currencies ‚Äî clients cannot do this.
// ============================================================

import * as admin from 'firebase-admin';
import type { UserChemCityData, UserProgressData } from '../../src/lib/chemcity/types';

const db = admin.firestore();

/**
 * Creates a fresh ChemCity user doc and progress sub-document.
 * Called once per user on their first ChemCity session.
 *
 * Starter state:
 *  - 500 coins, 20 diamonds (enough to unlock Garden + Kitchen)
 *  - Lab unlocked by default (free)
 *  - No cards, no equipped items
 */
export async function initChemCityUser(userId: string): Promise<void> {
  const userRef = db.collection('users').doc(userId);
  const progressRef = userRef.collection('progress').doc('data');

  // Check if already initialised
  const existing = await userRef.get();
  if (existing.exists) {
    console.warn(`[initChemCityUser] User ${userId} already initialised ‚Äî skipping.`);
    return;
  }

  const now = admin.firestore.FieldValue.serverTimestamp();

  const userDoc: Omit<UserChemCityData, 'createdAt' | 'updatedAt' | 'passiveIncome'> & {
    createdAt: admin.firestore.FieldValue;
    updatedAt: admin.firestore.FieldValue;
    passiveIncome: { lastCollected: null };
  } = {
    userId,
    currencies: {
      coins: 500,
      diamonds: 20,
    },
    ownedItems: [],
    equipped: {},
    activeBonuses: {
      passiveBaseCoinsPerHour: 0,
      passiveMultiplier: 1,
      quizFlatDiamondBonus: 0,
      quizDiamondMultiplier: 1,
      quizDoubleChancePercent: 0,
      dailyLoginDiamonds: 5, // base Toilet: 5 + (0 √ó 2)
      extraSlotsTotal: 0,
      shopDiscountPercent: 0,
    },
    unlockedPlaces: ['lab'], // Lab is free ‚Äî unlocked from the start
    unlockedSlots: [],
    extraSlotsBudget: 0,
    passiveIncome: {
      lastCollected: null,
    },
    streaks: {
      currentStreak: 0,
      longestStreak: 0,
      lastLoginDate: '',
      streakFreezeCount: 0,
    },
    cacheVersion: 0, // will be updated on first client load
    createdAt: now,
    updatedAt: now,
  };

  const progressDoc: UserProgressData = {
    collections: {},
    topicMastery: {},
  };

  // Write both docs in a single batch
  const batch = db.batch();
  batch.set(userRef, userDoc);
  batch.set(progressRef, progressDoc);
  await batch.commit();

  console.info(`[initChemCityUser] User ${userId} initialised successfully.`);
}


===== src/components/chemcity/CardDetail.tsx =====

import React from 'react';
import { useChemCityStore } from '../../store/chemcityStore';

const DetailSkeleton: React.FC = () => (
  <div className="animate-pulse flex flex-col gap-4 p-4">
    <div className="w-full h-48 bg-slate-700 rounded-xl" />
    <div className="h-6 bg-slate-700 rounded w-3/4" />
    <div className="h-4 bg-slate-700 rounded w-1/2" />
    {[1, 2, 3].map((i) => (
      <div key={i} className="flex flex-col gap-2">
        <div className="h-3 bg-slate-700 rounded w-1/4" />
        <div className="h-4 bg-slate-700 rounded" />
        <div className="h-4 bg-slate-700 rounded w-4/5" />
      </div>
    ))}
  </div>
);

const RARITY_BG: Record<string, string> = {
  common: 'from-slate-700 to-slate-600',
  rare: 'from-blue-800 to-indigo-700',
  epic: 'from-purple-800 to-pink-700',
  legendary: 'from-amber-700 to-yellow-500',
};

export const CardDetail: React.FC = () => {
  const cardDetailItemId = useChemCityStore((s) => s.cardDetailItemId);
  const cardDetailData = useChemCityStore((s) => s.cardDetailData);
  const cardDetailLoading = useChemCityStore((s) => s.cardDetailLoading);
  const slimItems = useChemCityStore((s) => s.slimItems);
  const closeCardDetail = useChemCityStore((s) => s.closeCardDetail);

  const isOpen = !!cardDetailItemId;
  if (!isOpen) return null;

  const slim = slimItems.find((i) => i.id === cardDetailItemId);
  const full = cardDetailData;
  const rarity = slim?.rarity ?? 'common';
  const gradBg = RARITY_BG[rarity] ?? RARITY_BG.common;

  return (
    <>
      <div className="fixed inset-0 bg-black/70 z-50" onClick={closeCardDetail} />

      <div className="fixed inset-x-4 top-12 bottom-4 z-50 bg-slate-900 border border-slate-700 rounded-2xl overflow-hidden flex flex-col shadow-2xl">
        <button
          onClick={closeCardDetail}
          className="absolute top-3 right-3 z-10 w-8 h-8 flex items-center justify-center rounded-full bg-slate-800/80 text-slate-300 hover:text-white text-lg"
          aria-label="Close"
        >
          √ó
        </button>

        <div className="overflow-y-auto flex-1">
          {cardDetailLoading ? (
            <DetailSkeleton />
          ) : (
            <>
              <div className={`w-full bg-gradient-to-b ${gradBg} p-6 flex flex-col items-center gap-3`}>
                {full?.imageUrl ? (
                  <img
                    src={full.imageUrl}
                    alt={full.name}
                    className="w-32 h-32 object-contain rounded-xl shadow-lg"
                    onError={(e) => {
                      (e.target as HTMLImageElement).style.display = 'none';
                    }}
                  />
                ) : (
                  <span className="text-7xl">{slim?.emoji}</span>
                )}

                <div className="text-center">
                  <h2 className="text-white font-bold text-xl leading-tight">
                    {full?.displayName || slim?.name || 'Unknown'}
                  </h2>
                  <p className="text-white/70 font-mono text-lg mt-0.5">{slim?.chemicalFormula}</p>
                  <div className="flex items-center justify-center gap-2 mt-2">
                    <span className="bg-white/20 text-white text-xs font-semibold rounded-full px-3 py-0.5 capitalize">
                      {rarity}
                    </span>
                    {slim?.placeId && (
                      <span className="bg-white/20 text-white text-xs rounded-full px-3 py-0.5">
                        {slim.placeId.replace(/_/g, ' ')}
                      </span>
                    )}
                  </div>
                </div>
              </div>

              <div className="p-4 flex flex-col gap-4">
                {full?.description && (
                  <p className="text-slate-300 text-sm leading-relaxed">{full.description}</p>
                )}

                {full?.educational?.funFact && (
                  <div className="bg-indigo-900/40 border border-indigo-700 rounded-xl p-3">
                    <p className="text-indigo-300 text-xs font-semibold mb-1">üî¨ Fun Fact</p>
                    <p className="text-slate-200 text-sm leading-relaxed">{full.educational.funFact}</p>
                  </div>
                )}

                {full?.educational?.everydayUses && full.educational.everydayUses.length > 0 && (
                  <div>
                    <p className="text-slate-400 text-xs font-semibold mb-2">üè† Everyday Uses</p>
                    <div className="flex flex-wrap gap-2">
                      {full.educational.everydayUses.map((use) => (
                        <span key={use} className="bg-slate-700 text-slate-200 text-xs rounded-full px-3 py-1">
                          {use}
                        </span>
                      ))}
                    </div>
                  </div>
                )}

                {full?.topicConnections && full.topicConnections.length > 0 && (
                  <div>
                    <p className="text-slate-400 text-xs font-semibold mb-2">üìö DSE Topics</p>
                    <div className="flex flex-wrap gap-2">
                      {full.topicConnections.map((tid) => (
                        <span
                          key={tid}
                          className="bg-emerald-900/50 text-emerald-300 text-xs rounded-full px-3 py-1 border border-emerald-800"
                        >
                          {tid}
                        </span>
                      ))}
                    </div>
                  </div>
                )}

                {full?.albumMetadata?.flavorText && (
                  <div className="border-t border-slate-700 pt-3">
                    <p className="text-slate-500 text-xs italic leading-relaxed">"{full.albumMetadata.flavorText}"</p>
                  </div>
                )}

                {slim?.skillContribution !== undefined && slim.skillContribution > 0 && (
                  <div className="bg-slate-800 rounded-xl p-3 flex items-center justify-between">
                    <span className="text-slate-400 text-sm">Skill Contribution</span>
                    <span className="text-white font-bold">+{slim.skillContribution}</span>
                  </div>
                )}

                {!full && (
                  <div className="text-slate-500 text-sm">Card details unavailable.</div>
                )}
              </div>
            </>
          )}
        </div>
      </div>
    </>
  );
};


===== src/components/chemcity/CardInventory.tsx =====

import React, { useMemo, useState } from 'react';
import { useChemCityStore } from '../../store/chemcityStore';
import { ChemCard } from './ChemCard';

type RarityFilter = 'all' | 'common' | 'rare' | 'epic' | 'legendary';

type PlaceFilter = 'all' | string;

export const CardInventory: React.FC = () => {
  const user = useChemCityStore((s) => s.user);
  const slimItems = useChemCityStore((s) => s.slimItems);
  const places = useChemCityStore((s) => s.places);
  const openCardDetail = useChemCityStore((s) => s.openCardDetail);

  const [placeFilter, setPlaceFilter] = useState<PlaceFilter>('all');
  const [rarityFilter, setRarityFilter] = useState<RarityFilter>('all');
  const [searchQuery, setSearchQuery] = useState('');

  const ownedItems = useMemo(() => {
    if (!user) return [];
    return slimItems.filter((item) => !item.deprecated && user.ownedItems.includes(item.id));
  }, [slimItems, user]);

  const filtered = useMemo(() => {
    return ownedItems.filter((item) => {
      if (placeFilter !== 'all' && item.placeId !== placeFilter) return false;
      if (rarityFilter !== 'all' && item.rarity !== rarityFilter) return false;
      if (
        searchQuery &&
        !item.name.toLowerCase().includes(searchQuery.toLowerCase()) &&
        !item.chemicalFormula.toLowerCase().includes(searchQuery.toLowerCase())
      ) {
        return false;
      }
      return true;
    });
  }, [ownedItems, placeFilter, rarityFilter, searchQuery]);

  const equippedSet = new Set(Object.values(user?.equipped ?? {}));
  const rarities: RarityFilter[] = ['all', 'common', 'rare', 'epic', 'legendary'];

  return (
    <div className="flex flex-col min-h-0">
      <div className="px-4 pt-3 pb-2">
        <h2 className="text-white font-bold text-lg">Card Inventory</h2>
        <p className="text-slate-400 text-xs">{ownedItems.length} cards owned</p>
      </div>

      <div className="px-4 pb-2">
        <input
          type="text"
          placeholder="Search cards..."
          value={searchQuery}
          onChange={(e) => setSearchQuery(e.target.value)}
          className="w-full bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-white text-sm placeholder-slate-500 outline-none focus:border-indigo-500"
        />
      </div>

      <div className="flex gap-2 px-4 pb-2 overflow-x-auto">
        <button
          onClick={() => setPlaceFilter('all')}
          className={`px-3 py-1 rounded-full text-xs font-semibold whitespace-nowrap transition-colors ${
            placeFilter === 'all'
              ? 'bg-indigo-600 text-white'
              : 'bg-slate-700 text-slate-300 hover:bg-slate-600'
          }`}
        >
          All Places
        </button>
        {places.map((p) => (
          <button
            key={p.id}
            onClick={() => setPlaceFilter(p.id)}
            className={`px-3 py-1 rounded-full text-xs font-semibold whitespace-nowrap transition-colors ${
              placeFilter === p.id
                ? 'bg-indigo-600 text-white'
                : 'bg-slate-700 text-slate-300 hover:bg-slate-600'
            }`}
          >
            {p.emoji} {p.displayName}
          </button>
        ))}
      </div>

      <div className="flex gap-2 px-4 pb-3 overflow-x-auto">
        {rarities.map((r) => (
          <button
            key={r}
            onClick={() => setRarityFilter(r)}
            className={`px-3 py-1 rounded-full text-xs font-semibold capitalize whitespace-nowrap transition-colors ${
              rarityFilter === r
                ? 'bg-indigo-600 text-white'
                : 'bg-slate-700 text-slate-300 hover:bg-slate-600'
            }`}
          >
            {r}
          </button>
        ))}
      </div>

      <div className="overflow-y-auto flex-1 px-4 pb-4">
        {filtered.length === 0 ? (
          <div className="flex flex-col items-center justify-center py-16 text-slate-500">
            <span className="text-5xl mb-3">üÉè</span>
            <p className="text-sm">{ownedItems.length === 0 ? 'No cards yet ‚Äî visit ChemStore!' : 'No cards match your filter'}</p>
          </div>
        ) : (
          <div className="grid grid-cols-3 gap-3">
            {filtered.map((item) => (
              <ChemCard
                key={item.id}
                item={item}
                size="md"
                isEquipped={equippedSet.has(item.id)}
                onClick={() => openCardDetail(item.id)}
              />
            ))}
          </div>
        )}
      </div>
    </div>
  );
};


===== src/components/chemcity/CardPicker.tsx =====

import React, { useMemo, useState } from 'react';
import { useChemCityStore } from '../../store/chemcityStore';
import { ChemCard } from './ChemCard';
import type { SlimItemDocument } from '../../lib/chemcity/types';

export const CardPicker: React.FC = () => {
  const user = useChemCityStore((s) => s.user);
  const slimItems = useChemCityStore((s) => s.slimItems);
  const cardPickerSlotId = useChemCityStore((s) => s.cardPickerSlotId);
  const closeCardPicker = useChemCityStore((s) => s.closeCardPicker);
  const equipCard = useChemCityStore((s) => s.equipCard);
  const unequipCard = useChemCityStore((s) => s.unequipCard);
  const openCardDetail = useChemCityStore((s) => s.openCardDetail);

  const [equipping, setEquipping] = useState<string | null>(null);
  const [filterRarity, setFilterRarity] = useState<string>('all');

  const isOpen = !!cardPickerSlotId;

  const validCards = useMemo<SlimItemDocument[]>(() => {
    if (!cardPickerSlotId || !user) return [];
    return slimItems.filter(
      (item) =>
        !item.deprecated &&
        user.ownedItems.includes(item.id) &&
        item.validSlots.includes(cardPickerSlotId)
    );
  }, [cardPickerSlotId, slimItems, user]);

  const filteredCards = useMemo(() => {
    if (filterRarity === 'all') return validCards;
    return validCards.filter((c) => c.rarity === filterRarity);
  }, [validCards, filterRarity]);

  const currentlyEquipped = cardPickerSlotId ? user?.equipped?.[cardPickerSlotId] : undefined;

  const handleSelect = async (itemId: string) => {
    if (!cardPickerSlotId || equipping) return;
    setEquipping(itemId);
    try {
      if (currentlyEquipped === itemId) {
        await unequipCard(cardPickerSlotId);
      } else {
        await equipCard(cardPickerSlotId, itemId);
      }
      closeCardPicker();
    } finally {
      setEquipping(null);
    }
  };

  const handleUnequipCurrent = async () => {
    if (!cardPickerSlotId || !currentlyEquipped) return;
    setEquipping('__unequip__');
    try {
      await unequipCard(cardPickerSlotId);
      closeCardPicker();
    } finally {
      setEquipping(null);
    }
  };

  if (!isOpen) return null;

  const rarities = ['all', 'common', 'rare', 'epic', 'legendary'];

  return (
    <>
      <div className="fixed inset-0 bg-black/60 z-40" onClick={closeCardPicker} />

      <div className="fixed bottom-0 left-0 right-0 z-50 bg-slate-900 border-t border-slate-700 rounded-t-2xl max-h-[80vh] flex flex-col">
        <div className="flex flex-col items-center pt-3 px-4 pb-2 border-b border-slate-700">
          <div className="w-10 h-1 bg-slate-600 rounded-full mb-3" />
          <div className="flex items-center justify-between w-full">
            <div>
              <h3 className="text-white font-bold text-base">Choose a Card</h3>
              <p className="text-slate-400 text-xs">
                Slot: <span className="font-mono">{cardPickerSlotId}</span>
              </p>
            </div>
            <button
              onClick={closeCardPicker}
              className="w-8 h-8 flex items-center justify-center rounded-lg bg-slate-800 text-slate-400 hover:text-white text-lg"
            >
              √ó
            </button>
          </div>
        </div>

        <div className="flex gap-2 px-4 py-2 overflow-x-auto">
          {rarities.map((r) => (
            <button
              key={r}
              onClick={() => setFilterRarity(r)}
              className={`px-3 py-1 rounded-full text-xs font-semibold capitalize whitespace-nowrap transition-colors ${
                filterRarity === r
                  ? 'bg-indigo-600 text-white'
                  : 'bg-slate-700 text-slate-300 hover:bg-slate-600'
              }`}
            >
              {r}
            </button>
          ))}
        </div>

        {currentlyEquipped && (
          <div className="px-4 py-2 border-b border-slate-700">
            <button
              onClick={handleUnequipCurrent}
              disabled={!!equipping}
              className="w-full flex items-center justify-center gap-2 bg-red-900/40 hover:bg-red-900/60 border border-red-800 rounded-lg py-2 text-red-300 text-sm font-semibold transition-colors"
            >
              {equipping === '__unequip__' ? 'Removing...' : '‚Ü© Remove equipped card'}
            </button>
          </div>
        )}

        <div className="overflow-y-auto flex-1 px-4 py-3">
          {filteredCards.length === 0 ? (
            <div className="flex flex-col items-center justify-center py-12 text-slate-500">
              <span className="text-4xl mb-3">üÉè</span>
              <p className="text-sm">{validCards.length === 0 ? 'No cards owned for this slot yet' : 'No cards match the filter'}</p>
            </div>
          ) : (
            <div className="grid grid-cols-3 gap-3">
              {filteredCards.map((item) => {
                const isEquipped = user?.equipped?.[cardPickerSlotId!] === item.id;
                return (
                  <div key={item.id} className="flex flex-col items-center gap-1">
                    <ChemCard
                      item={item}
                      size="md"
                      isEquipped={isEquipped}
                      onClick={() => handleSelect(item.id)}
                    />
                    <button
                      onClick={() => openCardDetail(item.id)}
                      className="text-slate-500 hover:text-slate-300 text-xs transition-colors"
                    >
                      details ‚Üí
                    </button>
                  </div>
                );
              })}
            </div>
          )}
        </div>
      </div>
    </>
  );
};


===== src/components/chemcity/ChemCard.tsx =====

import React from 'react';
import type { SlimItemDocument } from '../../lib/chemcity/types';

const RARITY_STYLES: Record<string, { bg: string; border: string; badge: string }> = {
  common: { bg: 'from-slate-700 to-slate-600', border: 'border-slate-500', badge: 'bg-slate-500 text-white' },
  rare: { bg: 'from-blue-700 to-indigo-600', border: 'border-blue-400', badge: 'bg-blue-500 text-white' },
  epic: { bg: 'from-purple-700 to-pink-600', border: 'border-purple-400', badge: 'bg-purple-500 text-white' },
  legendary: { bg: 'from-amber-600 to-yellow-400', border: 'border-yellow-300', badge: 'bg-yellow-400 text-slate-900' },
};

interface ChemCardProps {
  item: SlimItemDocument;
  isEquipped?: boolean;
  isOwned?: boolean;
  size?: 'sm' | 'md' | 'lg';
  onClick?: () => void;
  showDetailHint?: boolean;
}

export const ChemCard: React.FC<ChemCardProps> = ({
  item,
  isEquipped = false,
  isOwned = true,
  size = 'md',
  onClick,
}) => {
  const style = RARITY_STYLES[item.rarity] ?? RARITY_STYLES.common;

  const sizeClasses = {
    sm: 'w-20 h-28 text-xs',
    md: 'w-28 h-40 text-sm',
    lg: 'w-36 h-52 text-base',
  }[size];

  const emojiSize = { sm: 'text-2xl', md: 'text-3xl', lg: 'text-4xl' }[size];
  const formulaSize = { sm: 'text-xs', md: 'text-xs', lg: 'text-sm' }[size];
  const imageSize = { sm: 'w-10 h-10', md: 'w-14 h-14', lg: 'w-16 h-16' }[size];

  return (
    <button
      onClick={onClick}
      className={`relative flex flex-col items-center justify-between ${sizeClasses} bg-gradient-to-b ${style.bg} border-2 ${style.border} rounded-xl p-2 cursor-pointer transition-transform duration-150 active:scale-95 ${
        isEquipped ? 'ring-2 ring-green-400 ring-offset-1 ring-offset-slate-900' : ''
      } ${!isOwned ? 'opacity-50 grayscale' : ''} ${size === 'lg' ? 'shadow-lg' : 'shadow-md'}`}
      aria-label={`${item.name} card`}
    >
      <span className={`absolute top-1 right-1 text-xs font-bold rounded px-1 py-0.5 ${style.badge} ${size === 'sm' ? 'hidden' : ''}`}>
        {item.rarityValue === 4 ? '‚òÖ‚òÖ‚òÖ' : item.rarityValue === 3 ? '‚òÖ‚òÖ' : item.rarityValue === 2 ? '‚òÖ' : '¬∑'}
      </span>

      {isEquipped && (
        <span className="absolute top-1 left-1 bg-green-400 text-slate-900 text-xs font-bold rounded px-1">
          ‚úì
        </span>
      )}

      {item.imageUrl ? (
        <img
          src={item.imageUrl}
          alt={item.name}
          className={`${imageSize} mt-2 object-contain rounded-lg shadow-sm`}
          loading="lazy"
          onError={(e) => {
            (e.target as HTMLImageElement).style.display = 'none';
          }}
        />
      ) : (
        <span className={`${emojiSize} mt-2`}>{item.emoji}</span>
      )}

      <div className="text-center mt-auto w-full">
        <p className="text-white font-semibold leading-tight truncate px-1">{item.name}</p>
        <p className={`${formulaSize} text-white/70 font-mono`}>{item.chemicalFormula}</p>
      </div>
    </button>
  );
};


===== src/components/chemcity/ChemCityMap.tsx =====

import React, { useEffect, useRef, useState } from 'react';
import { useChemCityStore } from '../../store/chemcityStore';
import { PassiveIncomeCollector } from './PassiveIncomeCollector';

export const ChemCityMap: React.FC = () => {
  const user = useChemCityStore((s) => s.user);
  const places = useChemCityStore((s) => s.places);
  const navigateToPlace = useChemCityStore((s) => s.navigateToPlace);
  const openPlaceUnlockModal = useChemCityStore((s) => s.openPlaceUnlockModal);
  const [mapLevel, setMapLevel] = useState<'world' | 'home'>('world');

  const isHotspotEditorEnabled = false;
  const [editMode, setEditMode] = useState(false);
  const [selectedHotspotKey, setSelectedHotspotKey] = useState<string | null>(null);

  const mapImgRef = useRef<HTMLImageElement | null>(null);
  const [mapNaturalWidth, setMapNaturalWidth] = useState(0);
  const [mapRenderedWidth, setMapRenderedWidth] = useState(0);
  const [worldHotspots, setWorldHotspots] = useState<
    Array<{
      key: string;
      label: string;
      placeId?: string;
      leftPct: number;
      topPct: number;
      action?: 'home';
    }>
  >([
    { key: 'school', label: 'School', placeId: 'school', leftPct: 32.372, topPct: 34.495 },
    { key: 'beach', label: 'Beach', placeId: 'beach', leftPct: 44.952, topPct: 74.039 },
    { key: 'boutique', label: 'Boutique', placeId: 'lifestyle_boutique', leftPct: 29.487, topPct: 63.241 },
    { key: 'gas_station', label: 'Gas Station', placeId: 'gas_station', leftPct: 67.147, topPct: 50.761 },
    { key: 'home', label: 'Home', leftPct: 48.958, topPct: 50.06, action: 'home' },
  ]);

  const [homeHotspots, setHomeHotspots] = useState<
    Array<{
      key: string;
      label: string;
      placeId: string;
      leftPct: number;
      topPct: number;
    }>
  >([
    { key: 'toilet', label: 'Toilet', placeId: 'toilet', leftPct: 29.728, topPct: 49.079 },
    { key: 'kitchen', label: 'Kitchen', placeId: 'kitchen', leftPct: 29.728, topPct: 73.057 },
    { key: 'garden', label: 'Garden', placeId: 'garden', leftPct: 12.26, topPct: 72.496 },
    { key: 'lab', label: 'Lab', placeId: 'lab', leftPct: 73.397, topPct: 49.079 },
  ]);

  const worldHotspotsSnapshot: Array<{
    key: string;
    label: string;
    placeId?: string;
    leftPct: number;
    topPct: number;
    action?: 'home';
  }> = worldHotspots;

  const homeHotspotsSnapshot: Array<{
    key: string;
    label: string;
    placeId: string;
    leftPct: number;
    topPct: number;
  }> = homeHotspots;

  if (!user) return null;

  const placeById = (id: string) => places.find((p) => p.id === id) ?? null;
  const isPlaceUnlocked = (placeId: string) => {
    const place = placeById(placeId);
    if (!place) return false;
    return place.unlockCost === 0 || user.unlockedPlaces.includes(placeId as any);
  };

  const mapSrc = mapLevel === 'world' ? '/Map1.png' : '/Map2.png';

  const activeHotspots = mapLevel === 'world' ? worldHotspots : homeHotspots;

  useEffect(() => {
    const img = mapImgRef.current;
    if (!img) return;

    const update = () => {
      const rect = img.getBoundingClientRect();
      setMapRenderedWidth(rect.width);
    };

    update();

    let ro: ResizeObserver | null = null;
    if (typeof ResizeObserver !== 'undefined') {
      ro = new ResizeObserver(() => update());
      ro.observe(img);
    } else {
      window.addEventListener('resize', update);
    }

    return () => {
      if (ro) ro.disconnect();
      else window.removeEventListener('resize', update);
    };
  }, [mapSrc]);

  const hotspotScale = (() => {
    if (!mapNaturalWidth || !mapRenderedWidth) return 1;
    const scale = mapRenderedWidth / mapNaturalWidth;
    return Math.max(0.65, Math.min(1.25, scale * 1.1));
  })();

  const exportHotspotCoords = async () => {
    const payload = {
      mapLevel,
      hotspots: activeHotspots.map((h) => ({
        key: h.key,
        label: h.label,
        leftPct: h.leftPct,
        topPct: h.topPct,
      })),
    };

    const text = JSON.stringify(payload, null, 2);
    console.log('[ChemCityMap] Hotspot coords export:\n' + text);

    try {
      if (typeof navigator !== 'undefined' && navigator.clipboard?.writeText) {
        await navigator.clipboard.writeText(text);
      }
    } catch {
      // ignore clipboard errors
    }
  };

  const HotspotButton: React.FC<{
    label: string;
    leftPct: number;
    topPct: number;
    scale: number;
    onClick: () => void;
    disabled?: boolean;
    locked?: boolean;
  }> = ({ label, leftPct, topPct, scale, onClick, disabled, locked }) => {
    return (
      <button
        type="button"
        aria-label={label}
        title={locked ? `${label} (Locked ‚Äî tap to unlock)` : label}
        onClick={(e) => {
          e.stopPropagation();
          if (disabled) return;
          onClick();
        }}
        disabled={disabled}
        className={`absolute rounded-full border font-bold shadow-md transition-all px-4 py-2 text-xs ${
          disabled
            ? 'bg-slate-800/80 border-slate-700 text-slate-500 cursor-not-allowed'
            : locked
            ? 'bg-slate-800/90 hover:bg-slate-700 border-amber-600/80 text-amber-300 active:scale-95'
            : 'bg-indigo-500/90 hover:bg-indigo-400 border-indigo-200 text-white active:scale-95'
        }`}
        style={{
          left: `${leftPct}%`,
          top: `${topPct}%`,
          transform: `translate(-50%, -50%) scale(${scale})`,
          transformOrigin: 'center',
        }}
      >
        {locked ? `üîí ${label}` : label}
      </button>
    );
  };

  return (
    <div className="relative w-full h-full flex-1">
      <PassiveIncomeCollector />

      <div className="absolute inset-0 overflow-auto">
        <div
          className="relative w-full"
          onClick={(e) => {
            if (!isHotspotEditorEnabled) return;
            if (!editMode) return;
            if (!selectedHotspotKey) return;

            const target = e.currentTarget;
            const rect = target.getBoundingClientRect();
            const leftPct = ((e.clientX - rect.left) / rect.width) * 100;
            const topPct = ((e.clientY - rect.top) / rect.height) * 100;
            const leftRounded = Math.round(leftPct * 1000) / 1000;
            const topRounded = Math.round(topPct * 1000) / 1000;

            const leftClamped = Math.max(0, Math.min(100, leftRounded));
            const topClamped = Math.max(0, Math.min(100, topRounded));

            if (mapLevel === 'world') {
              setWorldHotspots((hs) =>
                hs.map((h) => (h.key === selectedHotspotKey ? { ...h, leftPct: leftClamped, topPct: topClamped } : h)),
              );
            } else {
              setHomeHotspots((hs) =>
                hs.map((h) => (h.key === selectedHotspotKey ? { ...h, leftPct: leftClamped, topPct: topClamped } : h)),
              );
            }

            console.log(
              `[ChemCityMap] ${mapLevel} set ${selectedHotspotKey}: leftPct=${leftClamped}, topPct=${topClamped}`,
            );
          }}
        >
          <img
            ref={mapImgRef}
            src={mapSrc}
            alt={mapLevel === 'world' ? 'ChemCity world map' : 'ChemCity home map'}
            className="w-full h-auto"
            loading="lazy"
            onLoad={(e) => {
              const el = e.currentTarget;
              if (el.naturalWidth) setMapNaturalWidth(el.naturalWidth);
              const rect = el.getBoundingClientRect();
              setMapRenderedWidth(rect.width);
            }}
          />

        {mapLevel === 'world'
          ? worldHotspotsSnapshot.map((h) => (
            <HotspotButton
              key={h.key}
              label={h.label}
              leftPct={h.leftPct}
              topPct={h.topPct}
              scale={hotspotScale}
              locked={h.placeId ? !isPlaceUnlocked(h.placeId) : false}
              onClick={() => {
                if (isHotspotEditorEnabled && editMode) {
                  setSelectedHotspotKey(h.key);
                  return;
                }
                if (h.action === 'home') {
                  setMapLevel('home');
                  return;
                }
                if (!h.placeId) return;
                if (!isPlaceUnlocked(h.placeId)) {
                  openPlaceUnlockModal(h.placeId);
                  return;
                }
                navigateToPlace(h.placeId);
              }}
              disabled={h.placeId ? !placeById(h.placeId) : false}
            />
          ))
          : homeHotspotsSnapshot.map((h) => (
            <HotspotButton
              key={h.key}
              label={h.label}
              leftPct={h.leftPct}
              topPct={h.topPct}
              scale={hotspotScale}
              onClick={() => {
                if (isHotspotEditorEnabled && editMode) {
                  setSelectedHotspotKey(h.key);
                  return;
                }
                if (!isPlaceUnlocked(h.placeId)) {
                  openPlaceUnlockModal(h.placeId);
                  return;
                }
                navigateToPlace(h.placeId);
              }}
              disabled={!placeById(h.placeId)}
              locked={!isPlaceUnlocked(h.placeId)}
            />
          ))}

        {isHotspotEditorEnabled && (
          <div
            className="absolute left-3 bottom-3 z-20 pointer-events-auto"
            onClick={(e) => e.stopPropagation()}
            onMouseDown={(e) => e.stopPropagation()}
            onPointerDown={(e) => e.stopPropagation()}
          >
            <div className="flex items-center gap-2">
              <button
                type="button"
                onClick={() => {
                  setEditMode((v) => !v);
                  setSelectedHotspotKey(null);
                }}
                className={`text-xs font-bold rounded-xl px-3 py-2 border backdrop-blur transition-colors ${
                  editMode
                    ? 'bg-indigo-600/90 border-indigo-300 text-white'
                    : 'bg-slate-900/80 hover:bg-slate-800 border-slate-700 text-slate-200'
                }`}
              >
                {editMode ? 'Editing' : 'Edit hotspots'}
              </button>
              {editMode && (
                <button
                  type="button"
                  onClick={() => exportHotspotCoords()}
                  className="text-xs font-bold rounded-xl px-3 py-2 border bg-slate-900/80 hover:bg-slate-800 border-slate-700 text-slate-200 backdrop-blur transition-colors"
                >
                  Export
                </button>
              )}
            </div>

            {editMode && (
              <div className="mt-2 p-2 rounded-xl bg-slate-900/80 border border-slate-700 backdrop-blur max-w-[86vw]">
                <div className="flex flex-wrap gap-1.5">
                  {activeHotspots.map((h) => (
                    <button
                      key={h.key}
                      type="button"
                      onClick={() => setSelectedHotspotKey(h.key)}
                      className={`text-[11px] font-bold rounded-lg px-2 py-1 border transition-colors ${
                        selectedHotspotKey === h.key
                          ? 'bg-indigo-600 border-indigo-300 text-white'
                          : 'bg-slate-800 border-slate-600 text-slate-200 hover:bg-slate-700'
                      }`}
                    >
                      {h.label}
                    </button>
                  ))}
                </div>
                <div className="mt-1 text-slate-300/80 text-[11px]">
                  {selectedHotspotKey
                    ? `Click map to set: ${selectedHotspotKey}`
                    : 'Select a hotspot, then click on the map'}
                </div>
              </div>
            )}
          </div>
        )}

        {mapLevel === 'home' && (
          <button
            type="button"
            onClick={() => setMapLevel('world')}
            className="absolute left-3 bottom-[4.5rem] z-10 w-12 h-12 rounded-2xl bg-slate-900/80 hover:bg-slate-800 border border-slate-700 backdrop-blur text-white font-bold"
            aria-label="Back to city map"
            title="Back"
          >
            ‚Üê
          </button>
        )}
        </div>
      </div>
    </div>
  );
};


===== src/components/chemcity/ChemCityRoot.tsx =====

import React, { useEffect } from 'react';
import { useAuth } from '../../contexts/AuthContext';
import { useChemCityStore } from '../../store/chemcityStore';
import { CurrencyBar } from './CurrencyBar';
import { ChemCityMap } from './ChemCityMap';
import { PlaceView } from './PlaceView';
import { CardInventory } from './CardInventory';
import { CardPicker } from './CardPicker';
import { CardDetail } from './CardDetail';
import { DailyLoginModal } from './DailyLoginModal';
import { QuizRewardModal } from './QuizRewardModal';
import { ChemStore } from './ChemStore';
import { PurchaseConfirmModal } from './PurchaseConfirmModal';
import { PlaceUnlockModal } from './PlaceUnlockModal';
import { GasStationDistributor } from './GasStationDistributor';

export const ChemCityRoot: React.FC = () => {
  const { currentUser } = useAuth();

  const view = useChemCityStore((s) => s.view);
  const isLoading = useChemCityStore((s) => s.isLoading);
  const error = useChemCityStore((s) => s.error);
  const loadAll = useChemCityStore((s) => s.loadAll);
  const teardown = useChemCityStore((s) => s.teardown);
  const dailyLoginOpen = useChemCityStore((s) => s.dailyLogin.showModal);

  useEffect(() => {
    if (!currentUser?.uid) return;
    loadAll(currentUser.uid);
    return () => {
      teardown();
    };
  }, [currentUser?.uid, loadAll, teardown]);

  if (!currentUser) {
    return (
      <div className="flex flex-col min-h-screen bg-slate-950 items-center justify-center gap-4 px-8">
        <span className="text-5xl">üß™</span>
        <p className="text-slate-400 text-sm text-center">Please sign in to access ChemCity.</p>
      </div>
    );
  }

  if (isLoading) {
    return (
      <div className="flex flex-col min-h-screen bg-slate-950 items-center justify-center gap-4">
        <span className="text-5xl animate-pulse">üß™</span>
        <p className="text-slate-400 text-sm">Loading ChemCity...</p>
      </div>
    );
  }

  if (error) {
    return (
      <div className="flex flex-col min-h-screen bg-slate-950 items-center justify-center gap-4 px-8">
        <span className="text-4xl">‚ö†Ô∏è</span>
        <p className="text-red-400 text-sm text-center">{error}</p>
        <button
          onClick={() => window.location.reload()}
          className="bg-slate-700 hover:bg-slate-600 text-white rounded-lg px-4 py-2 text-sm"
        >
          Retry
        </button>
      </div>
    );
  }

  return (
    <div className="relative flex flex-col min-h-screen bg-slate-950 text-white overflow-hidden">
      <CurrencyBar />

      <main className="flex-1 overflow-hidden flex flex-col">
        {view === 'map' && <ChemCityMap />}
        {view === 'place' && <PlaceView />}
        {view === 'inventory' && <CardInventory />}
        {view === 'store' && <ChemStore />}
        {view === 'gas_station_distributor' && <GasStationDistributor />}
      </main>

      <CardPicker />
      <CardDetail />

      <DailyLoginModal />
      {!dailyLoginOpen && <QuizRewardModal />}

      <PlaceUnlockModal />
      <PurchaseConfirmModal />
    </div>
  );
};


===== src/components/chemcity/ChemStore.tsx =====

import React, { useEffect, useState } from 'react';
import { useChemCityStore } from '../../store/chemcityStore';
import { getEffectiveCoinPrice } from '../../lib/chemcity/shop';
import {
  countdownToMidnight,
  STORE_SLOT_UNLOCK_COSTS,
  STORE_MAX_SLOTS,
} from '../../lib/chemcity/dailyStore';

const RARITY_STYLES: Record<string, { bg: string; border: string; pill: string; glow: string }> = {
  common: { bg: 'from-slate-700 to-slate-600', border: 'border-slate-500', pill: 'bg-slate-600 text-white', glow: '' },
  rare: { bg: 'from-blue-800 to-indigo-700', border: 'border-blue-500', pill: 'bg-blue-600 text-white', glow: 'shadow-blue-500/30' },
  epic: { bg: 'from-purple-800 to-pink-700', border: 'border-purple-500', pill: 'bg-purple-600 text-white', glow: 'shadow-purple-500/30' },
  legendary: { bg: 'from-amber-700 to-yellow-500', border: 'border-yellow-400', pill: 'bg-yellow-400 text-slate-900', glow: 'shadow-yellow-400/40' },
};

export const ChemStore: React.FC = () => {
  const user = useChemCityStore((s) => s.user);
  const dailyStoreItems = useChemCityStore((s) => s.dailyStoreItems);
  const storeSlotCount = useChemCityStore((s) => s.storeSlotCount);
  const openPurchaseConfirm = useChemCityStore((s) => s.openPurchaseConfirm);
  const unlockStoreSlot = useChemCityStore((s) => s.unlockStoreSlot);

  const [countdown, setCountdown] = useState(() => countdownToMidnight());
  const [unlockingSlot, setUnlockingSlot] = useState(false);
  const [unlockError, setUnlockError] = useState<string | null>(null);

  useEffect(() => {
    const id = setInterval(() => setCountdown(countdownToMidnight()), 1000);
    return () => clearInterval(id);
  }, []);

  const discount = user?.activeBonuses.shopDiscountPercent ?? 0;
  const coins = user?.currencies.coins ?? 0;
  const ownedSet = new Set(user?.ownedItems ?? []);

  const nextSlotNum = storeSlotCount + 1;
  const nextSlotCost = STORE_SLOT_UNLOCK_COSTS[nextSlotNum] ?? null;
  const canUnlockMore = storeSlotCount < STORE_MAX_SLOTS;
  const canAffordNext = nextSlotCost != null && coins >= nextSlotCost;

  const handleUnlockSlot = async () => {
    if (unlockingSlot || !canUnlockMore || !canAffordNext) return;
    setUnlockingSlot(true);
    setUnlockError(null);
    try {
      await unlockStoreSlot();
    } catch (err: any) {
      setUnlockError(err?.message ?? 'Failed to unlock slot.');
    } finally {
      setUnlockingSlot(false);
    }
  };

  return (
    <div className="flex flex-col flex-1" style={{ paddingTop: 76 }}>
      <div className="px-4 pt-3 pb-3 border-b border-slate-800">
        <div className="flex items-center justify-between gap-2">
          <div className="flex items-center gap-2">
            <span className="text-2xl">üè™</span>
            <div>
              <h2 className="text-white font-bold text-lg leading-tight">ChemStore</h2>
              <p className="text-slate-400 text-xs">New stock in {countdown}</p>
            </div>
          </div>
          {discount > 0 && (
            <span className="bg-emerald-600 text-white text-xs font-bold rounded-full px-3 py-1 shrink-0">
              {discount}% OFF
            </span>
          )}
        </div>

        <div className="flex items-center gap-1.5 mt-3">
          {Array.from({ length: STORE_MAX_SLOTS }, (_, i) => (
            <div
              key={i}
              className={`h-1.5 flex-1 rounded-full transition-colors ${i < storeSlotCount ? 'bg-indigo-500' : 'bg-slate-700'}`}
            />
          ))}
          <span className="text-slate-400 text-xs ml-1 shrink-0">
            {storeSlotCount}/{STORE_MAX_SLOTS} slots
          </span>
        </div>
      </div>

      <div className="overflow-y-auto flex-1 px-4 pt-4 pb-6">
        {dailyStoreItems.length === 0 ? (
          <div className="flex flex-col items-center justify-center py-16 text-slate-500">
            <span className="text-5xl mb-3 animate-pulse">üè™</span>
            <p className="text-sm">Store loading‚Ä¶</p>
          </div>
        ) : (
          <div className="flex flex-col gap-3">
            {dailyStoreItems.map((item, idx) => {
              const isOwned = ownedSet.has(item.id);
              const style = RARITY_STYLES[item.rarity] ?? RARITY_STYLES.common;
              const rawCoin = item.shopData?.coinCost;
              const rawDiamond = item.shopData?.diamondCost;
              const effCoin = rawCoin != null ? getEffectiveCoinPrice(rawCoin, user?.activeBonuses ?? null) : null;
              const coinSaved = rawCoin != null && effCoin != null ? rawCoin - effCoin : 0;

              return (
                <button
                  key={item.id}
                  onClick={() => openPurchaseConfirm(item.id)}
                  className={`relative flex items-center gap-4 rounded-2xl border-2 ${style.border} bg-gradient-to-r ${style.bg} p-3 text-left transition-transform active:scale-[0.98] shadow-lg ${style.glow ? `shadow-lg ${style.glow}` : ''}`}
                >
                  <span className="absolute top-2 left-2.5 text-[10px] text-white/30 font-mono">#{idx + 1}</span>

                  {isOwned && (
                    <span className="absolute top-2 right-2 bg-green-500 text-white text-[10px] font-bold rounded-full px-2 py-0.5">
                      ‚úì Owned
                    </span>
                  )}

                  <div className="w-16 h-16 shrink-0 flex items-center justify-center rounded-xl bg-white/10 mt-3">
                    {item.imageUrl ? (
                      <img
                        src={item.imageUrl}
                        alt={item.name}
                        className="w-14 h-14 object-contain rounded-lg"
                        loading="lazy"
                        onError={(e) => {
                          (e.target as HTMLImageElement).style.display = 'none';
                        }}
                      />
                    ) : (
                      <span className="text-4xl">{item.emoji}</span>
                    )}
                  </div>

                  <div className="flex-1 min-w-0 pr-2 mt-3">
                    <p className="text-white font-bold text-base leading-tight truncate">{item.name}</p>
                    <p className="text-white/60 font-mono text-sm">{item.chemicalFormula}</p>
                    <div className="flex items-center gap-1.5 mt-1.5">
                      <span className={`text-[10px] font-bold rounded-full px-2 py-0.5 capitalize ${style.pill}`}>{item.rarity}</span>
                      <span className="text-white/40 text-[10px] capitalize">{item.placeId?.replace(/_/g, ' ')}</span>
                    </div>
                  </div>

                  <div className="shrink-0 text-right mt-3">
                    {effCoin != null && (
                      <div>
                        <p className="text-yellow-300 font-black text-lg tabular-nums leading-tight">ü™ô {effCoin.toLocaleString()}</p>
                        {coinSaved > 0 && (
                          <p className="text-slate-400 text-xs line-through tabular-nums">{rawCoin!.toLocaleString()}</p>
                        )}
                      </div>
                    )}
                    {rawDiamond != null && (
                      <p className="text-cyan-300 font-black text-lg tabular-nums leading-tight">üíé {rawDiamond.toLocaleString()}</p>
                    )}
                  </div>
                </button>
              );
            })}
          </div>
        )}

        {canUnlockMore && (
          <div className="mt-6">
            <p className="text-slate-500 text-xs text-center mb-3">Unlock more store slots to see more cards each day</p>
            <button
              onClick={handleUnlockSlot}
              disabled={!canAffordNext || unlockingSlot}
              className={`w-full flex flex-col items-center gap-1.5 border-2 border-dashed rounded-2xl py-4 transition-all active:scale-[0.98] ${
                canAffordNext && !unlockingSlot
                  ? 'border-indigo-500/60 bg-indigo-900/20 hover:bg-indigo-900/30 cursor-pointer'
                  : 'border-slate-700 bg-slate-900/40 cursor-not-allowed opacity-60'
              }`}
            >
              <span className="text-2xl">{unlockingSlot ? '‚è≥' : 'üîì'}</span>
              <p className="text-white font-semibold text-sm">Unlock Slot #{nextSlotNum}</p>
              {nextSlotCost != null && (
                <p className={`text-sm font-bold tabular-nums ${canAffordNext ? 'text-yellow-300' : 'text-slate-500'}`}>
                  ü™ô {nextSlotCost.toLocaleString()}
                </p>
              )}
              {!canAffordNext && nextSlotCost != null && (
                <p className="text-slate-600 text-xs">Need {(nextSlotCost - coins).toLocaleString()} more coins</p>
              )}
              {unlockError && <p className="text-red-400 text-xs mt-1">{unlockError}</p>}
            </button>
          </div>
        )}

        {storeSlotCount === STORE_MAX_SLOTS && (
          <p className="text-slate-700 text-xs text-center mt-6">All store slots unlocked ‚úì</p>
        )}
      </div>
    </div>
  );
};


===== src/components/chemcity/CurrencyBar.tsx =====

// ==============================
// FILE: src/components/chemcity/CurrencyBar.tsx
// ==============================
import React, { useMemo, useState } from 'react';
import { useChemCityStore } from '../../store/chemcityStore';

export const CurrencyBar: React.FC = () => {
  const user = useChemCityStore((s) => s.user);
  const places = useChemCityStore((s) => s.places);
  const view = useChemCityStore((s) => s.view);
  const selectedPlaceId = useChemCityStore((s) => s.selectedPlaceId);
  const navigateToMap = useChemCityStore((s) => s.navigateToMap);
  const navigateToInventory = useChemCityStore((s) => s.navigateToInventory);
  const navigateToStore = useChemCityStore((s) => s.navigateToStore);
  const navigateToGasStationDistributor = useChemCityStore((s) => s.navigateToGasStationDistributor);

  const [skillsOpen, setSkillsOpen] = useState(false);

  const coins = user?.currencies.coins ?? 0;
  const diamonds = user?.currencies.diamonds ?? 0;

  const showGasDistributorButton =
    view === 'place' && selectedPlaceId === 'gas_station' && (user?.extraSlotsBudget ?? 0) > 0;

  const skillSummaryByPlaceId = useMemo(() => {
    const bonuses = user?.activeBonuses;
    if (!bonuses) return {} as Record<string, string>;

    return {
      garden: `${bonuses.passiveBaseCoinsPerHour.toLocaleString()} ü™ô/hr`,
      lab: `${bonuses.passiveMultiplier.toFixed(1)}√ó multiplier`,
      kitchen: `+${bonuses.quizFlatDiamondBonus} üíé max bonus`,
      school: `${bonuses.quizDiamondMultiplier.toFixed(1)}√ó quiz diamonds`,
      beach: `${bonuses.quizDoubleChancePercent}% double chance`,
      toilet: `${bonuses.dailyLoginDiamonds} üíé daily`,
      gas_station: `${bonuses.extraSlotsTotal} bonus slots`,
      lifestyle_boutique: `${bonuses.shopDiscountPercent}% store discount`,
    };
  }, [user?.activeBonuses]);

  return (
    <>
      {/*
        Positioned BELOW the main site header (~76px tall).
        Using top-[84px] = 76px header + 8px breathing room.
      */}
      <div className="fixed top-[84px] left-3 right-3 z-50 flex items-center justify-between gap-2 pointer-events-none">
        {/* Left: back button */}
        <div className="flex items-center pointer-events-auto">
          {view !== 'map' && (
            <button
              onClick={navigateToMap}
              className="
                flex items-center justify-center
                w-9 h-9 rounded-xl
                bg-slate-900/90 hover:bg-slate-800
                border border-slate-600
                backdrop-blur-md shadow-lg
                transition-all active:scale-95
                text-white text-base
              "
              aria-label="Back to map"
            >
              ‚Üê
            </button>
          )}
        </div>

        {/* Right: currency + action buttons */}
        <div className="flex items-center gap-2 pointer-events-auto">
          {/* Coins pill */}
          <div className="
            flex items-center gap-1.5
            bg-slate-900/90 border border-slate-600
            backdrop-blur-md shadow-lg
            rounded-full px-3 py-1.5
          ">
            <span className="text-yellow-400 text-sm leading-none">ü™ô</span>
            <span className="text-white text-sm font-bold tabular-nums leading-none">
              {coins.toLocaleString()}
            </span>
          </div>

          {/* Diamonds pill */}
          <div className="
            flex items-center gap-1.5
            bg-slate-900/90 border border-slate-600
            backdrop-blur-md shadow-lg
            rounded-full px-3 py-1.5
          ">
            <span className="text-cyan-400 text-sm leading-none">üíé</span>
            <span className="text-white text-sm font-bold tabular-nums leading-none">
              {diamonds.toLocaleString()}
            </span>
          </div>

          {/* Skills button */}
          <button
            onClick={() => setSkillsOpen(true)}
            className="
              flex items-center justify-center
              w-9 h-9 rounded-xl
              bg-slate-900/90 hover:bg-slate-800
              border border-slate-600
              backdrop-blur-md shadow-lg
              transition-all active:scale-95
              text-sm text-slate-200
            "
            aria-label="Skill boosts"
            title="Skill boosts"
          >
            ‚ú®
          </button>

          {/* Store button */}
          <button
            onClick={navigateToStore}
            className={`
              flex items-center justify-center
              w-9 h-9 rounded-xl
              border backdrop-blur-md shadow-lg
              transition-all active:scale-95
              text-sm
              ${view === 'store'
                ? 'bg-indigo-600/90 border-indigo-400 text-white'
                : 'bg-slate-900/90 hover:bg-slate-800 border-slate-600 text-slate-200'
              }
            `}
            aria-label="ChemStore"
            title="ChemStore"
          >
            üè™
          </button>

          {/* Inventory button */}
          <button
            onClick={navigateToInventory}
            className={`
              flex items-center justify-center
              w-9 h-9 rounded-xl
              border backdrop-blur-md shadow-lg
              transition-all active:scale-95
              text-sm
              ${view === 'inventory'
                ? 'bg-indigo-600/90 border-indigo-400 text-white'
                : 'bg-slate-900/90 hover:bg-slate-800 border-slate-600 text-slate-200'
              }
            `}
            aria-label="Card inventory"
            title="Card Inventory"
          >
            üÉè
          </button>

          {showGasDistributorButton && (
            <button
              onClick={navigateToGasStationDistributor}
              className={`
                flex items-center justify-center
                w-9 h-9 rounded-xl
                border backdrop-blur-md shadow-lg
                transition-all active:scale-95
                text-sm
                bg-amber-600/80 hover:bg-amber-500/80 border-amber-500 text-white
              `}
              aria-label="Distribute bonus slots"
              title="Distribute bonus slots"
            >
              ‚õΩ
            </button>
          )}
        </div>
      </div>

      {/* Skills modal */}
      {skillsOpen && (
        <div
          className="fixed inset-0 z-[60] bg-slate-950/70 backdrop-blur-sm flex items-center justify-center p-4"
          onClick={() => setSkillsOpen(false)}
          role="dialog"
          aria-modal="true"
        >
          <div
            className="w-full max-w-xl rounded-2xl border border-slate-700 bg-slate-900 p-4"
            onClick={(e) => e.stopPropagation()}
          >
            <div className="flex items-center justify-between gap-3 mb-3">
              <h3 className="text-white font-bold">Skill Boosts</h3>
              <button
                type="button"
                onClick={() => setSkillsOpen(false)}
                className="w-9 h-9 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-600 text-slate-200 transition-colors"
                aria-label="Close"
              >
                ‚úï
              </button>
            </div>

            <div className="space-y-2 max-h-[70vh] overflow-y-auto">
              {places.map((p) => (
                <div
                  key={p.id}
                  className="flex items-center justify-between gap-3 rounded-xl bg-slate-800/60 border border-slate-700 px-3 py-2"
                >
                  <div className="flex items-center gap-2 min-w-0">
                    <span className="text-xl">{p.emoji}</span>
                    <div className="min-w-0">
                      <div className="text-white text-sm font-bold truncate">{p.displayName}</div>
                      <div className="text-slate-400 text-xs truncate">{p.skill.description}</div>
                    </div>
                  </div>
                  <div className="text-indigo-200 text-sm font-bold shrink-0">
                    {skillSummaryByPlaceId[p.id] ?? '‚Äî'}
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      )}
    </>
  );
};

===== src/components/chemcity/DailyLoginModal.tsx =====

import React, { useMemo } from 'react';
import { useChemCityStore } from '../../store/chemcityStore';

function milestoneMessage(streak: number): string {
  if (streak === 1) return 'Welcome back! üëã';
  if (streak === 7) return '7-day streak! üéâ';
  if (streak === 30) return '30-day legend! üèÜ';
  if (streak % 10 === 0) return `${streak} days strong! ‚ö°`;
  return `${streak}-day streak! üî•`;
}

export const DailyLoginModal: React.FC = () => {
  const dailyLogin = useChemCityStore((s) => s.dailyLogin);
  const dismissDailyLogin = useChemCityStore((s) => s.dismissDailyLogin);

  const msg = useMemo(() => milestoneMessage(dailyLogin.streak || 0), [dailyLogin.streak]);

  const isOpen = dailyLogin.showModal;
  if (!isOpen) return null;

  return (
    <>
      <div className="fixed inset-0 bg-black/70 z-[70]" onClick={dismissDailyLogin} />
      <div className="fixed inset-x-4 top-20 z-[80] bg-slate-900 border border-slate-700 rounded-2xl overflow-hidden shadow-2xl">
        <div className="p-4 border-b border-slate-700 flex items-center justify-between">
          <div>
            <h3 className="text-white font-bold text-base">Daily Login Bonus</h3>
            <p className="text-slate-400 text-xs">{msg}</p>
          </div>
          <button
            onClick={dismissDailyLogin}
            className="w-8 h-8 flex items-center justify-center rounded-lg bg-slate-800 text-slate-400 hover:text-white text-lg"
            aria-label="Close"
          >
            √ó
          </button>
        </div>

        <div className="p-4 flex flex-col gap-4">
          <div className="grid grid-cols-2 gap-3">
            <div className="bg-slate-800 border border-slate-700 rounded-xl p-3">
              <p className="text-slate-400 text-xs">Coins</p>
              <p className="text-yellow-300 font-black text-2xl tabular-nums">+{Number(dailyLogin.coins || 0).toLocaleString()} ü™ô</p>
            </div>
            <div className="bg-slate-800 border border-slate-700 rounded-xl p-3">
              <p className="text-slate-400 text-xs">Diamonds</p>
              <p className="text-cyan-300 font-black text-2xl tabular-nums">+{Number(dailyLogin.diamonds || 0).toLocaleString()} üíé</p>
            </div>
          </div>

          <div className="bg-indigo-900/30 border border-indigo-800 rounded-xl p-3">
            <p className="text-indigo-200 text-xs">
              Tip: Equip cards in the <span className="font-bold">üöΩ Toilet</span> to boost daily login diamonds.
            </p>
          </div>

          <div className="flex justify-end">
            <button
              onClick={dismissDailyLogin}
              className="bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg px-4 py-2 text-sm font-bold"
            >
              Nice
            </button>
          </div>
        </div>
      </div>
    </>
  );
};


===== src/components/chemcity/GasStationDistributor.tsx =====

import React, { useMemo, useState } from 'react';
import { useChemCityStore } from '../../store/chemcityStore';

export const GasStationDistributor: React.FC = () => {
  const user = useChemCityStore((s) => s.user);
  const places = useChemCityStore((s) => s.places);
  const unlockSlot = useChemCityStore((s) => s.unlockSlot);

  const [unlockingSlotId, setUnlockingSlotId] = useState<string | null>(null);
  const [recentlyUnlocked, setRecentlyUnlocked] = useState<Set<string>>(new Set());
  const [error, setError] = useState<string | null>(null);

  const budget = user?.extraSlotsBudget ?? 0;

  const gasStationSlots = useMemo(() => {
    if (!user) return [] as Array<{ placeId: string; placeEmoji: string; placeDisplayName: string; slotId: string; slotLabel: string }>;

    const result: Array<{ placeId: string; placeEmoji: string; placeDisplayName: string; slotId: string; slotLabel: string }> = [];

    for (const place of places) {
      if (place.unlockCost > 0 && !user.unlockedPlaces.includes(place.id)) continue;

      for (const slot of place.slots) {
        if (!slot.budgetOnly) continue;
        if (user.unlockedSlots.includes(slot.slotId)) continue;
        if (recentlyUnlocked.has(slot.slotId)) continue;

        result.push({
          placeId: place.id,
          placeEmoji: place.emoji,
          placeDisplayName: place.displayName,
          slotId: slot.slotId,
          slotLabel: slot.slotId.replace(/_/g, ' '),
        });
      }
    }

    return result;
  }, [user, places, recentlyUnlocked]);

  const grouped = useMemo(() => {
    const map = new Map<string, typeof gasStationSlots>();
    for (const s of gasStationSlots) {
      if (!map.has(s.placeId)) map.set(s.placeId, []);
      map.get(s.placeId)!.push(s);
    }
    return Array.from(map.entries()).map(([placeId, slots]) => ({ placeId, slots }));
  }, [gasStationSlots]);

  const handleUnlock = async (placeId: string, slotId: string) => {
    if (unlockingSlotId || budget < 1) return;
    setUnlockingSlotId(slotId);
    setError(null);
    try {
      await unlockSlot(placeId, slotId, true);
      setRecentlyUnlocked((prev) => new Set([...prev, slotId]));
    } catch (err: any) {
      setError(err?.message ?? 'Failed to unlock slot.');
    } finally {
      setUnlockingSlotId(null);
    }
  };

  return (
    <div className="flex flex-col" style={{ paddingTop: 76 }}>
      <div className="px-4 pt-3 pb-3 border-b border-slate-800">
        <div className="flex items-center gap-2 mb-1">
          <span className="text-2xl">‚õΩ</span>
          <h2 className="text-white font-bold text-lg">Gas Station</h2>
        </div>
        <p className="text-slate-400 text-xs mb-3">Use your bonus slot budget to unlock extra card slots across any place.</p>

        <div className="bg-slate-800 border border-slate-700 rounded-xl p-3 flex items-center justify-between">
          <div>
            <p className="text-slate-400 text-xs">Extra Slot Budget</p>
            <p className="text-white font-black text-2xl tabular-nums">{budget}</p>
          </div>
          <div className="text-right">
            <p className="text-slate-400 text-xs">Total unlockable</p>
            <p className="text-slate-300 font-bold text-lg">{gasStationSlots.length}</p>
          </div>
        </div>
      </div>

      <div className="overflow-y-auto flex-1 px-4 py-3 pb-8">
        {budget === 0 && gasStationSlots.length > 0 && (
          <div className="bg-amber-900/30 border border-amber-700 rounded-xl p-3 mb-4">
            <p className="text-amber-200 text-sm">
              üí° Equip more cards in the <span className="font-bold">‚õΩ Gas Station</span> to increase your budget.
            </p>
          </div>
        )}

        {gasStationSlots.length === 0 ? (
          <div className="flex flex-col items-center justify-center py-16 text-slate-500">
            <span className="text-5xl mb-3">‚õΩ</span>
            {user?.extraSlotsBudget === 0 ? (
              <>
                <p className="text-sm text-center">No bonus slots available yet.</p>
                <p className="text-xs text-center mt-1">Equip cards in the Gas Station to earn slot budget.</p>
              </>
            ) : (
              <>
                <p className="text-sm text-center">All extra slots are unlocked!</p>
                <p className="text-xs text-center mt-1">Check back after unlocking more places.</p>
              </>
            )}
          </div>
        ) : (
          <div className="flex flex-col gap-4">
            {error && (
              <div className="bg-red-900/30 border border-red-700 rounded-xl p-3">
                <p className="text-red-300 text-sm">{error}</p>
              </div>
            )}

            {grouped.map(({ placeId, slots }) => {
              const place = places.find((p) => p.id === placeId);
              return (
                <div key={placeId}>
                  <div className="flex items-center gap-2 mb-2">
                    <span className="text-xl">{place?.emoji}</span>
                    <span className="text-slate-300 font-semibold text-sm">{place?.displayName}</span>
                    <span className="text-slate-500 text-xs ml-auto">{slots.length} available</span>
                  </div>

                  <div className="grid grid-cols-2 gap-2">
                    {slots.map(({ slotId, slotLabel }) => {
                      const isUnlocking = unlockingSlotId === slotId;
                      const canAfford = budget >= 1;

                      return (
                        <button
                          key={slotId}
                          onClick={() => handleUnlock(placeId, slotId)}
                          disabled={!canAfford || !!unlockingSlotId}
                          className={`flex items-center justify-between gap-2 rounded-xl border px-3 py-2.5 text-left transition-all active:scale-95 ${
                            canAfford && !unlockingSlotId
                              ? 'bg-slate-800 border-slate-600 hover:border-indigo-500 hover:bg-slate-700 cursor-pointer'
                              : 'bg-slate-900/60 border-slate-800 cursor-not-allowed opacity-60'
                          }`}
                        >
                          <div className="min-w-0">
                            <p className="text-white text-xs font-semibold capitalize leading-tight truncate">{slotLabel}</p>
                            <p className="text-slate-500 text-[10px] font-mono truncate">{slotId}</p>
                          </div>
                          <span
                            className={`shrink-0 text-xs font-bold rounded-lg px-2 py-1 ${
                              canAfford && !unlockingSlotId ? 'bg-indigo-600 text-white' : 'bg-slate-700 text-slate-400'
                            }`}
                          >
                            {isUnlocking ? '‚è≥' : '-1'}
                          </span>
                        </button>
                      );
                    })}
                  </div>
                </div>
              );
            })}
          </div>
        )}
      </div>
    </div>
  );
};


===== src/components/chemcity/PassiveIncomeCollector.tsx =====

import React, { useEffect, useRef, useState } from 'react';
import { useChemCityStore } from '../../store/chemcityStore';
import { formatCoinsPerHour } from '../../lib/chemcity/income';

export const PassiveIncomeCollector: React.FC = () => {
  const user = useChemCityStore((s) => s.user);
  const passiveDisplayCoins = useChemCityStore((s) => s.passiveDisplayCoins);
  const collectIncome = useChemCityStore((s) => s.collectIncome);
  const tickPassiveDisplay = useChemCityStore((s) => s.tickPassiveDisplay);

  const [collecting, setCollecting] = useState(false);
  const [lastCollected, setLastCollected] = useState<number | null>(null);
  const intervalRef = useRef<ReturnType<typeof setInterval> | null>(null);

  const rate = user?.activeBonuses.passiveBaseCoinsPerHour ?? 0;

  useEffect(() => {
    if (rate > 0) {
      tickPassiveDisplay();
      intervalRef.current = setInterval(tickPassiveDisplay, 1000);
    }
    return () => {
      if (intervalRef.current) clearInterval(intervalRef.current);
    };
  }, [rate, tickPassiveDisplay]);

  const handleCollect = async () => {
    if (collecting) return;
    setCollecting(true);
    try {
      const { coinsAwarded } = await collectIncome();
      setLastCollected(coinsAwarded);
      setTimeout(() => setLastCollected(null), 3000);
    } finally {
      setCollecting(false);
    }
  };

  if (rate === 0) return null;

  return (
    <div className="mx-4 my-2 bg-slate-800 border border-slate-600 rounded-xl p-3 flex items-center justify-between gap-3">
      <div className="min-w-0">
        <p className="text-slate-400 text-xs">{formatCoinsPerHour(rate)}</p>
        <div className="flex items-center gap-1 mt-0.5">
          <span className="text-yellow-300 font-bold text-base tabular-nums">
            ü™ô {passiveDisplayCoins.toLocaleString()}
          </span>
          <span className="text-slate-500 text-xs">pending</span>
        </div>
      </div>

      {lastCollected !== null ? (
        <div className="flex items-center gap-1 bg-green-600 rounded-lg px-3 py-1.5 text-white font-bold text-sm">
          +{lastCollected.toLocaleString()} ü™ô
        </div>
      ) : (
        <button
          onClick={handleCollect}
          disabled={collecting || passiveDisplayCoins < 1}
          className={`flex items-center gap-1 rounded-lg px-3 py-1.5 text-sm font-bold transition-all ${
            collecting || passiveDisplayCoins < 1
              ? 'bg-slate-600 text-slate-400 cursor-not-allowed'
              : 'bg-yellow-500 hover:bg-yellow-400 text-slate-900 active:scale-95'
          }`}
        >
          {collecting ? <span className="inline-block animate-spin">‚ü≥</span> : 'Collect'}
        </button>
      )}
    </div>
  );
};


===== src/components/chemcity/PlaceUnlockModal.tsx =====

import React, { useState } from 'react';
import { useChemCityStore } from '../../store/chemcityStore';

export const PlaceUnlockModal: React.FC = () => {
  const user = useChemCityStore((s) => s.user);
  const places = useChemCityStore((s) => s.places);
  const placeUnlockModalId = useChemCityStore((s) => s.placeUnlockModalId);
  const closePlaceUnlockModal = useChemCityStore((s) => s.closePlaceUnlockModal);
  const unlockPlace = useChemCityStore((s) => s.unlockPlace);

  const [unlocking, setUnlocking] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [success, setSuccess] = useState(false);

  const isOpen = !!placeUnlockModalId;
  const place = places.find((p) => p.id === placeUnlockModalId) ?? null;

  if (!isOpen || !place || !user) return null;

  const cost = place.unlockCost ?? 0;
  const coins = user.currencies.coins;
  const canAfford = coins >= cost;
  const isUnlocked = user.unlockedPlaces.includes(place.id);

  const handleUnlock = async () => {
    if (unlocking || !canAfford || isUnlocked) return;
    setUnlocking(true);
    setError(null);
    try {
      await unlockPlace(place.id);
      setSuccess(true);
      setTimeout(() => {
        closePlaceUnlockModal();
        setSuccess(false);
      }, 1200);
    } catch (err: any) {
      setError(err?.message ?? 'Unlock failed. Please try again.');
    } finally {
      setUnlocking(false);
    }
  };

  return (
    <>
      <div className="fixed inset-0 bg-black/70 z-[70]" onClick={closePlaceUnlockModal} />

      <div className="fixed inset-x-6 top-1/4 z-[80] bg-slate-900 border border-slate-700 rounded-2xl overflow-hidden shadow-2xl">
        <div className="p-5 flex flex-col items-center gap-2 border-b border-slate-700">
          <span className="text-5xl">{place.emoji}</span>
          <h3 className="text-white font-bold text-xl text-center">{place.displayName}</h3>
          <p className="text-slate-400 text-sm text-center leading-snug">{place.skill.description}</p>
        </div>

        <div className="p-5 flex flex-col gap-4">
          {isUnlocked ? (
            <div className="bg-green-900/30 border border-green-700 rounded-xl p-3 text-center">
              <p className="text-green-300 font-semibold">‚úì Already unlocked!</p>
            </div>
          ) : success ? (
            <div className="bg-green-900/30 border border-green-700 rounded-xl p-3 text-center">
              <p className="text-green-300 font-semibold">üéâ {place.displayName} unlocked!</p>
            </div>
          ) : (
            <>
              <div className="bg-slate-800 border border-slate-700 rounded-xl p-4">
                <div className="flex items-center justify-between mb-2">
                  <span className="text-slate-400 text-sm">Unlock Cost</span>
                  <span className="text-yellow-300 font-black text-xl tabular-nums">ü™ô {cost.toLocaleString()}</span>
                </div>
                <div className="flex items-center justify-between">
                  <span className="text-slate-400 text-sm">Your Balance</span>
                  <span className={`font-bold text-base tabular-nums ${canAfford ? 'text-white' : 'text-red-400'}`}>
                    ü™ô {coins.toLocaleString()}
                  </span>
                </div>
                {!canAfford && (
                  <p className="text-red-400 text-xs mt-2 text-center">Need {(cost - coins).toLocaleString()} more coins</p>
                )}
              </div>

              <div className="bg-indigo-900/30 border border-indigo-800 rounded-xl p-3">
                <p className="text-indigo-200 text-xs">
                  Unlocking <span className="font-bold">{place.displayName}</span> gives you access to{' '}
                  <span className="font-bold">{place.slots?.length ?? 0} card slots</span>.
                </p>
              </div>

              {error && <p className="text-red-400 text-xs text-center">{error}</p>}
            </>
          )}

          {!success && !isUnlocked && (
            <div className="flex gap-3">
              <button
                onClick={closePlaceUnlockModal}
                className="flex-1 py-2.5 rounded-xl bg-slate-700 hover:bg-slate-600 text-slate-200 font-semibold text-sm transition-colors"
              >
                Cancel
              </button>
              <button
                onClick={handleUnlock}
                disabled={!canAfford || unlocking}
                className={`flex-1 py-2.5 rounded-xl font-bold text-sm transition-all active:scale-95 ${
                  canAfford && !unlocking
                    ? 'bg-yellow-500 hover:bg-yellow-400 text-slate-900'
                    : 'bg-slate-600 text-slate-400 cursor-not-allowed'
                }`}
              >
                {unlocking ? 'Unlocking...' : `Unlock for ü™ô ${cost.toLocaleString()}`}
              </button>
            </div>
          )}

          {(success || isUnlocked) && (
            <button
              onClick={closePlaceUnlockModal}
              className="w-full py-2.5 rounded-xl bg-slate-700 hover:bg-slate-600 text-slate-200 font-semibold text-sm transition-colors"
            >
              Close
            </button>
          )}
        </div>
      </div>
    </>
  );
};


===== src/components/chemcity/PlaceView.tsx =====

// ==============================
// FILE: src/components/chemcity/PlaceView.tsx
// ==============================
import React, { useEffect, useMemo, useRef, useState } from 'react';
import { useChemCityStore } from '../../store/chemcityStore';
import { ChemCard } from './ChemCard';

const FIXED_SLOT_LAYOUTS: Record<
  string,
  {
    slotPositions?: Record<string, { leftPct: number; topPct: number }>;
    slotLabels?: Record<string, string>;
    slotSizesPx?: Record<string, number>;
  }
> = {
  school: {
    slotPositions: {
      school_desk_1: { leftPct: 44.8, topPct: 82.9 },
      school_desk_2: { leftPct: 39.7, topPct: 48.3 },
      school_desk_3: { leftPct: 24.1, topPct: 34.8 },
      school_desk_4: { leftPct: 92.4, topPct: 29.2 },
      school_desk_5: { leftPct: 39.5, topPct: 33.1 },
      school_locker_1: { leftPct: 66.3, topPct: 43.2 },
      school_locker_2: { leftPct: 88.5, topPct: 68.3 },
    },
    slotLabels: {
      school_desk_1: 'Student Desk 1',
      school_desk_2: 'Teacher Desk',
      school_desk_3: 'Blackboard',
      school_desk_4: 'Science Corner',
      school_desk_5: 'Poster',
      school_locker_1: 'Window-side Table',
      school_locker_2: 'Student Desk 2',
    },
    slotSizesPx: {
      school_desk_1: 64,
    },
  },
  gas_station: {
    slotPositions: {
      gas_pump_1: { leftPct: 24.1, topPct: 61.9 },
      gas_pump_2: { leftPct: 87.9, topPct: 79.1 },
      gas_pump_3: { leftPct: 63.7, topPct: 32.1 },
      gas_pump_4: { leftPct: 61.5, topPct: 57.8 },
      gas_shelf_1: { leftPct: 51.8, topPct: 61 },
      gas_shelf_2: { leftPct: 38.5, topPct: 48.4 },
      gas_shelf_3: { leftPct: 78.4, topPct: 37.2 },
      gas_shelf_4: { leftPct: 85.1, topPct: 17.1 },
    },
    slotLabels: {
      gas_pump_1: 'Car 1',
      gas_pump_2: 'Construction Site',
      gas_pump_3: 'Factory',
      gas_pump_4: 'Petrol Pump',
      gas_shelf_1: 'Car 2',
      gas_shelf_2: 'Motel',
      gas_shelf_3: 'Street Light',
      gas_shelf_4: 'Firework',
    },
  },
  lab: {
    slotPositions: {
      lab_bench_1: { leftPct: 50.7, topPct: 51.3 },
      lab_bench_2: { leftPct: 28.7, topPct: 36 },
      lab_bench_3: { leftPct: 46.4, topPct: 32.2 },
      lab_bench_4: { leftPct: 75.3, topPct: 78.9 },
      lab_bench_5: { leftPct: 81.4, topPct: 10.9 },
      lab_bench_6: { leftPct: 92.2, topPct: 21.3 },
      lab_premium_1: { leftPct: 60.4, topPct: 31.5 },
      lab_premium_2: { leftPct: 50.1, topPct: 84.1 },
      lab_premium_3: { leftPct: 80.5, topPct: 36.7 },
      lab_premium_4: { leftPct: 9.5, topPct: 46.9 },
    },
    slotLabels: {
      lab_bench_1: 'Bench',
      lab_bench_2: 'Fume Hood',
      lab_bench_3: 'Acid & Alkali Cabinet',
      lab_bench_4: 'Apparatus 1',
      lab_bench_5: 'Metal Shelf',
      lab_bench_6: 'Salt Shelf',
      lab_premium_1: 'Hazardous Chemical Shelf',
      lab_premium_2: 'Apparatus 2',
      lab_premium_3: 'Chemical Shelf',
      lab_premium_4: 'Gas Tank',
      lab_premium_5: 'Apparatus 3',
      lab_premium_6: 'Apparatus 4',
    },
  },
  kitchen: {
    slotPositions: {
      kitchen_counter_1: { leftPct: 60.5, topPct: 72.4 },
      kitchen_counter_2: { leftPct: 12.6, topPct: 40.2 },
      kitchen_counter_3: { leftPct: 67, topPct: 44.4 },
      kitchen_counter_4: { leftPct: 28.3, topPct: 88.8 },
      kitchen_shelf_1: { leftPct: 42.3, topPct: 41.2 },
      kitchen_shelf_2: { leftPct: 12.6, topPct: 17.4 },
      kitchen_shelf_3: { leftPct: 88.1, topPct: 87.8 },
      kitchen_shelf_4: { leftPct: 89.6, topPct: 41.2 },
    },
    slotLabels: {
      kitchen_counter_1: 'Cutlery Drawer',
      kitchen_counter_2: 'Pantry 1',
      kitchen_counter_3: 'Stove & Oven',
      kitchen_counter_4: 'Dinette',
      kitchen_shelf_1: 'Fridge',
      kitchen_shelf_2: 'Pantry 2',
      kitchen_shelf_3: 'Base Cabinet',
      kitchen_shelf_4: 'Countertop',
    },
  },
  toilet: {
    slotPositions: {
      toilet_tank_1: { leftPct: 24.1, topPct: 47.6 },
      toilet_tank_2: { leftPct: 40.8, topPct: 83.8 },
      toilet_tank_3: { leftPct: 80.3, topPct: 51.1 },
      toilet_tank_4: { leftPct: 21.3, topPct: 15.4 },
      toilet_cabinet_1: { leftPct: 58.1, topPct: 63.3 },
      toilet_cabinet_2: { leftPct: 37.4, topPct: 48.4 },
      toilet_cabinet_3: { leftPct: 45.5, topPct: 14.6 },
    },
    slotLabels: {
      toilet_tank_1: 'Faucet',
      toilet_tank_2: 'Vanity Cabinet',
      toilet_tank_3: 'Bathtub',
      toilet_tank_4: 'Mirror Cabinet 1',
      toilet_cabinet_1: 'Toilet',
      toilet_cabinet_2: 'Vanity Top',
      toilet_cabinet_3: 'Mirror Cabinet 2',
      toilet_cabinet_4: 'Mirror Cabinet 3',
    },
  },
  garden: {
    slotPositions: {
      garden_bed_1: { leftPct: 20.6, topPct: 47.6 },
      garden_bed_2: { leftPct: 65.2, topPct: 85.8 },
      garden_bed_3: { leftPct: 56.8, topPct: 40.7 },
      garden_bed_4: { leftPct: 76.7, topPct: 45.6 },
      garden_plot_1: { leftPct: 22.3, topPct: 79.1 },
      garden_plot_2: { leftPct: 48.6, topPct: 68.2 },
      garden_plot_3: { leftPct: 20.7, topPct: 18.6 },
    },
    slotLabels: {
      garden_bed_1: 'Shed 1',
      garden_bed_2: 'Lawn',
      garden_bed_3: 'Greenhouse',
      garden_bed_4: 'Flower Bed',
      garden_plot_1: 'Mole Hill',
      garden_plot_2: 'Broadcast Spreader',
      garden_plot_3: 'Shed 2',
      garden_plot_4: 'Garden Plot',
    },
  },
  lifestyle_boutique: {
    slotPositions: {
      boutique_shelf_1: { leftPct: 40.1, topPct: 82.6 },
      boutique_shelf_2: { leftPct: 29.1, topPct: 43.7 },
      boutique_shelf_3: { leftPct: 77.6, topPct: 54.8 },
      boutique_shelf_4: { leftPct: 85.7, topPct: 82.4 },
      boutique_display_1: { leftPct: 86.8, topPct: 27.8 },
      boutique_display_2: { leftPct: 52.8, topPct: 82.6 },
    },
    slotLabels: {
      boutique_shelf_1: 'Poseur Table 1',
      boutique_shelf_2: 'Service Desk',
      boutique_shelf_3: 'Jewellery Display',
      boutique_shelf_4: 'Power Essentials',
      boutique_display_1: 'Apparel Gallery',
      boutique_display_2: 'Poseur Table 2',
    },
  },
  beach: {
    slotPositions: {
      beach_sand_1: { leftPct: 60.1, topPct: 14.6 },
      beach_sand_2: { leftPct: 81.7, topPct: 37.2 },
      beach_sand_3: { leftPct: 13.2, topPct: 40.7 },
      beach_sand_4: { leftPct: 33.7, topPct: 76.6 },
      beach_pier_1: { leftPct: 72.3, topPct: 68.2 },
      beach_pier_2: { leftPct: 36.1, topPct: 44.6 },
      beach_pier_3: { leftPct: 27.7, topPct: 23.3 },
    },
    slotLabels: {
      beach_sand_1: 'Sky',
      beach_sand_2: 'Sea',
      beach_sand_3: 'Rock 1',
      beach_sand_4: 'Dry Sand',
      beach_pier_1: 'Strandline',
      beach_pier_2: 'Rock 2',
      beach_pier_3: 'Cliffside',
      beach_pier_4: 'Pier',
    },
  },
};

// ‚îÄ‚îÄ‚îÄ Compact equip strip slot item ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
interface StripSlotProps {
  slotId: string;
  label: string;
  isLocked: boolean;
  isUnlocking: boolean;
  canAfford: boolean;
  costLabel: string;
  slimItem: { id: string; name: string; emoji: string; imageUrl?: string } | undefined;
  onEquip: () => void;
  onUnlock: () => void;
  onDetail: (id: string) => void;
}

const StripSlot: React.FC<StripSlotProps> = ({
  slotId,
  label,
  isLocked,
  isUnlocking,
  canAfford,
  costLabel,
  slimItem,
  onEquip,
  onUnlock,
  onDetail,
}) => {
  if (isLocked) {
    return (
      <div className="flex flex-col items-center gap-1 shrink-0">
        <button
          onClick={canAfford ? onUnlock : undefined}
          disabled={!canAfford || isUnlocking}
          className={`
            w-14 h-14 rounded-xl border-2 border-dashed flex flex-col items-center justify-center gap-0.5
            transition-all active:scale-95
            ${canAfford && !isUnlocking
              ? 'bg-yellow-500/10 border-yellow-500/60 hover:bg-yellow-500/20 cursor-pointer'
              : 'bg-slate-900/60 border-slate-700 cursor-not-allowed opacity-60'
            }
          `}
          title={`Unlock for ${costLabel}`}
        >
          <span className="text-base leading-none">{isUnlocking ? '‚è≥' : 'üîí'}</span>
          <span className="text-[9px] text-slate-400 leading-none">{costLabel}</span>
        </button>
        <span className="text-[10px] text-slate-600 max-w-[3.5rem] truncate text-center leading-tight">
          {label}
        </span>
      </div>
    );
  }

  if (slimItem) {
    return (
      <div className="flex flex-col items-center gap-1 shrink-0">
        <button
          onClick={() => onDetail(slimItem.id)}
          className="
            w-14 h-14 rounded-xl border-2 border-indigo-500/70
            overflow-hidden bg-slate-800
            hover:border-indigo-400 transition-all active:scale-95
            relative
          "
          title={slimItem.name}
        >
          {slimItem.imageUrl ? (
            <img
              src={slimItem.imageUrl}
              alt={slimItem.name}
              className="w-full h-full object-cover"
              loading="lazy"
              onError={(ev) => {
                (ev.target as HTMLImageElement).style.display = 'none';
              }}
            />
          ) : (
            <span className="text-2xl flex items-center justify-center w-full h-full">
              {slimItem.emoji}
            </span>
          )}
          {/* Change indicator */}
          <span
            className="
              absolute bottom-0 right-0
              w-4 h-4 rounded-tl-md
              bg-slate-900/80 text-[8px]
              flex items-center justify-center text-indigo-300
            "
            onClick={(e) => { e.stopPropagation(); onEquip(); }}
          >
            ‚úé
          </span>
        </button>
        <span className="text-[10px] text-slate-400 max-w-[3.5rem] truncate text-center leading-tight">
          {label}
        </span>
      </div>
    );
  }

  // Empty slot
  return (
    <div className="flex flex-col items-center gap-1 shrink-0">
      <button
        onClick={onEquip}
        className="
          w-14 h-14 rounded-xl border-2 border-dashed border-slate-600
          bg-slate-800/60 hover:bg-slate-700/60 hover:border-indigo-500
          flex items-center justify-center
          text-slate-500 hover:text-indigo-400
          transition-all active:scale-95
        "
        title={`Equip card to ${label}`}
      >
        <span className="text-xl font-bold leading-none">+</span>
      </button>
      <span className="text-[10px] text-slate-500 max-w-[3.5rem] truncate text-center leading-tight">
        {label}
      </span>
    </div>
  );
};

// ‚îÄ‚îÄ‚îÄ Main PlaceView ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
export const PlaceView: React.FC = () => {
  const user = useChemCityStore((s) => s.user);
  const places = useChemCityStore((s) => s.places);
  const slimItems = useChemCityStore((s) => s.slimItems);
  const selectedPlaceId = useChemCityStore((s) => s.selectedPlaceId);
  const openCardPicker = useChemCityStore((s) => s.openCardPicker);
  const openCardDetail = useChemCityStore((s) => s.openCardDetail);
  const unlockSlot = useChemCityStore((s) => s.unlockSlot);
  const navigateToGasStationDistributor = useChemCityStore((s) => s.navigateToGasStationDistributor);

  const [unlockingSlotId, setUnlockingSlotId] = useState<string | null>(null);

  // Dev editor (disabled in production)
  const isDevEditorEnabled = false;
  const [editSlotsMode, setEditSlotsMode] = useState(false);
  const [selectedSlotIdForEdit, setSelectedSlotIdForEdit] = useState<string | null>(null);
  const [slotPositions, setSlotPositions] = useState<Record<string, { leftPct: number; topPct: number }>>({});
  const [slotLabels, setSlotLabels] = useState<Record<string, string>>({});
  const [slotSizesPx, setSlotSizesPx] = useState<Record<string, number>>({});

  const placeImageRef = useRef<HTMLImageElement | null>(null);
  const [placeImageNaturalWidth, setPlaceImageNaturalWidth] = useState<number>(0);
  const [placeImageRenderedWidth, setPlaceImageRenderedWidth] = useState<number>(0);

  const place = useMemo(
    () => places.find((p) => p.id === selectedPlaceId) ?? null,
    [places, selectedPlaceId],
  );

  if (!place || !user) return null;

  const fixedLayout = FIXED_SLOT_LAYOUTS[place.id] ?? null;

  const placeImageSrc = (() => {
    switch (place.id) {
      case 'toilet':           return '/Place1_Toilet.png';
      case 'kitchen':          return '/Place2_Kitchen.png';
      case 'beach':            return '/Place3_Beach.png';
      case 'gas_station':      return '/Place4_GasStation.png';
      case 'lab':              return '/Place5_Lab.png';
      case 'garden':           return '/Place6_Garden.png';
      case 'lifestyle_boutique': return '/Place7_Boutique.png';
      case 'school':           return '/Place8_School.png';
      default:                 return null;
    }
  })();

  // Track rendered image width for slot sizing
  useEffect(() => {
    const img = placeImageRef.current;
    if (!img) return;

    const updateRendered = () => {
      const rect = img.getBoundingClientRect();
      setPlaceImageRenderedWidth(rect.width);
    };

    updateRendered();

    let ro: ResizeObserver | null = null;
    if (typeof ResizeObserver !== 'undefined') {
      ro = new ResizeObserver(() => updateRendered());
      ro.observe(img);
    } else {
      window.addEventListener('resize', updateRendered);
    }

    return () => {
      if (ro) ro.disconnect();
      else window.removeEventListener('resize', updateRendered);
    };
  }, [placeImageSrc, selectedPlaceId]);

  const slotSizeScale =
    placeImageNaturalWidth > 0 && placeImageRenderedWidth > 0
      ? placeImageRenderedWidth / placeImageNaturalWidth
      : 1;
  const tunedSlotSizeScale = slotSizeScale * 1.35;

  const effectiveSlotPositions =
    (isDevEditorEnabled && editSlotsMode ? slotPositions : fixedLayout?.slotPositions) ?? slotPositions;
  const effectiveSlotLabels =
    (isDevEditorEnabled && editSlotsMode ? slotLabels : fixedLayout?.slotLabels) ?? slotLabels;
  const effectiveSlotSizesPx =
    (isDevEditorEnabled && editSlotsMode ? slotSizesPx : fixedLayout?.slotSizesPx) ?? slotSizesPx;

  const exportSlotCoords = async () => {
    const payload = {
      placeId: place.id,
      slots: place.slots.map((s) => ({
        slotId: s.slotId,
        label: slotLabels[s.slotId] || undefined,
        sizePx: slotSizesPx[s.slotId] || undefined,
        ...(slotPositions[s.slotId] ? slotPositions[s.slotId] : {}),
      })),
    };
    const text = JSON.stringify(payload, null, 2);
    console.log('[PlaceView] Slot coords export:\n' + text);
    try {
      if (typeof navigator !== 'undefined' && navigator.clipboard?.writeText) {
        await navigator.clipboard.writeText(text);
      }
    } catch { /* ignore */ }
  };

  const coins = user.currencies.coins;
  const diamonds = user.currencies.diamonds;
  const isPlaceUnlocked = place.unlockCost === 0 || user.unlockedPlaces.includes(place.id);

  const handleUnlockSlot = async (slotId: string) => {
    const slot = place.slots.find((s) => s.slotId === slotId);
    if (slot?.budgetOnly) {
      navigateToGasStationDistributor();
      return;
    }

    setUnlockingSlotId(slotId);
    try {
      await unlockSlot(place.id, slotId);
    } finally {
      setUnlockingSlotId(null);
    }
  };

  const skillValue = (() => {
    switch (place.id) {
      case 'garden':     return `${user.activeBonuses.passiveBaseCoinsPerHour.toLocaleString()} ü™ô/hr`;
      case 'lab':        return `${user.activeBonuses.passiveMultiplier.toFixed(1)}√ó multiplier`;
      case 'kitchen':    return `+${user.activeBonuses.quizFlatDiamondBonus} üíé max bonus`;
      case 'school':     return `${user.activeBonuses.quizDiamondMultiplier.toFixed(1)}√ó quiz diamonds`;
      case 'beach':      return `${user.activeBonuses.quizDoubleChancePercent}% double chance`;
      case 'toilet':     return `${user.activeBonuses.dailyLoginDiamonds} üíé daily`;
      case 'gas_station': return `${user.activeBonuses.extraSlotsTotal} bonus slots`;
      case 'lifestyle_boutique': return `${user.activeBonuses.shopDiscountPercent}% store discount`;
      default:           return '‚Äî';
    }
  })();

  const equippedCount = place.slots.filter((s) => !!user.equipped?.[s.slotId]).length;

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // LAYOUT
  //
  //  The outer wrapper fills the full viewport height.
  //  pt-[76px] pushes content below the fixed main site header.
  //  flex-col + overflow-hidden = no page scroll ever.
  //
  //   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚Üê 76px (main header, behind)
  //   ‚îÇ  IMAGE  (flex-1, maximised)       ‚îÇ
  //   ‚îÇ  ‚îå‚îÄ‚îÄ info overlay (bottom) ‚îÄ‚îÄ‚îê   ‚îÇ
  //   ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
  //   ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
  //   ‚îÇ  EQUIP STRIP (shrink-0, ~90px)    ‚îÇ
  //   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  return (
    <div
      className="flex flex-col overflow-hidden"
      style={{ height: '100vh', paddingTop: 76 }}
    >
      {/* ‚îÄ‚îÄ Image area (flex-1) ‚îÄ‚îÄ */}
      {placeImageSrc ? (
        <div className="flex-1 flex justify-center items-start overflow-hidden px-3 pt-2 pb-1 min-h-0">
          {/*
            Inner wrapper sizes to the image naturally.
            - h-full: fills flex-1 height
            - width: fit-content + max-w-full: stays inside horizontal bounds
            - Slots and overlay are positioned relative to this wrapper,
              which exactly matches the rendered image dimensions.
          */}
          <div
            className="relative h-full"
            style={{ width: 'fit-content', maxWidth: '100%' }}
            onClick={(e) => {
              if (!isDevEditorEnabled || !editSlotsMode || !selectedSlotIdForEdit) return;
              const target = e.currentTarget;
              const rect = target.getBoundingClientRect();
              const leftPct = Math.round(((e.clientX - rect.left) / rect.width) * 1000) / 10;
              const topPct = Math.round(((e.clientY - rect.top) / rect.height) * 1000) / 10;
              setSlotPositions((prev) => ({
                ...prev,
                [selectedSlotIdForEdit]: { leftPct, topPct },
              }));
              console.log(`[PlaceView] ${place.id} set ${selectedSlotIdForEdit}: leftPct=${leftPct}, topPct=${topPct}`);
            }}
          >
            <img
              src={placeImageSrc}
              alt={place.displayName}
              ref={placeImageRef}
              className="h-full w-auto max-w-full rounded-2xl border border-slate-700 bg-slate-950 block"
              loading="lazy"
              onLoad={(e) => {
                const el = e.currentTarget;
                if (el.naturalWidth) setPlaceImageNaturalWidth(el.naturalWidth);
                // Also update rendered width immediately after load
                const rect = el.getBoundingClientRect();
                setPlaceImageRenderedWidth(rect.width);
              }}
            />

            {/* ‚îÄ‚îÄ Slot overlay buttons ‚îÄ‚îÄ */}
            {place.slots.map((slot) => {
              const slotId = slot.slotId;
              const pos = effectiveSlotPositions[slotId];
              if (!pos) return null;

              const baseSizePx = effectiveSlotSizesPx[slotId] ?? 64;
              const sizePx = Math.max(38, Math.min(100, Math.round(baseSizePx * tunedSlotSizeScale)));

              const equippedItemId = user.equipped?.[slotId];
              const slimItem = equippedItemId ? slimItems.find((i) => i.id === equippedItemId) : undefined;

              const isFreeSlot = slot.unlockCost == null && !slot.budgetOnly;
              const isUnlockedSlot = isFreeSlot || user.unlockedSlots.includes(slotId);
              const isLocked = isPlaceUnlocked && !isUnlockedSlot;

              const label = effectiveSlotLabels[slotId]?.trim() ? effectiveSlotLabels[slotId] : slotId;

              return (
                <button
                  key={slotId}
                  type="button"
                  onClick={(e) => {
                    e.stopPropagation();
                    if (isDevEditorEnabled && editSlotsMode) {
                      setSelectedSlotIdForEdit(slotId);
                      return;
                    }
                    if (isLocked) return;
                    openCardPicker(slotId);
                  }}
                  title={label}
                  aria-label={label}
                  className={`
                    absolute -translate-x-1/2 -translate-y-1/2
                    rounded-full border-2 border-dashed
                    flex items-center justify-center
                    shadow-lg shadow-black/40
                    transition-all active:scale-95
                    ${isLocked
                      ? 'bg-slate-900/70 border-slate-700 text-slate-500 cursor-not-allowed'
                      : isDevEditorEnabled && editSlotsMode && selectedSlotIdForEdit === slotId
                        ? 'bg-indigo-600/60 border-indigo-300 text-white'
                        : 'bg-slate-900/60 border-slate-300/60 text-white hover:border-indigo-300 hover:bg-slate-800/70'
                    }
                  `}
                  style={{
                    left: `${pos.leftPct}%`,
                    top: `${pos.topPct}%`,
                    width: sizePx,
                    height: sizePx,
                  }}
                >
                  {isLocked ? (
                    <span className="text-xs font-bold">üîí</span>
                  ) : slimItem ? (
                    <div className="w-full h-full rounded-full overflow-hidden flex items-center justify-center">
                      {slimItem.imageUrl ? (
                        <img
                          src={slimItem.imageUrl}
                          alt={slimItem.name}
                          className="w-full h-full object-cover"
                          loading="lazy"
                          onError={(ev) => {
                            (ev.target as HTMLImageElement).style.display = 'none';
                          }}
                        />
                      ) : (
                        <span className="text-2xl">{slimItem.emoji}</span>
                      )}
                    </div>
                  ) : (
                    <span className="text-3xl font-bold leading-none">+</span>
                  )}
                </button>
              );
            })}

            {/* ‚îÄ‚îÄ Place info overlay (bottom of image) ‚îÄ‚îÄ */}
            <div className="
              absolute bottom-2 left-2 right-2
              flex items-center justify-between gap-2
              bg-slate-900/85 backdrop-blur-md
              rounded-xl px-3 py-2
              border border-slate-700/60
              pointer-events-none
            ">
              <div className="flex items-center gap-2 min-w-0">
                <span className="text-2xl leading-none">{place.emoji}</span>
                <div className="min-w-0">
                  <h2 className="text-white font-bold text-sm leading-tight truncate">
                    {place.displayName}
                  </h2>
                  <p className="text-slate-400 text-xs truncate leading-tight">
                    {place.skill.description}
                  </p>
                </div>
              </div>
              <div className="text-right shrink-0">
                <p className="text-indigo-300 font-bold text-sm leading-tight">{skillValue}</p>
                <p className="text-slate-500 text-xs leading-tight">
                  {equippedCount}/{place.slots.length} cards
                </p>
              </div>
            </div>

            {/* Locked place notice (overlay) */}
            {!isPlaceUnlocked && (
              <div className="
                absolute inset-0 flex items-center justify-center
                bg-slate-950/60 backdrop-blur-sm rounded-2xl
                pointer-events-none
              ">
                <div className="bg-slate-900/90 border border-slate-600 rounded-xl px-4 py-3 text-center">
                  <p className="text-slate-300 text-sm font-semibold">Place Locked</p>
                  <p className="text-slate-500 text-xs mt-1">Return to the map to unlock it.</p>
                </div>
              </div>
            )}
          </div>
        </div>
      ) : (
        // Fallback if no image
        <div className="flex-1 flex items-center justify-center text-slate-500 text-sm">
          No image available
        </div>
      )}

      {/* ‚îÄ‚îÄ Dev editor toolbar ‚îÄ‚îÄ */}
      {isDevEditorEnabled && (
        <div className="shrink-0 px-3 pb-1 flex items-center gap-2">
          <button
            type="button"
            onClick={() => {
              setEditSlotsMode((v) => !v);
              setSelectedSlotIdForEdit(null);
              if (!editSlotsMode) {
                setSlotPositions(fixedLayout?.slotPositions ?? {});
                setSlotLabels(fixedLayout?.slotLabels ?? {});
                setSlotSizesPx(fixedLayout?.slotSizesPx ?? {});
              }
            }}
            className={`text-xs font-bold rounded-lg px-3 py-1.5 border transition-colors ${
              editSlotsMode
                ? 'bg-indigo-600 hover:bg-indigo-500 border-indigo-300 text-white'
                : 'bg-slate-900 hover:bg-slate-800 border-slate-700 text-slate-200'
            }`}
          >
            {editSlotsMode ? 'Editing Slots' : 'Edit slots'}
          </button>
          {editSlotsMode && (
            <button
              type="button"
              onClick={exportSlotCoords}
              className="text-xs font-bold rounded-lg px-3 py-1.5 border bg-slate-900 hover:bg-slate-800 border-slate-700 text-slate-200 transition-colors"
            >
              Export coords
            </button>
          )}
          {editSlotsMode && (
            <div className="flex flex-wrap gap-1.5 ml-2">
              {place.slots.map((s) => (
                <button
                  key={s.slotId}
                  type="button"
                  onClick={() => setSelectedSlotIdForEdit(s.slotId)}
                  className={`text-[11px] font-bold rounded-lg px-2 py-1 border transition-colors ${
                    selectedSlotIdForEdit === s.slotId
                      ? 'bg-indigo-600 border-indigo-300 text-white'
                      : 'bg-slate-900 border-slate-700 text-slate-200 hover:bg-slate-800'
                  }`}
                >
                  {s.slotId}
                </button>
              ))}
            </div>
          )}
        </div>
      )}

      {/* ‚îÄ‚îÄ Compact equip strip ‚îÄ‚îÄ */}
      <div className="
        shrink-0
        flex gap-3 items-end
        px-3 pb-3 pt-1
        overflow-x-auto
        border-t border-slate-800/60
      ">
        {place.slots.map((slot) => {
          const slotId = slot.slotId;
          const equippedItemId = user.equipped?.[slotId];
          const slimItem = equippedItemId ? slimItems.find((i) => i.id === equippedItemId) : undefined;

          const isFreeSlot = slot.unlockCost == null && !slot.budgetOnly;
          const isUnlockedSlot = isFreeSlot || user.unlockedSlots.includes(slotId);
          const isLocked = isPlaceUnlocked && !isUnlockedSlot;

          const canAfford = slot.budgetOnly
            ? (user.extraSlotsBudget ?? 0) > 0
            : slot.unlockCurrency === 'diamonds'
              ? diamonds >= (slot.unlockCost ?? 0)
              : coins >= (slot.unlockCost ?? 0);

          const costLabel = slot.budgetOnly
            ? '1‚õΩ'
            : slot.unlockCurrency === 'diamonds'
              ? `${slot.unlockCost?.toLocaleString() ?? 0}üíé`
              : `${slot.unlockCost?.toLocaleString() ?? 0}ü™ô`;

          const label =
            (effectiveSlotLabels[slotId]?.trim() ? effectiveSlotLabels[slotId] : slotId);

          return (
            <StripSlot
              key={slotId}
              slotId={slotId}
              label={label}
              isLocked={isLocked}
              isUnlocking={unlockingSlotId === slotId}
              canAfford={canAfford}
              costLabel={costLabel}
              slimItem={slimItem}
              onEquip={() => openCardPicker(slotId)}
              onUnlock={() => handleUnlockSlot(slotId)}
              onDetail={(id) => openCardDetail(id)}
            />
          );
        })}
      </div>
    </div>
  );
};

===== src/components/chemcity/PurchaseConfirmModal.tsx =====

import React, { useEffect, useState } from 'react';
import { useChemCityStore } from '../../store/chemcityStore';
import { getEffectiveCoinPrice } from '../../lib/chemcity/shop';

const RARITY_BG: Record<string, string> = {
  common: 'from-slate-700 to-slate-600',
  rare: 'from-blue-800 to-indigo-700',
  epic: 'from-purple-800 to-pink-700',
  legendary: 'from-amber-700 to-yellow-500',
};

type PurchaseCurrency = 'coins' | 'diamonds';

export const PurchaseConfirmModal: React.FC = () => {
  const user = useChemCityStore((s) => s.user);
  const slimItems = useChemCityStore((s) => s.slimItems);
  const storePurchaseItemId = useChemCityStore((s) => s.storePurchaseItemId);
  const storePurchaseData = useChemCityStore((s) => s.storePurchaseData);
  const storePurchaseLoading = useChemCityStore((s) => s.storePurchaseLoading);
  const closePurchaseConfirm = useChemCityStore((s) => s.closePurchaseConfirm);
  const purchaseCard = useChemCityStore((s) => s.purchaseCard);

  const [purchasing, setPurchasing] = useState(false);
  const [purchaseCurrency, setPurchaseCurrency] = useState<PurchaseCurrency>('coins');
  const [purchaseError, setPurchaseError] = useState<string | null>(null);
  const [purchaseSuccess, setPurchaseSuccess] = useState(false);

  const isOpen = !!storePurchaseItemId;
  const slim = slimItems.find((i) => i.id === storePurchaseItemId);
  const full = storePurchaseData;

  const isOwned = !!user?.ownedItems?.includes(storePurchaseItemId ?? '');
  const rarity = slim?.rarity ?? 'common';
  const gradBg = RARITY_BG[rarity] ?? RARITY_BG.common;
  const discount = user?.activeBonuses.shopDiscountPercent ?? 0;
  const rawCoin = slim?.shopData?.coinCost;
  const rawDiamond = slim?.shopData?.diamondCost;
  const effCoin = rawCoin != null ? getEffectiveCoinPrice(rawCoin, user?.activeBonuses ?? null) : null;

  const coins = user?.currencies.coins ?? 0;
  const diamonds = user?.currencies.diamonds ?? 0;

  const canAffordCoins = effCoin != null && coins >= effCoin;
  const canAffordDiamonds = rawDiamond != null && diamonds >= rawDiamond;

  useEffect(() => {
    if (isOpen) {
      setPurchaseError(null);
      setPurchaseSuccess(false);
      setPurchasing(false);
      if (rawCoin != null) setPurchaseCurrency('coins');
      else if (rawDiamond != null) setPurchaseCurrency('diamonds');
    }
  }, [isOpen, storePurchaseItemId, rawCoin, rawDiamond]);

  if (!isOpen || !slim) return null;

  const handlePurchase = async () => {
    if (purchasing || isOwned) return;
    const canAfford = purchaseCurrency === 'coins' ? canAffordCoins : canAffordDiamonds;
    if (!canAfford) return;

    setPurchasing(true);
    setPurchaseError(null);
    try {
      await purchaseCard(slim.id, purchaseCurrency);
      setPurchaseSuccess(true);
      setTimeout(() => closePurchaseConfirm(), 1500);
    } catch (err: any) {
      setPurchaseError(err?.message ?? 'Purchase failed. Please try again.');
    } finally {
      setPurchasing(false);
    }
  };

  return (
    <>
      <div className="fixed inset-0 bg-black/75 z-[80]" onClick={closePurchaseConfirm} />

      <div className="fixed inset-x-3 top-10 bottom-4 z-[90] bg-slate-900 border border-slate-700 rounded-2xl overflow-hidden flex flex-col shadow-2xl">
        <button
          onClick={closePurchaseConfirm}
          className="absolute top-3 right-3 z-10 w-8 h-8 flex items-center justify-center rounded-full bg-slate-800/80 text-slate-300 hover:text-white text-lg"
          aria-label="Close"
        >
          √ó
        </button>

        <div className="overflow-y-auto flex-1">
          <div className={`w-full bg-gradient-to-b ${gradBg} p-6 flex flex-col items-center gap-3`}>
            {full?.imageUrl ? (
              <img
                src={full.imageUrl}
                alt={full.name}
                className="w-28 h-28 object-contain rounded-xl shadow-lg"
                onError={(e) => {
                  (e.target as HTMLImageElement).style.display = 'none';
                }}
              />
            ) : (
              <span className="text-6xl">{slim.emoji}</span>
            )}
            <div className="text-center">
              <h2 className="text-white font-bold text-xl leading-tight">{full?.displayName || slim.name}</h2>
              <p className="text-white/70 font-mono text-lg mt-0.5">{slim.chemicalFormula}</p>
              <div className="flex items-center justify-center gap-2 mt-2">
                <span className="bg-white/20 text-white text-xs font-semibold rounded-full px-3 py-0.5 capitalize">{rarity}</span>
                {isOwned && (
                  <span className="bg-green-500 text-white text-xs font-bold rounded-full px-3 py-0.5">‚úì Owned</span>
                )}
              </div>
            </div>
          </div>

          {storePurchaseLoading && (
            <div className="animate-pulse px-4 py-3 flex flex-col gap-2">
              <div className="h-4 bg-slate-700 rounded w-3/4" />
              <div className="h-4 bg-slate-700 rounded w-full" />
              <div className="h-4 bg-slate-700 rounded w-5/6" />
            </div>
          )}

          <div className="p-4 flex flex-col gap-4">
            {full?.description && <p className="text-slate-300 text-sm leading-relaxed">{full.description}</p>}

            {full?.educational?.funFact && (
              <div className="bg-indigo-900/40 border border-indigo-700 rounded-xl p-3">
                <p className="text-indigo-300 text-xs font-semibold mb-1">üî¨ Fun Fact</p>
                <p className="text-slate-200 text-sm leading-relaxed">{full.educational.funFact}</p>
              </div>
            )}

            {full?.educational?.everydayUses && full.educational.everydayUses.length > 0 && (
              <div>
                <p className="text-slate-400 text-xs font-semibold mb-2">üè† Everyday Uses</p>
                <div className="flex flex-wrap gap-2">
                  {full.educational.everydayUses.map((use) => (
                    <span key={use} className="bg-slate-700 text-slate-200 text-xs rounded-full px-3 py-1">
                      {use}
                    </span>
                  ))}
                </div>
              </div>
            )}

            {full?.topicConnections && full.topicConnections.length > 0 && (
              <div>
                <p className="text-slate-400 text-xs font-semibold mb-2">üìö DSE Topics</p>
                <div className="flex flex-wrap gap-2">
                  {full.topicConnections.map((tid) => (
                    <span
                      key={tid}
                      className="bg-emerald-900/50 text-emerald-300 text-xs rounded-full px-3 py-1 border border-emerald-800"
                    >
                      {tid}
                    </span>
                  ))}
                </div>
              </div>
            )}

            {full?.albumMetadata?.flavorText && (
              <div className="border-t border-slate-700 pt-3">
                <p className="text-slate-500 text-xs italic leading-relaxed">"{full.albumMetadata.flavorText}"</p>
              </div>
            )}

            {slim.skillContribution > 0 && (
              <div className="bg-slate-800 rounded-xl p-3 flex items-center justify-between">
                <span className="text-slate-400 text-sm">Skill Contribution</span>
                <span className="text-white font-bold">+{slim.skillContribution}</span>
              </div>
            )}
          </div>
        </div>

        <div className="shrink-0 border-t border-slate-700 p-4 bg-slate-900">
          {purchaseSuccess ? (
            <div className="flex items-center justify-center gap-2 bg-green-600 rounded-xl py-3">
              <span className="text-white font-bold">üéâ Added to your collection!</span>
            </div>
          ) : isOwned ? (
            <div className="flex items-center justify-center gap-2 bg-slate-700 rounded-xl py-3">
              <span className="text-slate-300 font-semibold">‚úì Already in your collection</span>
            </div>
          ) : (
            <>
              {effCoin != null && rawDiamond != null && (
                <div className="flex gap-2 mb-3">
                  <button
                    onClick={() => setPurchaseCurrency('coins')}
                    className={`flex-1 py-2 rounded-lg text-sm font-bold border transition-colors ${
                      purchaseCurrency === 'coins'
                        ? 'bg-yellow-500/20 border-yellow-500 text-yellow-300'
                        : 'bg-slate-800 border-slate-600 text-slate-400'
                    }`}
                  >
                    ü™ô Coins
                  </button>
                  <button
                    onClick={() => setPurchaseCurrency('diamonds')}
                    className={`flex-1 py-2 rounded-lg text-sm font-bold border transition-colors ${
                      purchaseCurrency === 'diamonds'
                        ? 'bg-cyan-500/20 border-cyan-500 text-cyan-300'
                        : 'bg-slate-800 border-slate-600 text-slate-400'
                    }`}
                  >
                    üíé Diamonds
                  </button>
                </div>
              )}

              <div className="flex items-center justify-between mb-3 px-1">
                <div>
                  {purchaseCurrency === 'coins' && effCoin != null && (
                    <div className="flex items-center gap-2">
                      <span className="text-yellow-300 font-black text-xl tabular-nums">ü™ô {effCoin.toLocaleString()}</span>
                      {rawCoin != null && rawCoin !== effCoin && (
                        <span className="text-slate-500 text-sm line-through tabular-nums">{rawCoin.toLocaleString()}</span>
                      )}
                      {discount > 0 && (
                        <span className="bg-emerald-600 text-white text-xs font-bold rounded-full px-2 py-0.5">
                          {discount}% OFF
                        </span>
                      )}
                    </div>
                  )}
                  {purchaseCurrency === 'diamonds' && rawDiamond != null && (
                    <span className="text-cyan-300 font-black text-xl tabular-nums">üíé {rawDiamond.toLocaleString()}</span>
                  )}
                </div>
                <div className="text-right text-xs text-slate-400">
                  {purchaseCurrency === 'coins' ? `You have: ü™ô ${coins.toLocaleString()}` : `You have: üíé ${diamonds.toLocaleString()}`}
                </div>
              </div>

              {purchaseError && <p className="text-red-400 text-xs mb-2 text-center">{purchaseError}</p>}

              {purchaseCurrency === 'coins' && effCoin != null && !canAffordCoins && (
                <p className="text-yellow-500 text-xs mb-2 text-center">Not enough coins ‚Äî need {(effCoin - coins).toLocaleString()} more</p>
              )}
              {purchaseCurrency === 'diamonds' && rawDiamond != null && !canAffordDiamonds && (
                <p className="text-cyan-500 text-xs mb-2 text-center">
                  Not enough diamonds ‚Äî need {(rawDiamond - diamonds).toLocaleString()} more
                </p>
              )}

              <button
                onClick={handlePurchase}
                disabled={
                  purchasing ||
                  (purchaseCurrency === 'coins' && (!canAffordCoins || effCoin == null)) ||
                  (purchaseCurrency === 'diamonds' && (!canAffordDiamonds || rawDiamond == null))
                }
                className={`w-full py-3 rounded-xl font-bold text-base transition-all active:scale-95 ${
                  purchasing
                    ? 'bg-slate-600 text-slate-400 cursor-not-allowed'
                    : purchaseCurrency === 'coins' && canAffordCoins
                      ? 'bg-yellow-500 hover:bg-yellow-400 text-slate-900'
                      : purchaseCurrency === 'diamonds' && canAffordDiamonds
                        ? 'bg-cyan-500 hover:bg-cyan-400 text-slate-900'
                        : 'bg-slate-700 text-slate-500 cursor-not-allowed'
                }`}
              >
                {purchasing
                  ? 'Purchasing...'
                  : purchaseCurrency === 'coins' && effCoin != null
                    ? `Buy for ü™ô ${effCoin.toLocaleString()}`
                    : rawDiamond != null
                      ? `Buy for üíé ${rawDiamond.toLocaleString()}`
                      : 'Not for sale'}
              </button>
            </>
          )}
        </div>
      </div>
    </>
  );
};


===== src/components/chemcity/QuizRewardModal.tsx =====

import React, { useEffect, useMemo, useState } from 'react';
import { useChemCityStore } from '../../store/chemcityStore';

function clamp(n: number, min: number, max: number) {
  return Math.max(min, Math.min(max, n));
}

function animateNumber(from: number, to: number, durationMs: number, onTick: (v: number) => void) {
  const start = performance.now();
  const delta = to - from;

  function step(now: number) {
    const t = clamp((now - start) / durationMs, 0, 1);
    const eased = 1 - Math.pow(1 - t, 3);
    onTick(Math.floor(from + delta * eased));
    if (t < 1) requestAnimationFrame(step);
  }

  requestAnimationFrame(step);
}

export const QuizRewardModal: React.FC = () => {
  const quizReward = useChemCityStore((s) => s.quizReward);
  const clearQuizReward = useChemCityStore((s) => s.clearQuizReward);

  const isOpen = !!quizReward?.result;
  const result = quizReward.result;

  const [coinsDisplay, setCoinsDisplay] = useState(0);
  const [diamondsDisplay, setDiamondsDisplay] = useState(0);

  const coinsFinal = result?.coinsAwarded ?? 0;
  const diamondsFinal = result?.diamondsAwarded ?? 0;

  useEffect(() => {
    if (!isOpen) return;
    setCoinsDisplay(0);
    setDiamondsDisplay(0);

    animateNumber(0, coinsFinal, 700, setCoinsDisplay);
    animateNumber(0, diamondsFinal, 900, setDiamondsDisplay);
  }, [coinsFinal, diamondsFinal, isOpen]);

  const breakdown = useMemo(() => {
    const b = (result as any)?.breakdown;
    if (!b || typeof b !== 'object') return null;
    return {
      flatBonus: Number(b.flatBonus ?? 0),
      afterSchool: Number(b.afterSchool ?? 0),
      afterBeach: Number(b.afterBeach ?? 0),
      didDouble: Boolean((result as any)?.didDouble),
    };
  }, [result]);

  if (!isOpen || !result) return null;

  return (
    <>
      <div className="fixed inset-0 bg-black/70 z-[60]" onClick={clearQuizReward} />
      <div className="fixed inset-x-4 top-24 z-[70] bg-slate-900 border border-slate-700 rounded-2xl overflow-hidden shadow-2xl">
        <div className="p-4 border-b border-slate-700 flex items-center justify-between">
          <div>
            <h3 className="text-white font-bold text-base">Quiz Rewards</h3>
            <p className="text-slate-400 text-xs">No cards drop from quizzes</p>
          </div>
          <button
            onClick={clearQuizReward}
            className="w-8 h-8 flex items-center justify-center rounded-lg bg-slate-800 text-slate-400 hover:text-white text-lg"
            aria-label="Close"
          >
            √ó
          </button>
        </div>

        <div className="p-4 flex flex-col gap-4">
          <div className="grid grid-cols-2 gap-3">
            <div className="bg-slate-800 border border-slate-700 rounded-xl p-3">
              <p className="text-slate-400 text-xs">Coins</p>
              <p className="text-yellow-300 font-black text-2xl tabular-nums">{coinsDisplay.toLocaleString()} ü™ô</p>
            </div>
            <div className="bg-slate-800 border border-slate-700 rounded-xl p-3">
              <p className="text-slate-400 text-xs">Diamonds</p>
              <p className="text-cyan-300 font-black text-2xl tabular-nums">{diamondsDisplay.toLocaleString()} üíé</p>
            </div>
          </div>

          {breakdown && (
            <div className="bg-slate-800/50 border border-slate-700 rounded-xl p-3">
              <p className="text-slate-300 text-xs font-semibold mb-2">Diamond breakdown</p>
              <div className="grid grid-cols-2 gap-2 text-xs">
                <div className="text-slate-400">Kitchen flat bonus</div>
                <div className="text-right text-slate-200 tabular-nums">+{breakdown.flatBonus}</div>
                <div className="text-slate-400">After School multiplier</div>
                <div className="text-right text-slate-200 tabular-nums">{breakdown.afterSchool}</div>
                <div className="text-slate-400">After Beach</div>
                <div className="text-right text-slate-200 tabular-nums">{breakdown.afterBeach}</div>
              </div>
              {breakdown.didDouble && (
                <div className="mt-2 text-emerald-300 text-xs font-semibold">Beach doubled your diamonds!</div>
              )}
            </div>
          )}

          <div className="flex justify-end">
            <button
              onClick={clearQuizReward}
              className="bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg px-4 py-2 text-sm font-bold"
            >
              Continue
            </button>
          </div>
        </div>
      </div>
    </>
  );
};


===== src/lib/chemcity/bonuses.ts =====

// ============================================================
// ChemCity ‚Äî Bonus Engine
// Computes all 8 place skill bonuses from equipped cards.
// Called after every equip/unequip ‚Äî result persisted to user doc.
//
// FORMULAS (locked ‚Äî do not change):
//   Garden:       coins_per_hour = total_bonus √ó 10
//   Lab:          multiplier = 1 + (total_bonus √ó 0.1)
//   Kitchen:      bonus_diamonds = total_bonus √ó random(1,3)  [max stored]
//   School:       multiplier = 1 + (total_bonus √ó 0.1)
//   Beach:        chance% = min(total_bonus √ó 5, 100)
//   Toilet:       diamonds = 5 + (total_bonus √ó 2)
//   Gas Station:  extra_slots_count = total_bonus
//   Boutique:     discount% = min(total_bonus √ó 2, 50)  [capped at 50%]
// ============================================================

import type { ActiveBonuses, SlimItemDocument } from './types';

// ‚îÄ‚îÄ‚îÄ Place Skill Totals ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

/**
 * Given the equipped map { slotId ‚Üí itemId } and the full slim item
 * catalog, sum up skillContribution per place.
 */
function sumBonusByPlace(
  equipped: Record<string, string>,
  slimItems: SlimItemDocument[],
): Record<string, number> {
  const itemMap = new Map(slimItems.map((i) => [i.id, i]));
  const totals: Record<string, number> = {};

  for (const itemId of Object.values(equipped)) {
    const item = itemMap.get(itemId);
    if (!item || item.deprecated) continue;
    const place = item.placeId;
    totals[place] = (totals[place] ?? 0) + item.skillContribution;
  }

  return totals;
}

// ‚îÄ‚îÄ‚îÄ Individual Skill Formulas ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

/** Garden ‚Äî base passive coin income per hour */
export function calcGardenCoinsPerHour(totalBonus: number): number {
  return totalBonus * 10;
}

/** Lab ‚Äî passive income multiplier applied to Garden base */
export function calcLabMultiplier(totalBonus: number): number {
  return 1 + totalBonus * 0.1;
}

/** Kitchen ‚Äî flat diamond bonus per quiz (returns the MAX of the range) */
export function calcKitchenMaxDiamonds(totalBonus: number): number {
  return totalBonus * 3; // range is (1√óbonus) to (3√óbonus); store max
}

/** Kitchen ‚Äî roll the actual bonus at quiz time */
export function rollKitchenBonus(totalBonus: number): number {
  if (totalBonus === 0) return 0;
  const min = totalBonus * 1;
  const max = totalBonus * 3;
  return Math.floor(Math.random() * (max - min + 1)) + min;
}

/** School ‚Äî quiz diamond multiplier */
export function calcSchoolMultiplier(totalBonus: number): number {
  return 1 + totalBonus * 0.1;
}

/** Beach ‚Äî chance % to double quiz diamonds (capped at 100%) */
export function calcBeachDoubleChance(totalBonus: number): number {
  return Math.min(totalBonus * 5, 100);
}

/** Beach ‚Äî roll whether diamonds are doubled at quiz time */
export function rollBeachDouble(totalBonus: number): boolean {
  return Math.random() * 100 < calcBeachDoubleChance(totalBonus);
}

/** Toilet ‚Äî diamonds awarded on daily login */
export function calcToiletLoginDiamonds(totalBonus: number): number {
  return 5 + totalBonus * 2;
}

/** Gas Station ‚Äî number of extra slots available to distribute */
export function calcGasStationExtraSlots(totalBonus: number): number {
  return totalBonus;
}

/** Boutique ‚Äî shop discount % (capped at 50%) */
export function calcBoutiqueDiscount(totalBonus: number): number {
  return Math.min(totalBonus * 2, 50);
}

// ‚îÄ‚îÄ‚îÄ Quiz Diamond Chain ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

/**
 * Full quiz diamond chain:
 *   base ‚Üí + Kitchen flat ‚Üí √ó School multiplier ‚Üí Beach double chance
 *
 * Called by the quizReward Cloud Function ‚Äî NOT the client.
 * Exposed here for unit tests and the Cloud Function to import.
 */
export function computeQuizDiamonds(
  baseDiamonds: number,
  bonuses: ActiveBonuses,
): number {
  let total = baseDiamonds;

  // Step 1: Kitchen flat bonus (randomised per quiz)
  const kitchenBonus = bonuses.quizFlatDiamondBonus > 0
    ? rollKitchenBonus(/* totalBonus */ bonuses.quizFlatDiamondBonus / 3)
    : 0;
  total += kitchenBonus;

  // Step 2: School multiplier
  total = Math.floor(total * bonuses.quizDiamondMultiplier);

  // Step 3: Beach double chance
  if (rollBeachDouble(bonuses.quizDoubleChancePercent / 5)) {
    total *= 2;
  }

  return Math.max(0, total);
}

// ‚îÄ‚îÄ‚îÄ Main Bonus Recompute ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

/**
 * Recomputes all 8 active bonuses from the current equipped state.
 *
 * Call after every equip/unequip, then persist result to:
 *   users/{userId}.activeBonuses
 *
 * This is a PURE function ‚Äî no Firestore reads. Fast and testable.
 */
export function computeActiveBonuses(
  equipped: Record<string, string>,
  slimItems: SlimItemDocument[],
): ActiveBonuses {
  const totals = sumBonusByPlace(equipped, slimItems);

  const gardenBonus = totals['garden'] ?? 0;
  const labBonus = totals['lab'] ?? 0;
  const kitchenBonus = totals['kitchen'] ?? 0;
  const schoolBonus = totals['school'] ?? 0;
  const beachBonus = totals['beach'] ?? 0;
  const toiletBonus = totals['toilet'] ?? 0;
  const gasStationBonus = totals['gas_station'] ?? 0;
  const boutiqueBonus = totals['lifestyle_boutique'] ?? 0;

  const gardenBase = calcGardenCoinsPerHour(gardenBonus);
  const labMult = calcLabMultiplier(labBonus);

  return {
    passiveBaseCoinsPerHour: Math.round(gardenBase * labMult),
    passiveMultiplier: labMult,
    quizFlatDiamondBonus: calcKitchenMaxDiamonds(kitchenBonus),
    quizDiamondMultiplier: calcSchoolMultiplier(schoolBonus),
    quizDoubleChancePercent: calcBeachDoubleChance(beachBonus),
    dailyLoginDiamonds: calcToiletLoginDiamonds(toiletBonus),
    extraSlotsTotal: calcGasStationExtraSlots(gasStationBonus),
    shopDiscountPercent: calcBoutiqueDiscount(boutiqueBonus),
  };
}

// ‚îÄ‚îÄ‚îÄ Shop Price Helper ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

/**
 * Returns the discounted price of an item given active bonuses.
 * Always used before displaying prices in ChemStore.
 */
export function getShopPrice(
  baseCost: number,
  currency: 'coins' | 'diamonds',
  bonuses: ActiveBonuses,
): number {
  if (currency === 'diamonds') return baseCost; // diamonds never discounted
  const discount = bonuses.shopDiscountPercent / 100;
  return Math.max(1, Math.floor(baseCost * (1 - discount)));
}


===== src/lib/chemcity/cloudFunctions.ts =====

import { getFunctions, httpsCallable } from 'firebase/functions';
import type {
  EquipCardRequest,
  UnequipCardRequest,
  PurchaseCardRequest,
  UnlockPlaceRequest,
  UnlockSlotRequest,
  QuizRewardRequest,
  QuizRewardResult,
} from './types';

function getFns() {
  return getFunctions(undefined, 'asia-east1');
}

export async function callChemCityInitUser(): Promise<void> {
  const fn = httpsCallable(getFns(), 'chemcityInitUser');
  await fn({});
}

export async function callChemCityEquipCard(slotId: string, itemId: string): Promise<void> {
  const fn = httpsCallable<EquipCardRequest, { ok?: boolean }>(getFns(), 'chemcityEquipCard');
  await fn({ slotId, itemId });
}

export async function callChemCityUnequipCard(slotId: string): Promise<void> {
  const fn = httpsCallable<UnequipCardRequest, { ok?: boolean }>(getFns(), 'chemcityUnequipCard');
  await fn({ slotId });
}

export async function callChemCityCollectPassiveIncome(): Promise<{ coinsAwarded: number } & Record<string, unknown>> {
  const fn = httpsCallable<{}, { coinsAwarded: number } & Record<string, unknown>>(
    getFns(),
    'chemcityCollectPassiveIncome',
  );
  const result = await fn({});
  return result.data;
}

export async function callChemCityGetDailyLoginBonus(): Promise<Record<string, unknown>> {
  const fn = httpsCallable(getFns(), 'chemcityGetDailyLoginBonus');
  const result = await fn({});
  return result.data as Record<string, unknown>;
}

export async function callChemCityPurchaseCard(itemId: string, currency: 'coins' | 'diamonds'): Promise<void> {
  const fn = httpsCallable<PurchaseCardRequest, { ok?: boolean }>(getFns(), 'chemcityPurchaseCard');
  await fn({ itemId, currency });
}

export async function callChemCityUnlockStoreSlot(): Promise<Record<string, unknown>> {
  const fn = httpsCallable(getFns(), 'chemcityUnlockStoreSlot');
  const result = await fn({});
  return result.data as Record<string, unknown>;
}

export async function callChemCityUnlockPlace(placeId: string): Promise<void> {
  const fn = httpsCallable<UnlockPlaceRequest, { ok?: boolean }>(getFns(), 'chemcityUnlockPlace');
  await fn({ placeId });
}

export async function callChemCityUnlockSlot(
  placeId: string,
  slotId: string,
  useExtraSlotBudget?: boolean,
): Promise<void> {
  const fn = httpsCallable<UnlockSlotRequest, { ok?: boolean }>(getFns(), 'chemcityUnlockSlot');
  await fn({ placeId, slotId, useExtraSlotBudget });
}

export async function callChemCityQuizReward(req: QuizRewardRequest): Promise<QuizRewardResult> {
  const fn = httpsCallable<QuizRewardRequest, QuizRewardResult>(getFns(), 'chemcityQuizReward');
  const result = await fn(req);
  return result.data;
}

// ‚îÄ‚îÄ‚îÄ Phase 4 aliases (used by the Phase 4 handoff code) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

export const callPurchaseCard = (req: PurchaseCardRequest) =>
  callChemCityPurchaseCard(req.itemId, req.currency).then(() => ({ success: true }));

export const callUnlockPlace = (req: UnlockPlaceRequest) =>
  callChemCityUnlockPlace(req.placeId).then(() => ({ success: true, coinsDeducted: 0 }));

export const callUnlockSlot = (req: UnlockSlotRequest) =>
  httpsCallable<UnlockSlotRequest, { ok?: boolean }>(getFns(), 'chemcityUnlockSlot')(req).then((r) => ({
    success: true,
    ...((r.data as any) ?? {}),
  }));

export const callUnlockStoreSlot = (_req: Record<string, never>) =>
  callChemCityUnlockStoreSlot().then((data: any) => ({
    success: true,
    newSlotCount: data?.newSlotCount ?? data?.storeSlotCount ?? 0,
    coinsDeducted: data?.coinsDeducted ?? data?.cost ?? 0,
  }));


===== src/lib/chemcity/dailyStore.ts =====

// ============================================================
// dailyStore.ts ‚Äî Daily rotating ChemStore logic
// ============================================================

import type { SlimItemDocument } from './types';

export const STORE_SLOT_UNLOCK_COSTS: Record<number, number> = {
  4: 1_000,
  5: 2_500,
  6: 5_000,
};
export const STORE_MIN_SLOTS = 3;
export const STORE_MAX_SLOTS = 6;

const RARITY_WEIGHT: Record<string, number> = {
  common: 60,
  rare: 25,
  epic: 12,
  legendary: 3,
};

function rarityWeight(item: SlimItemDocument): number {
  return RARITY_WEIGHT[item.rarity] ?? 60;
}

function makePrng(seed: number): () => number {
  let s = seed >>> 0;
  return () => {
    s += 0x6d2b79f5;
    let t = Math.imul(s ^ (s >>> 15), 1 | s);
    t = (t + Math.imul(t ^ (t >>> 7), 61 | t)) >>> 0;
    return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
  };
}

function hashString(str: string): number {
  let h = 5381;
  for (let i = 0; i < str.length; i++) {
    h = (Math.imul(h, 33) ^ str.charCodeAt(i)) >>> 0;
  }
  return h;
}

export function utcDateString(date: Date = new Date()): string {
  const y = date.getUTCFullYear();
  const m = String(date.getUTCMonth() + 1).padStart(2, '0');
  const d = String(date.getUTCDate()).padStart(2, '0');
  return `${y}-${m}-${d}`;
}

export function msUntilUtcMidnight(now: Date = new Date()): number {
  const tomorrow = new Date(now);
  tomorrow.setUTCHours(24, 0, 0, 0);
  return tomorrow.getTime() - now.getTime();
}

export function countdownToMidnight(now: Date = new Date()): string {
  const ms = msUntilUtcMidnight(now);
  const h = Math.floor(ms / 3_600_000);
  const m = Math.floor((ms % 3_600_000) / 60_000);
  if (h > 0) return `${h}h ${m}m`;
  const s = Math.floor((ms % 60_000) / 1_000);
  return `${m}m ${s}s`;
}

export function getDailyStoreItems(
  userId: string,
  slimItems: SlimItemDocument[],
  slotCount: number,
  dateOverride?: Date,
): SlimItemDocument[] {
  const n = Math.max(STORE_MIN_SLOTS, Math.min(STORE_MAX_SLOTS, slotCount));

  const pool = slimItems.filter(
    (item) =>
      !item.deprecated &&
      (item.shopData?.coinCost != null || item.shopData?.diamondCost != null),
  );

  if (pool.length === 0) return [];
  if (pool.length <= n) return [...pool];

  const seed = hashString(userId + utcDateString(dateOverride));
  const rand = makePrng(seed);

  const selected: SlimItemDocument[] = [];
  const remaining = [...pool];

  for (let i = 0; i < n && remaining.length > 0; i++) {
    const weights = remaining.map(rarityWeight);
    const total = weights.reduce((a, b) => a + b, 0);
    let pick = rand() * total;

    let chosenIdx = remaining.length - 1;
    for (let j = 0; j < weights.length; j++) {
      pick -= weights[j];
      if (pick <= 0) {
        chosenIdx = j;
        break;
      }
    }

    selected.push(remaining[chosenIdx]);
    remaining.splice(chosenIdx, 1);
  }

  return selected;
}


===== src/lib/chemcity/income.ts =====

import type { ActiveBonuses } from "./types";
import { Timestamp } from "firebase/firestore";

export const MAX_OFFLINE_HOURS = 24;

export function estimateUnclaimedCoins(
  activeBonuses: ActiveBonuses,
  lastCollected: Timestamp | null
): number {
  if (!lastCollected || activeBonuses.passiveBaseCoinsPerHour === 0) return 0;

  const nowMs = Date.now();
  const lastMs = lastCollected.toMillis();
  const elapsedHours = Math.min(
    (nowMs - lastMs) / (1000 * 60 * 60),
    MAX_OFFLINE_HOURS
  );

  return Math.floor(activeBonuses.passiveBaseCoinsPerHour * elapsedHours);
}

export function formatCoinsPerHour(coinsPerHour: number): string {
  if (coinsPerHour === 0) return "0 ü™ô/hr";
  if (coinsPerHour >= 1000) return `${(coinsPerHour / 1000).toFixed(1)}k ü™ô/hr`;
  return `${Math.round(coinsPerHour)} ü™ô/hr`;
}


===== src/lib/chemcity/shop.ts =====

import type { ActiveBonuses } from './types';

export function getEffectiveCoinPrice(
  rawCoinPrice: number,
  bonuses: ActiveBonuses | null | undefined,
): number {
  const discount = bonuses?.shopDiscountPercent ?? 0;
  if (discount <= 0) return rawCoinPrice;
  const discounted = rawCoinPrice * (1 - discount / 100);
  return Math.max(1, Math.floor(discounted));
}

export function getDisplayPrice(
  rawCoinPrice: number | undefined,
  rawDiamondPrice: number | undefined,
  currency: 'coins' | 'diamonds',
  bonuses: ActiveBonuses | null | undefined,
): number | null {
  if (currency === 'coins') {
    if (rawCoinPrice == null) return null;
    return getEffectiveCoinPrice(rawCoinPrice, bonuses);
  }
  return rawDiamondPrice ?? null;
}

export function canAffordItem(
  rawCoinPrice: number | undefined,
  rawDiamondPrice: number | undefined,
  currency: 'coins' | 'diamonds',
  userCoins: number,
  userDiamonds: number,
  bonuses: ActiveBonuses | null | undefined,
): boolean {
  if (currency === 'coins') {
    if (rawCoinPrice == null) return false;
    return userCoins >= getEffectiveCoinPrice(rawCoinPrice, bonuses);
  }
  if (rawDiamondPrice == null) return false;
  return userDiamonds >= rawDiamondPrice;
}


===== src/lib/chemcity/types.ts =====

// ============================================================
// ChemCity ‚Äî TypeScript Types
// Single source of truth for all data shapes.
// DO NOT change field names once users have data in Firestore.
// ============================================================

// ‚îÄ‚îÄ‚îÄ Item Documents ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

/**
 * Slim fields only ‚Äî what is cached in localStorage.
 * ~170 bytes per card. Never includes educational content.
 */
export interface SlimItemDocument {
  id: string;                  // e.g. "item_nacl"
  name: string;                // e.g. "Salt"
  chemicalFormula: string;     // e.g. "NaCl" (Unicode subscripts)
  emoji: string;               // e.g. "üßÇ"
  imageUrl?: string;
  rarity: 'common' | 'rare' | 'epic' | 'legendary';
  rarityValue: 1 | 2 | 3 | 4;
  placeId: PlaceId;            // which city location this belongs to
  validSlots: string[];        // slot IDs within that place
  shopData: {
    coinCost?: number;         // undefined = not coin-purchasable
    diamondCost?: number;      // undefined = not diamond-purchasable
  };
  skillContribution: number;   // this card's bonus value added to its place's skill total
  collections: string[];       // collection group IDs only ‚Äî not full objects
  deprecated: boolean;         // true = hidden from UI, never delete the row
}

/**
 * Full fields ‚Äî fetched from Firestore on card detail tap only.
 * ~800 bytes per card. NEVER stored in localStorage.
 */
export interface FullItemDocument extends SlimItemDocument {
  displayName: string;         // e.g. "The Seasoning of Life"
  description: string;
  cardBackground?: string;     // CSS gradient or colour token
  imageUrl?: string;
  topicConnections: string[];  // topic IDs this card relates to
  educational: {
    funFact: string;
    everydayUses: string[];
    category: 'element' | 'compound' | 'mixture' | 'process';
  };
  albumMetadata: {
    flavorText: string;
    sortOrder: number;
    tags: string[];
  };
}

// ‚îÄ‚îÄ‚îÄ Places ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

export type PlaceId =
  | 'lab'
  | 'kitchen'
  | 'toilet'
  | 'garden'
  | 'gas_station'
  | 'lifestyle_boutique'
  | 'beach'
  | 'school';

export interface SlotDocument {
  slotId: string;
  unlockCost?: number;         // undefined = free by default
  unlockCurrency?: 'coins' | 'diamonds';
  budgetOnly?: boolean;        // if true, can only be unlocked via extraSlotsBudget
  equippedItemId?: string;     // null = empty
}

export interface PlaceDocument {
  id: PlaceId;
  displayName: string;
  emoji: string;
  unlockCost: number;          // coin cost to unlock the place itself
  slots: SlotDocument[];
  skill: {
    description: string;
    formula: string;           // human-readable formula string for display
  };
}

// ‚îÄ‚îÄ‚îÄ User Documents ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

/**
 * Main user document ‚Äî users/{userId}
 * Kept lean: only IDs and numbers, never full objects.
 */
export interface UserChemCityData {
  userId: string;
  currencies: {
    coins: number;
    diamonds: number;
  };
  storeSlotCount: number;
  ownedItems: string[];        // array of item IDs only
  equipped: {
    [slotId: string]: string;  // slotId ‚Üí itemId
  };
  activeBonuses: ActiveBonuses;
  unlockedPlaces: PlaceId[];
  unlockedSlots: string[];     // slot IDs unlocked by the user
  extraSlotsBudget: number;    // remaining Gas Station bonus slots to distribute
  passiveIncome: {
    lastCollected: Date | null; // Firestore Timestamp ‚Äî set by server
  };
  streaks: {
    currentStreak: number;
    longestStreak: number;
    lastLoginDate: string;     // ISO date string YYYY-MM-DD
    streakFreezeCount: number;
  };
  cacheVersion: number;        // last known version when user doc was written
  createdAt: Date;
  updatedAt: Date;
}

/**
 * Progress sub-document ‚Äî users/{userId}/progress/data
 * Separated to protect the 1MB Firestore doc limit.
 */
export interface UserProgressData {
  collections: {
    [collectionId: string]: {
      collected: number;
      total: number;
      completed: boolean;
      rewardClaimed: boolean;
    };
  };
  topicMastery: {
    [topicId: string]: {
      quizzesCompleted: number;
      correctAnswers: number;
      totalQuestions: number;
    };
  };
}

// ‚îÄ‚îÄ‚îÄ Bonus Engine ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

/**
 * Computed bonuses ‚Äî recalculated after every equip/unequip.
 * Persisted to user doc so they're available instantly on load.
 */
export interface ActiveBonuses {
  passiveBaseCoinsPerHour: number;      // Garden: total_bonus √ó 10
  passiveMultiplier: number;            // Lab:    1 + (total_bonus √ó 0.1)
  quizFlatDiamondBonus: number;         // Kitchen: total_bonus √ó random(1,3) ‚Äî stored as max
  quizDiamondMultiplier: number;        // School: 1 + (total_bonus √ó 0.1)
  quizDoubleChancePercent: number;      // Beach:  min(total_bonus √ó 5, 100)
  dailyLoginDiamonds: number;           // Toilet: 5 + (total_bonus √ó 2)
  extraSlotsTotal: number;              // Gas Station: total_bonus
  shopDiscountPercent: number;          // Boutique: min(total_bonus √ó 2, 50) ‚Äî capped at 50%
}

// ‚îÄ‚îÄ‚îÄ Cache ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

export interface CacheManifest {
  version: number;
  fetchedAt: number;           // Date.now() timestamp
  itemIds: string[];           // IDs of what's cached
}

// ‚îÄ‚îÄ‚îÄ Collections ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

export interface CollectionDocument {
  id: string;
  displayName: string;
  description: string;
  itemIds: string[];
  rewardCoins?: number;
  rewardDiamonds?: number;
}

// ‚îÄ‚îÄ‚îÄ Topics ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

export interface TopicDocument {
  id: string;
  name: string;
  dseUnit: string;
  description?: string;
}

// ‚îÄ‚îÄ‚îÄ Cloud Function Request/Response Types ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

export interface EquipCardRequest {
  slotId: string;
  itemId: string;
}

export interface UnequipCardRequest {
  slotId: string;
}

export interface PurchaseCardRequest {
  itemId: string;
  currency: 'coins' | 'diamonds';
}

export interface UnlockPlaceRequest {
  placeId: string;
}

export interface UnlockSlotRequest {
  placeId: string;
  slotId: string;
  useExtraSlotBudget?: boolean;
}

export interface QuizRewardRequest {
  baseCoins: number;
  baseDiamonds: number;
  topicId?: string;
  correctAnswers?: number;
  totalQuestions?: number;
}

export interface QuizRewardResult {
  coinsAwarded: number;
  diamondsAwarded: number;
  didDouble?: boolean;
  breakdown?: {
    flatBonus: number;
    afterSchool: number;
    afterBeach: number;
  };
  ok?: boolean;
}


===== src/store/chemcityStore.ts =====

import { create } from 'zustand';
import { doc, getDoc, onSnapshot, type Unsubscribe } from 'firebase/firestore';
import { db } from '../firebase/config';
import { fetchSlimItems, fetchPlaces, fetchFullItem } from '../lib/cache';
import type {
  UserChemCityData,
  UserProgressData,
  SlimItemDocument,
  PlaceDocument,
  FullItemDocument,
} from '../lib/chemcity/types';
import {
  callChemCityInitUser,
  callChemCityEquipCard,
  callChemCityUnequipCard,
  callChemCityCollectPassiveIncome,
  callChemCityUnlockPlace,
  callChemCityUnlockSlot,
  callChemCityGetDailyLoginBonus,
  callChemCityQuizReward,
  callChemCityPurchaseCard,
  callChemCityUnlockStoreSlot,
} from '../lib/chemcity/cloudFunctions';
import { estimateUnclaimedCoins } from '../lib/chemcity/income';
import { getDailyStoreItems, STORE_MIN_SLOTS } from '../lib/chemcity/dailyStore';
import type { QuizRewardRequest, QuizRewardResult } from '../lib/chemcity/types';

type View = 'map' | 'place' | 'inventory' | 'store' | 'gas_station_distributor';

type RootUserDoc = {
  chemcity?: UserChemCityData;
} & Record<string, unknown>;

interface ChemCityStore {
  user: UserChemCityData | null;
  progress: UserProgressData | null;
  slimItems: SlimItemDocument[];
  places: PlaceDocument[];

  isLoading: boolean;
  error: string | null;

  view: View;
  selectedPlaceId: string | null;

  cardPickerSlotId: string | null;

  cardDetailItemId: string | null;
  cardDetailData: FullItemDocument | null;
  cardDetailLoading: boolean;

  passiveDisplayCoins: number;

  // Phase 4: store + unlock modals
  dailyStoreItems: SlimItemDocument[];
  storeSlotCount: number;
  storePurchaseItemId: string | null;
  storePurchaseData: FullItemDocument | null;
  storePurchaseLoading: boolean;
  placeUnlockModalId: string | null;

  quizReward: {
    result: QuizRewardResult | null;
    correctAnswers: number;
    totalQuestions: number;
    isAwarding: boolean;
  };

  dailyLogin: {
    diamonds: number;
    coins: number;
    streak: number;
    showModal: boolean;
    checked: boolean;
  };

  _unsubUser: Unsubscribe | null;

  loadAll: (userId: string) => Promise<void>;
  teardown: () => void;

  navigateToMap: () => void;
  navigateToPlace: (placeId: string) => void;
  navigateToInventory: () => void;
  navigateToStore: () => void;
  navigateToGasStationDistributor: () => void;

  openCardPicker: (slotId: string) => void;
  closeCardPicker: () => void;

  openCardDetail: (itemId: string) => Promise<void>;
  closeCardDetail: () => void;

  equipCard: (slotId: string, itemId: string) => Promise<void>;
  unequipCard: (slotId: string) => Promise<void>;

  collectIncome: () => Promise<{ coinsAwarded: number }>;

  unlockPlace: (placeId: string) => Promise<void>;
  unlockSlot: (placeId: string, slotId: string, useExtraSlotBudget?: boolean) => Promise<void>;

  tickPassiveDisplay: () => void;

  awardQuizReward: (request: QuizRewardRequest) => Promise<void>;
  clearQuizReward: () => void;

  checkDailyLogin: () => Promise<void>;
  dismissDailyLogin: () => void;

  computeDailyStore: (userId: string) => void;
  unlockStoreSlot: () => Promise<void>;

  openPurchaseConfirm: (itemId: string) => void;
  closePurchaseConfirm: () => void;
  purchaseCard: (itemId: string, currency: 'coins' | 'diamonds') => Promise<void>;

  openPlaceUnlockModal: (placeId: string) => void;
  closePlaceUnlockModal: () => void;
}

export const useChemCityStore = create<ChemCityStore>((set, get) => ({
  user: null,
  progress: null,
  slimItems: [],
  places: [],

  isLoading: false,
  error: null,

  view: 'map',
  selectedPlaceId: null,

  cardPickerSlotId: null,

  cardDetailItemId: null,
  cardDetailData: null,
  cardDetailLoading: false,

  passiveDisplayCoins: 0,

  dailyStoreItems: [],
  storeSlotCount: STORE_MIN_SLOTS,
  storePurchaseItemId: null,
  storePurchaseData: null,
  storePurchaseLoading: false,
  placeUnlockModalId: null,

  quizReward: {
    result: null,
    correctAnswers: 0,
    totalQuestions: 0,
    isAwarding: false,
  },

  dailyLogin: {
    diamonds: 0,
    coins: 0,
    streak: 0,
    showModal: false,
    checked: false,
  },

  _unsubUser: null,

  loadAll: async (userId: string) => {
    set({ isLoading: true, error: null });
    try {
      const [slimItems, places] = await Promise.all([fetchSlimItems(), fetchPlaces()]);

      await callChemCityInitUser();

      const userRef = doc(db, 'users', userId);
      const userSnap = await getDoc(userRef);
      const root = (userSnap.data() || {}) as RootUserDoc;
      const chemcity = (root.chemcity || null) as UserChemCityData | null;

      const progressRef = doc(db, 'users', userId, 'chemcity_progress', 'data');
      const progressSnap = await getDoc(progressRef);
      const progress = (progressSnap.data() || null) as UserProgressData | null;

      const existing = get()._unsubUser;
      if (existing) existing();

      const unsub = onSnapshot(userRef, (snap) => {
        if (!snap.exists()) return;
        const freshRoot = (snap.data() || {}) as RootUserDoc;
        const fresh = (freshRoot.chemcity || null) as UserChemCityData | null;

        // Phase 4: mirror storeSlotCount (default 3) + compute daily store items
        const slotCount = (fresh as any)?.storeSlotCount ?? STORE_MIN_SLOTS;
        const dailyStoreItems = fresh
          ? getDailyStoreItems(userId, slimItems, slotCount)
          : [];

        set({ user: fresh, storeSlotCount: slotCount, dailyStoreItems });
      });

      set({
        user: chemcity,
        progress,
        slimItems,
        places,
        isLoading: false,
        passiveDisplayCoins: 0,
        storeSlotCount: (chemcity as any)?.storeSlotCount ?? STORE_MIN_SLOTS,
        dailyStoreItems: chemcity ? getDailyStoreItems(userId, slimItems, (chemcity as any)?.storeSlotCount ?? STORE_MIN_SLOTS) : [],
        _unsubUser: unsub,
      });

      // Phase 3: check daily login bonus (non-blocking)
      get().checkDailyLogin();

      // Phase 4: compute store (non-blocking)
      setTimeout(() => get().computeDailyStore(userId), 200);
    } catch (err: any) {
      set({ isLoading: false, error: err?.message || 'Failed to load ChemCity' });
    }
  },

  teardown: () => {
    const unsub = get()._unsubUser;
    if (unsub) unsub();
    set({ _unsubUser: null });
  },

  navigateToMap: () => set({ view: 'map', selectedPlaceId: null }),
  navigateToPlace: (placeId) => set({ view: 'place', selectedPlaceId: placeId }),
  navigateToInventory: () => set({ view: 'inventory' }),
  navigateToStore: () => set({ view: 'store' }),
  navigateToGasStationDistributor: () => set({ view: 'gas_station_distributor' }),

  openCardPicker: (slotId) => set({ cardPickerSlotId: slotId }),
  closeCardPicker: () => set({ cardPickerSlotId: null }),

  openCardDetail: async (itemId: string) => {
    set({ cardDetailItemId: itemId, cardDetailData: null, cardDetailLoading: true });
    try {
      const full = await fetchFullItem(itemId);
      set({ cardDetailData: full ?? null, cardDetailLoading: false });
    } catch {
      set({ cardDetailLoading: false });
    }
  },
  closeCardDetail: () => set({ cardDetailItemId: null, cardDetailData: null, cardDetailLoading: false }),

  equipCard: async (slotId, itemId) => {
    await callChemCityEquipCard(slotId, itemId);
  },

  unequipCard: async (slotId) => {
    await callChemCityUnequipCard(slotId);
  },

  collectIncome: async () => {
    const result = await callChemCityCollectPassiveIncome();
    set({ passiveDisplayCoins: 0 });
    return { coinsAwarded: Number(result.coinsAwarded || 0) };
  },

  unlockPlace: async (placeId) => {
    await callChemCityUnlockPlace(placeId);
  },

  unlockSlot: async (placeId, slotId, useExtraSlotBudget) => {
    await callChemCityUnlockSlot(placeId, slotId, useExtraSlotBudget);
  },

  computeDailyStore: (userId: string) => {
    const { slimItems, storeSlotCount } = get();
    if (!slimItems.length) return;
    set({ dailyStoreItems: getDailyStoreItems(userId, slimItems, storeSlotCount) });
  },

  unlockStoreSlot: async () => {
    await callChemCityUnlockStoreSlot();
  },

  openPurchaseConfirm: (itemId: string) => {
    set({ storePurchaseItemId: itemId, storePurchaseData: null, storePurchaseLoading: true });
    fetchFullItem(itemId)
      .then((data) => set({ storePurchaseData: data ?? null, storePurchaseLoading: false }))
      .catch(() => set({ storePurchaseLoading: false }));
  },

  closePurchaseConfirm: () =>
    set({ storePurchaseItemId: null, storePurchaseData: null, storePurchaseLoading: false }),

  purchaseCard: async (itemId: string, currency: 'coins' | 'diamonds') => {
    await callChemCityPurchaseCard(itemId, currency);
  },

  openPlaceUnlockModal: (placeId: string) => set({ placeUnlockModalId: placeId }),
  closePlaceUnlockModal: () => set({ placeUnlockModalId: null }),

  tickPassiveDisplay: () => {
    const user = get().user;
    if (!user) return;

    const lastCollected = (user.passiveIncome?.lastCollected ?? null) as any;
    const coins = estimateUnclaimedCoins(user.activeBonuses, lastCollected);
    set({ passiveDisplayCoins: coins });
  },

  awardQuizReward: async (request) => {
    set((s) => ({
      quizReward: {
        ...s.quizReward,
        isAwarding: true,
        result: null,
      },
    }));

    try {
      const result = await callChemCityQuizReward(request);
      set({
        quizReward: {
          result,
          correctAnswers: request.correctAnswers ?? 0,
          totalQuestions: request.totalQuestions ?? 0,
          isAwarding: false,
        },
      });
    } catch {
      set((s) => ({
        quizReward: { ...s.quizReward, isAwarding: false },
      }));
    }
  },

  clearQuizReward: () => {
    set({
      quizReward: {
        result: null,
        correctAnswers: 0,
        totalQuestions: 0,
        isAwarding: false,
      },
    });
  },

  checkDailyLogin: async () => {
    const { dailyLogin } = get();
    if (dailyLogin.checked) return;

    try {
      const result = await callChemCityGetDailyLoginBonus();
      const alreadyClaimed = Boolean((result as any)?.alreadyClaimed);
      if (alreadyClaimed) {
        set((s) => ({ dailyLogin: { ...s.dailyLogin, checked: true } }));
        return;
      }

      set({
        dailyLogin: {
          diamonds: Number((result as any)?.diamondsAwarded || 0),
          coins: 0,
          streak: Number((result as any)?.currentStreak || 0),
          showModal: true,
          checked: true,
        },
      });
    } catch {
      set((s) => ({ dailyLogin: { ...s.dailyLogin, checked: true } }));
    }
  },

  dismissDailyLogin: () => {
    set((s) => ({ dailyLogin: { ...s.dailyLogin, showModal: false } }));
  },
}));


===== tests/chemcity/bonuses.test.ts =====

import {
  calcGardenCoinsPerHour,
  calcLabMultiplier,
  calcKitchenMaxDiamonds,
  calcSchoolMultiplier,
  calcBeachDoubleChance,
  calcToiletLoginDiamonds,
  calcGasStationExtraSlots,
  calcBoutiqueDiscount,
  computeActiveBonuses,
  computeQuizDiamonds,
  rollKitchenBonus,
  rollBeachDouble,
  getShopPrice,
} from "../../src/lib/chemcity/bonuses";

import type { SlimItemDocument, ActiveBonuses } from "../../src/lib/chemcity/types";

function makeItem(
  id: string,
  placeId: SlimItemDocument["placeId"],
  skillContribution: number
): SlimItemDocument {
  return {
    id,
    name: id,
    chemicalFormula: "X",
    emoji: "üß™",
    rarity: "common",
    rarityValue: 1,
    placeId,
    validSlots: [`${placeId}_slot_1`],
    shopData: { coinCost: 100 },
    skillContribution,
    collections: [],
    deprecated: false,
  };
}

describe("Garden coins per hour", () => {
  it("0 cards = 0 coins/hr", () => expect(calcGardenCoinsPerHour(0)).toBe(0));
  it("bonus 32 ‚Üí 320 coins/hr", () => expect(calcGardenCoinsPerHour(32)).toBe(320));
  it("linear with bonus", () => expect(calcGardenCoinsPerHour(10)).toBe(100));
});

describe("Lab multiplier", () => {
  it("0 cards = 1.0√ó", () => expect(calcLabMultiplier(0)).toBe(1));
  it("bonus 12 ‚Üí 2.2√ó", () => expect(calcLabMultiplier(12)).toBeCloseTo(2.2));
  it("bonus 10 ‚Üí 2.0√ó", () => expect(calcLabMultiplier(10)).toBe(2.0));
});

describe("Kitchen max diamonds", () => {
  it("0 bonus = 0", () => expect(calcKitchenMaxDiamonds(0)).toBe(0));
  it("bonus 16 ‚Üí 48", () => expect(calcKitchenMaxDiamonds(16)).toBe(48));
});

describe("School multiplier", () => {
  it("0 bonus = 1.0√ó", () => expect(calcSchoolMultiplier(0)).toBe(1));
  it("bonus 20 ‚Üí 3.0√ó", () => expect(calcSchoolMultiplier(20)).toBe(3.0));
});

describe("Beach double chance (capped at 100)", () => {
  it("0 bonus = 0%", () => expect(calcBeachDoubleChance(0)).toBe(0));
  it("bonus 10 = 50%", () => expect(calcBeachDoubleChance(10)).toBe(50));
  it("bonus 20 = 100% (cap)", () => expect(calcBeachDoubleChance(20)).toBe(100));
  it("bonus 30 = 100% (cap enforced)", () => expect(calcBeachDoubleChance(30)).toBe(100));
  it("never exceeds 100", () => {
    for (let b = 0; b <= 50; b++) {
      expect(calcBeachDoubleChance(b)).toBeLessThanOrEqual(100);
    }
  });
});

describe("Toilet daily login", () => {
  it("0 bonus = 5 diamonds (base)", () => expect(calcToiletLoginDiamonds(0)).toBe(5));
  it("bonus 24 ‚Üí 53", () => expect(calcToiletLoginDiamonds(24)).toBe(53));
  it("bonus 1 ‚Üí 7", () => expect(calcToiletLoginDiamonds(1)).toBe(7));
});

describe("Gas Station extra slots", () => {
  it("0 bonus = 0 extra slots", () => expect(calcGasStationExtraSlots(0)).toBe(0));
  it("bonus 16 = 16 slots", () => expect(calcGasStationExtraSlots(16)).toBe(16));
});

describe("Boutique discount (capped at 50%)", () => {
  it("0 bonus = 0%", () => expect(calcBoutiqueDiscount(0)).toBe(0));
  it("bonus 10 = 20%", () => expect(calcBoutiqueDiscount(10)).toBe(20));
  it("bonus 24 = 48%", () => expect(calcBoutiqueDiscount(24)).toBe(48));
  it("bonus 25 = 50% (exactly at cap)", () => expect(calcBoutiqueDiscount(25)).toBe(50));
  it("bonus 30 = 50% (cap enforced)", () => expect(calcBoutiqueDiscount(30)).toBe(50));
  it("never exceeds 50%", () => {
    for (let b = 0; b <= 100; b++) {
      expect(calcBoutiqueDiscount(b)).toBeLessThanOrEqual(50);
    }
  });
});

describe("computeActiveBonuses", () => {
  it("empty equipped ‚Üí defaults", () => {
    const bonuses = computeActiveBonuses({}, []);
    expect(bonuses.passiveBaseCoinsPerHour).toBe(0);
    expect(bonuses.passiveMultiplier).toBe(1);
    expect(bonuses.quizFlatDiamondBonus).toBe(0);
    expect(bonuses.quizDiamondMultiplier).toBe(1);
    expect(bonuses.quizDoubleChancePercent).toBe(0);
    expect(bonuses.dailyLoginDiamonds).toBe(5);
    expect(bonuses.extraSlotsTotal).toBe(0);
    expect(bonuses.shopDiscountPercent).toBe(0);
  });

  it("garden card contribution adds coins/hr", () => {
    const items: SlimItemDocument[] = [makeItem("item_plant", "garden", 10)];
    const bonuses = computeActiveBonuses({ garden_bed_1: "item_plant" }, items);
    expect(bonuses.passiveBaseCoinsPerHour).toBe(100);
    expect(bonuses.passiveMultiplier).toBe(1);
  });

  it("lab card multiplies garden income", () => {
    const items: SlimItemDocument[] = [
      makeItem("item_plant", "garden", 10),
      makeItem("item_flask", "lab", 10),
    ];
    const bonuses = computeActiveBonuses(
      { garden_bed_1: "item_plant", lab_bench_1: "item_flask" },
      items
    );
    expect(bonuses.passiveBaseCoinsPerHour).toBe(200);
    expect(bonuses.passiveMultiplier).toBe(2.0);
  });

  it("boutique discount is capped at 50", () => {
    const items: SlimItemDocument[] = [];
    const equipped: Record<string, string> = {};
    for (let i = 1; i <= 26; i++) {
      const id = `item_b${i}`;
      items.push(makeItem(id, "lifestyle_boutique", 1));
      equipped[`lifestyle_boutique_slot_${i}`] = id;
    }
    const bonuses = computeActiveBonuses(equipped, items);
    expect(bonuses.shopDiscountPercent).toBe(50);
  });

  it("deprecated cards do not contribute", () => {
    const item = makeItem("item_old", "garden", 10);
    item.deprecated = true;
    const bonuses = computeActiveBonuses({ garden_bed_1: "item_old" }, [item]);
    expect(bonuses.passiveBaseCoinsPerHour).toBe(0);
  });
});

describe("rollKitchenBonus", () => {
  it("0 kitchen bonus ‚Üí 0", () => {
    expect(rollKitchenBonus(0)).toBe(0);
  });

  it("kitchen bonus 10 ‚Üí value between 10 and 30", () => {
    for (let i = 0; i < 100; i++) {
      const result = rollKitchenBonus(10);
      expect(result).toBeGreaterThanOrEqual(10);
      expect(result).toBeLessThanOrEqual(30);
    }
  });
});

describe("rollBeachDouble", () => {
  it("0% chance ‚Üí never doubles", () => {
    for (let i = 0; i < 50; i++) {
      const doubled = rollBeachDouble(0);
      expect(doubled).toBe(false);
    }
  });
});

describe("computeQuizDiamonds", () => {
  it("no bonuses: base 5 diamonds", () => {
    const ab: ActiveBonuses = {
      passiveBaseCoinsPerHour: 0,
      passiveMultiplier: 1,
      quizFlatDiamondBonus: 0,
      quizDiamondMultiplier: 1,
      quizDoubleChancePercent: 0,
      dailyLoginDiamonds: 5,
      extraSlotsTotal: 0,
      shopDiscountPercent: 0,
    };
    const r = computeQuizDiamonds(5, ab);
    expect(r).toBe(5);
  });

  it("school 2√ó multiplier doubles diamonds", () => {
    const ab: ActiveBonuses = {
      passiveBaseCoinsPerHour: 0,
      passiveMultiplier: 1,
      quizFlatDiamondBonus: 0,
      quizDiamondMultiplier: 2,
      quizDoubleChancePercent: 0,
      dailyLoginDiamonds: 5,
      extraSlotsTotal: 0,
      shopDiscountPercent: 0,
    };
    const r = computeQuizDiamonds(5, ab);
    expect(r).toBe(10);
  });
});

describe("getShopPrice", () => {
  it("diamonds not discounted", () => {
    const ab: ActiveBonuses = {
      passiveBaseCoinsPerHour: 0,
      passiveMultiplier: 1,
      quizFlatDiamondBonus: 0,
      quizDiamondMultiplier: 1,
      quizDoubleChancePercent: 0,
      dailyLoginDiamonds: 5,
      extraSlotsTotal: 0,
      shopDiscountPercent: 50,
    };
    expect(getShopPrice(200, "diamonds", ab)).toBe(200);
  });

  it("50% discount halves coin price", () => {
    const ab: ActiveBonuses = {
      passiveBaseCoinsPerHour: 0,
      passiveMultiplier: 1,
      quizFlatDiamondBonus: 0,
      quizDiamondMultiplier: 1,
      quizDoubleChancePercent: 0,
      dailyLoginDiamonds: 5,
      extraSlotsTotal: 0,
      shopDiscountPercent: 50,
    };
    expect(getShopPrice(200, "coins", ab)).toBe(100);
  });
});


===== tests/chemcity/phase4.test.ts =====

import {
  getDailyStoreItems,
  utcDateString,
  msUntilUtcMidnight,
  countdownToMidnight,
  STORE_SLOT_UNLOCK_COSTS,
  STORE_MIN_SLOTS,
  STORE_MAX_SLOTS,
} from '../../src/lib/chemcity/dailyStore';

import { getEffectiveCoinPrice, canAffordItem, getDisplayPrice } from '../../src/lib/chemcity/shop';

import type { SlimItemDocument, ActiveBonuses } from '../../src/lib/chemcity/types';

function makeItem(id: string, rarity: SlimItemDocument['rarity'], coinCost: number): SlimItemDocument {
  return {
    id,
    name: id,
    chemicalFormula: 'X',
    emoji: 'üß™',
    rarity,
    rarityValue: { common: 1, rare: 2, epic: 3, legendary: 4 }[rarity] as any,
    placeId: 'lab',
    validSlots: ['lab_bench_1'],
    shopData: { coinCost },
    skillContribution: 0,
    collections: [],
    deprecated: false,
  };
}

function makeActiveBonuses(shopDiscountPercent: number): ActiveBonuses {
  return {
    passiveBaseCoinsPerHour: 0,
    passiveMultiplier: 1,
    quizFlatDiamondBonus: 0,
    quizDiamondMultiplier: 1,
    quizDoubleChancePercent: 0,
    dailyLoginDiamonds: 5,
    extraSlotsTotal: 0,
    shopDiscountPercent,
  };
}

const POOL = [
  ...Array.from({ length: 20 }, (_, i) => makeItem(`common_${i}`, 'common', 100)),
  ...Array.from({ length: 8 }, (_, i) => makeItem(`rare_${i}`, 'rare', 300)),
  ...Array.from({ length: 4 }, (_, i) => makeItem(`epic_${i}`, 'epic', 600)),
  ...Array.from({ length: 1 }, (_, i) => makeItem(`legendary_${i}`, 'legendary', 1000)),
];

describe('getDailyStoreItems ‚Äî determinism', () => {
  const DATE = new Date('2026-03-01T12:00:00Z');

  it('returns exactly storeSlotCount items', () => {
    const items = getDailyStoreItems('user123', POOL, 3, DATE);
    expect(items).toHaveLength(3);
  });

  it('returns correct count for 6 slots', () => {
    const items = getDailyStoreItems('user123', POOL, 6, DATE);
    expect(items).toHaveLength(6);
  });

  it('same user + same date ‚Üí same items (deterministic)', () => {
    const a = getDailyStoreItems('user123', POOL, 3, DATE);
    const b = getDailyStoreItems('user123', POOL, 3, DATE);
    expect(a.map((i) => i.id)).toEqual(b.map((i) => i.id));
  });

  it('different users on same date ‚Üí different selections', () => {
    const a = getDailyStoreItems('user_A', POOL, 3, DATE);
    const b = getDailyStoreItems('user_B', POOL, 3, DATE);
    expect(a.map((i) => i.id).join(',')).not.toBe(b.map((i) => i.id).join(','));
  });

  it('same user on different days ‚Üí different selections', () => {
    const day1 = new Date('2026-03-01T00:00:00Z');
    const day2 = new Date('2026-03-02T00:00:00Z');
    const a = getDailyStoreItems('user123', POOL, 3, day1);
    const b = getDailyStoreItems('user123', POOL, 3, day2);
    expect(a.map((i) => i.id).join(',')).not.toBe(b.map((i) => i.id).join(','));
  });

  it('no duplicate items in same day selection', () => {
    const items = getDailyStoreItems('user123', POOL, 6, DATE);
    const ids = items.map((i) => i.id);
    expect(new Set(ids).size).toBe(ids.length);
  });

  it('excludes deprecated items', () => {
    const poolWithDeprecated = [...POOL, { ...makeItem('deprecated_1', 'legendary', 500), deprecated: true }];
    for (let u = 0; u < 20; u++) {
      const items = getDailyStoreItems(`u${u}`, poolWithDeprecated, 6, DATE);
      items.forEach((item) => expect(item.deprecated).toBeFalsy());
    }
  });

  it('excludes items with no shop price', () => {
    const poolWithUnpurchasable = [...POOL, { ...makeItem('noshop_1', 'epic', 0), shopData: {} } as any];
    for (let u = 0; u < 20; u++) {
      const items = getDailyStoreItems(`u${u}`, poolWithUnpurchasable, 6, DATE);
      items.forEach((item) => {
        const hasCoin = item.shopData?.coinCost != null;
        const hasDia = item.shopData?.diamondCost != null;
        expect(hasCoin || hasDia).toBe(true);
      });
    }
  });
});

describe('utcDateString', () => {
  it('formats date as YYYY-MM-DD UTC', () => {
    expect(utcDateString(new Date('2026-03-05T23:59:59Z'))).toBe('2026-03-05');
  });

  it('rolls over at UTC midnight', () => {
    expect(utcDateString(new Date('2026-03-05T23:59:59.999Z'))).toBe('2026-03-05');
    expect(utcDateString(new Date('2026-03-06T00:00:00.000Z'))).toBe('2026-03-06');
  });
});

describe('msUntilUtcMidnight', () => {
  it('always returns a positive number', () => {
    expect(msUntilUtcMidnight()).toBeGreaterThan(0);
  });
});

describe('Store slot constants', () => {
  it('STORE_MIN_SLOTS is 3', () => expect(STORE_MIN_SLOTS).toBe(3));
  it('STORE_MAX_SLOTS is 6', () => expect(STORE_MAX_SLOTS).toBe(6));

  it('unlock costs are defined for slots 4, 5, 6', () => {
    expect(STORE_SLOT_UNLOCK_COSTS[4]).toBeGreaterThan(0);
    expect(STORE_SLOT_UNLOCK_COSTS[5]).toBeGreaterThan(STORE_SLOT_UNLOCK_COSTS[4]);
    expect(STORE_SLOT_UNLOCK_COSTS[6]).toBeGreaterThan(STORE_SLOT_UNLOCK_COSTS[5]);
  });
});

describe('getEffectiveCoinPrice', () => {
  it('no discount ‚Üí original price', () => {
    expect(getEffectiveCoinPrice(200, makeActiveBonuses(0))).toBe(200);
  });

  it('50% discount halves the price', () => {
    expect(getEffectiveCoinPrice(200, makeActiveBonuses(50))).toBe(100);
  });

  it('never reduces below 1', () => {
    expect(getEffectiveCoinPrice(1, makeActiveBonuses(50))).toBe(1);
  });
});

describe('canAffordItem', () => {
  it('can afford exact coin price', () => {
    expect(canAffordItem(100, undefined, 'coins', 100, 0, makeActiveBonuses(0))).toBe(true);
  });

  it('discount makes unaffordable item affordable', () => {
    expect(canAffordItem(200, undefined, 'coins', 100, 0, makeActiveBonuses(50))).toBe(true);
  });
});

describe('getDisplayPrice', () => {
  it('coin price with 20% discount ‚Üí 80', () => {
    expect(getDisplayPrice(100, undefined, 'coins', makeActiveBonuses(20))).toBe(80);
  });

  it('returns null when currency path unavailable', () => {
    expect(getDisplayPrice(undefined, 100, 'coins', makeActiveBonuses(0))).toBeNull();
    expect(getDisplayPrice(100, undefined, 'diamonds', makeActiveBonuses(0))).toBeNull();
  });
});

describe('countdownToMidnight', () => {
  it('returns a string', () => {
    expect(typeof countdownToMidnight(new Date('2026-03-05T22:30:00.000Z'))).toBe('string');
  });
});


===== tests/chemcity/quizReward.test.ts =====

import { BASE_DIAMONDS_PER_QUIZ, COINS_PER_CORRECT_ANSWER } from '../../src/hooks/useQuizReward';

describe('Quiz reward constants', () => {
  it('COINS_PER_CORRECT_ANSWER is positive', () => {
    expect(COINS_PER_CORRECT_ANSWER).toBeGreaterThan(0);
  });

  it('BASE_DIAMONDS_PER_QUIZ is positive', () => {
    expect(BASE_DIAMONDS_PER_QUIZ).toBeGreaterThan(0);
  });

  it('10 correct answers produces expected base coins', () => {
    expect(10 * COINS_PER_CORRECT_ANSWER).toBe(100);
  });

  it('0 correct answers produces 0 base coins', () => {
    expect(0 * COINS_PER_CORRECT_ANSWER).toBe(0);
  });
});

describe('DailyLogin streak messages', () => {
  function milestoneMessage(streak: number): string {
    if (streak === 1) return 'Welcome back! üëã';
    if (streak === 7) return '7-day streak! üéâ';
    if (streak === 30) return '30-day legend! üèÜ';
    if (streak % 10 === 0) return `${streak} days strong! ‚ö°`;
    return `${streak}-day streak! üî•`;
  }

  it('streak 1 shows welcome message', () => {
    expect(milestoneMessage(1)).toBe('Welcome back! üëã');
  });

  it('streak 7 shows 7-day message', () => {
    expect(milestoneMessage(7)).toBe('7-day streak! üéâ');
  });

  it('streak 30 shows legend message', () => {
    expect(milestoneMessage(30)).toBe('30-day legend! üèÜ');
  });

  it('streak 20 shows milestone message', () => {
    expect(milestoneMessage(20)).toBe('20 days strong! ‚ö°');
  });

  it('streak 5 shows generic streak message', () => {
    expect(milestoneMessage(5)).toBe('5-day streak! üî•');
  });
});
