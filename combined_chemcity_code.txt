================================================================================
FILE: functions/chemcity/collectPassiveIncome.ts
================================================================================

// ============================================================
// ChemCity — collectPassiveIncome Cloud Function
//
// CRITICAL: Server-side timestamp only. Client clock is IGNORED.
// Changing device clock to the future earns nothing.
//
// Algorithm:
//   1. Read user.passiveIncome.lastCollected from Firestore
//   2. Get current time from Firestore server timestamp
//   3. elapsed = serverNow - lastCollected
//   4. Cap elapsed at 24 hours
//   5. coins = passiveBaseCoinsPerHour × elapsed_in_hours
//   6. Add coins, write lastCollected = serverNow
//
// Called by client tap on "Collect" button.
// The client's displayed ticker is cosmetic only.
// ============================================================

import * as admin from 'firebase-admin';
import * as functions from 'firebase-functions';

const db = admin.firestore();

const MAX_HOURS = 24; // passive income cap

export const collectPassiveIncome = functions.https.onCall(
  async (data, context) => {
    if (!context.auth) {
      throw new functions.https.HttpsError(
        'unauthenticated',
        'User must be signed in.',
      );
    }

    const userId = context.auth.uid;
    const userRef = db.collection('users').doc(userId);

    return db.runTransaction(async (tx) => {
      const snap = await tx.get(userRef);
      if (!snap.exists) {
        throw new functions.https.HttpsError('not-found', 'User not initialised.');
      }

      const userData = snap.data()!;
      const bonuses = userData.activeBonuses;
      const passiveBase: number = bonuses.passiveBaseCoinsPerHour ?? 0;

      if (passiveBase === 0) {
        return { coinsAwarded: 0, message: 'No passive income yet — equip cards in the Garden and Lab.' };
      }

      // Server-side time only — client clock is irrelevant
      const serverNow = admin.firestore.Timestamp.now();
      const lastCollected: admin.firestore.Timestamp | null =
        userData.passiveIncome?.lastCollected ?? null;

      let elapsedSeconds = 0;
      if (lastCollected) {
        elapsedSeconds = serverNow.seconds - lastCollected.seconds;
      } else {
        // First ever collection — treat as if collected right now
        elapsedSeconds = 0;
      }

      // Cap at 24 hours
      const cappedSeconds = Math.min(elapsedSeconds, MAX_HOURS * 3600);
      const elapsedHours = cappedSeconds / 3600;

      const coinsAwarded = Math.floor(passiveBase * elapsedHours);

      // Write new balance + timestamp
      tx.update(userRef, {
        'currencies.coins': admin.firestore.FieldValue.increment(coinsAwarded),
        'passiveIncome.lastCollected': serverNow,
        updatedAt: serverNow,
      });

      return {
        coinsAwarded,
        elapsedHours: elapsedHours.toFixed(2),
        newLastCollected: serverNow.toDate().toISOString(),
      };
    });
  },
);

================================================================================
FILE: functions/chemcity/initChemCityUser.ts
================================================================================

// ============================================================
// ChemCity — User Initialization
// Creates the user doc + progress sub-document with defaults.
// Called by the initChemCityUser Cloud Function.
//
// NOTE: This function must run server-side (Cloud Function).
//       It writes currencies — clients cannot do this.
// ============================================================

import * as admin from 'firebase-admin';
import type { UserChemCityData, UserProgressData } from '../../src/lib/chemcity/types';

const db = admin.firestore();

/**
 * Creates a fresh ChemCity user doc and progress sub-document.
 * Called once per user on their first ChemCity session.
 *
 * Starter state:
 *  - 500 coins, 20 diamonds (enough to unlock Garden + Kitchen)
 *  - Lab unlocked by default (free)
 *  - No cards, no equipped items
 */
export async function initChemCityUser(userId: string): Promise<void> {
  const userRef = db.collection('users').doc(userId);
  const progressRef = userRef.collection('progress').doc('data');

  // Check if already initialised
  const existing = await userRef.get();
  if (existing.exists) {
    console.warn(`[initChemCityUser] User ${userId} already initialised — skipping.`);
    return;
  }

  const now = admin.firestore.FieldValue.serverTimestamp();

  const userDoc: Omit<UserChemCityData, 'createdAt' | 'updatedAt' | 'passiveIncome'> & {
    createdAt: admin.firestore.FieldValue;
    updatedAt: admin.firestore.FieldValue;
    passiveIncome: { lastCollected: null };
  } = {
    userId,
    currencies: {
      coins: 500,
      diamonds: 20,
    },
    ownedItems: [],
    equipped: {},
    activeBonuses: {
      passiveBaseCoinsPerHour: 0,
      passiveMultiplier: 1,
      quizFlatDiamondBonus: 0,
      quizDiamondMultiplier: 1,
      quizDoubleChancePercent: 0,
      dailyLoginDiamonds: 5, // base Toilet: 5 + (0 × 2)
      extraSlotsTotal: 0,
      shopDiscountPercent: 0,
    },
    unlockedPlaces: ['lab'], // Lab is free — unlocked from the start
    unlockedSlots: [],
    extraSlotsBudget: 0,
    passiveIncome: {
      lastCollected: null,
    },
    streaks: {
      currentStreak: 0,
      longestStreak: 0,
      lastLoginDate: '',
      streakFreezeCount: 0,
    },
    cacheVersion: 0, // will be updated on first client load
    createdAt: now,
    updatedAt: now,
  };

  const progressDoc: UserProgressData = {
    collections: {},
    topicMastery: {},
  };

  // Write both docs in a single batch
  const batch = db.batch();
  batch.set(userRef, userDoc);
  batch.set(progressRef, progressDoc);
  await batch.commit();

  console.info(`[initChemCityUser] User ${userId} initialised successfully.`);
}

================================================================================
FILE: src/components/chemcity/CardDetail.tsx
================================================================================

import React from 'react';
import { X, Zap, BookOpen, FlaskConical, Star } from 'lucide-react';
import { useChemCityStore } from '../../store/chemcityStore';

const RARITY_CONFIG: Record<string, {
  borderColor: string;
  glowColor: string;
  bgGradient: string;
  artBg: string;
  badgeColor: string;
  badgeText: string;
  foilBg: string;
}> = {
  common:    { borderColor: '#94a3b8', glowColor: 'rgba(148,163,184,0.3)', bgGradient: 'linear-gradient(165deg,#1e293b,#0f172a)', artBg: 'rgba(255,255,255,0.05)', badgeColor: 'rgba(148,163,184,0.2)', badgeText: '#94a3b8', foilBg: 'none' },
  rare:      { borderColor: '#60a5fa', glowColor: 'rgba(96,165,250,0.4)',   bgGradient: 'linear-gradient(165deg,#1e3a5f,#0f172a)', artBg: 'rgba(96,165,250,0.08)', badgeColor: 'rgba(96,165,250,0.2)', badgeText: '#60a5fa', foilBg: 'linear-gradient(135deg,rgba(96,165,250,0.06) 0%,transparent 60%)' },
  epic:      { borderColor: '#a855f7', glowColor: 'rgba(168,85,247,0.4)',   bgGradient: 'linear-gradient(165deg,#2d1b4e,#0f0a1e)', artBg: 'rgba(168,85,247,0.08)', badgeColor: 'rgba(168,85,247,0.2)', badgeText: '#a855f7', foilBg: 'linear-gradient(135deg,rgba(168,85,247,0.08) 0%,transparent 60%)' },
  legendary: { borderColor: '#fbbf24', glowColor: 'rgba(251,191,36,0.5)',   bgGradient: 'linear-gradient(165deg,#3d2800,#1a0f00)', artBg: 'rgba(251,191,36,0.1)',  badgeColor: 'rgba(251,191,36,0.2)', badgeText: '#fbbf24', foilBg: 'linear-gradient(135deg,rgba(251,191,36,0.1) 0%,transparent 60%)' },
};

const DetailSkeleton: React.FC = () => (
  <div style={{ padding: 24, display: 'flex', flexDirection: 'column', gap: 12 }}>
    {[1,2,3,4].map(i => (
      <div key={i} style={{ height: i === 1 ? 160 : 16, background: 'rgba(255,255,255,0.06)', borderRadius: 8, animation: 'pulse 1.5s ease-in-out infinite' }} />
    ))}
    <style>{`@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }`}</style>
  </div>
);

export const CardDetail: React.FC = () => {
  const cardDetailItemId = useChemCityStore(s => s.cardDetailItemId);
  const cardDetailData   = useChemCityStore(s => s.cardDetailData);
  const cardDetailLoading = useChemCityStore(s => s.cardDetailLoading);
  const slimItems        = useChemCityStore(s => s.slimItems);
  const closeCardDetail  = useChemCityStore(s => s.closeCardDetail);

  if (!cardDetailItemId) return null;

  const slim  = slimItems.find(i => i.id === cardDetailItemId);
  const full  = cardDetailData;
  const rarity = slim?.rarity ?? 'common';
  const cfg    = RARITY_CONFIG[rarity] ?? RARITY_CONFIG.common;
  const rarityStars = { common: 1, rare: 2, epic: 3, legendary: 4 }[rarity] ?? 1;

  return (
    <>
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Pacifico&family=Quicksand:wght@500;600;700;800&display=swap');
        .card-detail-shimmer {
          background: linear-gradient(105deg, transparent 30%, rgba(255,215,0,0.15) 50%, transparent 70%);
          animation: shimmerSlide 3s ease-in-out infinite;
        }
        @keyframes shimmerSlide { 0%,100%{transform:translateX(-200%)} 50%{transform:translateX(200%)} }
        @keyframes cardReveal { from{opacity:0;transform:scale(0.88) translateY(16px)} to{opacity:1;transform:scale(1) translateY(0)} }
        .card-detail-anim { animation: cardReveal 0.3s cubic-bezier(0.34,1.56,0.64,1) forwards; }
      `}</style>

      {/* Backdrop */}
      <div
        onClick={closeCardDetail}
        style={{
          position: 'fixed', inset: 0, zIndex: 60,
          background: 'rgba(4,10,9,0.85)',
          backdropFilter: 'blur(12px)',
          WebkitBackdropFilter: 'blur(12px)',
          display: 'flex', alignItems: 'center', justifyContent: 'center',
        }}
      >
        <div
          className="card-detail-anim"
          onClick={e => e.stopPropagation()}
          style={{
            display: 'flex',
            gap: 20,
            maxWidth: 680,
            width: '90vw',
            maxHeight: '90vh',
            overflow: 'hidden',
          }}
        >
          {/* ── Left: RPG Card ── */}
          <div style={{
            flexShrink: 0,
            width: 180,
            height: 260,
            borderRadius: 16,
            border: `2.5px solid ${cfg.borderColor}`,
            background: cfg.bgGradient,
            boxShadow: `0 0 40px ${cfg.glowColor}, 0 8px 32px rgba(0,0,0,0.7)`,
            overflow: 'hidden',
            position: 'relative',
            display: 'flex',
            flexDirection: 'column',
          }}>
            {/* Foil layer */}
            {cfg.foilBg !== 'none' && (
              <div style={{ position: 'absolute', inset: 0, background: cfg.foilBg, zIndex: 0, pointerEvents: 'none' }} />
            )}
            {rarity === 'legendary' && (
              <div className="card-detail-shimmer" style={{ position: 'absolute', inset: 0, zIndex: 1, pointerEvents: 'none' }} />
            )}

            {/* Card header: name + rarity */}
            <div style={{
              padding: '8px 10px 4px',
              position: 'relative', zIndex: 2,
              borderBottom: `1px solid ${cfg.borderColor}`,
              display: 'flex', justifyContent: 'space-between', alignItems: 'center',
            }}>
              <div style={{ color: '#f1f5f9', fontSize: 10, fontWeight: 800, fontFamily: "'Quicksand',sans-serif", flex: 1, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
                {full?.displayName || slim?.name || '—'}
              </div>
              <div style={{ color: cfg.badgeText, fontSize: 9, letterSpacing: 1, flexShrink: 0, marginLeft: 4 }}>
                {'✦'.repeat(rarityStars)}
              </div>
            </div>

            {/* Art */}
            <div style={{
              flex: 1, margin: '6px 8px 4px',
              background: cfg.artBg,
              border: `1px solid ${cfg.borderColor}`,
              borderRadius: 8,
              display: 'flex', alignItems: 'center', justifyContent: 'center',
              overflow: 'hidden',
              position: 'relative', zIndex: 2,
            }}>
              {full?.imageUrl || slim?.imageUrl ? (
                <img src={full?.imageUrl || slim?.imageUrl} alt={slim?.name}
                  style={{ width: '90%', height: '90%', objectFit: 'contain' }}
                  onError={e => { (e.target as HTMLImageElement).style.display = 'none'; }}
                />
              ) : (
                <span style={{ fontSize: 52, lineHeight: 1 }}>{slim?.emoji}</span>
              )}
            </div>

            {/* Formula */}
            <div style={{
              padding: '4px 10px', position: 'relative', zIndex: 2,
              borderTop: `1px solid ${cfg.borderColor}`,
              textAlign: 'center',
            }}>
              <div style={{ color: 'rgba(255,255,255,0.5)', fontSize: 9, fontFamily: 'monospace' }}>
                {slim?.chemicalFormula}
              </div>
              <div style={{
                marginTop: 3, background: cfg.badgeColor, borderRadius: 4,
                padding: '1px 0', fontSize: 8, fontWeight: 800, color: cfg.badgeText,
                fontFamily: "'Quicksand',sans-serif", textTransform: 'uppercase', letterSpacing: '0.06em',
              }}>{rarity}</div>
            </div>
          </div>

          {/* ── Right: Info Panel ── */}
          <div style={{
            flex: 1,
            background: 'rgba(255,255,255,0.04)',
            backdropFilter: 'blur(20px)',
            WebkitBackdropFilter: 'blur(20px)',
            border: '1px solid rgba(197,215,181,0.15)',
            borderRadius: 16,
            overflow: 'hidden',
            display: 'flex', flexDirection: 'column',
          }}>
            {/* Header */}
            <div style={{
              padding: '14px 16px',
              borderBottom: '1px solid rgba(255,255,255,0.08)',
              display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start',
            }}>
              <div>
                <div style={{ color: '#fff', fontWeight: 800, fontSize: 15, fontFamily: "'Quicksand',sans-serif" }}>
                  {full?.displayName || slim?.name || '—'}
                </div>
                <div style={{ color: 'rgba(255,255,255,0.4)', fontFamily: 'monospace', fontSize: 12, marginTop: 2 }}>
                  {slim?.chemicalFormula}
                </div>
              </div>
              <button onClick={closeCardDetail} style={{
                background: 'rgba(255,255,255,0.08)', border: '1px solid rgba(255,255,255,0.15)',
                borderRadius: 8, width: 28, height: 28, cursor: 'pointer',
                display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#94a3b8',
                flexShrink: 0, marginLeft: 8,
              }}>
                <X size={14} />
              </button>
            </div>

            {/* Scrollable content */}
            <div style={{ flex: 1, overflowY: 'auto', padding: '14px 16px', display: 'flex', flexDirection: 'column', gap: 12 }}>
              {cardDetailLoading ? <DetailSkeleton /> : (
                <>
                  {full?.description && (
                    <p style={{ color: 'rgba(255,255,255,0.65)', fontSize: 12, lineHeight: 1.7, margin: 0, fontFamily: "'Quicksand',sans-serif" }}>
                      {full.description}
                    </p>
                  )}

                  {slim?.skillContribution !== undefined && slim.skillContribution > 0 && (
                    <div style={{
                      background: 'rgba(118,168,165,0.12)', border: '1px solid rgba(118,168,165,0.3)',
                      borderRadius: 10, padding: '8px 12px',
                      display: 'flex', alignItems: 'center', justifyContent: 'space-between',
                    }}>
                      <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                        <Zap size={13} color="#76A8A5" />
                        <span style={{ color: 'rgba(197,215,181,0.8)', fontSize: 11, fontWeight: 700, fontFamily: "'Quicksand',sans-serif" }}>Skill Power</span>
                      </div>
                      <span style={{ color: '#76A8A5', fontWeight: 800, fontSize: 13, fontFamily: "'Quicksand',sans-serif" }}>
                        +{slim.skillContribution}
                      </span>
                    </div>
                  )}

                  {full?.educational?.funFact && (
                    <div style={{
                      background: 'rgba(96,165,250,0.08)', border: '1px solid rgba(96,165,250,0.25)',
                      borderRadius: 10, padding: '10px 12px',
                    }}>
                      <div style={{ display: 'flex', alignItems: 'center', gap: 6, marginBottom: 6 }}>
                        <FlaskConical size={12} color="#60a5fa" />
                        <span style={{ color: '#60a5fa', fontSize: 10, fontWeight: 800, fontFamily: "'Quicksand',sans-serif", textTransform: 'uppercase', letterSpacing: '0.08em' }}>Fun Fact</span>
                      </div>
                      <p style={{ color: 'rgba(255,255,255,0.7)', fontSize: 11, lineHeight: 1.65, margin: 0, fontFamily: "'Quicksand',sans-serif" }}>
                        {full.educational.funFact}
                      </p>
                    </div>
                  )}

                  {full?.educational?.everydayUses && full.educational.everydayUses.length > 0 && (
                    <div>
                      <div style={{ display: 'flex', alignItems: 'center', gap: 6, marginBottom: 6 }}>
                        <Star size={11} color="#c5d7b5" />
                        <span style={{ color: 'rgba(197,215,181,0.7)', fontSize: 10, fontWeight: 800, fontFamily: "'Quicksand',sans-serif", textTransform: 'uppercase', letterSpacing: '0.08em' }}>Everyday Uses</span>
                      </div>
                      <div style={{ display: 'flex', flexWrap: 'wrap', gap: 5 }}>
                        {full.educational.everydayUses.map(use => (
                          <span key={use} style={{
                            background: 'rgba(255,255,255,0.07)', border: '1px solid rgba(255,255,255,0.12)',
                            borderRadius: 6, padding: '3px 8px', fontSize: 10, color: 'rgba(255,255,255,0.65)',
                            fontFamily: "'Quicksand',sans-serif", fontWeight: 600,
                          }}>{use}</span>
                        ))}
                      </div>
                    </div>
                  )}

                  {full?.topicConnections && full.topicConnections.length > 0 && (
                    <div>
                      <div style={{ display: 'flex', alignItems: 'center', gap: 6, marginBottom: 6 }}>
                        <BookOpen size={11} color="#86efac" />
                        <span style={{ color: 'rgba(134,239,172,0.7)', fontSize: 10, fontWeight: 800, fontFamily: "'Quicksand',sans-serif", textTransform: 'uppercase', letterSpacing: '0.08em' }}>DSE Topics</span>
                      </div>
                      <div style={{ display: 'flex', flexWrap: 'wrap', gap: 5 }}>
                        {full.topicConnections.map(tid => (
                          <span key={tid} style={{
                            background: 'rgba(134,239,172,0.08)', border: '1px solid rgba(134,239,172,0.25)',
                            borderRadius: 6, padding: '3px 8px', fontSize: 10, color: '#86efac',
                            fontFamily: "'Quicksand',sans-serif", fontWeight: 600,
                          }}>{tid}</span>
                        ))}
                      </div>
                    </div>
                  )}

                  {full?.albumMetadata?.flavorText && (
                    <div style={{ borderTop: '1px solid rgba(255,255,255,0.08)', paddingTop: 10 }}>
                      <p style={{ color: 'rgba(255,255,255,0.3)', fontSize: 11, fontStyle: 'italic', margin: 0, lineHeight: 1.6, fontFamily: "'Quicksand',sans-serif" }}>
                        "{full.albumMetadata.flavorText}"
                      </p>
                    </div>
                  )}

                  {!full && !cardDetailLoading && (
                    <p style={{ color: 'rgba(255,255,255,0.3)', fontSize: 12, fontFamily: "'Quicksand',sans-serif" }}>Card details unavailable.</p>
                  )}
                </>
              )}
            </div>
          </div>
        </div>
      </div>
    </>
  );
};
================================================================================
FILE: src/components/chemcity/CardInventory.tsx
================================================================================

import React, { useMemo, useState } from 'react';
import { X, Warehouse, Search, SlidersHorizontal, Filter } from 'lucide-react';
import { useChemCityStore } from '../../store/chemcityStore';
import { ChemCard } from './ChemCard';

type RarityFilter = 'all' | 'common' | 'rare' | 'epic' | 'legendary';
type PlaceFilter = 'all' | string;

const RARITY_PILL_COLORS: Record<string, { bg: string; border: string; text: string }> = {
  all:       { bg: 'rgba(118,168,165,0.2)', border: 'rgba(118,168,165,0.5)', text: '#C5D7B5' },
  common:    { bg: 'rgba(148,163,184,0.15)', border: 'rgba(148,163,184,0.4)', text: '#94a3b8' },
  rare:      { bg: 'rgba(96,165,250,0.15)',  border: 'rgba(96,165,250,0.4)',  text: '#60a5fa' },
  epic:      { bg: 'rgba(168,85,247,0.15)',  border: 'rgba(168,85,247,0.4)',  text: '#a855f7' },
  legendary: { bg: 'rgba(251,191,36,0.15)', border: 'rgba(251,191,36,0.5)', text: '#fbbf24' },
};

export const CardInventory: React.FC = () => {
  const user          = useChemCityStore(s => s.user);
  const slimItems     = useChemCityStore(s => s.slimItems);
  const places        = useChemCityStore(s => s.places);
  const openCardDetail = useChemCityStore(s => s.openCardDetail);
  const navigateToMap = useChemCityStore(s => s.navigateToMap);

  const [placeFilter, setPlaceFilter]   = useState<PlaceFilter>('all');
  const [rarityFilter, setRarityFilter] = useState<RarityFilter>('all');
  const [searchQuery, setSearchQuery]   = useState('');
  const [showFilters, setShowFilters]   = useState(false);

  const ownedItems = useMemo(() => {
    if (!user) return [];
    return slimItems.filter(item => !item.deprecated && user.ownedItems.includes(item.id));
  }, [slimItems, user]);

  const filtered = useMemo(() => {
    return ownedItems.filter(item => {
      if (placeFilter !== 'all' && item.placeId !== placeFilter) return false;
      if (rarityFilter !== 'all' && item.rarity !== rarityFilter) return false;
      if (searchQuery && !item.name.toLowerCase().includes(searchQuery.toLowerCase()) && !item.chemicalFormula.toLowerCase().includes(searchQuery.toLowerCase())) return false;
      return true;
    });
  }, [ownedItems, placeFilter, rarityFilter, searchQuery]);

  const equippedSet = new Set(Object.values(user?.equipped ?? {}));
  const rarities: RarityFilter[] = ['all', 'legendary', 'epic', 'rare', 'common'];

  // Count by rarity for display
  const rarityCounts = useMemo(() => {
    const counts: Record<string, number> = { all: ownedItems.length };
    ownedItems.forEach(item => { counts[item.rarity] = (counts[item.rarity] ?? 0) + 1; });
    return counts;
  }, [ownedItems]);

  return (
    <>
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Pacifico&family=Quicksand:wght@500;600;700;800&display=swap');
        @keyframes warehouseIn { from{opacity:0;transform:scale(0.95)} to{opacity:1;transform:scale(1)} }
        .warehouse-panel { animation: warehouseIn 0.25s ease forwards; }
        .inv-rarity-btn { font-family:'Quicksand',sans-serif; font-weight:800; font-size:11px; padding:5px 10px; border-radius:20px; border:1.5px solid; cursor:pointer; transition:all 0.2s ease; text-transform:capitalize; white-space:nowrap; }
        .inv-place-btn { font-family:'Quicksand',sans-serif; font-weight:700; font-size:11px; padding:4px 10px; border-radius:8px; border:1.5px solid rgba(255,255,255,0.1); cursor:pointer; transition:all 0.2s ease; white-space:nowrap; background:transparent; color:rgba(255,255,255,0.5); }
        .inv-place-btn:hover { background:rgba(255,255,255,0.06); color:rgba(255,255,255,0.8); }
        .inv-place-btn.active { border-color:rgba(118,168,165,0.5); background:rgba(118,168,165,0.15); color:#C5D7B5; }
        .inv-search { width:100%; padding:9px 12px 9px 36px; background:rgba(255,255,255,0.05); border:1.5px solid rgba(255,255,255,0.1); border-radius:10px; color:#fff; font-size:13px; font-family:'Quicksand',sans-serif; font-weight:600; outline:none; box-sizing:border-box; }
        .inv-search:focus { border-color:rgba(118,168,165,0.5); background:rgba(255,255,255,0.07); }
        .inv-search::placeholder { color:rgba(255,255,255,0.25); }
        /* Shelf dividers */
        .shelf-row { background:rgba(255,255,255,0.02); border-radius:12px; padding:12px; border:1px solid rgba(255,255,255,0.05); margin-bottom:8px; }
        .shelf-row::after { content:''; display:block; height:3px; background:linear-gradient(90deg, rgba(118,168,165,0.3), transparent); border-radius:2px; margin-top:12px; }
      `}</style>

      {/* Full-screen backdrop */}
      <div
        onClick={navigateToMap}
        style={{
          position: 'fixed', inset: 0, zIndex: 90,
          background: 'rgba(4,10,9,0.92)',
          backdropFilter: 'blur(16px)',
          WebkitBackdropFilter: 'blur(16px)',
          display: 'flex', alignItems: 'center', justifyContent: 'center',
          padding: 16,
        }}
        role="dialog" aria-modal="true"
      >
        <div
          className="warehouse-panel"
          onClick={e => e.stopPropagation()}
          style={{
            width: 'min(860px, 96vw)',
            height: 'min(80vh, 680px)',
            background: 'rgba(8,20,19,0.97)',
            backdropFilter: 'blur(24px)',
            WebkitBackdropFilter: 'blur(24px)',
            border: '1.5px solid rgba(197,215,181,0.18)',
            borderRadius: 24,
            boxShadow: '0 40px 100px rgba(0,0,0,0.8), inset 0 1px 0 rgba(255,255,255,0.05)',
            overflow: 'hidden',
            display: 'flex', flexDirection: 'column',
            fontFamily: "'Quicksand',sans-serif",
          }}
        >
          {/* ── Warehouse Header ── */}
          <div style={{
            padding: '18px 22px 14px',
            borderBottom: '1px solid rgba(197,215,181,0.1)',
            background: 'linear-gradient(135deg, rgba(118,168,165,0.1) 0%, transparent 70%)',
          }}>
            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: 14 }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
                <div style={{
                  background: 'linear-gradient(135deg, rgba(118,168,165,0.3), rgba(118,168,165,0.1))',
                  border: '1.5px solid rgba(118,168,165,0.5)',
                  borderRadius: 12, width: 44, height: 44,
                  display: 'flex', alignItems: 'center', justifyContent: 'center',
                }}>
                  <Warehouse size={22} color="#76A8A5" />
                </div>
                <div>
                  <div style={{ color: '#fff', fontWeight: 800, fontSize: 18 }}>Card Warehouse</div>
                  <div style={{ color: 'rgba(197,215,181,0.5)', fontSize: 12, fontWeight: 600 }}>
                    {ownedItems.length} cards in storage
                    {filtered.length !== ownedItems.length && <span style={{ color: '#76A8A5', marginLeft: 8 }}>· {filtered.length} shown</span>}
                  </div>
                </div>
              </div>
              <div style={{ display: 'flex', gap: 8 }}>
                <button
                  onClick={() => setShowFilters(v => !v)}
                  style={{
                    background: showFilters ? 'rgba(118,168,165,0.2)' : 'rgba(255,255,255,0.06)',
                    border: `1.5px solid ${showFilters ? 'rgba(118,168,165,0.5)' : 'rgba(255,255,255,0.12)'}`,
                    borderRadius: 10, width: 36, height: 36, cursor: 'pointer',
                    display: 'flex', alignItems: 'center', justifyContent: 'center',
                    color: showFilters ? '#76A8A5' : '#94a3b8',
                  }}
                ><Filter size={15} /></button>
                <button onClick={navigateToMap} style={{
                  background: 'rgba(255,255,255,0.06)', border: '1.5px solid rgba(255,255,255,0.12)',
                  borderRadius: 10, width: 36, height: 36, cursor: 'pointer',
                  display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#94a3b8',
                }}><X size={16} /></button>
              </div>
            </div>

            {/* Search */}
            <div style={{ position: 'relative' }}>
              <Search size={14} color="rgba(255,255,255,0.3)" style={{ position: 'absolute', left: 12, top: '50%', transform: 'translateY(-50%)' }} />
              <input type="text" placeholder="Search by name or formula..." value={searchQuery}
                onChange={e => setSearchQuery(e.target.value)} className="inv-search" />
            </div>

            {/* Expandable filters */}
            {showFilters && (
              <div style={{ marginTop: 12, display: 'flex', flexDirection: 'column', gap: 8 }}>
                {/* Rarity row */}
                <div style={{ display: 'flex', gap: 6, overflowX: 'auto', paddingBottom: 2 }}>
                  {rarities.map(r => {
                    const pc = RARITY_PILL_COLORS[r] ?? RARITY_PILL_COLORS.all;
                    const active = rarityFilter === r;
                    return (
                      <button key={r} className="inv-rarity-btn" onClick={() => setRarityFilter(r)} style={{
                        background: active ? pc.bg : 'transparent',
                        borderColor: active ? pc.border : 'rgba(255,255,255,0.1)',
                        color: active ? pc.text : 'rgba(255,255,255,0.4)',
                      }}>
                        {r} {rarityCounts[r] != null ? <span style={{ opacity: 0.7 }}>({rarityCounts[r]})</span> : null}
                      </button>
                    );
                  })}
                </div>
                {/* Place row */}
                <div style={{ display: 'flex', gap: 5, overflowX: 'auto', paddingBottom: 2 }}>
                  <button className={`inv-place-btn ${placeFilter === 'all' ? 'active' : ''}`} onClick={() => setPlaceFilter('all')}>All</button>
                  {places.map(p => (
                    <button key={p.id} className={`inv-place-btn ${placeFilter === p.id ? 'active' : ''}`} onClick={() => setPlaceFilter(p.id)}>
                      {p.displayName}
                    </button>
                  ))}
                </div>
              </div>
            )}
          </div>

          {/* ── Card Grid (warehouse shelves) ── */}
          <div style={{ flex: 1, overflowY: 'auto', padding: '16px 22px 20px' }}>
            {filtered.length === 0 ? (
              <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', height: '100%', gap: 12 }}>
                <Warehouse size={44} color="rgba(255,255,255,0.1)" />
                <p style={{ color: 'rgba(255,255,255,0.3)', fontSize: 14, fontWeight: 600, margin: 0 }}>
                  {ownedItems.length === 0 ? 'No cards yet — visit ChemStore!' : 'No cards match your filters'}
                </p>
              </div>
            ) : (
              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, 110px)', gap: 14, justifyContent: 'start' }}>
                {filtered.map(item => (
                  <ChemCard
                    key={item.id}
                    item={item}
                    size="md"
                    isEquipped={equippedSet.has(item.id)}
                    onClick={() => openCardDetail(item.id)}
                  />
                ))}
              </div>
            )}
          </div>
        </div>
      </div>
    </>
  );
};
================================================================================
FILE: src/components/chemcity/CardPicker.tsx
================================================================================

import React, { useMemo, useState } from 'react';
import { X, Backpack, Search, Package, Info } from 'lucide-react';
import { useChemCityStore } from '../../store/chemcityStore';
import { ChemCard } from './ChemCard';
import type { SlimItemDocument } from '../../lib/chemcity/types';

const RARITY_ORDER: Record<string, number> = { legendary: 0, epic: 1, rare: 2, common: 3 };

export const CardPicker: React.FC = () => {
  const user               = useChemCityStore(s => s.user);
  const slimItems          = useChemCityStore(s => s.slimItems);
  const cardPickerSlotId   = useChemCityStore(s => s.cardPickerSlotId);
  const closeCardPicker    = useChemCityStore(s => s.closeCardPicker);
  const equipCard          = useChemCityStore(s => s.equipCard);
  const unequipCard        = useChemCityStore(s => s.unequipCard);
  const openCardDetail     = useChemCityStore(s => s.openCardDetail);

  const [equipping, setEquipping]     = useState<string | null>(null);
  const [filterRarity, setFilterRarity] = useState<string>('all');
  const [search, setSearch]           = useState('');

  const isOpen = !!cardPickerSlotId;

  const validCards = useMemo<SlimItemDocument[]>(() => {
    if (!cardPickerSlotId || !user) return [];
    return slimItems
      .filter(item => !item.deprecated && user.ownedItems.includes(item.id) && item.validSlots.includes(cardPickerSlotId))
      .sort((a, b) => (RARITY_ORDER[a.rarity] ?? 3) - (RARITY_ORDER[b.rarity] ?? 3));
  }, [cardPickerSlotId, slimItems, user]);

  const filteredCards = useMemo(() => {
    return validCards.filter(c => {
      if (filterRarity !== 'all' && c.rarity !== filterRarity) return false;
      if (search && !c.name.toLowerCase().includes(search.toLowerCase()) && !c.chemicalFormula.toLowerCase().includes(search.toLowerCase())) return false;
      return true;
    });
  }, [validCards, filterRarity, search]);

  const currentlyEquipped = cardPickerSlotId ? user?.equipped?.[cardPickerSlotId] : undefined;

  const handleSelect = async (itemId: string) => {
    if (!cardPickerSlotId || equipping) return;
    setEquipping(itemId);
    try {
      if (currentlyEquipped === itemId) await unequipCard(cardPickerSlotId);
      else await equipCard(cardPickerSlotId, itemId);
      closeCardPicker();
    } finally {
      setEquipping(null);
    }
  };

  const handleUnequip = async () => {
    if (!cardPickerSlotId || !currentlyEquipped) return;
    setEquipping('__unequip__');
    try {
      await unequipCard(cardPickerSlotId);
      closeCardPicker();
    } finally {
      setEquipping(null);
    }
  };

  if (!isOpen) return null;

  const rarities = ['all', 'legendary', 'epic', 'rare', 'common'];
  const slotLabel = cardPickerSlotId?.replace(/_/g, ' ') ?? '';

  return (
    <>
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Pacifico&family=Quicksand:wght@500;600;700;800&display=swap');
        @keyframes backdropIn { from{opacity:0} to{opacity:1} }
        @keyframes panelIn { from{opacity:0;transform:scale(0.93) translateY(20px)} to{opacity:1;transform:scale(1) translateY(0)} }
        .picker-anim { animation: panelIn 0.28s cubic-bezier(0.34,1.56,0.64,1) forwards; }
        .rarity-pill { font-family:'Quicksand',sans-serif; font-weight:800; font-size:11px; padding:5px 12px; border-radius:20px; border:1.5px solid; cursor:pointer; transition:all 0.2s ease; text-transform:capitalize; white-space:nowrap; }
        .card-slot-hover:hover { border-color:rgba(118,168,165,0.5) !important; background:rgba(118,168,165,0.08) !important; }
      `}</style>

      {/* Backdrop */}
      <div
        onClick={closeCardPicker}
        style={{
          position: 'fixed', inset: 0, zIndex: 55,
          background: 'rgba(4,10,9,0.88)',
          backdropFilter: 'blur(14px)',
          WebkitBackdropFilter: 'blur(14px)',
          display: 'flex', alignItems: 'center', justifyContent: 'center',
          animation: 'backdropIn 0.2s ease',
        }}
      >
        <div
          className="picker-anim"
          onClick={e => e.stopPropagation()}
          style={{
            width: 'min(580px, 94vw)',
            maxHeight: '88vh',
            background: 'rgba(8,20,19,0.96)',
            backdropFilter: 'blur(24px)',
            WebkitBackdropFilter: 'blur(24px)',
            border: '1.5px solid rgba(197,215,181,0.18)',
            borderRadius: 22,
            boxShadow: '0 32px 80px rgba(0,0,0,0.7), 0 0 0 1px rgba(255,255,255,0.04)',
            overflow: 'hidden',
            display: 'flex', flexDirection: 'column',
            fontFamily: "'Quicksand', sans-serif",
          }}
        >
          {/* ── Header: Backpack ── */}
          <div style={{
            padding: '18px 20px 14px',
            borderBottom: '1px solid rgba(197,215,181,0.1)',
            background: 'linear-gradient(135deg, rgba(118,168,165,0.12) 0%, transparent 100%)',
          }}>
            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
                <div style={{
                  background: 'rgba(118,168,165,0.2)', border: '1.5px solid rgba(118,168,165,0.4)',
                  borderRadius: 12, width: 42, height: 42,
                  display: 'flex', alignItems: 'center', justifyContent: 'center',
                }}>
                  <Backpack size={20} color="#76A8A5" />
                </div>
                <div>
                  <div style={{ color: '#fff', fontWeight: 800, fontSize: 16 }}>Your Backpack</div>
                  <div style={{ color: 'rgba(197,215,181,0.6)', fontSize: 12, fontWeight: 600, textTransform: 'capitalize' }}>
                    Slot: <span style={{ color: '#76A8A5' }}>{slotLabel}</span>
                    <span style={{ color: 'rgba(255,255,255,0.3)', marginLeft: 8 }}>{validCards.length} compatible cards</span>
                  </div>
                </div>
              </div>
              <button onClick={closeCardPicker} style={{
                background: 'rgba(255,255,255,0.07)', border: '1.5px solid rgba(255,255,255,0.12)',
                borderRadius: 10, width: 34, height: 34, cursor: 'pointer',
                display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#94a3b8',
              }}><X size={16} /></button>
            </div>

            {/* Search */}
            <div style={{ position: 'relative', marginTop: 12 }}>
              <Search size={14} color="rgba(255,255,255,0.3)" style={{ position: 'absolute', left: 12, top: '50%', transform: 'translateY(-50%)' }} />
              <input
                type="text"
                placeholder="Search cards..."
                value={search}
                onChange={e => setSearch(e.target.value)}
                style={{
                  width: '100%', padding: '9px 12px 9px 34px',
                  background: 'rgba(255,255,255,0.05)', border: '1.5px solid rgba(255,255,255,0.1)',
                  borderRadius: 10, color: '#fff', fontSize: 13, fontFamily: "'Quicksand',sans-serif",
                  fontWeight: 600, outline: 'none', boxSizing: 'border-box',
                }}
              />
            </div>

            {/* Rarity filters */}
            <div style={{ display: 'flex', gap: 6, marginTop: 10, overflowX: 'auto', paddingBottom: 2 }}>
              {rarities.map(r => (
                <button key={r} className="rarity-pill" onClick={() => setFilterRarity(r)} style={{
                  background: filterRarity === r ? 'rgba(118,168,165,0.25)' : 'transparent',
                  borderColor: filterRarity === r ? '#76A8A5' : 'rgba(255,255,255,0.12)',
                  color: filterRarity === r ? '#C5D7B5' : 'rgba(255,255,255,0.5)',
                }}>{r}</button>
              ))}
            </div>
          </div>

          {/* Unequip current */}
          {currentlyEquipped && (
            <div style={{ padding: '10px 20px', borderBottom: '1px solid rgba(255,255,255,0.06)' }}>
              <button onClick={handleUnequip} disabled={!!equipping} style={{
                width: '100%', padding: '9px', borderRadius: 10,
                background: 'rgba(239,68,68,0.08)', border: '1.5px solid rgba(239,68,68,0.3)',
                color: '#f87171', fontWeight: 800, fontSize: 12, cursor: 'pointer',
                fontFamily: "'Quicksand',sans-serif", transition: 'all 0.2s',
              }}>
                {equipping === '__unequip__' ? 'Removing...' : '↩ Remove equipped card'}
              </button>
            </div>
          )}

          {/* Card Grid */}
          <div style={{ flex: 1, overflowY: 'auto', padding: '16px 20px 20px' }}>
            {filteredCards.length === 0 ? (
              <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', padding: '40px 0', gap: 12 }}>
                <Package size={36} color="rgba(255,255,255,0.15)" />
                <p style={{ color: 'rgba(255,255,255,0.35)', fontSize: 13, fontWeight: 600, margin: 0 }}>
                  {validCards.length === 0 ? 'No cards for this slot yet' : 'No cards match filter'}
                </p>
              </div>
            ) : (
              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, 110px)', gap: 14, justifyContent: 'center' }}>
                {filteredCards.map(item => {
                  const isEq = user?.equipped?.[cardPickerSlotId!] === item.id;
                  return (
                    <div key={item.id} style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', gap: 6 }}>
                      <ChemCard
                        item={item}
                        size="md"
                        isEquipped={isEq}
                        onClick={() => handleSelect(item.id)}
                      />
                      <button
                        onClick={() => openCardDetail(item.id)}
                        style={{
                          background: 'rgba(255,255,255,0.05)', border: '1px solid rgba(255,255,255,0.1)',
                          borderRadius: 6, padding: '3px 10px', color: 'rgba(255,255,255,0.45)',
                          fontSize: 10, cursor: 'pointer', fontFamily: "'Quicksand',sans-serif",
                          fontWeight: 700, display: 'flex', alignItems: 'center', gap: 4, transition: 'all 0.2s',
                        }}
                        className="card-slot-hover"
                      >
                        <Info size={9} />Info
                      </button>
                    </div>
                  );
                })}
              </div>
            )}
          </div>
        </div>
      </div>
    </>
  );
};
================================================================================
FILE: src/components/chemcity/ChemCard.tsx
================================================================================

import React from 'react';
import type { SlimItemDocument } from '../../lib/chemcity/types';

// ─── Rarity Config ────────────────────────────────────────────
const RARITY_CONFIG: Record<string, {
  borderColor: string;
  glowColor: string;
  bgGradient: string;
  artBg: string;
  badgeColor: string;
  badgeText: string;
  stars: string;
  shimmer: boolean;
}> = {
  common: {
    borderColor: 'rgba(148,163,184,0.5)',
    glowColor: 'rgba(148,163,184,0.2)',
    bgGradient: 'linear-gradient(165deg, #1e293b 0%, #0f172a 100%)',
    artBg: 'rgba(255,255,255,0.04)',
    badgeColor: 'rgba(148,163,184,0.25)',
    badgeText: '#94a3b8',
    stars: '✦',
    shimmer: false,
  },
  rare: {
    borderColor: 'rgba(96,165,250,0.7)',
    glowColor: 'rgba(96,165,250,0.25)',
    bgGradient: 'linear-gradient(165deg, #1e3a5f 0%, #0f172a 100%)',
    artBg: 'rgba(96,165,250,0.06)',
    badgeColor: 'rgba(96,165,250,0.2)',
    badgeText: '#60a5fa',
    stars: '✦✦',
    shimmer: false,
  },
  epic: {
    borderColor: 'rgba(168,85,247,0.7)',
    glowColor: 'rgba(168,85,247,0.3)',
    bgGradient: 'linear-gradient(165deg, #2d1b4e 0%, #0f0a1e 100%)',
    artBg: 'rgba(168,85,247,0.07)',
    badgeColor: 'rgba(168,85,247,0.2)',
    badgeText: '#a855f7',
    stars: '✦✦✦',
    shimmer: false,
  },
  legendary: {
    borderColor: 'rgba(251,191,36,0.85)',
    glowColor: 'rgba(251,191,36,0.4)',
    bgGradient: 'linear-gradient(165deg, #3d2800 0%, #1a0f00 100%)',
    artBg: 'rgba(251,191,36,0.08)',
    badgeColor: 'rgba(251,191,36,0.2)',
    badgeText: '#fbbf24',
    stars: '✦✦✦✦',
    shimmer: true,
  },
};

interface ChemCardProps {
  item: SlimItemDocument;
  isEquipped?: boolean;
  isOwned?: boolean;
  size?: 'sm' | 'md' | 'lg';
  onClick?: () => void;
  showDetailHint?: boolean;
}

const SIZE_MAP = {
  sm: { w: 88,  h: 124, art: 54,  namePx: 9,  formulaPx: 8,  badgePx: 7,  pad: 5  },
  md: { w: 110, h: 158, art: 68,  namePx: 11, formulaPx: 9,  badgePx: 8,  pad: 6  },
  lg: { w: 140, h: 200, art: 86,  namePx: 12, formulaPx: 10, badgePx: 9,  pad: 8  },
};

export const ChemCard: React.FC<ChemCardProps> = ({
  item,
  isEquipped = false,
  isOwned = true,
  size = 'md',
  onClick,
}) => {
  const cfg = RARITY_CONFIG[item.rarity] ?? RARITY_CONFIG.common;
  const dim = SIZE_MAP[size];

  return (
    <button
      onClick={onClick}
      style={{
        width: dim.w,
        height: dim.h,
        flexShrink: 0,
        position: 'relative',
        borderRadius: 10,
        border: `2px solid ${isEquipped ? '#4ade80' : cfg.borderColor}`,
        background: cfg.bgGradient,
        boxShadow: isEquipped
          ? `0 0 0 2px rgba(74,222,128,0.4), 0 4px 20px rgba(0,0,0,0.5)`
          : `0 0 16px ${cfg.glowColor}, 0 4px 12px rgba(0,0,0,0.5)`,
        cursor: onClick ? 'pointer' : 'default',
        fontFamily: "'Quicksand', sans-serif",
        overflow: 'hidden',
        transition: 'transform 0.15s ease, box-shadow 0.15s ease',
        filter: !isOwned ? 'grayscale(0.7) opacity(0.6)' : 'none',
        padding: 0,
        outline: 'none',
      }}
      className={cfg.shimmer ? 'legendary-card' : ''}
      aria-label={`${item.name} card`}
      onMouseEnter={e => {
        if (onClick) (e.currentTarget as HTMLElement).style.transform = 'translateY(-3px) scale(1.02)';
      }}
      onMouseLeave={e => {
        (e.currentTarget as HTMLElement).style.transform = '';
      }}
    >
      {/* Shimmer overlay for legendary */}
      {cfg.shimmer && (
        <div style={{
          position: 'absolute', inset: 0, borderRadius: 8, zIndex: 1, pointerEvents: 'none',
          background: 'linear-gradient(105deg, transparent 30%, rgba(255,215,0,0.12) 50%, transparent 70%)',
          animation: 'shimmerSlide 3s ease-in-out infinite',
        }} />
      )}

      {/* Equipped badge */}
      {isEquipped && (
        <div style={{
          position: 'absolute', top: 4, left: 4, zIndex: 10,
          background: '#4ade80', borderRadius: 4, padding: '1px 5px',
          fontSize: 8, fontWeight: 800, color: '#052e16',
          fontFamily: "'Quicksand', sans-serif",
        }}>✓ EQ</div>
      )}

      {/* Rarity stars - top right */}
      <div style={{
        position: 'absolute', top: 4, right: 4, zIndex: 10,
        color: cfg.badgeText, fontSize: dim.badgePx, fontWeight: 800, letterSpacing: 1,
      }}>{cfg.stars}</div>

      {/* Art section */}
      <div style={{
        height: dim.art, margin: `${dim.pad}px ${dim.pad}px 0`,
        background: cfg.artBg,
        borderRadius: 7,
        border: `1px solid ${cfg.borderColor}`,
        display: 'flex', alignItems: 'center', justifyContent: 'center',
        overflow: 'hidden',
        position: 'relative',
      }}>
        {item.imageUrl ? (
          <img
            src={item.imageUrl}
            alt={item.name}
            style={{ width: '90%', height: '90%', objectFit: 'contain' }}
            loading="lazy"
            onError={e => { (e.target as HTMLImageElement).style.display = 'none'; }}
          />
        ) : (
          <span style={{ fontSize: dim.art * 0.48, lineHeight: 1 }}>{item.emoji}</span>
        )}
      </div>

      {/* Name + formula */}
      <div style={{
        padding: `${dim.pad - 1}px ${dim.pad}px 0`,
        textAlign: 'center',
      }}>
        <div style={{
          color: '#f1f5f9',
          fontSize: dim.namePx,
          fontWeight: 800,
          lineHeight: 1.2,
          fontFamily: "'Quicksand', sans-serif",
          overflow: 'hidden',
          textOverflow: 'ellipsis',
          whiteSpace: 'nowrap',
        }}>{item.name}</div>
        <div style={{
          color: 'rgba(255,255,255,0.5)',
          fontSize: dim.formulaPx,
          fontFamily: 'monospace',
          marginTop: 1,
        }}>{item.chemicalFormula}</div>
      </div>

      {/* Rarity badge footer */}
      <div style={{
        position: 'absolute', bottom: dim.pad, left: dim.pad, right: dim.pad,
        background: cfg.badgeColor,
        borderRadius: 4,
        padding: '2px 0',
        textAlign: 'center',
        fontSize: dim.badgePx,
        fontWeight: 800,
        color: cfg.badgeText,
        fontFamily: "'Quicksand', sans-serif",
        textTransform: 'uppercase',
        letterSpacing: '0.05em',
      }}>
        {item.rarity}
      </div>

      <style>{`
        @keyframes shimmerSlide {
          0% { transform: translateX(-100%); }
          50% { transform: translateX(100%); }
          100% { transform: translateX(100%); }
        }
        .legendary-card { animation: legendaryPulse 2s ease-in-out infinite; }
        @keyframes legendaryPulse {
          0%, 100% { box-shadow: 0 0 20px rgba(251,191,36,0.4), 0 4px 12px rgba(0,0,0,0.5); }
          50% { box-shadow: 0 0 32px rgba(251,191,36,0.65), 0 4px 16px rgba(0,0,0,0.6); }
        }
      `}</style>
    </button>
  );
};
================================================================================
FILE: src/components/chemcity/ChemCityMap.tsx
================================================================================

import React, { useEffect, useRef, useState } from 'react';
import { useChemCityStore } from '../../store/chemcityStore';
import { PassiveIncomeCollector } from './PassiveIncomeCollector';

export const ChemCityMap: React.FC = () => {
  const user = useChemCityStore((s) => s.user);
  const places = useChemCityStore((s) => s.places);
  const navigateToPlace = useChemCityStore((s) => s.navigateToPlace);
  const openPlaceUnlockModal = useChemCityStore((s) => s.openPlaceUnlockModal);
  const [mapLevel, setMapLevel] = useState<'world' | 'home'>('world');

  const isHotspotEditorEnabled = false;
  const [editMode, setEditMode] = useState(false);
  const [selectedHotspotKey, setSelectedHotspotKey] = useState<string | null>(null);

  const mapImgRef = useRef<HTMLImageElement | null>(null);
  const [mapNaturalWidth, setMapNaturalWidth] = useState(0);
  const [mapRenderedWidth, setMapRenderedWidth] = useState(0);
  const [worldHotspots, setWorldHotspots] = useState<
    Array<{
      key: string;
      label: string;
      placeId?: string;
      leftPct: number;
      topPct: number;
      action?: 'home';
    }>
  >([
    { key: 'school', label: 'School', placeId: 'school', leftPct: 32.372, topPct: 34.495 },
    { key: 'beach', label: 'Beach', placeId: 'beach', leftPct: 44.952, topPct: 74.039 },
    { key: 'boutique', label: 'Boutique', placeId: 'lifestyle_boutique', leftPct: 29.487, topPct: 63.241 },
    { key: 'gas_station', label: 'Gas Station', placeId: 'gas_station', leftPct: 67.147, topPct: 50.761 },
    { key: 'home', label: 'Home', leftPct: 48.958, topPct: 50.06, action: 'home' },
  ]);

  const [homeHotspots, setHomeHotspots] = useState<
    Array<{
      key: string;
      label: string;
      placeId: string;
      leftPct: number;
      topPct: number;
    }>
  >([
    { key: 'toilet', label: 'Toilet', placeId: 'toilet', leftPct: 29.728, topPct: 49.079 },
    { key: 'kitchen', label: 'Kitchen', placeId: 'kitchen', leftPct: 29.728, topPct: 73.057 },
    { key: 'garden', label: 'Garden', placeId: 'garden', leftPct: 12.26, topPct: 72.496 },
    { key: 'lab', label: 'Lab', placeId: 'lab', leftPct: 73.397, topPct: 49.079 },
  ]);

  const worldHotspotsSnapshot: Array<{
    key: string;
    label: string;
    placeId?: string;
    leftPct: number;
    topPct: number;
    action?: 'home';
  }> = worldHotspots;

  const homeHotspotsSnapshot: Array<{
    key: string;
    label: string;
    placeId: string;
    leftPct: number;
    topPct: number;
  }> = homeHotspots;

  if (!user) return null;

  const placeById = (id: string) => places.find((p) => p.id === id) ?? null;
  const isPlaceUnlocked = (placeId: string) => {
    const place = placeById(placeId);
    if (!place) return false;
    return place.unlockCost === 0 || user.unlockedPlaces.includes(placeId as any);
  };

  const mapSrc = mapLevel === 'world' ? '/Map1.png' : '/Map2.png';

  const activeHotspots = mapLevel === 'world' ? worldHotspots : homeHotspots;

  useEffect(() => {
    const img = mapImgRef.current;
    if (!img) return;

    const update = () => {
      const rect = img.getBoundingClientRect();
      setMapRenderedWidth(rect.width);
    };

    update();

    let ro: ResizeObserver | null = null;
    if (typeof ResizeObserver !== 'undefined') {
      ro = new ResizeObserver(() => update());
      ro.observe(img);
    } else {
      window.addEventListener('resize', update);
    }

    return () => {
      if (ro) ro.disconnect();
      else window.removeEventListener('resize', update);
    };
  }, [mapSrc]);

  const hotspotScale = (() => {
    if (!mapNaturalWidth || !mapRenderedWidth) return 1;
    const scale = mapRenderedWidth / mapNaturalWidth;
    return Math.max(0.65, Math.min(1.25, scale * 1.1));
  })();

  const exportHotspotCoords = async () => {
    const payload = {
      mapLevel,
      hotspots: activeHotspots.map((h) => ({
        key: h.key,
        label: h.label,
        leftPct: h.leftPct,
        topPct: h.topPct,
      })),
    };

    const text = JSON.stringify(payload, null, 2);
    console.log('[ChemCityMap] Hotspot coords export:\n' + text);

    try {
      if (typeof navigator !== 'undefined' && navigator.clipboard?.writeText) {
        await navigator.clipboard.writeText(text);
      }
    } catch {
      // ignore clipboard errors
    }
  };

  const HotspotButton: React.FC<{
    label: string;
    leftPct: number;
    topPct: number;
    scale: number;
    onClick: () => void;
    disabled?: boolean;
    locked?: boolean;
  }> = ({ label, leftPct, topPct, scale, onClick, disabled, locked }) => {
    return (
      <button
        type="button"
        aria-label={label}
        title={locked ? `${label} (Locked — tap to unlock)` : label}
        onClick={(e) => {
          e.stopPropagation();
          if (disabled) return;
          onClick();
        }}
        disabled={disabled}
        className={`absolute rounded-full border font-bold shadow-md transition-all px-4 py-2 text-xs ${
          disabled
            ? 'bg-slate-800/80 border-slate-700 text-slate-500 cursor-not-allowed'
            : locked
            ? 'bg-slate-800/90 hover:bg-slate-700 border-amber-600/80 text-amber-300 active:scale-95'
            : 'bg-indigo-500/90 hover:bg-indigo-400 border-indigo-200 text-white active:scale-95'
        }`}
        style={{
          left: `${leftPct}%`,
          top: `${topPct}%`,
          transform: `translate(-50%, -50%) scale(${scale})`,
          transformOrigin: 'center',
        }}
      >
        {locked ? `🔒 ${label}` : label}
      </button>
    );
  };

  return (
    <div className="relative w-full h-full flex-1">
      <PassiveIncomeCollector />

      <div className="absolute inset-0 overflow-auto">
        <div
          className="relative w-full"
          onClick={(e) => {
            if (!isHotspotEditorEnabled) return;
            if (!editMode) return;
            if (!selectedHotspotKey) return;

            const target = e.currentTarget;
            const rect = target.getBoundingClientRect();
            const leftPct = ((e.clientX - rect.left) / rect.width) * 100;
            const topPct = ((e.clientY - rect.top) / rect.height) * 100;
            const leftRounded = Math.round(leftPct * 1000) / 1000;
            const topRounded = Math.round(topPct * 1000) / 1000;

            const leftClamped = Math.max(0, Math.min(100, leftRounded));
            const topClamped = Math.max(0, Math.min(100, topRounded));

            if (mapLevel === 'world') {
              setWorldHotspots((hs) =>
                hs.map((h) => (h.key === selectedHotspotKey ? { ...h, leftPct: leftClamped, topPct: topClamped } : h)),
              );
            } else {
              setHomeHotspots((hs) =>
                hs.map((h) => (h.key === selectedHotspotKey ? { ...h, leftPct: leftClamped, topPct: topClamped } : h)),
              );
            }

            console.log(
              `[ChemCityMap] ${mapLevel} set ${selectedHotspotKey}: leftPct=${leftClamped}, topPct=${topClamped}`,
            );
          }}
        >
          <img
            ref={mapImgRef}
            src={mapSrc}
            alt={mapLevel === 'world' ? 'ChemCity world map' : 'ChemCity home map'}
            className="w-full h-auto"
            loading="lazy"
            onLoad={(e) => {
              const el = e.currentTarget;
              if (el.naturalWidth) setMapNaturalWidth(el.naturalWidth);
              const rect = el.getBoundingClientRect();
              setMapRenderedWidth(rect.width);
            }}
          />

        {mapLevel === 'world'
          ? worldHotspotsSnapshot.map((h) => (
            <HotspotButton
              key={h.key}
              label={h.label}
              leftPct={h.leftPct}
              topPct={h.topPct}
              scale={hotspotScale}
              locked={h.placeId ? !isPlaceUnlocked(h.placeId) : false}
              onClick={() => {
                if (isHotspotEditorEnabled && editMode) {
                  setSelectedHotspotKey(h.key);
                  return;
                }
                if (h.action === 'home') {
                  setMapLevel('home');
                  return;
                }
                if (!h.placeId) return;
                if (!isPlaceUnlocked(h.placeId)) {
                  openPlaceUnlockModal(h.placeId);
                  return;
                }
                navigateToPlace(h.placeId);
              }}
              disabled={h.placeId ? !placeById(h.placeId) : false}
            />
          ))
          : homeHotspotsSnapshot.map((h) => (
            <HotspotButton
              key={h.key}
              label={h.label}
              leftPct={h.leftPct}
              topPct={h.topPct}
              scale={hotspotScale}
              onClick={() => {
                if (isHotspotEditorEnabled && editMode) {
                  setSelectedHotspotKey(h.key);
                  return;
                }
                if (!isPlaceUnlocked(h.placeId)) {
                  openPlaceUnlockModal(h.placeId);
                  return;
                }
                navigateToPlace(h.placeId);
              }}
              disabled={!placeById(h.placeId)}
              locked={!isPlaceUnlocked(h.placeId)}
            />
          ))}

        {isHotspotEditorEnabled && (
          <div
            className="absolute left-3 bottom-3 z-20 pointer-events-auto"
            onClick={(e) => e.stopPropagation()}
            onMouseDown={(e) => e.stopPropagation()}
            onPointerDown={(e) => e.stopPropagation()}
          >
            <div className="flex items-center gap-2">
              <button
                type="button"
                onClick={() => {
                  setEditMode((v) => !v);
                  setSelectedHotspotKey(null);
                }}
                className={`text-xs font-bold rounded-xl px-3 py-2 border backdrop-blur transition-colors ${
                  editMode
                    ? 'bg-indigo-600/90 border-indigo-300 text-white'
                    : 'bg-slate-900/80 hover:bg-slate-800 border-slate-700 text-slate-200'
                }`}
              >
                {editMode ? 'Editing' : 'Edit hotspots'}
              </button>
              {editMode && (
                <button
                  type="button"
                  onClick={() => exportHotspotCoords()}
                  className="text-xs font-bold rounded-xl px-3 py-2 border bg-slate-900/80 hover:bg-slate-800 border-slate-700 text-slate-200 backdrop-blur transition-colors"
                >
                  Export
                </button>
              )}
            </div>

            {editMode && (
              <div className="mt-2 p-2 rounded-xl bg-slate-900/80 border border-slate-700 backdrop-blur max-w-[86vw]">
                <div className="flex flex-wrap gap-1.5">
                  {activeHotspots.map((h) => (
                    <button
                      key={h.key}
                      type="button"
                      onClick={() => setSelectedHotspotKey(h.key)}
                      className={`text-[11px] font-bold rounded-lg px-2 py-1 border transition-colors ${
                        selectedHotspotKey === h.key
                          ? 'bg-indigo-600 border-indigo-300 text-white'
                          : 'bg-slate-800 border-slate-600 text-slate-200 hover:bg-slate-700'
                      }`}
                    >
                      {h.label}
                    </button>
                  ))}
                </div>
                <div className="mt-1 text-slate-300/80 text-[11px]">
                  {selectedHotspotKey
                    ? `Click map to set: ${selectedHotspotKey}`
                    : 'Select a hotspot, then click on the map'}
                </div>
              </div>
            )}
          </div>
        )}

        {mapLevel === 'home' && (
          <button
            type="button"
            onClick={() => setMapLevel('world')}
            className="absolute left-3 bottom-[4.5rem] z-10 w-12 h-12 rounded-2xl bg-slate-900/80 hover:bg-slate-800 border border-slate-700 backdrop-blur text-white font-bold"
            aria-label="Back to city map"
            title="Back"
          >
            ←
          </button>
        )}
        </div>
      </div>
    </div>
  );
};

================================================================================
FILE: src/components/chemcity/ChemCityRoot.tsx
================================================================================

import React, { useEffect } from 'react';
import { useAuth } from '../../contexts/AuthContext';
import { useChemCityStore } from '../../store/chemcityStore';
import { CurrencyBar } from './CurrencyBar';
import { ChemCityMap } from './ChemCityMap';
import { PlaceView } from './PlaceView';
import { CardInventory } from './CardInventory';
import { CardPicker } from './CardPicker';
import { CardDetail } from './CardDetail';
import { DailyLoginModal } from './DailyLoginModal';
import { QuizRewardModal } from './QuizRewardModal';
import { ChemStore } from './ChemStore';
import { PurchaseConfirmModal } from './PurchaseConfirmModal';
import { PlaceUnlockModal } from './PlaceUnlockModal';
import { GasStationDistributor } from './GasStationDistributor';
import { CollectionsAlbum } from './CollectionsAlbum';
import { OnboardingOverlay } from './OnboardingOverlay';

export const ChemCityRoot: React.FC = () => {
  const { currentUser } = useAuth();

  const view = useChemCityStore((s) => s.view);
  const isLoading = useChemCityStore((s) => s.isLoading);
  const error = useChemCityStore((s) => s.error);
  const loadAll = useChemCityStore((s) => s.loadAll);
  const teardown = useChemCityStore((s) => s.teardown);
  const dailyLoginOpen = useChemCityStore((s) => s.dailyLogin.showModal);
  const showOnboarding = useChemCityStore((s) => s.showOnboarding);

  useEffect(() => {
    if (!currentUser?.uid) return;
    loadAll(currentUser.uid);
    return () => {
      teardown();
    };
  }, [currentUser?.uid, loadAll, teardown]);

  if (!currentUser) {
    return (
      <div className="flex flex-col min-h-screen bg-slate-950 items-center justify-center gap-4 px-8">
        <span className="text-5xl">🧪</span>
        <p className="text-slate-400 text-sm text-center">Please sign in to access ChemCity.</p>
      </div>
    );
  }

  if (isLoading) {
    return (
      <div className="flex flex-col min-h-screen bg-slate-950 items-center justify-center gap-4">
        <span className="text-5xl animate-pulse">🧪</span>
        <p className="text-slate-400 text-sm">Loading ChemCity...</p>
      </div>
    );
  }

  if (error) {
    return (
      <div className="flex flex-col min-h-screen bg-slate-950 items-center justify-center gap-4 px-8">
        <span className="text-4xl">⚠️</span>
        <p className="text-red-400 text-sm text-center">{error}</p>
        <button
          onClick={() => window.location.reload()}
          className="bg-slate-700 hover:bg-slate-600 text-white rounded-lg px-4 py-2 text-sm"
        >
          Retry
        </button>
      </div>
    );
  }

  return (
    <div className="relative flex flex-col min-h-screen bg-slate-950 text-white overflow-hidden">
      <CurrencyBar />

      <main className="flex-1 overflow-hidden flex flex-col">
        {view === 'map' && <ChemCityMap />}
        {view === 'place' && <PlaceView />}
        {view === 'inventory' && <CardInventory />}
        {view === 'store' && <ChemStore />}
        {view === 'gas_station_distributor' && <GasStationDistributor />}
        {view === 'collections' && <CollectionsAlbum />}
      </main>

      <CardPicker />
      <CardDetail />

      <DailyLoginModal />
      {!dailyLoginOpen && <QuizRewardModal />}

      <PlaceUnlockModal />
      <PurchaseConfirmModal />

      {showOnboarding && <OnboardingOverlay />}
    </div>
  );
};

================================================================================
FILE: src/components/chemcity/ChemStore.tsx
================================================================================

import React, { useEffect, useState } from 'react';
import { X, ShoppingBag, Clock, Lock, Plus, Coins, Gem, Tag } from 'lucide-react';
import { useChemCityStore } from '../../store/chemcityStore';
import { getEffectiveCoinPrice } from '../../lib/chemcity/shop';
import { countdownToMidnight, STORE_SLOT_UNLOCK_COSTS, STORE_MAX_SLOTS } from '../../lib/chemcity/dailyStore';

const RARITY_CONFIG: Record<string, {
  borderColor: string; glowColor: string; bgGradient: string; artBg: string;
  badgeColor: string; badgeText: string; labelBg: string;
}> = {
  common:    { borderColor: '#94a3b8', glowColor: 'rgba(148,163,184,0.2)', bgGradient: 'linear-gradient(165deg,#1e293b,#0f172a)', artBg: 'rgba(255,255,255,0.04)', badgeColor: 'rgba(148,163,184,0.2)', badgeText: '#94a3b8', labelBg: 'rgba(148,163,184,0.15)' },
  rare:      { borderColor: '#60a5fa', glowColor: 'rgba(96,165,250,0.35)',  bgGradient: 'linear-gradient(165deg,#1e3a5f,#0f172a)', artBg: 'rgba(96,165,250,0.07)',  badgeColor: 'rgba(96,165,250,0.2)',  badgeText: '#60a5fa', labelBg: 'rgba(96,165,250,0.15)'  },
  epic:      { borderColor: '#a855f7', glowColor: 'rgba(168,85,247,0.35)',  bgGradient: 'linear-gradient(165deg,#2d1b4e,#0f0a1e)', artBg: 'rgba(168,85,247,0.07)',  badgeColor: 'rgba(168,85,247,0.2)',  badgeText: '#a855f7', labelBg: 'rgba(168,85,247,0.15)' },
  legendary: { borderColor: '#fbbf24', glowColor: 'rgba(251,191,36,0.45)',  bgGradient: 'linear-gradient(165deg,#3d2800,#1a0f00)', artBg: 'rgba(251,191,36,0.09)',  badgeColor: 'rgba(251,191,36,0.2)',  badgeText: '#fbbf24', labelBg: 'rgba(251,191,36,0.15)' },
};

export const ChemStore: React.FC = () => {
  const user             = useChemCityStore(s => s.user);
  const dailyStoreItems  = useChemCityStore(s => s.dailyStoreItems);
  const storeSlotCount   = useChemCityStore(s => s.storeSlotCount);
  const openPurchaseConfirm = useChemCityStore(s => s.openPurchaseConfirm);
  const unlockStoreSlot  = useChemCityStore(s => s.unlockStoreSlot);

  const [countdown, setCountdown]   = useState(() => countdownToMidnight());
  const [unlockingSlot, setUnlockingSlot] = useState(false);
  const [unlockError, setUnlockError] = useState<string | null>(null);

  useEffect(() => {
    const id = setInterval(() => setCountdown(countdownToMidnight()), 1000);
    return () => clearInterval(id);
  }, []);

  const discount  = user?.activeBonuses.shopDiscountPercent ?? 0;
  const coins     = user?.currencies.coins ?? 0;
  const ownedSet  = new Set(user?.ownedItems ?? []);

  const nextSlotNum  = storeSlotCount + 1;
  const nextSlotCost = STORE_SLOT_UNLOCK_COSTS[nextSlotNum] ?? null;
  const canUnlockMore = storeSlotCount < STORE_MAX_SLOTS;
  const canAffordNext = nextSlotCost != null && coins >= nextSlotCost;

  const handleUnlockSlot = async () => {
    if (unlockingSlot || !canUnlockMore || !canAffordNext) return;
    setUnlockingSlot(true);
    setUnlockError(null);
    try { await unlockStoreSlot(); }
    catch (err: any) { setUnlockError(err?.message ?? 'Failed to unlock slot.'); }
    finally { setUnlockingSlot(false); }
  };

  return (
    <>
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Pacifico&family=Quicksand:wght@500;600;700;800&display=swap');
        @keyframes shimmerSlide { 0%,100%{transform:translateX(-200%)} 50%{transform:translateX(200%)} }
        @keyframes legendGlow { 0%,100%{box-shadow:0 0 20px rgba(251,191,36,0.4),0 4px 12px rgba(0,0,0,0.5)} 50%{box-shadow:0 0 36px rgba(251,191,36,0.7),0 4px 16px rgba(0,0,0,0.6)} }
        .store-card:hover { transform:translateY(-4px) !important; }
        .store-card { transition:transform 0.2s ease, box-shadow 0.2s ease !important; }
        .owned-overlay { position:absolute; inset:0; background:rgba(0,0,0,0.5); border-radius:inherit; display:flex; align-items:center; justify-content:center; }
        .slot-bar-segment { height:4px; border-radius:2px; flex:1; transition:background 0.4s ease; }
      `}</style>

      <div style={{ display: 'flex', flexDirection: 'column', flex: 1, paddingTop: 76, fontFamily: "'Quicksand',sans-serif", minHeight: 0 }}>

        {/* ── Store Header ── */}
        <div style={{
          padding: '16px 20px 14px',
          borderBottom: '1px solid rgba(197,215,181,0.1)',
          background: 'linear-gradient(135deg, rgba(118,168,165,0.1) 0%, transparent 80%)',
          flexShrink: 0,
        }}>
          <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: 10 }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
              <div style={{
                background: 'linear-gradient(135deg,rgba(118,168,165,0.3),rgba(118,168,165,0.1))',
                border: '1.5px solid rgba(118,168,165,0.5)',
                borderRadius: 12, width: 46, height: 46,
                display: 'flex', alignItems: 'center', justifyContent: 'center',
              }}>
                <ShoppingBag size={22} color="#76A8A5" />
              </div>
              <div>
                <div style={{ color: '#fff', fontWeight: 800, fontSize: 18 }}>ChemStore</div>
                <div style={{ display: 'flex', alignItems: 'center', gap: 6, color: 'rgba(197,215,181,0.5)', fontSize: 12, fontWeight: 600 }}>
                  <Clock size={11} />
                  <span>Resets in {countdown}</span>
                </div>
              </div>
            </div>
            {discount > 0 && (
              <div style={{
                display: 'flex', alignItems: 'center', gap: 5,
                background: 'rgba(52,211,153,0.15)', border: '1.5px solid rgba(52,211,153,0.4)',
                borderRadius: 20, padding: '5px 12px',
              }}>
                <Tag size={13} color="#34d399" />
                <span style={{ color: '#34d399', fontWeight: 800, fontSize: 13 }}>{discount}% OFF</span>
              </div>
            )}
          </div>

          {/* Slot progress bar */}
          <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
            <div style={{ display: 'flex', gap: 3, flex: 1 }}>
              {Array.from({ length: STORE_MAX_SLOTS }, (_, i) => (
                <div key={i} className="slot-bar-segment" style={{
                  background: i < storeSlotCount ? 'rgba(118,168,165,0.8)' : 'rgba(255,255,255,0.08)',
                }} />
              ))}
            </div>
            <span style={{ color: 'rgba(255,255,255,0.4)', fontSize: 11, fontWeight: 700, flexShrink: 0 }}>
              {storeSlotCount}/{STORE_MAX_SLOTS} slots
            </span>
          </div>
        </div>

        {/* ── Card Display ── */}
        <div style={{ flex: 1, overflowY: 'auto', padding: '20px' }}>
          {dailyStoreItems.length === 0 ? (
            <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', height: 200, gap: 12 }}>
              <ShoppingBag size={40} color="rgba(255,255,255,0.1)" style={{ animation: 'legendGlow 2s infinite' }} />
              <p style={{ color: 'rgba(255,255,255,0.3)', fontSize: 14, fontWeight: 600, margin: 0 }}>Loading store…</p>
            </div>
          ) : (
            <div style={{ display: 'flex', flexDirection: 'column', gap: 12 }}>
              {/* ── Card Row ── */}
              <div style={{
                display: 'grid',
                gridTemplateColumns: `repeat(${Math.min(dailyStoreItems.length, 3)}, 1fr)`,
                gap: 12,
                justifyItems: 'center',
              }}>
                {dailyStoreItems.map((item, idx) => {
                  const isOwned = ownedSet.has(item.id);
                  const cfg = RARITY_CONFIG[item.rarity] ?? RARITY_CONFIG.common;
                  const rawCoin = item.shopData?.coinCost;
                  const rawDiamond = item.shopData?.diamondCost;
                  const effCoin = rawCoin != null ? getEffectiveCoinPrice(rawCoin, user?.activeBonuses ?? null) : null;
                  const coinSaved = rawCoin != null && effCoin != null ? rawCoin - effCoin : 0;

                  return (
                    <div key={item.id} style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', gap: 8, width: '100%', maxWidth: 160 }}>
                      {/* Vertical RPG card */}
                      <button
                        onClick={() => openPurchaseConfirm(item.id)}
                        className="store-card"
                        style={{
                          position: 'relative',
                          width: '100%', maxWidth: 150, height: 210,
                          borderRadius: 14,
                          border: `2px solid ${cfg.borderColor}`,
                          background: cfg.bgGradient,
                          boxShadow: item.rarity === 'legendary'
                            ? `0 0 28px ${cfg.glowColor}, 0 6px 20px rgba(0,0,0,0.6)`
                            : `0 0 14px ${cfg.glowColor}, 0 4px 12px rgba(0,0,0,0.5)`,
                          cursor: 'pointer', overflow: 'hidden', padding: 0,
                          animation: item.rarity === 'legendary' ? 'legendGlow 2.5s ease-in-out infinite' : 'none',
                        }}
                      >
                        {/* Shimmer for legendary */}
                        {item.rarity === 'legendary' && (
                          <div style={{
                            position: 'absolute', inset: 0, zIndex: 1, pointerEvents: 'none',
                            background: 'linear-gradient(105deg,transparent 30%,rgba(255,215,0,0.12) 50%,transparent 70%)',
                            animation: 'shimmerSlide 3s ease-in-out infinite',
                          }} />
                        )}

                        {/* Slot # badge */}
                        <div style={{
                          position: 'absolute', top: 6, left: 8, zIndex: 3,
                          color: 'rgba(255,255,255,0.3)', fontSize: 9, fontWeight: 700,
                          fontFamily: "'Quicksand',sans-serif",
                        }}>#{idx + 1}</div>

                        {/* Stars */}
                        <div style={{
                          position: 'absolute', top: 5, right: 7, zIndex: 3,
                          color: cfg.badgeText, fontSize: 8, letterSpacing: 1,
                        }}>{'✦'.repeat({ common:1, rare:2, epic:3, legendary:4 }[item.rarity] ?? 1)}</div>

                        {/* Art */}
                        <div style={{
                          height: 130, margin: '14px 10px 6px',
                          background: cfg.artBg,
                          border: `1px solid ${cfg.borderColor}`,
                          borderRadius: 8,
                          display: 'flex', alignItems: 'center', justifyContent: 'center',
                          overflow: 'hidden', position: 'relative', zIndex: 2,
                        }}>
                          {item.imageUrl ? (
                            <img src={item.imageUrl} alt={item.name}
                              style={{ width: '88%', height: '88%', objectFit: 'contain' }} loading="lazy"
                              onError={e => { (e.target as HTMLImageElement).style.display='none'; }}
                            />
                          ) : (
                            <span style={{ fontSize: 48 }}>{item.emoji}</span>
                          )}
                        </div>

                        {/* Name */}
                        <div style={{ padding: '0 10px 4px', textAlign: 'center', position: 'relative', zIndex: 2 }}>
                          <div style={{ color: '#f1f5f9', fontSize: 11, fontWeight: 800, fontFamily: "'Quicksand',sans-serif", lineHeight: 1.25, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>{item.name}</div>
                          <div style={{ color: 'rgba(255,255,255,0.4)', fontSize: 9, fontFamily: 'monospace', marginTop: 1 }}>{item.chemicalFormula}</div>
                        </div>

                        {/* Rarity footer */}
                        <div style={{
                          position: 'absolute', bottom: 8, left: 10, right: 10,
                          background: cfg.badgeColor, borderRadius: 4, padding: '2px 0',
                          textAlign: 'center', fontSize: 8, fontWeight: 800,
                          color: cfg.badgeText, fontFamily: "'Quicksand',sans-serif",
                          textTransform: 'uppercase', letterSpacing: '0.06em', zIndex: 2,
                        }}>{item.rarity}</div>

                        {/* Owned overlay */}
                        {isOwned && (
                          <div className="owned-overlay" style={{ zIndex: 4, borderRadius: 12 }}>
                            <div style={{
                              background: 'rgba(52,211,153,0.9)', borderRadius: 8,
                              padding: '6px 14px', fontWeight: 800, fontSize: 12,
                              color: '#052e16', fontFamily: "'Quicksand',sans-serif",
                            }}>✓ Owned</div>
                          </div>
                        )}
                      </button>

                      {/* Price below card */}
                      <div style={{ textAlign: 'center', width: '100%' }}>
                        {effCoin != null && (
                          <div>
                            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 4 }}>
                              <Coins size={12} color="#fbbf24" />
                              <span style={{ color: '#fbbf24', fontWeight: 800, fontSize: 13, fontFamily: "'Quicksand',sans-serif" }}>
                                {effCoin.toLocaleString()}
                              </span>
                            </div>
                            {coinSaved > 0 && (
                              <div style={{ color: 'rgba(255,255,255,0.3)', fontSize: 10, textDecoration: 'line-through', fontFamily: "'Quicksand',sans-serif" }}>
                                {rawCoin!.toLocaleString()}
                              </div>
                            )}
                          </div>
                        )}
                        {item.shopData?.diamondCost != null && (
                          <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 4 }}>
                            <Gem size={11} color="#67e8f9" />
                            <span style={{ color: '#67e8f9', fontWeight: 800, fontSize: 13, fontFamily: "'Quicksand',sans-serif" }}>
                              {item.shopData.diamondCost.toLocaleString()}
                            </span>
                          </div>
                        )}
                      </div>
                    </div>
                  );
                })}
              </div>

              {/* ── Unlock More Slots ── */}
              {canUnlockMore && (
                <div style={{ marginTop: 8 }}>
                  <p style={{ color: 'rgba(255,255,255,0.3)', fontSize: 11, fontWeight: 600, textAlign: 'center', marginBottom: 10 }}>
                    Unlock more slots to see more cards daily
                  </p>
                  <button
                    onClick={handleUnlockSlot}
                    disabled={!canAffordNext || unlockingSlot}
                    style={{
                      width: '100%', padding: '14px',
                      borderRadius: 14, border: '2px dashed',
                      borderColor: canAffordNext && !unlockingSlot ? 'rgba(118,168,165,0.5)' : 'rgba(255,255,255,0.1)',
                      background: canAffordNext && !unlockingSlot ? 'rgba(118,168,165,0.08)' : 'rgba(255,255,255,0.02)',
                      cursor: canAffordNext && !unlockingSlot ? 'pointer' : 'not-allowed',
                      display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 10,
                      transition: 'all 0.2s',
                    }}
                  >
                    <div style={{
                      width: 32, height: 32,
                      background: canAffordNext ? 'rgba(118,168,165,0.2)' : 'rgba(255,255,255,0.05)',
                      borderRadius: 8, display: 'flex', alignItems: 'center', justifyContent: 'center',
                    }}>
                      {unlockingSlot ? (
                        <div style={{ width:14, height:14, border:'2px solid rgba(255,255,255,0.2)', borderTopColor:'#76A8A5', borderRadius:'50%', animation:'spin 0.8s linear infinite' }} />
                      ) : (
                        <Lock size={14} color={canAffordNext ? '#76A8A5' : '#64748b'} />
                      )}
                    </div>
                    <div style={{ textAlign: 'left' }}>
                      <div style={{ color: canAffordNext ? '#fff' : '#64748b', fontWeight: 800, fontSize: 13, fontFamily: "'Quicksand',sans-serif" }}>
                        Unlock Slot #{nextSlotNum}
                      </div>
                      {nextSlotCost != null && (
                        <div style={{ display: 'flex', alignItems: 'center', gap: 4 }}>
                          <Coins size={11} color={canAffordNext ? '#fbbf24' : '#64748b'} />
                          <span style={{ color: canAffordNext ? '#fbbf24' : '#64748b', fontSize: 12, fontWeight: 800, fontFamily: "'Quicksand',sans-serif" }}>
                            {nextSlotCost.toLocaleString()}
                          </span>
                          {!canAffordNext && (
                            <span style={{ color: '#64748b', fontSize: 10, fontFamily: "'Quicksand',sans-serif" }}>
                              (need {(nextSlotCost - coins).toLocaleString()} more)
                            </span>
                          )}
                        </div>
                      )}
                    </div>
                    <Plus size={16} color={canAffordNext ? '#76A8A5' : '#64748b'} style={{ marginLeft: 'auto' }} />
                  </button>
                  {unlockError && <p style={{ color: '#f87171', fontSize: 11, textAlign: 'center', marginTop: 6, fontFamily: "'Quicksand',sans-serif" }}>{unlockError}</p>}
                </div>
              )}

              {storeSlotCount === STORE_MAX_SLOTS && (
                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 6, padding: '12px 0' }}>
                  <div style={{ height: 1, flex: 1, background: 'rgba(255,255,255,0.06)' }} />
                  <span style={{ color: 'rgba(255,255,255,0.2)', fontSize: 11, fontWeight: 700, fontFamily: "'Quicksand',sans-serif" }}>All slots unlocked</span>
                  <div style={{ height: 1, flex: 1, background: 'rgba(255,255,255,0.06)' }} />
                </div>
              )}
            </div>
          )}
        </div>
      </div>
      <style>{`@keyframes spin { to { transform: rotate(360deg); } }`}</style>
    </>
  );
};
================================================================================
FILE: src/components/chemcity/CollectionsAlbum.tsx
================================================================================

import React, { useCallback, useMemo, useState } from 'react';
import { X, BookOpen, ChevronDown, ChevronRight, Coins, Gem, Award, CheckCircle, Circle } from 'lucide-react';
import { useChemCityStore } from '../../store/chemcityStore';
import type { CollectionDocument } from '../../lib/chemcity/types';

// ─── Progress Ring SVG ────────────────────────────────────────
const ProgressRing: React.FC<{ pct: number; size: number; completed: boolean }> = ({ pct, size, completed }) => {
  const r = (size - 6) / 2;
  const circ = 2 * Math.PI * r;
  const dash = circ * Math.min(pct / 100, 1);
  return (
    <svg width={size} height={size} style={{ transform: 'rotate(-90deg)', flexShrink: 0 }}>
      <circle cx={size/2} cy={size/2} r={r} fill="none" stroke="rgba(255,255,255,0.08)" strokeWidth={4} />
      <circle cx={size/2} cy={size/2} r={r} fill="none"
        stroke={completed ? '#4ade80' : '#76A8A5'}
        strokeWidth={4} strokeLinecap="round"
        strokeDasharray={`${dash} ${circ}`}
        style={{ transition: 'stroke-dasharray 0.6s ease' }}
      />
    </svg>
  );
};

// ─── Rarity pill ──────────────────────────────────────────────
const RARITY_DOT: Record<string, string> = {
  common: '#94a3b8', rare: '#60a5fa', epic: '#a855f7', legendary: '#fbbf24',
};

// ─── Single Collection Card ───────────────────────────────────
interface CollectionCardProps {
  collection: CollectionDocument;
  collected: number;
  total: number;
  completed: boolean;
  rewardClaimed: boolean;
  ownedItemIds: Set<string>;
  onClaim: (id: string) => void;
  isClaiming: boolean;
}

const CollectionCard: React.FC<CollectionCardProps> = ({
  collection, collected, total, completed, rewardClaimed, ownedItemIds, onClaim, isClaiming,
}) => {
  const [expanded, setExpanded] = useState(false);
  const slimItems = useChemCityStore(s => s.slimItems);
  const pct = total > 0 ? Math.round((collected / total) * 100) : 0;

  const itemSlims = useMemo(() =>
    collection.itemIds.map(id => slimItems.find(i => i.id === id)).filter(Boolean) as typeof slimItems,
  [collection.itemIds, slimItems]);

  return (
    <div style={{
      borderRadius: 16,
      border: `1.5px solid ${completed ? 'rgba(74,222,128,0.4)' : 'rgba(197,215,181,0.12)'}`,
      background: completed
        ? 'linear-gradient(135deg, rgba(74,222,128,0.06) 0%, rgba(8,20,19,0.95) 100%)'
        : 'rgba(255,255,255,0.03)',
      overflow: 'hidden',
      transition: 'border-color 0.3s ease',
      fontFamily: "'Quicksand',sans-serif",
    }}>
      {/* Header row */}
      <button
        type="button"
        onClick={() => setExpanded(v => !v)}
        style={{
          width: '100%', padding: '14px 16px', background: 'transparent',
          border: 'none', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: 14, textAlign: 'left',
        }}
      >
        {/* Progress ring */}
        <div style={{ position: 'relative', flexShrink: 0 }}>
          <ProgressRing pct={pct} size={52} completed={completed} />
          <div style={{
            position: 'absolute', inset: 0, display: 'flex', flexDirection: 'column',
            alignItems: 'center', justifyContent: 'center',
          }}>
            {completed ? (
              <CheckCircle size={16} color="#4ade80" />
            ) : (
              <span style={{ color: '#fff', fontSize: 11, fontWeight: 800 }}>{pct}%</span>
            )}
          </div>
        </div>

        {/* Info */}
        <div style={{ flex: 1, minWidth: 0 }}>
          <div style={{ display: 'flex', alignItems: 'center', gap: 8, flexWrap: 'wrap' }}>
            <span style={{ color: '#fff', fontWeight: 800, fontSize: 14 }}>{collection.displayName}</span>
            {completed && <span style={{
              background: 'rgba(74,222,128,0.15)', border: '1px solid rgba(74,222,128,0.4)',
              borderRadius: 20, padding: '1px 8px', fontSize: 9, fontWeight: 800, color: '#4ade80',
              textTransform: 'uppercase', letterSpacing: '0.05em',
            }}>Complete</span>}
          </div>
          <p style={{ color: 'rgba(197,215,181,0.5)', fontSize: 11, margin: '2px 0 0', lineHeight: 1.4 }}>
            {collection.description}
          </p>
          <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginTop: 6 }}>
            <div style={{ flex: 1, height: 3, background: 'rgba(255,255,255,0.08)', borderRadius: 2, overflow: 'hidden' }}>
              <div style={{
                height: '100%', borderRadius: 2,
                background: completed ? '#4ade80' : 'linear-gradient(90deg, #76A8A5, #C5D7B5)',
                width: `${pct}%`, transition: 'width 0.6s ease',
              }} />
            </div>
            <span style={{ color: 'rgba(255,255,255,0.35)', fontSize: 10, fontWeight: 700, flexShrink: 0 }}>
              {collected}/{total}
            </span>
          </div>
        </div>

        {/* Rewards + expand */}
        <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'flex-end', gap: 4, flexShrink: 0 }}>
          {(collection.rewardCoins || collection.rewardDiamonds) && (
            <div style={{ display: 'flex', flexDirection: 'column', gap: 2, alignItems: 'flex-end' }}>
              {collection.rewardCoins && (
                <div style={{ display: 'flex', alignItems: 'center', gap: 4 }}>
                  <Coins size={11} color="#fbbf24" />
                  <span style={{ color: '#fbbf24', fontWeight: 800, fontSize: 11 }}>{collection.rewardCoins.toLocaleString()}</span>
                </div>
              )}
              {collection.rewardDiamonds && (
                <div style={{ display: 'flex', alignItems: 'center', gap: 4 }}>
                  <Gem size={11} color="#67e8f9" />
                  <span style={{ color: '#67e8f9', fontWeight: 800, fontSize: 11 }}>{collection.rewardDiamonds}</span>
                </div>
              )}
            </div>
          )}
          {expanded ? <ChevronDown size={14} color="#64748b" /> : <ChevronRight size={14} color="#64748b" />}
        </div>
      </button>

      {/* Claim button */}
      {completed && !rewardClaimed && (
        <div style={{ padding: '0 16px 12px' }}>
          <button onClick={() => onClaim(collection.id)} disabled={isClaiming} style={{
            width: '100%', padding: '10px',
            background: isClaiming ? 'rgba(74,222,128,0.1)' : 'linear-gradient(135deg, rgba(74,222,128,0.25), rgba(52,211,153,0.15))',
            border: '1.5px solid rgba(74,222,128,0.5)', borderRadius: 10,
            color: '#4ade80', fontWeight: 800, fontSize: 13, cursor: isClaiming ? 'not-allowed' : 'pointer',
            fontFamily: "'Quicksand',sans-serif", display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 8,
            transition: 'all 0.2s',
          }}>
            <Award size={15} />
            {isClaiming ? 'Claiming...' : 'Claim Reward'}
          </button>
        </div>
      )}
      {rewardClaimed && (
        <div style={{ padding: '0 16px 12px' }}>
          <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 6, padding: '8px',
            background: 'rgba(255,255,255,0.04)', border: '1px solid rgba(255,255,255,0.08)', borderRadius: 10 }}>
            <CheckCircle size={13} color="rgba(255,255,255,0.3)" />
            <span style={{ color: 'rgba(255,255,255,0.3)', fontSize: 11, fontWeight: 700, fontFamily: "'Quicksand',sans-serif" }}>Reward claimed</span>
          </div>
        </div>
      )}

      {/* Expanded: card thumbnails */}
      {expanded && (
        <div style={{ borderTop: '1px solid rgba(255,255,255,0.07)', padding: '14px 16px 16px', background: 'rgba(0,0,0,0.2)' }}>
          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, 56px)', gap: 8 }}>
            {itemSlims.map(item => {
              const owned = ownedItemIds.has(item.id);
              return (
                <div key={item.id} style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', gap: 4 }}>
                  <div style={{
                    width: 52, height: 52, borderRadius: 10,
                    border: `2px solid ${owned ? RARITY_DOT[item.rarity] ?? '#94a3b8' : 'rgba(255,255,255,0.1)'}`,
                    background: owned ? 'rgba(255,255,255,0.06)' : 'rgba(0,0,0,0.3)',
                    display: 'flex', alignItems: 'center', justifyContent: 'center',
                    overflow: 'hidden',
                    filter: owned ? 'none' : 'grayscale(1) opacity(0.35)',
                    boxShadow: owned ? `0 0 8px ${RARITY_DOT[item.rarity] ?? '#94a3b8'}44` : 'none',
                    transition: 'all 0.2s',
                  }}>
                    {item.imageUrl ? (
                      <img src={item.imageUrl} alt={item.name} style={{ width: '88%', height: '88%', objectFit: 'contain' }} loading="lazy"
                        onError={e => { (e.target as HTMLImageElement).style.display='none'; }} />
                    ) : (
                      <span style={{ fontSize: 22 }}>{item.emoji}</span>
                    )}
                  </div>
                  <span style={{
                    fontSize: 8, fontWeight: 700, color: owned ? 'rgba(255,255,255,0.6)' : 'rgba(255,255,255,0.2)',
                    textAlign: 'center', lineHeight: 1.2, maxWidth: 52,
                    overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap',
                    fontFamily: "'Quicksand',sans-serif",
                  }}>{item.name}</span>
                </div>
              );
            })}
          </div>
        </div>
      )}
    </div>
  );
};

// ─── Main Component ───────────────────────────────────────────
type FilterState = 'all' | 'complete' | 'incomplete';

export const CollectionsAlbum: React.FC = () => {
  const user       = useChemCityStore(s => s.user);
  const progress   = useChemCityStore(s => s.progress);
  const collections = useChemCityStore(s => s.collections);
  const claimCollectionReward = useChemCityStore(s => s.claimCollectionReward);

  const [claimingId, setClaimingId]   = useState<string | null>(null);
  const [claimError, setClaimError]   = useState<string | null>(null);
  const [filter, setFilter]           = useState<FilterState>('all');

  const ownedItemIds = useMemo(() => new Set(user?.ownedItems ?? []), [user?.ownedItems]);

  const liveProgress = useMemo(() => {
    const map: Record<string, { collected: number; total: number }> = {};
    for (const col of collections) {
      map[col.id] = {
        total: col.itemIds.length,
        collected: col.itemIds.filter((id: string) => ownedItemIds.has(id)).length,
      };
    }
    return map;
  }, [collections, ownedItemIds]);

  const enriched = useMemo(() =>
    collections.map((col: CollectionDocument) => {
      const live = liveProgress[col.id] ?? { collected: 0, total: col.itemIds.length };
      const completed = live.collected === live.total && live.total > 0;
      const rewardClaimed = progress?.collections?.[col.id]?.rewardClaimed ?? false;
      return { collection: col, ...live, completed, rewardClaimed };
    }),
  [collections, liveProgress, progress]);

  const filtered = useMemo(() => {
    if (filter === 'complete') return enriched.filter(e => e.completed);
    if (filter === 'incomplete') return enriched.filter(e => !e.completed);
    return enriched;
  }, [enriched, filter]);

  const totalComplete   = enriched.filter(e => e.completed).length;
  const totalCollections = enriched.length;
  const overallPct      = totalCollections > 0 ? Math.round((totalComplete / totalCollections) * 100) : 0;

  const handleClaim = useCallback(async (collectionId: string) => {
    if (claimingId) return;
    setClaimingId(collectionId);
    setClaimError(null);
    try { await claimCollectionReward(collectionId); }
    catch (err: any) { setClaimError(err?.message ?? 'Failed to claim reward.'); }
    finally { setClaimingId(null); }
  }, [claimingId, claimCollectionReward]);

  return (
    <>
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Pacifico&family=Quicksand:wght@500;600;700;800&display=swap');
        @keyframes albumIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
        .album-content { animation: albumIn 0.25s ease forwards; }
      `}</style>

      <div className="album-content" style={{ display: 'flex', flexDirection: 'column', paddingTop: 76, flex: 1, minHeight: 0, fontFamily: "'Quicksand',sans-serif" }}>

        {/* ── Album Header ── */}
        <div style={{
          padding: '16px 20px 14px',
          borderBottom: '1px solid rgba(197,215,181,0.1)',
          background: 'linear-gradient(135deg, rgba(118,168,165,0.1) 0%, transparent 80%)',
          flexShrink: 0,
        }}>
          <div style={{ display: 'flex', alignItems: 'center', gap: 12, marginBottom: 14 }}>
            <div style={{
              background: 'linear-gradient(135deg,rgba(118,168,165,0.3),rgba(118,168,165,0.1))',
              border: '1.5px solid rgba(118,168,165,0.5)',
              borderRadius: 12, width: 46, height: 46,
              display: 'flex', alignItems: 'center', justifyContent: 'center',
            }}>
              <BookOpen size={22} color="#76A8A5" />
            </div>
            <div>
              <div style={{ color: '#fff', fontWeight: 800, fontSize: 18 }}>Collections Album</div>
              <div style={{ color: 'rgba(197,215,181,0.5)', fontSize: 12, fontWeight: 600 }}>
                {totalComplete}/{totalCollections} complete · {overallPct}%
              </div>
            </div>
          </div>

          {/* Overall progress bar */}
          <div style={{ display: 'flex', alignItems: 'center', gap: 10, marginBottom: 12 }}>
            <div style={{ flex: 1, height: 6, background: 'rgba(255,255,255,0.08)', borderRadius: 3, overflow: 'hidden' }}>
              <div style={{
                height: '100%', borderRadius: 3,
                background: overallPct === 100 ? '#4ade80' : 'linear-gradient(90deg, #76A8A5, #C5D7B5)',
                width: `${overallPct}%`, transition: 'width 0.8s ease',
              }} />
            </div>
            {overallPct === 100 && <CheckCircle size={16} color="#4ade80" />}
          </div>

          {/* Filter tabs */}
          <div style={{ display: 'flex', gap: 6 }}>
            {(['all', 'complete', 'incomplete'] as FilterState[]).map(f => (
              <button key={f} onClick={() => setFilter(f)} style={{
                padding: '6px 14px', borderRadius: 20,
                border: `1.5px solid ${filter === f ? 'rgba(118,168,165,0.5)' : 'rgba(255,255,255,0.1)'}`,
                background: filter === f ? 'rgba(118,168,165,0.18)' : 'transparent',
                color: filter === f ? '#C5D7B5' : 'rgba(255,255,255,0.4)',
                fontWeight: 800, fontSize: 11, cursor: 'pointer', fontFamily: "'Quicksand',sans-serif",
                textTransform: 'capitalize', transition: 'all 0.2s',
              }}>{f}</button>
            ))}
          </div>
        </div>

        {/* ── Collection List ── */}
        <div style={{ flex: 1, overflowY: 'auto', padding: '14px 16px 24px', display: 'flex', flexDirection: 'column', gap: 10 }}>
          {claimError && (
            <div style={{ background: 'rgba(239,68,68,0.1)', border: '1px solid rgba(239,68,68,0.3)', borderRadius: 10, padding: '10px 14px' }}>
              <p style={{ color: '#f87171', fontSize: 12, margin: 0, fontFamily: "'Quicksand',sans-serif" }}>{claimError}</p>
            </div>
          )}
          {filtered.length === 0 ? (
            <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', flex: 1, gap: 12 }}>
              <BookOpen size={44} color="rgba(255,255,255,0.1)" />
              <p style={{ color: 'rgba(255,255,255,0.3)', fontSize: 13, fontWeight: 600, margin: 0 }}>No collections found</p>
            </div>
          ) : (
            filtered.map(entry => (
              <CollectionCard
                key={entry.collection.id}
                collection={entry.collection}
                collected={entry.collected}
                total={entry.total}
                completed={entry.completed}
                rewardClaimed={entry.rewardClaimed}
                ownedItemIds={ownedItemIds}
                onClaim={handleClaim}
                isClaiming={claimingId === entry.collection.id}
              />
            ))
          )}
        </div>
      </div>
    </>
  );
};
================================================================================
FILE: src/components/chemcity/CurrencyBar.tsx
================================================================================

import React, { useMemo, useState } from 'react';
import { Coins, Gem, ChevronLeft, Sparkles, BookOpen, ShoppingBag, Archive, Fuel, X, Zap } from 'lucide-react';
import { useChemCityStore } from '../../store/chemcityStore';

export const CurrencyBar: React.FC = () => {
  const user               = useChemCityStore(s => s.user);
  const places             = useChemCityStore(s => s.places);
  const view               = useChemCityStore(s => s.view);
  const selectedPlaceId    = useChemCityStore(s => s.selectedPlaceId);
  const navigateToMap      = useChemCityStore(s => s.navigateToMap);
  const navigateToInventory = useChemCityStore(s => s.navigateToInventory);
  const navigateToStore    = useChemCityStore(s => s.navigateToStore);
  const navigateToCollections = useChemCityStore(s => s.navigateToCollections);
  const navigateToGasStationDistributor = useChemCityStore(s => s.navigateToGasStationDistributor);

  const [skillsOpen, setSkillsOpen] = useState(false);

  const coins    = user?.currencies.coins ?? 0;
  const diamonds = user?.currencies.diamonds ?? 0;

  const showGasDistributorButton = view === 'place' && selectedPlaceId === 'gas_station' && (user?.extraSlotsBudget ?? 0) > 0;

  const skillSummaryByPlaceId = useMemo(() => {
    const b = user?.activeBonuses;
    if (!b) return {} as Record<string, string>;
    return {
      garden:             `${b.passiveBaseCoinsPerHour.toLocaleString()} coins/hr`,
      lab:                `${b.passiveMultiplier.toFixed(1)}× multiplier`,
      kitchen:            `+${b.quizFlatDiamondBonus} diamond bonus`,
      school:             `${b.quizDiamondMultiplier.toFixed(1)}× quiz diamonds`,
      beach:              `${b.quizDoubleChancePercent}% double chance`,
      toilet:             `${b.dailyLoginDiamonds} daily diamonds`,
      gas_station:        `${b.extraSlotsTotal} bonus slots`,
      lifestyle_boutique: `${b.shopDiscountPercent}% store discount`,
    };
  }, [user?.activeBonuses]);

  const NavBtn: React.FC<{
    onClick: () => void; active: boolean; label: string; children: React.ReactNode; accent?: boolean;
  }> = ({ onClick, active, label, children, accent }) => (
    <button onClick={onClick} title={label} aria-label={label} style={{
      width: 36, height: 36, borderRadius: 10,
      border: `1.5px solid ${active ? 'rgba(118,168,165,0.6)' : accent ? 'rgba(251,191,36,0.4)' : 'rgba(255,255,255,0.12)'}`,
      background: active
        ? 'rgba(118,168,165,0.25)'
        : accent ? 'rgba(251,191,36,0.12)' : 'rgba(8,20,19,0.9)',
      backdropFilter: 'blur(12px)', WebkitBackdropFilter: 'blur(12px)',
      color: active ? '#C5D7B5' : accent ? '#fbbf24' : '#94a3b8',
      cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center',
      transition: 'all 0.2s ease',
      boxShadow: '0 2px 8px rgba(0,0,0,0.4)',
    }}>
      {children}
    </button>
  );

  return (
    <>
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@500;600;700;800&display=swap');
        .skills-row:hover { background: rgba(255,255,255,0.06) !important; }
      `}</style>

      <div style={{
        position: 'fixed', top: 84, left: 12, right: 12, zIndex: 50,
        display: 'flex', alignItems: 'center', justifyContent: 'space-between', gap: 8,
        pointerEvents: 'none',
        fontFamily: "'Quicksand',sans-serif",
      }}>
        {/* Left: Back button */}
        <div style={{ pointerEvents: 'auto' }}>
          {view !== 'map' && (
            <button onClick={navigateToMap} title="Back to map" aria-label="Back to map" style={{
              width: 36, height: 36, borderRadius: 10,
              border: '1.5px solid rgba(255,255,255,0.12)',
              background: 'rgba(8,20,19,0.9)',
              backdropFilter: 'blur(12px)', WebkitBackdropFilter: 'blur(12px)',
              color: '#94a3b8', cursor: 'pointer',
              display: 'flex', alignItems: 'center', justifyContent: 'center',
              boxShadow: '0 2px 8px rgba(0,0,0,0.4)',
              transition: 'all 0.2s',
            }}>
              <ChevronLeft size={18} />
            </button>
          )}
        </div>

        {/* Right: Currency pills + nav buttons */}
        <div style={{ display: 'flex', alignItems: 'center', gap: 7, pointerEvents: 'auto' }}>
          {/* Coins pill */}
          <div style={{
            display: 'flex', alignItems: 'center', gap: 6,
            background: 'rgba(8,20,19,0.9)',
            border: '1.5px solid rgba(251,191,36,0.25)',
            backdropFilter: 'blur(12px)', WebkitBackdropFilter: 'blur(12px)',
            borderRadius: 20, padding: '5px 10px',
            boxShadow: '0 2px 8px rgba(0,0,0,0.4)',
          }}>
            <Coins size={13} color="#fbbf24" />
            <span style={{ color: '#fff', fontSize: 13, fontWeight: 800, fontVariantNumeric: 'tabular-nums' }}>
              {coins.toLocaleString()}
            </span>
          </div>

          {/* Diamonds pill */}
          <div style={{
            display: 'flex', alignItems: 'center', gap: 6,
            background: 'rgba(8,20,19,0.9)',
            border: '1.5px solid rgba(103,232,249,0.25)',
            backdropFilter: 'blur(12px)', WebkitBackdropFilter: 'blur(12px)',
            borderRadius: 20, padding: '5px 10px',
            boxShadow: '0 2px 8px rgba(0,0,0,0.4)',
          }}>
            <Gem size={12} color="#67e8f9" />
            <span style={{ color: '#fff', fontSize: 13, fontWeight: 800, fontVariantNumeric: 'tabular-nums' }}>
              {diamonds.toLocaleString()}
            </span>
          </div>

          <NavBtn onClick={() => setSkillsOpen(true)} active={false} label="Skill Boosts">
            <Sparkles size={15} />
          </NavBtn>
          <NavBtn onClick={navigateToCollections} active={view === 'collections'} label="Collections Album">
            <BookOpen size={15} />
          </NavBtn>
          <NavBtn onClick={navigateToStore} active={view === 'store'} label="ChemStore">
            <ShoppingBag size={15} />
          </NavBtn>
          <NavBtn onClick={navigateToInventory} active={view === 'inventory'} label="Card Inventory">
            <Archive size={15} />
          </NavBtn>
          {showGasDistributorButton && (
            <NavBtn onClick={navigateToGasStationDistributor} active={false} label="Distribute Bonus Slots" accent>
              <Fuel size={15} />
            </NavBtn>
          )}
        </div>
      </div>

      {/* ── Skills Modal ── */}
      {skillsOpen && (
        <div
          onClick={() => setSkillsOpen(false)}
          style={{
            position: 'fixed', inset: 0, zIndex: 60,
            background: 'rgba(4,10,9,0.88)',
            backdropFilter: 'blur(14px)', WebkitBackdropFilter: 'blur(14px)',
            display: 'flex', alignItems: 'center', justifyContent: 'center', padding: 16,
          }}
        >
          <div onClick={e => e.stopPropagation()} style={{
            width: 'min(420px, 94vw)',
            background: 'rgba(8,20,19,0.97)',
            border: '1.5px solid rgba(197,215,181,0.18)',
            borderRadius: 20,
            boxShadow: '0 32px 80px rgba(0,0,0,0.7)',
            overflow: 'hidden',
            fontFamily: "'Quicksand',sans-serif",
          }}>
            {/* Header */}
            <div style={{
              padding: '16px 18px', borderBottom: '1px solid rgba(197,215,181,0.1)',
              display: 'flex', alignItems: 'center', justifyContent: 'space-between',
              background: 'linear-gradient(135deg, rgba(118,168,165,0.12) 0%, transparent)',
            }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
                <div style={{ background:'rgba(118,168,165,0.2)', border:'1.5px solid rgba(118,168,165,0.4)', borderRadius:10, width:36, height:36, display:'flex', alignItems:'center', justifyContent:'center' }}>
                  <Sparkles size={16} color="#76A8A5" />
                </div>
                <div>
                  <div style={{ color: '#fff', fontWeight: 800, fontSize: 15 }}>Skill Boosts</div>
                  <div style={{ color: 'rgba(197,215,181,0.5)', fontSize: 11, fontWeight: 600 }}>Active card bonuses</div>
                </div>
              </div>
              <button onClick={() => setSkillsOpen(false)} style={{
                background: 'rgba(255,255,255,0.07)', border: '1.5px solid rgba(255,255,255,0.12)',
                borderRadius: 8, width: 30, height: 30, cursor: 'pointer',
                display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#94a3b8',
              }}><X size={14} /></button>
            </div>

            {/* Skills list */}
            <div style={{ padding: '12px', display: 'flex', flexDirection: 'column', gap: 6, maxHeight: '65vh', overflowY: 'auto' }}>
              {places.map(p => (
                <div key={p.id} className="skills-row" style={{
                  display: 'flex', alignItems: 'center', justifyContent: 'space-between', gap: 12,
                  background: 'rgba(255,255,255,0.03)', border: '1px solid rgba(255,255,255,0.07)',
                  borderRadius: 12, padding: '10px 14px',
                  transition: 'background 0.2s',
                }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: 10, minWidth: 0 }}>
                    <div style={{ fontSize: 20, flexShrink: 0 }}>{p.emoji}</div>
                    <div style={{ minWidth: 0 }}>
                      <div style={{ color: '#fff', fontWeight: 800, fontSize: 12 }}>{p.displayName}</div>
                      <div style={{ color: 'rgba(197,215,181,0.4)', fontSize: 10, fontWeight: 600, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
                        {p.skill.description}
                      </div>
                    </div>
                  </div>
                  <div style={{ display: 'flex', alignItems: 'center', gap: 5, flexShrink: 0 }}>
                    <Zap size={10} color="#76A8A5" />
                    <span style={{ color: '#76A8A5', fontWeight: 800, fontSize: 12 }}>
                      {skillSummaryByPlaceId[p.id] ?? '—'}
                    </span>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      )}
    </>
  );
};
================================================================================
FILE: src/components/chemcity/DailyLoginModal.tsx
================================================================================

// ── DailyLoginModal.tsx ─────────────────────────────────────────
import React, { useMemo } from 'react';
import { X, Coins, Gem, Flame, Trophy, LogIn } from 'lucide-react';
import { useChemCityStore } from '../../store/chemcityStore';

function milestoneMessage(streak: number): { text: string; icon: React.ReactNode } {
  if (streak === 1) return { text: 'Welcome back!', icon: <LogIn size={16} color="#76A8A5" /> };
  if (streak === 7) return { text: '7-day streak!', icon: <Flame size={16} color="#fb923c" /> };
  if (streak === 30) return { text: '30-day legend!', icon: <Trophy size={16} color="#fbbf24" /> };
  if (streak % 10 === 0) return { text: `${streak} days strong!`, icon: <Trophy size={16} color="#fbbf24" /> };
  return { text: `${streak}-day streak!`, icon: <Flame size={16} color="#fb923c" /> };
}

export const DailyLoginModal: React.FC = () => {
  const dailyLogin     = useChemCityStore(s => s.dailyLogin);
  const dismissDailyLogin = useChemCityStore(s => s.dismissDailyLogin);

  const { text: msg, icon } = useMemo(() => milestoneMessage(dailyLogin.streak || 0), [dailyLogin.streak]);
  if (!dailyLogin.showModal) return null;

  return (
    <>
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Pacifico&family=Quicksand:wght@600;700;800&display=swap');
        @keyframes loginIn{from{opacity:0;transform:scale(0.9) translateY(20px)}to{opacity:1;transform:scale(1) translateY(0)}}
        @keyframes coinPop{0%{transform:scale(0);opacity:0}60%{transform:scale(1.15)}100%{transform:scale(1);opacity:1}}
      `}</style>
      <div onClick={dismissDailyLogin} style={{
        position:'fixed', inset:0, zIndex:70,
        background:'rgba(4,10,9,0.88)', backdropFilter:'blur(14px)', WebkitBackdropFilter:'blur(14px)',
        display:'flex', alignItems:'center', justifyContent:'center', padding:16,
      }}>
        <div onClick={e => e.stopPropagation()} style={{
          width:'min(340px,92vw)',
          background:'rgba(8,20,19,0.97)',
          border:'1.5px solid rgba(197,215,181,0.18)',
          borderRadius:22,
          boxShadow:'0 32px 80px rgba(0,0,0,0.7)',
          overflow:'hidden',
          fontFamily:"'Quicksand',sans-serif",
          animation:'loginIn 0.3s cubic-bezier(0.34,1.56,0.64,1) forwards',
        }}>
          {/* Header */}
          <div style={{
            padding:'20px 20px 16px',
            borderBottom:'1px solid rgba(197,215,181,0.1)',
            background:'linear-gradient(135deg,rgba(118,168,165,0.15) 0%,transparent)',
            display:'flex', alignItems:'center', justifyContent:'space-between',
          }}>
            <div style={{ display:'flex', alignItems:'center', gap:10 }}>
              <div style={{ background:'rgba(118,168,165,0.2)', border:'1.5px solid rgba(118,168,165,0.4)', borderRadius:12, width:42, height:42, display:'flex', alignItems:'center', justifyContent:'center' }}>
                {icon}
              </div>
              <div>
                <div style={{ color:'#fff', fontWeight:800, fontSize:16 }}>Daily Login Bonus</div>
                <div style={{ color:'rgba(197,215,181,0.6)', fontSize:12, fontWeight:600 }}>{msg}</div>
              </div>
            </div>
            <button onClick={dismissDailyLogin} style={{ background:'rgba(255,255,255,0.07)', border:'1.5px solid rgba(255,255,255,0.12)', borderRadius:8, width:30, height:30, cursor:'pointer', display:'flex', alignItems:'center', justifyContent:'center', color:'#94a3b8' }}>
              <X size={14} />
            </button>
          </div>

          {/* Rewards */}
          <div style={{ padding:'20px', display:'flex', flexDirection:'column', gap:12 }}>
            <div style={{ display:'grid', gridTemplateColumns:'1fr 1fr', gap:10 }}>
              <div style={{ background:'rgba(251,191,36,0.06)', border:'1.5px solid rgba(251,191,36,0.25)', borderRadius:14, padding:'14px', textAlign:'center', animation:'coinPop 0.5s 0.1s ease both' }}>
                <Coins size={24} color="#fbbf24" style={{ margin:'0 auto 6px' }} />
                <div style={{ color:'rgba(255,255,255,0.5)', fontSize:10, fontWeight:700, textTransform:'uppercase', letterSpacing:'0.06em', marginBottom:4 }}>Coins</div>
                <div style={{ color:'#fbbf24', fontWeight:800, fontSize:20, fontVariantNumeric:'tabular-nums' }}>
                  +{Number(dailyLogin.coins || 0).toLocaleString()}
                </div>
              </div>
              <div style={{ background:'rgba(103,232,249,0.06)', border:'1.5px solid rgba(103,232,249,0.25)', borderRadius:14, padding:'14px', textAlign:'center', animation:'coinPop 0.5s 0.2s ease both' }}>
                <Gem size={24} color="#67e8f9" style={{ margin:'0 auto 6px' }} />
                <div style={{ color:'rgba(255,255,255,0.5)', fontSize:10, fontWeight:700, textTransform:'uppercase', letterSpacing:'0.06em', marginBottom:4 }}>Diamonds</div>
                <div style={{ color:'#67e8f9', fontWeight:800, fontSize:20, fontVariantNumeric:'tabular-nums' }}>
                  +{Number(dailyLogin.diamonds || 0).toLocaleString()}
                </div>
              </div>
            </div>

            <div style={{ background:'rgba(118,168,165,0.08)', border:'1px solid rgba(118,168,165,0.2)', borderRadius:10, padding:'9px 12px' }}>
              <p style={{ color:'rgba(197,215,181,0.65)', fontSize:11, fontWeight:600, margin:0 }}>
                Tip: Equip cards in the <strong style={{ color:'#C5D7B5' }}>Toilet</strong> to boost your daily diamond reward.
              </p>
            </div>

            <button onClick={dismissDailyLogin} style={{
              width:'100%', padding:'12px', borderRadius:12, border:'none',
              background:'linear-gradient(135deg, #76A8A5, #5d9190)',
              color:'#fff', fontWeight:800, fontSize:14, cursor:'pointer',
              fontFamily:"'Quicksand',sans-serif",
              boxShadow:'0 4px 20px rgba(118,168,165,0.4)',
            }}>
              Collect
            </button>
          </div>
        </div>
      </div>
    </>
  );
};
================================================================================
FILE: src/components/chemcity/GasStationDistributor.tsx
================================================================================

import React, { useMemo, useState } from 'react';
import { useChemCityStore } from '../../store/chemcityStore';

export const GasStationDistributor: React.FC = () => {
  const user = useChemCityStore((s) => s.user);
  const places = useChemCityStore((s) => s.places);
  const unlockSlot = useChemCityStore((s) => s.unlockSlot);

  const [unlockingSlotId, setUnlockingSlotId] = useState<string | null>(null);
  const [recentlyUnlocked, setRecentlyUnlocked] = useState<Set<string>>(new Set());
  const [error, setError] = useState<string | null>(null);

  const budget = user?.extraSlotsBudget ?? 0;

  const gasStationSlots = useMemo(() => {
    if (!user) return [] as Array<{ placeId: string; placeEmoji: string; placeDisplayName: string; slotId: string; slotLabel: string }>;

    const result: Array<{ placeId: string; placeEmoji: string; placeDisplayName: string; slotId: string; slotLabel: string }> = [];

    for (const place of places) {
      if (place.unlockCost > 0 && !user.unlockedPlaces.includes(place.id)) continue;

      for (const slot of place.slots) {
        if (!slot.budgetOnly) continue;
        if (user.unlockedSlots.includes(slot.slotId)) continue;
        if (recentlyUnlocked.has(slot.slotId)) continue;

        result.push({
          placeId: place.id,
          placeEmoji: place.emoji,
          placeDisplayName: place.displayName,
          slotId: slot.slotId,
          slotLabel: slot.slotId.replace(/_/g, ' '),
        });
      }
    }

    return result;
  }, [user, places, recentlyUnlocked]);

  const grouped = useMemo(() => {
    const map = new Map<string, typeof gasStationSlots>();
    for (const s of gasStationSlots) {
      if (!map.has(s.placeId)) map.set(s.placeId, []);
      map.get(s.placeId)!.push(s);
    }
    return Array.from(map.entries()).map(([placeId, slots]) => ({ placeId, slots }));
  }, [gasStationSlots]);

  const handleUnlock = async (placeId: string, slotId: string) => {
    if (unlockingSlotId || budget < 1) return;
    setUnlockingSlotId(slotId);
    setError(null);
    try {
      await unlockSlot(placeId, slotId, true);
      setRecentlyUnlocked((prev) => new Set([...prev, slotId]));
    } catch (err: any) {
      setError(err?.message ?? 'Failed to unlock slot.');
    } finally {
      setUnlockingSlotId(null);
    }
  };

  return (
    <div className="flex flex-col" style={{ paddingTop: 76 }}>
      <div className="px-4 pt-3 pb-3 border-b border-slate-800">
        <div className="flex items-center gap-2 mb-1">
          <span className="text-2xl">⛽</span>
          <h2 className="text-white font-bold text-lg">Gas Station</h2>
        </div>
        <p className="text-slate-400 text-xs mb-3">Use your bonus slot budget to unlock extra card slots across any place.</p>

        <div className="bg-slate-800 border border-slate-700 rounded-xl p-3 flex items-center justify-between">
          <div>
            <p className="text-slate-400 text-xs">Extra Slot Budget</p>
            <p className="text-white font-black text-2xl tabular-nums">{budget}</p>
          </div>
          <div className="text-right">
            <p className="text-slate-400 text-xs">Total unlockable</p>
            <p className="text-slate-300 font-bold text-lg">{gasStationSlots.length}</p>
          </div>
        </div>
      </div>

      <div className="overflow-y-auto flex-1 px-4 py-3 pb-8">
        {budget === 0 && gasStationSlots.length > 0 && (
          <div className="bg-amber-900/30 border border-amber-700 rounded-xl p-3 mb-4">
            <p className="text-amber-200 text-sm">
              💡 Equip more cards in the <span className="font-bold">⛽ Gas Station</span> to increase your budget.
            </p>
          </div>
        )}

        {gasStationSlots.length === 0 ? (
          <div className="flex flex-col items-center justify-center py-16 text-slate-500">
            <span className="text-5xl mb-3">⛽</span>
            {user?.extraSlotsBudget === 0 ? (
              <>
                <p className="text-sm text-center">No bonus slots available yet.</p>
                <p className="text-xs text-center mt-1">Equip cards in the Gas Station to earn slot budget.</p>
              </>
            ) : (
              <>
                <p className="text-sm text-center">All extra slots are unlocked!</p>
                <p className="text-xs text-center mt-1">Check back after unlocking more places.</p>
              </>
            )}
          </div>
        ) : (
          <div className="flex flex-col gap-4">
            {error && (
              <div className="bg-red-900/30 border border-red-700 rounded-xl p-3">
                <p className="text-red-300 text-sm">{error}</p>
              </div>
            )}

            {grouped.map(({ placeId, slots }) => {
              const place = places.find((p) => p.id === placeId);
              return (
                <div key={placeId}>
                  <div className="flex items-center gap-2 mb-2">
                    <span className="text-xl">{place?.emoji}</span>
                    <span className="text-slate-300 font-semibold text-sm">{place?.displayName}</span>
                    <span className="text-slate-500 text-xs ml-auto">{slots.length} available</span>
                  </div>

                  <div className="grid grid-cols-2 gap-2">
                    {slots.map(({ slotId, slotLabel }) => {
                      const isUnlocking = unlockingSlotId === slotId;
                      const canAfford = budget >= 1;

                      return (
                        <button
                          key={slotId}
                          onClick={() => handleUnlock(placeId, slotId)}
                          disabled={!canAfford || !!unlockingSlotId}
                          className={`flex items-center justify-between gap-2 rounded-xl border px-3 py-2.5 text-left transition-all active:scale-95 ${
                            canAfford && !unlockingSlotId
                              ? 'bg-slate-800 border-slate-600 hover:border-indigo-500 hover:bg-slate-700 cursor-pointer'
                              : 'bg-slate-900/60 border-slate-800 cursor-not-allowed opacity-60'
                          }`}
                        >
                          <div className="min-w-0">
                            <p className="text-white text-xs font-semibold capitalize leading-tight truncate">{slotLabel}</p>
                            <p className="text-slate-500 text-[10px] font-mono truncate">{slotId}</p>
                          </div>
                          <span
                            className={`shrink-0 text-xs font-bold rounded-lg px-2 py-1 ${
                              canAfford && !unlockingSlotId ? 'bg-indigo-600 text-white' : 'bg-slate-700 text-slate-400'
                            }`}
                          >
                            {isUnlocking ? '⏳' : '-1'}
                          </span>
                        </button>
                      );
                    })}
                  </div>
                </div>
              );
            })}
          </div>
        )}
      </div>
    </div>
  );
};

================================================================================
FILE: src/components/chemcity/OnboardingOverlay.tsx
================================================================================

import React, { useState } from 'react';
import { useChemCityStore } from '../../store/chemcityStore';

const STEPS = [
  {
    emoji: '🧪',
    title: 'Welcome to ChemCity!',
    subtitle: 'Your chemistry-powered city awaits.',
    body: (
      <div className="flex flex-col gap-3 text-slate-300 text-sm leading-relaxed">
        <p>
          ChemCity is a collectible card game built around real chemistry. Collect chemical compound
          cards, equip them to 8 city locations, and watch your city generate rewards.
        </p>
        <div className="grid grid-cols-2 gap-2">
          {[
            { emoji: '🃏', label: 'Collect cards' },
            { emoji: '🏙️', label: 'Build your city' },
            { emoji: '💰', label: 'Earn coins' },
            { emoji: '💎', label: 'Win diamonds' },
          ].map(({ emoji, label }) => (
            <div key={label} className="flex items-center gap-2 bg-slate-800/60 rounded-xl px-3 py-2">
              <span className="text-xl">{emoji}</span>
              <span className="text-white text-xs font-semibold">{label}</span>
            </div>
          ))}
        </div>
      </div>
    ),
  },
  {
    emoji: '💰',
    title: 'Earn Coins & Diamonds',
    subtitle: 'Two ways to build your wealth.',
    body: (
      <div className="flex flex-col gap-3 text-sm">
        <div className="bg-yellow-900/30 border border-yellow-700/60 rounded-xl p-3">
          <div className="flex items-center gap-2 mb-1">
            <span className="text-xl">🪙</span>
            <span className="text-yellow-300 font-bold">Coins — Passive Income</span>
          </div>
          <p className="text-slate-300 text-xs leading-relaxed">
            Equip cards in the 🌱 <strong>Garden</strong> to generate coins per hour. The ⚗️{' '}
            <strong>Lab</strong> multiplies your rate. Collect any time from the map.
          </p>
        </div>
        <div className="bg-cyan-900/30 border border-cyan-700/60 rounded-xl p-3">
          <div className="flex items-center gap-2 mb-1">
            <span className="text-xl">💎</span>
            <span className="text-cyan-300 font-bold">Diamonds — Quiz Rewards</span>
          </div>
          <p className="text-slate-300 text-xs leading-relaxed">
            Complete quizzes to earn diamonds. 🍳 <strong>Kitchen</strong>, 📚 <strong>School</strong>,
            and 🏖️ <strong>Beach</strong> cards supercharge your quiz rewards.
          </p>
        </div>
        <div className="bg-indigo-900/30 border border-indigo-700/60 rounded-xl p-3">
          <div className="flex items-center gap-2 mb-1">
            <span className="text-xl">🚽</span>
            <span className="text-slate-200 font-bold">Daily Login Bonus</span>
          </div>
          <p className="text-slate-300 text-xs leading-relaxed">
            Open ChemCity every day to claim a streak bonus. Toilet cards boost your daily diamond
            reward.
          </p>
        </div>
      </div>
    ),
  },
  {
    emoji: '🏪',
    title: 'Collect Cards in ChemStore',
    subtitle: 'A new selection every day.',
    body: (
      <div className="flex flex-col gap-3 text-sm">
        <p className="text-slate-300 leading-relaxed">
          The <strong className="text-white">🏪 ChemStore</strong> rotates 3–6 cards daily. Spend
          coins or diamonds to add them to your collection.
        </p>
        <div className="flex flex-col gap-2">
          {[
            {
              pill: 'Common',
              pillClass: 'bg-slate-600 text-white',
              desc: 'Affordable and plentiful — great for filling slots.',
            },
            { pill: 'Rare', pillClass: 'bg-blue-600 text-white', desc: 'Stronger skill contributions.' },
            { pill: 'Epic', pillClass: 'bg-purple-600 text-white', desc: 'Significant boosts to place skills.' },
            {
              pill: 'Legendary',
              pillClass: 'bg-yellow-400 text-slate-900',
              desc: 'Massive power — rare to appear in the store.',
            },
          ].map(({ pill, pillClass, desc }) => (
            <div key={pill} className="flex items-center gap-3 bg-slate-800/60 rounded-xl px-3 py-2.5">
              <span className={`text-[10px] font-bold rounded-full px-2 py-0.5 shrink-0 ${pillClass}`}>
                {pill}
              </span>
              <span className="text-slate-300 text-xs">{desc}</span>
            </div>
          ))}
        </div>
        <div className="bg-emerald-900/30 border border-emerald-700/60 rounded-xl p-3">
          <p className="text-slate-300 text-xs leading-relaxed">
            💡 <strong className="text-white">Tip:</strong> Equip cards from the 🛍️{' '}
            <strong>Boutique</strong> to get a discount in the ChemStore — up to 50% off coin prices!
          </p>
        </div>
      </div>
    ),
  },
] as const;

export const OnboardingOverlay: React.FC = () => {
  const dismissOnboarding = useChemCityStore((s) => s.dismissOnboarding);
  const [step, setStep] = useState(0);

  const isLast = step === STEPS.length - 1;
  const { emoji, title, subtitle, body } = STEPS[step];

  const handleNext = () => {
    if (isLast) dismissOnboarding();
    else setStep((s) => s + 1);
  };

  const handleBack = () => {
    if (step > 0) setStep((s) => s - 1);
  };

  const handleSkip = () => {
    dismissOnboarding();
  };

  return (
    <>
      <div className="fixed inset-0 bg-slate-950/85 backdrop-blur-sm z-[100]" />

      <div className="fixed inset-x-4 top-16 bottom-4 z-[110] flex flex-col">
        <div className="bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl flex flex-col overflow-hidden h-full">
          <div className="flex items-center justify-center gap-2 pt-4">
            {STEPS.map((_, i) => (
              <div
                key={i}
                className={`rounded-full transition-all duration-300 ${
                  i === step
                    ? 'w-5 h-2 bg-indigo-400'
                    : i < step
                      ? 'w-2 h-2 bg-indigo-600'
                      : 'w-2 h-2 bg-slate-700'
                }`}
              />
            ))}
          </div>

          <div className="flex-1 overflow-y-auto px-5 py-4">
            <div className="flex flex-col items-center text-center mb-5">
              <div className="w-16 h-16 rounded-2xl bg-slate-800 border border-slate-700 flex items-center justify-center text-4xl mb-3 shadow-lg">
                {emoji}
              </div>
              <h2 className="text-white font-bold text-xl leading-tight">{title}</h2>
              <p className="text-slate-400 text-sm mt-1">{subtitle}</p>
            </div>

            {body}
          </div>

          <div className="shrink-0 border-t border-slate-700 px-5 py-4 flex items-center gap-3">
            {step > 0 ? (
              <button
                onClick={handleBack}
                className="w-10 h-10 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-600 text-slate-300 flex items-center justify-center transition-colors"
              >
                ←
              </button>
            ) : (
              <button
                onClick={handleSkip}
                className="text-slate-500 text-sm hover:text-slate-300 transition-colors px-2"
              >
                Skip
              </button>
            )}

            <button
              onClick={handleNext}
              className="flex-1 py-2.5 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-white font-bold text-sm transition-all active:scale-95"
            >
              {isLast ? "Let's go! 🚀" : 'Next →'}
            </button>
          </div>
        </div>
      </div>
    </>
  );
};

================================================================================
FILE: src/components/chemcity/PassiveIncomeCollector.tsx
================================================================================

// ── PassiveIncomeCollector.tsx ──────────────────────────────────
import React, { useEffect, useRef, useState } from 'react';
import { Coins, TrendingUp, Download } from 'lucide-react';
import { useChemCityStore } from '../../store/chemcityStore';
import { formatCoinsPerHour } from '../../lib/chemcity/income';

export const PassiveIncomeCollector: React.FC = () => {
  const user                = useChemCityStore(s => s.user);
  const passiveDisplayCoins = useChemCityStore(s => s.passiveDisplayCoins);
  const collectIncome       = useChemCityStore(s => s.collectIncome);
  const tickPassiveDisplay  = useChemCityStore(s => s.tickPassiveDisplay);

  const [collecting, setCollecting]       = useState(false);
  const [lastCollected, setLastCollected] = useState<number | null>(null);
  const intervalRef = useRef<ReturnType<typeof setInterval> | null>(null);

  const rate = user?.activeBonuses.passiveBaseCoinsPerHour ?? 0;

  useEffect(() => {
    if (rate > 0) {
      tickPassiveDisplay();
      intervalRef.current = setInterval(tickPassiveDisplay, 1000);
    }
    return () => { if (intervalRef.current) clearInterval(intervalRef.current); };
  }, [rate, tickPassiveDisplay]);

  const handleCollect = async () => {
    if (collecting) return;
    setCollecting(true);
    try {
      const { coinsAwarded } = await collectIncome();
      setLastCollected(coinsAwarded);
      setTimeout(() => setLastCollected(null), 3000);
    } finally {
      setCollecting(false);
    }
  };

  if (rate === 0) return null;

  return (
    <>
      <style>{`@import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@700;800&display=swap');`}</style>
      <div style={{
        margin: '10px 12px 4px',
        background: 'rgba(8,20,19,0.9)',
        backdropFilter: 'blur(12px)', WebkitBackdropFilter: 'blur(12px)',
        border: '1.5px solid rgba(251,191,36,0.2)',
        borderRadius: 14, padding: '10px 14px',
        display: 'flex', alignItems: 'center', justifyContent: 'space-between', gap: 12,
        boxShadow: '0 4px 16px rgba(0,0,0,0.4)',
        fontFamily: "'Quicksand',sans-serif",
      }}>
        <div style={{ display: 'flex', alignItems: 'center', gap: 10, minWidth: 0 }}>
          <div style={{ background:'rgba(251,191,36,0.12)', border:'1px solid rgba(251,191,36,0.2)', borderRadius:8, width:32, height:32, display:'flex', alignItems:'center', justifyContent:'center', flexShrink:0 }}>
            <TrendingUp size={15} color="#fbbf24" />
          </div>
          <div style={{ minWidth: 0 }}>
            <div style={{ color:'rgba(255,255,255,0.4)', fontSize:10, fontWeight:700 }}>
              {formatCoinsPerHour(rate)} passive
            </div>
            <div style={{ display:'flex', alignItems:'center', gap:5, marginTop:1 }}>
              <Coins size={12} color="#fbbf24" />
              <span style={{ color:'#fbbf24', fontWeight:800, fontSize:14, fontVariantNumeric:'tabular-nums' }}>
                {passiveDisplayCoins.toLocaleString()}
              </span>
              <span style={{ color:'rgba(255,255,255,0.3)', fontSize:10, fontWeight:600 }}>pending</span>
            </div>
          </div>
        </div>

        {lastCollected !== null ? (
          <div style={{
            display:'flex', alignItems:'center', gap:5,
            background:'rgba(74,222,128,0.15)', border:'1px solid rgba(74,222,128,0.4)',
            borderRadius:8, padding:'6px 12px',
          }}>
            <Coins size={12} color="#4ade80" />
            <span style={{ color:'#4ade80', fontWeight:800, fontSize:13 }}>+{lastCollected.toLocaleString()}</span>
          </div>
        ) : (
          <button onClick={handleCollect} disabled={collecting || passiveDisplayCoins < 1} style={{
            display:'flex', alignItems:'center', gap:6, padding:'8px 14px', borderRadius:10,
            background: collecting || passiveDisplayCoins < 1
              ? 'rgba(255,255,255,0.05)'
              : 'linear-gradient(135deg, rgba(180,83,9,0.8), rgba(146,64,14,0.8))',
            border: `1.5px solid ${collecting || passiveDisplayCoins < 1 ? 'rgba(255,255,255,0.08)' : 'rgba(251,191,36,0.4)'}`,
            color: collecting || passiveDisplayCoins < 1 ? 'rgba(255,255,255,0.3)' : '#fff',
            fontWeight:800, fontSize:12, cursor: collecting || passiveDisplayCoins < 1 ? 'not-allowed' : 'pointer',
            fontFamily:"'Quicksand',sans-serif", transition:'all 0.2s',
            boxShadow: passiveDisplayCoins >= 1 && !collecting ? '0 2px 12px rgba(180,83,9,0.4)' : 'none',
          }}>
            {collecting ? (
              <div style={{ width:13, height:13, border:'2px solid rgba(255,255,255,0.2)', borderTopColor:'#fff', borderRadius:'50%', animation:'spin 0.8s linear infinite' }} />
            ) : (
              <Download size={13} />
            )}
            Collect
          </button>
        )}
      </div>
      <style>{`@keyframes spin { to { transform: rotate(360deg); } }`}</style>
    </>
  );
};
================================================================================
FILE: src/components/chemcity/PlaceUnlockModal.tsx
================================================================================

import React, { useState } from 'react';
import { X, Lock, Coins, CheckCircle } from 'lucide-react';
import { useChemCityStore } from '../../store/chemcityStore';

export const PlaceUnlockModal: React.FC = () => {
  const user                  = useChemCityStore(s => s.user);
  const places                = useChemCityStore(s => s.places);
  const placeUnlockModalId    = useChemCityStore(s => s.placeUnlockModalId);
  const closePlaceUnlockModal = useChemCityStore(s => s.closePlaceUnlockModal);
  const unlockPlace           = useChemCityStore(s => s.unlockPlace);

  const [unlocking, setUnlocking] = useState(false);
  const [error, setError]         = useState<string | null>(null);
  const [success, setSuccess]     = useState(false);

  const isOpen = !!placeUnlockModalId;
  const place  = places.find(p => p.id === placeUnlockModalId) ?? null;
  if (!isOpen || !place || !user) return null;

  const cost       = place.unlockCost ?? 0;
  const coins      = user.currencies.coins;
  const canAfford  = coins >= cost;
  const isUnlocked = user.unlockedPlaces.includes(place.id as any);

  const handleUnlock = async () => {
    if (unlocking || !canAfford || isUnlocked) return;
    setUnlocking(true); setError(null);
    try {
      await unlockPlace(place.id);
      setSuccess(true);
      setTimeout(() => { closePlaceUnlockModal(); setSuccess(false); }, 1200);
    } catch (err: any) { setError(err?.message ?? 'Unlock failed.'); }
    finally { setUnlocking(false); }
  };

  return (
    <>
      <style>{`@import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@600;700;800&display=swap'); @keyframes spin{to{transform:rotate(360deg)}} @keyframes modalIn{from{opacity:0;transform:scale(0.92) translateY(16px)}to{opacity:1;transform:scale(1) translateY(0)}}`}</style>

      <div onClick={closePlaceUnlockModal} style={{
        position: 'fixed', inset: 0, zIndex: 70,
        background: 'rgba(4,10,9,0.88)',
        backdropFilter: 'blur(14px)', WebkitBackdropFilter: 'blur(14px)',
        display: 'flex', alignItems: 'center', justifyContent: 'center', padding: 16,
      }}>
        <div onClick={e => e.stopPropagation()} style={{
          width: 'min(360px, 92vw)',
          background: 'rgba(8,20,19,0.97)',
          border: '1.5px solid rgba(197,215,181,0.18)',
          borderRadius: 20,
          boxShadow: '0 32px 80px rgba(0,0,0,0.7)',
          overflow: 'hidden',
          fontFamily: "'Quicksand',sans-serif",
          animation: 'modalIn 0.28s cubic-bezier(0.34,1.56,0.64,1) forwards',
        }}>
          {/* Header */}
          <div style={{
            padding: '22px 20px 16px',
            borderBottom: '1px solid rgba(197,215,181,0.1)',
            background: 'linear-gradient(135deg, rgba(118,168,165,0.1) 0%, transparent)',
            display: 'flex', flexDirection: 'column', alignItems: 'center', gap: 6,
            position: 'relative',
          }}>
            <button onClick={closePlaceUnlockModal} style={{
              position: 'absolute', top: 12, right: 12,
              background: 'rgba(255,255,255,0.07)', border: '1.5px solid rgba(255,255,255,0.12)',
              borderRadius: 8, width: 28, height: 28, cursor: 'pointer',
              display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#94a3b8',
            }}><X size={13} /></button>

            <div style={{ fontSize: 48, lineHeight: 1 }}>{place.emoji}</div>
            <div style={{ color: '#fff', fontWeight: 800, fontSize: 18, textAlign: 'center' }}>{place.displayName}</div>
            <div style={{ color: 'rgba(197,215,181,0.5)', fontSize: 12, fontWeight: 600, textAlign: 'center', maxWidth: 260 }}>
              {place.skill.description}
            </div>
          </div>

          {/* Body */}
          <div style={{ padding: '18px 20px 22px', display: 'flex', flexDirection: 'column', gap: 12 }}>
            {isUnlocked || success ? (
              <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', gap: 10, padding: '14px 0' }}>
                <CheckCircle size={30} color="#4ade80" />
                <span style={{ color: '#4ade80', fontWeight: 800, fontSize: 14 }}>
                  {isUnlocked ? 'Already unlocked!' : `${place.displayName} unlocked!`}
                </span>
              </div>
            ) : (
              <>
                {/* Cost / Balance */}
                <div style={{ background: 'rgba(255,255,255,0.04)', border: '1px solid rgba(255,255,255,0.08)', borderRadius: 12, padding: '12px 14px', display: 'flex', flexDirection: 'column', gap: 8 }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <span style={{ color: 'rgba(255,255,255,0.45)', fontSize: 12, fontWeight: 700 }}>Unlock Cost</span>
                    <div style={{ display: 'flex', alignItems: 'center', gap: 5 }}>
                      <Coins size={14} color="#fbbf24" />
                      <span style={{ color: '#fbbf24', fontWeight: 800, fontSize: 16 }}>{cost.toLocaleString()}</span>
                    </div>
                  </div>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <span style={{ color: 'rgba(255,255,255,0.45)', fontSize: 12, fontWeight: 700 }}>Your Balance</span>
                    <div style={{ display: 'flex', alignItems: 'center', gap: 5 }}>
                      <Coins size={13} color={canAfford ? '#fbbf24' : '#f87171'} />
                      <span style={{ color: canAfford ? '#fff' : '#f87171', fontWeight: 800, fontSize: 14 }}>{coins.toLocaleString()}</span>
                    </div>
                  </div>
                  {!canAfford && (
                    <div style={{ textAlign: 'center', color: '#f87171', fontSize: 11, fontWeight: 700 }}>
                      Need {(cost - coins).toLocaleString()} more coins
                    </div>
                  )}
                </div>

                {/* Slot info */}
                <div style={{ background: 'rgba(118,168,165,0.08)', border: '1px solid rgba(118,168,165,0.2)', borderRadius: 10, padding: '9px 12px' }}>
                  <span style={{ color: 'rgba(197,215,181,0.7)', fontSize: 11, fontWeight: 600, fontFamily: "'Quicksand',sans-serif" }}>
                    Grants access to <strong style={{ color: '#C5D7B5' }}>{place.slots?.length ?? 0} card slots</strong>
                  </span>
                </div>

                {error && <p style={{ color: '#f87171', fontSize: 11, textAlign: 'center', margin: 0 }}>{error}</p>}
              </>
            )}

            {/* Action buttons */}
            <div style={{ display: 'flex', gap: 10, marginTop: 2 }}>
              <button onClick={closePlaceUnlockModal} style={{
                flex: 1, padding: '11px', borderRadius: 10,
                background: 'rgba(255,255,255,0.06)', border: '1.5px solid rgba(255,255,255,0.1)',
                color: 'rgba(255,255,255,0.6)', fontWeight: 800, fontSize: 13, cursor: 'pointer',
                fontFamily: "'Quicksand',sans-serif",
              }}>
                {isUnlocked || success ? 'Close' : 'Cancel'}
              </button>
              {!success && !isUnlocked && (
                <button onClick={handleUnlock} disabled={!canAfford || unlocking} style={{
                  flex: 2, padding: '11px', borderRadius: 10, border: 'none',
                  background: canAfford && !unlocking ? 'linear-gradient(135deg, #b45309, #92400e)' : 'rgba(255,255,255,0.05)',
                  color: canAfford && !unlocking ? '#fff' : 'rgba(255,255,255,0.25)',
                  fontWeight: 800, fontSize: 13,
                  cursor: canAfford && !unlocking ? 'pointer' : 'not-allowed',
                  fontFamily: "'Quicksand',sans-serif",
                  boxShadow: canAfford ? '0 4px 16px rgba(180,83,9,0.4)' : 'none',
                  display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 8,
                  transition: 'all 0.2s',
                }}>
                  {unlocking ? (
                    <div style={{ width: 14, height: 14, border: '2px solid rgba(255,255,255,0.2)', borderTopColor: '#fff', borderRadius: '50%', animation: 'spin 0.8s linear infinite' }} />
                  ) : <Lock size={13} />}
                  Unlock for {cost.toLocaleString()}
                </button>
              )}
            </div>
          </div>
        </div>
      </div>
    </>
  );
};
================================================================================
FILE: src/components/chemcity/PlaceView.tsx
================================================================================

// ==============================
// FILE: src/components/chemcity/PlaceView.tsx
// ==============================
import React, { useEffect, useMemo, useRef, useState } from 'react';
import { useChemCityStore } from '../../store/chemcityStore';
import { ChemCard } from './ChemCard';

const FIXED_SLOT_LAYOUTS: Record<
  string,
  {
    slotPositions?: Record<string, { leftPct: number; topPct: number }>;
    slotLabels?: Record<string, string>;
    slotSizesPx?: Record<string, number>;
  }
> = {
  school: {
    slotPositions: {
      school_desk_1: { leftPct: 44.8, topPct: 82.9 },
      school_desk_2: { leftPct: 39.7, topPct: 48.3 },
      school_desk_3: { leftPct: 24.1, topPct: 34.8 },
      school_desk_4: { leftPct: 92.4, topPct: 29.2 },
      school_desk_5: { leftPct: 39.5, topPct: 33.1 },
      school_locker_1: { leftPct: 66.3, topPct: 43.2 },
      school_locker_2: { leftPct: 88.5, topPct: 68.3 },
    },
    slotLabels: {
      school_desk_1: 'Student Desk 1',
      school_desk_2: 'Teacher Desk',
      school_desk_3: 'Blackboard',
      school_desk_4: 'Science Corner',
      school_desk_5: 'Poster',
      school_locker_1: 'Window-side Table',
      school_locker_2: 'Student Desk 2',
    },
    slotSizesPx: {
      school_desk_1: 64,
    },
  },
  gas_station: {
    slotPositions: {
      gas_pump_1: { leftPct: 24.1, topPct: 61.9 },
      gas_pump_2: { leftPct: 87.9, topPct: 79.1 },
      gas_pump_3: { leftPct: 63.7, topPct: 32.1 },
      gas_pump_4: { leftPct: 61.5, topPct: 57.8 },
      gas_shelf_1: { leftPct: 51.8, topPct: 61 },
      gas_shelf_2: { leftPct: 38.5, topPct: 48.4 },
      gas_shelf_3: { leftPct: 78.4, topPct: 37.2 },
      gas_shelf_4: { leftPct: 85.1, topPct: 17.1 },
    },
    slotLabels: {
      gas_pump_1: 'Car 1',
      gas_pump_2: 'Construction Site',
      gas_pump_3: 'Factory',
      gas_pump_4: 'Petrol Pump',
      gas_shelf_1: 'Car 2',
      gas_shelf_2: 'Motel',
      gas_shelf_3: 'Street Light',
      gas_shelf_4: 'Firework',
    },
  },
  lab: {
    slotPositions: {
      lab_bench_1: { leftPct: 50.7, topPct: 51.3 },
      lab_bench_2: { leftPct: 28.7, topPct: 36 },
      lab_bench_3: { leftPct: 46.4, topPct: 32.2 },
      lab_bench_4: { leftPct: 75.3, topPct: 78.9 },
      lab_bench_5: { leftPct: 81.4, topPct: 10.9 },
      lab_bench_6: { leftPct: 92.2, topPct: 21.3 },
      lab_premium_1: { leftPct: 60.4, topPct: 31.5 },
      lab_premium_2: { leftPct: 50.1, topPct: 84.1 },
      lab_premium_3: { leftPct: 80.5, topPct: 36.7 },
      lab_premium_4: { leftPct: 9.5, topPct: 46.9 },
    },
    slotLabels: {
      lab_bench_1: 'Bench',
      lab_bench_2: 'Fume Hood',
      lab_bench_3: 'Acid & Alkali Cabinet',
      lab_bench_4: 'Apparatus 1',
      lab_bench_5: 'Metal Shelf',
      lab_bench_6: 'Salt Shelf',
      lab_premium_1: 'Hazardous Chemical Shelf',
      lab_premium_2: 'Apparatus 2',
      lab_premium_3: 'Chemical Shelf',
      lab_premium_4: 'Gas Tank',
      lab_premium_5: 'Apparatus 3',
      lab_premium_6: 'Apparatus 4',
    },
  },
  kitchen: {
    slotPositions: {
      kitchen_counter_1: { leftPct: 60.5, topPct: 72.4 },
      kitchen_counter_2: { leftPct: 12.6, topPct: 40.2 },
      kitchen_counter_3: { leftPct: 67, topPct: 44.4 },
      kitchen_counter_4: { leftPct: 28.3, topPct: 88.8 },
      kitchen_shelf_1: { leftPct: 42.3, topPct: 41.2 },
      kitchen_shelf_2: { leftPct: 12.6, topPct: 17.4 },
      kitchen_shelf_3: { leftPct: 88.1, topPct: 87.8 },
      kitchen_shelf_4: { leftPct: 89.6, topPct: 41.2 },
    },
    slotLabels: {
      kitchen_counter_1: 'Cutlery Drawer',
      kitchen_counter_2: 'Pantry 1',
      kitchen_counter_3: 'Stove & Oven',
      kitchen_counter_4: 'Dinette',
      kitchen_shelf_1: 'Fridge',
      kitchen_shelf_2: 'Pantry 2',
      kitchen_shelf_3: 'Base Cabinet',
      kitchen_shelf_4: 'Countertop',
    },
  },
  toilet: {
    slotPositions: {
      toilet_tank_1: { leftPct: 24.1, topPct: 47.6 },
      toilet_tank_2: { leftPct: 40.8, topPct: 83.8 },
      toilet_tank_3: { leftPct: 80.3, topPct: 51.1 },
      toilet_tank_4: { leftPct: 21.3, topPct: 15.4 },
      toilet_cabinet_1: { leftPct: 58.1, topPct: 63.3 },
      toilet_cabinet_2: { leftPct: 37.4, topPct: 48.4 },
      toilet_cabinet_3: { leftPct: 45.5, topPct: 14.6 },
    },
    slotLabels: {
      toilet_tank_1: 'Faucet',
      toilet_tank_2: 'Vanity Cabinet',
      toilet_tank_3: 'Bathtub',
      toilet_tank_4: 'Mirror Cabinet 1',
      toilet_cabinet_1: 'Toilet',
      toilet_cabinet_2: 'Vanity Top',
      toilet_cabinet_3: 'Mirror Cabinet 2',
      toilet_cabinet_4: 'Mirror Cabinet 3',
    },
  },
  garden: {
    slotPositions: {
      garden_bed_1: { leftPct: 20.6, topPct: 47.6 },
      garden_bed_2: { leftPct: 65.2, topPct: 85.8 },
      garden_bed_3: { leftPct: 56.8, topPct: 40.7 },
      garden_bed_4: { leftPct: 76.7, topPct: 45.6 },
      garden_plot_1: { leftPct: 22.3, topPct: 79.1 },
      garden_plot_2: { leftPct: 48.6, topPct: 68.2 },
      garden_plot_3: { leftPct: 20.7, topPct: 18.6 },
    },
    slotLabels: {
      garden_bed_1: 'Shed 1',
      garden_bed_2: 'Lawn',
      garden_bed_3: 'Greenhouse',
      garden_bed_4: 'Flower Bed',
      garden_plot_1: 'Mole Hill',
      garden_plot_2: 'Broadcast Spreader',
      garden_plot_3: 'Shed 2',
      garden_plot_4: 'Garden Plot',
    },
  },
  lifestyle_boutique: {
    slotPositions: {
      boutique_shelf_1: { leftPct: 40.1, topPct: 82.6 },
      boutique_shelf_2: { leftPct: 29.1, topPct: 43.7 },
      boutique_shelf_3: { leftPct: 77.6, topPct: 54.8 },
      boutique_shelf_4: { leftPct: 85.7, topPct: 82.4 },
      boutique_display_1: { leftPct: 86.8, topPct: 27.8 },
      boutique_display_2: { leftPct: 52.8, topPct: 82.6 },
    },
    slotLabels: {
      boutique_shelf_1: 'Poseur Table 1',
      boutique_shelf_2: 'Service Desk',
      boutique_shelf_3: 'Jewellery Display',
      boutique_shelf_4: 'Power Essentials',
      boutique_display_1: 'Apparel Gallery',
      boutique_display_2: 'Poseur Table 2',
    },
  },
  beach: {
    slotPositions: {
      beach_sand_1: { leftPct: 60.1, topPct: 14.6 },
      beach_sand_2: { leftPct: 81.7, topPct: 37.2 },
      beach_sand_3: { leftPct: 13.2, topPct: 40.7 },
      beach_sand_4: { leftPct: 33.7, topPct: 76.6 },
      beach_pier_1: { leftPct: 72.3, topPct: 68.2 },
      beach_pier_2: { leftPct: 36.1, topPct: 44.6 },
      beach_pier_3: { leftPct: 27.7, topPct: 23.3 },
    },
    slotLabels: {
      beach_sand_1: 'Sky',
      beach_sand_2: 'Sea',
      beach_sand_3: 'Rock 1',
      beach_sand_4: 'Dry Sand',
      beach_pier_1: 'Strandline',
      beach_pier_2: 'Rock 2',
      beach_pier_3: 'Cliffside',
      beach_pier_4: 'Pier',
    },
  },
};

// ─── Compact equip strip slot item ───────────────────────────────────────────
interface StripSlotProps {
  slotId: string;
  label: string;
  isLocked: boolean;
  isUnlocking: boolean;
  canAfford: boolean;
  costLabel: string;
  slimItem: { id: string; name: string; emoji: string; imageUrl?: string } | undefined;
  onEquip: () => void;
  onUnlock: () => void;
  onDetail: (id: string) => void;
}

const StripSlot: React.FC<StripSlotProps> = ({
  slotId,
  label,
  isLocked,
  isUnlocking,
  canAfford,
  costLabel,
  slimItem,
  onEquip,
  onUnlock,
  onDetail,
}) => {
  if (isLocked) {
    return (
      <div className="flex flex-col items-center gap-1 shrink-0">
        <button
          onClick={canAfford ? onUnlock : undefined}
          disabled={!canAfford || isUnlocking}
          className={`
            w-14 h-14 rounded-xl border-2 border-dashed flex flex-col items-center justify-center gap-0.5
            transition-all active:scale-95
            ${canAfford && !isUnlocking
              ? 'bg-yellow-500/10 border-yellow-500/60 hover:bg-yellow-500/20 cursor-pointer'
              : 'bg-slate-900/60 border-slate-700 cursor-not-allowed opacity-60'
            }
          `}
          title={`Unlock for ${costLabel}`}
        >
          <span className="text-base leading-none">{isUnlocking ? '⏳' : '🔒'}</span>
          <span className="text-[9px] text-slate-400 leading-none">{costLabel}</span>
        </button>
        <span className="text-[10px] text-slate-600 max-w-[3.5rem] truncate text-center leading-tight">
          {label}
        </span>
      </div>
    );
  }

  if (slimItem) {
    return (
      <div className="flex flex-col items-center gap-1 shrink-0">
        <button
          onClick={() => onDetail(slimItem.id)}
          className="
            w-14 h-14 rounded-xl border-2 border-indigo-500/70
            overflow-hidden bg-slate-800
            hover:border-indigo-400 transition-all active:scale-95
            relative
          "
          title={slimItem.name}
        >
          {slimItem.imageUrl ? (
            <img
              src={slimItem.imageUrl}
              alt={slimItem.name}
              className="w-full h-full object-cover"
              loading="lazy"
              onError={(ev) => {
                (ev.target as HTMLImageElement).style.display = 'none';
              }}
            />
          ) : (
            <span className="text-2xl flex items-center justify-center w-full h-full">
              {slimItem.emoji}
            </span>
          )}
          {/* Change indicator */}
          <span
            className="
              absolute bottom-0 right-0
              w-4 h-4 rounded-tl-md
              bg-slate-900/80 text-[8px]
              flex items-center justify-center text-indigo-300
            "
            onClick={(e) => { e.stopPropagation(); onEquip(); }}
          >
            ✎
          </span>
        </button>
        <span className="text-[10px] text-slate-400 max-w-[3.5rem] truncate text-center leading-tight">
          {label}
        </span>
      </div>
    );
  }

  // Empty slot
  return (
    <div className="flex flex-col items-center gap-1 shrink-0">
      <button
        onClick={onEquip}
        className="
          w-14 h-14 rounded-xl border-2 border-dashed border-slate-600
          bg-slate-800/60 hover:bg-slate-700/60 hover:border-indigo-500
          flex items-center justify-center
          text-slate-500 hover:text-indigo-400
          transition-all active:scale-95
        "
        title={`Equip card to ${label}`}
      >
        <span className="text-xl font-bold leading-none">+</span>
      </button>
      <span className="text-[10px] text-slate-500 max-w-[3.5rem] truncate text-center leading-tight">
        {label}
      </span>
    </div>
  );
};

// ─── Main PlaceView ───────────────────────────────────────────────────────────
export const PlaceView: React.FC = () => {
  const user = useChemCityStore((s) => s.user);
  const places = useChemCityStore((s) => s.places);
  const slimItems = useChemCityStore((s) => s.slimItems);
  const selectedPlaceId = useChemCityStore((s) => s.selectedPlaceId);
  const openCardPicker = useChemCityStore((s) => s.openCardPicker);
  const openCardDetail = useChemCityStore((s) => s.openCardDetail);
  const unlockSlot = useChemCityStore((s) => s.unlockSlot);
  const navigateToGasStationDistributor = useChemCityStore((s) => s.navigateToGasStationDistributor);

  const [unlockingSlotId, setUnlockingSlotId] = useState<string | null>(null);

  // Dev editor (disabled in production)
  const isDevEditorEnabled = false;
  const [editSlotsMode, setEditSlotsMode] = useState(false);
  const [selectedSlotIdForEdit, setSelectedSlotIdForEdit] = useState<string | null>(null);
  const [slotPositions, setSlotPositions] = useState<Record<string, { leftPct: number; topPct: number }>>({});
  const [slotLabels, setSlotLabels] = useState<Record<string, string>>({});
  const [slotSizesPx, setSlotSizesPx] = useState<Record<string, number>>({});

  const placeImageRef = useRef<HTMLImageElement | null>(null);
  const [placeImageNaturalWidth, setPlaceImageNaturalWidth] = useState<number>(0);
  const [placeImageRenderedWidth, setPlaceImageRenderedWidth] = useState<number>(0);

  const place = useMemo(
    () => places.find((p) => p.id === selectedPlaceId) ?? null,
    [places, selectedPlaceId],
  );

  if (!place || !user) return null;

  const fixedLayout = FIXED_SLOT_LAYOUTS[place.id] ?? null;

  const placeImageSrc = (() => {
    switch (place.id) {
      case 'toilet':           return '/Place1_Toilet.png';
      case 'kitchen':          return '/Place2_Kitchen.png';
      case 'beach':            return '/Place3_Beach.png';
      case 'gas_station':      return '/Place4_GasStation.png';
      case 'lab':              return '/Place5_Lab.png';
      case 'garden':           return '/Place6_Garden.png';
      case 'lifestyle_boutique': return '/Place7_Boutique.png';
      case 'school':           return '/Place8_School.png';
      default:                 return null;
    }
  })();

  // Track rendered image width for slot sizing
  useEffect(() => {
    const img = placeImageRef.current;
    if (!img) return;

    const updateRendered = () => {
      const rect = img.getBoundingClientRect();
      setPlaceImageRenderedWidth(rect.width);
    };

    updateRendered();

    let ro: ResizeObserver | null = null;
    if (typeof ResizeObserver !== 'undefined') {
      ro = new ResizeObserver(() => updateRendered());
      ro.observe(img);
    } else {
      window.addEventListener('resize', updateRendered);
    }

    return () => {
      if (ro) ro.disconnect();
      else window.removeEventListener('resize', updateRendered);
    };
  }, [placeImageSrc, selectedPlaceId]);

  const slotSizeScale =
    placeImageNaturalWidth > 0 && placeImageRenderedWidth > 0
      ? placeImageRenderedWidth / placeImageNaturalWidth
      : 1;
  const tunedSlotSizeScale = slotSizeScale * 1.35;

  const effectiveSlotPositions =
    (isDevEditorEnabled && editSlotsMode ? slotPositions : fixedLayout?.slotPositions) ?? slotPositions;
  const effectiveSlotLabels =
    (isDevEditorEnabled && editSlotsMode ? slotLabels : fixedLayout?.slotLabels) ?? slotLabels;
  const effectiveSlotSizesPx =
    (isDevEditorEnabled && editSlotsMode ? slotSizesPx : fixedLayout?.slotSizesPx) ?? slotSizesPx;

  const exportSlotCoords = async () => {
    const payload = {
      placeId: place.id,
      slots: place.slots.map((s) => ({
        slotId: s.slotId,
        label: slotLabels[s.slotId] || undefined,
        sizePx: slotSizesPx[s.slotId] || undefined,
        ...(slotPositions[s.slotId] ? slotPositions[s.slotId] : {}),
      })),
    };
    const text = JSON.stringify(payload, null, 2);
    console.log('[PlaceView] Slot coords export:\n' + text);
    try {
      if (typeof navigator !== 'undefined' && navigator.clipboard?.writeText) {
        await navigator.clipboard.writeText(text);
      }
    } catch { /* ignore */ }
  };

  const coins = user.currencies.coins;
  const diamonds = user.currencies.diamonds;
  const isPlaceUnlocked = place.unlockCost === 0 || user.unlockedPlaces.includes(place.id);

  const handleUnlockSlot = async (slotId: string) => {
    const slot = place.slots.find((s) => s.slotId === slotId);
    if (slot?.budgetOnly) {
      navigateToGasStationDistributor();
      return;
    }

    setUnlockingSlotId(slotId);
    try {
      await unlockSlot(place.id, slotId);
    } finally {
      setUnlockingSlotId(null);
    }
  };

  const skillValue = (() => {
    switch (place.id) {
      case 'garden':     return `${user.activeBonuses.passiveBaseCoinsPerHour.toLocaleString()} 🪙/hr`;
      case 'lab':        return `${user.activeBonuses.passiveMultiplier.toFixed(1)}× multiplier`;
      case 'kitchen':    return `+${user.activeBonuses.quizFlatDiamondBonus} 💎 max bonus`;
      case 'school':     return `${user.activeBonuses.quizDiamondMultiplier.toFixed(1)}× quiz diamonds`;
      case 'beach':      return `${user.activeBonuses.quizDoubleChancePercent}% double chance`;
      case 'toilet':     return `${user.activeBonuses.dailyLoginDiamonds} 💎 daily`;
      case 'gas_station': return `${user.activeBonuses.extraSlotsTotal} bonus slots`;
      case 'lifestyle_boutique': return `${user.activeBonuses.shopDiscountPercent}% store discount`;
      default:           return '—';
    }
  })();

  const equippedCount = place.slots.filter((s) => !!user.equipped?.[s.slotId]).length;

  // ─────────────────────────────────────────────────────────────────────────────
  // LAYOUT
  //
  //  The outer wrapper fills the full viewport height.
  //  pt-[76px] pushes content below the fixed main site header.
  //  flex-col + overflow-hidden = no page scroll ever.
  //
  //   ┌───────────────────────────────────┐  ← 76px (main header, behind)
  //   │  IMAGE  (flex-1, maximised)       │
  //   │  ┌── info overlay (bottom) ──┐   │
  //   │  └───────────────────────────┘   │
  //   ├───────────────────────────────────┤
  //   │  EQUIP STRIP (shrink-0, ~90px)    │
  //   └───────────────────────────────────┘
  // ─────────────────────────────────────────────────────────────────────────────
  return (
    <div
      className="flex flex-col overflow-hidden"
      style={{ height: '100vh', paddingTop: 76 }}
    >
      {/* ── Image area (flex-1) ── */}
      {placeImageSrc ? (
        <div className="flex-1 flex justify-center items-start overflow-hidden px-3 pt-2 pb-1 min-h-0">
          {/*
            Inner wrapper sizes to the image naturally.
            - h-full: fills flex-1 height
            - width: fit-content + max-w-full: stays inside horizontal bounds
            - Slots and overlay are positioned relative to this wrapper,
              which exactly matches the rendered image dimensions.
          */}
          <div
            className="relative h-full"
            style={{ width: 'fit-content', maxWidth: '100%' }}
            onClick={(e) => {
              if (!isDevEditorEnabled || !editSlotsMode || !selectedSlotIdForEdit) return;
              const target = e.currentTarget;
              const rect = target.getBoundingClientRect();
              const leftPct = Math.round(((e.clientX - rect.left) / rect.width) * 1000) / 10;
              const topPct = Math.round(((e.clientY - rect.top) / rect.height) * 1000) / 10;
              setSlotPositions((prev) => ({
                ...prev,
                [selectedSlotIdForEdit]: { leftPct, topPct },
              }));
              console.log(`[PlaceView] ${place.id} set ${selectedSlotIdForEdit}: leftPct=${leftPct}, topPct=${topPct}`);
            }}
          >
            <img
              src={placeImageSrc}
              alt={place.displayName}
              ref={placeImageRef}
              className="h-full w-auto max-w-full rounded-2xl border border-slate-700 bg-slate-950 block"
              loading="lazy"
              onLoad={(e) => {
                const el = e.currentTarget;
                if (el.naturalWidth) setPlaceImageNaturalWidth(el.naturalWidth);
                // Also update rendered width immediately after load
                const rect = el.getBoundingClientRect();
                setPlaceImageRenderedWidth(rect.width);
              }}
            />

            {/* ── Slot overlay buttons ── */}
            {place.slots.map((slot) => {
              const slotId = slot.slotId;
              const pos = effectiveSlotPositions[slotId];
              if (!pos) return null;

              const baseSizePx = effectiveSlotSizesPx[slotId] ?? 64;
              const sizePx = Math.max(38, Math.min(100, Math.round(baseSizePx * tunedSlotSizeScale)));

              const equippedItemId = user.equipped?.[slotId];
              const slimItem = equippedItemId ? slimItems.find((i) => i.id === equippedItemId) : undefined;

              const isFreeSlot = slot.unlockCost == null && !slot.budgetOnly;
              const isUnlockedSlot = isFreeSlot || user.unlockedSlots.includes(slotId);
              const isLocked = isPlaceUnlocked && !isUnlockedSlot;

              const label = effectiveSlotLabels[slotId]?.trim() ? effectiveSlotLabels[slotId] : slotId;

              return (
                <button
                  key={slotId}
                  type="button"
                  onClick={(e) => {
                    e.stopPropagation();
                    if (isDevEditorEnabled && editSlotsMode) {
                      setSelectedSlotIdForEdit(slotId);
                      return;
                    }
                    if (isLocked) return;
                    openCardPicker(slotId);
                  }}
                  title={label}
                  aria-label={label}
                  className={`
                    absolute -translate-x-1/2 -translate-y-1/2
                    rounded-full border-2 border-dashed
                    flex items-center justify-center
                    shadow-lg shadow-black/40
                    transition-all active:scale-95
                    ${isLocked
                      ? 'bg-slate-900/70 border-slate-700 text-slate-500 cursor-not-allowed'
                      : isDevEditorEnabled && editSlotsMode && selectedSlotIdForEdit === slotId
                        ? 'bg-indigo-600/60 border-indigo-300 text-white'
                        : 'bg-slate-900/60 border-slate-300/60 text-white hover:border-indigo-300 hover:bg-slate-800/70'
                    }
                  `}
                  style={{
                    left: `${pos.leftPct}%`,
                    top: `${pos.topPct}%`,
                    width: sizePx,
                    height: sizePx,
                  }}
                >
                  {isLocked ? (
                    <span className="text-xs font-bold">🔒</span>
                  ) : slimItem ? (
                    <div className="w-full h-full rounded-full overflow-hidden flex items-center justify-center">
                      {slimItem.imageUrl ? (
                        <img
                          src={slimItem.imageUrl}
                          alt={slimItem.name}
                          className="w-full h-full object-cover"
                          loading="lazy"
                          onError={(ev) => {
                            (ev.target as HTMLImageElement).style.display = 'none';
                          }}
                        />
                      ) : (
                        <span className="text-2xl">{slimItem.emoji}</span>
                      )}
                    </div>
                  ) : (
                    <span className="text-3xl font-bold leading-none">+</span>
                  )}
                </button>
              );
            })}

            {/* ── Place info overlay (bottom of image) ── */}
            <div className="
              absolute bottom-2 left-2 right-2
              flex items-center justify-between gap-2
              bg-slate-900/85 backdrop-blur-md
              rounded-xl px-3 py-2
              border border-slate-700/60
              pointer-events-none
            ">
              <div className="flex items-center gap-2 min-w-0">
                <span className="text-2xl leading-none">{place.emoji}</span>
                <div className="min-w-0">
                  <h2 className="text-white font-bold text-sm leading-tight truncate">
                    {place.displayName}
                  </h2>
                  <p className="text-slate-400 text-xs truncate leading-tight">
                    {place.skill.description}
                  </p>
                </div>
              </div>
              <div className="text-right shrink-0">
                <p className="text-indigo-300 font-bold text-sm leading-tight">{skillValue}</p>
                <p className="text-slate-500 text-xs leading-tight">
                  {equippedCount}/{place.slots.length} cards
                </p>
              </div>
            </div>

            {/* Locked place notice (overlay) */}
            {!isPlaceUnlocked && (
              <div className="
                absolute inset-0 flex items-center justify-center
                bg-slate-950/60 backdrop-blur-sm rounded-2xl
                pointer-events-none
              ">
                <div className="bg-slate-900/90 border border-slate-600 rounded-xl px-4 py-3 text-center">
                  <p className="text-slate-300 text-sm font-semibold">Place Locked</p>
                  <p className="text-slate-500 text-xs mt-1">Return to the map to unlock it.</p>
                </div>
              </div>
            )}
          </div>
        </div>
      ) : (
        // Fallback if no image
        <div className="flex-1 flex items-center justify-center text-slate-500 text-sm">
          No image available
        </div>
      )}

      {/* ── Dev editor toolbar ── */}
      {isDevEditorEnabled && (
        <div className="shrink-0 px-3 pb-1 flex items-center gap-2">
          <button
            type="button"
            onClick={() => {
              setEditSlotsMode((v) => !v);
              setSelectedSlotIdForEdit(null);
              if (!editSlotsMode) {
                setSlotPositions(fixedLayout?.slotPositions ?? {});
                setSlotLabels(fixedLayout?.slotLabels ?? {});
                setSlotSizesPx(fixedLayout?.slotSizesPx ?? {});
              }
            }}
            className={`text-xs font-bold rounded-lg px-3 py-1.5 border transition-colors ${
              editSlotsMode
                ? 'bg-indigo-600 hover:bg-indigo-500 border-indigo-300 text-white'
                : 'bg-slate-900 hover:bg-slate-800 border-slate-700 text-slate-200'
            }`}
          >
            {editSlotsMode ? 'Editing Slots' : 'Edit slots'}
          </button>
          {editSlotsMode && (
            <button
              type="button"
              onClick={exportSlotCoords}
              className="text-xs font-bold rounded-lg px-3 py-1.5 border bg-slate-900 hover:bg-slate-800 border-slate-700 text-slate-200 transition-colors"
            >
              Export coords
            </button>
          )}
          {editSlotsMode && (
            <div className="flex flex-wrap gap-1.5 ml-2">
              {place.slots.map((s) => (
                <button
                  key={s.slotId}
                  type="button"
                  onClick={() => setSelectedSlotIdForEdit(s.slotId)}
                  className={`text-[11px] font-bold rounded-lg px-2 py-1 border transition-colors ${
                    selectedSlotIdForEdit === s.slotId
                      ? 'bg-indigo-600 border-indigo-300 text-white'
                      : 'bg-slate-900 border-slate-700 text-slate-200 hover:bg-slate-800'
                  }`}
                >
                  {s.slotId}
                </button>
              ))}
            </div>
          )}
        </div>
      )}

      {/* ── Compact equip strip ── */}
      <div className="
        shrink-0
        flex gap-3 items-end
        px-3 pb-3 pt-1
        overflow-x-auto
        border-t border-slate-800/60
      ">
        {place.slots.map((slot) => {
          const slotId = slot.slotId;
          const equippedItemId = user.equipped?.[slotId];
          const slimItem = equippedItemId ? slimItems.find((i) => i.id === equippedItemId) : undefined;

          const isFreeSlot = slot.unlockCost == null && !slot.budgetOnly;
          const isUnlockedSlot = isFreeSlot || user.unlockedSlots.includes(slotId);
          const isLocked = isPlaceUnlocked && !isUnlockedSlot;

          const canAfford = slot.budgetOnly
            ? (user.extraSlotsBudget ?? 0) > 0
            : slot.unlockCurrency === 'diamonds'
              ? diamonds >= (slot.unlockCost ?? 0)
              : coins >= (slot.unlockCost ?? 0);

          const costLabel = slot.budgetOnly
            ? '1⛽'
            : slot.unlockCurrency === 'diamonds'
              ? `${slot.unlockCost?.toLocaleString() ?? 0}💎`
              : `${slot.unlockCost?.toLocaleString() ?? 0}🪙`;

          const label =
            (effectiveSlotLabels[slotId]?.trim() ? effectiveSlotLabels[slotId] : slotId);

          return (
            <StripSlot
              key={slotId}
              slotId={slotId}
              label={label}
              isLocked={isLocked}
              isUnlocking={unlockingSlotId === slotId}
              canAfford={canAfford}
              costLabel={costLabel}
              slimItem={slimItem}
              onEquip={() => openCardPicker(slotId)}
              onUnlock={() => handleUnlockSlot(slotId)}
              onDetail={(id) => openCardDetail(id)}
            />
          );
        })}
      </div>
    </div>
  );
};
================================================================================
FILE: src/components/chemcity/PurchaseConfirmModal.tsx
================================================================================

import React, { useEffect, useState } from 'react';
import { X, Coins, Gem, CheckCircle, FlaskConical, Star, BookOpen, Zap } from 'lucide-react';
import { useChemCityStore } from '../../store/chemcityStore';
import { getEffectiveCoinPrice } from '../../lib/chemcity/shop';

const RARITY_CONFIG: Record<string, {
  borderColor: string; glowColor: string; bgGradient: string; artBg: string;
  badgeColor: string; badgeText: string;
}> = {
  common:    { borderColor: '#94a3b8', glowColor: 'rgba(148,163,184,0.3)', bgGradient: 'linear-gradient(165deg,#1e293b,#0f172a)', artBg: 'rgba(255,255,255,0.04)', badgeColor: 'rgba(148,163,184,0.2)', badgeText: '#94a3b8' },
  rare:      { borderColor: '#60a5fa', glowColor: 'rgba(96,165,250,0.4)',  bgGradient: 'linear-gradient(165deg,#1e3a5f,#0f172a)', artBg: 'rgba(96,165,250,0.07)',  badgeColor: 'rgba(96,165,250,0.2)',  badgeText: '#60a5fa' },
  epic:      { borderColor: '#a855f7', glowColor: 'rgba(168,85,247,0.4)',  bgGradient: 'linear-gradient(165deg,#2d1b4e,#0f0a1e)', artBg: 'rgba(168,85,247,0.07)',  badgeColor: 'rgba(168,85,247,0.2)',  badgeText: '#a855f7' },
  legendary: { borderColor: '#fbbf24', glowColor: 'rgba(251,191,36,0.5)',  bgGradient: 'linear-gradient(165deg,#3d2800,#1a0f00)', artBg: 'rgba(251,191,36,0.09)',  badgeColor: 'rgba(251,191,36,0.2)',  badgeText: '#fbbf24' },
};

type PurchaseCurrency = 'coins' | 'diamonds';

export const PurchaseConfirmModal: React.FC = () => {
  const user                  = useChemCityStore(s => s.user);
  const slimItems             = useChemCityStore(s => s.slimItems);
  const storePurchaseItemId   = useChemCityStore(s => s.storePurchaseItemId);
  const storePurchaseData     = useChemCityStore(s => s.storePurchaseData);
  const storePurchaseLoading  = useChemCityStore(s => s.storePurchaseLoading);
  const closePurchaseConfirm  = useChemCityStore(s => s.closePurchaseConfirm);
  const purchaseCard          = useChemCityStore(s => s.purchaseCard);

  const [purchasing, setPurchasing]         = useState(false);
  const [purchaseCurrency, setPurchaseCurrency] = useState<PurchaseCurrency>('coins');
  const [purchaseError, setPurchaseError]   = useState<string | null>(null);
  const [purchaseSuccess, setPurchaseSuccess] = useState(false);

  const isOpen = !!storePurchaseItemId;
  const slim   = slimItems.find(i => i.id === storePurchaseItemId);
  const full   = storePurchaseData;

  const isOwned  = !!user?.ownedItems?.includes(storePurchaseItemId ?? '');
  const rarity   = slim?.rarity ?? 'common';
  const cfg      = RARITY_CONFIG[rarity] ?? RARITY_CONFIG.common;
  const rarityStars = { common:1, rare:2, epic:3, legendary:4 }[rarity] ?? 1;
  const discount = user?.activeBonuses.shopDiscountPercent ?? 0;
  const rawCoin  = slim?.shopData?.coinCost;
  const rawDiamond = slim?.shopData?.diamondCost;
  const effCoin  = rawCoin != null ? getEffectiveCoinPrice(rawCoin, user?.activeBonuses ?? null) : null;
  const coins    = user?.currencies.coins ?? 0;
  const diamonds = user?.currencies.diamonds ?? 0;
  const canAffordCoins    = effCoin != null && coins >= effCoin;
  const canAffordDiamonds = rawDiamond != null && diamonds >= rawDiamond;

  useEffect(() => {
    if (isOpen) {
      setPurchaseError(null);
      setPurchaseSuccess(false);
      setPurchasing(false);
      if (rawCoin != null) setPurchaseCurrency('coins');
      else if (rawDiamond != null) setPurchaseCurrency('diamonds');
    }
  }, [isOpen, storePurchaseItemId, rawCoin, rawDiamond]);

  if (!isOpen || !slim) return null;

  const handlePurchase = async () => {
    if (purchasing || isOwned) return;
    const canAfford = purchaseCurrency === 'coins' ? canAffordCoins : canAffordDiamonds;
    if (!canAfford) return;
    setPurchasing(true);
    setPurchaseError(null);
    try {
      await purchaseCard(slim.id, purchaseCurrency);
      setPurchaseSuccess(true);
      setTimeout(() => closePurchaseConfirm(), 1800);
    } catch (err: any) {
      setPurchaseError(err?.message ?? 'Purchase failed. Please try again.');
    } finally {
      setPurchasing(false);
    }
  };

  return (
    <>
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Pacifico&family=Quicksand:wght@500;600;700;800&display=swap');
        @keyframes purchaseIn { from{opacity:0;transform:scale(0.9) translateY(20px)} to{opacity:1;transform:scale(1) translateY(0)} }
        @keyframes shimmerSlide { 0%,100%{transform:translateX(-200%)} 50%{transform:translateX(200%)} }
        @keyframes legendGlow { 0%,100%{box-shadow:0 0 24px rgba(251,191,36,0.4)} 50%{box-shadow:0 0 44px rgba(251,191,36,0.7)} }
        @keyframes successPop { 0%{transform:scale(0.7);opacity:0} 60%{transform:scale(1.12)} 100%{transform:scale(1);opacity:1} }
        .purchase-panel { animation: purchaseIn 0.3s cubic-bezier(0.34,1.56,0.64,1) forwards; }
        .curr-tab { font-family:'Quicksand',sans-serif; font-weight:800; font-size:12px; padding:8px 16px; border-radius:10px; border:1.5px solid; cursor:pointer; transition:all 0.2s; display:flex; align-items:center; gap:6px; }
      `}</style>

      {/* Backdrop */}
      <div onClick={closePurchaseConfirm} style={{
        position: 'fixed', inset: 0, zIndex: 80,
        background: 'rgba(4,10,9,0.9)',
        backdropFilter: 'blur(14px)', WebkitBackdropFilter: 'blur(14px)',
        display: 'flex', alignItems: 'center', justifyContent: 'center', padding: 16,
      }}>
        <div className="purchase-panel" onClick={e => e.stopPropagation()} style={{
          width: 'min(620px, 94vw)', maxHeight: '90vh',
          background: 'rgba(8,20,19,0.97)',
          backdropFilter: 'blur(24px)', WebkitBackdropFilter: 'blur(24px)',
          border: '1.5px solid rgba(197,215,181,0.18)',
          borderRadius: 24,
          boxShadow: '0 40px 100px rgba(0,0,0,0.8), inset 0 1px 0 rgba(255,255,255,0.05)',
          overflow: 'hidden', display: 'flex', flexDirection: 'column',
          fontFamily: "'Quicksand',sans-serif",
        }}>
          {/* Close */}
          <button onClick={closePurchaseConfirm} style={{
            position: 'absolute', top: 14, right: 14, zIndex: 10,
            background: 'rgba(255,255,255,0.08)', border: '1px solid rgba(255,255,255,0.12)',
            borderRadius: 8, width: 30, height: 30, cursor: 'pointer',
            display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#94a3b8',
          }}><X size={14} /></button>

          <div style={{ display: 'flex', gap: 0, flex: 1, minHeight: 0, overflow: 'hidden' }}>
            {/* ── Left: Vertical RPG Card ── */}
            <div style={{
              width: 200, flexShrink: 0, padding: '24px 0 24px 24px',
              display: 'flex', flexDirection: 'column', alignItems: 'center', gap: 12,
            }}>
              {/* Card */}
              <div style={{
                width: 155, height: 220, borderRadius: 16,
                border: `2.5px solid ${cfg.borderColor}`,
                background: cfg.bgGradient,
                boxShadow: rarity === 'legendary'
                  ? `0 0 40px ${cfg.glowColor}, 0 8px 24px rgba(0,0,0,0.7)`
                  : `0 0 20px ${cfg.glowColor}, 0 6px 16px rgba(0,0,0,0.6)`,
                overflow: 'hidden', position: 'relative', flexShrink: 0,
                animation: rarity === 'legendary' ? 'legendGlow 2.5s ease-in-out infinite' : 'none',
              }}>
                {rarity === 'legendary' && (
                  <div style={{
                    position: 'absolute', inset: 0, zIndex: 1, pointerEvents: 'none',
                    background: 'linear-gradient(105deg,transparent 30%,rgba(255,215,0,0.13) 50%,transparent 70%)',
                    animation: 'shimmerSlide 3s ease-in-out infinite',
                  }} />
                )}
                {/* Stars */}
                <div style={{ position:'absolute', top:6, right:8, zIndex:3, color:cfg.badgeText, fontSize:10, letterSpacing:1 }}>
                  {'✦'.repeat(rarityStars)}
                </div>
                {/* Art */}
                <div style={{
                  height: 140, margin: '14px 10px 6px',
                  background: cfg.artBg, border: `1px solid ${cfg.borderColor}`,
                  borderRadius: 10, display: 'flex', alignItems: 'center', justifyContent: 'center',
                  overflow: 'hidden', position: 'relative', zIndex: 2,
                }}>
                  {(full?.imageUrl || slim.imageUrl) ? (
                    <img src={full?.imageUrl || slim.imageUrl} alt={slim.name}
                      style={{ width:'90%', height:'90%', objectFit:'contain' }}
                      onError={e => { (e.target as HTMLImageElement).style.display='none'; }}
                    />
                  ) : (
                    <span style={{ fontSize: 52 }}>{slim.emoji}</span>
                  )}
                </div>
                {/* Name / formula */}
                <div style={{ padding:'0 10px 4px', textAlign:'center', position:'relative', zIndex:2 }}>
                  <div style={{ color:'#f1f5f9', fontSize:11, fontWeight:800, overflow:'hidden', textOverflow:'ellipsis', whiteSpace:'nowrap' }}>
                    {full?.displayName || slim.name}
                  </div>
                  <div style={{ color:'rgba(255,255,255,0.4)', fontSize:9, fontFamily:'monospace', marginTop:1 }}>
                    {slim.chemicalFormula}
                  </div>
                </div>
                {/* Rarity footer */}
                <div style={{
                  position:'absolute', bottom:8, left:10, right:10,
                  background:cfg.badgeColor, borderRadius:4, padding:'2px 0',
                  textAlign:'center', fontSize:8, fontWeight:800, color:cfg.badgeText,
                  textTransform:'uppercase', letterSpacing:'0.06em', zIndex:2,
                }}>{rarity}</div>

                {/* Owned stamp */}
                {isOwned && (
                  <div style={{
                    position:'absolute', inset:0, background:'rgba(0,0,0,0.55)', zIndex:4, borderRadius:14,
                    display:'flex', alignItems:'center', justifyContent:'center',
                  }}>
                    <div style={{ background:'rgba(74,222,128,0.9)', borderRadius:8, padding:'6px 14px', fontWeight:800, fontSize:12, color:'#052e16' }}>✓ Owned</div>
                  </div>
                )}
              </div>

              {/* Skill contribution */}
              {slim.skillContribution > 0 && (
                <div style={{
                  display:'flex', alignItems:'center', gap:6,
                  background:'rgba(118,168,165,0.12)', border:'1px solid rgba(118,168,165,0.3)',
                  borderRadius:8, padding:'6px 12px',
                }}>
                  <Zap size={12} color="#76A8A5" />
                  <span style={{ color:'rgba(197,215,181,0.8)', fontSize:11, fontWeight:700 }}>+{slim.skillContribution} Power</span>
                </div>
              )}
            </div>

            {/* ── Right: Info + Purchase ── */}
            <div style={{ flex:1, display:'flex', flexDirection:'column', minWidth:0, overflow:'hidden' }}>
              {/* Scrollable info */}
              <div style={{ flex:1, overflowY:'auto', padding:'24px 24px 12px' }}>
                <div style={{ color:'#fff', fontWeight:800, fontSize:17, marginBottom:4 }}>
                  {full?.displayName || slim.name}
                </div>
                <div style={{ color:'rgba(255,255,255,0.35)', fontFamily:'monospace', fontSize:12, marginBottom:12 }}>
                  {slim.chemicalFormula}
                </div>

                {storePurchaseLoading && (
                  <div style={{ display:'flex', flexDirection:'column', gap:8 }}>
                    {[1,2,3].map(i => <div key={i} style={{ height:14, background:'rgba(255,255,255,0.06)', borderRadius:6, animation:'pulse 1.5s infinite' }} />)}
                    <style>{`@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}`}</style>
                  </div>
                )}

                {full?.description && (
                  <p style={{ color:'rgba(255,255,255,0.6)', fontSize:12, lineHeight:1.7, margin:'0 0 12px', fontFamily:"'Quicksand',sans-serif" }}>
                    {full.description}
                  </p>
                )}

                {full?.educational?.funFact && (
                  <div style={{ background:'rgba(96,165,250,0.07)', border:'1px solid rgba(96,165,250,0.2)', borderRadius:10, padding:'10px 12px', marginBottom:10 }}>
                    <div style={{ display:'flex', alignItems:'center', gap:6, marginBottom:5 }}>
                      <FlaskConical size={11} color="#60a5fa" />
                      <span style={{ color:'#60a5fa', fontSize:10, fontWeight:800, textTransform:'uppercase', letterSpacing:'0.07em' }}>Fun Fact</span>
                    </div>
                    <p style={{ color:'rgba(255,255,255,0.65)', fontSize:11, lineHeight:1.6, margin:0 }}>{full.educational.funFact}</p>
                  </div>
                )}

                {full?.educational?.everydayUses && full.educational.everydayUses.length > 0 && (
                  <div style={{ marginBottom:10 }}>
                    <div style={{ display:'flex', alignItems:'center', gap:6, marginBottom:6 }}>
                      <Star size={10} color="#c5d7b5" />
                      <span style={{ color:'rgba(197,215,181,0.7)', fontSize:10, fontWeight:800, textTransform:'uppercase', letterSpacing:'0.07em' }}>Uses</span>
                    </div>
                    <div style={{ display:'flex', flexWrap:'wrap', gap:4 }}>
                      {full.educational.everydayUses.slice(0,5).map(use => (
                        <span key={use} style={{ background:'rgba(255,255,255,0.06)', border:'1px solid rgba(255,255,255,0.1)', borderRadius:6, padding:'3px 8px', fontSize:10, color:'rgba(255,255,255,0.6)', fontFamily:"'Quicksand',sans-serif", fontWeight:600 }}>{use}</span>
                      ))}
                    </div>
                  </div>
                )}

                {full?.topicConnections && full.topicConnections.length > 0 && (
                  <div>
                    <div style={{ display:'flex', alignItems:'center', gap:6, marginBottom:6 }}>
                      <BookOpen size={10} color="#86efac" />
                      <span style={{ color:'rgba(134,239,172,0.7)', fontSize:10, fontWeight:800, textTransform:'uppercase', letterSpacing:'0.07em' }}>DSE Topics</span>
                    </div>
                    <div style={{ display:'flex', flexWrap:'wrap', gap:4 }}>
                      {full.topicConnections.map(tid => (
                        <span key={tid} style={{ background:'rgba(134,239,172,0.08)', border:'1px solid rgba(134,239,172,0.25)', borderRadius:6, padding:'3px 8px', fontSize:10, color:'#86efac', fontFamily:"'Quicksand',sans-serif", fontWeight:600 }}>{tid}</span>
                      ))}
                    </div>
                  </div>
                )}
              </div>

              {/* ── Purchase Footer ── */}
              <div style={{ borderTop:'1px solid rgba(255,255,255,0.08)', padding:'14px 24px 20px', background:'rgba(0,0,0,0.2)', flexShrink:0 }}>
                {purchaseSuccess ? (
                  <div style={{ display:'flex', flexDirection:'column', alignItems:'center', gap:8, padding:'10px 0', animation:'successPop 0.4s ease forwards' }}>
                    <CheckCircle size={32} color="#4ade80" />
                    <span style={{ color:'#4ade80', fontWeight:800, fontSize:14 }}>Added to your collection!</span>
                  </div>
                ) : isOwned ? (
                  <div style={{ display:'flex', alignItems:'center', justifyContent:'center', gap:8, padding:'12px', background:'rgba(255,255,255,0.04)', border:'1px solid rgba(255,255,255,0.08)', borderRadius:12 }}>
                    <CheckCircle size={16} color="rgba(255,255,255,0.3)" />
                    <span style={{ color:'rgba(255,255,255,0.35)', fontWeight:700, fontSize:13 }}>Already in your collection</span>
                  </div>
                ) : (
                  <>
                    {/* Currency toggle */}
                    {effCoin != null && rawDiamond != null && (
                      <div style={{ display:'flex', gap:8, marginBottom:12 }}>
                        <button className="curr-tab" onClick={() => setPurchaseCurrency('coins')} style={{
                          flex:1, background: purchaseCurrency==='coins' ? 'rgba(251,191,36,0.15)' : 'rgba(255,255,255,0.05)',
                          borderColor: purchaseCurrency==='coins' ? 'rgba(251,191,36,0.5)' : 'rgba(255,255,255,0.1)',
                          color: purchaseCurrency==='coins' ? '#fbbf24' : 'rgba(255,255,255,0.4)',
                          justifyContent:'center',
                        }}>
                          <Coins size={14} /> Coins
                        </button>
                        <button className="curr-tab" onClick={() => setPurchaseCurrency('diamonds')} style={{
                          flex:1, background: purchaseCurrency==='diamonds' ? 'rgba(103,232,249,0.12)' : 'rgba(255,255,255,0.05)',
                          borderColor: purchaseCurrency==='diamonds' ? 'rgba(103,232,249,0.5)' : 'rgba(255,255,255,0.1)',
                          color: purchaseCurrency==='diamonds' ? '#67e8f9' : 'rgba(255,255,255,0.4)',
                          justifyContent:'center',
                        }}>
                          <Gem size={13} /> Diamonds
                        </button>
                      </div>
                    )}

                    {/* Price + balance */}
                    <div style={{ display:'flex', alignItems:'center', justifyContent:'space-between', marginBottom:10, padding:'10px 12px', background:'rgba(255,255,255,0.03)', borderRadius:10 }}>
                      <div>
                        {purchaseCurrency === 'coins' && effCoin != null && (
                          <div style={{ display:'flex', alignItems:'center', gap:8 }}>
                            <div style={{ display:'flex', alignItems:'center', gap:5 }}>
                              <Coins size={15} color="#fbbf24" />
                              <span style={{ color:'#fbbf24', fontWeight:800, fontSize:16 }}>{effCoin.toLocaleString()}</span>
                            </div>
                            {rawCoin != null && rawCoin !== effCoin && (
                              <span style={{ color:'rgba(255,255,255,0.25)', fontSize:12, textDecoration:'line-through' }}>{rawCoin.toLocaleString()}</span>
                            )}
                            {discount > 0 && (
                              <span style={{ background:'rgba(52,211,153,0.2)', border:'1px solid rgba(52,211,153,0.4)', borderRadius:20, padding:'1px 7px', fontSize:10, color:'#34d399', fontWeight:800 }}>{discount}% OFF</span>
                            )}
                          </div>
                        )}
                        {purchaseCurrency === 'diamonds' && rawDiamond != null && (
                          <div style={{ display:'flex', alignItems:'center', gap:5 }}>
                            <Gem size={14} color="#67e8f9" />
                            <span style={{ color:'#67e8f9', fontWeight:800, fontSize:16 }}>{rawDiamond.toLocaleString()}</span>
                          </div>
                        )}
                      </div>
                      <span style={{ color:'rgba(255,255,255,0.3)', fontSize:11, fontWeight:600 }}>
                        You have: {purchaseCurrency === 'coins' ? `${coins.toLocaleString()} 🪙` : `${diamonds.toLocaleString()} 💎`}
                      </span>
                    </div>

                    {purchaseError && <p style={{ color:'#f87171', fontSize:11, textAlign:'center', marginBottom:8 }}>{purchaseError}</p>}

                    {/* Shortfall notice */}
                    {purchaseCurrency === 'coins' && effCoin != null && !canAffordCoins && (
                      <p style={{ color:'rgba(251,191,36,0.7)', fontSize:11, textAlign:'center', marginBottom:8 }}>
                        Need {(effCoin - coins).toLocaleString()} more coins
                      </p>
                    )}
                    {purchaseCurrency === 'diamonds' && rawDiamond != null && !canAffordDiamonds && (
                      <p style={{ color:'rgba(103,232,249,0.7)', fontSize:11, textAlign:'center', marginBottom:8 }}>
                        Need {(rawDiamond - diamonds).toLocaleString()} more diamonds
                      </p>
                    )}

                    <button onClick={handlePurchase} disabled={
                      purchasing ||
                      (purchaseCurrency==='coins' && (!canAffordCoins || effCoin==null)) ||
                      (purchaseCurrency==='diamonds' && (!canAffordDiamonds || rawDiamond==null))
                    } style={{
                      width:'100%', padding:'13px',
                      borderRadius:12, border:'none',
                      background: purchasing ? 'rgba(255,255,255,0.08)'
                        : purchaseCurrency==='coins' && canAffordCoins ? 'linear-gradient(135deg, #b45309, #92400e)'
                        : purchaseCurrency==='diamonds' && canAffordDiamonds ? 'linear-gradient(135deg, #0e7490, #164e63)'
                        : 'rgba(255,255,255,0.06)',
                      color: (purchaseCurrency==='coins' && canAffordCoins) || (purchaseCurrency==='diamonds' && canAffordDiamonds) ? '#fff' : 'rgba(255,255,255,0.3)',
                      fontWeight:800, fontSize:14, cursor: purchasing ? 'not-allowed' : 'pointer',
                      fontFamily:"'Quicksand',sans-serif",
                      boxShadow: (purchaseCurrency==='coins' && canAffordCoins) ? '0 4px 20px rgba(180,83,9,0.4)' : 'none',
                      transition:'all 0.2s',
                      display:'flex', alignItems:'center', justifyContent:'center', gap:8,
                    }}>
                      {purchasing ? (
                        <div style={{ width:16, height:16, border:'2px solid rgba(255,255,255,0.2)', borderTopColor:'#fff', borderRadius:'50%', animation:'spin 0.8s linear infinite' }} />
                      ) : purchaseCurrency==='coins' && effCoin != null ? (
                        <><Coins size={16} />Buy for {effCoin.toLocaleString()} coins</>
                      ) : rawDiamond != null ? (
                        <><Gem size={15} />Buy for {rawDiamond.toLocaleString()} diamonds</>
                      ) : 'Not for sale'}
                    </button>
                  </>
                )}
              </div>
            </div>
          </div>
        </div>
      </div>
      <style>{`@keyframes spin { to { transform: rotate(360deg); } }`}</style>
    </>
  );
};
================================================================================
FILE: src/components/chemcity/QuizRewardModal.tsx
================================================================================

import React, { useEffect, useMemo, useState } from 'react';
import { useChemCityStore } from '../../store/chemcityStore';

function clamp(n: number, min: number, max: number) {
  return Math.max(min, Math.min(max, n));
}

function animateNumber(from: number, to: number, durationMs: number, onTick: (v: number) => void) {
  const start = performance.now();
  const delta = to - from;

  function step(now: number) {
    const t = clamp((now - start) / durationMs, 0, 1);
    const eased = 1 - Math.pow(1 - t, 3);
    onTick(Math.floor(from + delta * eased));
    if (t < 1) requestAnimationFrame(step);
  }

  requestAnimationFrame(step);
}

export const QuizRewardModal: React.FC = () => {
  const quizReward = useChemCityStore((s) => s.quizReward);
  const clearQuizReward = useChemCityStore((s) => s.clearQuizReward);

  const isOpen = !!quizReward?.result;
  const result = quizReward.result;

  const [coinsDisplay, setCoinsDisplay] = useState(0);
  const [diamondsDisplay, setDiamondsDisplay] = useState(0);

  const coinsFinal = result?.coinsAwarded ?? 0;
  const diamondsFinal = result?.diamondsAwarded ?? 0;

  useEffect(() => {
    if (!isOpen) return;
    setCoinsDisplay(0);
    setDiamondsDisplay(0);

    animateNumber(0, coinsFinal, 700, setCoinsDisplay);
    animateNumber(0, diamondsFinal, 900, setDiamondsDisplay);
  }, [coinsFinal, diamondsFinal, isOpen]);

  const breakdown = useMemo(() => {
    const b = (result as any)?.breakdown;
    if (!b || typeof b !== 'object') return null;
    return {
      flatBonus: Number(b.flatBonus ?? 0),
      afterSchool: Number(b.afterSchool ?? 0),
      afterBeach: Number(b.afterBeach ?? 0),
      didDouble: Boolean((result as any)?.didDouble),
    };
  }, [result]);

  if (!isOpen || !result) return null;

  return (
    <>
      <div className="fixed inset-0 bg-black/70 z-[60]" onClick={clearQuizReward} />
      <div className="fixed inset-x-4 top-24 z-[70] bg-slate-900 border border-slate-700 rounded-2xl overflow-hidden shadow-2xl">
        <div className="p-4 border-b border-slate-700 flex items-center justify-between">
          <div>
            <h3 className="text-white font-bold text-base">Quiz Rewards</h3>
            <p className="text-slate-400 text-xs">No cards drop from quizzes</p>
          </div>
          <button
            onClick={clearQuizReward}
            className="w-8 h-8 flex items-center justify-center rounded-lg bg-slate-800 text-slate-400 hover:text-white text-lg"
            aria-label="Close"
          >
            ×
          </button>
        </div>

        <div className="p-4 flex flex-col gap-4">
          <div className="grid grid-cols-2 gap-3">
            <div className="bg-slate-800 border border-slate-700 rounded-xl p-3">
              <p className="text-slate-400 text-xs">Coins</p>
              <p className="text-yellow-300 font-black text-2xl tabular-nums">{coinsDisplay.toLocaleString()} 🪙</p>
            </div>
            <div className="bg-slate-800 border border-slate-700 rounded-xl p-3">
              <p className="text-slate-400 text-xs">Diamonds</p>
              <p className="text-cyan-300 font-black text-2xl tabular-nums">{diamondsDisplay.toLocaleString()} 💎</p>
            </div>
          </div>

          {breakdown && (
            <div className="bg-slate-800/50 border border-slate-700 rounded-xl p-3">
              <p className="text-slate-300 text-xs font-semibold mb-2">Diamond breakdown</p>
              <div className="grid grid-cols-2 gap-2 text-xs">
                <div className="text-slate-400">Kitchen flat bonus</div>
                <div className="text-right text-slate-200 tabular-nums">+{breakdown.flatBonus}</div>
                <div className="text-slate-400">After School multiplier</div>
                <div className="text-right text-slate-200 tabular-nums">{breakdown.afterSchool}</div>
                <div className="text-slate-400">After Beach</div>
                <div className="text-right text-slate-200 tabular-nums">{breakdown.afterBeach}</div>
              </div>
              {breakdown.didDouble && (
                <div className="mt-2 text-emerald-300 text-xs font-semibold">Beach doubled your diamonds!</div>
              )}
            </div>
          )}

          <div className="flex justify-end">
            <button
              onClick={clearQuizReward}
              className="bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg px-4 py-2 text-sm font-bold"
            >
              Continue
            </button>
          </div>
        </div>
      </div>
    </>
  );
};

================================================================================
FILE: src/lib/chemcity/bonuses.ts
================================================================================

// ============================================================
// ChemCity — Bonus Engine
// Computes all 8 place skill bonuses from equipped cards.
// Called after every equip/unequip — result persisted to user doc.
//
// FORMULAS (locked — do not change):
//   Garden:       coins_per_hour = total_bonus × 10
//   Lab:          multiplier = 1 + (total_bonus × 0.1)
//   Kitchen:      bonus_diamonds = total_bonus × random(1,3)  [max stored]
//   School:       multiplier = 1 + (total_bonus × 0.1)
//   Beach:        chance% = min(total_bonus × 5, 100)
//   Toilet:       diamonds = 5 + (total_bonus × 2)
//   Gas Station:  extra_slots_count = total_bonus
//   Boutique:     discount% = min(total_bonus × 2, 50)  [capped at 50%]
// ============================================================

import type { ActiveBonuses, SlimItemDocument } from './types';

// ─── Place Skill Totals ───────────────────────────────────────

/**
 * Given the equipped map { slotId → itemId } and the full slim item
 * catalog, sum up skillContribution per place.
 */
function sumBonusByPlace(
  equipped: Record<string, string>,
  slimItems: SlimItemDocument[],
): Record<string, number> {
  const itemMap = new Map(slimItems.map((i) => [i.id, i]));
  const totals: Record<string, number> = {};

  for (const itemId of Object.values(equipped)) {
    const item = itemMap.get(itemId);
    if (!item || item.deprecated) continue;
    const place = item.placeId;
    totals[place] = (totals[place] ?? 0) + item.skillContribution;
  }

  return totals;
}

// ─── Individual Skill Formulas ────────────────────────────────

/** Garden — base passive coin income per hour */
export function calcGardenCoinsPerHour(totalBonus: number): number {
  return totalBonus * 10;
}

/** Lab — passive income multiplier applied to Garden base */
export function calcLabMultiplier(totalBonus: number): number {
  return 1 + totalBonus * 0.1;
}

/** Kitchen — flat diamond bonus per quiz (returns the MAX of the range) */
export function calcKitchenMaxDiamonds(totalBonus: number): number {
  return totalBonus * 3; // range is (1×bonus) to (3×bonus); store max
}

/** Kitchen — roll the actual bonus at quiz time */
export function rollKitchenBonus(totalBonus: number): number {
  if (totalBonus === 0) return 0;
  const min = totalBonus * 1;
  const max = totalBonus * 3;
  return Math.floor(Math.random() * (max - min + 1)) + min;
}

/** School — quiz diamond multiplier */
export function calcSchoolMultiplier(totalBonus: number): number {
  return 1 + totalBonus * 0.1;
}

/** Beach — chance % to double quiz diamonds (capped at 100%) */
export function calcBeachDoubleChance(totalBonus: number): number {
  return Math.min(totalBonus * 5, 100);
}

/** Beach — roll whether diamonds are doubled at quiz time */
export function rollBeachDouble(totalBonus: number): boolean {
  return Math.random() * 100 < calcBeachDoubleChance(totalBonus);
}

/** Toilet — diamonds awarded on daily login */
export function calcToiletLoginDiamonds(totalBonus: number): number {
  return 5 + totalBonus * 2;
}

/** Gas Station — number of extra slots available to distribute */
export function calcGasStationExtraSlots(totalBonus: number): number {
  return totalBonus;
}

/** Boutique — shop discount % (capped at 50%) */
export function calcBoutiqueDiscount(totalBonus: number): number {
  return Math.min(totalBonus * 2, 50);
}

// ─── Quiz Diamond Chain ───────────────────────────────────────

/**
 * Full quiz diamond chain:
 *   base → + Kitchen flat → × School multiplier → Beach double chance
 *
 * Called by the quizReward Cloud Function — NOT the client.
 * Exposed here for unit tests and the Cloud Function to import.
 */
export function computeQuizDiamonds(
  baseDiamonds: number,
  bonuses: ActiveBonuses,
): number {
  let total = baseDiamonds;

  // Step 1: Kitchen flat bonus (randomised per quiz)
  const kitchenBonus = bonuses.quizFlatDiamondBonus > 0
    ? rollKitchenBonus(/* totalBonus */ bonuses.quizFlatDiamondBonus / 3)
    : 0;
  total += kitchenBonus;

  // Step 2: School multiplier
  total = Math.floor(total * bonuses.quizDiamondMultiplier);

  // Step 3: Beach double chance
  if (rollBeachDouble(bonuses.quizDoubleChancePercent / 5)) {
    total *= 2;
  }

  return Math.max(0, total);
}

// ─── Main Bonus Recompute ─────────────────────────────────────

/**
 * Recomputes all 8 active bonuses from the current equipped state.
 *
 * Call after every equip/unequip, then persist result to:
 *   users/{userId}.activeBonuses
 *
 * This is a PURE function — no Firestore reads. Fast and testable.
 */
export function computeActiveBonuses(
  equipped: Record<string, string>,
  slimItems: SlimItemDocument[],
): ActiveBonuses {
  const totals = sumBonusByPlace(equipped, slimItems);

  const gardenBonus = totals['garden'] ?? 0;
  const labBonus = totals['lab'] ?? 0;
  const kitchenBonus = totals['kitchen'] ?? 0;
  const schoolBonus = totals['school'] ?? 0;
  const beachBonus = totals['beach'] ?? 0;
  const toiletBonus = totals['toilet'] ?? 0;
  const gasStationBonus = totals['gas_station'] ?? 0;
  const boutiqueBonus = totals['lifestyle_boutique'] ?? 0;

  const gardenBase = calcGardenCoinsPerHour(gardenBonus);
  const labMult = calcLabMultiplier(labBonus);

  return {
    passiveBaseCoinsPerHour: Math.round(gardenBase * labMult),
    passiveMultiplier: labMult,
    quizFlatDiamondBonus: calcKitchenMaxDiamonds(kitchenBonus),
    quizDiamondMultiplier: calcSchoolMultiplier(schoolBonus),
    quizDoubleChancePercent: calcBeachDoubleChance(beachBonus),
    dailyLoginDiamonds: calcToiletLoginDiamonds(toiletBonus),
    extraSlotsTotal: calcGasStationExtraSlots(gasStationBonus),
    shopDiscountPercent: calcBoutiqueDiscount(boutiqueBonus),
  };
}

// ─── Shop Price Helper ────────────────────────────────────────

/**
 * Returns the discounted price of an item given active bonuses.
 * Always used before displaying prices in ChemStore.
 */
export function getShopPrice(
  baseCost: number,
  currency: 'coins' | 'diamonds',
  bonuses: ActiveBonuses,
): number {
  if (currency === 'diamonds') return baseCost; // diamonds never discounted
  const discount = bonuses.shopDiscountPercent / 100;
  return Math.max(1, Math.floor(baseCost * (1 - discount)));
}

================================================================================
FILE: src/lib/chemcity/cloudFunctions.ts
================================================================================

import { getFunctions, httpsCallable } from 'firebase/functions';
import type {
  EquipCardRequest,
  UnequipCardRequest,
  PurchaseCardRequest,
  UnlockPlaceRequest,
  UnlockSlotRequest,
  QuizRewardRequest,
  QuizRewardResult,
} from './types';

function getFns() {
  return getFunctions(undefined, 'asia-east1');
}

export async function callChemCityInitUser(): Promise<void> {
  const fn = httpsCallable(getFns(), 'chemcityInitUser');
  await fn({});
}

export async function callChemCityEquipCard(slotId: string, itemId: string): Promise<void> {
  const fn = httpsCallable<EquipCardRequest, { ok?: boolean }>(getFns(), 'chemcityEquipCard');
  await fn({ slotId, itemId });
}

export async function callChemCityUnequipCard(slotId: string): Promise<void> {
  const fn = httpsCallable<UnequipCardRequest, { ok?: boolean }>(getFns(), 'chemcityUnequipCard');
  await fn({ slotId });
}

export async function callChemCityCollectPassiveIncome(): Promise<{ coinsAwarded: number } & Record<string, unknown>> {
  const fn = httpsCallable<{}, { coinsAwarded: number } & Record<string, unknown>>(
    getFns(),
    'chemcityCollectPassiveIncome',
  );
  const result = await fn({});
  return result.data;
}

export async function callChemCityGetDailyLoginBonus(): Promise<Record<string, unknown>> {
  const fn = httpsCallable(getFns(), 'chemcityGetDailyLoginBonus');
  const result = await fn({});
  return result.data as Record<string, unknown>;
}

export async function callChemCityPurchaseCard(itemId: string, currency: 'coins' | 'diamonds'): Promise<void> {
  const fn = httpsCallable<PurchaseCardRequest, { ok?: boolean }>(getFns(), 'chemcityPurchaseCard');
  await fn({ itemId, currency });
}

export async function callChemCityUnlockStoreSlot(): Promise<Record<string, unknown>> {
  const fn = httpsCallable(getFns(), 'chemcityUnlockStoreSlot');
  const result = await fn({});
  return result.data as Record<string, unknown>;
}

export async function callChemCityUnlockPlace(placeId: string): Promise<void> {
  const fn = httpsCallable<UnlockPlaceRequest, { ok?: boolean }>(getFns(), 'chemcityUnlockPlace');
  await fn({ placeId });
}

export async function callChemCityUnlockSlot(
  placeId: string,
  slotId: string,
  useExtraSlotBudget?: boolean,
): Promise<void> {
  const fn = httpsCallable<UnlockSlotRequest, { ok?: boolean }>(getFns(), 'chemcityUnlockSlot');
  await fn({ placeId, slotId, useExtraSlotBudget });
}

export async function callChemCityQuizReward(req: QuizRewardRequest): Promise<QuizRewardResult> {
  const fn = httpsCallable<QuizRewardRequest, QuizRewardResult>(getFns(), 'chemcityQuizReward');
  const result = await fn(req);
  return result.data;
}

export interface ClaimCollectionRewardResult {
  ok: boolean;
  coinsAwarded: number;
  diamondsAwarded: number;
}

export async function callChemCityClaimCollectionReward(
  collectionId: string,
): Promise<ClaimCollectionRewardResult> {
  const fn = httpsCallable<{ collectionId: string }, ClaimCollectionRewardResult>(
    getFns(),
    'chemcityClaimCollectionReward',
  );
  const result = await fn({ collectionId });
  return result.data;
}

// ─── Phase 4 aliases (used by the Phase 4 handoff code) ───────────────────────

export const callPurchaseCard = (req: PurchaseCardRequest) =>
  callChemCityPurchaseCard(req.itemId, req.currency).then(() => ({ success: true }));

export const callUnlockPlace = (req: UnlockPlaceRequest) =>
  callChemCityUnlockPlace(req.placeId).then(() => ({ success: true, coinsDeducted: 0 }));

export const callUnlockSlot = (req: UnlockSlotRequest) =>
  httpsCallable<UnlockSlotRequest, { ok?: boolean }>(getFns(), 'chemcityUnlockSlot')(req).then((r) => ({
    success: true,
    ...((r.data as any) ?? {}),
  }));

export const callUnlockStoreSlot = (_req: Record<string, never>) =>
  callChemCityUnlockStoreSlot().then((data: any) => ({
    success: true,
    newSlotCount: data?.newSlotCount ?? data?.storeSlotCount ?? 0,
    coinsDeducted: data?.coinsDeducted ?? data?.cost ?? 0,
  }));

================================================================================
FILE: src/lib/chemcity/dailyStore.ts
================================================================================

// ============================================================
// dailyStore.ts — Daily rotating ChemStore logic
// ============================================================

import type { SlimItemDocument } from './types';

export const STORE_SLOT_UNLOCK_COSTS: Record<number, number> = {
  4: 1_000,
  5: 2_500,
  6: 5_000,
};
export const STORE_MIN_SLOTS = 3;
export const STORE_MAX_SLOTS = 6;

const RARITY_WEIGHT: Record<string, number> = {
  common: 60,
  rare: 25,
  epic: 12,
  legendary: 3,
};

function rarityWeight(item: SlimItemDocument): number {
  return RARITY_WEIGHT[item.rarity] ?? 60;
}

function makePrng(seed: number): () => number {
  let s = seed >>> 0;
  return () => {
    s += 0x6d2b79f5;
    let t = Math.imul(s ^ (s >>> 15), 1 | s);
    t = (t + Math.imul(t ^ (t >>> 7), 61 | t)) >>> 0;
    return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
  };
}

function hashString(str: string): number {
  let h = 5381;
  for (let i = 0; i < str.length; i++) {
    h = (Math.imul(h, 33) ^ str.charCodeAt(i)) >>> 0;
  }
  return h;
}

export function utcDateString(date: Date = new Date()): string {
  const y = date.getUTCFullYear();
  const m = String(date.getUTCMonth() + 1).padStart(2, '0');
  const d = String(date.getUTCDate()).padStart(2, '0');
  return `${y}-${m}-${d}`;
}

export function msUntilUtcMidnight(now: Date = new Date()): number {
  const tomorrow = new Date(now);
  tomorrow.setUTCHours(24, 0, 0, 0);
  return tomorrow.getTime() - now.getTime();
}

export function countdownToMidnight(now: Date = new Date()): string {
  const ms = msUntilUtcMidnight(now);
  const h = Math.floor(ms / 3_600_000);
  const m = Math.floor((ms % 3_600_000) / 60_000);
  if (h > 0) return `${h}h ${m}m`;
  const s = Math.floor((ms % 60_000) / 1_000);
  return `${m}m ${s}s`;
}

export function getDailyStoreItems(
  userId: string,
  slimItems: SlimItemDocument[],
  slotCount: number,
  dateOverride?: Date,
): SlimItemDocument[] {
  const n = Math.max(STORE_MIN_SLOTS, Math.min(STORE_MAX_SLOTS, slotCount));

  const pool = slimItems.filter(
    (item) =>
      !item.deprecated &&
      (item.shopData?.coinCost != null || item.shopData?.diamondCost != null),
  );

  if (pool.length === 0) return [];
  if (pool.length <= n) return [...pool];

  const seed = hashString(userId + utcDateString(dateOverride));
  const rand = makePrng(seed);

  const selected: SlimItemDocument[] = [];
  const remaining = [...pool];

  for (let i = 0; i < n && remaining.length > 0; i++) {
    const weights = remaining.map(rarityWeight);
    const total = weights.reduce((a, b) => a + b, 0);
    let pick = rand() * total;

    let chosenIdx = remaining.length - 1;
    for (let j = 0; j < weights.length; j++) {
      pick -= weights[j];
      if (pick <= 0) {
        chosenIdx = j;
        break;
      }
    }

    selected.push(remaining[chosenIdx]);
    remaining.splice(chosenIdx, 1);
  }

  return selected;
}

================================================================================
FILE: src/lib/chemcity/income.ts
================================================================================

import type { ActiveBonuses } from "./types";
import { Timestamp } from "firebase/firestore";

export const MAX_OFFLINE_HOURS = 24;

export function estimateUnclaimedCoins(
  activeBonuses: ActiveBonuses,
  lastCollected: Timestamp | null
): number {
  if (!lastCollected || activeBonuses.passiveBaseCoinsPerHour === 0) return 0;

  const nowMs = Date.now();
  const lastMs = lastCollected.toMillis();
  const elapsedHours = Math.min(
    (nowMs - lastMs) / (1000 * 60 * 60),
    MAX_OFFLINE_HOURS
  );

  return Math.floor(activeBonuses.passiveBaseCoinsPerHour * elapsedHours);
}

export function formatCoinsPerHour(coinsPerHour: number): string {
  if (coinsPerHour === 0) return "0 🪙/hr";
  if (coinsPerHour >= 1000) return `${(coinsPerHour / 1000).toFixed(1)}k 🪙/hr`;
  return `${Math.round(coinsPerHour)} 🪙/hr`;
}

================================================================================
FILE: src/lib/chemcity/shop.ts
================================================================================

import type { ActiveBonuses } from './types';

export function getEffectiveCoinPrice(
  rawCoinPrice: number,
  bonuses: ActiveBonuses | null | undefined,
): number {
  const discount = bonuses?.shopDiscountPercent ?? 0;
  if (discount <= 0) return rawCoinPrice;
  const discounted = rawCoinPrice * (1 - discount / 100);
  return Math.max(1, Math.floor(discounted));
}

export function getDisplayPrice(
  rawCoinPrice: number | undefined,
  rawDiamondPrice: number | undefined,
  currency: 'coins' | 'diamonds',
  bonuses: ActiveBonuses | null | undefined,
): number | null {
  if (currency === 'coins') {
    if (rawCoinPrice == null) return null;
    return getEffectiveCoinPrice(rawCoinPrice, bonuses);
  }
  return rawDiamondPrice ?? null;
}

export function canAffordItem(
  rawCoinPrice: number | undefined,
  rawDiamondPrice: number | undefined,
  currency: 'coins' | 'diamonds',
  userCoins: number,
  userDiamonds: number,
  bonuses: ActiveBonuses | null | undefined,
): boolean {
  if (currency === 'coins') {
    if (rawCoinPrice == null) return false;
    return userCoins >= getEffectiveCoinPrice(rawCoinPrice, bonuses);
  }
  if (rawDiamondPrice == null) return false;
  return userDiamonds >= rawDiamondPrice;
}

================================================================================
FILE: src/lib/chemcity/types.ts
================================================================================

// ============================================================
// ChemCity — TypeScript Types
// Single source of truth for all data shapes.
// DO NOT change field names once users have data in Firestore.
// ============================================================

// ─── Item Documents ──────────────────────────────────────────

/**
 * Slim fields only — what is cached in localStorage.
 * ~170 bytes per card. Never includes educational content.
 */
export interface SlimItemDocument {
  id: string;                  // e.g. "item_nacl"
  name: string;                // e.g. "Salt"
  chemicalFormula: string;     // e.g. "NaCl" (Unicode subscripts)
  emoji: string;               // e.g. "🧂"
  imageUrl?: string;
  rarity: 'common' | 'rare' | 'epic' | 'legendary';
  rarityValue: 1 | 2 | 3 | 4;
  placeId: PlaceId;            // which city location this belongs to
  validSlots: string[];        // slot IDs within that place
  shopData: {
    coinCost?: number;         // undefined = not coin-purchasable
    diamondCost?: number;      // undefined = not diamond-purchasable
  };
  skillContribution: number;   // this card's bonus value added to its place's skill total
  collections: string[];       // collection group IDs only — not full objects
  deprecated: boolean;         // true = hidden from UI, never delete the row
}

/**
 * Full fields — fetched from Firestore on card detail tap only.
 * ~800 bytes per card. NEVER stored in localStorage.
 */
export interface FullItemDocument extends SlimItemDocument {
  displayName: string;         // e.g. "The Seasoning of Life"
  description: string;
  cardBackground?: string;     // CSS gradient or colour token
  imageUrl?: string;
  topicConnections: string[];  // topic IDs this card relates to
  educational: {
    funFact: string;
    everydayUses: string[];
    category: 'element' | 'compound' | 'mixture' | 'process';
  };
  albumMetadata: {
    flavorText: string;
    sortOrder: number;
    tags: string[];
  };
}

// ─── Places ──────────────────────────────────────────────────

export type PlaceId =
  | 'lab'
  | 'kitchen'
  | 'toilet'
  | 'garden'
  | 'gas_station'
  | 'lifestyle_boutique'
  | 'beach'
  | 'school';

export interface SlotDocument {
  slotId: string;
  unlockCost?: number;         // undefined = free by default
  unlockCurrency?: 'coins' | 'diamonds';
  budgetOnly?: boolean;        // if true, can only be unlocked via extraSlotsBudget
  equippedItemId?: string;     // null = empty
}

export interface PlaceDocument {
  id: PlaceId;
  displayName: string;
  emoji: string;
  unlockCost: number;          // coin cost to unlock the place itself
  slots: SlotDocument[];
  skill: {
    description: string;
    formula: string;           // human-readable formula string for display
  };
}

// ─── User Documents ──────────────────────────────────────────

/**
 * Main user document — users/{userId}
 * Kept lean: only IDs and numbers, never full objects.
 */
export interface UserChemCityData {
  userId: string;
  currencies: {
    coins: number;
    diamonds: number;
  };
  storeSlotCount: number;
  ownedItems: string[];        // array of item IDs only
  equipped: {
    [slotId: string]: string;  // slotId → itemId
  };
  activeBonuses: ActiveBonuses;
  unlockedPlaces: PlaceId[];
  unlockedSlots: string[];     // slot IDs unlocked by the user
  extraSlotsBudget: number;    // remaining Gas Station bonus slots to distribute
  passiveIncome: {
    lastCollected: Date | null; // Firestore Timestamp — set by server
  };
  streaks: {
    currentStreak: number;
    longestStreak: number;
    lastLoginDate: string;     // ISO date string YYYY-MM-DD
    streakFreezeCount: number;
  };
  cacheVersion: number;        // last known version when user doc was written
  createdAt: Date;
  updatedAt: Date;
}

/**
 * Progress sub-document — users/{userId}/progress/data
 * Separated to protect the 1MB Firestore doc limit.
 */
export interface UserProgressData {
  collections: {
    [collectionId: string]: {
      collected: number;
      total: number;
      completed: boolean;
      rewardClaimed: boolean;
    };
  };
  topicMastery: {
    [topicId: string]: {
      quizzesCompleted: number;
      correctAnswers: number;
      totalQuestions: number;
    };
  };
}

// ─── Bonus Engine ─────────────────────────────────────────────

/**
 * Computed bonuses — recalculated after every equip/unequip.
 * Persisted to user doc so they're available instantly on load.
 */
export interface ActiveBonuses {
  passiveBaseCoinsPerHour: number;      // Garden: total_bonus × 10
  passiveMultiplier: number;            // Lab:    1 + (total_bonus × 0.1)
  quizFlatDiamondBonus: number;         // Kitchen: total_bonus × random(1,3) — stored as max
  quizDiamondMultiplier: number;        // School: 1 + (total_bonus × 0.1)
  quizDoubleChancePercent: number;      // Beach:  min(total_bonus × 5, 100)
  dailyLoginDiamonds: number;           // Toilet: 5 + (total_bonus × 2)
  extraSlotsTotal: number;              // Gas Station: total_bonus
  shopDiscountPercent: number;          // Boutique: min(total_bonus × 2, 50) — capped at 50%
}

// ─── Cache ────────────────────────────────────────────────────

export interface CacheManifest {
  version: number;
  fetchedAt: number;           // Date.now() timestamp
  itemIds: string[];           // IDs of what's cached
}

// ─── Collections ─────────────────────────────────────────────

export interface CollectionDocument {
  id: string;
  displayName: string;
  description: string;
  itemIds: string[];
  rewardCoins?: number;
  rewardDiamonds?: number;
}

// ─── Topics ──────────────────────────────────────────────────

export interface TopicDocument {
  id: string;
  name: string;
  dseUnit: string;
  description?: string;
}

// ─── Cloud Function Request/Response Types ────────────────────

export interface EquipCardRequest {
  slotId: string;
  itemId: string;
}

export interface UnequipCardRequest {
  slotId: string;
}

export interface PurchaseCardRequest {
  itemId: string;
  currency: 'coins' | 'diamonds';
}

export interface UnlockPlaceRequest {
  placeId: string;
}

export interface UnlockSlotRequest {
  placeId: string;
  slotId: string;
  useExtraSlotBudget?: boolean;
}

export interface QuizRewardRequest {
  baseCoins: number;
  baseDiamonds: number;
  topicId?: string;
  correctAnswers?: number;
  totalQuestions?: number;
}

export interface QuizRewardResult {
  coinsAwarded: number;
  diamondsAwarded: number;
  didDouble?: boolean;
  breakdown?: {
    flatBonus: number;
    afterSchool: number;
    afterBeach: number;
  };
  ok?: boolean;
}

================================================================================
FILE: src/store/chemcityStore.ts
================================================================================

import { create } from 'zustand';
import { doc, getDoc, onSnapshot, type Unsubscribe } from 'firebase/firestore';
import { db } from '../firebase/config';
import { fetchSlimItems, fetchPlaces, fetchFullItem, fetchCollections } from '../lib/cache';
import type {
  UserChemCityData,
  UserProgressData,
  SlimItemDocument,
  PlaceDocument,
  FullItemDocument,
  CollectionDocument,
} from '../lib/chemcity/types';
import {
  callChemCityInitUser,
  callChemCityEquipCard,
  callChemCityUnequipCard,
  callChemCityCollectPassiveIncome,
  callChemCityUnlockPlace,
  callChemCityUnlockSlot,
  callChemCityGetDailyLoginBonus,
  callChemCityQuizReward,
  callChemCityPurchaseCard,
  callChemCityUnlockStoreSlot,
  callChemCityClaimCollectionReward,
} from '../lib/chemcity/cloudFunctions';
import { estimateUnclaimedCoins } from '../lib/chemcity/income';
import { getDailyStoreItems, STORE_MIN_SLOTS } from '../lib/chemcity/dailyStore';
import type { QuizRewardRequest, QuizRewardResult } from '../lib/chemcity/types';

const ONBOARDING_STORAGE_KEY = 'chemcity_onboarding_done_v1';

function hasSeenOnboarding(): boolean {
  try {
    return localStorage.getItem(ONBOARDING_STORAGE_KEY) === '1';
  } catch {
    return false;
  }
}

function markOnboardingDone(): void {
  try {
    localStorage.setItem(ONBOARDING_STORAGE_KEY, '1');
  } catch {
    // ignore
  }
}

type View = 'map' | 'place' | 'inventory' | 'store' | 'gas_station_distributor' | 'collections';

type RootUserDoc = {
  chemcity?: UserChemCityData;
} & Record<string, unknown>;

interface ChemCityStore {
  user: UserChemCityData | null;
  progress: UserProgressData | null;
  slimItems: SlimItemDocument[];
  places: PlaceDocument[];
  collections: CollectionDocument[];

  isLoading: boolean;
  error: string | null;

  view: View;
  selectedPlaceId: string | null;

  cardPickerSlotId: string | null;

  cardDetailItemId: string | null;
  cardDetailData: FullItemDocument | null;
  cardDetailLoading: boolean;

  passiveDisplayCoins: number;

  // Phase 4: store + unlock modals
  dailyStoreItems: SlimItemDocument[];
  storeSlotCount: number;
  storePurchaseItemId: string | null;
  storePurchaseData: FullItemDocument | null;
  storePurchaseLoading: boolean;
  placeUnlockModalId: string | null;

  quizReward: {
    result: QuizRewardResult | null;
    correctAnswers: number;
    totalQuestions: number;
    isAwarding: boolean;
  };

  dailyLogin: {
    diamonds: number;
    coins: number;
    streak: number;
    showModal: boolean;
    checked: boolean;
  };

  showOnboarding: boolean;

  _unsubUser: Unsubscribe | null;

  loadAll: (userId: string) => Promise<void>;
  teardown: () => void;

  navigateToMap: () => void;
  navigateToPlace: (placeId: string) => void;
  navigateToInventory: () => void;
  navigateToStore: () => void;
  navigateToGasStationDistributor: () => void;
  navigateToCollections: () => void;

  openCardPicker: (slotId: string) => void;
  closeCardPicker: () => void;

  openCardDetail: (itemId: string) => Promise<void>;
  closeCardDetail: () => void;

  equipCard: (slotId: string, itemId: string) => Promise<void>;
  unequipCard: (slotId: string) => Promise<void>;

  collectIncome: () => Promise<{ coinsAwarded: number }>;

  unlockPlace: (placeId: string) => Promise<void>;
  unlockSlot: (placeId: string, slotId: string, useExtraSlotBudget?: boolean) => Promise<void>;

  tickPassiveDisplay: () => void;

  awardQuizReward: (request: QuizRewardRequest) => Promise<void>;
  clearQuizReward: () => void;

  checkDailyLogin: () => Promise<void>;
  dismissDailyLogin: () => void;

  computeDailyStore: (userId: string) => void;
  unlockStoreSlot: () => Promise<void>;

  openPurchaseConfirm: (itemId: string) => void;
  closePurchaseConfirm: () => void;
  purchaseCard: (itemId: string, currency: 'coins' | 'diamonds') => Promise<void>;

  openPlaceUnlockModal: (placeId: string) => void;
  closePlaceUnlockModal: () => void;

  claimCollectionReward: (collectionId: string) => Promise<void>;
  dismissOnboarding: () => void;
}

export const useChemCityStore = create<ChemCityStore>((set, get) => ({
  user: null,
  progress: null,
  slimItems: [],
  places: [],
  collections: [],

  isLoading: false,
  error: null,

  view: 'map',
  selectedPlaceId: null,

  cardPickerSlotId: null,

  cardDetailItemId: null,
  cardDetailData: null,
  cardDetailLoading: false,

  passiveDisplayCoins: 0,

  dailyStoreItems: [],
  storeSlotCount: STORE_MIN_SLOTS,
  storePurchaseItemId: null,
  storePurchaseData: null,
  storePurchaseLoading: false,
  placeUnlockModalId: null,

  quizReward: {
    result: null,
    correctAnswers: 0,
    totalQuestions: 0,
    isAwarding: false,
  },

  dailyLogin: {
    diamonds: 0,
    coins: 0,
    streak: 0,
    showModal: false,
    checked: false,
  },

  showOnboarding: false,

  _unsubUser: null,

  loadAll: async (userId: string) => {
    set({ isLoading: true, error: null });
    try {
      const [slimItems, places, collections] = await Promise.all([
        fetchSlimItems(),
        fetchPlaces(),
        fetchCollections(),
      ]);

      await callChemCityInitUser();

      const userRef = doc(db, 'users', userId);
      const userSnap = await getDoc(userRef);
      const root = (userSnap.data() || {}) as RootUserDoc;
      const chemcity = (root.chemcity || null) as UserChemCityData | null;

      const progressRef = doc(db, 'users', userId, 'chemcity_progress', 'data');
      const progressSnap = await getDoc(progressRef);
      const progress = (progressSnap.data() || null) as UserProgressData | null;

      const existing = get()._unsubUser;
      if (existing) existing();

      const unsub = onSnapshot(userRef, (snap) => {
        if (!snap.exists()) return;
        const freshRoot = (snap.data() || {}) as RootUserDoc;
        const fresh = (freshRoot.chemcity || null) as UserChemCityData | null;

        // Phase 4: mirror storeSlotCount (default 3) + compute daily store items
        const slotCount = (fresh as any)?.storeSlotCount ?? STORE_MIN_SLOTS;
        const dailyStoreItems = fresh
          ? getDailyStoreItems(userId, slimItems, slotCount)
          : [];

        set({ user: fresh, storeSlotCount: slotCount, dailyStoreItems });
      });

      const progressUnsub = onSnapshot(progressRef, (snap) => {
        if (!snap.exists()) return;
        const fresh = snap.data() as UserProgressData;
        set({ progress: fresh });
      });

      const showOnboarding = (() => {
        if (hasSeenOnboarding()) return false;
        const createdAt = (chemcity as any)?.createdAt;
        if (!createdAt) return true;
        const createdMs =
          typeof createdAt?.toMillis === 'function'
            ? createdAt.toMillis()
            : typeof createdAt === 'number'
              ? createdAt
              : Date.now();
        return Date.now() - createdMs < 90_000;
      })();

      set({
        user: chemcity,
        progress,
        slimItems,
        places,
        collections,
        isLoading: false,
        passiveDisplayCoins: 0,
        storeSlotCount: (chemcity as any)?.storeSlotCount ?? STORE_MIN_SLOTS,
        dailyStoreItems: chemcity
          ? getDailyStoreItems(userId, slimItems, (chemcity as any)?.storeSlotCount ?? STORE_MIN_SLOTS)
          : [],
        showOnboarding,
        _unsubUser: (() => {
          return () => {
            unsub();
            progressUnsub();
          };
        })(),
      });

      // Phase 3: check daily login bonus (non-blocking)
      get().checkDailyLogin();

      // Phase 4: compute store (non-blocking)
      setTimeout(() => get().computeDailyStore(userId), 200);
    } catch (err: any) {
      set({ isLoading: false, error: err?.message || 'Failed to load ChemCity' });
    }
  },

  teardown: () => {
    const unsub = get()._unsubUser;
    if (unsub) unsub();
    set({ _unsubUser: null });
  },

  navigateToMap: () => set({ view: 'map', selectedPlaceId: null }),
  navigateToPlace: (placeId) => set({ view: 'place', selectedPlaceId: placeId }),
  navigateToInventory: () => set({ view: 'inventory' }),
  navigateToStore: () => set({ view: 'store' }),
  navigateToGasStationDistributor: () => set({ view: 'gas_station_distributor' }),
  navigateToCollections: () => set({ view: 'collections' }),

  openCardPicker: (slotId) => set({ cardPickerSlotId: slotId }),
  closeCardPicker: () => set({ cardPickerSlotId: null }),

  openCardDetail: async (itemId: string) => {
    set({ cardDetailItemId: itemId, cardDetailData: null, cardDetailLoading: true });
    try {
      const full = await fetchFullItem(itemId);
      set({ cardDetailData: full ?? null, cardDetailLoading: false });
    } catch {
      set({ cardDetailLoading: false });
    }
  },
  closeCardDetail: () => set({ cardDetailItemId: null, cardDetailData: null, cardDetailLoading: false }),

  equipCard: async (slotId, itemId) => {
    await callChemCityEquipCard(slotId, itemId);
  },

  unequipCard: async (slotId) => {
    await callChemCityUnequipCard(slotId);
  },

  collectIncome: async () => {
    const result = await callChemCityCollectPassiveIncome();
    set({ passiveDisplayCoins: 0 });
    return { coinsAwarded: Number(result.coinsAwarded || 0) };
  },

  unlockPlace: async (placeId) => {
    await callChemCityUnlockPlace(placeId);
  },

  unlockSlot: async (placeId, slotId, useExtraSlotBudget) => {
    await callChemCityUnlockSlot(placeId, slotId, useExtraSlotBudget);
  },

  computeDailyStore: (userId: string) => {
    const { slimItems, storeSlotCount } = get();
    if (!slimItems.length) return;
    set({ dailyStoreItems: getDailyStoreItems(userId, slimItems, storeSlotCount) });
  },

  unlockStoreSlot: async () => {
    await callChemCityUnlockStoreSlot();
  },

  openPurchaseConfirm: (itemId: string) => {
    set({ storePurchaseItemId: itemId, storePurchaseData: null, storePurchaseLoading: true });
    fetchFullItem(itemId)
      .then((data) => set({ storePurchaseData: data ?? null, storePurchaseLoading: false }))
      .catch(() => set({ storePurchaseLoading: false }));
  },

  closePurchaseConfirm: () =>
    set({ storePurchaseItemId: null, storePurchaseData: null, storePurchaseLoading: false }),

  purchaseCard: async (itemId: string, currency: 'coins' | 'diamonds') => {
    await callChemCityPurchaseCard(itemId, currency);
  },

  openPlaceUnlockModal: (placeId: string) => set({ placeUnlockModalId: placeId }),
  closePlaceUnlockModal: () => set({ placeUnlockModalId: null }),

  tickPassiveDisplay: () => {
    const user = get().user;
    if (!user) return;

    const lastCollected = (user.passiveIncome?.lastCollected ?? null) as any;
    const coins = estimateUnclaimedCoins(user.activeBonuses, lastCollected);
    set({ passiveDisplayCoins: coins });
  },

  awardQuizReward: async (request) => {
    set((s) => ({
      quizReward: {
        ...s.quizReward,
        isAwarding: true,
        result: null,
      },
    }));

    try {
      const result = await callChemCityQuizReward(request);
      set({
        quizReward: {
          result,
          correctAnswers: request.correctAnswers ?? 0,
          totalQuestions: request.totalQuestions ?? 0,
          isAwarding: false,
        },
      });
    } catch {
      set((s) => ({
        quizReward: { ...s.quizReward, isAwarding: false },
      }));
    }
  },

  clearQuizReward: () => {
    set({
      quizReward: {
        result: null,
        correctAnswers: 0,
        totalQuestions: 0,
        isAwarding: false,
      },
    });
  },

  checkDailyLogin: async () => {
    const { dailyLogin } = get();
    if (dailyLogin.checked) return;

    try {
      const result = await callChemCityGetDailyLoginBonus();
      const alreadyClaimed = Boolean((result as any)?.alreadyClaimed);
      if (alreadyClaimed) {
        set((s) => ({ dailyLogin: { ...s.dailyLogin, checked: true } }));
        return;
      }

      set({
        dailyLogin: {
          diamonds: Number((result as any)?.diamondsAwarded || 0),
          coins: Number((result as any)?.coinsAwarded || 0),
          streak: Number((result as any)?.currentStreak || 0),
          showModal: true,
          checked: true,
        },
      });
    } catch {
      set((s) => ({ dailyLogin: { ...s.dailyLogin, checked: true } }));
    }
  },

  dismissDailyLogin: () => {
    set((s) => ({ dailyLogin: { ...s.dailyLogin, showModal: false } }));
  },

  claimCollectionReward: async (collectionId: string) => {
    await callChemCityClaimCollectionReward(collectionId);
  },

  dismissOnboarding: () => {
    markOnboardingDone();
    set({ showOnboarding: false });
  },
}));

================================================================================
FILE: tests/chemcity/bonuses.test.ts
================================================================================

import {
  calcGardenCoinsPerHour,
  calcLabMultiplier,
  calcKitchenMaxDiamonds,
  calcSchoolMultiplier,
  calcBeachDoubleChance,
  calcToiletLoginDiamonds,
  calcGasStationExtraSlots,
  calcBoutiqueDiscount,
  computeActiveBonuses,
  computeQuizDiamonds,
  rollKitchenBonus,
  rollBeachDouble,
  getShopPrice,
} from "../../src/lib/chemcity/bonuses";

import type { SlimItemDocument, ActiveBonuses } from "../../src/lib/chemcity/types";

function makeItem(
  id: string,
  placeId: SlimItemDocument["placeId"],
  skillContribution: number
): SlimItemDocument {
  return {
    id,
    name: id,
    chemicalFormula: "X",
    emoji: "🧪",
    rarity: "common",
    rarityValue: 1,
    placeId,
    validSlots: [`${placeId}_slot_1`],
    shopData: { coinCost: 100 },
    skillContribution,
    collections: [],
    deprecated: false,
  };
}

describe("Garden coins per hour", () => {
  it("0 cards = 0 coins/hr", () => expect(calcGardenCoinsPerHour(0)).toBe(0));
  it("bonus 32 → 320 coins/hr", () => expect(calcGardenCoinsPerHour(32)).toBe(320));
  it("linear with bonus", () => expect(calcGardenCoinsPerHour(10)).toBe(100));
});

describe("Lab multiplier", () => {
  it("0 cards = 1.0×", () => expect(calcLabMultiplier(0)).toBe(1));
  it("bonus 12 → 2.2×", () => expect(calcLabMultiplier(12)).toBeCloseTo(2.2));
  it("bonus 10 → 2.0×", () => expect(calcLabMultiplier(10)).toBe(2.0));
});

describe("Kitchen max diamonds", () => {
  it("0 bonus = 0", () => expect(calcKitchenMaxDiamonds(0)).toBe(0));
  it("bonus 16 → 48", () => expect(calcKitchenMaxDiamonds(16)).toBe(48));
});

describe("School multiplier", () => {
  it("0 bonus = 1.0×", () => expect(calcSchoolMultiplier(0)).toBe(1));
  it("bonus 20 → 3.0×", () => expect(calcSchoolMultiplier(20)).toBe(3.0));
});

describe("Beach double chance (capped at 100)", () => {
  it("0 bonus = 0%", () => expect(calcBeachDoubleChance(0)).toBe(0));
  it("bonus 10 = 50%", () => expect(calcBeachDoubleChance(10)).toBe(50));
  it("bonus 20 = 100% (cap)", () => expect(calcBeachDoubleChance(20)).toBe(100));
  it("bonus 30 = 100% (cap enforced)", () => expect(calcBeachDoubleChance(30)).toBe(100));
  it("never exceeds 100", () => {
    for (let b = 0; b <= 50; b++) {
      expect(calcBeachDoubleChance(b)).toBeLessThanOrEqual(100);
    }
  });
});

describe("Toilet daily login", () => {
  it("0 bonus = 5 diamonds (base)", () => expect(calcToiletLoginDiamonds(0)).toBe(5));
  it("bonus 24 → 53", () => expect(calcToiletLoginDiamonds(24)).toBe(53));
  it("bonus 1 → 7", () => expect(calcToiletLoginDiamonds(1)).toBe(7));
});

describe("Gas Station extra slots", () => {
  it("0 bonus = 0 extra slots", () => expect(calcGasStationExtraSlots(0)).toBe(0));
  it("bonus 16 = 16 slots", () => expect(calcGasStationExtraSlots(16)).toBe(16));
});

describe("Boutique discount (capped at 50%)", () => {
  it("0 bonus = 0%", () => expect(calcBoutiqueDiscount(0)).toBe(0));
  it("bonus 10 = 20%", () => expect(calcBoutiqueDiscount(10)).toBe(20));
  it("bonus 24 = 48%", () => expect(calcBoutiqueDiscount(24)).toBe(48));
  it("bonus 25 = 50% (exactly at cap)", () => expect(calcBoutiqueDiscount(25)).toBe(50));
  it("bonus 30 = 50% (cap enforced)", () => expect(calcBoutiqueDiscount(30)).toBe(50));
  it("never exceeds 50%", () => {
    for (let b = 0; b <= 100; b++) {
      expect(calcBoutiqueDiscount(b)).toBeLessThanOrEqual(50);
    }
  });
});

describe("computeActiveBonuses", () => {
  it("empty equipped → defaults", () => {
    const bonuses = computeActiveBonuses({}, []);
    expect(bonuses.passiveBaseCoinsPerHour).toBe(0);
    expect(bonuses.passiveMultiplier).toBe(1);
    expect(bonuses.quizFlatDiamondBonus).toBe(0);
    expect(bonuses.quizDiamondMultiplier).toBe(1);
    expect(bonuses.quizDoubleChancePercent).toBe(0);
    expect(bonuses.dailyLoginDiamonds).toBe(5);
    expect(bonuses.extraSlotsTotal).toBe(0);
    expect(bonuses.shopDiscountPercent).toBe(0);
  });

  it("garden card contribution adds coins/hr", () => {
    const items: SlimItemDocument[] = [makeItem("item_plant", "garden", 10)];
    const bonuses = computeActiveBonuses({ garden_bed_1: "item_plant" }, items);
    expect(bonuses.passiveBaseCoinsPerHour).toBe(100);
    expect(bonuses.passiveMultiplier).toBe(1);
  });

  it("lab card multiplies garden income", () => {
    const items: SlimItemDocument[] = [
      makeItem("item_plant", "garden", 10),
      makeItem("item_flask", "lab", 10),
    ];
    const bonuses = computeActiveBonuses(
      { garden_bed_1: "item_plant", lab_bench_1: "item_flask" },
      items
    );
    expect(bonuses.passiveBaseCoinsPerHour).toBe(200);
    expect(bonuses.passiveMultiplier).toBe(2.0);
  });

  it("boutique discount is capped at 50", () => {
    const items: SlimItemDocument[] = [];
    const equipped: Record<string, string> = {};
    for (let i = 1; i <= 26; i++) {
      const id = `item_b${i}`;
      items.push(makeItem(id, "lifestyle_boutique", 1));
      equipped[`lifestyle_boutique_slot_${i}`] = id;
    }
    const bonuses = computeActiveBonuses(equipped, items);
    expect(bonuses.shopDiscountPercent).toBe(50);
  });

  it("deprecated cards do not contribute", () => {
    const item = makeItem("item_old", "garden", 10);
    item.deprecated = true;
    const bonuses = computeActiveBonuses({ garden_bed_1: "item_old" }, [item]);
    expect(bonuses.passiveBaseCoinsPerHour).toBe(0);
  });
});

describe("rollKitchenBonus", () => {
  it("0 kitchen bonus → 0", () => {
    expect(rollKitchenBonus(0)).toBe(0);
  });

  it("kitchen bonus 10 → value between 10 and 30", () => {
    for (let i = 0; i < 100; i++) {
      const result = rollKitchenBonus(10);
      expect(result).toBeGreaterThanOrEqual(10);
      expect(result).toBeLessThanOrEqual(30);
    }
  });
});

describe("rollBeachDouble", () => {
  it("0% chance → never doubles", () => {
    for (let i = 0; i < 50; i++) {
      const doubled = rollBeachDouble(0);
      expect(doubled).toBe(false);
    }
  });
});

describe("computeQuizDiamonds", () => {
  it("no bonuses: base 5 diamonds", () => {
    const ab: ActiveBonuses = {
      passiveBaseCoinsPerHour: 0,
      passiveMultiplier: 1,
      quizFlatDiamondBonus: 0,
      quizDiamondMultiplier: 1,
      quizDoubleChancePercent: 0,
      dailyLoginDiamonds: 5,
      extraSlotsTotal: 0,
      shopDiscountPercent: 0,
    };
    const r = computeQuizDiamonds(5, ab);
    expect(r).toBe(5);
  });

  it("school 2× multiplier doubles diamonds", () => {
    const ab: ActiveBonuses = {
      passiveBaseCoinsPerHour: 0,
      passiveMultiplier: 1,
      quizFlatDiamondBonus: 0,
      quizDiamondMultiplier: 2,
      quizDoubleChancePercent: 0,
      dailyLoginDiamonds: 5,
      extraSlotsTotal: 0,
      shopDiscountPercent: 0,
    };
    const r = computeQuizDiamonds(5, ab);
    expect(r).toBe(10);
  });
});

describe("getShopPrice", () => {
  it("diamonds not discounted", () => {
    const ab: ActiveBonuses = {
      passiveBaseCoinsPerHour: 0,
      passiveMultiplier: 1,
      quizFlatDiamondBonus: 0,
      quizDiamondMultiplier: 1,
      quizDoubleChancePercent: 0,
      dailyLoginDiamonds: 5,
      extraSlotsTotal: 0,
      shopDiscountPercent: 50,
    };
    expect(getShopPrice(200, "diamonds", ab)).toBe(200);
  });

  it("50% discount halves coin price", () => {
    const ab: ActiveBonuses = {
      passiveBaseCoinsPerHour: 0,
      passiveMultiplier: 1,
      quizFlatDiamondBonus: 0,
      quizDiamondMultiplier: 1,
      quizDoubleChancePercent: 0,
      dailyLoginDiamonds: 5,
      extraSlotsTotal: 0,
      shopDiscountPercent: 50,
    };
    expect(getShopPrice(200, "coins", ab)).toBe(100);
  });
});

================================================================================
FILE: tests/chemcity/phase4.test.ts
================================================================================

import {
  getDailyStoreItems,
  utcDateString,
  msUntilUtcMidnight,
  countdownToMidnight,
  STORE_SLOT_UNLOCK_COSTS,
  STORE_MIN_SLOTS,
  STORE_MAX_SLOTS,
} from '../../src/lib/chemcity/dailyStore';

import { getEffectiveCoinPrice, canAffordItem, getDisplayPrice } from '../../src/lib/chemcity/shop';

import type { SlimItemDocument, ActiveBonuses } from '../../src/lib/chemcity/types';

function makeItem(id: string, rarity: SlimItemDocument['rarity'], coinCost: number): SlimItemDocument {
  return {
    id,
    name: id,
    chemicalFormula: 'X',
    emoji: '🧪',
    rarity,
    rarityValue: { common: 1, rare: 2, epic: 3, legendary: 4 }[rarity] as any,
    placeId: 'lab',
    validSlots: ['lab_bench_1'],
    shopData: { coinCost },
    skillContribution: 0,
    collections: [],
    deprecated: false,
  };
}

function makeActiveBonuses(shopDiscountPercent: number): ActiveBonuses {
  return {
    passiveBaseCoinsPerHour: 0,
    passiveMultiplier: 1,
    quizFlatDiamondBonus: 0,
    quizDiamondMultiplier: 1,
    quizDoubleChancePercent: 0,
    dailyLoginDiamonds: 5,
    extraSlotsTotal: 0,
    shopDiscountPercent,
  };
}

const POOL = [
  ...Array.from({ length: 20 }, (_, i) => makeItem(`common_${i}`, 'common', 100)),
  ...Array.from({ length: 8 }, (_, i) => makeItem(`rare_${i}`, 'rare', 300)),
  ...Array.from({ length: 4 }, (_, i) => makeItem(`epic_${i}`, 'epic', 600)),
  ...Array.from({ length: 1 }, (_, i) => makeItem(`legendary_${i}`, 'legendary', 1000)),
];

describe('getDailyStoreItems — determinism', () => {
  const DATE = new Date('2026-03-01T12:00:00Z');

  it('returns exactly storeSlotCount items', () => {
    const items = getDailyStoreItems('user123', POOL, 3, DATE);
    expect(items).toHaveLength(3);
  });

  it('returns correct count for 6 slots', () => {
    const items = getDailyStoreItems('user123', POOL, 6, DATE);
    expect(items).toHaveLength(6);
  });

  it('same user + same date → same items (deterministic)', () => {
    const a = getDailyStoreItems('user123', POOL, 3, DATE);
    const b = getDailyStoreItems('user123', POOL, 3, DATE);
    expect(a.map((i) => i.id)).toEqual(b.map((i) => i.id));
  });

  it('different users on same date → different selections', () => {
    const a = getDailyStoreItems('user_A', POOL, 3, DATE);
    const b = getDailyStoreItems('user_B', POOL, 3, DATE);
    expect(a.map((i) => i.id).join(',')).not.toBe(b.map((i) => i.id).join(','));
  });

  it('same user on different days → different selections', () => {
    const day1 = new Date('2026-03-01T00:00:00Z');
    const day2 = new Date('2026-03-02T00:00:00Z');
    const a = getDailyStoreItems('user123', POOL, 3, day1);
    const b = getDailyStoreItems('user123', POOL, 3, day2);
    expect(a.map((i) => i.id).join(',')).not.toBe(b.map((i) => i.id).join(','));
  });

  it('no duplicate items in same day selection', () => {
    const items = getDailyStoreItems('user123', POOL, 6, DATE);
    const ids = items.map((i) => i.id);
    expect(new Set(ids).size).toBe(ids.length);
  });

  it('excludes deprecated items', () => {
    const poolWithDeprecated = [...POOL, { ...makeItem('deprecated_1', 'legendary', 500), deprecated: true }];
    for (let u = 0; u < 20; u++) {
      const items = getDailyStoreItems(`u${u}`, poolWithDeprecated, 6, DATE);
      items.forEach((item) => expect(item.deprecated).toBeFalsy());
    }
  });

  it('excludes items with no shop price', () => {
    const poolWithUnpurchasable = [...POOL, { ...makeItem('noshop_1', 'epic', 0), shopData: {} } as any];
    for (let u = 0; u < 20; u++) {
      const items = getDailyStoreItems(`u${u}`, poolWithUnpurchasable, 6, DATE);
      items.forEach((item) => {
        const hasCoin = item.shopData?.coinCost != null;
        const hasDia = item.shopData?.diamondCost != null;
        expect(hasCoin || hasDia).toBe(true);
      });
    }
  });
});

describe('utcDateString', () => {
  it('formats date as YYYY-MM-DD UTC', () => {
    expect(utcDateString(new Date('2026-03-05T23:59:59Z'))).toBe('2026-03-05');
  });

  it('rolls over at UTC midnight', () => {
    expect(utcDateString(new Date('2026-03-05T23:59:59.999Z'))).toBe('2026-03-05');
    expect(utcDateString(new Date('2026-03-06T00:00:00.000Z'))).toBe('2026-03-06');
  });
});

describe('msUntilUtcMidnight', () => {
  it('always returns a positive number', () => {
    expect(msUntilUtcMidnight()).toBeGreaterThan(0);
  });
});

describe('Store slot constants', () => {
  it('STORE_MIN_SLOTS is 3', () => expect(STORE_MIN_SLOTS).toBe(3));
  it('STORE_MAX_SLOTS is 6', () => expect(STORE_MAX_SLOTS).toBe(6));

  it('unlock costs are defined for slots 4, 5, 6', () => {
    expect(STORE_SLOT_UNLOCK_COSTS[4]).toBeGreaterThan(0);
    expect(STORE_SLOT_UNLOCK_COSTS[5]).toBeGreaterThan(STORE_SLOT_UNLOCK_COSTS[4]);
    expect(STORE_SLOT_UNLOCK_COSTS[6]).toBeGreaterThan(STORE_SLOT_UNLOCK_COSTS[5]);
  });
});

describe('getEffectiveCoinPrice', () => {
  it('no discount → original price', () => {
    expect(getEffectiveCoinPrice(200, makeActiveBonuses(0))).toBe(200);
  });

  it('50% discount halves the price', () => {
    expect(getEffectiveCoinPrice(200, makeActiveBonuses(50))).toBe(100);
  });

  it('never reduces below 1', () => {
    expect(getEffectiveCoinPrice(1, makeActiveBonuses(50))).toBe(1);
  });
});

describe('canAffordItem', () => {
  it('can afford exact coin price', () => {
    expect(canAffordItem(100, undefined, 'coins', 100, 0, makeActiveBonuses(0))).toBe(true);
  });

  it('discount makes unaffordable item affordable', () => {
    expect(canAffordItem(200, undefined, 'coins', 100, 0, makeActiveBonuses(50))).toBe(true);
  });
});

describe('getDisplayPrice', () => {
  it('coin price with 20% discount → 80', () => {
    expect(getDisplayPrice(100, undefined, 'coins', makeActiveBonuses(20))).toBe(80);
  });

  it('returns null when currency path unavailable', () => {
    expect(getDisplayPrice(undefined, 100, 'coins', makeActiveBonuses(0))).toBeNull();
    expect(getDisplayPrice(100, undefined, 'diamonds', makeActiveBonuses(0))).toBeNull();
  });
});

describe('countdownToMidnight', () => {
  it('returns a string', () => {
    expect(typeof countdownToMidnight(new Date('2026-03-05T22:30:00.000Z'))).toBe('string');
  });
});

================================================================================
FILE: tests/chemcity/phase5.test.ts
================================================================================

// tests/chemcity/phase5.test.ts
// Phase 5 — Collections Album + Onboarding tests
// Run with: npm test

import type { CollectionDocument, SlimItemDocument } from '../../src/lib/chemcity/types';

function makeSlimItem(id: string, collections: string[]): SlimItemDocument {
  return {
    id,
    name: id,
    chemicalFormula: 'H₂O',
    emoji: '💧',
    rarity: 'common',
    rarityValue: 1,
    placeId: 'lab',
    validSlots: ['lab_bench_1'],
    shopData: { coinCost: 100 },
    skillContribution: 1,
    collections,
    deprecated: false,
  };
}

function makeCollection(
  id: string,
  itemIds: string[],
  rewards?: { rewardCoins?: number; rewardDiamonds?: number },
): CollectionDocument {
  return {
    id,
    displayName: id,
    description: `Collection: ${id}`,
    itemIds,
    ...rewards,
  };
}

function computeCollectionProgress(
  collection: CollectionDocument,
  ownedItemIds: Set<string>,
): { collected: number; total: number; completed: boolean } {
  const total = collection.itemIds.length;
  const collected = collection.itemIds.filter((id) => ownedItemIds.has(id)).length;
  return { collected, total, completed: collected === total && total > 0 };
}

describe('Collection progress computation', () => {
  const col = makeCollection('acids', ['item_hcl', 'item_h2so4', 'item_hno3']);

  it('empty owned → 0 collected', () => {
    const { collected, completed } = computeCollectionProgress(col, new Set());
    expect(collected).toBe(0);
    expect(completed).toBe(false);
  });

  it('partial ownership → not completed', () => {
    const { collected, completed } = computeCollectionProgress(col, new Set(['item_hcl', 'item_h2so4']));
    expect(collected).toBe(2);
    expect(completed).toBe(false);
  });

  it('all items owned → completed', () => {
    const { collected, completed } = computeCollectionProgress(
      col,
      new Set(['item_hcl', 'item_h2so4', 'item_hno3']),
    );
    expect(collected).toBe(3);
    expect(completed).toBe(true);
  });

  it('empty collection is never completed', () => {
    const empty = makeCollection('empty', []);
    const { completed } = computeCollectionProgress(empty, new Set(['item_hcl']));
    expect(completed).toBe(false);
  });

  it('extra owned items not in collection do not count', () => {
    const owned = new Set(['item_hcl', 'item_h2so4', 'item_hno3', 'item_nacl', 'item_kcl']);
    const { collected, total } = computeCollectionProgress(col, owned);
    expect(collected).toBe(3);
    expect(total).toBe(3);
  });
});

function computeAlbumOverall(
  collections: CollectionDocument[],
  ownedItemIds: Set<string>,
): { totalComplete: number; totalCollections: number; overallPct: number } {
  let totalComplete = 0;
  for (const col of collections) {
    const { completed } = computeCollectionProgress(col, ownedItemIds);
    if (completed) totalComplete++;
  }
  const totalCollections = collections.length;
  const overallPct = totalCollections > 0 ? Math.round((totalComplete / totalCollections) * 100) : 0;
  return { totalComplete, totalCollections, overallPct };
}

describe('Album overall progress', () => {
  const cols = [
    makeCollection('acids', ['item_hcl', 'item_h2so4']),
    makeCollection('salts', ['item_nacl', 'item_kcl']),
    makeCollection('metals', ['item_fe', 'item_cu']),
  ];

  it('no collections owned → 0% overall', () => {
    const { overallPct } = computeAlbumOverall(cols, new Set());
    expect(overallPct).toBe(0);
  });

  it('one of three collections complete → 33%', () => {
    const { overallPct, totalComplete } = computeAlbumOverall(cols, new Set(['item_hcl', 'item_h2so4']));
    expect(totalComplete).toBe(1);
    expect(overallPct).toBe(33);
  });

  it('all collections complete → 100%', () => {
    const owned = new Set(['item_hcl', 'item_h2so4', 'item_nacl', 'item_kcl', 'item_fe', 'item_cu']);
    const { overallPct } = computeAlbumOverall(cols, owned);
    expect(overallPct).toBe(100);
  });

  it('empty collections list → 0%', () => {
    const { overallPct } = computeAlbumOverall([], new Set(['item_hcl']));
    expect(overallPct).toBe(0);
  });
});

type FilterState = 'all' | 'complete' | 'incomplete';

function applyCollectionFilter(
  enriched: Array<{ collection: CollectionDocument; completed: boolean }>,
  filter: FilterState,
) {
  if (filter === 'complete') return enriched.filter((e) => e.completed);
  if (filter === 'incomplete') return enriched.filter((e) => !e.completed);
  return enriched;
}

describe('Collection filter', () => {
  const acids = makeCollection('acids', ['item_hcl', 'item_h2so4']);
  const salts = makeCollection('salts', ['item_nacl', 'item_kcl']);

  const enriched = [
    { collection: acids, completed: true },
    { collection: salts, completed: false },
  ];

  it('"all" shows all collections', () => {
    expect(applyCollectionFilter(enriched, 'all')).toHaveLength(2);
  });

  it('"complete" shows only completed', () => {
    const result = applyCollectionFilter(enriched, 'complete');
    expect(result).toHaveLength(1);
    expect(result[0].collection.id).toBe('acids');
  });

  it('"incomplete" shows only incomplete', () => {
    const result = applyCollectionFilter(enriched, 'incomplete');
    expect(result).toHaveLength(1);
    expect(result[0].collection.id).toBe('salts');
  });
});

function validateClaimReward(
  collection: CollectionDocument,
  ownedItemIds: Set<string>,
  alreadyClaimed: boolean,
): { valid: boolean; reason?: string } {
  if (collection.itemIds.length === 0) {
    return { valid: false, reason: 'Collection has no items.' };
  }
  const allOwned = collection.itemIds.every((id) => ownedItemIds.has(id));
  if (!allOwned) {
    return { valid: false, reason: 'Collection not complete.' };
  }
  if (alreadyClaimed) {
    return { valid: false, reason: 'Reward already claimed.' };
  }
  return { valid: true };
}

describe('Claim collection reward validation', () => {
  const col = makeCollection('acids', ['item_hcl', 'item_h2so4'], {
    rewardCoins: 500,
    rewardDiamonds: 10,
  });

  it('valid claim when all owned + not claimed', () => {
    const result = validateClaimReward(col, new Set(['item_hcl', 'item_h2so4']), false);
    expect(result.valid).toBe(true);
  });

  it('invalid when collection incomplete', () => {
    const result = validateClaimReward(col, new Set(['item_hcl']), false);
    expect(result.valid).toBe(false);
    expect(result.reason).toContain('complete');
  });

  it('invalid when already claimed', () => {
    const result = validateClaimReward(col, new Set(['item_hcl', 'item_h2so4']), true);
    expect(result.valid).toBe(false);
    expect(result.reason).toContain('claimed');
  });

  it('invalid when collection has no items', () => {
    const empty = makeCollection('empty', []);
    const result = validateClaimReward(empty, new Set(['item_hcl']), false);
    expect(result.valid).toBe(false);
  });
});

const ONBOARDING_KEY = 'chemcity_onboarding_done_v1';

function shouldShowOnboarding(storageValue: string | null, createdAtMs: number | null, nowMs: number): boolean {
  if (storageValue === '1') return false;
  if (createdAtMs === null) return true;
  return nowMs - createdAtMs < 90_000;
}

describe('Onboarding display logic', () => {
  const NOW = 1_700_000_000_000;

  it('shows onboarding for brand new user with no storage flag', () => {
    expect(shouldShowOnboarding(null, null, NOW)).toBe(true);
  });

  it('shows onboarding for user created < 90 s ago', () => {
    expect(shouldShowOnboarding(null, NOW - 30_000, NOW)).toBe(true);
  });

  it('hides onboarding for user created > 90 s ago', () => {
    expect(shouldShowOnboarding(null, NOW - 120_000, NOW)).toBe(false);
  });

  it('hides onboarding when localStorage flag is set', () => {
    expect(shouldShowOnboarding('1', null, NOW)).toBe(false);
  });

  it('localStorage flag takes priority over creation time', () => {
    expect(shouldShowOnboarding('1', NOW - 10_000, NOW)).toBe(false);
  });
});

describe('Slim item collection field', () => {
  it('item can belong to multiple collections', () => {
    const item = makeSlimItem('item_water', ['household', 'life_essentials']);
    expect(item.collections).toContain('household');
    expect(item.collections).toContain('life_essentials');
  });

  it('item can belong to no collections', () => {
    const item = makeSlimItem('item_radon', []);
    expect(item.collections).toHaveLength(0);
  });

  it('deprecated items are excluded from collection display', () => {
    const item = makeSlimItem('item_old', ['acids']);
    item.deprecated = true;
    expect(item.deprecated).toBe(true);
  });
});

================================================================================
FILE: tests/chemcity/quizReward.test.ts
================================================================================

import { BASE_DIAMONDS_PER_QUIZ, COINS_PER_CORRECT_ANSWER } from '../../src/hooks/useQuizReward';

describe('Quiz reward constants', () => {
  it('COINS_PER_CORRECT_ANSWER is positive', () => {
    expect(COINS_PER_CORRECT_ANSWER).toBeGreaterThan(0);
  });

  it('BASE_DIAMONDS_PER_QUIZ is positive', () => {
    expect(BASE_DIAMONDS_PER_QUIZ).toBeGreaterThan(0);
  });

  it('10 correct answers produces expected base coins', () => {
    expect(10 * COINS_PER_CORRECT_ANSWER).toBe(100);
  });

  it('0 correct answers produces 0 base coins', () => {
    expect(0 * COINS_PER_CORRECT_ANSWER).toBe(0);
  });
});

describe('DailyLogin streak messages', () => {
  function milestoneMessage(streak: number): string {
    if (streak === 1) return 'Welcome back! 👋';
    if (streak === 7) return '7-day streak! 🎉';
    if (streak === 30) return '30-day legend! 🏆';
    if (streak % 10 === 0) return `${streak} days strong! ⚡`;
    return `${streak}-day streak! 🔥`;
  }

  it('streak 1 shows welcome message', () => {
    expect(milestoneMessage(1)).toBe('Welcome back! 👋');
  });

  it('streak 7 shows 7-day message', () => {
    expect(milestoneMessage(7)).toBe('7-day streak! 🎉');
  });

  it('streak 30 shows legend message', () => {
    expect(milestoneMessage(30)).toBe('30-day legend! 🏆');
  });

  it('streak 20 shows milestone message', () => {
    expect(milestoneMessage(20)).toBe('20 days strong! ⚡');
  });

  it('streak 5 shows generic streak message', () => {
    expect(milestoneMessage(5)).toBe('5-day streak! 🔥');
  });
});

