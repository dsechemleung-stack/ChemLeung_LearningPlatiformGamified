

// ========== combine-code.js ==========

import fs from 'fs';
import path from 'path';

function getAllFiles(dirPath, arrayOfFiles = []) {
  try {
    const files = fs.readdirSync(dirPath);
    console.log(`Scanning: ${dirPath}`);

    files.forEach(file => {
      const filePath = path.join(dirPath, file);

      if (fs.statSync(filePath).isDirectory()) {
        if (!file.match(/node_modules|\.git|dist|build/)) {
          arrayOfFiles = getAllFiles(filePath, arrayOfFiles);
        }
      } else {
        if (file.match(/\.(js|ts|jsx|tsx)$/)) {
          console.log(`Found: ${filePath}`);
          arrayOfFiles.push(filePath);
        }
      }
    });
  } catch (error) {
    console.error(`Error: ${error.message}`);
  }
  return arrayOfFiles;
}

console.log('Starting...\n');

const allFiles = getAllFiles('./');

console.log(`\nFound ${allFiles.length} files\n`);

if (allFiles.length === 0) {
  console.log('No JS files found!');
  process.exit(1);
}

let combinedCode = '';

allFiles.forEach(file => {
  combinedCode += `\n\n// ========== ${file} ==========\n\n`;
  combinedCode += fs.readFileSync(file, 'utf8');
});

fs.writeFileSync('combined-code.txt', combinedCode);

console.log('\nSuccess!');
console.log(`Created: combined-code.txt`);
console.log(`Total files: ${allFiles.length}`);
console.log(`Total size: ${combinedCode.length} characters`);


// ========== eslint.config.js ==========

import js from '@eslint/js'
import globals from 'globals'
import reactHooks from 'eslint-plugin-react-hooks'
import reactRefresh from 'eslint-plugin-react-refresh'
import { defineConfig, globalIgnores } from 'eslint/config'

export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{js,jsx}'],
    extends: [
      js.configs.recommended,
      reactHooks.configs.flat.recommended,
      reactRefresh.configs.vite,
    ],
    languageOptions: {
      ecmaVersion: 2020,
      globals: globals.browser,
      parserOptions: {
        ecmaVersion: 'latest',
        ecmaFeatures: { jsx: true },
        sourceType: 'module',
      },
    },
    rules: {
      'no-unused-vars': ['error', { varsIgnorePattern: '^[A-Z_]' }],
    },
  },
])


// ========== simple-test.js ==========

console.log('Script started!');
console.log('Current directory:', process.cwd());
console.log('Script finished!');

// ========== src/App_Final.jsx ==========

import React from 'react';
import ForumPage from './pages/ForumPage';
import { BrowserRouter as Router, Routes, Route, Navigate } from 'react-router-dom';
import { AuthProvider } from './contexts/AuthContext';
import { LanguageProvider } from './contexts/LanguageContext';
import PrivateRoute from './components/PrivateRoute';
import Header from './components/Header';
import LoginPage from './pages/LoginPage';
import RegisterPage from './pages/RegisterPage';
import DashboardPage from './pages/DashboardPage_Fixed';
import TopicSelectionPage from './pages/TopicSelectionPage_Updated';
import PracticeModeSelection from './pages/PracticeModeSelection';
import QuizPage from './pages/QuizPage';
import ResultsPage from './pages/ResultsPage_Updated_Fixed';
import LeaderboardPage from './pages/LeaderboardPage';
import ProfilePage from './pages/ProfilePage';
import HistoryPage from './pages/HistoryPage_Fixed';
import MistakeNotebookPage from './pages/MistakeNotebookPage';
import FirebaseTestPage from './pages/FirebaseTestPage';
import DebugDashboard from './pages/DebugDashboard';
import { useQuizData } from './hooks/useQuizData';
import { Beaker } from 'lucide-react';
import ChemStore from './components/ChemStore';
import TokenLog from './components/TokenLog';

const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTK36yaUN-NMCkQNT-DAHgc6FMZPjUc0Yv3nYEK4TA9W2qE9V1TqVD10Tq98-wXQoAvKOZlwGWRSDkU/pub?gid=1182550140&single=true&output=csv';

function AppContent() {
  const { questions, loading, error } = useQuizData(SHEET_URL);

  if (loading) {
    return (
      <div className="flex h-screen items-center justify-center bg-gray-50">
        <div className="text-center">
          <Beaker className="animate-bounce text-academic-gold w-12 h-12 mx-auto mb-4" />
          <p className="text-academic-slate font-semibold">Loading questions...</p>
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="flex h-screen items-center justify-center bg-gray-50">
        <div className="text-center bg-white p-8 rounded-2xl shadow-xl border-2 border-red-200">
          <p className="text-red-500 font-bold mb-2">Error loading questions</p>
          <p className="text-academic-slate">{error}</p>
        </div>
      </div>
    );
  }

  return (
    <>
      <Header />
      <div className="container mx-auto px-4 py-6">
        <Routes>
          {/* Public Routes */}
          <Route path="/login" element={<LoginPage />} />
          <Route path="/register" element={<RegisterPage />} />

          {/* Protected Routes */}
          <Route
            path="/dashboard"
            element={
              <PrivateRoute>
                <DashboardPage />
              </PrivateRoute>
            }
          />
          
          {/* Practice Mode Selection - NEW */}
          <Route
            path="/"
            element={
              <PrivateRoute>
                <PracticeModeSelection questions={questions} />
              </PrivateRoute>
            }
          />
          
          {/* Legacy Topic Selection */}
          <Route
            path="/topics"
            element={
              <PrivateRoute>
                <TopicSelectionPage questions={questions} />
              </PrivateRoute>
            }
          />
          
          <Route
            path="/quiz"
            element={
              <PrivateRoute>
                <QuizPage />
              </PrivateRoute>
            }
          />
          
          <Route
            path="/results"
            element={
              <PrivateRoute>
                <ResultsPage />
              </PrivateRoute>
            }
          />
          
          <Route
            path="/leaderboard"
            element={
              <PrivateRoute>
                <LeaderboardPage />
              </PrivateRoute>
            }
          />
          
          <Route
            path="/profile"
            element={
              <PrivateRoute>
                <ProfilePage />
              </PrivateRoute>
            }
          />
          
          <Route
            path="/history"
            element={
              <PrivateRoute>
                <HistoryPage />
              </PrivateRoute>
            }
          />
          
          {/* Mistake Notebook - NEW */}
          <Route
            path="/notebook"
            element={
              <PrivateRoute>
                <MistakeNotebookPage />
              </PrivateRoute>
            }
          />
          
          <Route
            path="/forum"
            element={
              <PrivateRoute>
                <ForumPage />
              </PrivateRoute>
            }
          />

          {/* ChemStore - FIXED: Now inside Routes */}
          <Route
            path="/store"
            element={
              <PrivateRoute>
                <ChemStore />
              </PrivateRoute>
            }
          />

          {/* Token Log - FIXED: Now inside Routes */}
          <Route
            path="/token-log"
            element={
              <PrivateRoute>
                <TokenLog />
              </PrivateRoute>
            }
          />

          {/* Firebase Test Page - for debugging */}
          <Route
            path="/test-firebase"
            element={
              <PrivateRoute>
                <FirebaseTestPage />
              </PrivateRoute>
            }
          />
          
          {/* Debug Dashboard - comprehensive diagnostics */}
          <Route
            path="/debug"
            element={
              <PrivateRoute>
                <DebugDashboard />
              </PrivateRoute>
            }
          />

          {/* Catch all - redirect to dashboard */}
          <Route path="*" element={<Navigate to="/dashboard" replace />} />
        </Routes>
      </div>
    </>
  );
}

export default function App() {
  return (
    <LanguageProvider>
      <AuthProvider>
        <Router>
          <div className="min-h-screen bg-gray-50">
            <AppContent />
          </div>
        </Router>
      </AuthProvider>
    </LanguageProvider>
  );
}

// ========== src/components/AttemptDetailModal.jsx ==========

import React, { useState } from 'react';
import { X, CheckCircle2, XCircle, Clock, Info, Share2, BarChart3, MessageSquare } from 'lucide-react';
import ShareableReport from './ShareableReport';
import QuestionForum from './QuestionForum';

export default function AttemptDetailModal({ attempt, onClose }) {
  const [showShareReport, setShowShareReport] = useState(false);
  const [forumQuestion, setForumQuestion] = useState(null);

  const { questions, answers, questionTimes, correctAnswers, totalQuestions, percentage, topics, timestamp, timeSpent } = attempt;

  // If attempt doesn't have questions stored, show a limited view
  const hasFullData = questions && questions.length > 0 && answers;

  const formatTime = (ms) => {
    if (!ms) return 'N/A';
    const seconds = Math.floor(ms / 1000);
    const minutes = Math.floor(seconds / 60);
    const hrs = Math.floor(minutes / 60);
    if (hrs > 0) return `${hrs}h ${minutes % 60}m ${seconds % 60}s`;
    if (minutes > 0) return `${minutes}m ${seconds % 60}s`;
    return `${seconds}s`;
  };

  const formatDate = (iso) => {
    return new Date(iso).toLocaleDateString('en-GB', {
      day: '2-digit', month: 'short', year: 'numeric',
      hour: '2-digit', minute: '2-digit'
    });
  };

  // Topic analysis
  const analysis = hasFullData
    ? questions.reduce((acc, q) => {
        if (!acc[q.Topic]) acc[q.Topic] = { total: 0, correct: 0 };
        acc[q.Topic].total += 1;
        if (answers[q.ID] === q.CorrectOption) acc[q.Topic].correct += 1;
        return acc;
      }, {})
    : {};

  const topicResults = Object.entries(analysis).map(([topic, data]) => ({
    topic,
    percent: Math.round((data.correct / data.total) * 100),
    ...data,
  }));

  const strengths = topicResults.filter(t => t.percent >= 70);
  const weaknesses = topicResults.filter(t => t.percent < 70);

  const scoreColor =
    percentage >= 70 ? 'from-emerald-500 to-green-600'
    : percentage >= 50 ? 'from-amber-400 to-orange-500'
    : 'from-red-400 to-rose-600';

  return (
    <>
      <div className="fixed inset-0 bg-black bg-opacity-60 flex items-start justify-center z-50 p-4 overflow-y-auto">
        <div className="bg-white rounded-2xl shadow-2xl w-full max-w-4xl my-6">
          {/* Header */}
          <div className="sticky top-0 bg-white border-b-2 border-slate-200 p-5 rounded-t-2xl z-10 flex justify-between items-center">
            <div>
              <h2 className="text-2xl font-black text-slate-800">Attempt Detail</h2>
              <p className="text-sm text-slate-500 mt-0.5">{formatDate(timestamp)}</p>
            </div>
            <div className="flex items-center gap-2">
              {hasFullData && (
                <button
                  onClick={() => setShowShareReport(true)}
                  className="flex items-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-lg font-bold hover:bg-purple-700 transition-all"
                >
                  <Share2 size={16} />
                  Share
                </button>
              )}
              <button
                onClick={onClose}
                className="p-2 hover:bg-slate-100 rounded-lg transition-all"
              >
                <X size={24} />
              </button>
            </div>
          </div>

          <div className="p-6 space-y-6">
            {/* Score Banner */}
            <div className={`bg-gradient-to-r ${scoreColor} rounded-2xl p-8 text-white text-center`}>
              <div className="text-6xl font-black mb-1">{percentage}%</div>
              <div className="text-xl opacity-90">{correctAnswers} / {totalQuestions} correct</div>
              {timeSpent && (
                <div className="mt-3 flex items-center justify-center gap-2 text-white/80 text-sm">
                  <Clock size={16} />
                  <span>Total time: {formatTime(timeSpent)}</span>
                  <span>¬∑</span>
                  <span>Avg: {formatTime(timeSpent / totalQuestions)} / question</span>
                </div>
              )}
              {topics && topics.length > 0 && (
                <div className="mt-3 flex flex-wrap justify-center gap-2">
                  {topics.map(t => (
                    <span key={t} className="px-2 py-1 bg-white/20 rounded-full text-xs font-bold">{t}</span>
                  ))}
                </div>
              )}
            </div>

            {/* Strengths / Weaknesses */}
            {hasFullData && topicResults.length > 0 && (
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="bg-white p-4 rounded-xl border-2 border-slate-200">
                  <h3 className="flex items-center gap-2 font-bold text-emerald-600 mb-3">
                    <CheckCircle2 size={18} /> Strengths
                  </h3>
                  {strengths.length > 0
                    ? strengths.map(s => (
                        <div key={s.topic} className="text-sm mb-2 flex justify-between">
                          <span className="truncate mr-2">{s.topic}</span>
                          <span className="font-bold text-emerald-700">{s.percent}%</span>
                        </div>
                      ))
                    : <p className="text-sm text-slate-400 italic">Keep practicing!</p>}
                </div>
                <div className="bg-white p-4 rounded-xl border-2 border-slate-200">
                  <h3 className="flex items-center gap-2 font-bold text-amber-600 mb-3">
                    <BarChart3 size={18} /> Needs Focus
                  </h3>
                  {weaknesses.length > 0
                    ? weaknesses.map(w => (
                        <div key={w.topic} className="text-sm mb-2 flex justify-between">
                          <span className="truncate mr-2">{w.topic}</span>
                          <span className="font-bold text-amber-700">{w.percent}%</span>
                        </div>
                      ))
                    : <p className="text-sm text-slate-400 italic">No major weaknesses!</p>}
                </div>
              </div>
            )}

            {/* No full data notice */}
            {!hasFullData && (
              <div className="bg-amber-50 border-2 border-amber-200 rounded-xl p-4 text-amber-800 text-sm font-semibold">
                ‚ÑπÔ∏è Full question data is only available for attempts made after this feature was added.
              </div>
            )}

            {/* Detailed Q&A */}
            {hasFullData && (
              <div className="space-y-4">
                <h3 className="text-xl font-bold flex items-center gap-2">
                  <Info className="text-lab-blue" /> Detailed Review
                </h3>
                {questions.map((q, index) => {
                  const isCorrect = answers[q.ID] === q.CorrectOption;
                  const timeForQ = questionTimes ? questionTimes[q.ID] : null;
                  return (
                    <div
                      key={q.ID}
                      className={`p-5 rounded-xl border-l-4 bg-white shadow-sm ${isCorrect ? 'border-emerald-500' : 'border-red-500'}`}
                    >
                      <div className="flex justify-between items-start mb-3">
                        <div className="flex items-center gap-3">
                          <span className="text-xl font-black text-slate-700">Q{index + 1}</span>
                          {timeForQ && (
                            <div className="text-xs text-slate-500 flex items-center gap-1 bg-slate-100 px-2 py-1 rounded-full">
                              <Clock size={12} />
                              {formatTime(timeForQ)}
                            </div>
                          )}
                        </div>
                        <div className="flex items-center gap-2">
                          <button
                            onClick={() => setForumQuestion(q)}
                            className="flex items-center gap-1 px-3 py-1 bg-purple-100 text-purple-700 rounded-lg text-xs font-bold hover:bg-purple-200 transition-all"
                          >
                            <MessageSquare size={12} /> Discuss
                          </button>
                          {isCorrect
                            ? <CheckCircle2 className="text-emerald-500" size={22} />
                            : <XCircle className="text-red-500" size={22} />
                          }
                        </div>
                      </div>
                      <div
                        className="prose prose-slate max-w-none mb-3 text-base"
                        dangerouslySetInnerHTML={{ __html: q.Question }}
                      />
                      {q.Pictureurl && (
                        <div className="mb-3 flex justify-center">
                          <img src={q.Pictureurl} alt="Diagram" className="max-h-[180px] object-contain rounded-lg border border-slate-200" />
                        </div>
                      )}
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-2 mb-3">
                        <div className={`p-3 rounded-lg text-sm border ${isCorrect ? 'bg-green-50 border-green-200 text-green-800' : 'bg-red-50 border-red-200 text-red-800'}`}>
                          <strong>Your Answer:</strong> {answers[q.ID] || 'None'}
                        </div>
                        <div className="p-3 rounded-lg bg-blue-50 border border-blue-200 text-blue-800 text-sm">
                          <strong>Correct:</strong> {q.CorrectOption}
                        </div>
                      </div>
                      {q.Explanation && (
                        <div className="p-3 bg-slate-50 rounded-lg text-sm border border-slate-200">
                          <strong className="block mb-1 text-slate-700 flex items-center gap-1">
                            <Info size={13} /> Explanation:
                          </strong>
                          <div dangerouslySetInnerHTML={{ __html: q.Explanation }} className="text-slate-600 leading-relaxed" />
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Share Report */}
      {showShareReport && hasFullData && (
        <ShareableReport
          questions={questions}
          userAnswers={answers}
          questionTimes={questionTimes}
          onClose={() => setShowShareReport(false)}
        />
      )}

      {/* Forum */}
      {forumQuestion && (
        <QuestionForum
          question={forumQuestion}
          onClose={() => setForumQuestion(null)}
        />
      )}
    </>
  );
}

// ========== src/components/ChemStore.jsx ==========

// ============================================================================
// CHEMSTORE - Token Economy Shop
// ============================================================================

import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { useAuth } from '../contexts/AuthContext';
import { purchaseItem, equipItem } from '../services/tokenService';
import { STORE_ITEMS, RARITY_COLORS, RARITY_BORDER, RARITY_LABELS } from '../utils/storeItems';
import { ArrowLeft, ShoppingBag, Sparkles, Check, Lock, Zap } from 'lucide-react';

export default function ChemStore() {
  const navigate = useNavigate();
  const { currentUser, userProfile } = useAuth();
  const [selectedCategory, setSelectedCategory] = useState('profilePics');
  const [purchasing, setPurchasing] = useState(null);
  const [notification, setNotification] = useState(null);

  const tokens = userProfile?.tokens || 0;
  const inventory = userProfile?.inventory || [];
  const equipped = userProfile?.equipped || {};

  // Show notification
  const showNotification = (message, type = 'success') => {
    setNotification({ message, type });
    setTimeout(() => setNotification(null), 3000);
  };

  // Handle purchase
  const handlePurchase = async (item) => {
    if (purchasing) return;
    
    if (tokens < item.price) {
      showNotification('Not enough tokens! üí∏', 'error');
      return;
    }

    setPurchasing(item.id);

    try {
      const result = await purchaseItem(currentUser.uid, item.id, item.price);
      
      if (result.success) {
        showNotification(`Purchased ${item.name}! üéâ`, 'success');
      } else {
        showNotification(result.error || 'Purchase failed', 'error');
      }
    } catch (error) {
      showNotification('Purchase failed. Please try again.', 'error');
    }

    setPurchasing(null);
  };

  // Handle equip
  const handleEquip = async (item) => {
    try {
      const slot = item.category;
      const result = await equipItem(currentUser.uid, item.id, slot);
      
      if (result.success) {
        showNotification(`Equipped ${item.name}! ‚ú®`, 'success');
      } else {
        showNotification(result.error || 'Failed to equip', 'error');
      }
    } catch (error) {
      showNotification('Failed to equip item', 'error');
    }
  };

  const categories = [
    { key: 'profilePics', label: 'Profile Pics', icon: 'üé≠' },
    { key: 'badges', label: 'Badges', icon: 'üèÖ' },
    { key: 'themes', label: 'Themes', icon: 'üé®' }
  ];

  const currentItems = STORE_ITEMS[selectedCategory] || [];

  return (
    <div className="max-w-7xl mx-auto space-y-6">
      {/* Notification */}
      {notification && (
        <div className={`fixed top-20 right-4 z-50 px-6 py-3 rounded-lg shadow-2xl animate-in slide-in-from-top-2 ${
          notification.type === 'success' 
            ? 'bg-gradient-to-r from-green-500 to-emerald-600 text-white' 
            : 'bg-gradient-to-r from-red-500 to-rose-600 text-white'
        }`}>
          <p className="font-bold">{notification.message}</p>
        </div>
      )}

      {/* Header */}
      <div className="flex items-center gap-4">
        <button
          onClick={() => navigate('/dashboard')}
          className="p-3 bg-white rounded-lg border-2 border-slate-200 hover:border-lab-blue transition-all"
        >
          <ArrowLeft size={20} />
        </button>
        
        <div className="flex-1 bg-gradient-to-r from-purple-600 via-pink-600 to-orange-500 rounded-2xl shadow-2xl p-6 text-white relative overflow-hidden">
          {/* Animated background effect */}
          <div className="absolute inset-0 opacity-20">
            <div className="absolute top-0 left-0 w-40 h-40 bg-white rounded-full blur-3xl animate-pulse"></div>
            <div className="absolute bottom-0 right-0 w-60 h-60 bg-white rounded-full blur-3xl animate-pulse" style={{ animationDelay: '1s' }}></div>
          </div>
          
          <div className="relative z-10">
            <div className="flex items-center justify-between">
              <div>
                <h1 className="text-3xl font-black flex items-center gap-3 mb-2">
                  <ShoppingBag size={32} strokeWidth={3} />
                  ChemStore
                </h1>
                <p className="text-white/90 font-semibold">
                  Unlock exclusive items with your tokens
                </p>
              </div>
              
              {/* Token Balance */}
              <div className="bg-white/20 backdrop-blur-sm rounded-2xl px-6 py-4 border-2 border-white/40">
                <div className="text-sm font-bold text-white/80 mb-1">Your Balance</div>
                <div className="text-4xl font-black flex items-center gap-2">
                  <Zap size={32} className="text-yellow-300" fill="currentColor" />
                  {tokens}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* Category Tabs */}
      <div className="bg-white rounded-2xl shadow-xl border-2 border-slate-200 overflow-hidden">
        <div className="flex border-b-2 border-slate-200">
          {categories.map(cat => (
            <button
              key={cat.key}
              onClick={() => setSelectedCategory(cat.key)}
              className={`flex-1 px-6 py-4 font-bold text-base transition-all flex items-center justify-center gap-2 ${
                selectedCategory === cat.key
                  ? 'bg-gradient-to-r from-purple-600 to-pink-600 text-white'
                  : 'text-slate-600 hover:bg-slate-50'
              }`}
            >
              <span className="text-2xl">{cat.icon}</span>
              {cat.label}
            </button>
          ))}
        </div>

        {/* Items Grid */}
        <div className="p-6">
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {currentItems.map(item => {
              const owned = inventory.includes(item.id);
              const isEquipped = equipped[item.category] === item.id;
              const canAfford = tokens >= item.price;
              const isFree = item.price === 0;

              return (
                <div
                  key={item.id}
                  className={`relative bg-white rounded-2xl border-4 ${RARITY_BORDER[item.rarity]} overflow-hidden transition-all hover:scale-105 hover:shadow-2xl group`}
                >
                  {/* Rarity Badge */}
                  <div className={`absolute top-3 right-3 px-3 py-1 rounded-full text-xs font-black text-white bg-gradient-to-r ${RARITY_COLORS[item.rarity]} shadow-lg z-10 flex items-center gap-1`}>
                    <Sparkles size={12} />
                    {RARITY_LABELS[item.rarity]}
                  </div>

                  {/* Item Icon */}
                  <div className="p-8 bg-gradient-to-br from-slate-50 to-slate-100 flex items-center justify-center">
                    {item.category === 'theme' ? (
                      <div className="w-32 h-32 rounded-2xl shadow-2xl" style={{ background: item.preview }}></div>
                    ) : (
                      <div className="text-8xl group-hover:scale-110 transition-transform">
                        {item.icon}
                      </div>
                    )}
                  </div>

                  {/* Item Info */}
                  <div className="p-6">
                    <h3 className="text-xl font-black text-slate-800 mb-1">
                      {item.name}
                    </h3>
                    <p className="text-sm text-slate-600 mb-4">
                      {item.description}
                    </p>

                    {/* Price & Actions */}
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-2">
                        <Zap size={20} className="text-amber-500" fill="currentColor" />
                        <span className="text-2xl font-black text-slate-800">
                          {item.price === 0 ? 'FREE' : item.price}
                        </span>
                      </div>

                      {/* Action Buttons */}
                      {owned ? (
                        isEquipped ? (
                          <button
                            disabled
                            className="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg font-bold cursor-default"
                          >
                            <Check size={16} />
                            Equipped
                          </button>
                        ) : (
                          <button
                            onClick={() => handleEquip(item)}
                            className="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-lg font-bold hover:opacity-90 transition-all"
                          >
                            <Sparkles size={16} />
                            Equip
                          </button>
                        )
                      ) : (
                        <button
                          onClick={() => handlePurchase(item)}
                          disabled={!canAfford || purchasing === item.id}
                          className={`flex items-center gap-2 px-4 py-2 rounded-lg font-bold transition-all ${
                            canAfford
                              ? 'bg-gradient-to-r from-purple-600 to-pink-600 text-white hover:opacity-90'
                              : 'bg-slate-200 text-slate-400 cursor-not-allowed'
                          }`}
                        >
                          {purchasing === item.id ? (
                            <>
                              <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                              Buying...
                            </>
                          ) : !canAfford && !isFree ? (
                            <>
                              <Lock size={16} />
                              Locked
                            </>
                          ) : (
                            <>
                              <ShoppingBag size={16} />
                              {isFree ? 'Claim' : 'Buy'}
                            </>
                          )}
                        </button>
                      )}
                    </div>
                  </div>
                </div>
              );
            })}
          </div>

          {currentItems.length === 0 && (
            <div className="text-center py-12">
              <p className="text-slate-400 text-lg">Coming soon! üöÄ</p>
            </div>
          )}
        </div>
      </div>

      {/* Info Box */}
      <div className="bg-gradient-to-r from-blue-50 to-purple-50 border-2 border-blue-200 rounded-xl p-6">
        <h3 className="font-bold text-blue-900 mb-3 flex items-center gap-2">
          <Sparkles size={18} />
          How to Earn Tokens
        </h3>
        <ul className="space-y-2 text-sm text-blue-800">
          <li className="flex items-start gap-2">
            <span className="text-lg">‚≠ê</span>
            <span><strong>Perfect MCQ Score (100%):</strong> 10 tokens</span>
          </li>
          <li className="flex items-start gap-2">
            <span className="text-lg">üéØ</span>
            <span><strong>Excellent Score (80%+):</strong> 5 tokens</span>
          </li>
          <li className="flex items-start gap-2">
            <span className="text-lg">üëç</span>
            <span><strong>Good Score (60%+):</strong> 2 tokens</span>
          </li>
          <li className="flex items-start gap-2">
            <span className="text-lg">üìö</span>
            <span><strong>Clear Mistake:</strong> 1 token (once per question per day)</span>
          </li>
          <li className="flex items-start gap-2">
            <span className="text-lg">üèÜ</span>
            <span><strong>Leaderboard Gold:</strong> 60 tokens (weekly) / 10 tokens (daily)</span>
          </li>
          <li className="flex items-start gap-2">
            <span className="text-lg">üî•</span>
            <span><strong>Study Streaks:</strong> 15 tokens (7 days) / 50 tokens (30 days)</span>
          </li>
        </ul>
      </div>
    </div>
  );
}

// ========== src/components/FilterScreen.jsx ==========

import React, { useState, useMemo } from 'react';
import { Settings, Play, Check, Filter } from 'lucide-react';

export default function FilterScreen({ questions, onStart }) {
  const [selectedTopics, setSelectedTopics] = useState([]);
  const [selectedSubtopics, setSelectedSubtopics] = useState([]);
  const [count, setCount] = useState(10);

  // 1. Sort Topics numerically/alphabetically
  const topics = useMemo(() => {
    return [...new Set(questions.map(q => q.Topic))]
      .filter(t => t && t !== "Uncategorized")
      .sort((a, b) => a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' }));
  }, [questions]);

  // 2. Derive available subtopics based on ALL selected topics
  const availableSubtopics = useMemo(() => {
    if (selectedTopics.length === 0) return [];
    return [...new Set(questions
      .filter(q => selectedTopics.includes(q.Topic))
      .map(q => q.Subtopic))]
      .filter(Boolean)
      .sort((a, b) => a.localeCompare(b, undefined, { numeric: true }));
  }, [selectedTopics, questions]);

  const toggleTopic = (topic) => {
    setSelectedTopics(prev => 
      prev.includes(topic) ? prev.filter(t => t !== topic) : [...prev, topic]
    );
    // Reset subtopics that no longer belong to selected topics
    setSelectedSubtopics([]);
  };

  // NEW: Select all topics at once
  const selectAllTopics = () => {
    if (selectedTopics.length === topics.length) {
      // If all are selected, deselect all
      setSelectedTopics([]);
      setSelectedSubtopics([]);
    } else {
      // Select all topics
      setSelectedTopics([...topics]);
      setSelectedSubtopics([]);
    }
  };

  const toggleSubtopic = (sub) => {
    setSelectedSubtopics(prev => 
      prev.includes(sub) ? prev.filter(s => s !== sub) : [...prev, sub]
    );
  };

  const handleStart = () => {
    // Filter pool based on multiple selections
    let pool = questions.filter(q => selectedTopics.includes(q.Topic));
    
    if (selectedSubtopics.length > 0) {
      pool = pool.filter(q => selectedSubtopics.includes(q.Subtopic));
    }
    
    const shuffled = [...pool].sort(() => 0.5 - Math.random());
    const finalSelection = count === 'All' ? shuffled : shuffled.slice(0, parseInt(count));
    
    if (finalSelection.length === 0) {
      alert("No questions found for this selection. Try broader filters!");
      return;
    }
    onStart(finalSelection);
  };

  const allTopicsSelected = selectedTopics.length === topics.length;

  return (
    <div className="max-w-4xl mx-auto space-y-6 animate-in fade-in duration-500">
      <div className="bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
        <div className="bg-slate-50 p-6 border-b flex justify-between items-center">
          <h2 className="text-xl font-bold flex items-center gap-2 text-slate-800">
            <Filter size={20} className="text-lab-blue" />
            Configure Custom Session
          </h2>
          <span className="text-xs font-bold text-slate-400 bg-slate-200 px-2 py-1 rounded">
            {questions.length} Questions Loaded
          </span>
        </div>

        <div className="p-8 space-y-8">
          {/* 1. Multi-Topic Selection */}
          <div>
            <div className="flex justify-between items-center mb-4">
              <label className="block text-sm font-black text-slate-500 uppercase tracking-widest">
                1. Select Topics (Multi-choice)
              </label>
              <button
                onClick={selectAllTopics}
                className={`px-4 py-2 rounded-lg text-xs font-bold transition-all ${
                  allTopicsSelected
                    ? 'bg-lab-blue text-white hover:bg-blue-800'
                    : 'bg-slate-100 text-slate-600 hover:bg-slate-200 border border-slate-300'
                }`}
              >
                {allTopicsSelected ? '‚úì All Selected' : 'Select All Topics'}
              </button>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
              {topics.map(topic => (
                <button
                  key={topic}
                  onClick={() => toggleTopic(topic)}
                  className={`flex items-center justify-between p-3 rounded-xl border-2 transition-all ${
                    selectedTopics.includes(topic)
                    ? 'border-lab-blue bg-blue-50 text-lab-blue shadow-sm'
                    : 'border-slate-100 text-slate-600 hover:border-slate-200'
                  }`}
                >
                  <span className="text-sm font-semibold">{topic}</span>
                  {selectedTopics.includes(topic) && <Check size={16} />}
                </button>
              ))}
            </div>
          </div>

          {/* 2. Multi-Subtopic Selection */}
          {selectedTopics.length > 0 && availableSubtopics.length > 0 && (
            <div className="animate-in slide-in-from-top-4">
              <label className="block text-sm font-black text-slate-500 mb-4 uppercase tracking-widest">
                2. Focus on Subtopics
              </label>
              <div className="flex flex-wrap gap-2">
                {availableSubtopics.map(sub => (
                  <button
                    key={sub}
                    onClick={() => toggleSubtopic(sub)}
                    className={`px-4 py-2 rounded-full text-xs font-bold border-2 transition-all ${
                      selectedSubtopics.includes(sub)
                      ? 'bg-lab-blue border-lab-blue text-white'
                      : 'bg-white border-slate-200 text-slate-500 hover:border-slate-300'
                    }`}
                  >
                    {sub}
                  </button>
                ))}
              </div>
            </div>
          )}

          {/* 3. Question Count */}
          <div>
            <label className="block text-sm font-black text-slate-500 mb-4 uppercase tracking-widest">
              3. Session Length
            </label>
            <div className="grid grid-cols-3 md:grid-cols-6 gap-3">
              {['5', '10', '15', '20', '36', 'All'].map(num => (
                <button
                  key={num}
                  onClick={() => setCount(num)}
                  className={`py-3 rounded-xl border-2 font-bold transition-all ${
                    count === num ? 'border-lab-blue bg-blue-50 text-lab-blue' : 'border-slate-100 text-slate-400'
                  }`}
                >
                  {num}
                </button>
              ))}
            </div>
          </div>

          <button 
            disabled={selectedTopics.length === 0}
            onClick={handleStart}
            className="w-full py-5 bg-lab-blue text-white rounded-2xl font-black text-lg shadow-lg hover:bg-blue-800 disabled:bg-slate-200 transition-all flex items-center justify-center gap-2 active:scale-95"
          >
            <Play fill="currentColor" size={18} />
            GENERATE EXAM
          </button>
        </div>
      </div>
    </div>
  );
}

// ========== src/components/Header.jsx ==========

import React, { useState } from 'react';
import { useNavigate, useLocation } from 'react-router-dom';
import { useAuth } from '../contexts/AuthContext';
import { useLanguage } from '../contexts/LanguageContext';
import { Beaker, Home, Trophy, User, LogOut, History, ChevronDown, Menu, X, Languages, BookOpen, MessageSquare, Zap, ShoppingBag, Clock, AlertTriangle } from 'lucide-react';
import { quizStorage } from '../utils/quizStorage';

// Icon mapping
const iconMap = {
  flask_blue: 'üß™', atom_green: '‚öõÔ∏è', molecule: 'üî¨', fire: 'üî•',
  lightning: '‚ö°', crystal: 'üíé', explosion: 'üí•', star: '‚≠ê',
  crown: 'üëë', trophy: 'üèÜ'
};

export default function Header() {
    const { currentUser, logout, userProfile } = useAuth();
    const { language, toggleLanguage, isEnglish } = useLanguage();
    const navigate = useNavigate();
    const location = useLocation();
    const [showUserMenu, setShowUserMenu] = useState(false);
    const [showMobileNav, setShowMobileNav] = useState(false);
    const [showLogoutModal, setShowLogoutModal] = useState(false);

    // Get tokens from userProfile with real-time sync
    const tokens = userProfile?.tokens || 0;
    const equipped = userProfile?.equipped || {};
    const profileColor = userProfile?.profileColor || '#2563eb'; // Default blue

    if (location.pathname === '/login' || location.pathname === '/register') {
        return null;
    }

    const isInQuiz = location.pathname === '/quiz';

    async function handleLogoutConfirm() {
        try {
            await logout();
            navigate('/login');
        } catch (error) {
            console.error('Failed to log out:', error);
        }
    }

    const handleLogoutClick = () => {
        if (isInQuiz) {
            const confirmed = window.confirm(
                "Are you sure you want to logout?\n\n‚ö†Ô∏è You are in the middle of a quiz. Your progress will be lost!"
            );
            if (!confirmed) return;
            quizStorage.clearQuizData();
            handleLogoutConfirm();
        } else {
            setShowLogoutModal(true);
        }
    };

    const handleNavigation = (path) => {
        if (isInQuiz && path !== '/quiz') {
            const confirmed = window.confirm(
                "Are you sure you want to leave the quiz?\n\n‚ö†Ô∏è Your current progress will be lost!"
            );
            if (!confirmed) {
                return;
            }
            quizStorage.clearQuizData();
        }

        navigate(path);
        setShowUserMenu(false);
        setShowMobileNav(false);
    };

    const isActive = (path) => location.pathname === path;

    // Get equipped profile pic icon
    const profileIcon = equipped.profilePic || 'flask_blue';
    const displayIcon = iconMap[profileIcon] || 'üß™';

    return (
        <>
            <header className="bg-white border-b-2 border-slate-200 shadow-sm sticky top-0 z-40">
                <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div className="flex justify-between items-center h-16">
                        {/* Logo and Brand */}
                        <div className="flex items-center gap-3 cursor-pointer" onClick={() => handleNavigation('/dashboard')}>
                            <div className="bg-lab-blue p-2 rounded-lg">
                                <Beaker className="text-white" size={24} />
                            </div>
                            <div>
                                <h1 className="text-xl font-black text-lab-blue leading-tight">
                                    ChemLeung
                                </h1>
                                <p className="text-[10px] text-slate-700 font-bold -mt-1 hidden sm:block">
                                    {isEnglish ? 'HKDSE MCQ Practice Platform' : 'HKDSE MCQ Á∑¥ÁøíÂπ≥Âè∞'}
                                </p>
                            </div>
                        </div>

                        {/* Desktop Navigation Links */}
                        {currentUser && (
                            <nav className="hidden md:flex items-center gap-2">
                                <button
                                    onClick={() => handleNavigation('/dashboard')}
                                    className={`flex items-center gap-2 px-4 py-2 rounded-lg font-bold transition-all ${isActive('/dashboard')
                                            ? 'bg-lab-blue text-white shadow-md'
                                            : 'text-slate-800 hover:bg-slate-100 border-2 border-transparent hover:border-slate-200'
                                        }`}
                                >
                                    <Home size={18} />
                                    <span>{isEnglish ? 'Dashboard' : 'ÂÑÄË°®Êùø'}</span>
                                </button>
                                <button
                                    onClick={() => handleNavigation('/')}
                                    className={`flex items-center gap-2 px-4 py-2 rounded-lg font-bold transition-all ${isActive('/') || isActive('/quiz')
                                            ? 'bg-chemistry-green text-white shadow-md'
                                            : 'text-slate-800 hover:bg-slate-100 border-2 border-transparent hover:border-slate-200'
                                        }`}
                                >
                                    <Beaker size={18} />
                                    <span>{isEnglish ? 'Practice' : 'Á∑¥Áøí'}</span>
                                </button>

                                <button
                                    onClick={() => handleNavigation('/notebook')}
                                    className={`flex items-center gap-2 px-4 py-2 rounded-lg font-bold transition-all ${isActive('/notebook')
                                            ? 'bg-orange-600 text-white shadow-md'
                                            : 'text-slate-800 hover:bg-slate-100 border-2 border-transparent hover:border-slate-200'
                                        }`}
                                >
                                    <BookOpen size={18} />
                                    <span>{isEnglish ? 'Mistakes' : 'ÈåØÈ°åÁ∞ø'}</span>
                                </button>

                                <button
                                    onClick={() => handleNavigation('/forum')}
                                    className={`flex items-center gap-2 px-4 py-2 rounded-lg font-bold transition-all ${isActive('/forum')
                                            ? 'bg-purple-600 text-white shadow-md'
                                            : 'text-slate-800 hover:bg-slate-100 border-2 border-transparent hover:border-slate-200'
                                        }`}
                                >
                                    <MessageSquare size={18} />
                                    <span>{isEnglish ? 'Forum' : 'Ë´ñÂ£á'}</span>
                                </button>

                                <button
                                    onClick={() => handleNavigation('/leaderboard')}
                                    className={`flex items-center gap-2 px-4 py-2 rounded-lg font-bold transition-all ${isActive('/leaderboard')
                                            ? 'bg-amber-500 text-white shadow-md'
                                            : 'text-slate-800 hover:bg-slate-100 border-2 border-transparent hover:border-slate-200'
                                        }`}
                                >
                                    <Trophy size={18} />
                                    <span>{isEnglish ? 'Leaderboard' : 'ÊéíË°åÊ¶ú'}</span>
                                </button>
                                
                                {/* TOKEN DISPLAY */}
                                <button
                                    onClick={() => handleNavigation('/store')}
                                    className={`flex items-center gap-2 px-4 py-2 rounded-lg font-bold transition-all shadow-md ${isActive('/store')
                                            ? 'bg-gradient-to-r from-purple-600 to-pink-600 text-white'
                                            : 'bg-gradient-to-r from-amber-400 to-orange-500 text-white hover:from-amber-500 hover:to-orange-600'
                                        }`}
                                >
                                    <Zap size={18} fill="currentColor" />
                                    <span className="font-black">{tokens}</span>
                                </button>

                                <button
                                    onClick={toggleLanguage}
                                    className="flex items-center gap-2 px-4 py-2 rounded-lg font-black transition-all bg-gradient-to-r from-slate-600 to-slate-700 text-white hover:from-slate-700 hover:to-slate-800 shadow-md border-2 border-white ml-2"
                                    title={isEnglish ? 'Switch to Traditional Chinese' : 'ÂàáÊèõËá≥Ëã±Êñá'}
                                >
                                    <Languages size={18} strokeWidth={3} />
                                    <span className="text-sm">{isEnglish ? 'ÁπÅ' : 'EN'}</span>
                                </button>
                            </nav>
                        )}

                        {/* Mobile + Desktop User Menu */}
                        {currentUser && (
                            <div className="flex items-center gap-2">
                                <button
                                    onClick={() => setShowMobileNav(!showMobileNav)}
                                    className="md:hidden p-2 rounded-lg hover:bg-slate-100 transition-all"
                                >
                                    {showMobileNav ? <X size={24} /> : <Menu size={24} />}
                                </button>

                                <div className="relative">
                                    <button
                                        onClick={() => setShowUserMenu(!showUserMenu)}
                                        className="flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-slate-100 transition-all border-2 border-transparent hover:border-slate-200"
                                    >
                                        {/* Profile Icon - with equipped item and custom color */}
                                        <div 
                                            className="w-8 h-8 rounded-full flex items-center justify-center shadow-md text-lg"
                                            style={{ background: `linear-gradient(135deg, ${profileColor}, ${profileColor}dd)` }}
                                        >
                                            {displayIcon}
                                        </div>
                                        <div className="hidden sm:block text-left">
                                            <p className="text-sm font-bold text-slate-900">
                                                {currentUser.displayName || 'User'}
                                            </p>
                                            <p className="text-xs text-slate-600 truncate max-w-[150px]">
                                                {currentUser.email}
                                            </p>
                                        </div>
                                        <ChevronDown size={16} className="text-slate-600 hidden sm:block" />
                                    </button>

                                    {showUserMenu && (
                                        <>
                                            <div
                                                className="fixed inset-0 z-40"
                                                onClick={() => setShowUserMenu(false)}
                                            />
                                            <div className="absolute right-0 mt-2 w-56 bg-white rounded-xl shadow-xl border-2 border-slate-200 z-50 overflow-hidden">
                                                <button
                                                    onClick={() => handleNavigation('/profile')}
                                                    className="w-full flex items-center gap-3 px-4 py-3 hover:bg-slate-50 transition-all text-left"
                                                >
                                                    <User size={18} className="text-slate-700" />
                                                    <span className="font-bold text-slate-900">
                                                        {isEnglish ? 'Profile Settings' : 'ÂÄã‰∫∫Ë®≠ÂÆö'}
                                                    </span>
                                                </button>
                                                <button
                                                    onClick={() => handleNavigation('/history')}
                                                    className="w-full flex items-center gap-3 px-4 py-3 hover:bg-slate-50 transition-all text-left border-t border-slate-100"
                                                >
                                                    <History size={18} className="text-slate-700" />
                                                    <span className="font-bold text-slate-900">
                                                        {isEnglish ? 'My History' : 'ÊàëÁöÑÊ≠∑Âè≤'}
                                                    </span>
                                                </button>
                                                <button
                                                    onClick={() => handleNavigation('/token-log')}
                                                    className="w-full flex items-center gap-3 px-4 py-3 hover:bg-slate-50 transition-all text-left border-t border-slate-100"
                                                >
                                                    <Clock size={18} className="text-amber-500" />
                                                    <span className="font-bold text-slate-900">
                                                        {isEnglish ? 'Token History' : '‰ª£Âπ£Ê≠∑Âè≤'}
                                                    </span>
                                                </button>
                                                <button
                                                    onClick={handleLogoutClick}
                                                    className="w-full flex items-center gap-3 px-4 py-3 hover:bg-red-50 transition-all text-left border-t border-slate-100"
                                                >
                                                    <LogOut size={18} className="text-red-600" />
                                                    <span className="font-bold text-red-600">
                                                        {isEnglish ? 'Logout' : 'ÁôªÂá∫'}
                                                    </span>
                                                </button>
                                            </div>
                                        </>
                                    )}
                                </div>
                            </div>
                        )}
                    </div>
                </div>

                {/* Mobile Navigation Menu */}
                {showMobileNav && currentUser && (
                    <>
                        <div
                            className="fixed inset-0 bg-black bg-opacity-25 z-30"
                            onClick={() => setShowMobileNav(false)}
                        />
                        <div className="md:hidden fixed top-16 left-0 right-0 bg-white border-b-2 border-slate-200 shadow-xl z-40 animate-in slide-in-from-top duration-200">
                            <nav className="flex flex-col p-2">
                                {/* Token Display - Mobile */}
                                <div className="mb-2 p-3 bg-gradient-to-r from-amber-400 to-orange-500 rounded-lg">
                                    <div className="flex items-center justify-between text-white">
                                        <div className="flex items-center gap-2">
                                            <Zap size={20} fill="currentColor" />
                                            <span className="font-black text-lg">{tokens}</span>
                                            <span className="text-sm opacity-90">{isEnglish ? 'tokens' : '‰ª£Âπ£'}</span>
                                        </div>
                                        <button
                                            onClick={() => handleNavigation('/store')}
                                            className="px-3 py-1 bg-white/20 rounded-lg font-bold text-sm hover:bg-white/30"
                                        >
                                            <ShoppingBag size={16} className="inline mr-1" />
                                            {isEnglish ? 'Store' : 'ÂïÜÂ∫ó'}
                                        </button>
                                    </div>
                                </div>

                                <button
                                    onClick={() => handleNavigation('/dashboard')}
                                    className={`flex items-center gap-3 px-4 py-3 rounded-lg font-bold transition-all ${isActive('/dashboard')
                                            ? 'bg-lab-blue text-white'
                                            : 'text-slate-900 hover:bg-slate-100'
                                        }`}
                                >
                                    <Home size={20} />
                                    <span>{isEnglish ? 'Dashboard' : 'ÂÑÄË°®Êùø'}</span>
                                </button>
                                <button
                                    onClick={() => handleNavigation('/')}
                                    className={`flex items-center gap-3 px-4 py-3 rounded-lg font-bold transition-all ${isActive('/') || isActive('/quiz')
                                            ? 'bg-chemistry-green text-white'
                                            : 'text-slate-900 hover:bg-slate-100'
                                        }`}
                                >
                                    <Beaker size={20} />
                                    <span>{isEnglish ? 'Practice' : 'Á∑¥Áøí'}</span>
                                </button>
                                
                                <button
                                    onClick={() => handleNavigation('/notebook')}
                                    className={`flex items-center gap-3 px-4 py-3 rounded-lg font-bold transition-all ${isActive('/notebook')
                                            ? 'bg-orange-600 text-white'
                                            : 'text-slate-900 hover:bg-slate-100'
                                        }`}
                                >
                                    <BookOpen size={20} />
                                    <span>{isEnglish ? 'Mistake Notebook' : 'ÈåØÈ°åÁ∞ø'}</span>
                                </button>

                                <button
                                    onClick={() => handleNavigation('/forum')}
                                    className={`flex items-center gap-3 px-4 py-3 rounded-lg font-bold transition-all ${isActive('/forum')
                                            ? 'bg-purple-600 text-white'
                                            : 'text-slate-900 hover:bg-slate-100'
                                        }`}
                                >
                                    <MessageSquare size={20} />
                                    <span>{isEnglish ? 'Forum' : 'Ë´ñÂ£á'}</span>
                                </button>

                                <button
                                    onClick={() => handleNavigation('/leaderboard')}
                                    className={`flex items-center gap-3 px-4 py-3 rounded-lg font-bold transition-all ${isActive('/leaderboard')
                                            ? 'bg-amber-500 text-white'
                                            : 'text-slate-900 hover:bg-slate-100'
                                        }`}
                                >
                                    <Trophy size={20} />
                                    <span>{isEnglish ? 'Leaderboard' : 'ÊéíË°åÊ¶ú'}</span>
                                </button>
                                <button
                                    onClick={() => handleNavigation('/history')}
                                    className={`flex items-center gap-3 px-4 py-3 rounded-lg font-bold transition-all ${isActive('/history')
                                            ? 'bg-purple-600 text-white'
                                            : 'text-slate-900 hover:bg-slate-100'
                                        }`}
                                >
                                    <History size={20} />
                                    <span>{isEnglish ? 'History' : 'Ê≠∑Âè≤'}</span>
                                </button>

                                <button
                                    onClick={() => {
                                        toggleLanguage();
                                        setShowMobileNav(false);
                                    }}
                                    className="flex items-center gap-3 px-4 py-3 rounded-lg font-bold transition-all bg-gradient-to-r from-amber-400 to-orange-500 text-white hover:from-amber-500 hover:to-orange-600 mt-2 shadow-md"
                                >
                                    <Languages size={20} strokeWidth={3} />
                                    <span>{isEnglish ? 'ÁπÅÈ´î‰∏≠Êñá' : 'English'}</span>
                                </button>
                            </nav>
                        </div>
                    </>
                )}
            </header>

            {/* Logout Confirmation Modal */}
            {showLogoutModal && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-2xl shadow-2xl max-w-md w-full animate-in zoom-in duration-200">
                        <div className="p-6">
                            <div className="flex items-center gap-3 mb-4">
                                <div className="w-12 h-12 rounded-full bg-red-100 flex items-center justify-center">
                                    <AlertTriangle className="text-red-600" size={24} />
                                </div>
                                <div>
                                    <h3 className="text-xl font-black text-slate-800">
                                        {isEnglish ? 'Confirm Logout' : 'Á¢∫Ë™çÁôªÂá∫'}
                                    </h3>
                                    <p className="text-sm text-slate-500">
                                        {isEnglish ? 'Are you sure?' : 'ÊÇ®Á¢∫ÂÆöÂóéÔºü'}
                                    </p>
                                </div>
                            </div>
                            <p className="text-slate-600 mb-6">
                                {isEnglish 
                                    ? 'You will be logged out of your account. Any unsaved progress will be lost.' 
                                    : 'ÊÇ®Â∞áÁôªÂá∫Â∏≥Êà∂„ÄÇ‰ªª‰ΩïÊú™ÂÑ≤Â≠òÁöÑÈÄ≤Â∫¶Â∞áÊúÉÈÅ∫Â§±„ÄÇ'}
                            </p>
                            <div className="flex gap-3">
                                <button
                                    onClick={() => setShowLogoutModal(false)}
                                    className="flex-1 px-6 py-3 bg-slate-100 text-slate-700 rounded-xl font-bold hover:bg-slate-200 transition-all"
                                >
                                    {isEnglish ? 'Cancel' : 'ÂèñÊ∂à'}
                                </button>
                                <button
                                    onClick={() => {
                                        setShowLogoutModal(false);
                                        handleLogoutConfirm();
                                    }}
                                    className="flex-1 px-6 py-3 bg-red-600 text-white rounded-xl font-bold hover:bg-red-700 transition-all flex items-center justify-center gap-2"
                                >
                                    <LogOut size={18} />
                                    {isEnglish ? 'Logout' : 'ÁôªÂá∫'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            )}
        </>
    );
}

// ========== src/components/PrivateRoute.jsx ==========

import React from 'react';
import { Navigate } from 'react-router-dom';
import { useAuth } from '../contexts/AuthContext';

export default function PrivateRoute({ children }) {
  const { currentUser } = useAuth();
  
  return currentUser ? children : <Navigate to="/login" />;
}

// ========== src/components/QuestionCard.jsx ==========

import React, { useState } from 'react';
import { HelpCircle, MessageSquare } from 'lucide-react';
import QuestionForum from './QuestionForum';

export default function QuestionCard({ question, selectedOption, onSelect, showDiscussButton = false }) {
  const [showForum, setShowForum] = useState(false);

  // If no question is passed, or if the question object is empty, show nothing.
  if (!question || !question.Question) {
    return (
      <div className="p-8 text-center bg-white rounded-2xl border-2 border-dashed border-slate-200">
        <p className="text-slate-400 font-medium">Loading question content...</p>
      </div>
    );
  }

  // We use the keys defined in our useQuizData.js mapping
  const options = [
    { key: 'A', text: question.OptionA },
    { key: 'B', text: question.OptionB },
    { key: 'C', text: question.OptionC },
    { key: 'D', text: question.OptionD },
  ];

  // Toggle answer - if clicking the same answer again, deselect it
  const handleOptionClick = (optionKey) => {
    if (selectedOption === optionKey) {
      // Clicking the same answer again deselects it
      onSelect(null);
    } else {
      // Select the new answer
      onSelect(optionKey);
    }
  };

  return (
    <>
      <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden transition-all animate-in fade-in slide-in-from-bottom-4 duration-500">
        
        {/* Header Info Bar */}
        <div className="bg-slate-50 px-6 py-3 border-b border-slate-100 flex justify-between items-center">
          <div className="flex flex-col">
            <span className="text-[10px] font-black text-lab-blue uppercase tracking-tighter">
              {question.Topic || 'General Chemistry'}
            </span>
            <span className="text-xs text-slate-500 font-medium italic">
              {question.Subtopic}
            </span>
          </div>
          <div className="flex items-center gap-2">
            {question.DSEcode && (
              <span className="bg-blue-100 text-lab-blue px-2 py-1 rounded text-[10px] font-bold">
                {question.DSEcode}
              </span>
            )}
            {showDiscussButton && (
              <button
                onClick={() => setShowForum(true)}
                className="flex items-center gap-1 px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-bold hover:bg-purple-200 transition-all"
                title="Discuss this question"
              >
                <MessageSquare size={12} />
                <span>Discuss</span>
              </button>
            )}
          </div>
        </div>

        <div className="p-6 md:p-8">
          {/* Image Display Logic */}
          {question.Pictureurl && (
            <div className="mb-8 flex justify-center bg-white p-4 rounded-xl border border-slate-50 shadow-inner">
              <img 
                src={question.Pictureurl} 
                alt="Chemistry Diagram" 
                className="max-w-full h-auto max-h-[300px] object-contain rounded-md"
                onError={(e) => {
                  console.warn("Image load failed for URL:", question.Pictureurl);
                  e.target.parentElement.style.display = 'none';
                }}
              />
            </div>
          )}

          {/* Question Text - with whitespace-pre-wrap for line breaks */}
          <div className="mb-8">
            <div 
              className="text-lg md:text-xl font-semibold leading-relaxed text-slate-800 prose prose-slate max-w-none whitespace-pre-wrap"
              dangerouslySetInnerHTML={{ __html: question.Question }}
            />
          </div>

          {/* MCQ Options Grid */}
          <div className="grid grid-cols-1 gap-3">
            {options.map((opt) => (
              <button
                key={opt.key}
                onClick={() => handleOptionClick(opt.key)}
                className={`group flex items-center text-left p-4 rounded-xl border-2 transition-all duration-200 ${
                  selectedOption === opt.key
                    ? 'border-lab-blue bg-blue-50/50 ring-1 ring-lab-blue'
                    : 'border-slate-100 hover:border-slate-300 hover:bg-slate-50'
                }`}
              >
                {/* Option Letter Bubble */}
                <div className={`w-10 h-10 flex-shrink-0 flex items-center justify-center rounded-lg font-bold mr-4 transition-colors ${
                  selectedOption === opt.key
                    ? 'bg-lab-blue text-white'
                    : 'bg-slate-100 text-slate-500 group-hover:bg-slate-200'
                }`}>
                  {opt.key}
                </div>

                {/* Option Text - with whitespace-pre-wrap for line breaks */}
                <div 
                  className={`text-base md:text-lg whitespace-pre-wrap ${
                    selectedOption === opt.key ? 'text-lab-blue font-medium' : 'text-slate-700'
                  }`}
                  dangerouslySetInnerHTML={{ __html: opt.text }}
                />
              </button>
            ))}
          </div>
        </div>

        {/* Footer Instruction */}
        <div className="px-6 py-4 bg-slate-50/50 border-t border-slate-100 flex items-center gap-2">
          <HelpCircle size={14} className="text-slate-400" />
          <span className="text-[11px] text-slate-400 font-medium italic">
            Select the most appropriate answer. Click again to deselect. All chemical equations should be assumed to occur at r.t.p. unless stated otherwise.
          </span>
        </div>
      </div>

      {/* Forum Modal */}
      {showForum && (
        <QuestionForum
          question={question}
          onClose={() => setShowForum(false)}
        />
      )}
    </>
  );
}

// ========== src/components/QuestionForum.jsx ==========

import React, { useState, useEffect, useCallback } from 'react';
import { useAuth } from '../contexts/AuthContext';
import { useLanguage } from '../contexts/LanguageContext';
import { forumService, canEditComment, editTimeRemaining, EDIT_WINDOW_MS } from '../services/forumService';
import { MessageSquare, Send, Edit2, Trash2, ThumbsUp, X, AlertCircle, Clock, Lock } from 'lucide-react';

function EditTimer({ createdAt, onExpire }) {
  const [remaining, setRemaining] = useState(() => editTimeRemaining(createdAt));

  useEffect(() => {
    const interval = setInterval(() => {
      const r = editTimeRemaining(createdAt);
      setRemaining(r);
      if (!r) { clearInterval(interval); onExpire && onExpire(); }
    }, 1000);
    return () => clearInterval(interval);
  }, [createdAt, onExpire]);

  if (!remaining) return (
    <span className="flex items-center gap-1 text-xs text-red-500 font-semibold">
      <Lock size={11} /> Edit locked
    </span>
  );
  return (
    <span className="flex items-center gap-1 text-xs text-amber-500 font-semibold">
      <Clock size={11} /> Edit in {remaining}
    </span>
  );
}

export default function QuestionForum({ question, onClose }) {
  const { currentUser } = useAuth();
  const { isEnglish } = useLanguage();
  const [comments, setComments] = useState([]);
  const [newComment, setNewComment] = useState('');
  const [editingId, setEditingId] = useState(null);
  const [editText, setEditText] = useState('');
  const [loading, setLoading] = useState(true);
  const [submitting, setSubmitting] = useState(false);
  const [, forceUpdate] = useState(0); // for timer re-render

  const loadComments = useCallback(async () => {
    setLoading(true);
    try {
      const fetched = await forumService.getQuestionComments(question.ID);
      setComments(fetched);
    } catch { /* ignore */ }
    setLoading(false);
  }, [question.ID]);

  useEffect(() => { loadComments(); }, [loadComments]);

  // Refresh edit-timers every 10 seconds
  useEffect(() => {
    const interval = setInterval(() => forceUpdate(n => n + 1), 10000);
    return () => clearInterval(interval);
  }, []);

  async function handleSubmitComment() {
    if (!newComment.trim() || !currentUser) return;
    setSubmitting(true);
    try {
      await forumService.addComment(question.ID, currentUser.uid, currentUser.displayName || 'Anonymous', newComment.trim());
      setNewComment('');
      await loadComments();
    } catch (error) {
      alert(isEnglish ? `Failed to add comment: ${error.message}` : `Êñ∞Â¢ûË©ïË´ñÂ§±Êïó: ${error.message}`);
    }
    setSubmitting(false);
  }

  async function handleEditComment(commentId) {
    if (!editText.trim()) return;
    try {
      await forumService.updateComment(commentId, editText.trim());
      setEditingId(null);
      setEditText('');
      await loadComments();
    } catch (error) {
      if (error.message === 'EDIT_EXPIRED') {
        alert(isEnglish ? 'Edit window has expired (15 minutes). You can no longer edit this comment.' : 'Á∑®ËºØÊôÇÈñìÂ∑≤ÈÅéÔºà15ÂàÜÈêòÔºâ„ÄÇÊÇ®ÁÑ°Ê≥ïÂÜçÁ∑®ËºØÊ≠§Ë©ïË´ñ„ÄÇ');
        setEditingId(null);
      } else {
        alert(isEnglish ? 'Failed to update comment' : 'Êõ¥Êñ∞Ë©ïË´ñÂ§±Êïó');
      }
    }
  }

  async function handleDeleteComment(commentId) {
    if (!window.confirm(isEnglish ? 'Are you sure you want to delete this comment?' : 'Á¢∫ÂÆöË¶ÅÂà™Èô§Ê≠§Ë©ïË´ñÂóéÔºü')) return;
    try {
      await forumService.deleteComment(commentId);
      await loadComments();
    } catch { alert(isEnglish ? 'Failed to delete comment' : 'Âà™Èô§Ë©ïË´ñÂ§±Êïó'); }
  }

  async function handleToggleLike(commentId) {
    if (!currentUser) { alert(isEnglish ? 'Please log in to like comments' : 'Ë´ãÁôªÂÖ•‰ª•ÊåâËÆöË©ïË´ñ'); return; }
    try {
      await forumService.toggleLike(commentId, currentUser.uid);
      await loadComments();
    } catch { /* ignore */ }
  }

  const formatDate = (isoString) => {
    const date = new Date(isoString);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    if (diffMins < 1) return isEnglish ? 'Just now' : 'ÂâõÂâõ';
    if (diffMins < 60) return `${diffMins} ${isEnglish ? 'min ago' : 'ÂàÜÈêòÂâç'}`;
    if (diffHours < 24) return `${diffHours} ${isEnglish ? 'hr ago' : 'Â∞èÊôÇÂâç'}`;
    if (diffDays < 7) return `${diffDays} ${isEnglish ? 'days ago' : 'Â§©Ââç'}`;
    return date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto">
      <div className="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
        {/* Header */}
        <div className="sticky top-0 bg-white border-b-2 border-slate-200 p-6 rounded-t-2xl z-10">
          <div className="flex justify-between items-start">
            <div className="flex-1 pr-4">
              <h2 className="text-2xl font-black text-slate-800 flex items-center gap-2 mb-2">
                <MessageSquare className="text-lab-blue" size={24} />
                {isEnglish ? 'Discussion' : 'Ë®éË´ñÂçÄ'}
              </h2>
              <div className="flex items-center gap-2 text-sm">
                <span className="bg-blue-100 text-lab-blue px-2 py-1 rounded font-bold">{question.Topic}</span>
                {question.DSEcode && <span className="bg-slate-100 text-slate-600 px-2 py-1 rounded text-xs font-bold">{question.DSEcode}</span>}
              </div>
            </div>
            <button onClick={onClose} className="p-2 hover:bg-slate-100 rounded-lg transition-all flex-shrink-0"><X size={24} /></button>
          </div>
        </div>

        {/* Question */}
        <div className="p-6 bg-slate-50 border-b-2 border-slate-200">
          <div className="prose prose-slate max-w-none text-base text-slate-800 font-medium whitespace-pre-wrap"
            dangerouslySetInnerHTML={{ __html: question.Question }} />
          {question.Pictureurl && (
            <div className="mt-4 flex justify-center">
              <img src={question.Pictureurl} alt="Question Diagram" className="max-w-full h-auto max-h-[200px] object-contain rounded-lg border-2 border-slate-200" />
            </div>
          )}
        </div>

        {/* Comment Input */}
        {currentUser ? (
          <div className="p-6 border-b-2 border-slate-200 bg-white">
            <div className="flex gap-3">
              <div className="w-10 h-10 rounded-full bg-lab-blue flex items-center justify-center flex-shrink-0">
                <span className="text-white font-bold text-sm">{currentUser.displayName?.charAt(0).toUpperCase() || 'U'}</span>
              </div>
              <div className="flex-1">
                <textarea value={newComment} onChange={e => setNewComment(e.target.value)}
                  placeholder={isEnglish ? 'Share your thoughts...' : 'ÂàÜ‰∫´ÊÇ®ÁöÑÊÉ≥Ê≥ï...'}
                  className="w-full px-4 py-3 border-2 border-slate-200 rounded-lg focus:border-lab-blue focus:ring-2 focus:ring-blue-100 outline-none transition-all resize-none" rows="3" />
                <div className="flex justify-end mt-2">
                  <button onClick={handleSubmitComment} disabled={!newComment.trim() || submitting}
                    className="flex items-center gap-2 px-6 py-2 bg-lab-blue text-white rounded-lg font-bold hover:bg-blue-700 disabled:bg-slate-300 disabled:cursor-not-allowed transition-all">
                    {submitting ? <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white" /> : <Send size={16} />}
                    {isEnglish ? 'Post' : 'ÁôºË°®'}
                  </button>
                </div>
              </div>
            </div>
          </div>
        ) : (
          <div className="p-6 border-b-2 border-slate-200 bg-amber-50">
            <div className="flex items-center gap-3 text-amber-800">
              <AlertCircle size={20} />
              <p className="font-semibold">{isEnglish ? 'Please log in to join the discussion' : 'Ë´ãÁôªÂÖ•‰ª•ÂèÉËàáË®éË´ñ'}</p>
            </div>
          </div>
        )}

        {/* Comments */}
        <div className="p-6">
          {loading ? (
            <div className="flex justify-center py-12">
              <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-lab-blue" />
            </div>
          ) : comments.length === 0 ? (
            <div className="text-center py-12">
              <MessageSquare className="w-16 h-16 text-slate-300 mx-auto mb-4" />
              <p className="text-slate-400 text-lg mb-2">{isEnglish ? 'No comments yet' : 'Â∞öÁÑ°Ë©ïË´ñ'}</p>
              <p className="text-slate-500 text-sm">{isEnglish ? 'Be the first to share your thoughts!' : 'ÊàêÁÇ∫Á¨¨‰∏ÄÂÄãÂàÜ‰∫´ÊÉ≥Ê≥ïÁöÑ‰∫∫ÔºÅ'}</p>
            </div>
          ) : (
            <div className="space-y-4">
              <h3 className="text-lg font-bold text-slate-700 mb-4">{comments.length} {isEnglish ? 'Comments' : 'ÂâáË©ïË´ñ'}</h3>
              {comments.map(comment => {
                const isOwner = currentUser && comment.userId === currentUser.uid;
                const editable = isOwner && canEditComment(comment.createdAt);
                return (
                  <div key={comment.id} className="bg-slate-50 rounded-xl p-4 border-2 border-slate-200">
                    <div className="flex justify-between items-start mb-2">
                      <div className="flex items-center gap-3">
                        <div className="w-8 h-8 rounded-full bg-lab-blue flex items-center justify-center">
                          <span className="text-white font-bold text-xs">{comment.userDisplayName?.charAt(0).toUpperCase() || 'U'}</span>
                        </div>
                        <div>
                          <div className="font-bold text-slate-800">{comment.userDisplayName || 'Anonymous'}</div>
                          <div className="text-xs text-slate-500 flex items-center gap-2">
                            {formatDate(comment.createdAt)}
                            {comment.edited && <span className="text-slate-400 italic">({isEnglish ? 'edited' : 'Â∑≤Á∑®ËºØ'})</span>}
                          </div>
                        </div>
                      </div>
                      {isOwner && (
                        <div className="flex items-center gap-2">
                          {/* Edit timer badge */}
                          {editingId !== comment.id && (
                            <EditTimer createdAt={comment.createdAt} onExpire={() => forceUpdate(n => n + 1)} />
                          )}
                          {editable && (
                            <button onClick={() => { setEditingId(comment.id); setEditText(comment.text); }}
                              className="p-2 hover:bg-blue-100 rounded-lg transition-all" title={isEnglish ? 'Edit' : 'Á∑®ËºØ'}>
                              <Edit2 size={16} className="text-lab-blue" />
                            </button>
                          )}
                          {!editable && editingId !== comment.id && (
                            <button disabled title={isEnglish ? 'Edit window expired' : 'Á∑®ËºØÊôÇÈñìÂ∑≤ÈÅé'}
                              className="p-2 opacity-30 cursor-not-allowed rounded-lg">
                              <Lock size={16} className="text-slate-400" />
                            </button>
                          )}
                          <button onClick={() => handleDeleteComment(comment.id)}
                            className="p-2 hover:bg-red-100 rounded-lg transition-all" title={isEnglish ? 'Delete' : 'Âà™Èô§'}>
                            <Trash2 size={16} className="text-red-500" />
                          </button>
                        </div>
                      )}
                    </div>

                    {editingId === comment.id ? (
                      <div className="mt-3">
                        <div className="flex items-center gap-2 mb-2 text-xs text-amber-600 font-semibold">
                          <Clock size={12} />
                          {isEnglish ? 'Edit window: ' : 'Á∑®ËºØÊôÇÈôêÔºö'}
                          <EditTimer createdAt={comment.createdAt} onExpire={() => { setEditingId(null); forceUpdate(n => n + 1); }} />
                        </div>
                        <textarea value={editText} onChange={e => setEditText(e.target.value)}
                          className="w-full px-3 py-2 border-2 border-slate-300 rounded-lg focus:border-lab-blue outline-none resize-none" rows="3" />
                        <div className="flex gap-2 mt-2">
                          <button onClick={() => handleEditComment(comment.id)}
                            className="px-4 py-2 bg-lab-blue text-white rounded-lg font-bold hover:bg-blue-700 transition-all text-sm">
                            {isEnglish ? 'Save' : 'ÂÑ≤Â≠ò'}
                          </button>
                          <button onClick={() => { setEditingId(null); setEditText(''); }}
                            className="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg font-bold hover:bg-slate-300 transition-all text-sm">
                            {isEnglish ? 'Cancel' : 'ÂèñÊ∂à'}
                          </button>
                        </div>
                      </div>
                    ) : (
                      <>
                        <p className="text-slate-700 leading-relaxed mt-2 whitespace-pre-wrap">{comment.text}</p>
                        <div className="mt-3 pt-3 border-t border-slate-300">
                          <button onClick={() => handleToggleLike(comment.id)} disabled={!currentUser}
                            className={`flex items-center gap-2 px-3 py-1 rounded-lg font-semibold text-sm transition-all ${comment.likedBy?.includes(currentUser?.uid) ? 'bg-blue-100 text-lab-blue' : 'bg-slate-200 text-slate-600 hover:bg-slate-300'} ${!currentUser ? 'opacity-50 cursor-not-allowed' : ''}`}>
                            <ThumbsUp size={14} fill={comment.likedBy?.includes(currentUser?.uid) ? 'currentColor' : 'none'} />
                            {comment.likes || 0}
                          </button>
                        </div>
                      </>
                    )}
                  </div>
                );
              })}
            </div>
          )}
        </div>
      </div>
    </div>
  );
}

// ========== src/components/QuizEngine.jsx ==========

import React, { useState, useEffect, useRef } from 'react';
import QuestionCard from './QuestionCard';
import { ChevronLeft, ChevronRight, Send, Timer, FlaskConical, Flag, Clock, X } from 'lucide-react';

export default function QuizEngine({ questions, onComplete }) {
  const [currentIndex, setCurrentIndex] = useState(0);
  const [answers, setAnswers] = useState({});
  const [flagged, setFlagged] = useState(new Set());
  const [showPeriodicTable, setShowPeriodicTable] = useState(false);
  const [showQuestionPanel, setShowQuestionPanel] = useState(false);
  const [timerEnabled, setTimerEnabled] = useState(null);
  const [questionTimes, setQuestionTimes] = useState({});
  const [currentQuestionStartTime, setCurrentQuestionStartTime] = useState(null);
  const [currentTime, setCurrentTime] = useState(Date.now());
  const [sessionStartTime, setSessionStartTime] = useState(null);
  const timerInitialized = useRef(false);
  
  const currentQuestion = questions[currentIndex];
  const totalQuestions = questions.length;
  const progress = ((currentIndex + 1) / totalQuestions) * 100;

  // Timer initialization prompt - only once
  useEffect(() => {
    if (timerEnabled === null && !timerInitialized.current) {
      timerInitialized.current = true;
      const enableTimer = window.confirm(
        "Do you want to enable the timer?\n\n" +
        "The timer will track how long you spend on each question.\n\n" +
        "Click OK to enable, Cancel to skip."
      );
      setTimerEnabled(enableTimer);
      if (enableTimer) {
        const now = Date.now();
        setCurrentQuestionStartTime(now);
        setSessionStartTime(now);
      }
    }
  }, [timerEnabled]);

  // Live timer update - updates every second
  useEffect(() => {
    if (!timerEnabled) return;
    
    const interval = setInterval(() => {
      setCurrentTime(Date.now());
    }, 1000);

    return () => clearInterval(interval);
  }, [timerEnabled]);

  // Start timer when changing questions
  useEffect(() => {
    if (timerEnabled && currentQuestion) {
      setCurrentQuestionStartTime(Date.now());
    }
  }, [currentIndex, timerEnabled]);

  // Record time when leaving a question
  const recordQuestionTime = () => {
    if (timerEnabled && currentQuestionStartTime) {
      const timeSpent = Date.now() - currentQuestionStartTime;
      setQuestionTimes(prev => ({
        ...prev,
        [currentQuestion.ID]: (prev[currentQuestion.ID] || 0) + timeSpent
      }));
    }
  };

  const handleOptionSelect = (option) => {
    setAnswers({
      ...answers,
      [currentQuestion.ID]: option
    });
  };

  const toggleFlag = () => {
    const questionId = currentQuestion.ID;
    setFlagged(prev => {
      const newSet = new Set(prev);
      if (newSet.has(questionId)) {
        newSet.delete(questionId);
      } else {
        newSet.add(questionId);
      }
      return newSet;
    });
  };

  const nextQuestion = () => {
    recordQuestionTime();
    if (currentIndex < totalQuestions - 1) {
      setCurrentIndex(currentIndex + 1);
    }
  };

  const prevQuestion = () => {
    recordQuestionTime();
    if (currentIndex > 0) {
      setCurrentIndex(currentIndex - 1);
    }
  };

  const jumpToQuestion = (index) => {
    recordQuestionTime();
    setCurrentIndex(index);
    setShowQuestionPanel(false);
  };

  const isLastQuestion = currentIndex === totalQuestions - 1;
  const allAnswered = Object.keys(answers).length === totalQuestions;

  // Calculate total time spent (accumulated + current question time)
  const getTotalTimeSpent = () => {
    const accumulated = Object.values(questionTimes).reduce((sum, time) => sum + time, 0);
    if (timerEnabled && currentQuestionStartTime) {
      const currentQuestionTime = currentTime - currentQuestionStartTime;
      return accumulated + currentQuestionTime;
    }
    return accumulated;
  };

  // Calculate session time
  const getSessionTime = () => {
    if (timerEnabled && sessionStartTime) {
      return currentTime - sessionStartTime;
    }
    return 0;
  };

  const formatTime = (ms) => {
    const seconds = Math.floor(ms / 1000);
    const minutes = Math.floor(seconds / 60);
    const hrs = Math.floor(minutes / 60);
    if (hrs > 0) {
      return `${hrs}:${String(minutes % 60).padStart(2, '0')}:${String(seconds % 60).padStart(2, '0')}`;
    }
    return `${minutes}:${String(seconds % 60).padStart(2, '0')}`;
  };

  // Get question status
  const getQuestionStatus = (q) => {
    if (answers[q.ID]) return 'answered';
    if (flagged.has(q.ID)) return 'flagged';
    return 'skipped';
  };

  if (timerEnabled === null) {
    return (
      <div className="flex h-screen items-center justify-center">
        <div className="text-center">
          <Clock className="animate-pulse text-lab-blue w-12 h-12 mx-auto mb-4" />
          <p className="text-slate-600">Initializing quiz...</p>
        </div>
      </div>
    );
  }

  const totalTimeSpent = getTotalTimeSpent();
  const sessionTime = getSessionTime();

  return (
    <div className="relative h-screen overflow-hidden">
      {/* Fixed Left Sidebar */}
      <div className="fixed left-8 top-32 flex flex-col gap-4 z-30 h-[calc(100vh-10rem)]">
        {/* Timer Display */}
        {timerEnabled && (
          <div className="bg-white rounded-2xl shadow-xl border-2 border-lab-blue p-6 w-48">
            <div className="text-center">
              <div className="flex items-center justify-center gap-2 mb-2">
                <Timer className="text-lab-blue" size={24} />
                <span className="text-sm font-bold text-slate-600">SESSION TIME</span>
              </div>
              <div className="text-4xl font-black text-lab-blue mb-4 font-mono">
                {formatTime(sessionTime)}
              </div>
              <div className="text-xs text-slate-500 border-t pt-2">
                <div className="flex justify-between mb-1">
                  <span>Active Time:</span>
                  <span className="font-bold">{formatTime(totalTimeSpent)}</span>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Periodic Table Button */}
        <button
          onClick={() => setShowPeriodicTable(true)}
          className="flex items-center gap-2 px-6 py-4 bg-purple-600 text-white rounded-xl font-bold hover:bg-purple-700 transition-all shadow-lg hover:scale-105 active:scale-95"
        >
          <FlaskConical size={20} />
          <span>Periodic Table</span>
        </button>

        {/* Question Panel Button */}
        <button
          onClick={() => setShowQuestionPanel(!showQuestionPanel)}
          className="flex items-center gap-2 px-6 py-4 bg-slate-700 text-white rounded-xl font-bold hover:bg-slate-800 transition-all shadow-lg hover:scale-105 active:scale-95"
        >
          <Flag size={20} />
          <span>Overview</span>
        </button>

        {/* Spacer to push button to bottom */}
        <div className="flex-1"></div>

        {/* Previous Button - Left Side - Aligned to bottom */}
        <button
          onClick={prevQuestion}
          disabled={currentIndex === 0}
          className="flex items-center justify-center w-16 h-16 bg-lab-blue text-white rounded-full font-bold hover:bg-blue-800 disabled:bg-slate-300 disabled:cursor-not-allowed transition-all shadow-lg hover:scale-110 active:scale-95"
        >
          <ChevronLeft size={32} />
        </button>
      </div>

      {/* Fixed Right Sidebar */}
      <div className="fixed right-8 top-32 flex flex-col gap-4 z-30 h-[calc(100vh-10rem)]">
        {/* Flag Button */}
        <button
          onClick={toggleFlag}
          className={`w-16 h-16 rounded-full flex items-center justify-center transition-all shadow-lg hover:scale-110 active:scale-95 ${
            flagged.has(currentQuestion?.ID)
              ? 'bg-amber-500 text-white hover:bg-amber-600'
              : 'bg-white text-amber-500 border-2 border-amber-500 hover:bg-amber-50'
          }`}
          title={flagged.has(currentQuestion?.ID) ? 'Unflag Question' : 'Flag Question'}
        >
          <Flag size={28} fill={flagged.has(currentQuestion?.ID) ? 'currentColor' : 'none'} />
        </button>

        {/* Spacer to push button to bottom */}
        <div className="flex-1"></div>

        {/* Next/Submit Button - Right Side - Aligned to bottom */}
        {!isLastQuestion ? (
          <button
            onClick={nextQuestion}
            className="flex items-center justify-center w-16 h-16 bg-lab-blue text-white rounded-full font-bold hover:bg-blue-800 transition-all shadow-lg hover:scale-110 active:scale-95"
          >
            <ChevronRight size={32} />
          </button>
        ) : (
          <button
            onClick={() => {
              recordQuestionTime();
              onComplete(answers, timerEnabled ? questionTimes : null);
            }}
            className={`flex items-center justify-center w-16 h-16 rounded-full font-bold transition-all shadow-lg hover:scale-110 active:scale-95 ${
              allAnswered 
                ? 'bg-chemistry-green text-white hover:opacity-90' 
                : 'bg-slate-300 text-slate-500 cursor-not-allowed'
            }`}
            title="Finish & Submit"
          >
            <Send size={28} />
          </button>
        )}
      </div>

      {/* Question Overview Panel - Floating Left Sidebar */}
      {showQuestionPanel && (
        <>
          {/* Backdrop - semi-transparent to see content behind */}
          <div 
            className="fixed inset-0 z-40"
            style={{ backgroundColor: 'rgba(0, 0, 0, 0.15)' }}
            onClick={() => setShowQuestionPanel(false)}
          />
          
          {/* Panel - narrower sidebar on the left */}
          <div className="fixed left-0 top-0 h-full w-80 bg-white shadow-2xl z-50 overflow-y-auto animate-in slide-in-from-left duration-300">
            <div className="sticky top-0 bg-white border-b p-6 flex justify-between items-center">
              <h3 className="text-lg font-bold text-slate-800">Question Overview</h3>
              <button 
                onClick={() => setShowQuestionPanel(false)}
                className="text-slate-400 hover:text-slate-600 p-2 rounded-full hover:bg-slate-100"
              >
                <X size={20} />
              </button>
            </div>
            
            <div className="p-6">
              <div className="flex flex-col gap-3 mb-6 text-sm">
                <div className="flex items-center gap-2">
                  <div className="w-6 h-6 rounded bg-chemistry-green"></div>
                  <span>Answered ({Object.keys(answers).length})</span>
                </div>
                <div className="flex items-center gap-2">
                  <div className="w-6 h-6 rounded bg-amber-500"></div>
                  <span>Flagged ({flagged.size})</span>
                </div>
                <div className="flex items-center gap-2">
                  <div className="w-6 h-6 rounded bg-slate-200"></div>
                  <span>Skipped ({totalQuestions - Object.keys(answers).length})</span>
                </div>
              </div>

              <div className="grid grid-cols-4 gap-3">
                {questions.map((q, idx) => {
                  const status = getQuestionStatus(q);
                  return (
                    <button
                      key={q.ID}
                      onClick={() => jumpToQuestion(idx)}
                      className={`aspect-square rounded-xl font-bold text-base transition-all border-2 ${
                        idx === currentIndex
                          ? 'border-lab-blue ring-2 ring-lab-blue ring-offset-2'
                          : 'border-transparent'
                      } ${
                        status === 'answered'
                          ? 'bg-chemistry-green text-white hover:opacity-80'
                          : status === 'flagged'
                          ? 'bg-amber-500 text-white hover:opacity-80'
                          : 'bg-slate-200 text-slate-600 hover:bg-slate-300'
                      }`}
                    >
                      {idx + 1}
                    </button>
                  );
                })}
              </div>
            </div>
          </div>
        </>
      )}

      {/* Periodic Table Modal */}
      {showPeriodicTable && (
        <div 
          className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
          onClick={() => setShowPeriodicTable(false)}
        >
          <div 
            className="bg-white rounded-2xl shadow-2xl max-w-6xl w-full max-h-[90vh] overflow-auto"
            onClick={(e) => e.stopPropagation()}
          >
            <div className="sticky top-0 bg-white border-b p-4 flex justify-between items-center">
              <h3 className="text-xl font-bold text-slate-800">Periodic Table of Elements</h3>
              <button 
                onClick={() => setShowPeriodicTable(false)}
                className="text-slate-400 hover:text-slate-600 p-2 rounded-full hover:bg-slate-100"
              >
                <X size={24} />
              </button>
            </div>
            <div className="p-4">
              <img 
                src="https://upload.wikimedia.org/wikipedia/commons/2/2e/Simple_Periodic_Table_Chart-en.svg"
                alt="Periodic Table"
                className="w-full h-auto"
              />
            </div>
          </div>
        </div>
      )}

      {/* Main Content Area - Centered and compact */}
      <div className="max-w-5xl mx-auto px-4 py-6 h-full flex flex-col">
        {/* Progress Header - More Compact */}
        <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 mb-4">
          <div className="flex justify-between items-center mb-2">
            <div className="flex items-baseline gap-3">
              <span className="text-3xl font-black text-lab-blue">
                Q{currentIndex + 1}
              </span>
              <span className="text-sm font-medium text-slate-500">
                of {totalQuestions}
              </span>
            </div>
            <span className="text-xl font-bold text-lab-blue">
              {Math.round(progress)}%
            </span>
          </div>
          <div className="w-full bg-slate-100 h-2 rounded-full overflow-hidden">
            <div 
              className="bg-lab-blue h-full transition-all duration-300" 
              style={{ width: `${progress}%` }}
            />
          </div>
        </div>

        {/* Question Card Component - Takes remaining space */}
        <div className="flex-1 overflow-y-auto">
          <QuestionCard 
            question={currentQuestion}
            selectedOption={answers[currentQuestion.ID]}
            onSelect={handleOptionSelect}
          />
        </div>

        {/* Mini Progress Dots */}
        <div className="flex justify-center gap-1 mt-4 py-2">
          {questions.slice(0, Math.min(30, totalQuestions)).map((_, idx) => (
            <div 
              key={idx}
              className={`w-2 h-2 rounded-full transition-all ${
                idx === currentIndex ? 'bg-lab-blue w-6' : 
                answers[questions[idx].ID] ? 'bg-chemistry-green' : 
                flagged.has(questions[idx].ID) ? 'bg-amber-500' : 'bg-slate-200'
              }`}
            />
          ))}
          {totalQuestions > 30 && <span className="text-slate-400 text-xs">...</span>}
        </div>

        {!allAnswered && isLastQuestion && (
          <p className="text-center text-sm text-amber-600 font-medium mt-2">
            Please answer all questions before submitting.
          </p>
        )}
      </div>
    </div>
  );
}

// ========== src/components/ResultsSummary.jsx ==========

import React, { useState } from 'react';
import { CheckCircle2, XCircle, BarChart3, RotateCcw, Info, Clock, Share2, MessageSquare } from 'lucide-react';
import ShareableReport from './ShareableReport';
import QuestionForum from './QuestionForum';

export default function ResultsSummary({ questions, userAnswers, questionTimes, onRestart }) {
  const [showShareReport, setShowShareReport] = useState(false);
  const [forumQuestion, setForumQuestion] = useState(null);

  // 1. Calculate Score
  const total = questions.length;
  const correctCount = questions.reduce((acc, q) => {
    return acc + (userAnswers[q.ID] === q.CorrectOption ? 1 : 0);
  }, 0);
  const percentage = Math.round((correctCount / total) * 100);

  // Format time
  const formatTime = (ms) => {
    const seconds = Math.floor(ms / 1000);
    const minutes = Math.floor(seconds / 60);
    const hrs = Math.floor(minutes / 60);
    if (hrs > 0) {
      return `${hrs}h ${minutes % 60}m ${seconds % 60}s`;
    } else if (minutes > 0) {
      return `${minutes}m ${seconds % 60}s`;
    }
    return `${seconds}s`;
  };

  // Calculate total time and average
  const totalTime = questionTimes 
    ? Object.values(questionTimes).reduce((sum, time) => sum + time, 0)
    : null;
  
  const averageTimePerQuestion = questionTimes && total > 0
    ? totalTime / total
    : null;

  // 2. Strength/Weakness Analysis by Topic
  const analysis = questions.reduce((acc, q) => {
    if (!acc[q.Topic]) {
      acc[q.Topic] = { total: 0, correct: 0 };
    }
    acc[q.Topic].total += 1;
    if (userAnswers[q.ID] === q.CorrectOption) {
      acc[q.Topic].correct += 1;
    }
    return acc;
  }, {});

  const topicResults = Object.entries(analysis).map(([topic, data]) => ({
    topic,
    percent: Math.round((data.correct / data.total) * 100),
    ...data
  }));

  const strengths = topicResults.filter(t => t.percent >= 70);
  const weaknesses = topicResults.filter(t => t.percent < 70);

  return (
    <div className="space-y-8 animate-in fade-in duration-500">
      {/* Hero Score Section */}
      <div className="bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-200">
        <div className="bg-lab-blue p-8 text-center text-white">
          <h2 className="text-xl opacity-90 mb-2">Your Performance</h2>
          <div className="text-6xl font-black mb-2">{percentage}%</div>
          <p className="text-blue-100">
            {correctCount} out of {total} questions correct
          </p>
          {totalTime && (
            <div className="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4 text-blue-100">
              <div className="bg-blue-700 bg-opacity-50 rounded-lg p-4">
                <div className="flex items-center justify-center gap-2 mb-1">
                  <Clock size={18} />
                  <span className="text-sm font-semibold">Total Time</span>
                </div>
                <div className="text-2xl font-bold">{formatTime(totalTime)}</div>
              </div>
              <div className="bg-blue-700 bg-opacity-50 rounded-lg p-4">
                <div className="flex items-center justify-center gap-2 mb-1">
                  <Clock size={18} />
                  <span className="text-sm font-semibold">Average per MCQ</span>
                </div>
                <div className="text-2xl font-bold">{formatTime(averageTimePerQuestion)}</div>
              </div>
            </div>
          )}
        </div>

        {/* Analytics Grid */}
        <div className="p-6 grid grid-cols-1 md:grid-cols-2 gap-6 bg-slate-50">
          <div className="bg-white p-4 rounded-xl border border-slate-200">
            <h3 className="flex items-center gap-2 font-bold text-chemistry-green mb-3">
              <CheckCircle2 size={18} /> Strengths
            </h3>
            {strengths.length > 0 ? (
              strengths.map(s => (
                <div key={s.topic} className="text-sm mb-2 flex justify-between">
                  <span className="truncate mr-2">{s.topic}</span>
                  <span className="font-bold">{s.percent}%</span>
                </div>
              ))
            ) : <p className="text-sm text-slate-400 italic">Keep practicing to build strengths!</p>}
          </div>

          <div className="bg-white p-4 rounded-xl border border-slate-200">
            <h3 className="flex items-center gap-2 font-bold text-amber-600 mb-3">
              <BarChart3 size={18} /> Needs Focus
            </h3>
            {weaknesses.length > 0 ? (
              weaknesses.map(w => (
                <div key={w.topic} className="text-sm mb-2 flex justify-between">
                  <span className="truncate mr-2">{w.topic}</span>
                  <span className="font-bold text-amber-700">{w.percent}%</span>
                </div>
              ))
            ) : <p className="text-sm text-slate-400 italic">No major weaknesses detected!</p>}
          </div>
        </div>
      </div>

      {/* Action Buttons */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        <button
          onClick={() => setShowShareReport(true)}
          className="w-full py-4 flex items-center justify-center gap-2 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-xl font-bold hover:opacity-90 transition-all shadow-lg"
        >
          <Share2 size={20} />
          Share Report Card
        </button>

        <button
          onClick={onRestart}
          className="w-full py-4 flex items-center justify-center gap-2 bg-carbon-grey text-white rounded-xl font-bold hover:bg-slate-800 transition-all shadow-lg"
        >
          <RotateCcw size={20} />
          Start New Session
        </button>
      </div>

      {/* Detailed Review List */}
      <div className="space-y-4">
        <h3 className="text-xl font-bold flex items-center gap-2">
          <Info className="text-lab-blue" /> Detailed Review
        </h3>
        {questions.map((q, index) => {
          const isCorrect = userAnswers[q.ID] === q.CorrectOption;
          const timeSpent = questionTimes ? questionTimes[q.ID] : null;
          
          return (
            <div key={q.ID} className={`p-6 rounded-xl border-l-4 bg-white shadow-sm ${isCorrect ? 'border-chemistry-green' : 'border-red-500'}`}>
              <div className="flex justify-between items-start mb-4">
                <div className="flex items-center gap-3">
                  <span className="text-2xl font-black text-slate-700">Question {index + 1}</span>
                  {timeSpent && (
                    <div className="text-sm text-slate-500 flex items-center gap-1 bg-slate-100 px-3 py-1 rounded-full">
                      <Clock size={14} />
                      <span className="font-semibold">{formatTime(timeSpent)}</span>
                    </div>
                  )}
                </div>
                <div className="flex items-center gap-2">
                  {/* Forum Button */}
                  <button
                    onClick={() => setForumQuestion(q)}
                    className="flex items-center gap-2 px-4 py-2 bg-purple-100 text-purple-700 rounded-lg font-bold hover:bg-purple-200 transition-all"
                    title="Discuss this question"
                  >
                    <MessageSquare size={16} />
                    <span className="hidden sm:inline">Discuss</span>
                  </button>
                  
                  {/* Status Icon */}
                  {isCorrect ? 
                    <CheckCircle2 className="text-chemistry-green" size={24} /> : 
                    <XCircle className="text-red-500" size={24} />
                  }
                </div>
              </div>
              
              <div className="prose prose-slate max-w-none mb-4 text-lg" dangerouslySetInnerHTML={{ __html: q.Question }} />
              
              <div className="grid grid-cols-1 md:grid-cols-2 gap-2 mb-4">
                <div className={`p-3 rounded-lg text-sm border ${userAnswers[q.ID] === q.CorrectOption ? 'bg-green-50 border-green-200 text-green-800' : 'bg-red-50 border-red-200 text-red-800'}`}>
                  <strong>Your Answer:</strong> {userAnswers[q.ID] || 'None'}
                </div>
                <div className="p-3 rounded-lg bg-blue-50 border border-blue-200 text-blue-800 text-sm">
                  <strong>Correct Answer:</strong> {q.CorrectOption}
                </div>
              </div>

              {q.Explanation && (
                <div className="mt-4 p-4 bg-slate-100 rounded-lg text-sm border border-slate-200">
                  <strong className="block mb-2 text-slate-700 flex items-center gap-1">
                    <Info size={14}/> Explanation:
                  </strong>
                  <div dangerouslySetInnerHTML={{ __html: q.Explanation }} className="leading-relaxed text-slate-600" />
                </div>
              )}
            </div>
          );
        })}
      </div>

      {/* Share Report Modal */}
      {showShareReport && (
        <ShareableReport
          questions={questions}
          userAnswers={userAnswers}
          questionTimes={questionTimes}
          onClose={() => setShowShareReport(false)}
        />
      )}

      {/* Forum Modal */}
      {forumQuestion && (
        <QuestionForum
          question={forumQuestion}
          onClose={() => setForumQuestion(null)}
        />
      )}
    </div>
  );
}

// ========== src/components/ShareableReport.jsx ==========

import React, { useRef, useState } from 'react';
import { useAuth } from '../contexts/AuthContext';
import { useLanguage } from '../contexts/LanguageContext';
import html2canvas from 'html2canvas';
import jsPDF from 'jspdf';
import { Download, Share2, X, Trophy, Target, Clock, Calendar, CheckCircle, AlertCircle } from 'lucide-react';

export default function ShareableReport({ 
  questions, 
  userAnswers, 
  questionTimes,
  onClose 
}) {
  const { currentUser } = useAuth();
  const { isEnglish } = useLanguage();
  const reportRef = useRef(null);
  const [exporting, setExporting] = useState(false);
  const [error, setError] = useState(null);

  // Calculate stats
  const totalQuestions = questions.length;
  const correctAnswers = questions.reduce((acc, q) => {
    return acc + (userAnswers[q.ID] === q.CorrectOption ? 1 : 0);
  }, 0);
  const percentage = Math.round((correctAnswers / totalQuestions) * 100);

  const topics = [...new Set(questions.map(q => q.Topic))].filter(Boolean);

  const totalTime = questionTimes 
    ? Object.values(questionTimes).reduce((sum, time) => sum + time, 0)
    : null;

  const formatTime = (ms) => {
    if (!ms) return 'N/A';
    const seconds = Math.floor(ms / 1000);
    const minutes = Math.floor(seconds / 60);
    const hrs = Math.floor(minutes / 60);
    if (hrs > 0) {
      return `${hrs}h ${minutes % 60}m`;
    }
    return `${minutes}m ${seconds % 60}s`;
  };

  const formatDate = () => {
    const date = new Date();
    return date.toLocaleDateString('en-GB', {
      day: '2-digit',
      month: 'short',
      year: 'numeric'
    });
  };

  // Topic analysis
  const topicAnalysis = questions.reduce((acc, q) => {
    if (!acc[q.Topic]) {
      acc[q.Topic] = { total: 0, correct: 0 };
    }
    acc[q.Topic].total += 1;
    if (userAnswers[q.ID] === q.CorrectOption) {
      acc[q.Topic].correct += 1;
    }
    return acc;
  }, {});

  const topicResults = Object.entries(topicAnalysis).map(([topic, data]) => ({
    topic,
    percent: Math.round((data.correct / data.total) * 100),
    ...data
  }));

  // IMPROVED: Export as Image with better error handling and proxy for CORS
  const exportAsImage = async () => {
    if (!reportRef.current) {
      setError(isEnglish ? 'Report not ready. Please try again.' : 'Â†±ÂëäÊú™Ê∫ñÂÇôÂ•Ω„ÄÇË´ãÈáçË©¶„ÄÇ');
      return;
    }
    
    setExporting(true);
    setError(null);
    
    try {
      console.log('üîµ Starting image export...');
      
      // Wait for rendering to complete
      await new Promise(resolve => setTimeout(resolve, 500));
      
      // Create canvas with improved settings
      const canvas = await html2canvas(reportRef.current, {
        scale: 2, // High quality
        backgroundColor: '#ffffff',
        logging: false,
        useCORS: true,
        allowTaint: false, // Changed to false for better CORS handling
        foreignObjectRendering: false,
        imageTimeout: 15000, // Increased timeout
        onclone: (clonedDoc) => {
          // Remove any problematic images in the cloned document
          const images = clonedDoc.getElementsByTagName('img');
          Array.from(images).forEach(img => {
            // If image has CORS issues, replace with placeholder
            if (img.src && !img.complete) {
              img.style.display = 'none';
            }
          });
        }
      });
      
      console.log('‚úÖ Canvas created successfully');
      
      // Convert to blob and download
      canvas.toBlob((blob) => {
        if (!blob) {
          throw new Error(isEnglish ? 'Failed to create image' : 'ÁÑ°Ê≥ïÂâµÂª∫ÂúñÁâá');
        }
        
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.download = `ChemLeung-Report-${formatDate().replace(/\s/g, '-')}.png`;
        link.href = url;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        console.log('‚úÖ Image downloaded successfully');
        setExporting(false);
      }, 'image/png', 0.95); // High quality PNG
      
    } catch (error) {
      console.error('‚ùå Error exporting image:', error);
      setError(isEnglish 
        ? 'Failed to export image. Try PDF export instead.' 
        : 'ÂåØÂá∫ÂúñÁâáÂ§±Êïó„ÄÇË´ãÂòóË©¶ PDF ÂåØÂá∫„ÄÇ'
      );
      setExporting(false);
    }
  };

  // IMPROVED: Export as PDF with better error handling
  const exportAsPDF = async () => {
    if (!reportRef.current) {
      setError(isEnglish ? 'Report not ready. Please try again.' : 'Â†±ÂëäÊú™Ê∫ñÂÇôÂ•Ω„ÄÇË´ãÈáçË©¶„ÄÇ');
      return;
    }
    
    setExporting(true);
    setError(null);
    
    try {
      console.log('üîµ Starting PDF export...');
      
      // Wait for rendering to complete
      await new Promise(resolve => setTimeout(resolve, 500));
      
      // Create canvas
      const canvas = await html2canvas(reportRef.current, {
        scale: 2,
        backgroundColor: '#ffffff',
        logging: false,
        useCORS: true,
        allowTaint: false,
        foreignObjectRendering: false,
        imageTimeout: 15000,
        onclone: (clonedDoc) => {
          // Remove any problematic images in the cloned document
          const images = clonedDoc.getElementsByTagName('img');
          Array.from(images).forEach(img => {
            if (img.src && !img.complete) {
              img.style.display = 'none';
            }
          });
        }
      });
      
      console.log('‚úÖ Canvas created for PDF');
      
      const imgData = canvas.toDataURL('image/png', 0.95);
      const pdf = new jsPDF({
        orientation: 'portrait',
        unit: 'mm',
        format: 'a4',
        compress: true
      });
      
      const imgWidth = 210; // A4 width in mm
      const pageHeight = 297; // A4 height in mm
      const imgHeight = (canvas.height * imgWidth) / canvas.width;
      
      let heightLeft = imgHeight;
      let position = 0;
      
      // Add first page
      pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight, undefined, 'FAST');
      heightLeft -= pageHeight;
      
      // Add additional pages if needed
      while (heightLeft > 0) {
        position = heightLeft - imgHeight;
        pdf.addPage();
        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight, undefined, 'FAST');
        heightLeft -= pageHeight;
      }
      
      pdf.save(`ChemLeung-Report-${formatDate().replace(/\s/g, '-')}.pdf`);
      
      console.log('‚úÖ PDF downloaded successfully');
      setExporting(false);
    } catch (error) {
      console.error('‚ùå Error exporting PDF:', error);
      setError(isEnglish 
        ? 'Failed to export PDF. Try image export instead.' 
        : 'ÂåØÂá∫ PDF Â§±Êïó„ÄÇË´ãÂòóË©¶ÂúñÁâáÂåØÂá∫„ÄÇ'
      );
      setExporting(false);
    }
  };

  const getGradeColor = (percent) => {
    if (percent >= 80) return 'from-green-500 to-emerald-600';
    if (percent >= 60) return 'from-blue-500 to-indigo-600';
    if (percent >= 40) return 'from-amber-500 to-orange-600';
    return 'from-red-500 to-rose-600';
  };

  const getGrade = (percent) => {
    if (percent >= 90) return 'A+';
    if (percent >= 80) return 'A';
    if (percent >= 70) return 'B';
    if (percent >= 60) return 'C';
    if (percent >= 50) return 'D';
    return 'F';
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto">
      <div className="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
        {/* Header with close and export buttons */}
        <div className="sticky top-0 bg-white border-b-2 border-slate-200 p-4 flex justify-between items-center rounded-t-2xl z-10">
          <h2 className="text-2xl font-black text-slate-800 flex items-center gap-2">
            <Share2 className="text-lab-blue" size={24} />
            {isEnglish ? 'Share Report Card' : 'ÂàÜ‰∫´ÊàêÁ∏æÂñÆ'}
          </h2>
          
          <div className="flex items-center gap-2">
            <button
              onClick={exportAsImage}
              disabled={exporting}
              className="flex items-center gap-2 px-4 py-2 bg-lab-blue text-white rounded-lg font-bold hover:bg-blue-700 disabled:bg-slate-300 transition-all"
              title={isEnglish ? 'Download as PNG image' : '‰∏ãËºâÁÇ∫ PNG ÂúñÁâá'}
            >
              <Download size={18} />
              {isEnglish ? 'Image' : 'ÂúñÁâá'}
            </button>
            
            <button
              onClick={exportAsPDF}
              disabled={exporting}
              className="flex items-center gap-2 px-4 py-2 bg-chemistry-green text-white rounded-lg font-bold hover:opacity-90 disabled:bg-slate-300 transition-all"
              title={isEnglish ? 'Download as PDF' : '‰∏ãËºâÁÇ∫ PDF'}
            >
              <Download size={18} />
              PDF
            </button>
            
            <button
              onClick={onClose}
              className="p-2 hover:bg-slate-100 rounded-lg transition-all"
              title={isEnglish ? 'Close' : 'ÈóúÈñâ'}
            >
              <X size={24} />
            </button>
          </div>
        </div>

        {/* Error Display */}
        {error && (
          <div className="mx-4 mt-4 bg-red-50 border-2 border-red-200 rounded-lg p-4 flex items-start gap-3">
            <AlertCircle className="text-red-500 flex-shrink-0 mt-0.5" size={20} />
            <div className="flex-1">
              <p className="text-red-800 font-semibold">{error}</p>
              <button
                onClick={() => setError(null)}
                className="text-sm text-red-600 hover:underline mt-1"
              >
                {isEnglish ? 'Dismiss' : 'ÈóúÈñâ'}
              </button>
            </div>
          </div>
        )}

        {/* Report Card Content - NO EXTERNAL IMAGES to avoid CORS */}
        <div ref={reportRef} className="p-8 bg-gradient-to-br from-slate-50 to-blue-50">
          {/* Header */}
          <div className="text-center mb-8">
            <div className="inline-block bg-lab-blue px-6 py-2 rounded-full mb-4">
              <h1 className="text-3xl font-black text-white">ChemLeung</h1>
            </div>
            <h2 className="text-2xl font-bold text-slate-800 mb-2">
              {isEnglish ? 'HKDSE Chemistry Practice Report' : 'HKDSE ÂåñÂ≠∏Á∑¥ÁøíÂ†±Âëä'}
            </h2>
            <div className="flex items-center justify-center gap-4 text-slate-600">
              <div className="flex items-center gap-1">
                <Calendar size={16} />
                <span className="text-sm font-semibold">{formatDate()}</span>
              </div>
            </div>
          </div>

          {/* Student Info */}
          <div className="bg-white rounded-xl shadow-lg p-6 mb-6 border-2 border-slate-200">
            <div className="grid grid-cols-2 gap-4">
              <div>
                <div className="text-sm text-slate-500 mb-1">
                  {isEnglish ? 'Student Name' : 'Â≠∏ÁîüÂßìÂêç'}
                </div>
                <div className="text-lg font-bold text-slate-800">
                  {currentUser?.displayName || 'Student'}
                </div>
              </div>
              <div>
                <div className="text-sm text-slate-500 mb-1">
                  {isEnglish ? 'Topics Covered' : 'Ê∂µËìã‰∏ªÈ°å'}
                </div>
                <div className="text-lg font-bold text-slate-800">
                  {topics.length} {isEnglish ? 'Topics' : 'ÂÄã‰∏ªÈ°å'}
                </div>
              </div>
            </div>
          </div>

          {/* Main Score Display */}
          <div className={`bg-gradient-to-r ${getGradeColor(percentage)} rounded-2xl shadow-2xl p-8 mb-6 text-white`}>
            <div className="text-center">
              <div className="text-6xl font-black mb-2">{percentage}%</div>
              <div className="text-3xl font-bold mb-4">{getGrade(percentage)}</div>
              <div className="text-xl opacity-90">
                {correctAnswers} {isEnglish ? 'out of' : '/'} {totalQuestions} {isEnglish ? 'Correct' : 'Ê≠£Á¢∫'}
              </div>
            </div>
          </div>

          {/* Stats Grid */}
          <div className="grid grid-cols-3 gap-4 mb-6">
            <div className="bg-white rounded-xl shadow-lg p-4 border-2 border-blue-200 text-center">
              <div className="w-8 h-8 bg-amber-500 rounded-full flex items-center justify-center mx-auto mb-2">
                <Trophy size={20} className="text-white" />
              </div>
              <div className="text-2xl font-black text-slate-800">{correctAnswers}</div>
              <div className="text-sm text-slate-600">{isEnglish ? 'Correct' : 'Ê≠£Á¢∫'}</div>
            </div>
            
            <div className="bg-white rounded-xl shadow-lg p-4 border-2 border-red-200 text-center">
              <div className="w-8 h-8 bg-red-500 rounded-full flex items-center justify-center mx-auto mb-2">
                <Target size={20} className="text-white" />
              </div>
              <div className="text-2xl font-black text-slate-800">{totalQuestions - correctAnswers}</div>
              <div className="text-sm text-slate-600">{isEnglish ? 'Incorrect' : 'ÈåØË™§'}</div>
            </div>
            
            {totalTime && (
              <div className="bg-white rounded-xl shadow-lg p-4 border-2 border-purple-200 text-center">
                <div className="w-8 h-8 bg-purple-500 rounded-full flex items-center justify-center mx-auto mb-2">
                  <Clock size={20} className="text-white" />
                </div>
                <div className="text-2xl font-black text-slate-800">{formatTime(totalTime)}</div>
                <div className="text-sm text-slate-600">{isEnglish ? 'Time Used' : 'Áî®ÊôÇ'}</div>
              </div>
            )}
          </div>

          {/* Topic Breakdown */}
          <div className="bg-white rounded-xl shadow-lg p-6 border-2 border-slate-200">
            <h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
              <div className="w-5 h-5 bg-lab-blue rounded-full flex items-center justify-center">
                <CheckCircle size={14} className="text-white" />
              </div>
              {isEnglish ? 'Topic Breakdown' : '‰∏ªÈ°åÂàÜÊûê'}
            </h3>
            
            <div className="space-y-3">
              {topicResults.map((result, index) => (
                <div key={index} className="flex items-center justify-between">
                  <div className="flex-1">
                    <div className="flex justify-between mb-1">
                      <span className="text-sm font-semibold text-slate-700">{result.topic}</span>
                      <span className="text-sm font-bold text-slate-800">{result.percent}%</span>
                    </div>
                    <div className="w-full bg-slate-200 h-2 rounded-full overflow-hidden">
                      <div 
                        className={`h-full rounded-full ${
                          result.percent >= 70 ? 'bg-chemistry-green' :
                          result.percent >= 50 ? 'bg-amber-500' :
                          'bg-red-500'
                        }`}
                        style={{ width: `${result.percent}%` }}
                      />
                    </div>
                    <div className="text-xs text-slate-500 mt-1">
                      {result.correct}/{result.total} {isEnglish ? 'correct' : 'Ê≠£Á¢∫'}
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>

          {/* Footer */}
          <div className="mt-8 pt-6 border-t-2 border-slate-200 text-center text-slate-500 text-sm">
            <p className="font-semibold">
              {isEnglish 
                ? 'Generated by ChemLeung HKDSE MCQ Practice Platform' 
                : 'Áî± ChemLeung HKDSE MCQ Á∑¥ÁøíÂπ≥Âè∞ÁîüÊàê'}
            </p>
            <p className="text-xs mt-1">www.chemleung.com</p>
          </div>
        </div>

        {/* Loading Overlay */}
        {exporting && (
          <div className="absolute inset-0 bg-white bg-opacity-90 flex items-center justify-center rounded-2xl">
            <div className="text-center">
              <div className="animate-spin rounded-full h-12 w-12 border-b-4 border-lab-blue mx-auto mb-4"></div>
              <p className="text-slate-700 font-semibold">
                {isEnglish ? 'Generating report...' : 'ÁîüÊàêÂ†±Âëä‰∏≠...'}
              </p>
              <p className="text-slate-500 text-sm mt-2">
                {isEnglish ? 'This may take a few seconds' : 'ÈÄôÂèØËÉΩÈúÄË¶ÅÂπæÁßíÈêò'}
              </p>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

// ========== src/components/TokenLog.jsx ==========

// ============================================================================
// TOKEN LOG - Transaction History
// ============================================================================

import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { useAuth } from '../contexts/AuthContext';
import { getTokenHistory } from '../services/tokenService';
import { ArrowLeft, TrendingUp, TrendingDown, Clock, Filter, Zap } from 'lucide-react';

export default function TokenLog() {
  const navigate = useNavigate();
  const { currentUser } = useAuth();
  const [history, setHistory] = useState([]);
  const [loading, setLoading] = useState(true);
  const [filter, setFilter] = useState('all'); // all | gains | spends

  useEffect(() => {
    loadHistory();
  }, [currentUser]);

  async function loadHistory() {
    if (!currentUser) return;
    
    setLoading(true);
    try {
      const data = await getTokenHistory(currentUser.uid, 50);
      setHistory(data);
    } catch (error) {
      console.error('Error loading token history:', error);
    }
    setLoading(false);
  }

  const formatTimeAgo = (timestamp) => {
    if (!timestamp) return 'Unknown';
    
    const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);

    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    if (diffDays < 7) return `${diffDays}d ago`;
    
    return date.toLocaleDateString('en-GB', { 
      day: '2-digit', 
      month: 'short', 
      year: 'numeric' 
    });
  };

  const filteredHistory = history.filter(entry => {
    if (filter === 'gains') return entry.type === 'gain';
    if (filter === 'spends') return entry.type === 'spend';
    return true;
  });

  // Calculate totals
  const totalGained = history
    .filter(e => e.type === 'gain')
    .reduce((sum, e) => sum + e.amount, 0);
  
  const totalSpent = history
    .filter(e => e.type === 'spend')
    .reduce((sum, e) => sum + Math.abs(e.amount), 0);

  return (
    <div className="max-w-4xl mx-auto space-y-6">
      {/* Header */}
      <div className="flex items-center gap-4">
        <button
          onClick={() => navigate('/dashboard')}
          className="p-3 bg-white rounded-lg border-2 border-slate-200 hover:border-lab-blue transition-all"
        >
          <ArrowLeft size={20} />
        </button>
        
        <div className="flex-1 bg-gradient-to-r from-amber-500 to-orange-600 rounded-2xl shadow-xl p-6 text-white">
          <h1 className="text-3xl font-black flex items-center gap-3">
            <Clock size={32} />
            Token History
          </h1>
          <p className="text-orange-100 mt-1">
            Track your earnings and purchases
          </p>
        </div>
      </div>

      {/* Stats Overview */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div className="bg-white rounded-xl shadow-lg border-2 border-green-200 p-6">
          <div className="flex items-center gap-3 mb-2">
            <div className="p-3 bg-green-100 rounded-lg">
              <TrendingUp className="text-green-600" size={24} />
            </div>
            <div>
              <div className="text-sm font-semibold text-slate-600">Total Earned</div>
              <div className="text-3xl font-black text-green-600 flex items-center gap-2">
                <Zap size={24} fill="currentColor" />
                {totalGained}
              </div>
            </div>
          </div>
        </div>

        <div className="bg-white rounded-xl shadow-lg border-2 border-red-200 p-6">
          <div className="flex items-center gap-3 mb-2">
            <div className="p-3 bg-red-100 rounded-lg">
              <TrendingDown className="text-red-600" size={24} />
            </div>
            <div>
              <div className="text-sm font-semibold text-slate-600">Total Spent</div>
              <div className="text-3xl font-black text-red-600 flex items-center gap-2">
                <Zap size={24} fill="currentColor" />
                {totalSpent}
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* Filters */}
      <div className="bg-white rounded-xl shadow-lg border-2 border-slate-200 p-4">
        <div className="flex items-center gap-3">
          <Filter size={18} className="text-slate-600" />
          <div className="flex gap-2">
            {[
              { value: 'all', label: 'All Transactions' },
              { value: 'gains', label: 'Gains' },
              { value: 'spends', label: 'Spends' }
            ].map(opt => (
              <button
                key={opt.value}
                onClick={() => setFilter(opt.value)}
                className={`px-4 py-2 rounded-lg font-bold text-sm transition-all ${
                  filter === opt.value
                    ? 'bg-gradient-to-r from-purple-600 to-pink-600 text-white'
                    : 'bg-slate-100 text-slate-600 hover:bg-slate-200'
                }`}
              >
                {opt.label}
              </button>
            ))}
          </div>
        </div>
      </div>

      {/* Transaction List */}
      <div className="bg-white rounded-2xl shadow-xl border-2 border-slate-200 overflow-hidden">
        <div className="bg-slate-50 p-4 border-b-2 border-slate-200">
          <h2 className="text-lg font-bold text-slate-800">
            Recent Transactions ({filteredHistory.length})
          </h2>
        </div>

        <div className="divide-y divide-slate-100">
          {loading ? (
            <div className="flex justify-center py-12">
              <div className="animate-spin rounded-full h-10 w-10 border-b-2 border-lab-blue"></div>
            </div>
          ) : filteredHistory.length === 0 ? (
            <div className="text-center py-12">
              <Clock className="w-16 h-16 text-slate-300 mx-auto mb-4" />
              <p className="text-slate-400 text-lg">
                {filter === 'all' 
                  ? 'No transactions yet' 
                  : `No ${filter === 'gains' ? 'earnings' : 'purchases'} yet`
                }
              </p>
              <p className="text-slate-500 text-sm mt-2">
                Complete quizzes to start earning tokens!
              </p>
            </div>
          ) : (
            filteredHistory.map((entry, index) => {
              const isGain = entry.type === 'gain';
              const amount = Math.abs(entry.amount);

              return (
                <div
                  key={entry.id || index}
                  className="p-4 hover:bg-slate-50 transition-all"
                >
                  <div className="flex items-center justify-between">
                    <div className="flex items-center gap-4 flex-1">
                      {/* Icon */}
                      <div className={`p-3 rounded-lg ${
                        isGain ? 'bg-green-100' : 'bg-red-100'
                      }`}>
                        {isGain ? (
                          <TrendingUp className="text-green-600" size={20} />
                        ) : (
                          <TrendingDown className="text-red-600" size={20} />
                        )}
                      </div>

                      {/* Details */}
                      <div className="flex-1 min-w-0">
                        <div className="font-bold text-slate-800 mb-1">
                          {entry.reason}
                        </div>
                        <div className="text-sm text-slate-500 flex items-center gap-2">
                          <Clock size={12} />
                          {formatTimeAgo(entry.timestamp)}
                          {entry.metadata?.category && (
                            <>
                              <span>‚Ä¢</span>
                              <span className="capitalize">
                                {entry.metadata.category.replace('_', ' ')}
                              </span>
                            </>
                          )}
                        </div>
                      </div>
                    </div>

                    {/* Amount */}
                    <div className="flex items-center gap-2">
                      <div className={`text-2xl font-black ${
                        isGain ? 'text-green-600' : 'text-red-600'
                      }`}>
                        {isGain ? '+' : '-'}{amount}
                      </div>
                      <Zap 
                        size={20} 
                        className={isGain ? 'text-green-600' : 'text-red-600'}
                        fill="currentColor"
                      />
                    </div>
                  </div>

                  {/* Balance After */}
                  {entry.balanceAfter !== undefined && (
                    <div className="mt-2 text-xs text-slate-400 text-right">
                      Balance after: {entry.balanceAfter} tokens
                    </div>
                  )}
                </div>
              );
            })
          )}
        </div>
      </div>
    </div>
  );
}

// ========== src/contexts/AuthContext.jsx ==========

import React, { createContext, useState, useEffect, useContext, useRef } from 'react';
import { 
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  signOut,
  onAuthStateChanged,
  updateProfile
} from 'firebase/auth';
import { doc, setDoc, getDoc, onSnapshot } from 'firebase/firestore';
import { auth, db } from '../firebase/config';
import { initializeUserTokens } from '../services/tokenService';

const AuthContext = createContext();

export function useAuth() {
  return useContext(AuthContext);
}

export function AuthProvider({ children }) {
  const [currentUser, setCurrentUser] = useState(null);
  const [userProfile, setUserProfile] = useState(null);
  const [loading, setLoading] = useState(true);
  
  // Real-time listener cleanup ref
  const profileUnsubscribeRef = useRef(null);

  // Register new user
  async function signup(email, password, displayName) {
    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
    
    // Update profile with display name
    await updateProfile(userCredential.user, {
      displayName: displayName
    });

    // Create user profile in Firestore with token initialization
    await setDoc(doc(db, 'users', userCredential.user.uid), {
      uid: userCredential.user.uid,
      email: email,
      displayName: displayName,
      createdAt: new Date().toISOString(),
      totalAttempts: 0,
      totalQuestions: 0,
      totalCorrect: 0,
      tokens: 100,        // Initial token balance
      inventory: [],      // Owned items
      equipped: {}        // Currently equipped items
    });

    // Initialize token system (creates welcome bonus entry)
    await initializeUserTokens(userCredential.user.uid, 100);

    return userCredential;
  }

  // Login user
  function login(email, password) {
    return signInWithEmailAndPassword(auth, email, password);
  }

  // Logout user
  function logout() {
    // Clean up real-time listener
    if (profileUnsubscribeRef.current) {
      profileUnsubscribeRef.current();
      profileUnsubscribeRef.current = null;
    }
    return signOut(auth);
  }

  // Load user profile with REAL-TIME synchronization
  function setupProfileListener(uid) {
    // Clean up existing listener
    if (profileUnsubscribeRef.current) {
      profileUnsubscribeRef.current();
    }

    const docRef = doc(db, 'users', uid);
    
    // Set up real-time listener
    const unsubscribe = onSnapshot(docRef, (docSnap) => {
      if (docSnap.exists()) {
        const data = docSnap.data();
        console.log('üìä Profile updated:', {
          tokens: data.tokens,
          inventory: data.inventory?.length || 0
        });
        setUserProfile(data);
      } else {
        console.error('‚ùå User profile not found');
        setUserProfile(null);
      }
    }, (error) => {
      console.error('‚ùå Profile listener error:', error);
    });

    profileUnsubscribeRef.current = unsubscribe;
    return unsubscribe;
  }

  // Legacy: Load profile once (for backwards compatibility)
  async function loadUserProfile(uid) {
    try {
      const docRef = doc(db, 'users', uid);
      const docSnap = await getDoc(docRef);
      
      if (docSnap.exists()) {
        setUserProfile(docSnap.data());
      }
    } catch (error) {
      console.error('Error loading profile:', error);
    }
  }

  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, async (user) => {
      setCurrentUser(user);
      
      if (user) {
        // Set up real-time profile listener
        setupProfileListener(user.uid);
      } else {
        setUserProfile(null);
        // Clean up listener
        if (profileUnsubscribeRef.current) {
          profileUnsubscribeRef.current();
          profileUnsubscribeRef.current = null;
        }
      }
      
      setLoading(false);
    });

    return () => {
      unsubscribe();
      // Clean up listener on unmount
      if (profileUnsubscribeRef.current) {
        profileUnsubscribeRef.current();
      }
    };
  }, []);

  const value = {
    currentUser,
    userProfile,
    signup,
    login,
    logout,
    loadUserProfile  // Keep for backwards compatibility
  };

  return (
    <AuthContext.Provider value={value}>
      {!loading && children}
    </AuthContext.Provider>
  );
}

// ========== src/contexts/LanguageContext.jsx ==========

import React, { createContext, useState, useContext, useEffect } from 'react';

const LanguageContext = createContext();

export function useLanguage() {
  return useContext(LanguageContext);
}

// Translation dictionary
const translations = {
  en: {
    // Branding
    appName: "ChemLeung HKDSE MCQ Practice Platform",
    tagline: "HKDSE Chemistry Practice",
    
    // Navigation
    nav: {
      dashboard: "Dashboard",
      practice: "Practice",
      leaderboard: "Leaderboard",
      history: "History",
      profile: "Profile",
      logout: "Logout",
    },
    
    // Dashboard
    dashboard: {
      welcomeBack: "Welcome back",
      totalAttempts: "Total Attempts",
      overallAccuracy: "Overall Accuracy",
      questionsSolved: "Questions Solved",
      correctAnswers: "Correct Answers",
      studyStreak: "Study Streak",
      days: "days",
      startNewQuiz: "Start New Quiz",
      viewLeaderboard: "View Leaderboard",
      recentAttempts: "Recent Attempts",
      noAttempts: "No attempts yet!",
      takeFirstQuiz: "Take Your First Quiz",
    },
    
    // Practice Modes
    practice: {
      selectMode: "Select Practice Mode",
      timed: "Timed Practice",
      timedDesc: "Race against the clock - {minutes} minutes",
      marathon: "Marathon Mode",
      marathonDesc: "Unlimited time - track your progress",
      custom: "Custom Session",
      customDesc: "Choose topics and question count",
      startPractice: "Start Practice",
    },
    
    // Quiz Interface
    quiz: {
      question: "Question",
      of: "of",
      flagQuestion: "Flag Question",
      unflagQuestion: "Unflag Question",
      periodicTable: "Periodic Table",
      overview: "Overview",
      previous: "Previous",
      next: "Next",
      submit: "Submit",
      answered: "Answered",
      flagged: "Flagged",
      skipped: "Skipped",
      timeRemaining: "Time Remaining",
      sessionTime: "Session Time",
    },
    
    // Results
    results: {
      yourPerformance: "Your Performance",
      totalTime: "Total Time",
      averagePerQuestion: "Average per MCQ",
      strengths: "Strengths",
      needsFocus: "Needs Focus",
      detailedReview: "Detailed Review",
      yourAnswer: "Your Answer",
      correctAnswer: "Correct Answer",
      explanation: "Explanation",
      shareReport: "Share Report Card",
      addToNotebook: "Add to Mistake Notebook",
      startNewSession: "Start New Session",
    },
    
    // Profile
    profile: {
      profileSettings: "Profile Settings",
      yourStatistics: "Your Statistics",
      displayName: "Display Name",
      email: "Email Address",
      schoolLevel: "School Level (Form)",
      studyLevel: "Current Study Level",
      memberSince: "Member Since",
      saveChanges: "Save Changes",
      topicExceptions: "Topic Exceptions",
      unlockTopic: "Unlock Topic",
      lockTopic: "Lock Topic",
    },
    
    // Leaderboard
    leaderboard: {
      title: "Leaderboard",
      thisWeek: "This Week",
      thisMonth: "This Month",
      allTime: "All Time",
      you: "You",
      attempts: "attempts",
      questions: "questions",
    },
    
    // Forum
    forum: {
      title: "The MCQ Forum",
      discuss: "Discuss",
      addComment: "Add Comment",
      editComment: "Edit Comment",
      deleteComment: "Delete Comment",
      noComments: "No comments yet. Be the first to discuss!",
      loading: "Loading discussion...",
    },
    
    // Mistake Notebook
    notebook: {
      title: "Mistake Notebook",
      review: "Review Mistakes",
      practiceMistakes: "Practice Mistakes Only",
      cleared: "All mistakes cleared!",
      addedToNotebook: "Added to Mistake Notebook",
      removedFromNotebook: "Removed from Notebook",
    },
    
    // Common
    common: {
      loading: "Loading...",
      error: "Error",
      success: "Success",
      confirm: "Confirm",
      cancel: "Cancel",
      save: "Save",
      delete: "Delete",
      edit: "Edit",
      close: "Close",
      retry: "Retry",
      backToTopics: "Back to Topics",
    },
    
    // Authentication
    auth: {
      login: "Login",
      register: "Register",
      email: "Email Address",
      password: "Password",
      confirmPassword: "Confirm Password",
      fullName: "Full Name",
      createAccount: "Create Account",
      alreadyHaveAccount: "Already have an account?",
      dontHaveAccount: "Don't have an account?",
      loginHere: "Login here",
      registerHere: "Register here",
    },
  },
  
  zh: {
    // ÂìÅÁâå
    appName: "ChemLeung HKDSE MCQ Á∑¥ÁøíÂπ≥Âè∞",
    tagline: "HKDSE ÂåñÂ≠∏Á∑¥Áøí",
    
    // Â∞éËà™
    nav: {
      dashboard: "ÂÑÄË°®Êùø",
      practice: "Á∑¥Áøí",
      leaderboard: "ÊéíË°åÊ¶ú",
      history: "Ê≠∑Âè≤Ë®òÈåÑ",
      profile: "ÂÄã‰∫∫Ë≥áÊñô",
      logout: "ÁôªÂá∫",
    },
    
    // ÂÑÄË°®Êùø
    dashboard: {
      welcomeBack: "Ê≠°ËøéÂõû‰æÜ",
      totalAttempts: "Á∏ΩÊ∏¨È©óÊ¨°Êï∏",
      overallAccuracy: "Êï¥È´îÊ∫ñÁ¢∫Áéá",
      questionsSolved: "Â∑≤ÂÆåÊàêÈ°åÁõÆ",
      correctAnswers: "Ê≠£Á¢∫Á≠îÊ°à",
      studyStreak: "ÈÄ£Á∫åÂ≠∏ÁøíÂ§©Êï∏",
      days: "Â§©",
      startNewQuiz: "ÈñãÂßãÊñ∞Ê∏¨È©ó",
      viewLeaderboard: "Êü•ÁúãÊéíË°åÊ¶ú",
      recentAttempts: "ÊúÄËøëÊ∏¨È©ó",
      noAttempts: "Â∞öÊú™ÈÄ≤Ë°åÊ∏¨È©óÔºÅ",
      takeFirstQuiz: "ÈñãÂßãÊÇ®ÁöÑÁ¨¨‰∏ÄÂÄãÊ∏¨È©ó",
    },
    
    // Á∑¥ÁøíÊ®°Âºè
    practice: {
      selectMode: "ÈÅ∏ÊìáÁ∑¥ÁøíÊ®°Âºè",
      timed: "ÈôêÊôÇÁ∑¥Áøí",
      timedDesc: "ËàáÊôÇÈñìÁ´∂Ë≥Ω - {minutes} ÂàÜÈêò",
      marathon: "È¶¨ÊãâÊùæÊ®°Âºè",
      marathonDesc: "ÁÑ°ÈôêÊôÇÈñì - ËøΩËπ§ÊÇ®ÁöÑÈÄ≤Â∫¶",
      custom: "Ëá™ÂÆöÁæ©Á∑¥Áøí",
      customDesc: "ÈÅ∏Êìá‰∏ªÈ°åÂíåÈ°åÁõÆÊï∏Èáè",
      startPractice: "ÈñãÂßãÁ∑¥Áøí",
    },
    
    // Ê∏¨È©ó‰ªãÈù¢
    quiz: {
      question: "È°åÁõÆ",
      of: "ÂÖ±",
      flagQuestion: "Ê®ôË®òÈ°åÁõÆ",
      unflagQuestion: "ÂèñÊ∂àÊ®ôË®ò",
      periodicTable: "ÂÖÉÁ¥†ÈÄ±ÊúüË°®",
      overview: "Á∏ΩË¶Ω",
      previous: "‰∏ä‰∏ÄÈ°å",
      next: "‰∏ã‰∏ÄÈ°å",
      submit: "Êèê‰∫§",
      answered: "Â∑≤Á≠î",
      flagged: "Â∑≤Ê®ôË®ò",
      skipped: "Ë∑≥ÈÅé",
      timeRemaining: "Ââ©È§òÊôÇÈñì",
      sessionTime: "Á∑¥ÁøíÊôÇÈñì",
    },
    
    // ÊàêÁ∏æ
    results: {
      yourPerformance: "ÊÇ®ÁöÑË°®Áèæ",
      totalTime: "Á∏ΩÊôÇÈñì",
      averagePerQuestion: "ÊØèÈ°åÂπ≥ÂùáÊôÇÈñì",
      strengths: "ÂÑ™Âã¢È†òÂüü",
      needsFocus: "ÈúÄË¶ÅÂä†Âº∑",
      detailedReview: "Ë©≥Á¥∞Ê™¢Ë®é",
      yourAnswer: "ÊÇ®ÁöÑÁ≠îÊ°à",
      correctAnswer: "Ê≠£Á¢∫Á≠îÊ°à",
      explanation: "Ëß£Èáã",
      shareReport: "ÂàÜ‰∫´ÊàêÁ∏æÂñÆ",
      addToNotebook: "Âä†ÂÖ•ÈåØÈ°åÁ∞ø",
      startNewSession: "ÈñãÂßãÊñ∞Á∑¥Áøí",
    },
    
    // ÂÄã‰∫∫Ë≥áÊñô
    profile: {
      profileSettings: "ÂÄã‰∫∫Ë®≠ÂÆö",
      yourStatistics: "ÊÇ®ÁöÑÁµ±Ë®àË≥áÊñô",
      displayName: "È°ØÁ§∫ÂêçÁ®±",
      email: "ÈõªÈÉµÂú∞ÂùÄ",
      schoolLevel: "Âπ¥Á¥öÔºà‰∏≠Â≠∏Ôºâ",
      studyLevel: "Áï∂ÂâçÂ≠∏ÁøíÁ®ãÂ∫¶",
      memberSince: "Ë®ªÂÜäÊó•Êúü",
      saveChanges: "ÂÑ≤Â≠òËÆäÊõ¥",
      topicExceptions: "‰∏ªÈ°å‰æãÂ§ñ",
      unlockTopic: "Ëß£Èéñ‰∏ªÈ°å",
      lockTopic: "ÈéñÂÆö‰∏ªÈ°å",
    },
    
    // ÊéíË°åÊ¶ú
    leaderboard: {
      title: "ÊéíË°åÊ¶ú",
      thisWeek: "Êú¨ÈÄ±",
      thisMonth: "Êú¨Êúà",
      allTime: "Ê≠∑Âè≤Á∏ΩÊ¶ú",
      you: "ÊÇ®",
      attempts: "Ê¨°Ê∏¨È©ó",
      questions: "È°å",
    },
    
    // Ë´ñÂ£á
    forum: {
      title: "MCQ Ë®éË´ñÂçÄ",
      discuss: "Ë®éË´ñ",
      addComment: "Êñ∞Â¢ûË©ïË´ñ",
      editComment: "Á∑®ËºØË©ïË´ñ",
      deleteComment: "Âà™Èô§Ë©ïË´ñ",
      noComments: "Â∞öÁÑ°Ë©ïË´ñ„ÄÇÊàêÁÇ∫Á¨¨‰∏ÄÂÄãË®éË´ñÁöÑ‰∫∫ÔºÅ",
      loading: "ËºâÂÖ•Ë®éË´ñ‰∏≠...",
    },
    
    // ÈåØÈ°åÁ∞ø
    notebook: {
      title: "ÈåØÈ°åÁ∞ø",
      review: "Ê™¢Ë®éÈåØÈ°å",
      practiceMistakes: "Âè™Á∑¥ÁøíÈåØÈ°å",
      cleared: "ÊâÄÊúâÈåØÈ°åÂ∑≤Ê∏ÖÈô§ÔºÅ",
      addedToNotebook: "Â∑≤Âä†ÂÖ•ÈåØÈ°åÁ∞ø",
      removedFromNotebook: "Â∑≤ÂæûÈåØÈ°åÁ∞øÁßªÈô§",
    },
    
    // ÈÄöÁî®
    common: {
      loading: "ËºâÂÖ•‰∏≠...",
      error: "ÈåØË™§",
      success: "ÊàêÂäü",
      confirm: "Á¢∫Ë™ç",
      cancel: "ÂèñÊ∂à",
      save: "ÂÑ≤Â≠ò",
      delete: "Âà™Èô§",
      edit: "Á∑®ËºØ",
      close: "ÈóúÈñâ",
      retry: "ÈáçË©¶",
      backToTopics: "ËøîÂõû‰∏ªÈ°åÈÅ∏Êìá",
    },
    
    // Ë™çË≠â
    auth: {
      login: "ÁôªÂÖ•",
      register: "Ë®ªÂÜä",
      email: "ÈõªÈÉµÂú∞ÂùÄ",
      password: "ÂØÜÁ¢º",
      confirmPassword: "Á¢∫Ë™çÂØÜÁ¢º",
      fullName: "ÂÖ®Âêç",
      createAccount: "Âª∫Á´ãÂ∏≥Êà∂",
      alreadyHaveAccount: "Â∑≤ÊúâÂ∏≥Êà∂Ôºü",
      dontHaveAccount: "ÈÇÑÊ≤íÊúâÂ∏≥Êà∂Ôºü",
      loginHere: "Âú®Ê≠§ÁôªÂÖ•",
      registerHere: "Âú®Ê≠§Ë®ªÂÜä",
    },
  },
};

export function LanguageProvider({ children }) {
  const [language, setLanguage] = useState(() => {
    // Load saved language preference or default to English
    return localStorage.getItem('chemleung_language') || 'en';
  });

  useEffect(() => {
    // Save language preference
    localStorage.setItem('chemleung_language', language);
  }, [language]);

  const toggleLanguage = () => {
    setLanguage(prev => prev === 'en' ? 'zh' : 'en');
  };

  const t = (key) => {
    const keys = key.split('.');
    let value = translations[language];
    
    for (const k of keys) {
      if (value && typeof value === 'object') {
        value = value[k];
      } else {
        return key; // Return key if translation not found
      }
    }
    
    return value || key;
  };

  // Helper for interpolation
  const tf = (key, params = {}) => {
    let text = t(key);
    Object.keys(params).forEach(param => {
      text = text.replace(`{${param}}`, params[param]);
    });
    return text;
  };

  const value = {
    language,
    setLanguage,
    toggleLanguage,
    t,
    tf,
    isEnglish: language === 'en',
    isChinese: language === 'zh',
  };

  return (
    <LanguageContext.Provider value={value}>
      {children}
    </LanguageContext.Provider>
  );
}

// ========== src/firebase/config.js ==========

// Firebase configuration and initialization
import { initializeApp } from 'firebase/app';
import { getAuth } from 'firebase/auth';
import { getFirestore } from 'firebase/firestore';

// Your web app's Firebase configuration
// TODO: Replace with your own Firebase config from Firebase Console
const firebaseConfig = {
  apiKey: "AIzaSyBKk_TsWIVQCXfIwPQXnFOXvSNQNDgyvFg",
  authDomain: "chemleung-hkdse-mcq-platform.firebaseapp.com",
  projectId: "chemleung-hkdse-mcq-platform",
  storageBucket: "chemleung-hkdse-mcq-platform.firebasestorage.app",
  messagingSenderId: "811594644247",
  appId: "1:811594644247:web:5282c3c73f1d3566955552",
  measurementId: "G-85R118KESK"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);

// Initialize Firebase services
export const auth = getAuth(app);
export const db = getFirestore(app);

export default app;

// ========== src/hooks/useQuizData.js ==========

import { useState, useEffect } from 'react';
import Papa from 'papaparse';

export function useQuizData(url) {
  const [questions, setQuestions] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  useEffect(() => {
    Papa.parse(url, {
      download: true,
      header: true,
      skipEmptyLines: 'greedy',
      newline: '',
      complete: (results) => {
        try {
          const formattedData = results.data
            .filter(row => Object.values(row).join('').trim().length > 0)
            .map((row, index) => {
              const getVal = (name) => {
                const key = Object.keys(row).find(k => k.trim().toLowerCase() === name.toLowerCase());
                return row[key] ? row[key] : "";
              };

              // Convert any type of line break to <br>
              const nl2br = (text) => {
                if (!text) return "";
                return text.split(/\r\n|\r|\n/).join('<br>');
              };

              // Remove option prefix (A. B. C. D.) from the beginning
              const removePrefix = (text) => {
                if (!text) return "";
                // Remove patterns like "A. ", "B. ", "C. ", "D. " from the start
                return text.replace(/^[A-D]\.\s*/i, '');
              };

              const rawQuestion = getVal('QuestionText');

              // Image logic
              const imgRegex = /[\{\(]image:(.*?)[\}\)]/i;
              const imgMatch = rawQuestion.match(imgRegex);
              const imageUrl = getVal('Pictureurl') || (imgMatch ? imgMatch[1] : null);
              const cleanQuestion = rawQuestion.replace(imgRegex, "");

              // CRITICAL FIX: Ensure truly unique IDs
              // Use the spreadsheet ID if available AND unique, otherwise use index
              const rawId = getVal('ID');
              const uniqueId = rawId && rawId.trim() !== "" 
                ? `${rawId}-${index}` // Combine ID with index for guaranteed uniqueness
                : `q-${index}`; // Fallback to index-based ID

              return {
                ID: uniqueId,
                Topic: getVal('Topic') || "Uncategorized",
                Subtopic: getVal('Subtopic') || "",
                Question: nl2br(cleanQuestion),
                OptionA: nl2br(removePrefix(getVal('OptionA'))),
                OptionB: nl2br(removePrefix(getVal('OptionB'))),
                OptionC: nl2br(removePrefix(getVal('OptionC'))),
                OptionD: nl2br(removePrefix(getVal('OptionD'))),
                CorrectOption: getVal('CorrectOption').toUpperCase().trim(),
                Explanation: nl2br(getVal('Explanation')),
                Pictureurl: imageUrl ? imageUrl.trim() : null,
                DSEcode: getVal('DSEcode') || getVal('DSECode')
              };
            });

          setQuestions(formattedData);
          setLoading(false);
        } catch (err) {
          setError("Failed to process data.");
          setLoading(false);
        }
      }
    });
  }, [url]);

  return { questions, loading, error };
}

// ========== src/main.jsx ==========

import { StrictMode } from 'react'
import { createRoot } from 'react-dom/client'
import './index.css'
import App from './App_Final.jsx'

createRoot(document.getElementById('root')).render(
  <StrictMode>
    <App />
  </StrictMode>,
)


// ========== src/pages/DashboardPage_Fixed.jsx ==========

import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { useAuth } from '../contexts/AuthContext';
import { useLanguage } from '../contexts/LanguageContext';
import { quizService } from '../services/quizService';
import AttemptDetailModal from '../components/AttemptDetailModal';
import {
  Trophy, Clock, Target, TrendingUp, Calendar, LogOut,
  Play, AlertCircle, RefreshCw, Flame, BookOpen, MessageSquare,
  ChevronRight,
} from 'lucide-react';

export default function DashboardPage() {
  const { currentUser, userProfile, logout } = useAuth();
  const { t, isEnglish } = useLanguage();
  const [attempts, setAttempts] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [studyStreak, setStudyStreak] = useState(0);
  const [selectedAttempt, setSelectedAttempt] = useState(null);
  const navigate = useNavigate();

  useEffect(() => {
    loadAttempts();
    calculateStudyStreak();
  }, [currentUser]);

  async function loadAttempts() {
    if (!currentUser) { setLoading(false); return; }
    try {
      setError(null);
      setLoading(true);
      const userAttempts = await quizService.getUserAttempts(currentUser.uid, 10);
      setAttempts(userAttempts);
    } catch (err) {
      setError(err.message);
    } finally {
      setLoading(false);
    }
  }

  async function calculateStudyStreak() {
    if (!currentUser) return;
    try {
      const allAttempts = await quizService.getUserAttempts(currentUser.uid, 100);
      if (!allAttempts.length) { setStudyStreak(0); return; }
      const uniqueDates = [...new Set(allAttempts.map(a => new Date(a.timestamp).toDateString()))]
        .sort((a, b) => new Date(b) - new Date(a));
      let streak = 0;
      const today = new Date().toDateString();
      const yesterday = new Date(Date.now() - 86400000).toDateString();
      if (uniqueDates[0] === today || uniqueDates[0] === yesterday) {
        streak = 1;
        for (let i = 1; i < uniqueDates.length; i++) {
          const diff = Math.floor((new Date(uniqueDates[i - 1]) - new Date(uniqueDates[i])) / 86400000);
          if (diff === 1) streak++; else break;
        }
      }
      setStudyStreak(streak);
    } catch { setStudyStreak(0); }
  }

  async function handleLogout() {
    try { await logout(); navigate('/login'); } catch (e) { console.error(e); }
  }

  const formatDate = (iso) =>
    new Date(iso).toLocaleDateString('en-GB', {
      day: '2-digit', month: 'short', year: 'numeric',
      hour: '2-digit', minute: '2-digit',
    });

  const formatTime = (ms) => {
    if (!ms) return 'N/A';
    const s = Math.floor(ms / 1000), m = Math.floor(s / 60), h = Math.floor(m / 60);
    if (h > 0) return `${h}h ${m % 60}m`;
    if (m > 0) return `${m}m ${s % 60}s`;
    return `${s}s`;
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center h-screen bg-gray-50">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500 mx-auto mb-4"></div>
          <p className="text-slate-700 font-semibold">Loading dashboard...</p>
        </div>
      </div>
    );
  }

  const overallAccuracy = userProfile?.totalQuestions > 0
    ? Math.round((userProfile.totalCorrect / userProfile.totalQuestions) * 100)
    : 0;

  return (
    <div className="max-w-6xl mx-auto space-y-6 p-4">
      {/* HEADER */}
      <div className="bg-white rounded-2xl shadow-lg p-8 border-2 border-indigo-100">
        <div className="flex justify-between items-start mb-6">
          <div>
            <h1 className="text-4xl font-black text-slate-800 mb-2 leading-tight">
              {isEnglish ? 'Welcome back' : 'Ê≠°ËøéÂõû‰æÜ'}, {currentUser?.displayName}!
            </h1>
            <p className="text-lg text-slate-600 font-medium">{currentUser?.email}</p>
          </div>
          <button
            onClick={handleLogout}
            className="flex items-center gap-2 px-4 py-2 bg-rose-500 hover:bg-rose-600 text-white rounded-xl font-bold transition-all shadow-md"
          >
            <LogOut size={18} />
            {isEnglish ? 'Logout' : 'ÁôªÂá∫'}
          </button>
        </div>

        {/* STATS GRID */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
          <div className="bg-gradient-to-br from-amber-100 to-amber-200 rounded-xl p-5 shadow-sm border border-amber-200">
            <div className="flex items-center gap-2 mb-2">
              <Trophy className="text-amber-700" size={20} />
              <span className="text-xs font-bold text-amber-800 uppercase tracking-wide">
                {isEnglish ? 'Total Attempts' : 'Á∏ΩÊ∏¨È©óÊ¨°Êï∏'}
              </span>
            </div>
            <div className="text-4xl font-black text-amber-900">{userProfile?.totalAttempts || 0}</div>
          </div>
          <div className="bg-gradient-to-br from-emerald-100 to-emerald-200 rounded-xl p-5 shadow-sm border border-emerald-200">
            <div className="flex items-center gap-2 mb-2">
              <Target className="text-emerald-700" size={20} />
              <span className="text-xs font-bold text-emerald-800 uppercase tracking-wide">
                {isEnglish ? 'Overall Accuracy' : 'Êï¥È´îÊ∫ñÁ¢∫Áéá'}
              </span>
            </div>
            <div className="text-4xl font-black text-emerald-900">{overallAccuracy}%</div>
          </div>
          <div className="bg-gradient-to-br from-purple-100 to-purple-200 rounded-xl p-5 shadow-sm border border-purple-200">
            <div className="flex items-center gap-2 mb-2">
              <TrendingUp className="text-purple-700" size={20} />
              <span className="text-xs font-bold text-purple-800 uppercase tracking-wide">
                {isEnglish ? 'Questions Solved' : 'Â∑≤ÂÆåÊàêÈ°åÁõÆ'}
              </span>
            </div>
            <div className="text-4xl font-black text-purple-900">{userProfile?.totalQuestions || 0}</div>
          </div>
          <div className="bg-gradient-to-br from-blue-100 to-blue-200 rounded-xl p-5 shadow-sm border border-blue-200">
            <div className="flex items-center gap-2 mb-2">
              <Calendar className="text-blue-700" size={20} />
              <span className="text-xs font-bold text-blue-800 uppercase tracking-wide">
                {isEnglish ? 'Correct Answers' : 'Ê≠£Á¢∫Á≠îÊ°à'}
              </span>
            </div>
            <div className="text-4xl font-black text-blue-900">{userProfile?.totalCorrect || 0}</div>
          </div>
          <div className="bg-gradient-to-br from-orange-100 to-orange-200 rounded-xl p-5 shadow-sm border border-orange-200">
            <div className="flex items-center gap-2 mb-2">
              <Flame className="text-orange-700" size={20} />
              <span className="text-xs font-bold text-orange-800 uppercase tracking-wide">
                {isEnglish ? 'Study Streak' : 'ÈÄ£Á∫åÂ≠∏ÁøíÂ§©Êï∏'}
              </span>
            </div>
            <div className="text-4xl font-black text-orange-900 flex items-baseline gap-2">
              {studyStreak}
              <span className="text-base font-bold text-orange-700">{isEnglish ? 'days' : 'Â§©'}</span>
            </div>
          </div>
        </div>
      </div>

      {/* ACTION BUTTONS */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
        <button
          onClick={() => navigate('/')}
          className="bg-gradient-to-r from-indigo-400 to-indigo-500 text-white rounded-xl p-6 font-bold text-lg shadow-md hover:shadow-lg transition-all flex items-center justify-center gap-3 active:scale-95"
        >
          <Play fill="currentColor" size={24} />
          {isEnglish ? 'Start New Quiz' : 'ÈñãÂßãÊñ∞Ê∏¨È©ó'}
        </button>
        <button
          onClick={() => navigate('/forum')}
          className="bg-gradient-to-r from-purple-400 to-purple-500 text-white rounded-xl p-6 font-bold text-lg shadow-md hover:shadow-lg transition-all flex items-center justify-center gap-3 active:scale-95"
        >
          <MessageSquare size={24} />
          {isEnglish ? 'Browse Forum' : 'ÁÄèË¶ΩË®éË´ñÂçÄ'}
        </button>
        <button
          onClick={() => navigate('/notebook')}
          className="bg-gradient-to-r from-rose-400 to-rose-500 text-white rounded-xl p-6 font-bold text-lg shadow-md hover:shadow-lg transition-all flex items-center justify-center gap-3 active:scale-95"
        >
          <BookOpen size={24} />
          {isEnglish ? 'Mistake Notebook' : 'ÈåØÈ°åÁ∞ø'}
        </button>
      </div>

      {/* Error */}
      {error && (
        <div className="bg-red-50 border-2 border-red-200 rounded-xl p-5">
          <div className="flex items-start gap-3">
            <AlertCircle className="text-red-600 flex-shrink-0 mt-1" size={20} />
            <div className="flex-1">
              <h3 className="font-bold text-red-900 mb-1">
                {isEnglish ? 'Error Loading Attempts' : 'ËºâÂÖ•Ë®òÈåÑÂ§±Êïó'}
              </h3>
              <p className="text-sm text-red-800 mb-3">{error}</p>
              <button
                onClick={loadAttempts}
                className="flex items-center gap-2 px-4 py-2 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 transition-all"
              >
                <RefreshCw size={16} />
                {isEnglish ? 'Retry' : 'ÈáçË©¶'}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Recent Attempts */}
      <div className="bg-white rounded-2xl shadow-lg border-2 border-slate-100 overflow-hidden">
        <div className="bg-slate-50 p-5 border-b-2 border-indigo-100 flex items-center justify-between">
          <h2 className="text-xl font-bold text-slate-800 flex items-center gap-2">
            <Clock className="text-indigo-600" size={24} />
            {isEnglish ? 'Recent Attempts' : 'ÊúÄËøëË®òÈåÑ'}
          </h2>
          <div className="flex items-center gap-3">
            <span className="text-xs text-slate-400 italic hidden sm:block">
              {isEnglish ? 'Click any row to see full analysis' : 'ÈªûÊìäË®òÈåÑÊü•ÁúãÂÆåÊï¥ÂàÜÊûê'}
            </span>
            <button
              onClick={loadAttempts}
              className="text-sm text-indigo-600 hover:text-indigo-700 font-bold hover:underline flex items-center gap-1"
            >
              <RefreshCw size={14} />
              {isEnglish ? 'Refresh' : 'Âà∑Êñ∞'}
            </button>
          </div>
        </div>

        <div className="p-6">
          {attempts.length === 0 ? (
            <div className="text-center py-12">
              <AlertCircle className="w-16 h-16 text-slate-300 mx-auto mb-4" />
              <p className="text-slate-600 text-lg mb-2 font-semibold">
                {isEnglish ? 'No attempts yet!' : 'Â∞öÁÑ°Ë®òÈåÑÔºÅ'}
              </p>
              <p className="text-slate-500 text-sm mb-4">
                {isEnglish ? 'Complete a quiz to see your results here' : 'ÂÆåÊàêÊ∏¨È©óÂæåË®òÈåÑÂ∞áÈ°ØÁ§∫ÊñºÊ≠§'}
              </p>
              <button
                onClick={() => navigate('/')}
                className="px-6 py-3 bg-indigo-500 text-white rounded-xl font-bold hover:bg-indigo-600 transition-all shadow-md"
              >
                {isEnglish ? 'Take Your First Quiz' : 'ÈñãÂßãÁ¨¨‰∏ÄÂÄãÊ∏¨È©ó'}
              </button>
            </div>
          ) : (
            <div className="space-y-3">
              {attempts.map((attempt) => (
                <button
                  key={attempt.id}
                  onClick={() => setSelectedAttempt(attempt)}
                  className="w-full flex items-center justify-between p-4 rounded-xl border-2 border-slate-100 hover:border-indigo-300 hover:bg-indigo-50 transition-all hover:shadow-md text-left group"
                >
                  <div className="flex items-center gap-4">
                    <div className={`w-16 h-16 rounded-xl flex items-center justify-center font-black text-2xl shadow-sm ${
                      attempt.percentage >= 70
                        ? 'bg-gradient-to-br from-emerald-100 to-emerald-200 text-emerald-800 border-2 border-emerald-300'
                        : attempt.percentage >= 50
                        ? 'bg-gradient-to-br from-amber-100 to-amber-200 text-amber-800 border-2 border-amber-300'
                        : 'bg-gradient-to-br from-rose-100 to-rose-200 text-rose-800 border-2 border-rose-300'
                    }`}>
                      {attempt.percentage}%
                    </div>
                    <div>
                      <div className="font-bold text-lg text-slate-800">
                        {attempt.correctAnswers}/{attempt.totalQuestions} {isEnglish ? 'correct' : 'Ê≠£Á¢∫'}
                      </div>
                      <div className="text-sm text-slate-600 font-medium">{formatDate(attempt.timestamp)}</div>
                      {attempt.topics && (
                        <div className="text-xs text-slate-500 mt-1 truncate max-w-xs">
                          {attempt.topics.join(', ')}
                        </div>
                      )}
                    </div>
                  </div>
                  <div className="flex items-center gap-3">
                    {attempt.timeSpent && (
                      <div className="text-right hidden sm:block">
                        <div className="text-sm font-bold text-slate-700">‚è±Ô∏è {formatTime(attempt.timeSpent)}</div>
                        <div className="text-xs text-slate-500">{isEnglish ? 'Time spent' : 'Áî®ÊôÇ'}</div>
                      </div>
                    )}
                    <ChevronRight size={20} className="text-slate-400 group-hover:text-indigo-500 transition-colors" />
                  </div>
                </button>
              ))}
            </div>
          )}
        </div>
      </div>

      {/* Attempt Detail Modal */}
      {selectedAttempt && (
        <AttemptDetailModal
          attempt={selectedAttempt}
          onClose={() => setSelectedAttempt(null)}
        />
      )}
    </div>
  );
}

// ========== src/pages/DebugDashboard.jsx ==========

import React, { useState, useEffect } from 'react';
import { useAuth } from '../contexts/AuthContext';
import { quizService } from '../services/quizService';
import { collection, getDocs, query, where, orderBy, limit } from 'firebase/firestore';
import { db } from '../firebase/config';
import { CheckCircle, XCircle, AlertCircle, Database, RefreshCw } from 'lucide-react';

export default function DebugDashboard() {
  const { currentUser, userProfile } = useAuth();
  const [logs, setLogs] = useState([]);
  const [testing, setTesting] = useState(false);
  const [rawData, setRawData] = useState(null);

  const addLog = (type, message) => {
    setLogs(prev => [...prev, { type, message, timestamp: new Date().toLocaleTimeString() }]);
  };

  async function testEverything() {
    setLogs([]);
    setTesting(true);
    
    addLog('info', 'üîç Starting comprehensive diagnostics...');
    
    // Test 1: Check Authentication
    addLog('info', '--- TEST 1: Authentication ---');
    if (currentUser) {
      addLog('success', `‚úÖ User authenticated: ${currentUser.email}`);
      addLog('info', `User ID: ${currentUser.uid}`);
    } else {
      addLog('error', '‚ùå No user authenticated');
      setTesting(false);
      return;
    }

    // Test 2: Check User Profile
    addLog('info', '--- TEST 2: User Profile ---');
    if (userProfile) {
      addLog('success', `‚úÖ Profile loaded`);
      addLog('info', `Display Name: ${userProfile.displayName}`);
      addLog('info', `Total Attempts: ${userProfile.totalAttempts || 0}`);
      addLog('info', `Total Questions: ${userProfile.totalQuestions || 0}`);
      addLog('info', `Total Correct: ${userProfile.totalCorrect || 0}`);
    } else {
      addLog('error', '‚ùå Profile not loaded');
    }

    // Test 3: Direct Firestore Read - Users Collection
    addLog('info', '--- TEST 3: Direct Firestore Read (Users) ---');
    try {
      const { doc, getDoc } = await import('firebase/firestore');
      const userDocRef = doc(db, 'users', currentUser.uid);
      const userDocSnap = await getDoc(userDocRef);
      
      if (userDocSnap.exists()) {
        addLog('success', '‚úÖ User document exists in Firestore');
        addLog('info', `Data: ${JSON.stringify(userDocSnap.data())}`);
      } else {
        addLog('error', '‚ùå User document does NOT exist in Firestore');
      }
    } catch (error) {
      addLog('error', `‚ùå Error reading user document: ${error.message}`);
    }

    // Test 4: Direct Firestore Read - Attempts Collection
    addLog('info', '--- TEST 4: Direct Firestore Read (Attempts) ---');
    try {
      const attemptsQuery = query(
        collection(db, 'attempts'),
        where('userId', '==', currentUser.uid),
        orderBy('timestamp', 'desc'),
        limit(10)
      );
      
      const querySnapshot = await getDocs(attemptsQuery);
      addLog('info', `Found ${querySnapshot.size} attempts in Firestore`);
      
      if (querySnapshot.size > 0) {
        addLog('success', `‚úÖ Attempts collection has data`);
        querySnapshot.forEach((doc) => {
          const data = doc.data();
          addLog('info', `Attempt ${doc.id}: ${data.percentage}% - ${data.timestamp}`);
        });
      } else {
        addLog('warning', '‚ö†Ô∏è Attempts collection is EMPTY - no quiz results saved yet');
      }

      setRawData({ attempts: querySnapshot.size });
    } catch (error) {
      addLog('error', `‚ùå Error reading attempts: ${error.message}`);
      if (error.code === 'failed-precondition') {
        addLog('error', '‚ùå FIRESTORE INDEX MISSING! You need to create an index.');
        addLog('info', 'Firebase will show a link in the console to create the index automatically.');
      }
    }

    // Test 5: Test Save Function
    addLog('info', '--- TEST 5: Test Save Attempt ---');
    try {
      const testAttemptData = {
        score: 85,
        totalQuestions: 10,
        correctAnswers: 8,
        percentage: 80,
        topics: ['Test Topic'],
        timeSpent: 120000,
        questionTimes: {},
        answers: {}
      };

      addLog('info', 'Attempting to save test quiz result...');
      const attemptId = await quizService.saveAttempt(currentUser.uid, testAttemptData);
      addLog('success', `‚úÖ Test attempt saved successfully! ID: ${attemptId}`);
    } catch (error) {
      addLog('error', `‚ùå Failed to save test attempt: ${error.message}`);
      addLog('error', `Error code: ${error.code}`);
    }

    // Test 6: Test Fetch Function
    addLog('info', '--- TEST 6: Test Fetch Attempts ---');
    try {
      const attempts = await quizService.getUserAttempts(currentUser.uid, 5);
      addLog('success', `‚úÖ Successfully fetched ${attempts.length} attempts`);
      if (attempts.length > 0) {
        attempts.forEach((att, idx) => {
          addLog('info', `Attempt ${idx + 1}: ${att.percentage}% (${att.correctAnswers}/${att.totalQuestions})`);
        });
      }
    } catch (error) {
      addLog('error', `‚ùå Failed to fetch attempts: ${error.message}`);
    }

    // Test 7: Check Leaderboard
    addLog('info', '--- TEST 7: Test Leaderboard ---');
    try {
      const leaderboard = await quizService.getWeeklyLeaderboard(5);
      addLog('success', `‚úÖ Leaderboard loaded with ${leaderboard.length} users`);
    } catch (error) {
      addLog('error', `‚ùå Failed to load leaderboard: ${error.message}`);
    }

    addLog('info', '‚úÖ Diagnostics complete!');
    setTesting(false);
  }

  async function createTestAttempt() {
    if (!currentUser) {
      addLog('error', '‚ùå Must be logged in');
      return;
    }

    addLog('info', 'Creating test quiz attempt...');
    
    try {
      const testAttemptData = {
        score: Math.floor(Math.random() * 40) + 60, // Random 60-100
        totalQuestions: 10,
        correctAnswers: Math.floor(Math.random() * 4) + 6, // Random 6-10
        percentage: Math.floor(Math.random() * 40) + 60,
        topics: ['Organic Chemistry', 'Acids and Bases'],
        timeSpent: Math.floor(Math.random() * 300000) + 60000, // Random 1-6 min
        questionTimes: {},
        answers: {}
      };

      const attemptId = await quizService.saveAttempt(currentUser.uid, testAttemptData);
      addLog('success', `‚úÖ Test attempt created! ID: ${attemptId}`);
      addLog('info', 'Now check Dashboard and History pages to see if it appears');
    } catch (error) {
      addLog('error', `‚ùå Failed to create test attempt: ${error.message}`);
    }
  }

  const getLogIcon = (type) => {
    switch (type) {
      case 'success':
        return <CheckCircle className="text-green-500" size={16} />;
      case 'error':
        return <XCircle className="text-red-500" size={16} />;
      case 'warning':
        return <AlertCircle className="text-amber-500" size={16} />;
      default:
        return <Database className="text-blue-500" size={16} />;
    }
  };

  return (
    <div className="max-w-6xl mx-auto space-y-6">
      <div className="bg-gradient-to-r from-red-600 to-orange-600 rounded-2xl shadow-xl p-6 text-white">
        <h1 className="text-3xl font-black flex items-center gap-3">
          <Database size={32} />
          Firebase Debug Dashboard
        </h1>
        <p className="text-orange-100 mt-1">
          Comprehensive diagnostics for data saving issues
        </p>
      </div>

      {/* Quick Actions */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        <button
          onClick={testEverything}
          disabled={testing}
          className="py-6 bg-lab-blue text-white rounded-xl font-bold text-lg shadow-lg hover:bg-blue-800 disabled:bg-slate-300 transition-all flex items-center justify-center gap-2"
        >
          {testing ? (
            <>
              <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
              Running Tests...
            </>
          ) : (
            <>
              <RefreshCw size={20} />
              Run Full Diagnostics
            </>
          )}
        </button>

        <button
          onClick={createTestAttempt}
          className="py-6 bg-chemistry-green text-white rounded-xl font-bold text-lg shadow-lg hover:opacity-90 transition-all flex items-center justify-center gap-2"
        >
          <Database size={20} />
          Create Test Quiz Attempt
        </button>
      </div>

      {/* Console Output */}
      <div className="bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
        <div className="bg-slate-800 p-4 border-b">
          <h2 className="text-lg font-bold text-white font-mono flex items-center gap-2">
            <Database size={20} />
            Console Output
          </h2>
        </div>

        <div className="p-4 bg-slate-900 max-h-[600px] overflow-y-auto">
          {logs.length === 0 ? (
            <p className="text-slate-500 text-center py-8 font-mono">
              Click "Run Full Diagnostics" to start testing...
            </p>
          ) : (
            <div className="space-y-2 font-mono text-sm">
              {logs.map((log, idx) => (
                <div
                  key={idx}
                  className={`flex items-start gap-3 p-2 rounded ${
                    log.type === 'error' ? 'bg-red-900/20' :
                    log.type === 'success' ? 'bg-green-900/20' :
                    log.type === 'warning' ? 'bg-amber-900/20' :
                    'bg-slate-800'
                  }`}
                >
                  {getLogIcon(log.type)}
                  <span className="text-slate-400 text-xs">[{log.timestamp}]</span>
                  <span className={
                    log.type === 'error' ? 'text-red-400' :
                    log.type === 'success' ? 'text-green-400' :
                    log.type === 'warning' ? 'text-amber-400' :
                    'text-blue-400'
                  }>
                    {log.message}
                  </span>
                </div>
              ))}
            </div>
          )}
        </div>
      </div>

      {/* Instructions */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div className="bg-blue-50 border-2 border-blue-200 rounded-xl p-4">
          <h3 className="font-bold text-blue-900 mb-2 flex items-center gap-2">
            <CheckCircle size={18} />
            What Success Looks Like
          </h3>
          <ul className="text-sm text-blue-800 space-y-1">
            <li>‚úÖ User authenticated</li>
            <li>‚úÖ Profile loaded</li>
            <li>‚úÖ User document exists</li>
            <li>‚úÖ Can read attempts collection</li>
            <li>‚úÖ Can save test attempt</li>
            <li>‚úÖ Can fetch attempts</li>
            <li>‚úÖ Leaderboard loads</li>
          </ul>
        </div>

        <div className="bg-red-50 border-2 border-red-200 rounded-xl p-4">
          <h3 className="font-bold text-red-900 mb-2 flex items-center gap-2">
            <XCircle size={18} />
            Common Errors & Fixes
          </h3>
          <ul className="text-sm text-red-800 space-y-2">
            <li><strong>Permission denied:</strong> Update Firestore rules</li>
            <li><strong>Failed precondition:</strong> Missing Firestore index</li>
            <li><strong>Not authenticated:</strong> Log in first</li>
            <li><strong>Empty attempts:</strong> Complete a quiz first</li>
          </ul>
        </div>
      </div>

      {/* Firestore Rules Reminder */}
      <div className="bg-amber-50 border-2 border-amber-200 rounded-xl p-4">
        <h3 className="font-bold text-amber-900 mb-2">üìã Required Firestore Rules</h3>
        <pre className="bg-slate-900 text-green-400 p-4 rounded-lg overflow-x-auto text-xs">
{`rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{userId} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    match /attempts/{attemptId} {
      allow read: if true;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }
  }
}`}
        </pre>
        <p className="text-sm text-amber-800 mt-2">
          Copy this to Firebase Console ‚Üí Firestore Database ‚Üí Rules tab ‚Üí Publish
        </p>
      </div>
    </div>
  );
}

// ========== src/pages/FirebaseTestPage.jsx ==========

import React, { useState } from 'react';
import { useAuth } from '../contexts/AuthContext';
import { quizService } from '../services/quizService';
import { CheckCircle, XCircle, AlertCircle } from 'lucide-react';

export default function FirebaseTestPage() {
  const { currentUser, userProfile } = useAuth();
  const [testResults, setTestResults] = useState({});
  const [testing, setTesting] = useState(false);

  async function runTests() {
    setTesting(true);
    const results = {};

    // Test 1: Check if user is authenticated
    results.auth = {
      status: currentUser ? 'success' : 'error',
      message: currentUser 
        ? `‚úÖ Authenticated as ${currentUser.email}` 
        : '‚ùå Not authenticated'
    };

    // Test 2: Check if user profile exists
    results.profile = {
      status: userProfile ? 'success' : 'error',
      message: userProfile 
        ? `‚úÖ Profile loaded (${userProfile.totalAttempts} attempts)` 
        : '‚ùå Profile not found'
    };

    // Test 3: Try to save a test attempt
    if (currentUser) {
      try {
        const testAttempt = {
          score: 75,
          totalQuestions: 10,
          correctAnswers: 7,
          percentage: 70,
          topics: ['Test Topic'],
          timeSpent: 120000,
          questionTimes: {},
          answers: {}
        };

        const attemptId = await quizService.saveAttempt(currentUser.uid, testAttempt);
        results.saveAttempt = {
          status: 'success',
          message: `‚úÖ Test attempt saved! ID: ${attemptId}`
        };
      } catch (error) {
        results.saveAttempt = {
          status: 'error',
          message: `‚ùå Failed to save attempt: ${error.message}`
        };
      }
    } else {
      results.saveAttempt = {
        status: 'warning',
        message: '‚ö†Ô∏è Skipped - not authenticated'
      };
    }

    // Test 4: Try to fetch user attempts
    if (currentUser) {
      try {
        const attempts = await quizService.getUserAttempts(currentUser.uid, 5);
        results.fetchAttempts = {
          status: 'success',
          message: `‚úÖ Fetched ${attempts.length} attempts`
        };
      } catch (error) {
        results.fetchAttempts = {
          status: 'error',
          message: `‚ùå Failed to fetch attempts: ${error.message}`
        };
      }
    } else {
      results.fetchAttempts = {
        status: 'warning',
        message: '‚ö†Ô∏è Skipped - not authenticated'
      };
    }

    // Test 5: Check leaderboard
    try {
      const leaderboard = await quizService.getWeeklyLeaderboard(5);
      results.leaderboard = {
        status: 'success',
        message: `‚úÖ Leaderboard loaded (${leaderboard.length} users)`
      };
    } catch (error) {
      results.leaderboard = {
        status: 'error',
        message: `‚ùå Failed to load leaderboard: ${error.message}`
      };
    }

    setTestResults(results);
    setTesting(false);
  }

  const getIcon = (status) => {
    switch (status) {
      case 'success':
        return <CheckCircle className="text-green-500" size={24} />;
      case 'error':
        return <XCircle className="text-red-500" size={24} />;
      case 'warning':
        return <AlertCircle className="text-amber-500" size={24} />;
      default:
        return null;
    }
  };

  return (
    <div className="max-w-4xl mx-auto space-y-6">
      <div className="bg-gradient-to-r from-purple-600 to-blue-600 rounded-2xl shadow-xl p-6 text-white">
        <h1 className="text-3xl font-black">Firebase Connection Test</h1>
        <p className="text-purple-100 mt-1">
          Diagnose data saving issues
        </p>
      </div>

      <div className="bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
        <div className="p-6">
          <button
            onClick={runTests}
            disabled={testing}
            className="w-full py-4 bg-lab-blue text-white rounded-xl font-bold text-lg shadow-lg hover:bg-blue-800 disabled:bg-slate-300 disabled:cursor-not-allowed transition-all flex items-center justify-center gap-2"
          >
            {testing ? (
              <>
                <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
                Running Tests...
              </>
            ) : (
              'Run Firebase Tests'
            )}
          </button>
        </div>

        {Object.keys(testResults).length > 0 && (
          <div className="border-t border-slate-200 p-6 space-y-4">
            <h2 className="text-xl font-bold text-slate-800 mb-4">Test Results</h2>
            
            {Object.entries(testResults).map(([test, result]) => (
              <div
                key={test}
                className="flex items-start gap-4 p-4 rounded-lg border-2 border-slate-100"
              >
                {getIcon(result.status)}
                <div className="flex-1">
                  <div className="font-bold text-slate-800 capitalize mb-1">
                    {test.replace(/([A-Z])/g, ' $1').trim()}
                  </div>
                  <div className="text-sm text-slate-600">
                    {result.message}
                  </div>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>

      <div className="bg-blue-50 border-2 border-blue-200 rounded-xl p-4">
        <h3 className="font-bold text-blue-900 mb-2">üí° How to interpret results:</h3>
        <ul className="text-sm text-blue-800 space-y-1">
          <li><strong>Auth:</strong> Should show your email if logged in</li>
          <li><strong>Profile:</strong> Should load your user data from Firestore</li>
          <li><strong>Save Attempt:</strong> Should successfully save a test quiz result</li>
          <li><strong>Fetch Attempts:</strong> Should retrieve your quiz history</li>
          <li><strong>Leaderboard:</strong> Should load ranking data</li>
        </ul>
      </div>

      <div className="bg-red-50 border-2 border-red-200 rounded-xl p-4">
        <h3 className="font-bold text-red-900 mb-2">üîß Common Issues:</h3>
        <ul className="text-sm text-red-800 space-y-2">
          <li>
            <strong>‚ùå Not authenticated:</strong> Make sure you're logged in
          </li>
          <li>
            <strong>‚ùå Failed to save/fetch:</strong> Check Firebase Firestore rules
          </li>
          <li>
            <strong>‚ùå Permission denied:</strong> Update Firestore security rules to allow read/write
          </li>
        </ul>
      </div>

      <div className="bg-amber-50 border-2 border-amber-200 rounded-xl p-4">
        <h3 className="font-bold text-amber-900 mb-2">üìã Recommended Firestore Rules:</h3>
        <pre className="bg-slate-900 text-green-400 p-4 rounded-lg overflow-x-auto text-xs">
{`rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Users collection
    match /users/{userId} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Attempts collection
    match /attempts/{attemptId} {
      allow read: if true;
      allow write: if request.auth != null;
    }
  }
}`}
        </pre>
      </div>
    </div>
  );
}

// ========== src/pages/Forumpage.jsx ==========

import React, { useState, useEffect, useCallback } from 'react';
import { useNavigate } from 'react-router-dom';
import { useAuth } from '../contexts/AuthContext';
import { useLanguage } from '../contexts/LanguageContext';
import { useQuizData } from '../hooks/useQuizData';
import { forumService, canEditComment, editTimeRemaining } from '../services/forumService';
import {
  MessageSquare, ArrowLeft, Search, TrendingUp, Clock, MessageCircle,
  PlusCircle, X, Send, Edit2, Trash2, ThumbsUp, Bell, BellDot,
  Lock, Tag, Pin, ChevronLeft, AlertCircle
} from 'lucide-react';
import QuestionForum from '../components/QuestionForum';

const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTK36yaUN-NMCkQNT-DAHgc6FMZPjUc0Yv3nYEK4TA9W2qE9V1TqVD10Tq98-wXQoAvKOZlwGWRSDkU/pub?gid=1182550140&single=true&output=csv';

const CATEGORIES = ['general', 'question', 'announcement'];

// ‚îÄ‚îÄ Notification Panel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function NotificationPanel({ userId, isEnglish, onClose }) {
  const [notifs, setNotifs] = useState([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    setLoading(true);
    const unsub = forumService.subscribeToNotifications(userId, (data) => {
      setNotifs(data);
      setLoading(false);
    });
    return () => unsub && unsub();
  }, [userId]);

  const handleMarkAllRead = async () => {
    await forumService.markAllNotificationsRead(userId);
  };

  const handleMarkRead = async (id) => {
    await forumService.markNotificationRead(id);
  };

  const typeLabel = (n, en) => {
    switch (n.type) {
      case 'like': return en ? `liked your comment` : 'ÈªûËÆö‰∫ÜÊÇ®ÁöÑË©ïË´ñ';
      case 'reply': return en ? `replied to your post` : 'ÂõûË¶Ü‰∫ÜÊÇ®ÁöÑÂ∏ñÂ≠ê';
      case 'post_like': return en ? `liked your post` : 'ÈªûËÆö‰∫ÜÊÇ®ÁöÑÂ∏ñÂ≠ê';
      case 'reply_like': return en ? `liked your reply` : 'ÈªûËÆö‰∫ÜÊÇ®ÁöÑÂõûË¶Ü';
      default: return en ? 'interacted with your content' : '‰∫íÂãï‰∫ÜÊÇ®ÁöÑÂÖßÂÆπ';
    }
  };

  const formatAgo = (iso) => {
    const diffMs = Date.now() - new Date(iso).getTime();
    const mins = Math.floor(diffMs / 60000);
    if (mins < 1) return isEnglish ? 'Just now' : 'ÂâõÂâõ';
    if (mins < 60) return `${mins}m`;
    const hrs = Math.floor(mins / 60);
    if (hrs < 24) return `${hrs}h`;
    return `${Math.floor(hrs / 24)}d`;
  };

  const unread = notifs.filter(n => !n.read).length;

  return (
    <div className="absolute right-0 top-12 w-80 bg-white rounded-2xl shadow-2xl border-2 border-slate-200 z-50 overflow-hidden max-h-[480px] flex flex-col">
      <div className="p-4 border-b flex items-center justify-between bg-slate-50">
        <h3 className="font-bold text-slate-800 flex items-center gap-2">
          <Bell size={18} />
          {isEnglish ? 'Notifications' : 'ÈÄöÁü•'}
          {unread > 0 && <span className="bg-red-500 text-white text-xs rounded-full px-2 py-0.5">{unread}</span>}
        </h3>
        <div className="flex items-center gap-2">
          {unread > 0 && (
            <button onClick={handleMarkAllRead} className="text-xs text-lab-blue hover:underline font-semibold">
              {isEnglish ? 'Mark all read' : 'ÂÖ®ÈÉ®Â∑≤ËÆÄ'}
            </button>
          )}
          <button onClick={onClose} className="p-1 hover:bg-slate-200 rounded"><X size={16} /></button>
        </div>
      </div>

      <div className="overflow-y-auto flex-1">
        {loading ? (
          <div className="flex justify-center py-8"><div className="animate-spin rounded-full h-6 w-6 border-b-2 border-lab-blue" /></div>
        ) : notifs.length === 0 ? (
          <div className="text-center py-10 text-slate-400 text-sm">{isEnglish ? 'No notifications yet' : 'Êö´ÁÑ°ÈÄöÁü•'}</div>
        ) : (
          notifs.map(n => (
            <div key={n.id} onClick={() => handleMarkRead(n.id)}
              className={`p-4 border-b cursor-pointer hover:bg-slate-50 transition-all ${!n.read ? 'bg-blue-50' : ''}`}>
              <div className="flex items-start gap-3">
                <div className={`w-2 h-2 rounded-full mt-2 flex-shrink-0 ${!n.read ? 'bg-lab-blue' : 'bg-transparent'}`} />
                <div className="flex-1 min-w-0">
                  <p className="text-sm text-slate-800 font-medium leading-snug">
                    <span className="font-bold">Someone</span> {typeLabel(n, isEnglish)}
                  </p>
                  {n.previewText && (
                    <p className="text-xs text-slate-500 mt-1 truncate">"{n.previewText}"</p>
                  )}
                  {n.postTitle && (
                    <p className="text-xs text-lab-blue mt-0.5 truncate">‚Üí {n.postTitle}</p>
                  )}
                  <p className="text-xs text-slate-400 mt-1">{formatAgo(n.createdAt)}</p>
                </div>
              </div>
            </div>
          ))
        )}
      </div>
    </div>
  );
}

// ‚îÄ‚îÄ General Forum Post Detail ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function PostDetail({ postId, currentUser, isEnglish, onBack }) {
  const [post, setPost] = useState(null);
  const [replies, setReplies] = useState([]);
  const [loading, setLoading] = useState(true);
  const [newReply, setNewReply] = useState('');
  const [submitting, setSubmitting] = useState(false);
  const [editingId, setEditingId] = useState(null); // 'post' | reply id
  const [editText, setEditText] = useState('');
  const [editTitle, setEditTitle] = useState('');
  const [, forceUpdate] = useState(0);

  useEffect(() => { loadAll(); }, [postId]);
  useEffect(() => {
    const i = setInterval(() => forceUpdate(n => n + 1), 10000);
    return () => clearInterval(i);
  }, []);

  async function loadAll() {
    setLoading(true);
    try {
      const [p, r] = await Promise.all([forumService.getPost(postId), forumService.getReplies(postId)]);
      setPost(p); setReplies(r);
    } catch { /* post may have been deleted */ }
    setLoading(false);
  }

  async function handleReply() {
    if (!newReply.trim() || !currentUser) return;
    setSubmitting(true);
    try {
      await forumService.addReply(postId, currentUser.uid, currentUser.displayName || 'Anonymous', newReply.trim());
      setNewReply(''); await loadAll();
    } catch (e) { alert(e.message); }
    setSubmitting(false);
  }

  async function handleEditPost() {
    try {
      await forumService.updatePost(postId, currentUser.uid, editText, editTitle || undefined);
      setEditingId(null); await loadAll();
    } catch (e) {
      if (e.message === 'EDIT_EXPIRED') alert(isEnglish ? 'Edit window expired (15 min).' : 'Á∑®ËºØÊôÇÈñìÂ∑≤ÈÅéÔºà15ÂàÜÈêòÔºâ„ÄÇ');
      else alert(e.message);
    }
  }

  async function handleDeletePost() {
    if (!window.confirm(isEnglish ? 'Delete this post?' : 'Âà™Èô§Ê≠§Â∏ñÂ≠êÔºü')) return;
    await forumService.deletePost(postId);
    onBack();
  }

  async function handleEditReply(replyId) {
    try {
      await forumService.updateReply(replyId, editText);
      setEditingId(null); await loadAll();
    } catch (e) {
      if (e.message === 'EDIT_EXPIRED') alert(isEnglish ? 'Edit window expired.' : 'Á∑®ËºØÊôÇÈñìÂ∑≤ÈÅé„ÄÇ');
      else alert(e.message);
    }
  }

  async function handleDeleteReply(replyId) {
    if (!window.confirm(isEnglish ? 'Delete this reply?' : 'Âà™Èô§Ê≠§ÂõûË¶ÜÔºü')) return;
    await forumService.deleteReply(replyId); await loadAll();
  }

  async function handleLikePost() {
    if (!currentUser) return;
    await forumService.togglePostLike(postId, currentUser.uid); await loadAll();
  }

  async function handleLikeReply(replyId) {
    if (!currentUser) return;
    await forumService.toggleReplyLike(replyId, currentUser.uid); await loadAll();
  }

  const formatDate = (iso) => {
    const d = new Date(iso), now = new Date();
    const mins = Math.floor((now - d) / 60000);
    if (mins < 1) return isEnglish ? 'Just now' : 'ÂâõÂâõ';
    if (mins < 60) return `${mins} ${isEnglish ? 'min ago' : 'ÂàÜÈêòÂâç'}`;
    if (mins < 1440) return `${Math.floor(mins / 60)} ${isEnglish ? 'hr ago' : 'Â∞èÊôÇÂâç'}`;
    return d.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
  };

  const categoryColor = { general: 'bg-blue-100 text-blue-700', question: 'bg-amber-100 text-amber-700', announcement: 'bg-purple-100 text-purple-700' };

  if (loading) return <div className="flex justify-center py-16"><div className="animate-spin rounded-full h-10 w-10 border-b-2 border-lab-blue" /></div>;
  if (!post) return <div className="text-center py-12 text-slate-400">{isEnglish ? 'Post not found.' : 'Â∏ñÂ≠ê‰∏çÂ≠òÂú®„ÄÇ'}</div>;

  return (
    <div className="space-y-4">
      <button onClick={onBack} className="flex items-center gap-2 text-sm font-bold text-slate-600 hover:text-lab-blue transition-colors">
        <ChevronLeft size={18} /> {isEnglish ? 'Back to forum' : 'ËøîÂõûË®éË´ñÂçÄ'}
      </button>

      {/* Post */}
      <div className="bg-white rounded-2xl shadow-lg border-2 border-slate-200 overflow-hidden">
        <div className="p-6">
          <div className="flex items-start justify-between gap-4 mb-4">
            <div className="flex-1">
              <div className="flex items-center gap-2 mb-2">
                <span className={`text-xs font-bold px-2 py-1 rounded-full ${categoryColor[post.category] || categoryColor.general}`}>
                  {post.category?.toUpperCase()}
                </span>
                {post.edited && <span className="text-xs text-slate-400 italic">({isEnglish ? 'edited' : 'Â∑≤Á∑®ËºØ'})</span>}
              </div>
              {editingId === 'post' ? (
                <div className="space-y-2">
                  <input value={editTitle} onChange={e => setEditTitle(e.target.value)}
                    className="w-full px-3 py-2 border-2 border-slate-200 rounded-lg outline-none focus:border-lab-blue font-bold text-lg" />
                  <textarea value={editText} onChange={e => setEditText(e.target.value)} rows="4"
                    className="w-full px-3 py-2 border-2 border-slate-200 rounded-lg outline-none focus:border-lab-blue resize-none" />
                  <div className="flex gap-2">
                    <button onClick={handleEditPost} className="px-4 py-2 bg-lab-blue text-white rounded-lg font-bold text-sm">{isEnglish ? 'Save' : 'ÂÑ≤Â≠ò'}</button>
                    <button onClick={() => setEditingId(null)} className="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg font-bold text-sm">{isEnglish ? 'Cancel' : 'ÂèñÊ∂à'}</button>
                  </div>
                </div>
              ) : (
                <>
                  <h2 className="text-2xl font-black text-slate-800 mb-3">{post.title}</h2>
                  <p className="text-slate-700 leading-relaxed whitespace-pre-wrap">{post.content}</p>
                </>
              )}
            </div>
            {currentUser && post.userId === currentUser.uid && editingId !== 'post' && (
              <div className="flex items-center gap-1 flex-shrink-0">
                {canEditComment(post.createdAt) ? (
                  <button onClick={() => { setEditingId('post'); setEditText(post.content); setEditTitle(post.title); }}
                    className="p-2 hover:bg-blue-100 rounded-lg transition-all"><Edit2 size={16} className="text-lab-blue" /></button>
                ) : (
                  <button disabled className="p-2 opacity-30 cursor-not-allowed rounded-lg"><Lock size={16} className="text-slate-400" /></button>
                )}
                <button onClick={handleDeletePost} className="p-2 hover:bg-red-100 rounded-lg transition-all"><Trash2 size={16} className="text-red-500" /></button>
              </div>
            )}
          </div>
          <div className="flex items-center justify-between pt-4 border-t border-slate-200">
            <div className="flex items-center gap-3 text-sm text-slate-500">
              <div className="w-7 h-7 rounded-full bg-slate-300 flex items-center justify-center text-xs font-bold text-slate-700">
                {post.userDisplayName?.charAt(0).toUpperCase() || 'U'}
              </div>
              <span className="font-semibold">{post.userDisplayName}</span>
              <span>¬∑</span>
              <span>{formatDate(post.createdAt)}</span>
            </div>
            <button onClick={handleLikePost} disabled={!currentUser}
              className={`flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-sm font-bold transition-all ${post.likedBy?.includes(currentUser?.uid) ? 'bg-blue-100 text-lab-blue' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}>
              <ThumbsUp size={14} fill={post.likedBy?.includes(currentUser?.uid) ? 'currentColor' : 'none'} />
              {post.likes || 0}
            </button>
          </div>
        </div>
      </div>

      {/* Replies */}
      <div className="space-y-3">
        <h3 className="font-bold text-slate-700">{replies.length} {isEnglish ? 'Replies' : 'ÂâáÂõûË¶Ü'}</h3>
        {replies.map(reply => {
          const isOwner = currentUser && reply.userId === currentUser.uid;
          return (
            <div key={reply.id} className="bg-white rounded-xl border-2 border-slate-200 p-4">
              <div className="flex items-start justify-between gap-3 mb-2">
                <div className="flex items-center gap-2">
                  <div className="w-7 h-7 rounded-full bg-lab-blue flex items-center justify-center text-white text-xs font-bold">
                    {reply.userDisplayName?.charAt(0).toUpperCase() || 'U'}
                  </div>
                  <div>
                    <span className="font-bold text-slate-800 text-sm">{reply.userDisplayName}</span>
                    <span className="text-xs text-slate-400 ml-2">{formatDate(reply.createdAt)}</span>
                    {reply.edited && <span className="text-xs text-slate-400 italic ml-1">({isEnglish ? 'edited' : 'Â∑≤Á∑®ËºØ'})</span>}
                  </div>
                </div>
                {isOwner && (
                  <div className="flex items-center gap-1">
                    {canEditComment(reply.createdAt) ? (
                      <button onClick={() => { setEditingId(reply.id); setEditText(reply.text); }}
                        className="p-1.5 hover:bg-blue-100 rounded-lg"><Edit2 size={14} className="text-lab-blue" /></button>
                    ) : (
                      <button disabled className="p-1.5 opacity-30 cursor-not-allowed rounded-lg"><Lock size={14} className="text-slate-400" /></button>
                    )}
                    <button onClick={() => handleDeleteReply(reply.id)} className="p-1.5 hover:bg-red-100 rounded-lg"><Trash2 size={14} className="text-red-500" /></button>
                  </div>
                )}
              </div>
              {editingId === reply.id ? (
                <div className="space-y-2">
                  <textarea value={editText} onChange={e => setEditText(e.target.value)} rows="3"
                    className="w-full px-3 py-2 border-2 border-slate-200 rounded-lg outline-none focus:border-lab-blue resize-none text-sm" />
                  <div className="flex gap-2">
                    <button onClick={() => handleEditReply(reply.id)} className="px-3 py-1.5 bg-lab-blue text-white rounded-lg font-bold text-xs">{isEnglish ? 'Save' : 'ÂÑ≤Â≠ò'}</button>
                    <button onClick={() => setEditingId(null)} className="px-3 py-1.5 bg-slate-200 text-slate-700 rounded-lg font-bold text-xs">{isEnglish ? 'Cancel' : 'ÂèñÊ∂à'}</button>
                  </div>
                </div>
              ) : (
                <div className="flex items-start justify-between gap-4">
                  <p className="text-slate-700 text-sm leading-relaxed whitespace-pre-wrap flex-1">{reply.text}</p>
                  <button onClick={() => handleLikeReply(reply.id)} disabled={!currentUser}
                    className={`flex items-center gap-1 px-2 py-1 rounded-lg text-xs font-bold transition-all flex-shrink-0 ${reply.likedBy?.includes(currentUser?.uid) ? 'bg-blue-100 text-lab-blue' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'}`}>
                    <ThumbsUp size={12} fill={reply.likedBy?.includes(currentUser?.uid) ? 'currentColor' : 'none'} />
                    {reply.likes || 0}
                  </button>
                </div>
              )}
            </div>
          );
        })}
      </div>

      {/* Reply Input */}
      {currentUser ? (
        <div className="bg-white rounded-xl border-2 border-slate-200 p-4">
          <div className="flex gap-3">
            <div className="w-8 h-8 rounded-full bg-lab-blue flex items-center justify-center flex-shrink-0">
              <span className="text-white font-bold text-xs">{currentUser.displayName?.charAt(0).toUpperCase() || 'U'}</span>
            </div>
            <div className="flex-1">
              <textarea value={newReply} onChange={e => setNewReply(e.target.value)} rows="3"
                placeholder={isEnglish ? 'Write a reply...' : 'Êí∞ÂØ´ÂõûË¶Ü...'}
                className="w-full px-3 py-2 border-2 border-slate-200 rounded-lg outline-none focus:border-lab-blue resize-none text-sm" />
              <div className="flex justify-end mt-2">
                <button onClick={handleReply} disabled={!newReply.trim() || submitting}
                  className="flex items-center gap-2 px-4 py-2 bg-lab-blue text-white rounded-lg font-bold text-sm hover:bg-blue-700 disabled:bg-slate-300 disabled:cursor-not-allowed transition-all">
                  {submitting ? <div className="animate-spin rounded-full h-3 w-3 border-b-2 border-white" /> : <Send size={14} />}
                  {isEnglish ? 'Reply' : 'ÂõûË¶Ü'}
                </button>
              </div>
            </div>
          </div>
        </div>
      ) : (
        <div className="bg-amber-50 border-2 border-amber-200 rounded-xl p-4 text-sm font-semibold text-amber-800">
          {isEnglish ? 'Please log in to reply.' : 'Ë´ãÁôªÂÖ•‰ª•ÂõûË¶Ü„ÄÇ'}
        </div>
      )}
    </div>
  );
}

// ‚îÄ‚îÄ New Post Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function NewPostModal({ currentUser, isEnglish, onClose, onCreated }) {
  const [title, setTitle] = useState('');
  const [content, setContent] = useState('');
  const [category, setCategory] = useState('general');
  const [submitting, setSubmitting] = useState(false);

  const handleSubmit = async () => {
    if (!title.trim() || !content.trim()) return;
    setSubmitting(true);
    try {
      await forumService.createPost(currentUser.uid, currentUser.displayName || 'Anonymous', { title, content, category });
      onCreated();
    } catch (e) { alert(e.message); }
    setSubmitting(false);
  };

  const catColors = { general: 'border-blue-400 bg-blue-50 text-blue-700', question: 'border-amber-400 bg-amber-50 text-amber-700', announcement: 'border-purple-400 bg-purple-50 text-purple-700' };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
      <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl">
        <div className="p-6 border-b flex items-center justify-between">
          <h2 className="text-xl font-black text-slate-800">{isEnglish ? 'Create New Post' : 'Âª∫Á´ãÊñ∞Â∏ñÂ≠ê'}</h2>
          <button onClick={onClose} className="p-2 hover:bg-slate-100 rounded-lg"><X size={20} /></button>
        </div>
        <div className="p-6 space-y-4">
          <div>
            <label className="block text-sm font-bold text-slate-600 mb-2">{isEnglish ? 'Category' : 'È°ûÂà•'}</label>
            <div className="flex gap-2">
              {CATEGORIES.map(cat => (
                <button key={cat} onClick={() => setCategory(cat)}
                  className={`px-3 py-1.5 rounded-full text-xs font-bold border-2 transition-all ${category === cat ? catColors[cat] : 'border-slate-200 text-slate-500 hover:border-slate-300'}`}>
                  {cat.charAt(0).toUpperCase() + cat.slice(1)}
                </button>
              ))}
            </div>
          </div>
          <div>
            <label className="block text-sm font-bold text-slate-600 mb-2">{isEnglish ? 'Title' : 'Ê®ôÈ°å'}</label>
            <input value={title} onChange={e => setTitle(e.target.value)} maxLength={120}
              placeholder={isEnglish ? 'Enter a clear, descriptive title' : 'Ëº∏ÂÖ•Ê∏ÖÊô∞ÁöÑÊ®ôÈ°å'}
              className="w-full px-4 py-3 border-2 border-slate-200 rounded-lg outline-none focus:border-lab-blue font-semibold" />
          </div>
          <div>
            <label className="block text-sm font-bold text-slate-600 mb-2">{isEnglish ? 'Content' : 'ÂÖßÂÆπ'}</label>
            <textarea value={content} onChange={e => setContent(e.target.value)} rows="6"
              placeholder={isEnglish ? 'Share your thoughts, question, or announcement...' : 'ÂàÜ‰∫´ÊÇ®ÁöÑÊÉ≥Ê≥ï„ÄÅÂïèÈ°åÊàñÂÖ¨Âëä...'}
              className="w-full px-4 py-3 border-2 border-slate-200 rounded-lg outline-none focus:border-lab-blue resize-none" />
          </div>
        </div>
        <div className="p-6 border-t flex gap-3 justify-end">
          <button onClick={onClose} className="px-6 py-2 bg-slate-200 text-slate-700 rounded-lg font-bold hover:bg-slate-300 transition-all">
            {isEnglish ? 'Cancel' : 'ÂèñÊ∂à'}
          </button>
          <button onClick={handleSubmit} disabled={!title.trim() || !content.trim() || submitting}
            className="flex items-center gap-2 px-6 py-2 bg-lab-blue text-white rounded-lg font-bold hover:bg-blue-700 disabled:bg-slate-300 disabled:cursor-not-allowed transition-all">
            {submitting ? <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white" /> : <Send size={16} />}
            {isEnglish ? 'Post' : 'ÁôºË°®'}
          </button>
        </div>
      </div>
    </div>
  );
}

// ‚îÄ‚îÄ Main ForumPage ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
export default function ForumPage() {
  const navigate = useNavigate();
  const { currentUser } = useAuth();
  const { isEnglish } = useLanguage();
  const { questions, loading: questionsLoading } = useQuizData(SHEET_URL);

  const [activeTab, setActiveTab] = useState('mcq'); // 'mcq' | 'general'
  const [showNotifPanel, setShowNotifPanel] = useState(false);
  const [unreadCount, setUnreadCount] = useState(0);

  // MCQ tab state
  const [discussedQuestions, setDiscussedQuestions] = useState([]);
  const [mcqLoading, setMcqLoading] = useState(true);
  const [searchTerm, setSearchTerm] = useState('');
  const [sortBy, setSortBy] = useState('recent');
  const [selectedQuestion, setSelectedQuestion] = useState(null);

  // General tab state
  const [posts, setPosts] = useState([]);
  const [postsLoading, setPostsLoading] = useState(false);
  const [activePost, setActivePost] = useState(null); // postId
  const [showNewPost, setShowNewPost] = useState(false);
  const [postSearch, setPostSearch] = useState('');
  const [postCategory, setPostCategory] = useState('all');

  // Subscribe to notifications
  useEffect(() => {
    if (!currentUser) return;
    const unsub = forumService.subscribeToNotifications(currentUser.uid, (notifs) => {
      setUnreadCount(notifs.filter(n => !n.read).length);
    });
    return () => unsub && unsub();
  }, [currentUser]);

  useEffect(() => { loadDiscussedQuestions(); }, []);
  useEffect(() => { if (activeTab === 'general') loadPosts(); }, [activeTab]);

  async function loadDiscussedQuestions() {
    setMcqLoading(true);
    try {
      const discussed = await forumService.getQuestionsWithComments();
      setDiscussedQuestions(discussed);
    } catch { /* ignore */ }
    setMcqLoading(false);
  }

  async function loadPosts() {
    setPostsLoading(true);
    try {
      const data = await forumService.getPosts({ limit: 50 });
      setPosts(data);
    } catch { /* ignore */ }
    setPostsLoading(false);
  }

  const getQuestionDetails = (questionId) => questions.find(q => q.ID === questionId);

  const filteredMcqQuestions = discussedQuestions
    .filter(dq => {
      const qd = getQuestionDetails(dq.questionId);
      if (!qd) return false;
      if (!searchTerm) return true;
      const s = searchTerm.toLowerCase();
      return qd.Question?.toLowerCase().includes(s) || qd.Topic?.toLowerCase().includes(s) || qd.DSEcode?.toLowerCase().includes(s);
    })
    .sort((a, b) => sortBy === 'recent' ? new Date(b.lastActivity) - new Date(a.lastActivity) : b.commentCount - a.commentCount);

  const filteredPosts = posts
    .filter(p => {
      if (postCategory !== 'all' && p.category !== postCategory) return false;
      if (!postSearch) return true;
      return p.title?.toLowerCase().includes(postSearch.toLowerCase()) || p.content?.toLowerCase().includes(postSearch.toLowerCase());
    });

  const formatDate = (iso) => {
    const d = new Date(iso), now = new Date(), diffMs = now - d;
    const mins = Math.floor(diffMs / 60000);
    if (mins < 1) return isEnglish ? 'Just now' : 'ÂâõÂâõ';
    if (mins < 60) return `${mins} ${isEnglish ? 'min ago' : 'ÂàÜÈêòÂâç'}`;
    const hrs = Math.floor(mins / 60);
    if (hrs < 24) return `${hrs} ${isEnglish ? 'hr ago' : 'Â∞èÊôÇÂâç'}`;
    const days = Math.floor(hrs / 24);
    if (days < 7) return `${days} ${isEnglish ? 'days ago' : 'Â§©Ââç'}`;
    return d.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
  };

  const catColors = { general: 'bg-blue-100 text-blue-700', question: 'bg-amber-100 text-amber-700', announcement: 'bg-purple-100 text-purple-700' };

  if (activePost) {
    return (
      <div className="max-w-4xl mx-auto space-y-6">
        <PostDetail postId={activePost} currentUser={currentUser} isEnglish={isEnglish}
          onBack={() => { setActivePost(null); loadPosts(); }} />
      </div>
    );
  }

  return (
    <div className="max-w-6xl mx-auto space-y-6">
      {/* Header */}
      <div className="flex items-center gap-4">
        <button onClick={() => navigate('/dashboard')} className="p-3 bg-white rounded-lg border-2 border-slate-200 hover:border-lab-blue transition-all">
          <ArrowLeft size={20} />
        </button>
        <div className="flex-1 bg-gradient-to-r from-purple-600 to-indigo-600 rounded-2xl shadow-xl p-6 text-white">
          <h1 className="text-3xl font-black flex items-center gap-3">
            <MessageSquare size={32} />
            {isEnglish ? 'Forum' : 'Ë®éË´ñÂçÄ'}
          </h1>
          <p className="text-purple-100 mt-1">{isEnglish ? 'Connect and discuss with other students' : 'ËàáÂÖ∂‰ªñÂ≠∏Áîü‰∫§ÊµÅË®éË´ñ'}</p>
        </div>
        {/* Notification Bell */}
        {currentUser && (
          <div className="relative">
            <button onClick={() => setShowNotifPanel(v => !v)}
              className="relative p-3 bg-white rounded-xl border-2 border-slate-200 hover:border-purple-400 transition-all shadow-sm">
              {unreadCount > 0 ? <BellDot size={22} className="text-purple-600" /> : <Bell size={22} className="text-slate-600" />}
              {unreadCount > 0 && (
                <span className="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center font-bold">
                  {unreadCount > 9 ? '9+' : unreadCount}
                </span>
              )}
            </button>
            {showNotifPanel && (
              <NotificationPanel userId={currentUser.uid} isEnglish={isEnglish} onClose={() => setShowNotifPanel(false)} />
            )}
          </div>
        )}
      </div>

      {/* Tabs */}
      <div className="bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
        <div className="flex border-b">
          <button onClick={() => setActiveTab('mcq')}
            className={`flex-1 px-6 py-4 font-bold text-base transition-all flex items-center justify-center gap-2 ${activeTab === 'mcq' ? 'bg-lab-blue text-white' : 'text-slate-600 hover:bg-slate-50'}`}>
            <MessageCircle size={18} />
            {isEnglish ? 'MCQ Discussion' : 'MCQ Ë®éË´ñ'}
          </button>
          <button onClick={() => setActiveTab('general')}
            className={`flex-1 px-6 py-4 font-bold text-base transition-all flex items-center justify-center gap-2 ${activeTab === 'general' ? 'bg-purple-600 text-white' : 'text-slate-600 hover:bg-slate-50'}`}>
            <MessageSquare size={18} />
            {isEnglish ? 'General Forum' : '‰∏ÄËà¨Ë®éË´ñÂçÄ'}
          </button>
        </div>

        {/* ‚îÄ‚îÄ MCQ Tab ‚îÄ‚îÄ */}
        {activeTab === 'mcq' && (
          <div className="p-6 space-y-4">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div className="relative">
                <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={20} />
                <input type="text" value={searchTerm} onChange={e => setSearchTerm(e.target.value)}
                  placeholder={isEnglish ? 'Search questions, topics, DSE codes...' : 'ÊêúÂ∞ãÈ°åÁõÆ„ÄÅ‰∏ªÈ°å„ÄÅDSE ‰ª£Á¢º...'}
                  className="w-full pl-11 pr-4 py-3 border-2 border-slate-200 rounded-lg focus:border-lab-blue outline-none transition-all" />
              </div>
              <div className="flex gap-2">
                {[['recent', <Clock size={16} />, isEnglish ? 'Recent' : 'ÊúÄÊñ∞'], ['popular', <TrendingUp size={16} />, isEnglish ? 'Popular' : 'ÁÜ±ÈñÄ']].map(([val, icon, label]) => (
                  <button key={val} onClick={() => setSortBy(val)}
                    className={`flex-1 flex items-center justify-center gap-2 px-4 py-3 rounded-lg font-bold transition-all ${sortBy === val ? 'bg-lab-blue text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}>
                    {icon}{label}
                  </button>
                ))}
              </div>
            </div>
            <p className="text-sm text-slate-600"><span className="font-bold text-lab-blue">{filteredMcqQuestions.length}</span> {isEnglish ? 'questions with discussions' : 'ÂÄãÈ°åÁõÆÊúâË®éË´ñ'}</p>

            {mcqLoading || questionsLoading ? (
              <div className="flex justify-center py-12"><div className="animate-spin rounded-full h-10 w-10 border-b-2 border-lab-blue" /></div>
            ) : filteredMcqQuestions.length === 0 ? (
              <div className="text-center py-12">
                <MessageSquare className="w-14 h-14 text-slate-300 mx-auto mb-3" />
                <p className="text-slate-400">{searchTerm ? (isEnglish ? 'No results found' : 'Êâæ‰∏çÂà∞ÁµêÊûú') : (isEnglish ? 'No MCQ discussions yet. Start one from any quiz!' : 'Â∞öÁÑ°MCQË®éË´ñ„ÄÇÂú®Ê∏¨È©ó‰∏≠ÈñãÂßãË®éË´ñÔºÅ')}</p>
              </div>
            ) : (
              <div className="space-y-3">
                {filteredMcqQuestions.map(dq => {
                  const qd = getQuestionDetails(dq.questionId);
                  if (!qd) return null;
                  return (
                    <div key={dq.questionId} onClick={() => setSelectedQuestion(qd)}
                      className="p-4 rounded-xl border-2 border-slate-100 hover:border-purple-200 hover:bg-purple-50 transition-all cursor-pointer">
                      <div className="flex items-start justify-between gap-4">
                        <div className="flex-1 min-w-0">
                          <div className="flex items-center gap-2 mb-2">
                            <span className="bg-blue-100 text-lab-blue px-2 py-1 rounded text-xs font-bold">{qd.Topic}</span>
                            {qd.DSEcode && <span className="bg-slate-100 text-slate-600 px-2 py-1 rounded text-xs font-bold">{qd.DSEcode}</span>}
                          </div>
                          <div className="text-slate-700 font-medium mb-2 line-clamp-2"
                            dangerouslySetInnerHTML={{ __html: qd.Question.substring(0, 150) + '...' }} />
                          <div className="flex items-center gap-4 text-sm text-slate-500">
                            <div className="flex items-center gap-1"><MessageCircle size={14} /><span className="font-semibold">{dq.commentCount}</span><span>{isEnglish ? 'comments' : 'ÂâáË©ïË´ñ'}</span></div>
                            <div className="flex items-center gap-1"><Clock size={14} /><span>{formatDate(dq.lastActivity)}</span></div>
                          </div>
                        </div>
                        <div className="flex-shrink-0 w-12 h-12 rounded-full bg-purple-100 flex items-center justify-center">
                          <span className="text-lg font-black text-purple-600">{dq.commentCount}</span>
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            )}
          </div>
        )}

        {/* ‚îÄ‚îÄ General Forum Tab ‚îÄ‚îÄ */}
        {activeTab === 'general' && (
          <div className="p-6 space-y-4">
            <div className="flex flex-col md:flex-row gap-4 items-start md:items-center">
              <div className="relative flex-1">
                <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={18} />
                <input type="text" value={postSearch} onChange={e => setPostSearch(e.target.value)}
                  placeholder={isEnglish ? 'Search posts...' : 'ÊêúÂ∞ãÂ∏ñÂ≠ê...'}
                  className="w-full pl-10 pr-4 py-2.5 border-2 border-slate-200 rounded-lg focus:border-purple-400 outline-none" />
              </div>
              {/* Category filter */}
              <div className="flex gap-2">
                {['all', ...CATEGORIES].map(cat => (
                  <button key={cat} onClick={() => setPostCategory(cat)}
                    className={`px-3 py-2 rounded-lg text-xs font-bold border-2 transition-all ${postCategory === cat ? 'border-purple-500 bg-purple-50 text-purple-700' : 'border-slate-200 text-slate-600 hover:border-slate-300'}`}>
                    {cat === 'all' ? (isEnglish ? 'All' : 'ÂÖ®ÈÉ®') : cat.charAt(0).toUpperCase() + cat.slice(1)}
                  </button>
                ))}
              </div>
              {currentUser && (
                <button onClick={() => setShowNewPost(true)}
                  className="flex items-center gap-2 px-5 py-2.5 bg-purple-600 text-white rounded-lg font-bold hover:bg-purple-700 transition-all shadow-md whitespace-nowrap">
                  <PlusCircle size={18} />
                  {isEnglish ? 'New Post' : 'Êñ∞Â∏ñÂ≠ê'}
                </button>
              )}
            </div>

            {postsLoading ? (
              <div className="flex justify-center py-12"><div className="animate-spin rounded-full h-10 w-10 border-b-2 border-purple-600" /></div>
            ) : filteredPosts.length === 0 ? (
              <div className="text-center py-12">
                <MessageSquare className="w-14 h-14 text-slate-300 mx-auto mb-3" />
                <p className="text-slate-400 mb-3">{isEnglish ? 'No posts yet. Be the first!' : 'Êö´ÁÑ°Â∏ñÂ≠êÔºåÊàêÁÇ∫Á¨¨‰∏ÄÂÄãÔºÅ'}</p>
                {currentUser && (
                  <button onClick={() => setShowNewPost(true)} className="px-5 py-2 bg-purple-600 text-white rounded-lg font-bold hover:bg-purple-700 transition-all">
                    {isEnglish ? 'Create a Post' : 'Âª∫Á´ãÂ∏ñÂ≠ê'}
                  </button>
                )}
              </div>
            ) : (
              <div className="space-y-3">
                {filteredPosts.map(post => (
                  <div key={post.id} onClick={() => setActivePost(post.id)}
                    className="p-4 rounded-xl border-2 border-slate-100 hover:border-purple-200 hover:bg-purple-50 transition-all cursor-pointer">
                    <div className="flex items-start gap-4">
                      <div className="flex-1 min-w-0">
                        <div className="flex items-center gap-2 mb-1.5">
                          <span className={`text-xs font-bold px-2 py-0.5 rounded-full ${catColors[post.category] || catColors.general}`}>
                            {post.category?.toUpperCase()}
                          </span>
                          {post.edited && <span className="text-xs text-slate-400 italic">({isEnglish ? 'edited' : 'Â∑≤Á∑®ËºØ'})</span>}
                        </div>
                        <h3 className="font-bold text-slate-800 text-base mb-1 line-clamp-1">{post.title}</h3>
                        <p className="text-sm text-slate-600 line-clamp-2">{post.content}</p>
                        <div className="flex items-center gap-4 mt-2 text-xs text-slate-500">
                          <span className="font-semibold">{post.userDisplayName}</span>
                          <span>{formatDate(post.createdAt)}</span>
                          <span className="flex items-center gap-1"><MessageCircle size={12} />{post.replyCount || 0}</span>
                          <span className="flex items-center gap-1"><ThumbsUp size={12} />{post.likes || 0}</span>
                        </div>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        )}
      </div>

      {/* MCQ Forum Modal */}
      {selectedQuestion && (
        <QuestionForum question={selectedQuestion}
          onClose={() => { setSelectedQuestion(null); loadDiscussedQuestions(); }} />
      )}

      {/* New Post Modal */}
      {showNewPost && currentUser && (
        <NewPostModal currentUser={currentUser} isEnglish={isEnglish}
          onClose={() => setShowNewPost(false)}
          onCreated={() => { setShowNewPost(false); loadPosts(); }} />
      )}
    </div>
  );
}

// ========== src/pages/HistoryPage_Fixed.jsx ==========

import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { useAuth } from '../contexts/AuthContext';
import { useLanguage } from '../contexts/LanguageContext';
import { quizService } from '../services/quizService';
import AttemptDetailModal from '../components/AttemptDetailModal';
import {
  History, ArrowLeft, Calendar, Clock, Target, TrendingUp,
  Filter, ChevronDown, Trophy, AlertCircle, RefreshCw, ChevronRight,
} from 'lucide-react';

export default function HistoryPage() {
  const { currentUser } = useAuth();
  const { isEnglish } = useLanguage();
  const navigate = useNavigate();
  const [attempts, setAttempts] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [filterPeriod, setFilterPeriod] = useState('all');
  const [sortBy, setSortBy] = useState('recent');
  const [showFilters, setShowFilters] = useState(false);
  const [selectedAttempt, setSelectedAttempt] = useState(null);

  useEffect(() => { loadHistory(); }, [currentUser]);

  async function loadHistory() {
    if (!currentUser) { setLoading(false); return; }
    try {
      setError(null);
      setLoading(true);
      const userAttempts = await quizService.getUserAttempts(currentUser.uid, 100);
      setAttempts(userAttempts);
    } catch (err) {
      setError(err.message);
    } finally {
      setLoading(false);
    }
  }

  const formatDate = (iso) =>
    new Date(iso).toLocaleDateString('en-GB', {
      day: '2-digit', month: 'short', year: 'numeric',
      hour: '2-digit', minute: '2-digit',
    });

  const formatTime = (ms) => {
    if (!ms) return 'N/A';
    const s = Math.floor(ms / 1000), m = Math.floor(s / 60), h = Math.floor(m / 60);
    if (h > 0) return `${h}h ${m % 60}m`;
    if (m > 0) return `${m}m ${s % 60}s`;
    return `${s}s`;
  };

  const getFilteredAttempts = () => {
    let filtered = [...attempts];
    if (filterPeriod === 'week') {
      const w = new Date(); w.setDate(w.getDate() - 7);
      filtered = filtered.filter(a => new Date(a.timestamp) >= w);
    } else if (filterPeriod === 'month') {
      const m = new Date(); m.setMonth(m.getMonth() - 1);
      filtered = filtered.filter(a => new Date(a.timestamp) >= m);
    }
    if (sortBy === 'recent') filtered.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    else if (sortBy === 'score') filtered.sort((a, b) => b.percentage - a.percentage);
    else if (sortBy === 'time') filtered.sort((a, b) => (b.timeSpent || 0) - (a.timeSpent || 0));
    return filtered;
  };

  const filteredAttempts = getFilteredAttempts();
  const stats = {
    total: filteredAttempts.length,
    average: filteredAttempts.length > 0
      ? Math.round(filteredAttempts.reduce((s, a) => s + a.percentage, 0) / filteredAttempts.length) : 0,
    best: filteredAttempts.length > 0 ? Math.max(...filteredAttempts.map(a => a.percentage)) : 0,
    totalTime: filteredAttempts.reduce((s, a) => s + (a.timeSpent || 0), 0),
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center h-screen">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-lab-blue mx-auto mb-4"></div>
          <p className="text-slate-600">{isEnglish ? 'Loading your history...' : 'ËºâÂÖ•Ê≠∑Âè≤Ë®òÈåÑ...'}</p>
        </div>
      </div>
    );
  }

  return (
    <div className="max-w-6xl mx-auto space-y-6">
      {/* Header */}
      <div className="flex items-center gap-4">
        <button onClick={() => navigate('/dashboard')} className="p-3 bg-white rounded-lg border-2 border-slate-200 hover:border-lab-blue transition-all">
          <ArrowLeft size={20} />
        </button>
        <div className="flex-1 bg-gradient-to-r from-purple-600 to-purple-800 rounded-2xl shadow-xl p-6 text-white">
          <h1 className="text-3xl font-black flex items-center gap-3">
            <History size={32} />
            {isEnglish ? 'Practice History' : 'Á∑¥ÁøíÊ≠∑Âè≤'}
          </h1>
          <p className="text-purple-100 mt-1">
            {isEnglish ? 'Click any attempt to see the full analysis' : 'ÈªûÊìä‰ªª‰ΩïË®òÈåÑÊü•ÁúãÂÆåÊï¥ÂàÜÊûê'}
          </p>
        </div>
      </div>

      {error && (
        <div className="bg-red-50 border-2 border-red-200 rounded-xl p-4">
          <div className="flex items-start gap-3">
            <AlertCircle className="text-red-500 flex-shrink-0 mt-1" size={20} />
            <div className="flex-1">
              <h3 className="font-bold text-red-900 mb-1">{isEnglish ? 'Error Loading History' : 'ËºâÂÖ•Â§±Êïó'}</h3>
              <p className="text-sm text-red-800 mb-3">{error}</p>
              <button onClick={loadHistory} className="flex items-center gap-2 px-4 py-2 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 transition-all">
                <RefreshCw size={16} /> {isEnglish ? 'Retry' : 'ÈáçË©¶'}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Stats */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
        {[
          { icon: <Target className="text-lab-blue" size={20} />, label: isEnglish ? 'Total Attempts' : 'Á∏ΩÊ¨°Êï∏', val: stats.total, color: 'text-lab-blue' },
          { icon: <TrendingUp className="text-chemistry-green" size={20} />, label: isEnglish ? 'Average Score' : 'Âπ≥ÂùáÂàÜÊï∏', val: `${stats.average}%`, color: 'text-chemistry-green' },
          { icon: <Trophy className="text-amber-500" size={20} />, label: isEnglish ? 'Best Score' : 'ÊúÄÈ´òÂàÜÊï∏', val: `${stats.best}%`, color: 'text-amber-500' },
          { icon: <Clock className="text-purple-600" size={20} />, label: isEnglish ? 'Total Time' : 'Á∏ΩÊôÇÈñì', val: formatTime(stats.totalTime), color: 'text-purple-600' },
        ].map(({ icon, label, val, color }) => (
          <div key={label} className="bg-white rounded-xl shadow-lg border-2 border-slate-200 p-4">
            <div className="flex items-center gap-2 mb-2">{icon}<span className="text-sm font-semibold text-slate-600">{label}</span></div>
            <div className={`text-3xl font-black ${color}`}>{val}</div>
          </div>
        ))}
      </div>

      {/* Filters */}
      <div className="bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
        <button
          onClick={() => setShowFilters(!showFilters)}
          className="w-full flex items-center justify-between p-4 hover:bg-slate-50 transition-all"
        >
          <div className="flex items-center gap-2">
            <Filter className="text-lab-blue" size={20} />
            <span className="font-bold text-slate-800">{isEnglish ? 'Filters & Sorting' : 'ÁØ©ÈÅ∏ËàáÊéíÂ∫è'}</span>
          </div>
          <ChevronDown size={20} className={`text-slate-400 transition-transform ${showFilters ? 'rotate-180' : ''}`} />
        </button>
        {showFilters && (
          <div className="p-4 border-t border-slate-200 bg-slate-50">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-bold text-slate-700 mb-2">
                  {isEnglish ? 'Time Period' : 'ÊôÇÈñìÁØÑÂúç'}
                </label>
                <div className="grid grid-cols-3 gap-2">
                  {[
                    { value: 'all', label: isEnglish ? 'All Time' : 'ÂÖ®ÈÉ®' },
                    { value: 'month', label: isEnglish ? 'Last Month' : '‰∏äÂÄãÊúà' },
                    { value: 'week', label: isEnglish ? 'Last Week' : '‰∏äÈÄ±' },
                  ].map(o => (
                    <button key={o.value} onClick={() => setFilterPeriod(o.value)}
                      className={`py-2 rounded-lg font-semibold text-sm transition-all ${filterPeriod === o.value ? 'bg-lab-blue text-white' : 'bg-white text-slate-600 hover:bg-slate-100 border-2 border-slate-200'}`}>
                      {o.label}
                    </button>
                  ))}
                </div>
              </div>
              <div>
                <label className="block text-sm font-bold text-slate-700 mb-2">
                  {isEnglish ? 'Sort By' : 'ÊéíÂ∫èÊñπÂºè'}
                </label>
                <div className="grid grid-cols-3 gap-2">
                  {[
                    { value: 'recent', label: isEnglish ? 'Recent' : 'ÊúÄÊñ∞' },
                    { value: 'score', label: isEnglish ? 'Score' : 'ÂàÜÊï∏' },
                    { value: 'time', label: isEnglish ? 'Time' : 'ÊôÇÈñì' },
                  ].map(o => (
                    <button key={o.value} onClick={() => setSortBy(o.value)}
                      className={`py-2 rounded-lg font-semibold text-sm transition-all ${sortBy === o.value ? 'bg-chemistry-green text-white' : 'bg-white text-slate-600 hover:bg-slate-100 border-2 border-slate-200'}`}>
                      {o.label}
                    </button>
                  ))}
                </div>
              </div>
            </div>
          </div>
        )}
      </div>

      {/* Attempts List */}
      <div className="bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
        <div className="bg-slate-50 p-4 border-b flex items-center justify-between">
          <h2 className="text-lg font-bold text-slate-800">
            {isEnglish ? 'Your Attempts' : 'ÊÇ®ÁöÑË®òÈåÑ'} ({filteredAttempts.length})
          </h2>
          <div className="flex items-center gap-3">
            <span className="text-xs text-slate-400 italic hidden sm:block">
              {isEnglish ? 'Click to view full analysis' : 'ÈªûÊìäÊü•ÁúãÂÆåÊï¥ÂàÜÊûê'}
            </span>
            <button onClick={loadHistory} className="text-sm text-lab-blue hover:underline flex items-center gap-1">
              <RefreshCw size={14} /> {isEnglish ? 'Refresh' : 'Âà∑Êñ∞'}
            </button>
          </div>
        </div>

        <div className="p-6">
          {filteredAttempts.length === 0 ? (
            <div className="text-center py-12">
              <History className="w-16 h-16 text-slate-300 mx-auto mb-4" />
              <p className="text-slate-400 text-lg mb-2">{isEnglish ? 'No attempts found' : 'Ê≤íÊúâÊâæÂà∞Ë®òÈåÑ'}</p>
              <p className="text-slate-500 text-sm mb-4">
                {filterPeriod !== 'all'
                  ? (isEnglish ? 'Try changing the filter period' : 'ÂòóË©¶Êõ¥ÊîπÊôÇÈñìÁØÑÂúç')
                  : (isEnglish ? 'Start practicing to see your history!' : 'ÈñãÂßãÁ∑¥Áøí‰ª•Êü•ÁúãÊ≠∑Âè≤Ë®òÈåÑÔºÅ')}
              </p>
              {attempts.length === 0 && (
                <button onClick={() => navigate('/')} className="px-6 py-3 bg-lab-blue text-white rounded-lg font-bold hover:bg-blue-800 transition-all">
                  {isEnglish ? 'Take Your First Quiz' : 'ÈñãÂßãÁ¨¨‰∏ÄÂÄãÊ∏¨È©ó'}
                </button>
              )}
            </div>
          ) : (
            <div className="space-y-3">
              {filteredAttempts.map((attempt, index) => (
                <button
                  key={attempt.id}
                  onClick={() => setSelectedAttempt(attempt)}
                  className="w-full flex items-center justify-between p-4 rounded-xl border-2 border-slate-100 hover:border-purple-300 hover:bg-purple-50 transition-all hover:shadow-md text-left group"
                >
                  <div className="flex items-center gap-4 flex-1">
                    <div className="w-10 h-10 rounded-lg bg-slate-100 flex items-center justify-center font-black text-slate-600">
                      #{index + 1}
                    </div>
                    <div className={`w-16 h-16 rounded-xl flex items-center justify-center font-black text-2xl ${
                      attempt.percentage >= 70 ? 'bg-green-100 text-green-700'
                      : attempt.percentage >= 50 ? 'bg-yellow-100 text-yellow-700'
                      : 'bg-red-100 text-red-700'
                    }`}>
                      {attempt.percentage}%
                    </div>
                    <div className="flex-1">
                      <div className="font-bold text-slate-800 text-lg">
                        {attempt.correctAnswers}/{attempt.totalQuestions} {isEnglish ? 'correct' : 'Ê≠£Á¢∫'}
                      </div>
                      <div className="text-sm text-slate-500 flex items-center gap-2">
                        <Calendar size={14} /> {formatDate(attempt.timestamp)}
                      </div>
                      {attempt.topics && (
                        <div className="flex flex-wrap gap-1 mt-1">
                          {attempt.topics.slice(0, 3).map((topic, i) => (
                            <span key={i} className="text-xs bg-blue-100 text-lab-blue px-2 py-0.5 rounded-full font-semibold">{topic}</span>
                          ))}
                          {attempt.topics.length > 3 && (
                            <span className="text-xs text-slate-400 px-1">+{attempt.topics.length - 3}</span>
                          )}
                        </div>
                      )}
                    </div>
                  </div>
                  <div className="flex items-center gap-3">
                    {attempt.timeSpent && (
                      <div className="text-right hidden sm:block">
                        <div className="flex items-center gap-1 text-sm font-semibold text-slate-600">
                          <Clock size={14} /> {formatTime(attempt.timeSpent)}
                        </div>
                        <div className="text-xs text-slate-400">
                          {formatTime(attempt.timeSpent / attempt.totalQuestions)}/Q
                        </div>
                      </div>
                    )}
                    <ChevronRight size={20} className="text-slate-400 group-hover:text-purple-500 transition-colors flex-shrink-0" />
                  </div>
                </button>
              ))}
            </div>
          )}
        </div>
      </div>

      {/* Attempt Detail Modal */}
      {selectedAttempt && (
        <AttemptDetailModal
          attempt={selectedAttempt}
          onClose={() => setSelectedAttempt(null)}
        />
      )}
    </div>
  );
}

// ========== src/pages/LeaderboardPage.jsx ==========

import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { useAuth } from '../contexts/AuthContext';
import { useLanguage } from '../contexts/LanguageContext';
import { quizService } from '../services/quizService';
import { Trophy, Medal, Award, Calendar, TrendingUp, ArrowLeft, Flame, GraduationCap } from 'lucide-react';

// ‚îÄ‚îÄ Level badge ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function LevelBadge({ level, rank }) {
  if (!level) return null;
  const isTopThree = rank <= 3;
  const colors = {
    S4: isTopThree ? 'bg-white/20 text-white border-white/40' : 'bg-sky-100 text-sky-700 border-sky-200',
    S5: isTopThree ? 'bg-white/20 text-white border-white/40' : 'bg-violet-100 text-violet-700 border-violet-200',
    S6: isTopThree ? 'bg-white/20 text-white border-white/40' : 'bg-emerald-100 text-emerald-700 border-emerald-200',
  };
  return (
    <span className={`inline-flex items-center gap-1 px-2 py-0.5 rounded-full border text-xs font-bold ${colors[level] || colors.S5}`}>
      <GraduationCap size={10} />
      {level}
    </span>
  );
}

// ‚îÄ‚îÄ Streak badge ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function StreakBadge({ streak, rank, isEnglish }) {
  if (!streak || streak < 1) return null;
  const isTopThree = rank <= 3;
  return (
    <span className={`inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-bold ${
      isTopThree ? 'bg-white/20 text-white border border-white/40' : 'bg-orange-100 text-orange-700 border border-orange-200'
    }`}>
      <Flame size={10} />
      {streak} {isEnglish ? 'd' : 'Â§©'}
    </span>
  );
}

export default function LeaderboardPage() {
  const [activeTab, setActiveTab] = useState('weekly');
  const [leaderboard, setLeaderboard] = useState([]);
  const [loading, setLoading] = useState(true);
  const { currentUser } = useAuth();
  const { isEnglish } = useLanguage();
  const navigate = useNavigate();

  useEffect(() => { loadLeaderboard(); }, [activeTab]);

  async function loadLeaderboard() {
    setLoading(true);
    try {
      let data;
      if (activeTab === 'weekly') data = await quizService.getWeeklyLeaderboard(20);
      else if (activeTab === 'monthly') data = await quizService.getMonthlyLeaderboard(20);
      else data = await quizService.getAllTimeLeaderboard(20);
      setLeaderboard(data);
    } catch (error) {
      console.error('Error loading leaderboard:', error);
    }
    setLoading(false);
  }

  const getRankIcon = (rank) => {
    if (rank === 1) return <Trophy className="text-yellow-400" size={24} />;
    if (rank === 2) return <Medal className="text-slate-300" size={24} />;
    if (rank === 3) return <Award className="text-amber-500" size={24} />;
    return (
      <div className="w-6 h-6 rounded-full bg-slate-200 flex items-center justify-center text-xs font-bold text-slate-600">
        {rank}
      </div>
    );
  };

  const getRankStyle = (rank) => {
    if (rank === 1) return 'bg-gradient-to-r from-yellow-400 to-yellow-600 text-white shadow-lg';
    if (rank === 2) return 'bg-gradient-to-r from-slate-300 to-slate-500 text-white shadow-md';
    if (rank === 3) return 'bg-gradient-to-r from-amber-500 to-amber-700 text-white shadow-md';
    return 'bg-white border-2 border-slate-200 hover:border-slate-300';
  };

  const tabs = [
    {
      value: 'weekly',
      icon: <Calendar size={16} />,
      label: isEnglish ? 'This Week' : 'Êú¨ÈÄ±',
    },
    {
      value: 'monthly',
      icon: <TrendingUp size={16} />,
      label: isEnglish ? 'This Month' : 'Êú¨Êúà',
    },
    {
      value: 'alltime',
      icon: <Trophy size={16} />,
      label: isEnglish ? 'All Time' : 'Ê≠∑Âè≤Á∏ΩÊ¶ú',
    },
  ];

  const periodInfo = {
    weekly: isEnglish
      ? 'Average score from all attempts in the last 7 days'
      : 'ÈÅéÂéª 7 Â§©ÊâÄÊúâÊ∏¨È©óÁöÑÂπ≥ÂùáÂàÜÊï∏',
    monthly: isEnglish
      ? 'Average score from all attempts in the last 30 days'
      : 'ÈÅéÂéª 30 Â§©ÊâÄÊúâÊ∏¨È©óÁöÑÂπ≥ÂùáÂàÜÊï∏',
    alltime: isEnglish
      ? 'Overall accuracy across all attempts ever'
      : 'ÊâÄÊúâÊ∏¨È©óÁöÑÊï¥È´îÊ∫ñÁ¢∫Áéá',
  };

  return (
    <div className="max-w-4xl mx-auto space-y-6">
      {/* Header */}
      <div className="flex items-center gap-4">
        <button
          onClick={() => navigate('/dashboard')}
          className="p-3 bg-white rounded-lg border-2 border-slate-200 hover:border-lab-blue transition-all"
        >
          <ArrowLeft size={20} />
        </button>
        <div className="flex-1 bg-gradient-to-r from-amber-500 to-orange-600 rounded-2xl shadow-xl p-6 text-white">
          <h1 className="text-3xl font-black flex items-center gap-3">
            <Trophy size={32} />
            {isEnglish ? 'Leaderboard' : 'ÊéíË°åÊ¶ú'}
          </h1>
          <p className="text-orange-100 mt-1">
            {isEnglish ? 'See how you rank against other students' : 'ÁúãÁúãÊÇ®Âú®ÂÖ∂‰ªñÂ≠∏Áîü‰∏≠ÁöÑÊéíÂêç'}
          </p>
        </div>
      </div>

      {/* Tabs */}
      <div className="bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
        <div className="flex border-b">
          {tabs.map(tab => (
            <button
              key={tab.value}
              onClick={() => setActiveTab(tab.value)}
              className={`flex-1 px-4 py-4 font-bold transition-all flex items-center justify-center gap-2 text-sm sm:text-base ${
                activeTab === tab.value
                  ? 'bg-lab-blue text-white'
                  : 'text-slate-600 hover:bg-slate-50'
              }`}
            >
              {tab.icon}
              {tab.label}
            </button>
          ))}
        </div>

        {/* List */}
        <div className="p-6">
          {loading ? (
            <div className="flex items-center justify-center py-16">
              <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-lab-blue"></div>
            </div>
          ) : leaderboard.length === 0 ? (
            <div className="text-center py-16">
              <Trophy className="w-16 h-16 text-slate-200 mx-auto mb-4" />
              <p className="text-slate-400 text-lg font-semibold">
                {isEnglish ? 'No data yet' : 'Êö´ÁÑ°Êï∏Êìö'}
              </p>
              <p className="text-slate-500 text-sm mt-2">
                {isEnglish ? 'Be the first to complete a quiz!' : 'ÊàêÁÇ∫Á¨¨‰∏ÄÂÄãÂÆåÊàêÊ∏¨È©óÁöÑ‰∫∫ÔºÅ'}
              </p>
            </div>
          ) : (
            <div className="space-y-3">
              {leaderboard.map((entry, index) => {
                const rank = index + 1;
                const isCurrentUser = entry.userId === currentUser?.uid;
                const scoreToShow = activeTab === 'alltime' ? entry.overallPercentage : entry.averageScore;
                const isTopThree = rank <= 3;

                return (
                  <div
                    key={entry.userId}
                    className={`flex items-center gap-4 p-4 rounded-xl transition-all ${getRankStyle(rank)} ${
                      isCurrentUser ? 'ring-4 ring-chemistry-green ring-offset-2' : ''
                    }`}
                  >
                    {/* Rank icon */}
                    <div className="flex-shrink-0 w-8 flex items-center justify-center">
                      {getRankIcon(rank)}
                    </div>

                    {/* User info */}
                    <div className="flex-1 min-w-0">
                      <div className="flex items-center flex-wrap gap-2 mb-1">
                        <span className={`font-bold text-base truncate ${isTopThree ? 'text-white' : 'text-slate-800'}`}>
                          {entry.displayName}
                        </span>
                        {isCurrentUser && (
                          <span className="text-xs bg-chemistry-green text-white px-2 py-0.5 rounded-full font-bold flex-shrink-0">
                            {isEnglish ? 'You' : 'ÊÇ®'}
                          </span>
                        )}
                        {entry.level && <LevelBadge level={entry.level} rank={rank} />}
                        {entry.streak > 0 && <StreakBadge streak={entry.streak} rank={rank} isEnglish={isEnglish} />}
                      </div>
                      <div className={`text-xs ${isTopThree ? 'text-white/75' : 'text-slate-500'}`}>
                        {activeTab === 'alltime'
                          ? `${entry.totalAttempts} ${isEnglish ? 'attempts' : 'Ê¨°'} ¬∑ ${entry.totalQuestions} ${isEnglish ? 'questions' : 'È°å'}`
                          : `${entry.attemptCount} ${isEnglish ? 'attempts' : 'Ê¨°'} ¬∑ ${entry.totalQuestions} ${isEnglish ? 'questions' : 'È°å'}`
                        }
                      </div>
                    </div>

                    {/* Score */}
                    <div className="text-right flex-shrink-0">
                      <div className={`text-3xl font-black ${isTopThree ? 'text-white' : 'text-lab-blue'}`}>
                        {scoreToShow}%
                      </div>
                      <div className={`text-xs ${isTopThree ? 'text-white/70' : 'text-slate-500'}`}>
                        {entry.totalCorrect}/{entry.totalQuestions}
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </div>
      </div>

      {/* Info box */}
      <div className="bg-blue-50 border-2 border-blue-200 rounded-xl p-4 text-sm text-blue-800">
        <p className="font-semibold mb-2">
          üìä {isEnglish ? 'How rankings work:' : 'ÊéíÂêçË¶èÂâáÔºö'}
        </p>
        <p className="text-blue-700">{periodInfo[activeTab]}</p>
        <div className="mt-3 flex flex-wrap gap-4 text-xs text-blue-700">
          <span className="flex items-center gap-1">
            <GraduationCap size={12} />
            {isEnglish ? 'S4/S5/S6 = form level' : 'S4/S5/S6 = Âπ¥Á¥ö'}
          </span>
          <span className="flex items-center gap-1">
            <Flame size={12} />
            {isEnglish ? 'Flame = consecutive study days' : 'ÁÅ´ÁÑ∞ = ÈÄ£Á∫åÂ≠∏ÁøíÂ§©Êï∏'}
          </span>
        </div>
      </div>
    </div>
  );
}

// ========== src/pages/LoginPage.jsx ==========

import React, { useState } from 'react';
import { useNavigate, Link } from 'react-router-dom';
import { useAuth } from '../contexts/AuthContext';
import { Beaker, Mail, Lock, LogIn, AlertCircle, Sparkles } from 'lucide-react';

export default function LoginPage() {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);
  const { login } = useAuth();
  const navigate = useNavigate();

  async function handleSubmit(e) {
    e.preventDefault();

    try {
      setError('');
      setLoading(true);
      await login(email, password);
      navigate('/');
    } catch (err) {
      console.error(err);
      if (err.code === 'auth/user-not-found') {
        setError('No account found with this email.');
      } else if (err.code === 'auth/wrong-password') {
        setError('Incorrect password.');
      } else if (err.code === 'auth/invalid-email') {
        setError('Invalid email address.');
      } else {
        setError('Failed to log in. Please check your credentials.');
      }
    }
    setLoading(false);
  }

  return (
    <div className="min-h-screen flex items-center justify-center relative overflow-hidden bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 p-4">
      {/* Animated Background Elements */}
      <div className="absolute inset-0 overflow-hidden">
        <div className="absolute top-20 left-10 w-72 h-72 bg-blue-500 rounded-full mix-blend-multiply filter blur-xl opacity-20 animate-blob"></div>
        <div className="absolute top-40 right-10 w-72 h-72 bg-purple-500 rounded-full mix-blend-multiply filter blur-xl opacity-20 animate-blob animation-delay-2000"></div>
        <div className="absolute -bottom-8 left-20 w-72 h-72 bg-pink-500 rounded-full mix-blend-multiply filter blur-xl opacity-20 animate-blob animation-delay-4000"></div>
      </div>

      {/* Floating Chemistry Icons */}
      <div className="absolute inset-0 overflow-hidden pointer-events-none">
        <div className="absolute top-1/4 left-1/4 text-6xl opacity-10 animate-float">‚öõÔ∏è</div>
        <div className="absolute top-1/3 right-1/4 text-5xl opacity-10 animate-float animation-delay-1000">üß™</div>
        <div className="absolute bottom-1/4 left-1/3 text-7xl opacity-10 animate-float animation-delay-2000">üî¨</div>
        <div className="absolute top-1/2 right-1/3 text-4xl opacity-10 animate-float animation-delay-3000">‚öóÔ∏è</div>
      </div>

      <div className="max-w-md w-full relative z-10">
        {/* Logo Header */}
        <div className="text-center mb-8 animate-in fade-in slide-in-from-top duration-700">
          <div className="flex justify-center mb-6">
            <div className="relative">
              <div className="absolute inset-0 bg-gradient-to-r from-blue-600 to-purple-600 rounded-2xl blur-xl opacity-75 animate-pulse"></div>
              <div className="relative bg-gradient-to-r from-blue-500 to-purple-600 p-5 rounded-2xl shadow-2xl transform hover:scale-110 transition-transform duration-300">
                <Beaker className="text-white" size={56} strokeWidth={2.5} />
              </div>
            </div>
          </div>
          <h1 className="text-4xl font-black text-white mb-2 tracking-tight">
            ChemLeung
          </h1>
          <p className="text-blue-200 text-lg font-medium">HKDSE Chemistry MCQ Platform</p>
          <div className="flex items-center justify-center gap-2 mt-3 text-blue-300 text-sm">
            <Sparkles size={16} />
            <span>Sign in to continue your journey</span>
          </div>
        </div>

        {/* Login Form */}
        <div className="bg-white/10 backdrop-blur-xl rounded-3xl shadow-2xl border border-white/20 overflow-hidden animate-in fade-in slide-in-from-bottom duration-700">
          <div className="bg-gradient-to-r from-blue-600 to-purple-600 p-6 text-center">
            <h2 className="text-2xl font-bold text-white flex items-center justify-center gap-2">
              <LogIn size={24} />
              Welcome Back
            </h2>
            <p className="text-blue-100 text-sm mt-1">Enter your credentials to access your account</p>
          </div>

          <form onSubmit={handleSubmit} className="p-8 space-y-6">
            {error && (
              <div className="bg-red-500/20 backdrop-blur border-2 border-red-400/50 rounded-xl p-4 flex items-start gap-3 animate-in shake">
                <AlertCircle className="text-red-300 flex-shrink-0 mt-0.5" size={20} />
                <p className="text-red-100 text-sm font-medium">{error}</p>
              </div>
            )}

            {/* Email Field */}
            <div className="space-y-2">
              <label className="block text-sm font-bold text-white/90 ml-1">
                Email Address
              </label>
              <div className="relative group">
                <Mail className="absolute left-4 top-1/2 transform -translate-y-1/2 text-blue-300 group-focus-within:text-blue-400 transition-colors" size={20} />
                <input
                  type="email"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  required
                  className="w-full pl-12 pr-4 py-4 bg-white/10 backdrop-blur border-2 border-white/20 rounded-xl focus:border-blue-400 focus:ring-4 focus:ring-blue-500/20 outline-none transition-all text-white placeholder-white/50 font-medium"
                  placeholder="your.email@example.com"
                />
              </div>
            </div>

            {/* Password Field */}
            <div className="space-y-2">
              <label className="block text-sm font-bold text-white/90 ml-1">
                Password
              </label>
              <div className="relative group">
                <Lock className="absolute left-4 top-1/2 transform -translate-y-1/2 text-blue-300 group-focus-within:text-blue-400 transition-colors" size={20} />
                <input
                  type="password"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  required
                  className="w-full pl-12 pr-4 py-4 bg-white/10 backdrop-blur border-2 border-white/20 rounded-xl focus:border-blue-400 focus:ring-4 focus:ring-blue-500/20 outline-none transition-all text-white placeholder-white/50 font-medium"
                  placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                />
              </div>
            </div>

            {/* Submit Button */}
            <button
              type="submit"
              disabled={loading}
              className="relative w-full py-4 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-xl font-bold text-lg shadow-2xl hover:shadow-blue-500/50 disabled:opacity-50 disabled:cursor-not-allowed transition-all overflow-hidden group"
            >
              <div className="absolute inset-0 bg-gradient-to-r from-blue-600 to-purple-700 opacity-0 group-hover:opacity-100 transition-opacity"></div>
              <div className="relative flex items-center justify-center gap-2">
                {loading ? (
                  <>
                    <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
                    <span>Signing in...</span>
                  </>
                ) : (
                  <>
                    <LogIn size={20} />
                    <span>Sign In</span>
                  </>
                )}
              </div>
            </button>
          </form>

          {/* Register Link */}
          <div className="bg-white/5 px-8 py-6 border-t border-white/10 text-center">
            <p className="text-white/70 text-sm">
              Don't have an account?{' '}
              <Link 
                to="/register" 
                className="text-blue-300 font-bold hover:text-blue-200 transition-colors hover:underline"
              >
                Create one now
              </Link>
            </p>
          </div>
        </div>

        {/* Footer Note */}
        <p className="text-center text-white/50 text-xs mt-6 animate-in fade-in duration-1000">
          Secure login powered by Firebase Authentication
        </p>
      </div>

      {/* Custom CSS for animations */}
      <style jsx>{`
        @keyframes blob {
          0%, 100% { transform: translate(0, 0) scale(1); }
          33% { transform: translate(30px, -50px) scale(1.1); }
          66% { transform: translate(-20px, 20px) scale(0.9); }
        }
        @keyframes float {
          0%, 100% { transform: translateY(0px); }
          50% { transform: translateY(-20px); }
        }
        @keyframes shake {
          0%, 100% { transform: translateX(0); }
          10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
          20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        .animate-blob {
          animation: blob 7s infinite;
        }
        .animate-float {
          animation: float 3s ease-in-out infinite;
        }
        .animation-delay-1000 {
          animation-delay: 1s;
        }
        .animation-delay-2000 {
          animation-delay: 2s;
        }
        .animation-delay-3000 {
          animation-delay: 3s;
        }
        .animation-delay-4000 {
          animation-delay: 4s;
        }
        .animate-in {
          animation: fadeIn 0.5s ease-out;
        }
        .shake {
          animation: shake 0.5s;
        }
        @keyframes fadeIn {
          from { opacity: 0; }
          to { opacity: 1; }
        }
      `}</style>
    </div>
  );
}

// ========== src/pages/MistakeNotebookPage.jsx ==========

import React, { useState, useEffect, useMemo } from 'react';
import { useNavigate } from 'react-router-dom';
import { useAuth } from '../contexts/AuthContext';
import { useLanguage } from '../contexts/LanguageContext';
import { quizService } from '../services/quizService';
import { quizStorage } from '../utils/quizStorage';
import {
  BookOpen, ArrowLeft, Play, AlertCircle, Target,
  CheckCircle, Filter, ChevronDown, Calendar, Hash, Tag,
} from 'lucide-react';

export default function MistakeNotebookPage() {
  const { currentUser } = useAuth();
  const { isEnglish } = useLanguage();
  const navigate = useNavigate();

  const [mistakes, setMistakes] = useState([]);  // all mistakes raw
  const [loading, setLoading] = useState(true);
  const [showFilters, setShowFilters] = useState(true);

  // Filter state
  const [questionCount, setQuestionCount] = useState('5');   // default 5
  const [datePeriod, setDatePeriod] = useState('all');       // all | week | month
  const [selectedTopics, setSelectedTopics] = useState([]);  // empty = all topics

  useEffect(() => { loadMistakes(); }, [currentUser]);

  async function loadMistakes() {
    if (!currentUser) { setLoading(false); return; }
    try {
      setLoading(true);
      const attempts = await quizService.getUserAttempts(currentUser.uid, 100);
      const incorrectMap = new Map();

      attempts.forEach(attempt => {
        if (attempt.answers && attempt.questions) {
          attempt.questions.forEach(question => {
            const userAnswer = attempt.answers[question.ID];
            if (userAnswer && userAnswer !== question.CorrectOption) {
              if (!incorrectMap.has(question.ID)) {
                incorrectMap.set(question.ID, {
                  ...question,
                  attemptCount: 1,
                  lastAttempted: attempt.timestamp,
                  userAnswer,
                });
              } else {
                const existing = incorrectMap.get(question.ID);
                existing.attemptCount += 1;
                if (new Date(attempt.timestamp) > new Date(existing.lastAttempted)) {
                  existing.lastAttempted = attempt.timestamp;
                  existing.userAnswer = userAnswer;
                }
              }
            }
          });
        }
      });

      const arr = Array.from(incorrectMap.values()).sort(
        (a, b) => new Date(b.lastAttempted) - new Date(a.lastAttempted)
      );
      setMistakes(arr);
    } catch (err) {
      console.error('Error loading mistakes:', err);
    } finally {
      setLoading(false);
    }
  }

  // All unique topics from mistakes
  const allTopics = useMemo(() => {
    return [...new Set(mistakes.map(m => m.Topic).filter(Boolean))].sort();
  }, [mistakes]);

  // Apply filters
  const filteredMistakes = useMemo(() => {
    let result = [...mistakes];

    // Date filter
    if (datePeriod === 'week') {
      const weekAgo = new Date(); weekAgo.setDate(weekAgo.getDate() - 7);
      result = result.filter(m => new Date(m.lastAttempted) >= weekAgo);
    } else if (datePeriod === 'month') {
      const monthAgo = new Date(); monthAgo.setMonth(monthAgo.getMonth() - 1);
      result = result.filter(m => new Date(m.lastAttempted) >= monthAgo);
    }

    // Topic filter
    if (selectedTopics.length > 0) {
      result = result.filter(m => selectedTopics.includes(m.Topic));
    }

    return result;
  }, [mistakes, datePeriod, selectedTopics]);

  // The final slice for practice
  const practiceCount = questionCount === 'All' ? filteredMistakes.length : Math.min(parseInt(questionCount), filteredMistakes.length);

  const toggleTopic = (topic) => {
    setSelectedTopics(prev =>
      prev.includes(topic) ? prev.filter(t => t !== topic) : [...prev, topic]
    );
  };

  const handlePracticeMistakes = () => {
    if (filteredMistakes.length === 0) return;
    const shuffled = [...filteredMistakes].sort(() => 0.5 - Math.random());
    const selected = shuffled.slice(0, practiceCount);
    quizStorage.clearQuizData();
    quizStorage.saveSelectedQuestions(selected);
    localStorage.setItem('quiz_mode', 'mistakes');
    navigate('/quiz');
  };

  const formatDate = (iso) =>
    new Date(iso).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });

  if (loading) {
    return (
      <div className="flex items-center justify-center h-screen">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-lab-blue mx-auto mb-4"></div>
          <p className="text-slate-600">{isEnglish ? 'Loading your mistakes...' : 'ËºâÂÖ•ÈåØÈ°å‰∏≠...'}</p>
        </div>
      </div>
    );
  }

  return (
    <div className="max-w-6xl mx-auto space-y-6">
      {/* Header */}
      <div className="flex items-center gap-4">
        <button onClick={() => navigate('/dashboard')} className="p-3 bg-white rounded-lg border-2 border-slate-200 hover:border-lab-blue transition-all">
          <ArrowLeft size={20} />
        </button>
        <div className="flex-1 bg-gradient-to-r from-orange-600 to-red-600 rounded-2xl shadow-xl p-6 text-white">
          <h1 className="text-3xl font-black flex items-center gap-3">
            <BookOpen size={32} />
            {isEnglish ? 'Mistake Notebook' : 'ÈåØÈ°åÁ∞ø'}
          </h1>
          <p className="text-orange-100 mt-1">
            {isEnglish ? 'Review and master questions you got wrong' : 'Ë§áÁøí‰∏¶ÊéåÊè°ÊÇ®Á≠îÈåØÁöÑÈ°åÁõÆ'}
          </p>
        </div>
      </div>

      {/* Stats */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div className="bg-white rounded-xl shadow-lg border-2 border-slate-200 p-4">
          <div className="flex items-center gap-2 mb-2">
            <AlertCircle className="text-red-600" size={20} />
            <span className="text-sm font-semibold text-slate-600">{isEnglish ? 'Total Mistakes' : 'Á∏ΩÈåØÈ°åÊï∏'}</span>
          </div>
          <div className="text-3xl font-black text-red-600">{mistakes.length}</div>
        </div>
        <div className="bg-white rounded-xl shadow-lg border-2 border-slate-200 p-4">
          <div className="flex items-center gap-2 mb-2">
            <Target className="text-amber-600" size={20} />
            <span className="text-sm font-semibold text-slate-600">{isEnglish ? 'Topics to Focus' : 'ÈúÄÂä†Âº∑‰∏ªÈ°å'}</span>
          </div>
          <div className="text-3xl font-black text-amber-600">{new Set(mistakes.map(m => m.Topic)).size}</div>
        </div>
        <div className="bg-white rounded-xl shadow-lg border-2 border-slate-200 p-4">
          <div className="flex items-center gap-2 mb-2">
            <CheckCircle className="text-chemistry-green" size={20} />
            <span className="text-sm font-semibold text-slate-600">{isEnglish ? 'Repeated Mistakes' : 'ÈáçË§áÈåØË™§'}</span>
          </div>
          <div className="text-3xl font-black text-chemistry-green">{mistakes.filter(m => m.attemptCount > 1).length}</div>
        </div>
      </div>

      {/* ‚îÄ‚îÄ PRACTICE CONFIGURATOR ‚îÄ‚îÄ */}
      {mistakes.length > 0 && (
        <div className="bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
          {/* Toggle header */}
          <button
            onClick={() => setShowFilters(!showFilters)}
            className="w-full flex items-center justify-between p-5 hover:bg-slate-50 transition-all"
          >
            <div className="flex items-center gap-2">
              <Filter className="text-orange-600" size={20} />
              <span className="font-bold text-slate-800 text-lg">
                {isEnglish ? 'Configure Practice Session' : 'Ë®≠ÂÆöÁ∑¥Áøí'}
              </span>
            </div>
            <ChevronDown size={20} className={`text-slate-400 transition-transform ${showFilters ? 'rotate-180' : ''}`} />
          </button>

          {showFilters && (
            <div className="border-t border-slate-200 p-6 space-y-6 bg-slate-50">

              {/* 1. Question Count */}
              <div>
                <label className="flex items-center gap-2 text-sm font-black text-slate-600 uppercase tracking-widest mb-3">
                  <Hash size={14} />
                  {isEnglish ? '1. Number of Questions' : '1. È°åÁõÆÊï∏Èáè'}
                </label>
                <div className="grid grid-cols-4 md:grid-cols-7 gap-2">
                  {['5', '10', '15', '20', '30', '40', 'All'].map(num => (
                    <button
                      key={num}
                      onClick={() => setQuestionCount(num)}
                      disabled={num !== 'All' && parseInt(num) > filteredMistakes.length}
                      className={`py-2.5 rounded-xl border-2 font-bold text-sm transition-all ${
                        questionCount === num
                          ? 'border-orange-500 bg-orange-50 text-orange-600'
                          : 'border-slate-200 text-slate-500 hover:border-slate-300 disabled:opacity-30 disabled:cursor-not-allowed'
                      }`}
                    >
                      {num}
                    </button>
                  ))}
                </div>
                <p className="text-xs text-slate-500 mt-2">
                  {filteredMistakes.length} {isEnglish ? 'questions available with current filters' : 'È°åÁ¨¶ÂêàÁõÆÂâçÁØ©ÈÅ∏Ê¢ù‰ª∂'}
                </p>
              </div>

              {/* 2. Date Range */}
              <div>
                <label className="flex items-center gap-2 text-sm font-black text-slate-600 uppercase tracking-widest mb-3">
                  <Calendar size={14} />
                  {isEnglish ? '2. Time Range (when you made the mistake)' : '2. ÊôÇÈñìÁØÑÂúçÔºàÁäØÈåØÊôÇÈñìÔºâ'}
                </label>
                <div className="grid grid-cols-3 gap-2">
                  {[
                    { value: 'all', label: isEnglish ? 'All Time' : 'ÊâÄÊúâÊôÇÈñì', desc: isEnglish ? 'default' : 'È†êË®≠' },
                    { value: 'month', label: isEnglish ? 'Last Month' : '‰∏äÂÄãÊúà', desc: '' },
                    { value: 'week', label: isEnglish ? 'Last Week' : '‰∏äÈÄ±', desc: '' },
                  ].map(o => (
                    <button
                      key={o.value}
                      onClick={() => setDatePeriod(o.value)}
                      className={`py-3 px-4 rounded-xl border-2 font-bold text-sm transition-all text-left ${
                        datePeriod === o.value
                          ? 'border-orange-500 bg-orange-50 text-orange-700'
                          : 'border-slate-200 text-slate-600 hover:border-slate-300 bg-white'
                      }`}
                    >
                      {o.label}
                      {o.desc && <span className="block text-xs font-normal opacity-70">{o.desc}</span>}
                    </button>
                  ))}
                </div>
              </div>

              {/* 3. Topics */}
              {allTopics.length > 1 && (
                <div>
                  <label className="flex items-center gap-2 text-sm font-black text-slate-600 uppercase tracking-widest mb-3">
                    <Tag size={14} />
                    {isEnglish ? '3. Topics (leave empty for all)' : '3. ‰∏ªÈ°åÔºàÁïôÁ©∫Ë°®Á§∫ÂÖ®ÈÉ®Ôºâ'}
                  </label>
                  <div className="flex flex-wrap gap-2">
                    {allTopics.map(topic => (
                      <button
                        key={topic}
                        onClick={() => toggleTopic(topic)}
                        className={`px-3 py-2 rounded-full text-xs font-bold border-2 transition-all ${
                          selectedTopics.includes(topic)
                            ? 'bg-orange-500 border-orange-500 text-white'
                            : 'bg-white border-slate-200 text-slate-600 hover:border-orange-300'
                        }`}
                      >
                        {topic}
                        <span className="ml-1 opacity-70">
                          ({mistakes.filter(m => m.Topic === topic).length})
                        </span>
                      </button>
                    ))}
                  </div>
                  {selectedTopics.length > 0 && (
                    <button
                      onClick={() => setSelectedTopics([])}
                      className="mt-2 text-xs text-orange-600 hover:underline font-semibold"
                    >
                      {isEnglish ? '‚úï Clear topic filter' : '‚úï Ê∏ÖÈô§‰∏ªÈ°åÁØ©ÈÅ∏'}
                    </button>
                  )}
                </div>
              )}

              {/* Start Button */}
              <button
                onClick={handlePracticeMistakes}
                disabled={filteredMistakes.length === 0}
                className="w-full py-4 bg-orange-600 text-white rounded-2xl font-black text-lg shadow-lg hover:bg-orange-700 disabled:bg-slate-300 transition-all flex items-center justify-center gap-2 active:scale-95"
              >
                <Play fill="currentColor" size={18} />
                {isEnglish
                  ? `Practice ${practiceCount} Mistake${practiceCount !== 1 ? 's' : ''}`
                  : `Á∑¥Áøí ${practiceCount} ÈÅìÈåØÈ°å`
                }
              </button>
            </div>
          )}
        </div>
      )}

      {/* Mistakes List */}
      <div className="bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
        <div className="bg-slate-50 p-4 border-b">
          <h2 className="text-lg font-bold text-slate-800">
            {isEnglish ? 'All Mistakes' : 'ÊâÄÊúâÈåØÈ°å'} ({mistakes.length})
          </h2>
        </div>

        <div className="p-6">
          {mistakes.length === 0 ? (
            <div className="text-center py-12">
              <CheckCircle className="w-16 h-16 text-green-300 mx-auto mb-4" />
              <p className="text-slate-400 text-lg mb-2 font-semibold">
                {isEnglish ? 'No mistakes yet!' : 'ÁõÆÂâçÊ≤íÊúâÈåØÈ°åÔºÅ'}
              </p>
              <p className="text-slate-500 text-sm mb-4">
                {isEnglish ? "Keep practicing. Wrong answers appear here." : 'ÁπºÁ∫åÁ∑¥Áøí„ÄÇÁ≠îÈåØÁöÑÈ°åÁõÆÊúÉÂá∫ÁèæÂú®ÈÄôË£°„ÄÇ'}
              </p>
              <button onClick={() => navigate('/')} className="px-6 py-3 bg-lab-blue text-white rounded-lg font-bold hover:bg-blue-800 transition-all">
                {isEnglish ? 'Start Practicing' : 'ÈñãÂßãÁ∑¥Áøí'}
              </button>
            </div>
          ) : (
            <div className="space-y-4">
              {mistakes.map((mistake, index) => (
                <div key={mistake.ID} className="p-6 rounded-xl border-2 border-slate-100 hover:border-red-200 transition-all">
                  <div className="flex justify-between items-start mb-4">
                    <div className="flex items-center gap-3">
                      <div className="w-12 h-12 rounded-lg bg-red-100 flex items-center justify-center font-black text-red-600">
                        #{index + 1}
                      </div>
                      <div>
                        <div className="text-xs font-bold text-slate-500 uppercase">{mistake.Topic}</div>
                        <div className="text-xs text-slate-400">{mistake.Subtopic}</div>
                      </div>
                    </div>
                    <div className="text-right">
                      <div className="text-xs text-slate-500">{isEnglish ? 'Last Attempt' : 'ÊúÄÂæåÂòóË©¶'}</div>
                      <div className="text-sm font-semibold text-slate-700">{formatDate(mistake.lastAttempted)}</div>
                      {mistake.attemptCount > 1 && (
                        <div className="text-xs text-amber-600 font-bold mt-1">
                          ‚ö†Ô∏è {isEnglish ? `Missed ${mistake.attemptCount}√ó` : `ÈåØ ${mistake.attemptCount} Ê¨°`}
                        </div>
                      )}
                    </div>
                  </div>

                  <div className="mb-4 p-4 bg-slate-50 rounded-lg">
                    <div className="text-base text-slate-800 font-medium prose max-w-none whitespace-pre-wrap"
                      dangerouslySetInnerHTML={{ __html: mistake.Question }} />
                  </div>

                  {mistake.Pictureurl && (
                    <div className="mb-4 flex justify-center bg-white p-4 rounded-xl border border-slate-100">
                      <img src={mistake.Pictureurl} alt="Diagram" className="max-w-full h-auto max-h-[200px] object-contain rounded-md" />
                    </div>
                  )}

                  <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                    <div className="p-3 rounded-lg bg-red-50 border border-red-200">
                      <div className="text-xs font-bold text-red-700 mb-1">{isEnglish ? 'Your Answer' : 'ÊÇ®ÁöÑÁ≠îÊ°à'}</div>
                      <div className="text-sm font-semibold text-red-900">{mistake.userAnswer}</div>
                    </div>
                    <div className="p-3 rounded-lg bg-green-50 border border-green-200">
                      <div className="text-xs font-bold text-green-700 mb-1">{isEnglish ? 'Correct Answer' : 'Ê≠£Á¢∫Á≠îÊ°à'}</div>
                      <div className="text-sm font-semibold text-green-900">{mistake.CorrectOption}</div>
                    </div>
                  </div>

                  {mistake.Explanation && (
                    <div className="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                      <div className="text-xs font-bold text-blue-700 mb-2 flex items-center gap-1">
                        <BookOpen size={14} /> {isEnglish ? 'Explanation' : 'Ëß£Èáã'}
                      </div>
                      <div className="text-sm text-blue-900 leading-relaxed prose max-w-none"
                        dangerouslySetInnerHTML={{ __html: mistake.Explanation }} />
                    </div>
                  )}
                </div>
              ))}
            </div>
          )}
        </div>
      </div>

      <div className="bg-blue-50 border-2 border-blue-200 rounded-xl p-4 text-sm">
        <p className="text-blue-900 font-semibold mb-2">üí° {isEnglish ? 'How it works' : 'ÈÅã‰ΩúÂéüÁêÜ'}</p>
        <ul className="list-disc list-inside space-y-1 text-blue-800">
          <li>{isEnglish ? 'Wrong answers are auto-saved here' : 'Á≠îÈåØÁöÑÈ°åÁõÆËá™ÂãïÂÑ≤Â≠òÂú®ÈÄôË£°'}</li>
          <li>{isEnglish ? 'Use filters to focus on specific topics or recent mistakes' : '‰ΩøÁî®ÁØ©ÈÅ∏Âô®Â∞àÊ≥®ÊñºÁâπÂÆö‰∏ªÈ°åÊàñÊúÄËøëÁöÑÈåØË™§'}</li>
          <li>{isEnglish ? 'Practice until you master them!' : 'Á∑¥ÁøíÁõ¥Âà∞ÊÇ®ÊéåÊè°ÂÆÉÂÄëÔºÅ'}</li>
        </ul>
      </div>
    </div>
  );
}

// ========== src/pages/PracticeModeSelection.jsx ==========

import React, { useState, useMemo } from 'react';
import { useNavigate } from 'react-router-dom';
import { useAuth } from '../contexts/AuthContext';
import { Clock, Infinity, Settings, Play, Zap, BookOpen, Lock, Check, AlertCircle } from 'lucide-react';
import { quizStorage } from '../utils/quizStorage';
import { useLanguage } from '../contexts/LanguageContext';
import { doc, updateDoc } from 'firebase/firestore';
import { db } from '../firebase/config';

export default function PracticeModeSelection({ questions }) {
  const navigate = useNavigate();
  const { currentUser, userProfile, loadUserProfile } = useAuth();
  const { isEnglish } = useLanguage();
  const [selectedMode, setSelectedMode] = useState(null);
  const [questionCount, setQuestionCount] = useState(10);
  const [showCustom, setShowCustom] = useState(false);
  const [showUpdateTopics, setShowUpdateTopics] = useState(false);

  // Custom mode state
  const [selectedTopics, setSelectedTopics] = useState([]);
  const [selectedSubtopics, setSelectedSubtopics] = useState([]);
  const [customCount, setCustomCount] = useState(10);

  // Quick update topics state
  const [tempLearnedUpTo, setTempLearnedUpTo] = useState(userProfile?.learnedUpTo || '');
  const [tempExceptions, setTempExceptions] = useState(userProfile?.topicExceptions || []);
  const [updating, setUpdating] = useState(false);

  const MAX_QUESTIONS = 40;

  // Get all unique topics from questions
  const allTopics = useMemo(() => {
    return [...new Set(questions.map(q => q.Topic))]
      .filter(t => t && t !== "Uncategorized")
      .sort((a, b) => a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' }));
  }, [questions]);

  // Get available topics based on user's learned progress
  const availableTopics = useMemo(() => {
    const learnedUpTo = userProfile?.learnedUpTo;
    const exceptions = userProfile?.topicExceptions || [];
    
    if (!learnedUpTo) return [];
    
    return allTopics.filter(topic => {
      const topicNum = topic.match(/^\d+/)?.[0];
      return topicNum && topicNum <= learnedUpTo && !exceptions.includes(topic);
    });
  }, [allTopics, userProfile]);

  // For custom mode: determine which topics can be selected
  const customTopics = useMemo(() => {
    return allTopics.map(topic => {
      const isAvailable = availableTopics.includes(topic);
      return {
        name: topic,
        available: isAvailable
      };
    });
  }, [allTopics, availableTopics]);

  const availableSubtopics = useMemo(() => {
    if (selectedTopics.length === 0) return [];
    return [...new Set(questions
      .filter(q => selectedTopics.includes(q.Topic))
      .map(q => q.Subtopic))]
      .filter(Boolean)
      .sort((a, b) => a.localeCompare(b, undefined, { numeric: true }));
  }, [selectedTopics, questions]);

  const toggleTopic = (topic) => {
    setSelectedTopics(prev => 
      prev.includes(topic) ? prev.filter(t => t !== topic) : [...prev, topic]
    );
    setSelectedSubtopics([]);
  };

  const toggleSubtopic = (sub) => {
    setSelectedSubtopics(prev => 
      prev.includes(sub) ? prev.filter(s => s !== sub) : [...prev, sub]
    );
  };

  const handleUpdateTopics = async () => {
    setUpdating(true);
    try {
      const userRef = doc(db, 'users', currentUser.uid);
      await updateDoc(userRef, {
        learnedUpTo: tempLearnedUpTo,
        topicExceptions: tempExceptions,
        updatedAt: new Date().toISOString()
      });
      await loadUserProfile(currentUser.uid);
      setShowUpdateTopics(false);
      alert(isEnglish ? 'Topics updated successfully!' : '‰∏ªÈ°åÂ∑≤ÊàêÂäüÊõ¥Êñ∞ÔºÅ');
    } catch (error) {
      console.error('Error updating topics:', error);
      alert(isEnglish ? 'Failed to update topics' : 'Êõ¥Êñ∞‰∏ªÈ°åÂ§±Êïó');
    }
    setUpdating(false);
  };

  const handleModeSelect = (mode, count) => {
    if (availableTopics.length === 0) {
      alert(isEnglish 
        ? "Please set your learned topics in Profile first!" 
        : "Ë´ãÂÖàÂú®ÂÄã‰∫∫Ë≥áÊñô‰∏≠Ë®≠ÂÆöÊÇ®Â∑≤Â≠∏ÁøíÁöÑ‰∏ªÈ°åÔºÅ"
      );
      navigate('/profile');
      return;
    }

    setSelectedMode(mode);
    setQuestionCount(count);
    
    if (mode === 'custom') {
      setShowCustom(true);
    } else {
      // For Timed and Marathon: filter by available topics
      const filtered = questions.filter(q => availableTopics.includes(q.Topic));
      const shuffled = [...filtered].sort(() => 0.5 - Math.random());
      const finalSelection = shuffled.slice(0, Math.min(count, MAX_QUESTIONS, shuffled.length));
      
      startQuiz(finalSelection, mode);
    }
  };

  const handleCustomStart = () => {
    let pool = questions.filter(q => selectedTopics.includes(q.Topic));
    
    if (selectedSubtopics.length > 0) {
      pool = pool.filter(q => selectedSubtopics.includes(q.Subtopic));
    }
    
    const shuffled = [...pool].sort(() => 0.5 - Math.random());
    const requestedCount = customCount === 'All' ? pool.length : parseInt(customCount);
    const finalCount = Math.min(requestedCount, MAX_QUESTIONS);
    const finalSelection = shuffled.slice(0, finalCount);
    
    if (finalSelection.length === 0) {
      alert(isEnglish 
        ? "No questions found for this selection. Try broader filters!" 
        : "Êâæ‰∏çÂà∞Á¨¶ÂêàÊ¢ù‰ª∂ÁöÑÈ°åÁõÆ„ÄÇË´ãÂòóË©¶Êõ¥Âª£Ê≥õÁöÑÁØ©ÈÅ∏ÔºÅ"
      );
      return;
    }

    if (requestedCount > MAX_QUESTIONS) {
      alert(isEnglish 
        ? `Session limited to ${MAX_QUESTIONS} questions maximum.` 
        : `ÊØèÊ¨°Á∑¥ÁøíÊúÄÂ§ö ${MAX_QUESTIONS} È°å„ÄÇ`
      );
    }

    startQuiz(finalSelection, 'custom');
  };

  const startQuiz = (selectedQuestions, mode) => {
    quizStorage.clearQuizData();
    quizStorage.saveSelectedQuestions(selectedQuestions);
    
    localStorage.setItem('quiz_mode', mode);
    if (mode === 'timed') {
      const timeLimit = selectedQuestions.length * 1.25 * 60 * 1000;
      localStorage.setItem('quiz_time_limit', timeLimit.toString());
    }
    
    navigate('/quiz');
  };

  // Quick update topics modal
  if (showUpdateTopics) {
    const learnedRangeTopics = allTopics.filter(topic => {
      const topicNum = topic.match(/^\d+/)?.[0];
      return topicNum && topicNum <= tempLearnedUpTo;
    });

    return (
      <div className="max-w-4xl mx-auto space-y-6">
        <div className="bg-white rounded-2xl shadow-xl border-2 border-slate-200 overflow-hidden">
          <div className="bg-lab-blue p-6 text-white flex justify-between items-center">
            <h2 className="text-2xl font-bold">
              {isEnglish ? 'Update Your Topics' : 'Êõ¥Êñ∞ÊÇ®ÁöÑ‰∏ªÈ°å'}
            </h2>
            <button
              onClick={() => setShowUpdateTopics(false)}
              className="text-white hover:text-blue-100 font-bold"
            >
              ‚úï
            </button>
          </div>

          <div className="p-6 space-y-6">
            <div>
              <label className="block text-sm font-bold text-slate-700 mb-3">
                {isEnglish ? 'Learned Up To:' : 'Â∑≤Â≠∏ÁøíËá≥Ôºö'}
              </label>
              <div className="grid grid-cols-6 md:grid-cols-8 gap-2">
                {allTopics.map((topic) => {
                  const topicNum = topic.match(/^\d+/)?.[0];
                  return (
                    <button
                      key={topic}
                      onClick={() => setTempLearnedUpTo(topicNum)}
                      className={`py-2 rounded-lg border-2 font-bold transition-all ${
                        tempLearnedUpTo === topicNum
                          ? 'border-chemistry-green bg-green-50 text-chemistry-green'
                          : 'border-slate-200 text-slate-600 hover:border-slate-300'
                      }`}
                    >
                      {topicNum}
                    </button>
                  );
                })}
              </div>
            </div>

            {tempLearnedUpTo && learnedRangeTopics.length > 0 && (
              <div>
                <label className="block text-sm font-bold text-slate-700 mb-3">
                  {isEnglish ? 'Exceptions (Not Learned):' : '‰æãÂ§ñÔºàÊú™Â≠∏ÁøíÔºâÔºö'}
                </label>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                  {learnedRangeTopics.map((topic) => {
                    const isException = tempExceptions.includes(topic);
                    return (
                      <button
                        key={topic}
                        onClick={() => setTempExceptions(prev =>
                          prev.includes(topic) ? prev.filter(t => t !== topic) : [...prev, topic]
                        )}
                        className={`flex items-center justify-between p-3 rounded-xl border-2 transition-all ${
                          isException
                            ? 'border-red-300 bg-red-50 text-red-700'
                            : 'border-green-200 bg-green-50 text-green-700'
                        }`}
                      >
                        <span className="text-sm font-semibold">{topic}</span>
                        {isException ? <Lock size={16} /> : <Check size={16} />}
                      </button>
                    );
                  })}
                </div>
              </div>
            )}

            <div className="flex gap-3">
              <button
                onClick={handleUpdateTopics}
                disabled={updating}
                className="flex-1 py-3 bg-chemistry-green text-white rounded-xl font-bold hover:opacity-90 disabled:bg-slate-300 transition-all"
              >
                {updating ? (isEnglish ? 'Updating...' : 'Êõ¥Êñ∞‰∏≠...') : (isEnglish ? 'Save Changes' : 'ÂÑ≤Â≠òËÆäÊõ¥')}
              </button>
              <button
                onClick={() => setShowUpdateTopics(false)}
                className="px-6 py-3 bg-slate-200 text-slate-700 rounded-xl font-bold hover:bg-slate-300 transition-all"
              >
                {isEnglish ? 'Cancel' : 'ÂèñÊ∂à'}
              </button>
            </div>
          </div>
        </div>
      </div>
    );
  }

  // Custom mode configuration
  if (showCustom) {
    return (
      <div className="max-w-4xl mx-auto space-y-6 animate-in fade-in duration-500">
        <div className="bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
          <div className="bg-slate-50 p-6 border-b flex justify-between items-center">
            <h2 className="text-xl font-bold flex items-center gap-2 text-slate-800">
              <Settings size={20} className="text-lab-blue" />
              {isEnglish ? 'Configure Custom Session' : 'Ëá™Ë®ÇÁ∑¥ÁøíË®≠ÂÆö'}
            </h2>
            <button
              onClick={() => setShowCustom(false)}
              className="text-sm text-slate-600 hover:text-slate-800 hover:underline font-semibold"
            >
              ‚Üê {isEnglish ? 'Back' : 'ËøîÂõû'}
            </button>
          </div>

          <div className="p-8 space-y-8">
            <div>
              <label className="block text-sm font-black text-slate-500 uppercase tracking-widest mb-4">
                1. {isEnglish ? 'Select Topics (Multi-choice)' : 'ÈÅ∏Êìá‰∏ªÈ°åÔºàÂèØÂ§öÈÅ∏Ôºâ'}
              </label>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                {customTopics.map(({ name, available }) => (
                  <button
                    key={name}
                    onClick={() => available && toggleTopic(name)}
                    disabled={!available}
                    className={`flex items-center justify-between p-3 rounded-xl border-2 transition-all ${
                      !available
                        ? 'border-slate-200 bg-slate-50 text-slate-400 cursor-not-allowed opacity-50'
                        : selectedTopics.includes(name)
                        ? 'border-lab-blue bg-blue-50 text-lab-blue shadow-sm'
                        : 'border-slate-100 text-slate-600 hover:border-slate-200'
                    }`}
                  >
                    <span className="text-sm font-semibold flex items-center gap-2">
                      {!available && <Lock size={14} />}
                      {name}
                    </span>
                    {selectedTopics.includes(name) && <Check size={16} />}
                  </button>
                ))}
              </div>
              {customTopics.some(t => !t.available) && (
                <p className="text-xs text-amber-600 mt-2 flex items-center gap-1">
                  <Lock size={12} />
                  {isEnglish 
                    ? 'Locked topics not yet learned. Update in Profile or click button above.' 
                    : 'ÈéñÂÆöÁöÑ‰∏ªÈ°åÂ∞öÊú™Â≠∏Áøí„ÄÇË´ãÂú®ÂÄã‰∫∫Ë≥áÊñô‰∏≠Êõ¥Êñ∞ÊàñÈªûÊìä‰∏äÊñπÊåâÈàï„ÄÇ'}
                </p>
              )}
            </div>

            {selectedTopics.length > 0 && availableSubtopics.length > 0 && (
              <div className="animate-in slide-in-from-top-4">
                <label className="block text-sm font-black text-slate-500 mb-4 uppercase tracking-widest">
                  2. {isEnglish ? 'Focus on Subtopics (Optional)' : 'ÈÅ∏ÊìáÂ≠ê‰∏ªÈ°åÔºàÂèØÈÅ∏Ôºâ'}
                </label>
                <div className="flex flex-wrap gap-2">
                  {availableSubtopics.map(sub => (
                    <button
                      key={sub}
                      onClick={() => toggleSubtopic(sub)}
                      className={`px-4 py-2 rounded-full text-xs font-bold border-2 transition-all ${
                        selectedSubtopics.includes(sub)
                        ? 'bg-lab-blue border-lab-blue text-white'
                        : 'bg-white border-slate-200 text-slate-500 hover:border-slate-300'
                      }`}
                    >
                      {sub}
                    </button>
                  ))}
                </div>
              </div>
            )}

            <div>
              <label className="block text-sm font-black text-slate-500 mb-4 uppercase tracking-widest">
                3. {isEnglish ? 'Session Length' : 'Á∑¥ÁøíÈ°åÊï∏'}
              </label>
              <div className="grid grid-cols-3 md:grid-cols-6 gap-3">
                {['5', '10', '15', '20', '30', '40'].map(num => (
                  <button
                    key={num}
                    onClick={() => setCustomCount(num)}
                    className={`py-3 rounded-xl border-2 font-bold transition-all ${
                      customCount === num ? 'border-lab-blue bg-blue-50 text-lab-blue' : 'border-slate-100 text-slate-400'
                    }`}
                  >
                    {num}
                  </button>
                ))}
              </div>
            </div>

            <button 
              disabled={selectedTopics.length === 0}
              onClick={handleCustomStart}
              className="w-full py-5 bg-lab-blue text-white rounded-2xl font-black text-lg shadow-lg hover:bg-blue-800 disabled:bg-slate-200 transition-all flex items-center justify-center gap-2 active:scale-95"
            >
              <Play fill="currentColor" size={18} />
              {isEnglish ? 'GENERATE EXAM' : 'ÈñãÂßãÁ∑¥Áøí'}
            </button>
          </div>
        </div>
      </div>
    );
  }

  // Main mode selection screen
  return (
    <div className="max-w-6xl mx-auto space-y-6 animate-in fade-in duration-500">
      <div className="text-center mb-8">
        <h1 className="text-4xl font-black text-academic-charcoal mb-2">
          {isEnglish ? 'Select Practice Mode' : 'ÈÅ∏ÊìáÁ∑¥ÁøíÊ®°Âºè'}
        </h1>
        <p className="text-academic-light-slate text-lg">
          {isEnglish ? 'Choose how you want to practice today' : 'ÈÅ∏ÊìáÊÇ®ÁöÑÁ∑¥ÁøíÊñπÂºè'}
        </p>
      </div>

      {/* Available Topics Info + Update Button */}
      {availableTopics.length > 0 ? (
        <div className="bg-blue-50 border-2 border-blue-200 rounded-xl p-4">
          <div className="flex justify-between items-start mb-2">
            <div>
              <h3 className="font-bold text-blue-900 flex items-center gap-2">
                <BookOpen size={16} />
                {isEnglish ? 'Your Available Topics' : 'ÊÇ®ÂèØÁî®ÁöÑ‰∏ªÈ°å'} ({availableTopics.length})
              </h3>
              <div className="flex flex-wrap gap-2 mt-2">
                {availableTopics.slice(0, 8).map((topic) => (
                  <span key={topic} className="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs font-bold">
                    {topic}
                  </span>
                ))}
                {availableTopics.length > 8 && (
                  <span className="px-2 py-1 text-blue-700 text-xs font-bold">
                    +{availableTopics.length - 8} more
                  </span>
                )}
              </div>
            </div>
            <button
              onClick={() => setShowUpdateTopics(true)}
              className="px-4 py-2 bg-lab-blue text-white rounded-lg font-bold text-sm hover:bg-blue-700 transition-all whitespace-nowrap"
            >
              {isEnglish ? 'Update Topics' : 'Êõ¥Êñ∞‰∏ªÈ°å'}
            </button>
          </div>
        </div>
      ) : (
        <div className="bg-amber-50 border-2 border-amber-300 rounded-xl p-4">
          <div className="flex items-start gap-3">
            <AlertCircle className="text-amber-600 flex-shrink-0 mt-0.5" size={20} />
            <div className="flex-1">
              <p className="text-amber-900 font-bold mb-2">
                {isEnglish ? 'No topics configured!' : 'Â∞öÊú™Ë®≠ÂÆö‰∏ªÈ°åÔºÅ'}
              </p>
              <p className="text-amber-800 text-sm mb-3">
                {isEnglish 
                  ? 'Please set which topics you\'ve learned in your Profile settings.' 
                  : 'Ë´ãÂú®ÂÄã‰∫∫Ë≥áÊñôË®≠ÂÆö‰∏≠Ë®≠ÂÆöÊÇ®Â∑≤Â≠∏ÁøíÁöÑ‰∏ªÈ°å„ÄÇ'}
              </p>
              <button
                onClick={() => navigate('/profile')}
                className="px-4 py-2 bg-amber-600 text-white rounded-lg font-bold hover:bg-amber-700 transition-all"
              >
                {isEnglish ? 'Go to Profile' : 'ÂâçÂæÄÂÄã‰∫∫Ë≥áÊñô'}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Mode Selection Cards */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
        {/* TIMED MODE */}
        <div className="bg-white rounded-2xl shadow-xl border-2 border-slate-200 overflow-hidden">
          <div className="bg-red-500 p-6 text-white">
            <div className="flex items-center gap-3 mb-2">
              <Clock size={32} strokeWidth={3} />
              <h3 className="text-2xl font-black">
                {isEnglish ? 'Timed' : 'ÈôêÊôÇÊ®°Âºè'}
              </h3>
            </div>
            <p className="text-red-100 text-sm">
              {isEnglish ? '1.25 min per question' : 'ÊØèÈ°å 1.25 ÂàÜÈêò'}
            </p>
          </div>
          
          <div className="p-6 space-y-4">
            <p className="text-sm text-slate-600">
              {isEnglish 
                ? 'Perfect for exam simulation with a countdown timer.' 
                : 'ÊúÄÈÅ©ÂêàËÄÉË©¶Ê®°Êì¨ÔºåÂ∏∂ÊúâÂÄíÊï∏Ë®àÊôÇÂô®„ÄÇ'}
            </p>
            
            <div>
              <label className="block text-xs font-bold text-slate-500 mb-2 uppercase">
                {isEnglish ? 'Questions:' : 'È°åÊï∏Ôºö'}
              </label>
              <div className="grid grid-cols-3 gap-2">
                {[5, 10, 20, 40].map(num => (
                  <button
                    key={num}
                    onClick={() => handleModeSelect('timed', num)}
                    disabled={availableTopics.length === 0}
                    className="py-2 bg-red-50 border-2 border-red-200 text-red-700 rounded-lg font-bold hover:bg-red-100 disabled:bg-slate-100 disabled:text-slate-400 disabled:border-slate-200 transition-all"
                  >
                    {num}
                  </button>
                ))}
              </div>
            </div>
          </div>
        </div>

        {/* MARATHON MODE */}
        <div className="bg-white rounded-2xl shadow-xl border-2 border-slate-200 overflow-hidden">
          <div className="bg-purple-600 p-6 text-white">
            <div className="flex items-center gap-3 mb-2">
              <Infinity size={32} strokeWidth={3} />
              <h3 className="text-2xl font-black">
                {isEnglish ? 'Marathon' : 'È¶¨ÊãâÊùæÊ®°Âºè'}
              </h3>
            </div>
            <p className="text-purple-100 text-sm">
              {isEnglish ? 'Unlimited time' : 'ÁÑ°ÈôêÊôÇÈñì'}
            </p>
          </div>
          
          <div className="p-6 space-y-4">
            <p className="text-sm text-slate-600">
              {isEnglish 
                ? 'Take your time. We\'ll track duration but no pressure!' 
                : 'ÊÖ¢ÊÖ¢‰æÜ„ÄÇÊàëÂÄëÊúÉË®òÈåÑÊôÇÈñì‰ΩÜÊ≤íÊúâÂ£ìÂäõÔºÅ'}
            </p>
            
            <div>
              <label className="block text-xs font-bold text-slate-500 mb-2 uppercase">
                {isEnglish ? 'Questions:' : 'È°åÊï∏Ôºö'}
              </label>
              <div className="grid grid-cols-3 gap-2">
                {[5, 10, 20, 40].map(num => (
                  <button
                    key={num}
                    onClick={() => handleModeSelect('marathon', num)}
                    disabled={availableTopics.length === 0}
                    className="py-2 bg-purple-50 border-2 border-purple-200 text-purple-700 rounded-lg font-bold hover:bg-purple-100 disabled:bg-slate-100 disabled:text-slate-400 disabled:border-slate-200 transition-all"
                  >
                    {num}
                  </button>
                ))}
              </div>
            </div>
          </div>
        </div>

        {/* CUSTOM MODE */}
        <div className="bg-white rounded-2xl shadow-xl border-2 border-slate-200 overflow-hidden">
          <div className="bg-lab-blue p-6 text-white">
            <div className="flex items-center gap-3 mb-2">
              <Settings size={32} strokeWidth={3} />
              <h3 className="text-2xl font-black">
                {isEnglish ? 'Custom' : 'Ëá™Ë®ÇÊ®°Âºè'}
              </h3>
            </div>
            <p className="text-blue-100 text-sm">
              {isEnglish ? 'Full control' : 'ÂÆåÂÖ®ÊéßÂà∂'}
            </p>
          </div>
          
          <div className="p-6 space-y-4">
            <p className="text-sm text-slate-600">
              {isEnglish 
                ? 'Choose specific topics, subtopics, and question count.' 
                : 'ÈÅ∏ÊìáÁâπÂÆö‰∏ªÈ°å„ÄÅÂ≠ê‰∏ªÈ°åÂíåÈ°åÊï∏„ÄÇ'}
            </p>
            
            <button
              onClick={() => handleModeSelect('custom', 10)}
              disabled={availableTopics.length === 0}
              className="w-full py-3 bg-lab-blue text-white rounded-xl font-bold hover:bg-blue-700 disabled:bg-slate-300 transition-all"
            >
              {isEnglish ? 'Configure' : 'Ë®≠ÂÆö'}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

// ========== src/pages/ProfilePage.jsx ==========

import React, { useState, useMemo } from 'react';
import { useNavigate } from 'react-router-dom';
import { useAuth } from '../contexts/AuthContext';
import { updateProfile } from 'firebase/auth';
import { doc, updateDoc } from 'firebase/firestore';
import { db } from '../firebase/config';
import { User, GraduationCap, Mail, Calendar, Save, ArrowLeft, Trophy, Target, BookOpen, Lock, Unlock } from 'lucide-react';
import { useQuizData } from '../hooks/useQuizData';

const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTK36yaUN-NMCkQNT-DAHgc6FMZPjUc0Yv3nYEK4TA9W2qE9V1TqVD10Tq98-wXQoAvKOZlwGWRSDkU/pub?gid=1182550140&single=true&output=csv';

export default function ProfilePage() {
  const { currentUser, userProfile, loadUserProfile } = useAuth();
  const navigate = useNavigate();
  const { questions, loading: questionsLoading } = useQuizData(SHEET_URL);
  
  const [displayName, setDisplayName] = useState(currentUser?.displayName || '');
  const [level, setLevel] = useState(userProfile?.level || 'S5');
  const [learnedUpTo, setLearnedUpTo] = useState(userProfile?.learnedUpTo || '');
  const [topicExceptions, setTopicExceptions] = useState(userProfile?.topicExceptions || []);
  const [saving, setSaving] = useState(false);
  const [message, setMessage] = useState({ type: '', text: '' });

  // Extract all unique topics from questions
  const allTopics = useMemo(() => {
    if (!questions || questions.length === 0) return [];
    return [...new Set(questions.map(q => q.Topic))]
      .filter(t => t && t !== "Uncategorized")
      .sort((a, b) => a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' }));
  }, [questions]);

  // Get currently available topics based on learnedUpTo and exceptions
  const availableTopics = useMemo(() => {
    if (!learnedUpTo) return [];
    
    const available = [];
    for (const topic of allTopics) {
      const topicNum = topic.match(/^\d+/)?.[0];
      if (topicNum && topicNum <= learnedUpTo && !topicExceptions.includes(topic)) {
        available.push(topic);
      }
    }
    return available;
  }, [allTopics, learnedUpTo, topicExceptions]);

  // Get topics that are within learned range (for exceptions UI)
  const learnedRangeTopics = useMemo(() => {
    if (!learnedUpTo) return [];
    
    return allTopics.filter(topic => {
      const topicNum = topic.match(/^\d+/)?.[0];
      return topicNum && topicNum <= learnedUpTo;
    });
  }, [allTopics, learnedUpTo]);

  const toggleTopicException = (topic) => {
    setTopicExceptions(prev => 
      prev.includes(topic) 
        ? prev.filter(t => t !== topic)
        : [...prev, topic]
    );
  };

  async function handleSave(e) {
    e.preventDefault();
    setSaving(true);
    setMessage({ type: '', text: '' });

    try {
      // Update Firebase Auth profile
      await updateProfile(currentUser, {
        displayName: displayName
      });

      // Update Firestore user document
      const userRef = doc(db, 'users', currentUser.uid);
      await updateDoc(userRef, {
        displayName: displayName,
        level: level,
        learnedUpTo: learnedUpTo,
        topicExceptions: topicExceptions,
        updatedAt: new Date().toISOString()
      });

      // Reload user profile
      await loadUserProfile(currentUser.uid);

      setMessage({ type: 'success', text: 'Profile updated successfully!' });
    } catch (error) {
      console.error('Error updating profile:', error);
      setMessage({ type: 'error', text: 'Failed to update profile. Please try again.' });
    }

    setSaving(false);
  }

  const formatDate = (isoString) => {
    if (!isoString) return 'N/A';
    const date = new Date(isoString);
    return date.toLocaleDateString('en-GB', { 
      day: '2-digit', 
      month: 'short', 
      year: 'numeric'
    });
  };

  const overallAccuracy = userProfile?.totalQuestions > 0
    ? Math.round((userProfile.totalCorrect / userProfile.totalQuestions) * 100)
    : 0;

  return (
    <div className="max-w-4xl mx-auto space-y-6">
      {/* Header */}
      <div className="flex items-center gap-4">
        <button
          onClick={() => navigate('/dashboard')}
          className="p-3 bg-white rounded-lg border-2 border-slate-200 hover:border-lab-blue transition-all"
        >
          <ArrowLeft size={20} />
        </button>
        
        <div className="flex-1 bg-gradient-to-r from-lab-blue to-blue-700 rounded-2xl shadow-xl p-6 text-white">
          <h1 className="text-3xl font-black flex items-center gap-3">
            <User size={32} />
            Profile Settings
          </h1>
          <p className="text-blue-100 mt-1">
            Manage your account and learning preferences
          </p>
        </div>
      </div>

      {/* Stats Summary */}
      <div className="bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
        <div className="bg-slate-50 p-4 border-b">
          <h2 className="text-lg font-bold text-slate-800">Your Statistics</h2>
        </div>
        
        <div className="p-6 grid grid-cols-1 md:grid-cols-3 gap-4">
          <div className="bg-blue-50 rounded-xl p-4 border-2 border-blue-200">
            <div className="flex items-center gap-2 mb-2">
              <Trophy className="text-lab-blue" size={20} />
              <span className="text-sm font-semibold text-slate-600">Total Attempts</span>
            </div>
            <div className="text-3xl font-black text-lab-blue">
              {userProfile?.totalAttempts || 0}
            </div>
          </div>

          <div className="bg-green-50 rounded-xl p-4 border-2 border-green-200">
            <div className="flex items-center gap-2 mb-2">
              <Target className="text-chemistry-green" size={20} />
              <span className="text-sm font-semibold text-slate-600">Overall Accuracy</span>
            </div>
            <div className="text-3xl font-black text-chemistry-green">
              {overallAccuracy}%
            </div>
          </div>

          <div className="bg-purple-50 rounded-xl p-4 border-2 border-purple-200">
            <div className="flex items-center gap-2 mb-2">
              <GraduationCap className="text-purple-600" size={20} />
              <span className="text-sm font-semibold text-slate-600">Questions Solved</span>
            </div>
            <div className="text-3xl font-black text-purple-600">
              {userProfile?.totalQuestions || 0}
            </div>
          </div>
        </div>
      </div>

      {/* Profile Form */}
      <form onSubmit={handleSave} className="bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
        <div className="bg-slate-50 p-4 border-b">
          <h2 className="text-lg font-bold text-slate-800">Account Information</h2>
        </div>

        <div className="p-6 space-y-6">
          {/* Success/Error Message */}
          {message.text && (
            <div className={`p-4 rounded-lg border-2 ${
              message.type === 'success' 
                ? 'bg-green-50 border-green-200 text-green-800' 
                : 'bg-red-50 border-red-200 text-red-800'
            }`}>
              <p className="font-semibold">{message.text}</p>
            </div>
          )}

          {/* Display Name */}
          <div>
            <label className="block text-sm font-bold text-slate-700 mb-2 flex items-center gap-2">
              <User size={16} />
              Display Name
            </label>
            <input
              type="text"
              value={displayName}
              onChange={(e) => setDisplayName(e.target.value)}
              required
              className="w-full px-4 py-3 border-2 border-slate-200 rounded-lg focus:border-lab-blue focus:ring-2 focus:ring-blue-100 outline-none transition-all"
              placeholder="Enter your name"
            />
          </div>

          {/* Email (Read-only) */}
          <div>
            <label className="block text-sm font-bold text-slate-700 mb-2 flex items-center gap-2">
              <Mail size={16} />
              Email Address
            </label>
            <input
              type="email"
              value={currentUser?.email || ''}
              disabled
              className="w-full px-4 py-3 border-2 border-slate-200 rounded-lg bg-slate-50 text-slate-500 cursor-not-allowed"
            />
            <p className="text-xs text-slate-500 mt-1">Email cannot be changed</p>
          </div>

          {/* School Level */}
          <div>
            <label className="block text-sm font-bold text-slate-700 mb-2 flex items-center gap-2">
              <GraduationCap size={16} />
              School Level (Form)
            </label>
            <div className="grid grid-cols-3 gap-3">
              {['S4', 'S5', 'S6'].map((lvl) => (
                <button
                  key={lvl}
                  type="button"
                  onClick={() => setLevel(lvl)}
                  className={`py-3 rounded-xl border-2 font-bold transition-all ${
                    level === lvl
                      ? 'border-lab-blue bg-blue-50 text-lab-blue'
                      : 'border-slate-200 text-slate-600 hover:border-slate-300'
                  }`}
                >
                  {lvl}
                </button>
              ))}
            </div>
            <p className="text-xs text-slate-500 mt-2">
              Select your current form (Secondary 4, 5, or 6)
            </p>
          </div>

          {/* LEARNED UP TO SELECTOR */}
          <div>
            <label className="block text-sm font-bold text-slate-700 mb-2 flex items-center gap-2">
              <BookOpen size={16} />
              Topics Learned Up To
            </label>
            <p className="text-xs text-slate-500 mb-3">
              Select the highest topic number you've learned. For example, "08" means you've learned topics 01-08.
            </p>
            <div className="grid grid-cols-6 md:grid-cols-8 gap-2">
              {allTopics.map((topic) => {
                const topicNum = topic.match(/^\d+/)?.[0];
                return (
                  <button
                    key={topic}
                    type="button"
                    onClick={() => setLearnedUpTo(topicNum)}
                    className={`py-2 rounded-lg border-2 font-bold transition-all text-sm ${
                      learnedUpTo === topicNum
                        ? 'border-chemistry-green bg-green-50 text-chemistry-green'
                        : 'border-slate-200 text-slate-600 hover:border-slate-300'
                    }`}
                    title={topic}
                  >
                    {topicNum}
                  </button>
                );
              })}
            </div>
          </div>

          {/* TOPIC EXCEPTIONS */}
          {learnedUpTo && learnedRangeTopics.length > 0 && (
            <div className="border-t-2 border-slate-100 pt-6">
              <label className="block text-sm font-bold text-slate-700 mb-2 flex items-center gap-2">
                <Lock size={16} />
                Topic Exceptions (Mark topics NOT learned)
              </label>
              <p className="text-xs text-slate-500 mb-3">
                Click to exclude topics you haven't covered yet, even though they're below your "learned up to" level.
              </p>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                {learnedRangeTopics.map((topic) => {
                  const isException = topicExceptions.includes(topic);
                  return (
                    <button
                      key={topic}
                      type="button"
                      onClick={() => toggleTopicException(topic)}
                      className={`flex items-center justify-between p-3 rounded-xl border-2 transition-all ${
                        isException
                          ? 'border-red-300 bg-red-50 text-red-700'
                          : 'border-green-200 bg-green-50 text-green-700'
                      }`}
                    >
                      <span className="text-sm font-semibold">{topic}</span>
                      {isException ? (
                        <Lock size={16} className="text-red-600" />
                      ) : (
                        <Unlock size={16} className="text-green-600" />
                      )}
                    </button>
                  );
                })}
              </div>
            </div>
          )}

          {/* Available Topics Preview */}
          {availableTopics.length > 0 && (
            <div className="bg-blue-50 border-2 border-blue-200 rounded-xl p-4">
              <h3 className="font-bold text-blue-900 mb-2 flex items-center gap-2">
                <BookOpen size={16} />
                Your Available Topics ({availableTopics.length})
              </h3>
              <div className="flex flex-wrap gap-2">
                {availableTopics.map((topic) => (
                  <span
                    key={topic}
                    className="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-bold"
                  >
                    {topic}
                  </span>
                ))}
              </div>
              <p className="text-xs text-blue-700 mt-2">
                These topics will appear in your Timed and Marathon practice modes.
              </p>
            </div>
          )}

          {/* Account Created Date */}
          <div>
            <label className="block text-sm font-bold text-slate-700 mb-2 flex items-center gap-2">
              <Calendar size={16} />
              Member Since
            </label>
            <div className="px-4 py-3 border-2 border-slate-200 rounded-lg bg-slate-50 text-slate-700 font-semibold">
              {formatDate(userProfile?.createdAt)}
            </div>
          </div>

          {/* Save Button */}
          <button
            type="submit"
            disabled={saving || questionsLoading}
            className="w-full py-4 bg-lab-blue text-white rounded-xl font-bold text-lg shadow-lg hover:bg-blue-800 disabled:bg-slate-300 disabled:cursor-not-allowed transition-all flex items-center justify-center gap-2 active:scale-95"
          >
            {saving ? (
              <>
                <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
                Saving...
              </>
            ) : (
              <>
                <Save size={20} />
                Save Changes
              </>
            )}
          </button>
        </div>
      </form>
    </div>
  );
}

// ========== src/pages/QuizPage.jsx ==========

import React, { useState, useEffect, useRef } from 'react';
import { useNavigate } from 'react-router-dom';
import QuestionCard from '../components/QuestionCard';
import { ChevronLeft, ChevronRight, Send, Timer, FlaskConical, Flag, Clock, X, Home, Menu } from 'lucide-react';
import { quizStorage } from '../utils/quizStorage';

export default function QuizPage() {
  const navigate = useNavigate();
  
  const questions = quizStorage.getSelectedQuestions();
  
  useEffect(() => {
    if (!questions || questions.length === 0) {
      navigate('/');
    }
  }, [questions, navigate]);

  const [currentIndex, setCurrentIndex] = useState(() => quizStorage.getCurrentIndex());
  const [answers, setAnswers] = useState(() => quizStorage.getUserAnswers());
  const [flagged, setFlagged] = useState(() => quizStorage.getFlagged());
  const [showPeriodicTable, setShowPeriodicTable] = useState(false);
  const [showQuestionPanel, setShowQuestionPanel] = useState(false);
  const [showMobileMenu, setShowMobileMenu] = useState(false);
  const [timerEnabled, setTimerEnabled] = useState(() => quizStorage.getTimerEnabled());
  const [questionTimes, setQuestionTimes] = useState(() => quizStorage.getQuestionTimes());
  const [currentQuestionStartTime, setCurrentQuestionStartTime] = useState(null);
  const [currentTime, setCurrentTime] = useState(Date.now());
  const [sessionStartTime, setSessionStartTime] = useState(() => quizStorage.getSessionStart());
  const timerInitialized = useRef(false);

  // ‚îÄ‚îÄ Prevent accidental navigation away ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  useEffect(() => {
    const handleBeforeUnload = (e) => {
      e.preventDefault();
      e.returnValue = '';
      return '';
    };
    window.addEventListener('beforeunload', handleBeforeUnload);
    return () => window.removeEventListener('beforeunload', handleBeforeUnload);
  }, []);

  // ‚îÄ‚îÄ Keyboard shortcuts: A/B/C/D to select answer, Enter to advance ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  useEffect(() => {
    const handleKeyDown = (e) => {
      // Ignore when typing in inputs/textareas or when modals are open
      const activeElement = document.activeElement;
      if (
        activeElement &&
        (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA')
      ) return;
      if (showPeriodicTable || showQuestionPanel || showMobileMenu) return;
      if (!questions || questions.length === 0) return;

      const currentQuestion = questions[currentIndex];
      const key = e.key.toUpperCase();

      // A / B / C / D ‚Üí select / deselect answer
      if (['A', 'B', 'C', 'D'].includes(key)) {
        e.preventDefault();
        const currentAnswer = answers[currentQuestion.ID];
        if (currentAnswer === key) {
          // Clicking same key deselects
          setAnswers(prev => ({ ...prev, [currentQuestion.ID]: null }));
        } else {
          setAnswers(prev => ({ ...prev, [currentQuestion.ID]: key }));
        }
        return;
      }

      // Enter ‚Üí advance (or submit on last question)
      if (e.key === 'Enter') {
        e.preventDefault();
        if (currentIndex < questions.length - 1) {
          nextQuestion();
        } else if (allAnswered) {
          handleComplete();
        }
        return;
      }

      // Arrow keys ‚Üí navigate
      if (e.key === 'ArrowRight' && currentIndex < questions.length - 1) {
        e.preventDefault();
        nextQuestion();
        return;
      }
      if (e.key === 'ArrowLeft' && currentIndex > 0) {
        e.preventDefault();
        prevQuestion();
        return;
      }

      // F ‚Üí flag/unflag
      if (key === 'F') {
        e.preventDefault();
        toggleFlag();
        return;
      }
    };

    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, [currentIndex, answers, showPeriodicTable, showQuestionPanel, showMobileMenu, questions]);

  // ‚îÄ‚îÄ Persist state to localStorage ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  useEffect(() => { quizStorage.saveCurrentIndex(currentIndex); }, [currentIndex]);
  useEffect(() => { quizStorage.saveUserAnswers(answers); }, [answers]);
  useEffect(() => { quizStorage.saveFlagged(flagged); }, [flagged]);
  useEffect(() => { quizStorage.saveQuestionTimes(questionTimes); }, [questionTimes]);
  useEffect(() => { if (timerEnabled !== null) quizStorage.saveTimerEnabled(timerEnabled); }, [timerEnabled]);
  useEffect(() => { if (sessionStartTime !== null) quizStorage.saveSessionStart(sessionStartTime); }, [sessionStartTime]);

  if (!questions || questions.length === 0) return null;

  const currentQuestion = questions[currentIndex];
  const totalQuestions = questions.length;
  const progress = ((currentIndex + 1) / totalQuestions) * 100;
  const allAnswered = questions.every(q => answers[q.ID]);

  // ‚îÄ‚îÄ Timer init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  useEffect(() => {
    if (timerEnabled === null && !timerInitialized.current) {
      timerInitialized.current = true;
      const enableTimer = window.confirm(
        "Do you want to enable the timer?\n\nThe timer will track how long you spend on each question.\n\nClick OK to enable, Cancel to skip."
      );
      setTimerEnabled(enableTimer);
      if (enableTimer) {
        const now = Date.now();
        setCurrentQuestionStartTime(now);
        setSessionStartTime(now);
      }
    }
  }, [timerEnabled]);

  useEffect(() => {
    if (!timerEnabled) return;
    const interval = setInterval(() => setCurrentTime(Date.now()), 1000);
    return () => clearInterval(interval);
  }, [timerEnabled]);

  useEffect(() => {
    if (timerEnabled && currentQuestion) setCurrentQuestionStartTime(Date.now());
  }, [currentIndex, timerEnabled]);

  const recordQuestionTime = () => {
    if (timerEnabled && currentQuestionStartTime) {
      const timeSpent = Date.now() - currentQuestionStartTime;
      setQuestionTimes(prev => ({
        ...prev,
        [currentQuestion.ID]: (prev[currentQuestion.ID] || 0) + timeSpent
      }));
    }
  };

  const handleOptionSelect = (option) => {
    setAnswers(prev => ({ ...prev, [currentQuestion.ID]: option }));
  };

  const toggleFlag = () => {
    const questionId = currentQuestion.ID;
    setFlagged(prev => {
      const newSet = new Set(prev);
      if (newSet.has(questionId)) newSet.delete(questionId);
      else newSet.add(questionId);
      return newSet;
    });
  };

  const nextQuestion = () => {
    recordQuestionTime();
    if (currentIndex < totalQuestions - 1) setCurrentIndex(currentIndex + 1);
  };

  const prevQuestion = () => {
    recordQuestionTime();
    if (currentIndex > 0) setCurrentIndex(currentIndex - 1);
  };

  const jumpToQuestion = (index) => {
    recordQuestionTime();
    setCurrentIndex(index);
    setShowQuestionPanel(false);
  };

  const handleBackToTopics = () => {
    const confirmed = window.confirm(
      "Are you sure you want to go back to topic selection?\n\n‚ö†Ô∏è ALL YOUR PROGRESS WILL BE LOST!"
    );
    if (confirmed) {
      quizStorage.clearQuizData();
      navigate('/');
    }
  };

  const handleComplete = () => {
    recordQuestionTime();
    quizStorage.saveUserAnswers(answers);
    quizStorage.saveQuestionTimes(questionTimes);
    navigate('/results');
  };

  const isLastQuestion = currentIndex === totalQuestions - 1;

  const getTotalTimeSpent = () => {
    const accumulated = Object.values(questionTimes).reduce((sum, t) => sum + t, 0);
    if (timerEnabled && currentQuestionStartTime) {
      return accumulated + (currentTime - currentQuestionStartTime);
    }
    return accumulated;
  };

  const getSessionTime = () => {
    if (timerEnabled && sessionStartTime) return currentTime - sessionStartTime;
    return 0;
  };

  const formatTime = (ms) => {
    const seconds = Math.floor(ms / 1000);
    const minutes = Math.floor(seconds / 60);
    const hrs = Math.floor(minutes / 60);
    if (hrs > 0) return `${hrs}:${String(minutes % 60).padStart(2, '0')}:${String(seconds % 60).padStart(2, '0')}`;
    return `${minutes}:${String(seconds % 60).padStart(2, '0')}`;
  };

  const getQuestionStatus = (q) => {
    if (answers[q.ID]) return 'answered';
    if (flagged.has(q.ID)) return 'flagged';
    return 'skipped';
  };

  if (timerEnabled === null) {
    return (
      <div className="flex h-screen items-center justify-center">
        <div className="text-center">
          <Clock className="animate-pulse text-lab-blue w-12 h-12 mx-auto mb-4" />
          <p className="text-slate-600">Initializing quiz...</p>
        </div>
      </div>
    );
  }

  const totalTimeSpent = getTotalTimeSpent();
  const sessionTime = getSessionTime();

  return (
    <div className="relative min-h-screen pb-32 md:pb-6">
      {/* ‚îÄ‚îÄ Keyboard shortcut hint (desktop only) ‚îÄ‚îÄ */}
      <div className="hidden md:flex fixed top-20 left-1/2 -translate-x-1/2 z-20 items-center gap-3 bg-white/90 backdrop-blur border border-slate-200 rounded-full px-4 py-1.5 shadow-sm text-xs text-slate-500">
        <span>Type <kbd className="px-1.5 py-0.5 bg-slate-100 border border-slate-300 rounded font-mono font-bold text-slate-700">A</kbd> <kbd className="px-1.5 py-0.5 bg-slate-100 border border-slate-300 rounded font-mono font-bold text-slate-700">B</kbd> <kbd className="px-1.5 py-0.5 bg-slate-100 border border-slate-300 rounded font-mono font-bold text-slate-700">C</kbd> <kbd className="px-1.5 py-0.5 bg-slate-100 border border-slate-300 rounded font-mono font-bold text-slate-700">D</kbd> to select</span>
        <span className="text-slate-300">|</span>
        <span><kbd className="px-1.5 py-0.5 bg-slate-100 border border-slate-300 rounded font-mono font-bold text-slate-700">Enter</kbd> / <kbd className="px-1.5 py-0.5 bg-slate-100 border border-slate-300 rounded font-mono font-bold text-slate-700">‚Üí</kbd> next</span>
        <span className="text-slate-300">|</span>
        <span><kbd className="px-1.5 py-0.5 bg-slate-100 border border-slate-300 rounded font-mono font-bold text-slate-700">F</kbd> flag</span>
      </div>

      {/* ‚îÄ‚îÄ Mobile Tools ‚îÄ‚îÄ */}
      <button
        onClick={() => setShowMobileMenu(!showMobileMenu)}
        className="md:hidden fixed top-20 right-4 z-40 flex items-center gap-2 px-4 py-2 bg-lab-blue text-white rounded-lg font-bold shadow-lg"
      >
        <Menu size={18} />Tools
      </button>

      {showMobileMenu && (
        <>
          <div className="md:hidden fixed inset-0 bg-black bg-opacity-25 z-40" onClick={() => setShowMobileMenu(false)} />
          <div className="md:hidden fixed top-32 right-4 bg-white rounded-xl shadow-2xl border-2 border-slate-200 z-50 overflow-hidden min-w-[200px]">
            <button onClick={() => { handleBackToTopics(); setShowMobileMenu(false); }}
              className="w-full flex items-center gap-2 px-4 py-3 hover:bg-slate-50 transition-all text-left border-b">
              <Home size={18} className="text-red-500" />
              <span className="font-semibold text-red-600">Back to Topics</span>
            </button>
            <button onClick={() => { setShowPeriodicTable(true); setShowMobileMenu(false); }}
              className="w-full flex items-center gap-2 px-4 py-3 hover:bg-slate-50 transition-all text-left border-b">
              <FlaskConical size={18} className="text-purple-600" />
              <span className="font-semibold text-slate-700">Periodic Table</span>
            </button>
            <button onClick={() => { setShowQuestionPanel(true); setShowMobileMenu(false); }}
              className="w-full flex items-center gap-2 px-4 py-3 hover:bg-slate-50 transition-all text-left border-b">
              <Flag size={18} className="text-slate-700" />
              <span className="font-semibold text-slate-700">Overview</span>
            </button>
            <button onClick={() => { toggleFlag(); setShowMobileMenu(false); }}
              className={`w-full flex items-center gap-2 px-4 py-3 hover:bg-slate-50 transition-all text-left ${flagged.has(currentQuestion?.ID) ? 'bg-amber-50' : ''}`}>
              <Flag size={18} className="text-amber-500" fill={flagged.has(currentQuestion?.ID) ? 'currentColor' : 'none'} />
              <span className="font-semibold text-slate-700">{flagged.has(currentQuestion?.ID) ? 'Unflag' : 'Flag'} Question</span>
            </button>
          </div>
        </>
      )}

      {/* ‚îÄ‚îÄ Desktop Back Button ‚îÄ‚îÄ */}
      <button onClick={handleBackToTopics}
        className="hidden md:flex fixed left-8 top-24 z-30 items-center gap-2 px-4 py-2 bg-red-500 text-white rounded-lg font-bold hover:bg-red-600 transition-all shadow-lg hover:scale-105 active:scale-95">
        <Home size={18} /><span>Back to Topics</span>
      </button>

      {/* ‚îÄ‚îÄ Desktop Left Sidebar ‚îÄ‚îÄ */}
      <div className="hidden md:flex fixed left-8 top-40 flex-col gap-4 z-30 h-[calc(100vh-12rem)]">
        {timerEnabled && (
          <div className="bg-white rounded-2xl shadow-xl border-2 border-lab-blue p-6 w-48">
            <div className="text-center">
              <div className="flex items-center justify-center gap-2 mb-2">
                <Timer className="text-lab-blue" size={24} />
                <span className="text-sm font-bold text-slate-600">SESSION TIME</span>
              </div>
              <div className="text-4xl font-black text-lab-blue mb-4 font-mono">{formatTime(sessionTime)}</div>
              <div className="text-xs text-slate-500 border-t pt-2">
                <div className="flex justify-between mb-1">
                  <span>Active Time:</span>
                  <span className="font-bold">{formatTime(totalTimeSpent)}</span>
                </div>
              </div>
            </div>
          </div>
        )}
        <button onClick={() => setShowPeriodicTable(true)}
          className="flex items-center gap-2 px-6 py-4 bg-purple-600 text-white rounded-xl font-bold hover:bg-purple-700 transition-all shadow-lg hover:scale-105 active:scale-95">
          <FlaskConical size={20} /><span>Periodic Table</span>
        </button>
        <button onClick={() => setShowQuestionPanel(!showQuestionPanel)}
          className="flex items-center gap-2 px-6 py-4 bg-slate-700 text-white rounded-xl font-bold hover:bg-slate-800 transition-all shadow-lg hover:scale-105 active:scale-95">
          <Flag size={20} /><span>Overview</span>
        </button>
        <div className="flex-1" />
        <button onClick={prevQuestion} disabled={currentIndex === 0}
          className="flex items-center justify-center w-16 h-16 bg-lab-blue text-white rounded-full font-bold hover:bg-blue-800 disabled:bg-slate-300 disabled:cursor-not-allowed transition-all shadow-lg hover:scale-110 active:scale-95">
          <ChevronLeft size={32} />
        </button>
      </div>

      {/* ‚îÄ‚îÄ Desktop Right Sidebar ‚îÄ‚îÄ */}
      <div className="hidden md:flex fixed right-8 top-40 flex-col gap-4 z-30 h-[calc(100vh-12rem)]">
        <button onClick={toggleFlag}
          className={`w-16 h-16 rounded-full flex items-center justify-center transition-all shadow-lg hover:scale-110 active:scale-95 ${flagged.has(currentQuestion?.ID) ? 'bg-amber-500 text-white hover:bg-amber-600' : 'bg-white text-amber-500 border-2 border-amber-500 hover:bg-amber-50'}`}
          title={flagged.has(currentQuestion?.ID) ? 'Unflag Question' : 'Flag Question'}>
          <Flag size={28} fill={flagged.has(currentQuestion?.ID) ? 'currentColor' : 'none'} />
        </button>
        <div className="flex-1" />
        {!isLastQuestion ? (
          <button onClick={nextQuestion}
            className="flex items-center justify-center w-16 h-16 bg-lab-blue text-white rounded-full font-bold hover:bg-blue-800 transition-all shadow-lg hover:scale-110 active:scale-95">
            <ChevronRight size={32} />
          </button>
        ) : (
          <button onClick={handleComplete} disabled={!allAnswered}
            className={`flex items-center justify-center w-16 h-16 rounded-full font-bold transition-all shadow-lg hover:scale-110 active:scale-95 ${allAnswered ? 'bg-chemistry-green text-white hover:opacity-90' : 'bg-slate-300 text-slate-500 cursor-not-allowed'}`}
            title="Finish & Submit">
            <Send size={28} />
          </button>
        )}
      </div>

      {/* ‚îÄ‚îÄ Question Overview Panel ‚îÄ‚îÄ */}
      {showQuestionPanel && (
        <>
          <div className="fixed inset-0 z-40 bg-black bg-opacity-15" onClick={() => setShowQuestionPanel(false)} />
          <div className="fixed left-0 top-0 h-full w-80 max-w-[90vw] bg-white shadow-2xl z-50 overflow-y-auto animate-in slide-in-from-left duration-300">
            <div className="sticky top-0 bg-white border-b p-6 flex justify-between items-center">
              <h3 className="text-lg font-bold text-slate-800">Question Overview</h3>
              <button onClick={() => setShowQuestionPanel(false)} className="text-slate-400 hover:text-slate-600 p-2 rounded-full hover:bg-slate-100">
                <X size={20} />
              </button>
            </div>
            <div className="p-6">
              <div className="flex flex-col gap-3 mb-6 text-sm">
                <div className="flex items-center gap-2"><div className="w-6 h-6 rounded bg-chemistry-green" /><span>Answered ({Object.keys(answers).filter(k => answers[k]).length})</span></div>
                <div className="flex items-center gap-2"><div className="w-6 h-6 rounded bg-amber-500" /><span>Flagged ({flagged.size})</span></div>
                <div className="flex items-center gap-2"><div className="w-6 h-6 rounded bg-slate-200" /><span>Skipped ({totalQuestions - Object.keys(answers).filter(k => answers[k]).length})</span></div>
              </div>
              <div className="grid grid-cols-4 gap-3">
                {questions.map((q, idx) => {
                  const status = getQuestionStatus(q);
                  return (
                    <button key={q.ID} onClick={() => jumpToQuestion(idx)}
                      className={`aspect-square rounded-xl font-bold text-base transition-all border-2 ${idx === currentIndex ? 'border-lab-blue ring-2 ring-lab-blue ring-offset-2' : 'border-transparent'} ${status === 'answered' ? 'bg-chemistry-green text-white hover:opacity-80' : status === 'flagged' ? 'bg-amber-500 text-white hover:opacity-80' : 'bg-slate-200 text-slate-600 hover:bg-slate-300'}`}>
                      {idx + 1}
                    </button>
                  );
                })}
              </div>
            </div>
          </div>
        </>
      )}

      {/* ‚îÄ‚îÄ Periodic Table Modal ‚îÄ‚îÄ */}
      {showPeriodicTable && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowPeriodicTable(false)}>
          <div className="bg-white rounded-2xl shadow-2xl max-w-6xl w-full max-h-[90vh] overflow-auto" onClick={e => e.stopPropagation()}>
            <div className="sticky top-0 bg-white border-b p-4 flex justify-between items-center">
              <h3 className="text-xl font-bold text-slate-800">Periodic Table of Elements</h3>
              <button onClick={() => setShowPeriodicTable(false)} className="text-slate-400 hover:text-slate-600 p-2 rounded-full hover:bg-slate-100"><X size={24} /></button>
            </div>
            <div className="p-4">
              <img src="https://upload.wikimedia.org/wikipedia/commons/2/2e/Simple_Periodic_Table_Chart-en.svg" alt="Periodic Table" className="w-full h-auto" />
            </div>
          </div>
        </div>
      )}

      {/* ‚îÄ‚îÄ Main Content ‚îÄ‚îÄ */}
      <div className="max-w-5xl mx-auto px-4 pt-6 pb-6">
        <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 mb-4">
          <div className="flex justify-between items-center mb-2">
            <div className="flex items-baseline gap-3">
              <span className="text-3xl font-black text-lab-blue">Q{currentIndex + 1}</span>
              <span className="text-sm font-medium text-slate-500">of {totalQuestions}</span>
            </div>
            <span className="text-xl font-bold text-lab-blue">{Math.round(progress)}%</span>
          </div>
          <div className="w-full bg-slate-100 h-2 rounded-full overflow-hidden">
            <div className="bg-lab-blue h-full transition-all duration-300" style={{ width: `${progress}%` }} />
          </div>
        </div>

        {timerEnabled && (
          <div className="md:hidden bg-white p-3 rounded-lg shadow-sm border border-slate-200 mb-4">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-2"><Timer className="text-lab-blue" size={18} /><span className="text-sm font-bold text-slate-600">Time</span></div>
              <div className="text-xl font-black text-lab-blue font-mono">{formatTime(sessionTime)}</div>
            </div>
          </div>
        )}

        <div className="mb-4">
          <QuestionCard
            question={currentQuestion}
            selectedOption={answers[currentQuestion.ID]}
            onSelect={handleOptionSelect}
          />
        </div>

        <div className="flex justify-center gap-1 py-2">
          {questions.slice(0, Math.min(30, totalQuestions)).map((_, idx) => (
            <div key={idx} className={`w-2 h-2 rounded-full transition-all ${idx === currentIndex ? 'bg-lab-blue w-6' : answers[questions[idx].ID] ? 'bg-chemistry-green' : flagged.has(questions[idx].ID) ? 'bg-amber-500' : 'bg-slate-200'}`} />
          ))}
          {totalQuestions > 30 && <span className="text-slate-400 text-xs">...</span>}
        </div>

        <div className="text-center text-sm mt-2 space-y-1">
          <p className="text-slate-500 hidden md:block">
            üí° <span className="font-semibold">Tip:</span> Press <kbd className="px-2 py-1 bg-slate-100 border border-slate-300 rounded text-xs font-mono">A</kbd>‚Äì<kbd className="px-2 py-1 bg-slate-100 border border-slate-300 rounded text-xs font-mono">D</kbd> to select ¬∑ <kbd className="px-2 py-1 bg-slate-100 border border-slate-300 rounded text-xs font-mono">Enter</kbd> / <kbd className="px-2 py-1 bg-slate-100 border border-slate-300 rounded text-xs font-mono">‚Üí</kbd> next ¬∑ <kbd className="px-2 py-1 bg-slate-100 border border-slate-300 rounded text-xs font-mono">F</kbd> flag
          </p>
          {!allAnswered && isLastQuestion && (
            <p className="text-amber-600 font-medium">Please answer all questions before submitting.</p>
          )}
        </div>
      </div>

      {/* ‚îÄ‚îÄ Mobile Nav Bar ‚îÄ‚îÄ */}
      <div className="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t-2 border-slate-200 shadow-2xl z-30">
        <div className="grid grid-cols-3 gap-2 p-3">
          <button onClick={prevQuestion} disabled={currentIndex === 0}
            className="flex flex-col items-center justify-center py-3 px-2 bg-slate-100 rounded-lg font-bold disabled:opacity-50 disabled:cursor-not-allowed transition-all active:scale-95">
            <ChevronLeft size={24} className={currentIndex === 0 ? 'text-slate-400' : 'text-lab-blue'} />
            <span className={`text-xs mt-1 ${currentIndex === 0 ? 'text-slate-400' : 'text-lab-blue'}`}>Previous</span>
          </button>
          <div className="flex flex-col items-center justify-center py-3 px-2 bg-slate-100 rounded-lg">
            <div className="text-2xl font-black text-lab-blue">{currentIndex + 1}/{totalQuestions}</div>
            <div className="text-xs text-slate-500 mt-1">Question</div>
          </div>
          {!isLastQuestion ? (
            <button onClick={nextQuestion}
              className="flex flex-col items-center justify-center py-3 px-2 bg-lab-blue rounded-lg font-bold transition-all active:scale-95">
              <ChevronRight size={24} className="text-white" />
              <span className="text-xs text-white mt-1">Next</span>
            </button>
          ) : (
            <button onClick={handleComplete} disabled={!allAnswered}
              className={`flex flex-col items-center justify-center py-3 px-2 rounded-lg font-bold transition-all active:scale-95 ${allAnswered ? 'bg-chemistry-green' : 'bg-slate-300 cursor-not-allowed'}`}>
              <Send size={24} className="text-white" />
              <span className="text-xs text-white mt-1">Submit</span>
            </button>
          )}
        </div>
      </div>
    </div>
  );
}

// ========== src/pages/RegisterPage.jsx ==========

import React, { useState } from 'react';
import { useNavigate, Link } from 'react-router-dom';
import { useAuth } from '../contexts/AuthContext';
import { Beaker, Mail, Lock, User, UserPlus, AlertCircle } from 'lucide-react';

export default function RegisterPage() {
  const [displayName, setDisplayName] = useState('');
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [confirmPassword, setConfirmPassword] = useState('');
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);
  const { signup } = useAuth();
  const navigate = useNavigate();

  async function handleSubmit(e) {
    e.preventDefault();

    // Validation
    if (password !== confirmPassword) {
      return setError('Passwords do not match');
    }

    if (password.length < 6) {
      return setError('Password must be at least 6 characters');
    }

    if (displayName.trim().length < 2) {
      return setError('Please enter your full name');
    }

    try {
      setError('');
      setLoading(true);
      await signup(email, password, displayName);
      navigate('/');
    } catch (err) {
      console.error(err);
      if (err.code === 'auth/email-already-in-use') {
        setError('An account with this email already exists.');
      } else if (err.code === 'auth/invalid-email') {
        setError('Invalid email address.');
      } else if (err.code === 'auth/weak-password') {
        setError('Password is too weak. Use at least 6 characters.');
      } else {
        setError('Failed to create account. Please try again.');
      }
    }
    setLoading(false);
  }

  return (
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-slate-100 p-4">
      <div className="max-w-md w-full">
        {/* Logo Header */}
        <div className="text-center mb-8">
          <div className="flex justify-center mb-4">
            <div className="bg-chemistry-green p-4 rounded-2xl shadow-lg">
              <Beaker className="text-white" size={48} />
            </div>
          </div>
          <h1 className="text-3xl font-black text-lab-blue mb-2">
            Chemistry HKDSE MCQ
          </h1>
          <p className="text-slate-600">Create your account to get started</p>
        </div>

        {/* Register Form */}
        <div className="bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
          <div className="bg-chemistry-green p-6 text-center">
            <h2 className="text-2xl font-bold text-white flex items-center justify-center gap-2">
              <UserPlus size={24} />
              Register
            </h2>
          </div>

          <form onSubmit={handleSubmit} className="p-8 space-y-6">
            {error && (
              <div className="bg-red-50 border-2 border-red-200 rounded-lg p-4 flex items-start gap-3">
                <AlertCircle className="text-red-500 flex-shrink-0 mt-0.5" size={20} />
                <p className="text-red-700 text-sm font-medium">{error}</p>
              </div>
            )}

            {/* Display Name Field */}
            <div>
              <label className="block text-sm font-bold text-slate-700 mb-2">
                Full Name
              </label>
              <div className="relative">
                <User className="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400" size={20} />
                <input
                  type="text"
                  value={displayName}
                  onChange={(e) => setDisplayName(e.target.value)}
                  required
                  className="w-full pl-11 pr-4 py-3 border-2 border-slate-200 rounded-lg focus:border-chemistry-green focus:ring-2 focus:ring-green-100 outline-none transition-all"
                  placeholder="John Doe"
                />
              </div>
            </div>

            {/* Email Field */}
            <div>
              <label className="block text-sm font-bold text-slate-700 mb-2">
                Email Address
              </label>
              <div className="relative">
                <Mail className="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400" size={20} />
                <input
                  type="email"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  required
                  className="w-full pl-11 pr-4 py-3 border-2 border-slate-200 rounded-lg focus:border-chemistry-green focus:ring-2 focus:ring-green-100 outline-none transition-all"
                  placeholder="your.email@example.com"
                />
              </div>
            </div>

            {/* Password Field */}
            <div>
              <label className="block text-sm font-bold text-slate-700 mb-2">
                Password
              </label>
              <div className="relative">
                <Lock className="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400" size={20} />
                <input
                  type="password"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  required
                  className="w-full pl-11 pr-4 py-3 border-2 border-slate-200 rounded-lg focus:border-chemistry-green focus:ring-2 focus:ring-green-100 outline-none transition-all"
                  placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                />
              </div>
              <p className="text-xs text-slate-500 mt-1">Minimum 6 characters</p>
            </div>

            {/* Confirm Password Field */}
            <div>
              <label className="block text-sm font-bold text-slate-700 mb-2">
                Confirm Password
              </label>
              <div className="relative">
                <Lock className="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400" size={20} />
                <input
                  type="password"
                  value={confirmPassword}
                  onChange={(e) => setConfirmPassword(e.target.value)}
                  required
                  className="w-full pl-11 pr-4 py-3 border-2 border-slate-200 rounded-lg focus:border-chemistry-green focus:ring-2 focus:ring-green-100 outline-none transition-all"
                  placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                />
              </div>
            </div>

            {/* Submit Button */}
            <button
              type="submit"
              disabled={loading}
              className="w-full py-4 bg-chemistry-green text-white rounded-xl font-bold text-lg shadow-lg hover:opacity-90 disabled:bg-slate-300 disabled:cursor-not-allowed transition-all flex items-center justify-center gap-2 active:scale-95"
            >
              {loading ? (
                <>
                  <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
                  Creating account...
                </>
              ) : (
                <>
                  <UserPlus size={20} />
                  Create Account
                </>
              )}
            </button>
          </form>

          {/* Login Link */}
          <div className="bg-slate-50 px-8 py-6 border-t border-slate-200 text-center">
            <p className="text-slate-600">
              Already have an account?{' '}
              <Link 
                to="/login" 
                className="text-lab-blue font-bold hover:underline"
              >
                Login here
              </Link>
            </p>
          </div>
        </div>
      </div>
    </div>
  );
}

// ========== src/pages/ResultsPage_Updated_Fixed.jsx ==========

import React, { useEffect, useState, useRef } from 'react';
import { useNavigate } from 'react-router-dom';
import { useAuth } from '../contexts/AuthContext';
import ResultsSummary from '../components/ResultsSummary';
import { quizStorage } from '../utils/quizStorage';
import { quizService } from '../services/quizService';

export default function ResultsPage() {
  const navigate = useNavigate();
  const { currentUser } = useAuth();
  const [saving, setSaving] = useState(false);
  const [saved, setSaved] = useState(false);
  // FIX 1: Use a ref to prevent double-save across renders/StrictMode
  const hasSavedRef = useRef(false);

  // Load data from storage
  const questions = quizStorage.getSelectedQuestions();
  const userAnswers = quizStorage.getUserAnswers();
  const questionTimes = quizStorage.getQuestionTimes();

  // Redirect if no data
  useEffect(() => {
    if (!questions || questions.length === 0 || Object.keys(userAnswers).length === 0) {
      navigate('/');
    }
  }, []); // eslint-disable-line react-hooks/exhaustive-deps

  // Save attempt to Firebase - only once, guarded by ref
  useEffect(() => {
    async function saveAttemptToFirebase() {
      // Guard: skip if already saved, saving, no user, no data, or ref already fired
      if (hasSavedRef.current) return;
      if (!currentUser || !questions || questions.length === 0) return;
      if (Object.keys(userAnswers).length === 0) return;

      // Set ref immediately to block any concurrent calls
      hasSavedRef.current = true;
      setSaving(true);

      try {
        const totalQuestions = questions.length;
        const correctAnswers = questions.reduce((acc, q) => {
          return acc + (userAnswers[q.ID] === q.CorrectOption ? 1 : 0);
        }, 0);
        const percentage = Math.round((correctAnswers / totalQuestions) * 100);
        const topics = [...new Set(questions.map(q => q.Topic))].filter(Boolean);
        const timeSpent = questionTimes
          ? Object.values(questionTimes).reduce((sum, time) => sum + time, 0)
          : null;

        const attemptData = {
          score: percentage,
          totalQuestions,
          correctAnswers,
          percentage,
          topics,
          timeSpent,
          questionTimes,
          answers: userAnswers,
          questions, // For Mistake Notebook
        };

        await quizService.saveAttempt(currentUser.uid, attemptData);
        setSaved(true);
        console.log('‚úÖ Attempt saved (once).');
      } catch (error) {
        console.error('‚ùå Error saving attempt:', error);
        // Reset ref so user can potentially retry, but don't loop
        hasSavedRef.current = false;
      } finally {
        setSaving(false);
      }
    }

    saveAttemptToFirebase();
  }, [currentUser]); // Only depends on currentUser; questions/answers come from storage

  if (!questions || questions.length === 0) return null;

  const handleRestart = () => {
    quizStorage.clearQuizData();
    navigate('/');
  };

  return (
    <div className="relative">
      {saving && (
        <div className="fixed top-20 right-4 bg-blue-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 flex items-center gap-2">
          <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
          <span className="font-semibold">Saving to your profile...</span>
        </div>
      )}
      {saved && (
        <div className="fixed top-20 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 flex items-center gap-2">
          <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
          </svg>
          <span className="font-semibold">Saved to your profile!</span>
        </div>
      )}
      <ResultsSummary
        questions={questions}
        userAnswers={userAnswers}
        questionTimes={questionTimes}
        onRestart={handleRestart}
      />
    </div>
  );
}

// ========== src/pages/TopicSelectionPage_Updated.jsx ==========

import React from 'react';
import { useNavigate } from 'react-router-dom';
import FilterScreen from '../components/FilterScreen';
import { quizStorage } from '../utils/quizStorage';

export default function TopicSelectionPage({ questions }) {
  const navigate = useNavigate();

  const handleStart = (selectedQuestions) => {
    // Clear any previous quiz data
    quizStorage.clearQuizData();
    
    // Save selected questions
    quizStorage.saveSelectedQuestions(selectedQuestions);
    
    // Navigate to quiz page
    navigate('/quiz');
  };

  return <FilterScreen questions={questions} onStart={handleStart} />;
}

// ========== src/services/forumService.js ==========

import { 
  collection, addDoc, updateDoc, deleteDoc, doc, query,
  where, orderBy, getDocs, getDoc, increment, onSnapshot
} from 'firebase/firestore';
import { db } from '../firebase/config';

// ‚îÄ‚îÄ Constants ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
export const EDIT_WINDOW_MS = 15 * 60 * 1000; // 15 minutes

export const canEditComment = (createdAt) => {
  const ageMs = Date.now() - new Date(createdAt).getTime();
  return ageMs <= EDIT_WINDOW_MS;
};

export const editTimeRemaining = (createdAt) => {
  const ageMs = Date.now() - new Date(createdAt).getTime();
  const remaining = EDIT_WINDOW_MS - ageMs;
  if (remaining <= 0) return null;
  const mins = Math.floor(remaining / 60000);
  const secs = Math.floor((remaining % 60000) / 1000);
  return `${mins}:${String(secs).padStart(2, '0')}`;
};

export const forumService = {
  // ‚îÄ‚îÄ MCQ Comments ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async addComment(questionId, userId, userDisplayName, commentText) {
    try {
      if (!questionId || !userId || !commentText) throw new Error('Missing required fields');
      const commentData = {
        questionId: String(questionId),
        userId: String(userId),
        userDisplayName: userDisplayName || 'Anonymous',
        text: commentText.trim(),
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString(),
        edited: false,
        likes: 0,
        likedBy: []
      };
      const ref = await addDoc(collection(db, 'comments'), commentData);
      return ref.id;
    } catch (error) {
      if (error.code === 'permission-denied') throw new Error('Permission denied. Please check Firebase rules.');
      throw new Error(`Failed to add comment: ${error.message}`);
    }
  },

  async getQuestionComments(questionId) {
    try {
      const q = query(
        collection(db, 'comments'),
        where('questionId', '==', String(questionId)),
        orderBy('createdAt', 'desc')
      );
      const snapshot = await getDocs(q);
      return snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
    } catch (error) {
      if (error.code === 'failed-precondition') return [];
      throw error;
    }
  },

  // Edit only allowed within 15 minutes
  async updateComment(commentId, newText) {
    try {
      const ref = doc(db, 'comments', commentId);
      const snap = await getDoc(ref);
      if (!snap.exists()) throw new Error('Comment not found');
      if (!canEditComment(snap.data().createdAt)) {
        throw new Error('EDIT_EXPIRED');
      }
      await updateDoc(ref, {
        text: newText.trim(),
        updatedAt: new Date().toISOString(),
        edited: true
      });
    } catch (error) {
      if (error.message === 'EDIT_EXPIRED') throw error;
      if (error.code === 'permission-denied') throw new Error('You can only edit your own comments.');
      throw error;
    }
  },

  async deleteComment(commentId) {
    try {
      await deleteDoc(doc(db, 'comments', commentId));
    } catch (error) {
      if (error.code === 'permission-denied') throw new Error('You can only delete your own comments.');
      throw error;
    }
  },

  async toggleLike(commentId, userId) {
    try {
      const ref = doc(db, 'comments', commentId);
      const snap = await getDoc(ref);
      if (!snap.exists()) throw new Error('Comment not found');
      const data = snap.data();
      const likedBy = data.likedBy || [];
      const hasLiked = likedBy.includes(userId);
      
      if (hasLiked) {
        await updateDoc(ref, { likes: increment(-1), likedBy: likedBy.filter(id => id !== userId) });
      } else {
        await updateDoc(ref, { likes: increment(1), likedBy: [...likedBy, userId] });
        // Create notification for comment author
        if (data.userId && data.userId !== userId) {
          await forumService.createNotification({
            recipientId: data.userId,
            senderId: userId,
            type: 'like',
            commentId,
            questionId: data.questionId,
            postId: data.postId || null,
            previewText: data.text?.substring(0, 80) || '',
          });
        }
      }
    } catch (error) {
      throw error;
    }
  },

  async getQuestionsWithComments() {
    try {
      const snapshot = await getDocs(collection(db, 'comments'));
      const map = new Map();
      snapshot.forEach(d => {
        const data = d.data();
        if (!data.questionId) return;
        if (!map.has(data.questionId)) {
          map.set(data.questionId, { questionId: data.questionId, commentCount: 1, lastActivity: data.createdAt });
        } else {
          const ex = map.get(data.questionId);
          ex.commentCount++;
          if (data.createdAt > ex.lastActivity) ex.lastActivity = data.createdAt;
        }
      });
      return Array.from(map.values()).sort((a, b) => new Date(b.lastActivity) - new Date(a.lastActivity));
    } catch (error) {
      throw error;
    }
  },

  // ‚îÄ‚îÄ General Forum Posts ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async createPost(userId, userDisplayName, { title, content, category = 'general' }) {
    if (!userId || !title?.trim() || !content?.trim()) throw new Error('Missing required fields');
    const data = {
      userId, userDisplayName: userDisplayName || 'Anonymous',
      title: title.trim(), content: content.trim(),
      category, // 'general' | 'question' | 'announcement'
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString(),
      edited: false, replyCount: 0, likes: 0, likedBy: [], pinned: false
    };
    const ref = await addDoc(collection(db, 'forum_posts'), data);
    return ref.id;
  },

  async getPosts({ category = null, limit: lim = 30 } = {}) {
    try {
      let q;
      if (category) {
        q = query(collection(db, 'forum_posts'), where('category', '==', category), orderBy('createdAt', 'desc'));
      } else {
        q = query(collection(db, 'forum_posts'), orderBy('createdAt', 'desc'));
      }
      const snapshot = await getDocs(q);
      const posts = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
      return posts.slice(0, lim);
    } catch (error) {
      if (error.code === 'failed-precondition') {
        const snapshot = await getDocs(collection(db, 'forum_posts'));
        return snapshot.docs.map(d => ({ id: d.id, ...d.data() }))
          .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
          .slice(0, lim);
      }
      throw error;
    }
  },

  async getPost(postId) {
    const snap = await getDoc(doc(db, 'forum_posts', postId));
    if (!snap.exists()) throw new Error('Post not found');
    return { id: snap.id, ...snap.data() };
  },

  async updatePost(postId, userId, newContent, newTitle = null) {
    const ref = doc(db, 'forum_posts', postId);
    const snap = await getDoc(ref);
    if (!snap.exists()) throw new Error('Post not found');
    if (!canEditComment(snap.data().createdAt)) throw new Error('EDIT_EXPIRED');
    const updates = { content: newContent.trim(), updatedAt: new Date().toISOString(), edited: true };
    if (newTitle) updates.title = newTitle.trim();
    await updateDoc(ref, updates);
  },

  async deletePost(postId) {
    await deleteDoc(doc(db, 'forum_posts', postId));
  },

  async togglePostLike(postId, userId) {
    const ref = doc(db, 'forum_posts', postId);
    const snap = await getDoc(ref);
    if (!snap.exists()) throw new Error('Post not found');
    const data = snap.data();
    const likedBy = data.likedBy || [];
    const hasLiked = likedBy.includes(userId);
    if (hasLiked) {
      await updateDoc(ref, { likes: increment(-1), likedBy: likedBy.filter(id => id !== userId) });
    } else {
      await updateDoc(ref, { likes: increment(1), likedBy: [...likedBy, userId] });
      if (data.userId && data.userId !== userId) {
        await forumService.createNotification({
          recipientId: data.userId, senderId: userId,
          type: 'post_like', postId,
          previewText: data.title?.substring(0, 80) || '',
        });
      }
    }
  },

  // ‚îÄ‚îÄ Post Replies ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async addReply(postId, userId, userDisplayName, text) {
    if (!postId || !userId || !text?.trim()) throw new Error('Missing required fields');
    const data = {
      postId, userId, userDisplayName: userDisplayName || 'Anonymous',
      text: text.trim(), createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString(), edited: false, likes: 0, likedBy: []
    };
    const ref = await addDoc(collection(db, 'forum_replies'), data);
    // Increment reply count on post
    await updateDoc(doc(db, 'forum_posts', postId), { replyCount: increment(1) });
    // Notify post author
    const postSnap = await getDoc(doc(db, 'forum_posts', postId));
    if (postSnap.exists() && postSnap.data().userId !== userId) {
      await forumService.createNotification({
        recipientId: postSnap.data().userId, senderId: userId,
        type: 'reply', postId,
        previewText: text.substring(0, 80),
        postTitle: postSnap.data().title?.substring(0, 60) || '',
      });
    }
    return ref.id;
  },

  async getReplies(postId) {
    try {
      const q = query(
        collection(db, 'forum_replies'),
        where('postId', '==', postId),
        orderBy('createdAt', 'asc')
      );
      const snapshot = await getDocs(q);
      return snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
    } catch (error) {
      if (error.code === 'failed-precondition') {
        const snapshot = await getDocs(collection(db, 'forum_replies'));
        return snapshot.docs
          .map(d => ({ id: d.id, ...d.data() }))
          .filter(r => r.postId === postId)
          .sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
      }
      throw error;
    }
  },

  async updateReply(replyId, newText) {
    const ref = doc(db, 'forum_replies', replyId);
    const snap = await getDoc(ref);
    if (!snap.exists()) throw new Error('Reply not found');
    if (!canEditComment(snap.data().createdAt)) throw new Error('EDIT_EXPIRED');
    await updateDoc(ref, { text: newText.trim(), updatedAt: new Date().toISOString(), edited: true });
  },

  async deleteReply(replyId) {
    const snap = await getDoc(doc(db, 'forum_replies', replyId));
    if (snap.exists()) {
      const postId = snap.data().postId;
      await deleteDoc(doc(db, 'forum_replies', replyId));
      await updateDoc(doc(db, 'forum_posts', postId), { replyCount: increment(-1) });
    }
  },

  async toggleReplyLike(replyId, userId) {
    const ref = doc(db, 'forum_replies', replyId);
    const snap = await getDoc(ref);
    if (!snap.exists()) throw new Error('Reply not found');
    const data = snap.data();
    const likedBy = data.likedBy || [];
    const hasLiked = likedBy.includes(userId);
    if (hasLiked) {
      await updateDoc(ref, { likes: increment(-1), likedBy: likedBy.filter(id => id !== userId) });
    } else {
      await updateDoc(ref, { likes: increment(1), likedBy: [...likedBy, userId] });
      if (data.userId && data.userId !== userId) {
        await forumService.createNotification({
          recipientId: data.userId, senderId: userId,
          type: 'reply_like', replyId, postId: data.postId,
          previewText: data.text?.substring(0, 80) || '',
        });
      }
    }
  },

  // ‚îÄ‚îÄ Notifications ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async createNotification({ recipientId, senderId, type, commentId, postId, replyId, questionId, previewText, postTitle }) {
    if (!recipientId || recipientId === senderId) return;
    await addDoc(collection(db, 'notifications'), {
      recipientId, senderId, type,
      commentId: commentId || null,
      postId: postId || null,
      replyId: replyId || null,
      questionId: questionId || null,
      previewText: previewText || '',
      postTitle: postTitle || '',
      read: false,
      createdAt: new Date().toISOString()
    });
  },

  async getNotifications(userId, limitCount = 20) {
    try {
      const q = query(
        collection(db, 'notifications'),
        where('recipientId', '==', userId),
        orderBy('createdAt', 'desc')
      );
      const snapshot = await getDocs(q);
      return snapshot.docs.map(d => ({ id: d.id, ...d.data() })).slice(0, limitCount);
    } catch (error) {
      if (error.code === 'failed-precondition') {
        const snapshot = await getDocs(collection(db, 'notifications'));
        return snapshot.docs
          .map(d => ({ id: d.id, ...d.data() }))
          .filter(n => n.recipientId === userId)
          .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
          .slice(0, limitCount);
      }
      return [];
    }
  },

  async markNotificationRead(notifId) {
    await updateDoc(doc(db, 'notifications', notifId), { read: true });
  },

  async markAllNotificationsRead(userId) {
    const notifs = await forumService.getNotifications(userId, 50);
    const unread = notifs.filter(n => !n.read);
    await Promise.all(unread.map(n => forumService.markNotificationRead(n.id)));
  },

  subscribeToNotifications(userId, callback) {
    const q = query(
      collection(db, 'notifications'),
      where('recipientId', '==', userId),
      orderBy('createdAt', 'desc')
    );
    return onSnapshot(q, (snapshot) => {
      const notifs = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
      callback(notifs);
    }, () => { /* ignore snapshot errors */ });
  }
};

// ========== src/services/quizService.js ==========

import { doc, setDoc, collection, addDoc, updateDoc, increment, query, where, orderBy, limit, getDocs, getDoc } from 'firebase/firestore';
import { db } from '../firebase/config';

export const quizService = {
  // Save a quiz attempt WITH questions data for Mistake Notebook
  async saveAttempt(userId, attemptData) {
    try {
      const attemptRef = await addDoc(collection(db, 'attempts'), {
        userId: userId,
        timestamp: new Date().toISOString(),
        date: new Date().toISOString().split('T')[0],
        score: attemptData.score,
        totalQuestions: attemptData.totalQuestions,
        correctAnswers: attemptData.correctAnswers,
        percentage: attemptData.percentage,
        topics: attemptData.topics,
        timeSpent: attemptData.timeSpent || null,
        questionTimes: attemptData.questionTimes || null,
        answers: attemptData.answers || null,
        questions: attemptData.questions || null,
      });

      const userRef = doc(db, 'users', userId);
      await updateDoc(userRef, {
        totalAttempts: increment(1),
        totalQuestions: increment(attemptData.totalQuestions),
        totalCorrect: increment(attemptData.correctAnswers),
        lastAttemptDate: new Date().toISOString(),
      });

      return attemptRef.id;
    } catch (error) {
      console.error('Error saving attempt:', error);
      throw error;
    }
  },

  // Get user's attempt history
  async getUserAttempts(userId, limitCount = 20) {
    try {
      const q = query(
        collection(db, 'attempts'),
        where('userId', '==', userId),
        orderBy('timestamp', 'desc'),
        limit(limitCount),
      );
      const querySnapshot = await getDocs(q);
      const attempts = [];
      querySnapshot.forEach((doc) => attempts.push({ id: doc.id, ...doc.data() }));
      return attempts;
    } catch (error) {
      console.error('Error getting user attempts:', error);
      throw error;
    }
  },

  // ‚îÄ‚îÄ‚îÄ Helper: compute streak for a user given their attempts ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  _computeStreak(attempts) {
    if (!attempts.length) return 0;
    const uniqueDates = [...new Set(attempts.map(a => new Date(a.timestamp).toDateString()))]
      .sort((a, b) => new Date(b) - new Date(a));
    const today = new Date().toDateString();
    const yesterday = new Date(Date.now() - 86400000).toDateString();
    if (uniqueDates[0] !== today && uniqueDates[0] !== yesterday) return 0;
    let streak = 1;
    for (let i = 1; i < uniqueDates.length; i++) {
      const diff = Math.floor((new Date(uniqueDates[i - 1]) - new Date(uniqueDates[i])) / 86400000);
      if (diff === 1) streak++; else break;
    }
    return streak;
  },

  // ‚îÄ‚îÄ‚îÄ Shared leaderboard builder ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async _buildLeaderboard(attemptsQuery, limitCount, sortField = 'averageScore') {
    const querySnapshot = await getDocs(attemptsQuery);

    // Group by user
    const userMap = new Map();
    querySnapshot.forEach((doc) => {
      const data = doc.data();
      const uid = data.userId;
      if (!userMap.has(uid)) {
        userMap.set(uid, { userId: uid, attempts: [], totalScore: 0, totalQuestions: 0, totalCorrect: 0 });
      }
      const u = userMap.get(uid);
      u.attempts.push(data);
      u.totalScore += data.percentage;
      u.totalQuestions += data.totalQuestions;
      u.totalCorrect += data.correctAnswers;
    });

    // Fetch user profiles + compute streaks
    const leaderboard = await Promise.all(
      Array.from(userMap.values()).map(async (u) => {
        const userDoc = await getDoc(doc(db, 'users', u.userId));
        const userData = userDoc.data() || {};

        // Streak: fetch all-time attempts for streak calculation
        let streak = 0;
        try {
          const allQ = query(
            collection(db, 'attempts'),
            where('userId', '==', u.userId),
            orderBy('timestamp', 'desc'),
            limit(100),
          );
          const allSnap = await getDocs(allQ);
          const allAttempts = [];
          allSnap.forEach(d => allAttempts.push(d.data()));
          streak = this._computeStreak(allAttempts);
        } catch (_) { /* streak stays 0 */ }

        return {
          userId: u.userId,
          displayName: userData.displayName || 'Unknown',
          level: userData.level || null,          // S4 / S5 / S6
          attemptCount: u.attempts.length,
          averageScore: Math.round(u.totalScore / u.attempts.length),
          totalQuestions: u.totalQuestions,
          totalCorrect: u.totalCorrect,
          overallPercentage: Math.round((u.totalCorrect / u.totalQuestions) * 100),
          streak,
        };
      })
    );

    leaderboard.sort((a, b) => b[sortField] - a[sortField]);
    return leaderboard.slice(0, limitCount);
  },

  // Get weekly leaderboard
  async getWeeklyLeaderboard(limitCount = 10) {
    try {
      const weekAgo = new Date(); weekAgo.setDate(weekAgo.getDate() - 7);
      const q = query(
        collection(db, 'attempts'),
        where('timestamp', '>=', weekAgo.toISOString()),
        orderBy('timestamp', 'desc'),
      );
      return await this._buildLeaderboard(q, limitCount, 'averageScore');
    } catch (error) {
      console.error('Error getting weekly leaderboard:', error);
      throw error;
    }
  },

  // Get monthly leaderboard
  async getMonthlyLeaderboard(limitCount = 10) {
    try {
      const monthAgo = new Date(); monthAgo.setMonth(monthAgo.getMonth() - 1);
      const q = query(
        collection(db, 'attempts'),
        where('timestamp', '>=', monthAgo.toISOString()),
        orderBy('timestamp', 'desc'),
      );
      return await this._buildLeaderboard(q, limitCount, 'averageScore');
    } catch (error) {
      console.error('Error getting monthly leaderboard:', error);
      throw error;
    }
  },

  // Get all-time leaderboard
  async getAllTimeLeaderboard(limitCount = 10) {
    try {
      const usersQuery = query(collection(db, 'users'));
      const usersSnapshot = await getDocs(usersQuery);

      const users = [];
      const streakPromises = [];

      usersSnapshot.forEach((docSnap) => {
        const data = docSnap.data();
        if (data.totalAttempts > 0) {
          const entry = {
            userId: docSnap.id,
            displayName: data.displayName || 'Unknown',
            level: data.level || null,
            totalAttempts: data.totalAttempts || 0,
            totalQuestions: data.totalQuestions || 0,
            totalCorrect: data.totalCorrect || 0,
            overallPercentage: data.totalQuestions > 0
              ? Math.round((data.totalCorrect / data.totalQuestions) * 100)
              : 0,
            streak: 0,
          };
          users.push(entry);

          // Queue streak fetch
          streakPromises.push(
            (async () => {
              try {
                const q = query(
                  collection(db, 'attempts'),
                  where('userId', '==', docSnap.id),
                  orderBy('timestamp', 'desc'),
                  limit(100),
                );
                const snap = await getDocs(q);
                const arr = []; snap.forEach(d => arr.push(d.data()));
                entry.streak = this._computeStreak(arr);
              } catch (_) {}
            })()
          );
        }
      });

      await Promise.all(streakPromises);
      users.sort((a, b) => b.overallPercentage - a.overallPercentage);
      return users.slice(0, limitCount);
    } catch (error) {
      console.error('Error getting all-time leaderboard:', error);
      throw error;
    }
  },
};

// ========== src/services/rewardLogic.js ==========

// ============================================================================
// REWARD LOGIC - Token Awards with Anti-Cheat
// ============================================================================

import { awardTokens, canClaimReward, recordRewardClaim } from './tokenService';

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// REWARD TIERS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

const REWARDS = {
  // MCQ Completion Rewards (based on percentage)
  MCQ_PERFECT: 10,      // 100%
  MCQ_EXCELLENT: 5,     // 80-99%
  MCQ_GOOD: 2,          // 60-79%
  MCQ_COMPLETE: 1,      // < 60% (participation)

  // Mistake Book Rewards
  MISTAKE_CLEARED: 1,   // Per unique question (24h cooldown)

  // Leaderboard Rewards (Weekly)
  LEADERBOARD_GOLD_WEEKLY: 60,
  LEADERBOARD_SILVER_WEEKLY: 40,
  LEADERBOARD_BRONZE_WEEKLY: 20,

  // Leaderboard Rewards (Daily - via Weekly/7)
  LEADERBOARD_GOLD_DAILY: 10,
  LEADERBOARD_SILVER_DAILY: 6,
  LEADERBOARD_BRONZE_DAILY: 3,

  // Streak Bonuses
  STREAK_WEEK: 15,      // 7-day streak
  STREAK_MONTH: 50,     // 30-day streak

  // Special Events
  FIRST_QUIZ: 20,       // First quiz completion
  FORUM_POST: 2,        // Per helpful post (manual approval)
};

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// MCQ COMPLETION REWARDS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

/**
 * Award tokens for MCQ quiz completion
 */
export async function rewardMCQCompletion(userId, attemptData) {
  try {
    const { percentage, totalQuestions, correctAnswers, topics, attemptId } = attemptData;

    let tokensAwarded = 0;
    let rewardTier = '';

    // Determine reward tier
    if (percentage === 100) {
      tokensAwarded = REWARDS.MCQ_PERFECT;
      rewardTier = 'Perfect Score! üèÜ';
    } else if (percentage >= 80) {
      tokensAwarded = REWARDS.MCQ_EXCELLENT;
      rewardTier = 'Excellent! ‚≠ê';
    } else if (percentage >= 60) {
      tokensAwarded = REWARDS.MCQ_GOOD;
      rewardTier = 'Good Work! üëç';
    } else {
      tokensAwarded = REWARDS.MCQ_COMPLETE;
      rewardTier = 'Keep Practicing! üí™';
    }

    // Bonus for completing many questions
    if (totalQuestions >= 40) {
      tokensAwarded += 3;
      rewardTier += ' +3 Marathon Bonus';
    } else if (totalQuestions >= 20) {
      tokensAwarded += 1;
      rewardTier += ' +1 Length Bonus';
    }

    const reason = `MCQ Completed (${percentage}%) - ${rewardTier}`;
    
    await awardTokens(userId, tokensAwarded, reason, {
      category: 'mcq_completion',
      percentage,
      totalQuestions,
      correctAnswers,
      topics,
      attemptId
    });

    return {
      success: true,
      tokensAwarded,
      message: `+${tokensAwarded} tokens! ${rewardTier}`
    };
  } catch (error) {
    console.error('Error rewarding MCQ completion:', error);
    return { success: false, tokensAwarded: 0 };
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// MISTAKE NOTEBOOK REWARDS (with Anti-Cheat)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

/**
 * Reward clearing a mistake (once per question per 24h)
 */
export async function rewardMistakeCleared(userId, questionId) {
  try {
    const rewardKey = `mistake_${questionId}`;
    
    // Anti-cheat: Check cooldown
    const { canClaim, hoursRemaining } = await canClaimReward(userId, rewardKey);
    
    if (!canClaim) {
      return {
        success: false,
        message: `You can claim this reward again in ${hoursRemaining}h`,
        tokensAwarded: 0
      };
    }

    // Award token
    const tokensAwarded = REWARDS.MISTAKE_CLEARED;
    const reason = `Mistake Cleared: Question ${questionId.substring(0, 8)}`;

    await awardTokens(userId, tokensAwarded, reason, {
      category: 'mistake_cleared',
      questionId
    });

    // Record cooldown
    await recordRewardClaim(userId, rewardKey, 24);

    return {
      success: true,
      tokensAwarded,
      message: `+${tokensAwarded} token for mastering this question!`
    };
  } catch (error) {
    console.error('Error rewarding mistake cleared:', error);
    return { success: false, tokensAwarded: 0 };
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// LEADERBOARD REWARDS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

/**
 * Award tokens for leaderboard placement
 */
export async function rewardLeaderboardPlacement(userId, rank, period = 'weekly') {
  try {
    let tokensAwarded = 0;
    let medal = '';

    if (period === 'weekly') {
      if (rank === 1) {
        tokensAwarded = REWARDS.LEADERBOARD_GOLD_WEEKLY;
        medal = 'ü•á Weekly Gold';
      } else if (rank === 2) {
        tokensAwarded = REWARDS.LEADERBOARD_SILVER_WEEKLY;
        medal = 'ü•à Weekly Silver';
      } else if (rank === 3) {
        tokensAwarded = REWARDS.LEADERBOARD_BRONZE_WEEKLY;
        medal = 'ü•â Weekly Bronze';
      }
    } else if (period === 'daily') {
      if (rank === 1) {
        tokensAwarded = REWARDS.LEADERBOARD_GOLD_DAILY;
        medal = 'ü•á Daily Gold';
      } else if (rank === 2) {
        tokensAwarded = REWARDS.LEADERBOARD_SILVER_DAILY;
        medal = 'ü•à Daily Silver';
      } else if (rank === 3) {
        tokensAwarded = REWARDS.LEADERBOARD_BRONZE_DAILY;
        medal = 'ü•â Daily Bronze';
      }
    }

    if (tokensAwarded === 0) {
      return { success: false, tokensAwarded: 0 };
    }

    const reason = `Leaderboard Reward: ${medal}`;

    await awardTokens(userId, tokensAwarded, reason, {
      category: 'leaderboard',
      rank,
      period
    });

    return {
      success: true,
      tokensAwarded,
      message: `${medal} - +${tokensAwarded} tokens!`
    };
  } catch (error) {
    console.error('Error rewarding leaderboard placement:', error);
    return { success: false, tokensAwarded: 0 };
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// STREAK REWARDS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

/**
 * Award tokens for study streaks
 */
export async function rewardStreak(userId, streakDays) {
  try {
    let tokensAwarded = 0;
    let milestone = '';

    if (streakDays === 7) {
      tokensAwarded = REWARDS.STREAK_WEEK;
      milestone = '7-Day Streak! üî•';
    } else if (streakDays === 30) {
      tokensAwarded = REWARDS.STREAK_MONTH;
      milestone = '30-Day Streak! üî•üî•üî•';
    } else if (streakDays % 7 === 0 && streakDays > 7) {
      // Bonus for every week after first
      tokensAwarded = Math.floor(REWARDS.STREAK_WEEK * 1.5);
      milestone = `${streakDays}-Day Streak! üî•`;
    }

    if (tokensAwarded === 0) {
      return { success: false, tokensAwarded: 0 };
    }

    const rewardKey = `streak_${streakDays}`;
    
    // Check if already claimed
    const { canClaim } = await canClaimReward(userId, rewardKey);
    if (!canClaim) {
      return { success: false, message: 'Streak reward already claimed' };
    }

    const reason = `Study Streak: ${milestone}`;

    await awardTokens(userId, tokensAwarded, reason, {
      category: 'streak',
      streakDays
    });

    // Record to prevent duplicate claims
    await recordRewardClaim(userId, rewardKey, 720); // 30 days

    return {
      success: true,
      tokensAwarded,
      message: `${milestone} - +${tokensAwarded} tokens!`
    };
  } catch (error) {
    console.error('Error rewarding streak:', error);
    return { success: false, tokensAwarded: 0 };
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// SPECIAL MILESTONE REWARDS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

/**
 * Award first-time achievement bonuses
 */
export async function rewardFirstTimeAchievement(userId, achievementType) {
  try {
    const rewardKey = `first_${achievementType}`;
    
    const { canClaim } = await canClaimReward(userId, rewardKey);
    if (!canClaim) {
      return { success: false, message: 'Achievement already unlocked' };
    }

    let tokensAwarded = 0;
    let message = '';

    switch (achievementType) {
      case 'quiz':
        tokensAwarded = REWARDS.FIRST_QUIZ;
        message = 'First Quiz Completed! üéâ';
        break;
      case 'forum_post':
        tokensAwarded = REWARDS.FORUM_POST;
        message = 'Forum Contributor! üí¨';
        break;
      default:
        return { success: false };
    }

    const reason = `First Time: ${message}`;

    await awardTokens(userId, tokensAwarded, reason, {
      category: 'first_time',
      achievementType
    });

    await recordRewardClaim(userId, rewardKey, 99999); // Never reset

    return {
      success: true,
      tokensAwarded,
      message: `${message} - +${tokensAwarded} tokens!`
    };
  } catch (error) {
    console.error('Error rewarding first-time achievement:', error);
    return { success: false, tokensAwarded: 0 };
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// EXPORTS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

export const REWARD_AMOUNTS = REWARDS;

export default {
  rewardMCQCompletion,
  rewardMistakeCleared,
  rewardLeaderboardPlacement,
  rewardStreak,
  rewardFirstTimeAchievement,
  REWARDS
};

// ========== src/services/tokenService.js ==========

// ============================================================================
// TOKEN SERVICE - Real-Time Token Economy with Anti-Cheat
// ============================================================================

import { 
  doc, getDoc, setDoc, updateDoc, collection, addDoc, 
  query, orderBy, limit, getDocs, runTransaction, serverTimestamp,
  onSnapshot, increment
} from 'firebase/firestore';
import { db } from '../firebase/config';

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// TRANSACTION-SAFE TOKEN OPERATIONS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

/**
 * Award tokens to a user with transaction safety
 * Creates entry in tokenHistory sub-collection
 */
export async function awardTokens(userId, amount, reason, metadata = {}) {
  try {
    const userRef = doc(db, 'users', userId);
    
    await runTransaction(db, async (transaction) => {
      const userDoc = await transaction.get(userRef);
      
      if (!userDoc.exists()) {
        throw new Error('User not found');
      }

      const currentTokens = userDoc.data().tokens || 0;
      const newTokens = currentTokens + amount;

      // Update user tokens
      transaction.update(userRef, {
        tokens: newTokens,
        updatedAt: serverTimestamp()
      });

      // Create history entry
      const historyRef = doc(collection(db, 'users', userId, 'tokenHistory'));
      transaction.set(historyRef, {
        amount,
        reason,
        type: 'gain',
        timestamp: serverTimestamp(),
        balanceAfter: newTokens,
        metadata
      });
    });

    return { success: true, message: `Awarded ${amount} tokens` };
  } catch (error) {
    console.error('Error awarding tokens:', error);
    throw error;
  }
}

/**
 * Deduct tokens with transaction safety (prevents double-spending)
 */
export async function deductTokens(userId, amount, reason, metadata = {}) {
  try {
    const userRef = doc(db, 'users', userId);
    
    const result = await runTransaction(db, async (transaction) => {
      const userDoc = await transaction.get(userRef);
      
      if (!userDoc.exists()) {
        throw new Error('User not found');
      }

      const currentTokens = userDoc.data().tokens || 0;
      
      // Anti-cheat: Verify sufficient funds
      if (currentTokens < amount) {
        throw new Error('INSUFFICIENT_TOKENS');
      }

      const newTokens = currentTokens - amount;

      // Update user tokens
      transaction.update(userRef, {
        tokens: newTokens,
        updatedAt: serverTimestamp()
      });

      // Create history entry
      const historyRef = doc(collection(db, 'users', userId, 'tokenHistory'));
      transaction.set(historyRef, {
        amount: -amount,
        reason,
        type: 'spend',
        timestamp: serverTimestamp(),
        balanceAfter: newTokens,
        metadata
      });

      return { newBalance: newTokens };
    });

    return { success: true, newBalance: result.newBalance };
  } catch (error) {
    if (error.message === 'INSUFFICIENT_TOKENS') {
      return { success: false, error: 'Not enough tokens' };
    }
    console.error('Error deducting tokens:', error);
    throw error;
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// STORE OPERATIONS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

/**
 * Purchase an item from the store
 */
export async function purchaseItem(userId, itemId, price) {
  try {
    const userRef = doc(db, 'users', userId);
    
    const result = await runTransaction(db, async (transaction) => {
      const userDoc = await transaction.get(userRef);
      
      if (!userDoc.exists()) {
        throw new Error('User not found');
      }

      const currentTokens = userDoc.data().tokens || 0;
      const inventory = userDoc.data().inventory || [];

      // Check if already owned
      if (inventory.includes(itemId)) {
        throw new Error('ALREADY_OWNED');
      }

      // Verify funds
      if (currentTokens < price) {
        throw new Error('INSUFFICIENT_TOKENS');
      }

      const newTokens = currentTokens - price;

      // Update user
      transaction.update(userRef, {
        tokens: newTokens,
        inventory: [...inventory, itemId],
        updatedAt: serverTimestamp()
      });

      // Log transaction
      const historyRef = doc(collection(db, 'users', userId, 'tokenHistory'));
      transaction.set(historyRef, {
        amount: -price,
        reason: `Purchased: ${itemId}`,
        type: 'spend',
        timestamp: serverTimestamp(),
        balanceAfter: newTokens,
        metadata: { itemId, category: 'store_purchase' }
      });

      return { newBalance: newTokens, newInventory: [...inventory, itemId] };
    });

    return { success: true, ...result };
  } catch (error) {
    if (error.message === 'ALREADY_OWNED') {
      return { success: false, error: 'You already own this item' };
    }
    if (error.message === 'INSUFFICIENT_TOKENS') {
      return { success: false, error: 'Not enough tokens' };
    }
    console.error('Error purchasing item:', error);
    throw error;
  }
}

/**
 * Equip an item (set as active profile picture, etc.)
 */
export async function equipItem(userId, itemId, slot = 'profilePic') {
  try {
    const userRef = doc(db, 'users', userId);
    const userDoc = await getDoc(userRef);

    if (!userDoc.exists()) {
      throw new Error('User not found');
    }

    const inventory = userDoc.data().inventory || [];
    
    if (!inventory.includes(itemId)) {
      return { success: false, error: 'Item not owned' };
    }

    // Update equipped item
    await updateDoc(userRef, {
      [`equipped.${slot}`]: itemId,
      updatedAt: serverTimestamp()
    });

    return { success: true };
  } catch (error) {
    console.error('Error equipping item:', error);
    throw error;
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// TOKEN HISTORY
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

/**
 * Get user's token transaction history
 */
export async function getTokenHistory(userId, limitCount = 50) {
  try {
    const historyRef = collection(db, 'users', userId, 'tokenHistory');
    const q = query(historyRef, orderBy('timestamp', 'desc'), limit(limitCount));
    
    const snapshot = await getDocs(q);
    const history = [];
    
    snapshot.forEach(doc => {
      history.push({
        id: doc.id,
        ...doc.data()
      });
    });

    return history;
  } catch (error) {
    console.error('Error fetching token history:', error);
    return [];
  }
}

/**
 * Subscribe to real-time token updates
 */
export function subscribeToTokens(userId, callback) {
  const userRef = doc(db, 'users', userId);
  
  return onSnapshot(userRef, (doc) => {
    if (doc.exists()) {
      const data = doc.data();
      callback({
        tokens: data.tokens || 0,
        inventory: data.inventory || [],
        equipped: data.equipped || {}
      });
    }
  }, (error) => {
    console.error('Error in token subscription:', error);
  });
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ANTI-CHEAT UTILITIES
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

/**
 * Check if user can claim a reward (prevents spam/abuse)
 */
export async function canClaimReward(userId, rewardKey) {
  try {
    const cooldownRef = doc(db, 'users', userId, 'rewardCooldowns', rewardKey);
    const cooldownDoc = await getDoc(cooldownRef);

    if (!cooldownDoc.exists()) {
      return { canClaim: true };
    }

    const lastClaimed = cooldownDoc.data().lastClaimed?.toDate();
    const cooldownHours = cooldownDoc.data().cooldownHours || 24;
    
    if (!lastClaimed) {
      return { canClaim: true };
    }

    const hoursSince = (Date.now() - lastClaimed.getTime()) / (1000 * 60 * 60);
    
    if (hoursSince >= cooldownHours) {
      return { canClaim: true };
    }

    const hoursRemaining = Math.ceil(cooldownHours - hoursSince);
    return { 
      canClaim: false, 
      hoursRemaining,
      message: `Please wait ${hoursRemaining}h before claiming again`
    };
  } catch (error) {
    console.error('Error checking reward cooldown:', error);
    return { canClaim: true }; // Fail open
  }
}

/**
 * Record a reward claim with cooldown
 */
export async function recordRewardClaim(userId, rewardKey, cooldownHours = 24) {
  try {
    const cooldownRef = doc(db, 'users', userId, 'rewardCooldowns', rewardKey);
    await setDoc(cooldownRef, {
      lastClaimed: serverTimestamp(),
      cooldownHours,
      updatedAt: serverTimestamp()
    });
  } catch (error) {
    console.error('Error recording reward claim:', error);
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// INITIALIZATION
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

/**
 * Initialize token system for new user
 */
export async function initializeUserTokens(userId, initialTokens = 100) {
  try {
    const userRef = doc(db, 'users', userId);
    
    await updateDoc(userRef, {
      tokens: initialTokens,
      inventory: [],
      equipped: {},
      updatedAt: serverTimestamp()
    });

    // Create welcome token entry
    const historyRef = doc(collection(db, 'users', userId, 'tokenHistory'));
    await setDoc(historyRef, {
      amount: initialTokens,
      reason: 'Welcome to ChemLeung! üéâ',
      type: 'gain',
      timestamp: serverTimestamp(),
      balanceAfter: initialTokens,
      metadata: { category: 'welcome_bonus' }
    });

    return { success: true };
  } catch (error) {
    console.error('Error initializing tokens:', error);
    throw error;
  }
}

// ========== src/theme/colors.js ==========

// Premium Academic Color Scheme for ChemLeung HKDSE MCQ Platform

export const colors = {
  // Primary Academic Colors
  primary: {
    charcoal: '#2C3E50',      // Deep charcoal for headers
    slate: '#34495E',          // Slate for backgrounds
    lightSlate: '#5D6D7E',     // Light slate for secondary text
    paleSlate: '#ECF0F1',      // Very light slate for cards
  },
  
  // Academic Gold Accent
  gold: {
    main: '#D4AF37',           // Classic academic gold
    light: '#F4E4C1',          // Light gold for highlights
    dark: '#B8941F',           // Dark gold for active states
  },
  
  // Semantic Colors
  success: '#27AE60',          // Green for correct answers
  error: '#E74C3C',            // Red for incorrect
  warning: '#F39C12',          // Orange for flagged
  info: '#3498DB',             // Blue for information
  
  // Neutral Palette
  neutral: {
    white: '#FFFFFF',
    lightGray: '#F8F9FA',
    gray: '#BDC3C7',
    darkGray: '#7F8C8D',
    black: '#2C3E50',
  },
  
  // Text Colors (ensuring contrast)
  text: {
    primary: '#2C3E50',        // Dark charcoal - excellent contrast
    secondary: '#5D6D7E',      // Light slate
    inverse: '#FFFFFF',        // White text on dark backgrounds
    gold: '#B8941F',           // Dark gold for emphasis
  },
  
  // Background Colors
  background: {
    page: '#F5F7FA',           // Very light gray-blue
    card: '#FFFFFF',           // White cards
    cardAlt: '#ECF0F1',        // Pale slate alternative
    dark: '#2C3E50',           // Dark backgrounds
  }
};

// Tailwind CSS extension
export const tailwindColors = {
  'academic-charcoal': colors.primary.charcoal,
  'academic-slate': colors.primary.slate,
  'academic-light-slate': colors.primary.lightSlate,
  'academic-pale-slate': colors.primary.paleSlate,
  'academic-gold': colors.gold.main,
  'academic-gold-light': colors.gold.light,
  'academic-gold-dark': colors.gold.dark,
};

// ========== src/utils/quizStorage.js ==========

// localStorage utility for managing quiz state across pages

const STORAGE_KEYS = {
  SELECTED_QUESTIONS: 'quiz_selected_questions',
  USER_ANSWERS: 'quiz_user_answers',
  QUESTION_TIMES: 'quiz_question_times',
  FLAGGED: 'quiz_flagged',
  CURRENT_INDEX: 'quiz_current_index',
  TIMER_ENABLED: 'quiz_timer_enabled',
  SESSION_START: 'quiz_session_start'
};

export const quizStorage = {
  // Save selected questions for the quiz
  saveSelectedQuestions: (questions) => {
    localStorage.setItem(STORAGE_KEYS.SELECTED_QUESTIONS, JSON.stringify(questions));
  },

  getSelectedQuestions: () => {
    const data = localStorage.getItem(STORAGE_KEYS.SELECTED_QUESTIONS);
    return data ? JSON.parse(data) : null;
  },

  // Save user answers
  saveUserAnswers: (answers) => {
    localStorage.setItem(STORAGE_KEYS.USER_ANSWERS, JSON.stringify(answers));
  },

  getUserAnswers: () => {
    const data = localStorage.getItem(STORAGE_KEYS.USER_ANSWERS);
    return data ? JSON.parse(data) : {};
  },

  // Save question times
  saveQuestionTimes: (times) => {
    localStorage.setItem(STORAGE_KEYS.QUESTION_TIMES, JSON.stringify(times));
  },

  getQuestionTimes: () => {
    const data = localStorage.getItem(STORAGE_KEYS.QUESTION_TIMES);
    return data ? JSON.parse(data) : {};
  },

  // Save flagged questions
  saveFlagged: (flaggedSet) => {
    localStorage.setItem(STORAGE_KEYS.FLAGGED, JSON.stringify(Array.from(flaggedSet)));
  },

  getFlagged: () => {
    const data = localStorage.getItem(STORAGE_KEYS.FLAGGED);
    return data ? new Set(JSON.parse(data)) : new Set();
  },

  // Save current question index
  saveCurrentIndex: (index) => {
    localStorage.setItem(STORAGE_KEYS.CURRENT_INDEX, index.toString());
  },

  getCurrentIndex: () => {
    const data = localStorage.getItem(STORAGE_KEYS.CURRENT_INDEX);
    return data ? parseInt(data) : 0;
  },

  // Save timer settings
  saveTimerEnabled: (enabled) => {
    localStorage.setItem(STORAGE_KEYS.TIMER_ENABLED, JSON.stringify(enabled));
  },

  getTimerEnabled: () => {
    const data = localStorage.getItem(STORAGE_KEYS.TIMER_ENABLED);
    return data ? JSON.parse(data) : null;
  },

  saveSessionStart: (timestamp) => {
    localStorage.setItem(STORAGE_KEYS.SESSION_START, timestamp.toString());
  },

  getSessionStart: () => {
    const data = localStorage.getItem(STORAGE_KEYS.SESSION_START);
    return data ? parseInt(data) : null;
  },

  // Clear all quiz data (use when starting new quiz)
  clearQuizData: () => {
    Object.values(STORAGE_KEYS).forEach(key => {
      localStorage.removeItem(key);
    });
  },

  // Clear only progress data (keep selected questions)
  clearProgressData: () => {
    localStorage.removeItem(STORAGE_KEYS.USER_ANSWERS);
    localStorage.removeItem(STORAGE_KEYS.QUESTION_TIMES);
    localStorage.removeItem(STORAGE_KEYS.FLAGGED);
    localStorage.removeItem(STORAGE_KEYS.CURRENT_INDEX);
    localStorage.removeItem(STORAGE_KEYS.TIMER_ENABLED);
    localStorage.removeItem(STORAGE_KEYS.SESSION_START);
  }
};

// ========== src/utils/storeItems.js ==========

// ============================================================================
// STORE ITEMS - ChemStore Catalog
// ============================================================================

export const STORE_ITEMS = {
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ PROFILE PICTURES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  profilePics: [
    {
      id: 'flask_blue',
      name: 'Blue Flask',
      description: 'Classic chemistry icon',
      price: 0,
      icon: 'üß™',
      rarity: 'common',
      category: 'profilePic'
    },
    {
      id: 'atom_green',
      name: 'Green Atom',
      description: 'Atomic structure design',
      price: 50,
      icon: '‚öõÔ∏è',
      rarity: 'common',
      category: 'profilePic'
    },
    {
      id: 'molecule',
      name: 'Molecule Master',
      description: 'For molecular enthusiasts',
      price: 100,
      icon: 'üî¨',
      rarity: 'uncommon',
      category: 'profilePic'
    },
    {
      id: 'fire',
      name: 'Combustion King',
      description: 'Exothermic reactions only',
      price: 150,
      icon: 'üî•',
      rarity: 'uncommon',
      category: 'profilePic'
    },
    {
      id: 'lightning',
      name: 'Electrochemist',
      description: 'Charged with energy',
      price: 200,
      icon: '‚ö°',
      rarity: 'rare',
      category: 'profilePic'
    },
    {
      id: 'crystal',
      name: 'Crystal Scholar',
      description: 'Perfectly structured',
      price: 250,
      icon: 'üíé',
      rarity: 'rare',
      category: 'profilePic'
    },
    {
      id: 'explosion',
      name: 'Reaction Expert',
      description: 'Explosive personality',
      price: 300,
      icon: 'üí•',
      rarity: 'epic',
      category: 'profilePic'
    },
    {
      id: 'star',
      name: 'Chemistry Star',
      description: 'Shine bright like neon',
      price: 400,
      icon: '‚≠ê',
      rarity: 'epic',
      category: 'profilePic'
    },
    {
      id: 'crown',
      name: 'Noble Gas King',
      description: 'Unreactive royalty',
      price: 500,
      icon: 'üëë',
      rarity: 'legendary',
      category: 'profilePic'
    },
    {
      id: 'trophy',
      name: 'Grand Master',
      description: 'Ultimate achievement',
      price: 1000,
      icon: 'üèÜ',
      rarity: 'legendary',
      category: 'profilePic'
    }
  ],

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ BADGES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  badges: [
    {
      id: 'beginner',
      name: 'Beginner Badge',
      description: 'Your first steps',
      price: 0,
      icon: 'üéñÔ∏è',
      rarity: 'common',
      category: 'badge'
    },
    {
      id: 'scholar',
      name: 'Scholar Badge',
      description: '100 questions solved',
      price: 200,
      icon: 'üìö',
      rarity: 'uncommon',
      category: 'badge'
    },
    {
      id: 'expert',
      name: 'Expert Badge',
      description: '500 questions mastered',
      price: 500,
      icon: 'üéì',
      rarity: 'rare',
      category: 'badge'
    }
  ],

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ THEMES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  themes: [
    {
      id: 'default',
      name: 'Classic Blue',
      description: 'Original ChemLeung theme',
      price: 0,
      preview: 'linear-gradient(135deg, #2563eb, #1e40af)',
      rarity: 'common',
      category: 'theme'
    },
    {
      id: 'forest',
      name: 'Forest Green',
      description: 'Organic chemistry vibes',
      price: 150,
      preview: 'linear-gradient(135deg, #10b981, #059669)',
      rarity: 'uncommon',
      category: 'theme'
    },
    {
      id: 'sunset',
      name: 'Sunset Orange',
      description: 'Warm combustion colors',
      price: 200,
      preview: 'linear-gradient(135deg, #f97316, #ea580c)',
      rarity: 'rare',
      category: 'theme'
    },
    {
      id: 'royal',
      name: 'Royal Purple',
      description: 'Permanganate elegance',
      price: 300,
      preview: 'linear-gradient(135deg, #9333ea, #7e22ce)',
      rarity: 'epic',
      category: 'theme'
    }
  ]
};

// Flatten all items for easy lookup
export const ALL_ITEMS = [
  ...STORE_ITEMS.profilePics,
  ...STORE_ITEMS.badges,
  ...STORE_ITEMS.themes
];

// Get item by ID
export function getItemById(itemId) {
  return ALL_ITEMS.find(item => item.id === itemId);
}

// Rarity colors
export const RARITY_COLORS = {
  common: 'from-slate-400 to-slate-500',
  uncommon: 'from-green-400 to-green-600',
  rare: 'from-blue-400 to-blue-600',
  epic: 'from-purple-400 to-purple-600',
  legendary: 'from-amber-400 to-amber-600'
};

export const RARITY_BORDER = {
  common: 'border-slate-300',
  uncommon: 'border-green-300',
  rare: 'border-blue-300',
  epic: 'border-purple-300',
  legendary: 'border-amber-300'
};

export const RARITY_LABELS = {
  common: 'Common',
  uncommon: 'Uncommon',
  rare: 'Rare',
  epic: 'Epic',
  legendary: 'Legendary'
};

// ========== vite.config.js ==========

import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';
import tailwindcss from '@tailwindcss/vite';

export default defineConfig({
  plugins: [react(), tailwindcss()],
});

