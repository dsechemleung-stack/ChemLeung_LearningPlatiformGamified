# üß™ ChemCity ‚Äî The Alchemist's Lab

> A collectible card game layer on top of a Hong Kong DSE chemistry study platform.  
> Stack: **React + Vite + TypeScript** ¬∑ **Firebase Firestore** ¬∑ **Vercel**

---

## Quick Start

### 1. Clone and install

```bash
git clone <repo-url>
cd chemcity
npm install
```

### 2. Configure Firebase

```bash
cp .env.example .env.local
# Fill in your Firebase project values in .env.local
```

Get your Firebase config from:  
**Firebase Console ‚Üí Project Settings ‚Üí Your apps ‚Üí SDK setup and configuration**

### 3. Run locally

```bash
npm run dev
```

---

## Data Import Workflow

After editing `ChemCity_Items.xlsx`:

```bash
# Step 1: Convert Excel ‚Üí slim JSON
npm run excel-to-json

# Step 2: Upload to Firestore + auto-bump cacheVersion
npm run seed

# Or run both in sequence:
npm run seed:full
```

‚ö†Ô∏è **Never delete rows from the Excel file.** Set column Q (`deprecated`) to `TRUE` to hide a card.

‚ö†Ô∏è **If you edit Firestore directly** (without running the seed script), you must manually bump `meta/cacheVersion` in the Firebase Console. See Section 2.4 of the master plan.

---

## Environment Variables

| Variable | Description |
|---|---|
| `VITE_FIREBASE_API_KEY` | Firebase API key |
| `VITE_FIREBASE_AUTH_DOMAIN` | Firebase auth domain |
| `VITE_FIREBASE_PROJECT_ID` | Firebase project ID |
| `VITE_FIREBASE_STORAGE_BUCKET` | Firebase storage bucket |
| `VITE_FIREBASE_MESSAGING_SENDER_ID` | Firebase messaging sender ID |
| `VITE_FIREBASE_APP_ID` | Firebase app ID |

For seed scripts (Admin SDK), set `GOOGLE_APPLICATION_CREDENTIALS` to the path of your service account JSON.

---

## Project Structure

```
chemcity/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îî‚îÄ‚îÄ lib/
‚îÇ       ‚îú‚îÄ‚îÄ firebase.ts              # Firebase init
‚îÇ       ‚îú‚îÄ‚îÄ cache.ts                 # localStorage cache layer
‚îÇ       ‚îî‚îÄ‚îÄ chemcity/
‚îÇ           ‚îú‚îÄ‚îÄ types.ts             # All TypeScript interfaces
‚îÇ           ‚îî‚îÄ‚îÄ bonuses.ts           # 8 skill formulas + bonus engine
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îú‚îÄ‚îÄ excel-to-json.ts            # Excel ‚Üí slim JSON
‚îÇ   ‚îî‚îÄ‚îÄ seed-firestore.ts           # Firestore seeder + cacheVersion bump
‚îú‚îÄ‚îÄ functions/
‚îÇ   ‚îú‚îÄ‚îÄ initChemCityUser.ts         # Create user doc on first session
‚îÇ   ‚îî‚îÄ‚îÄ collectPassiveIncome.ts     # Server-side passive income payout
‚îú‚îÄ‚îÄ data/
‚îÇ   ‚îú‚îÄ‚îÄ places.json                 # 8 city locations + slots
‚îÇ   ‚îú‚îÄ‚îÄ items/                      # Generated by excel-to-json (one file per place)
‚îÇ   ‚îú‚îÄ‚îÄ collections.json            # Card collection groups
‚îÇ   ‚îî‚îÄ‚îÄ topics.json                 # DSE curriculum topics
‚îú‚îÄ‚îÄ docs/
‚îÇ   ‚îî‚îÄ‚îÄ handoff/
‚îÇ       ‚îî‚îÄ‚îÄ HANDOFF_PHASE0.md       # Phase 0 completion summary
‚îú‚îÄ‚îÄ firestore.rules                 # Firestore security rules
‚îú‚îÄ‚îÄ .env.example                    # Environment variable template
‚îî‚îÄ‚îÄ ChemCity_Master_Plan_v3.docx    # The single source of truth
```

---

## Architecture Principles

| Rule | Why |
|---|---|
| **Slim items in localStorage, full items from Firestore** | 5MB limit protection + fast load |
| **Server-side timestamps for passive income** | Clock manipulation prevention |
| **Currency writes through Cloud Functions only** | Cheat prevention |
| **cacheVersion auto-bumped by seed script** | Safe data updates |
| **Progress in sub-document** | 1MB Firestore doc limit protection |

---

## The Golden Rule

> The existing platform uses ~400 Firestore reads/day per user.  
> **ChemCity must add no more than 100 reads/day per user.**  
> Current architecture adds ~3‚Äì6 reads/day per user.

---

## Phase Plan

| Phase | Status | Description |
|---|---|---|
| **P0** | ‚úÖ Complete | Foundation, types, cache, seeder, security rules |
| **P1** | ‚è≥ Next | Core game logic: equip, passive income, purchase, Cloud Functions |
| **P2** | ‚Äî | UI: city map, place views, card inventory |
| **P3** | ‚Äî | Quiz currency rewards |
| **P4** | ‚Äî | ChemStore & unlocks |
| **P5** | ‚Äî | Polish, animations, Vercel deploy |

---

## For AI Coders

Read these in order before writing any code:

1. `ChemCity_Master_Plan_v3.docx`
2. `docs/handoff/HANDOFF_PHASE0.md`
3. Any subsequent handoff files in `docs/handoff/`

Then describe your implementation plan before writing code.  
Produce `HANDOFF_PHASE[X].md` when your phase is complete.
